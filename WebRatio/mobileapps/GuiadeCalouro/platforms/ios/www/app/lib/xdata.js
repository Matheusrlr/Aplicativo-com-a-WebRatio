!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.xdata=e():t.xdata=e()}(window,function(){return function(r){var n={};function i(t){if(n[t])return n[t].exports;var e=n[t]={i:t,l:!1,exports:{}};return r[t].call(e.exports,e,e.exports,i),e.l=!0,e.exports}return i.m=r,i.c=n,i.d=function(t,e,r){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=1)}([,function(t,e,r){"use strict";r.r(e);var n,i=function(t){this.totalCount=t?t.totalCount:void 0},s=function(){function t(t,e){this._db=t,this._providerTx=e}return t.prototype.select=function(t,e,r){return this._db.prepareSelect(t,e).query(this,r)},t.prototype.selectAll=function(t,e,r){return this._db.prepareSelect(t,e).queryAll(this,r)},t.prototype.selectOne=function(t,e,r){return this._db.prepareSelect(t,e).queryOne(this,r)},t.prototype.insert=function(t,e,r){return this._db.prepareInsert(t,e).execute(this,r)},t.prototype.insertGetChanged=function(t,e,r){return this._db.prepareInsert(t,e).executeGetChanged(this,r)},t.prototype.insertGetKey=function(t,e,r){return this._db.prepareInsert(t,e).executeGetKey(this,r)},t.prototype.update=function(t,e,r){return this._db.prepareUpdate(t,e).execute(this,r)},t.prototype.updateGetChanged=function(t,e,r){return this._db.prepareUpdate(t,e).executeGetChanged(this,r)},t.prototype.updateGetCount=function(t,e,r){return this._db.prepareUpdate(t,e).executeGetCount(this,r)},t.prototype.updateGetKeys=function(t,e,r){return this._db.prepareUpdate(t,e).executeGetKeys(this,r)},t.prototype.delete=function(t,e,r){return this._db.prepareDelete(t,e).execute(this,r)},t.prototype.deleteGetChanged=function(t,e,r){return this._db.prepareDelete(t,e).executeGetChanged(this,r)},t.prototype.deleteGetCount=function(t,e,r){return this._db.prepareDelete(t,e).executeGetCount(this,r)},t.prototype.deleteGetKeys=function(t,e,r){return this._db.prepareDelete(t,e).executeGetKeys(this,r)},t.prototype.executeCommand=function(t,e,r){var n=r?U:null;return this._providerTx.executeCommand(t,e,n)},t.prototype.resolve=function(){var t=this._providerTx;return Promise.resolve().then(function(){return t.resolve()})},t}();function d(t){return"object"==typeof t&&!!t&&"then"in t}function u(t){return"next"in t}function f(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];var n=Object.create(t.prototype),i=t.apply(n,e);return void 0!==i?i:n}function h(r,n,i){Object.keys(r).forEach(function(t){var e=r[t];n.call(i,e,t)})}function c(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];if(null==t)throw new TypeError("Cannot convert first argument to object");t=Object(t);for(var n=0;n<e.length;n++){var i=e[n];if(null!=i)for(var o in i=Object(i))i.hasOwnProperty(o)&&(t[o]=i[o])}return t}!function(t){var n=Object.prototype.hasOwnProperty,r=Array.isArray;function i(t){return 4294967295&t}function o(t){var e=typeof t;switch(e){case"object":return null===t?0:r(t)?function(t){for(var e=0,r=0;r<t.length;r++)e^=o(t[r]);return e}(t):function(t){var e,r=0;for(e in t)n.call(t,e)&&(r^=o(t[e]));return r}(t);case"undefined":return 0;case"boolean":return t?1231:1237;case"number":return i(t);case"string":return function(t){for(var e=0,r=0;r<t.length;r++)e=i(i(31*e)+t.charCodeAt(r));return e}(t);case"symbol":case"function":default:throw new Error("Cannot hash values of type "+e)}}t.computeValueHashCode=o}(n||(n={}));var o,a=n.computeValueHashCode;!function(t){var i=Object.prototype.hasOwnProperty,r=Array.isArray;function o(t,e){return t===e||(null!==t&&null!==e||void 0!==t&&void 0!==e)&&("object"==typeof t&&"object"==typeof e&&(r(t)?!!r(e)&&function(t,e){if(t.length!==e.length)return!1;for(var r=0;r<t.length;r++)if(!o(t[r],e[r]))return!1;return!0}(t,e):function(t,e){var r,n=Object.create(null);for(r in t)if(i.call(t,r)){if(n[r]=!0,!i.call(e,r))return!1;if(!o(t[r],e[r]))return!1}for(r in e)if(i.call(e,r)&&!0!==n[r])return!1;return!0}(t,e)))}t.computeValueEquality=o}(o||(o={}));var p=o.computeValueEquality;function l(t){return _(t).list}var y="__enum_values";function _(e){var t=e[y];if(!t){var r=Object.keys(e).filter(function(t){return/^[A-Z_\d]+$/.test(t)}).map(function(t){return e[t]}),n={};r.forEach(function(t){return n[t]=!0}),t={list:r,set:n},Object.defineProperty(e,y,{value:t})}return t}function m(t,e,r){var n=t[e];if(null==n||""===n)throw new Error("Missing required "+(r||"'"+e+"' property"));return n}function g(t,e,r,n){var i=m(t,e,n);try{return function(t,e){if(!0!==_(t).set[e])throw new TypeError("Invalid constant value '"+e+"' for enumeration type "+t);return e}(r,i)}catch(t){if(t instanceof TypeError)throw new Error("Invalid "+(n||"'"+e+"' property")+" value. Validd values are: "+l(r).join(", "));throw t}}function v(t,r,n,i,o){var s,u,a,p,e,c=m(t,r,o),l=(s=function(t,e){try{return f(n,e,t,i)}catch(t){throw new Error("Error constructing schema of "+(o||"'"+r+"' object value at")+" '"+e+"': "+t.message)}},p={},h(c,function(t,e){s&&(t=s.call(a,t,e)),u&&(e=u.call(a,e)),p[e]=t},a),p);return{map:l,list:(e=l,Object.keys(e).map(function(t){return e[t]}))}}function E(t,e,r){var n=t[e];if(null==n||null==n)throw new Error("Unknown "+r+" '"+e+"'");return n}var b,w,x=function(){function n(t,e,r){this._name=n._validateName(t),this._identity=e.identity||null,this._providerConfigs=n._constructProviderConfigs(e),this._schema=void 0===r?this:r}return n._validateName=function(t){if(!/^[^\s\.()]*$/.test(t))throw new Error("Name contains illegal characters");return t},n._constructProviderConfigs=function(t){var e,r=t.provider;if(!(e=r)||"object"!=typeof e)return{};var s={};return h(r,function(t,e){var r=/^([^\.]+)\.(.+)$/.exec(e);if(!r)throw new Error("Invalid provider configuration key '"+e+"'");var n=r[1],i=r[2],o=s[n];o||(s[n]=o={}),o[i]=t}),s},n.prototype.getName=function(){return this._name},n.prototype.getIdentity=function(){return this._identity},n.prototype.getProviderConfig=function(t){return this._providerConfigs[t]||{}},n.prototype.getSchema=function(){return this._schema},n.prototype.toString=function(){return this._name},n}();(w=b||(b={})).ARRAYBUFFER="arraybuffer",w.BOOLEAN="boolean",w.DATE="date",w.DECIMAL="decimal",w.INTEGER="integer",w.REAL="real",w.STRING="string";var N,O,I,P,C,A=(N=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},function(t,e){function r(){this.constructor=t}N(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),T=function(i){function o(t,e,r){var n=i.call(this,t,e,r)||this;return n._attr=null,e=o.normalizeConfig(e),n._type=g(e,"type",b,"type"),n}return A(o,i),o.normalizeConfig=function(t){if(!t)throw new Error("Missing configuration");return"string"==typeof t&&(t={type:t}),t},o.prototype.initAttribute=function(t){if(this._attr)throw new Error("Attribute already initialized");this._attr=t},o.prototype.getType=function(){return this._type},o.prototype.getAttribute=function(){if(!this._attr)throw new Error("Not part of an attribute");return this._attr},o}(x),R=(O=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},function(t,e){function r(){this.constructor=t}O(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),F=function(n){function t(t,e,r){return n.call(this,t,e,r)||this}return R(t,n),t}(x),S=(I=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},function(t,e){function r(){this.constructor=t}I(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),M=function(o){function s(t,e,r){var n=o.call(this,t,e,r)||this;if(n._entity=null,!t)throw new Error("No name specified");var i=r.getTypeHandler(s._extractConfigType(e));return e=s.normalizeConfig(e,i),n._type=m(e,"type","type"),n._key=m(e,"key"),n._fields=v(e,"typeMapping",T,r,"field"),n._fields.list.forEach(function(t){return t.initAttribute(n)}),n}return S(s,o),s._extractConfigType=function(t){if(!t)throw new Error("Missing configuration");var e="string"==typeof t?t:t.type;if(!e)throw new Error("No type specified");return e},s.normalizeConfig=function(t,e){if(!t)throw new Error("Missing configuration");"string"==typeof t&&(t={type:t});var n,i=s._createTypeMapping(e);n=t.hasOwnProperty("typeMapping")?"string"==typeof t.typeMapping?{"":t.typeMapping}:c({},t.typeMapping):i,t.typeMapping=n,h(i,function(t,e){n.hasOwnProperty(e)||(n[e]=t)});var o=t.provider;return h(n,function(t,e){if(!i.hasOwnProperty(e))throw new Error("Mapped type has no "+(e?"'"+e+"'":"default")+" field");if(o){var r=T.normalizeConfig(t);(n[e]=r).provider=c({},o,r.provider)}}),t.hasOwnProperty("key")||(t.key=!1),t},s._createTypeMapping=function(t){var e=t.getMapping();return"string"==typeof e&&(e={"":e}),c({},e)},s.prototype.initEntity=function(t){if(this._entity)throw new Error("Entity already initialized");this._entity=t},s.prototype.getType=function(){return this._type},s.prototype.isKey=function(){return this._key},s.prototype.getFields=function(){return this._fields.list},s.prototype.hasField=function(t){return!!this._fields.map[t]},s.prototype.getField=function(t){return E(this._fields.map,t,"field")},s.prototype.getEntity=function(){if(!this._entity)throw new Error("Not part of an entity");return this._entity},s}(F),j=(P=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},function(t,e){function r(){this.constructor=t}P(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),L=function(i){function o(t,e,r){var n=i.call(this,t,e,r)||this;return n._input=null,e=o.normalizeConfig(e),n._type=g(e,"type",b,"type"),n}return j(o,i),o.normalizeConfig=function(t){if(!t)throw new Error("Missing configuration");return"string"==typeof t&&(t={type:t}),t},o.prototype.initInput=function(t){if(this._input)throw new Error("Input already initialized");this._input=t},o.prototype.getType=function(){return this._type},o.prototype.getInput=function(){if(!this._input)throw new Error("Not part of an input");return this._input},o}(x),k=(C=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},function(t,e){function r(){this.constructor=t}C(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),B=function(o){function s(t,e,r){var n=o.call(this,t,e,r)||this;if(n._entity=null,!t)throw new Error("No name specified");var i=r.getTypeHandler(s._extractConfigType(e));return e=s.normalizeConfig(e,i),n._type=m(e,"type","type"),n._fields=v(e,"typeMapping",L,r,"field"),n._fields.list.forEach(function(t){return t.initInput(n)}),n}return k(s,o),s._extractConfigType=function(t){if(!t)throw new Error("Missing configuration");var e="string"==typeof t?t:t.type;if(!e)throw new Error("No type specified");return e},s.normalizeConfig=function(t,e){if(!t)throw new Error("Missing configuration");"string"==typeof t&&(t={type:t});var n,i=s._createTypeMapping(e);n=t.hasOwnProperty("typeMapping")?"string"==typeof t.typeMapping?{"":t.typeMapping}:c({},t.typeMapping):i,t.typeMapping=n,h(i,function(t,e){n.hasOwnProperty(e)||(n[e]=t)});var o=t.provider;return h(n,function(t,e){if(!i.hasOwnProperty(e))throw new Error("Mapped type has no "+(e?"'"+e+"'":"default")+" field");if(o){var r=L.normalizeConfig(t);(n[e]=r).provider=c({},o,r.provider)}}),t},s._createTypeMapping=function(t){var e=t.getMapping();return"string"==typeof e&&(e={"":e}),c({},e)},s.prototype.initEntity=function(t){if(this._entity)throw new Error("Entity already initialized");this._entity=t},s.prototype.getType=function(){return this._type},s.prototype.getFields=function(){return this._fields.list},s.prototype.hasField=function(t){return!!this._fields.map[t]},s.prototype.getField=function(t){return E(this._fields.map,t,"field")},s.prototype.getEntity=function(){if(!this._entity)throw new Error("Not part of an entity");return this._entity},s}(x);function z(t){if(!(t instanceof s))throw new Error("Invalid transaction object");return t}function V(t,e){return void 0===t||!e&&null===t||Array.isArray(t)&&t.length<=0}function D(t,e){var r=e instanceof x?e:e.getElement();if(r instanceof M)return t.getAttributeValueAccessor(r);if(r instanceof T)return t.getAttributeValueAccessor(r.getAttribute(),r.getName());if(r instanceof B)return t.getInputValueAccessor(r);if(r instanceof L)return t.getInputValueAccessor(r.getInput(),r.getName());throw new Error("Cannot access a value on "+r)}var G="__xdata_result_metadata";function U(t,e){"object"==typeof t&&t&&Object.defineProperty(t,G,{value:e})}function K(t){return t&&t[G]||null}var q,H,Y,Q,W=function(){function e(t,e){this._schema=t,this._providerName=e,this._providerSchema=null}return e.prototype.getSchema=function(){return this._schema},e.prototype.getProviderSchema=function(){var t=this._providerSchema;return t||(this._providerSchema=t=this._createSchema()),t},e.prototype._createSchema=function(){var t=this._schema;return{stores:t.getEntities().map(this._createStoreSchema,this),relations:t.getRelationships().map(this._createRelationSchema,this),properties:this._createProviderProperties(t)}},e.prototype._createStoreSchema=function(t){var r=this,n=[],i={};t.getInputs().forEach(function(t){t.getFields().forEach(function(t){var e=r._createInputFieldSchema(t);if(i[e.name])throw new Error("Conflicting input field name '"+e.name+"'");i[e.name]=!0,n.push(e)})});var o=[],s={};t.getAttributes().forEach(function(t){t.getFields().forEach(function(t){var e=r._createAttributeFieldSchema(t);if(s[e.name])throw new Error("Conflicting attribute field name '"+e.name+"'");s[e.name]=!0,o.push(e)})});var u=[];return t.getIndexes().forEach(function(t){var e=r._createIndexSchema(t);u.push(e)}),{name:e.getStoreName(t),identities:e.getStoreIdentities(t),inputs:n,fields:o,indexes:u,properties:this._createProviderProperties(t)}},e.prototype._createInputFieldSchema=function(t){return{name:e.getInputFieldName(t),type:t.getType(),identities:e.getInputFieldIdentities(t),properties:this._createProviderProperties(t)}},e.prototype._createAttributeFieldSchema=function(t){return{name:e.getAttributeFieldName(t),type:t.getType(),key:t.getAttribute().isKey(),identities:e.getAttributeFieldIdentities(t),properties:this._createProviderProperties(t)}},e.prototype._createIndexSchema=function(t){return{unique:t.isUnique(),fieldNames:Array.prototype.concat.apply([],t.getAttributes().map(function(t){return t.getFields().map(e.getAttributeFieldName)})),properties:this._createProviderProperties(t)}},e.prototype._createRelationSchema=function(t){return{name:e.getRelationName(t),identities:e.getRelationIdentities(t),end1:this._createRelationEndSchema(t.getRole1()),end2:this._createRelationEndSchema(t.getRole2()),properties:this._createProviderProperties(t)}},e.prototype._createRelationEndSchema=function(t){return{storeName:e.getStoreName(t.getEntity()),name:e.getRelationEndName(t),many:t.isManyParticipant(),innerName:e.getRelationEndInnerName(t),properties:this._createProviderProperties(t)}},e.prototype._createProviderProperties=function(t){return c({},t.getProviderConfig(this._providerName))},e.getStoreName=function(t){return t.getName()},e.getStoreIdentities=function(t){var e=t.getIdentity();return e?[e]:[]},e.getInputFieldName=function(t){var e=t.getInput().getName(),r=t.getName();return r?e+"_"+r:e},e.getInputFieldIdentities=function(t){var e=t.getInput().getIdentity();return e?[e+"/"+(t.getIdentity()||":name:"+t.getName())]:[]},e.getAttributeFieldName=function(t){var e=t.getAttribute().getName(),r=t.getName();return r?e+"_"+r:e},e.getAttributeFieldIdentities=function(t){var e=t.getAttribute().getIdentity();return e?[e+"/"+(t.getIdentity()||":name:"+t.getName())]:[]},e.getRelationName=function(t){return(e=t.getName()).charAt(0).toUpperCase()+e.substring(1);var e},e.getRelationIdentities=function(t){var e=t.getIdentity();return e?[e]:[]},e.getRelationEndName=function(t){return t.getNameAtEntity()},e.getRelationEndInnerName=function(t){return t.getName()},e}(),$=(q=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},function(t,e){function r(){this.constructor=t}q(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Z=function(o){function s(t,e,r){var n=o.call(this,t,e,r)||this;n._entity=null,n._attrs=null;var i=(e=s.normalizeConfig(e)).attributes.slice();if(i.length<=0)throw new Error("No attributes specified");return n._unique=m(e,"unique"),n._attrNames=i,n}return $(s,o),s.normalizeConfig=function(t){if(!t)throw new Error("Missing configuration");return("string"==typeof t||Array.isArray(t))&&(t={attributes:t}),"string"==typeof t.attributes&&(t.attributes=[t.attributes]),t.hasOwnProperty("unique")||(t.unique=!1),t},s.prototype.initEntity=function(e){if(this._entity||this._attrs)throw new Error("Entity already initialized");this._entity=e,this._attrs=this._attrNames.map(function(t){return e.getAttribute(t)})},s.prototype.isUnique=function(){return this._unique},s.prototype.getEntity=function(){if(!this._entity)throw new Error("Not part of an entity");return this._entity},s.prototype.getAttributes=function(){if(!this._attrs)throw new Error("Not part of an entity");return this._attrs},s}(x),J=(H=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},function(t,e){function r(){this.constructor=t}H(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),X=function(a){function p(t,e,i){var o=a.call(this,t,e,i)||this;if(o._roles={map:{},list:[]},o._rels=null,!t)throw new Error("No name specified");var r=v(e=p.normalizeConfig(e),"attributes",M,i,"attribute");if(r.list.length<=0)throw new Error("No attributes defined");var n=null;r.list.forEach(function(t){if(e.roles.hasOwnProperty(t.getName()))throw new Error("Name '"+t.getName()+"' conflict between attributes and roles");if(t.isKey()){if(n)throw new Error("Multiple key attributes defined");n=t}});var s=v(e,"indexes",Z,i,"index"),u=v(e,"inputs",B,i,"input");return r.list.forEach(function(t){return t.initEntity(o)}),o._attrs=r,o._keyAttr=n,s.list.forEach(function(t){return t.initEntity(o)}),o._indexes=s,u.list.forEach(function(t){return t.initEntity(o)}),o._inputs=u,h(e.roles||{},function(e,t){var r=/^([^\s\.]+)\.([^\s\.]+)$/.exec(e);if(!r)throw new Error("Invalid role reference '"+e+"'");var n=i.getRelationship(r[1]).getRole(r[2]);try{n.initEntity(o,t)}catch(t){throw new Error("Role '"+e+"' already connected to another entity")}o._roles.map[t]=n,o._roles.list.push(n)}),o._props={map:c({},o._attrs.map,o._roles.map),list:o._attrs.list.concat(o._roles.list)},o}return J(p,a),p.normalizeConfig=function(t){if(!t)throw new Error("Missing configuration");if(t.hasOwnProperty("attributes")||(t.attributes={}),t.hasOwnProperty("indexes")||(t.indexes={}),Array.isArray(t.indexes)){var i={};t.indexes.forEach(function(t,e){var r="string"==typeof t||Array.isArray(t)?t:t.attributes,n="string"==typeof r?r:r.join("_");i[n]=t}),t.indexes=i}return t.hasOwnProperty("inputs")||(t.inputs={}),t.hasOwnProperty("roles")||(t.roles={}),t},p.prototype.getAttributes=function(){return this._attrs.list},p.prototype.hasAttribute=function(t){return!!this._attrs.map[t]},p.prototype.getAttribute=function(t){return E(this._attrs.map,t,"attribute")},p.prototype.hasKeyAttribute=function(){return!!this._keyAttr},p.prototype.getKeyAttribute=function(){if(this._keyAttr)return this._keyAttr;throw new Error("Entity has no key attribute")},p.prototype.getIndexes=function(){return this._indexes.list},p.prototype.hasIndex=function(t){return!!this._indexes.map[t]},p.prototype.getIndex=function(t){return E(this._indexes.map,t,"index")},p.prototype.getInputs=function(){return this._inputs.list},p.prototype.hasInput=function(t){return!!this._inputs.map[t]},p.prototype.getInput=function(t){return E(this._inputs.map,t,"input")},p.prototype.getRoles=function(){return this._roles.list},p.prototype.hasRole=function(t){return!!this._roles.map[t]},p.prototype.getRole=function(t){return E(this._roles.map,t,"role")},p.prototype.getRelationships=function(){if(this._rels)return this._rels;var n={},i=[];return this.getRoles().forEach(function(t){var e=t.getRelationship(),r=e.getName();!0!==n[r]&&(n[r]=!0,i.push(e))}),this._rels=i},p.prototype.getProperties=function(){return this._props.list},p.prototype.hasProperty=function(t){return!!this._props.map[t]},p.prototype.getProperty=function(t){return E(this._props.map,t,"property")},p}(x);(Q=Y||(Y={})).ONE="1",Q.MANY="N";var tt,et,rt,nt,it,ot,st,ut,at,pt,ct=(tt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},function(t,e){function r(){this.constructor=t}tt(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),lt=function(i){function o(t,e,r){var n=i.call(this,t,e,r)||this;if(n._rel=null,n._inverse=null,n._entity=null,n._nameAtEntity=null,!t)throw new Error("No name specified");return e=o.normalizeConfig(e),n._cardinality=g(e,"cardinality",Y,"cardinality"),n}return ct(o,i),o.normalizeConfig=function(t){if(!t)throw new Error("Missing configuration");return"string"==typeof t&&(t={cardinality:t}),t},o.prototype.initRelationship=function(t){if(this._rel)throw new Error("Relationship already initialized");this._rel=t},o.prototype.initEntity=function(t,e){if(this._entity)throw new Error("Entity already initialized");this._entity=t,this._nameAtEntity=e},o.prototype.isOneParticipant=function(){return this._cardinality===Y.ONE},o.prototype.isManyParticipant=function(){return this._cardinality===Y.MANY},o.prototype.getRelationship=function(){if(!this._rel)throw new Error("Not part of a relationship");return this._rel},o.prototype.getInverseRole=function(){return this._inverse||(this._inverse=this.getRelationship().computeInverseRole(this)),this._inverse},o.prototype.isOneValue=function(){return this.getInverseRole().isOneParticipant()},o.prototype.isManyValue=function(){return this.getInverseRole().isManyParticipant()},o.prototype.getEntity=function(){if(!this._entity)throw new Error("Not connected to an entity");return this._entity},o.prototype.getNameAtEntity=function(){if(!this._nameAtEntity)throw new Error("Not connected to an entity");return this._nameAtEntity},o.prototype.getInverseEntity=function(){return this.getInverseRole().getEntity()},o}(F),ft=(et=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},function(t,e){function r(){this.constructor=t}et(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),ht=function(o){function s(t,e,r){var n=o.call(this,t,e,r)||this;if(n._self=null,n._entitiesMap=null,!t)throw new Error("No name specified");var i=v(e=s.normalizeConfig(e),"roles",lt,r,"role");if(2===i.list.length)return i.list.forEach(function(t){t.initRelationship(n)}),n._rolesMap=i.map,n._role1=i.list[0],n._role2=i.list[1],n;if(i.list.length<=0)throw new Error("No roles defined");if(i.list.length<2)throw new Error("Only one role defined");throw new Error("More than two roles defined")}return ft(s,o),s.normalizeConfig=function(t){if(!t)throw new Error("Missing configuration");if(Array.isArray(t)&&(t={roles:t}),Array.isArray(t.roles)){var r={};t.roles.forEach(function(t,e){r[String(e+1)]=t}),t.roles=r}return t},s.prototype.computeInverseRole=function(t){return t===this._role1?this._role2:this._role1},s.prototype.getRole1=function(){return this._role1},s.prototype.getRole2=function(){return this._role2},s.prototype.hasRole=function(t){return!!this._rolesMap[t]},s.prototype.getRole=function(t){return E(this._rolesMap,t,"role")},s.prototype.getEntity1=function(){return this._role1.getEntity()},s.prototype.getEntity2=function(){return this._role2.getEntity()},s.prototype.hasEntity=function(t){if(this._getEntitiesMap()[t]){if(this._isSelf())throw new Error("Ambiguous entity reference from self-relationship");return!0}return!1},s.prototype.getEntity=function(t){var e=E(this._getEntitiesMap(),t,"entity");if(this._isSelf())throw new Error("Ambiguous entity reference from self-relationship");return e},s.prototype._getEntitiesMap=function(){var t=this._entitiesMap;return t||((t={})[this.getEntity1().getName()]=this.getEntity1(),t[this.getEntity2().getName()]=this.getEntity2(),this._entitiesMap=t),t},s.prototype._isSelf=function(){return null===this._self&&(this._self=this.getEntity1()===this.getEntity2()),this._self},s}(x),dt=function(){function c(t,e){this._baseElement=t,this._elements=e,this._mappedFieldPathPrefix=null}return c.prototype.getBaseElement=function(){return this._baseElement},c.prototype.getElement=function(){return this._elements[this._elements.length-1]},c.prototype.getAttribute=function(){var t=this.getElement();if(!(t instanceof M))throw new Error("Reference does not point to an attribute");return t},c.prototype.getAttributeField=function(){var t=this.getElement();if(!(t instanceof T))throw new Error("Reference does not point to an attribute field");return t},c.prototype.computeMappedAttributeFieldPath=function(t){var e,r=this.getElement();if(r instanceof T){if(r.getName()!==t)throw new Error("Unable to reference attribute field '"+t+"'");r.getAttribute(),e=r}else e=this.getAttribute().getField(t);var n=this._mappedFieldPathPrefix;return n||(this._mappedFieldPathPrefix=n=this._computeMappedAttributeFieldPathPrefix()),n+W.getAttributeFieldName(e)},c.prototype._computeMappedAttributeFieldPathPrefix=function(){var t;t=this._elements[this._elements.length-1]instanceof T?this._elements.length-2:this._elements.length-1;for(var e="",r=0;r<t;r++){var n=this._elements[r],i=0<r?this._elements[r-1]:this._baseElement,o=void 0;if(n instanceof lt)o=i instanceof ht?W.getRelationEndInnerName(n):W.getRelationEndName(n);else{if(!(n instanceof X))throw new Error("Unexpected un-mappable element "+n);o=W.getStoreName(n)}e+=o+"."}return e},c.prototype.toUniqueKey=function(){return"["+this._baseElement.getName()+"]."+this._elements.map(function(t){return t.getName()}).join(".")},c.prototype.toString=function(){return this.toUniqueKey()},c.of=function(t,e){var r,n=e.split(".");if(!n[0])throw new Error("Empty reference expresison '"+e+"'");var i=n[n.length-1],o=i.indexOf("#");0<o?(n[n.length-1]=i.substring(0,o),r=i.substring(o+1)):r=null;for(var s=[],u=t,a=null,p=0;p<n.length;p++){if(u instanceof X){if((a=u.getProperty(n[p]))instanceof lt)u=a.getInverseEntity();else if(u=null,p<n.length-1)throw new Error("Found attribute not at the end of reference expression '"+e+"'")}else{if(!u)throw new Error("Illegal state");if(u.hasRole(n[p]))a=u.getRole(n[p]);else{if(!u.hasEntity(n[p]))throw new Error("Unknown role or entity '"+n[p]+"'");a=u.getEntity(n[p])===u.getEntity1()?u.getRole1():u.getRole2()}u=a.getEntity()}s.push(a)}if(null!==r){if(!(a instanceof M))throw new Error("Found fragment not after an attribute");a=a.getField(r),s.push(a)}return new c(t,s)},c}(),yt=function(){function t(t,e,r){this._providerOrderExpr=[],this._db=t,this._baseElement=e,this._compileOrderExpr(r,this._providerOrderExpr)}return t.prototype._compileOrderExpr=function(t,r){var n=this;if(Array.isArray(t))t.forEach(function(t){var e=n._normalizeOrderTerm(t);n._compileOrderTerm(e.property,e.descending||!1,r)});else{var e=this._normalizeOrderTerm(t);this._compileOrderTerm(e.property,e.descending||!1,r)}},t.prototype._normalizeOrderTerm=function(t){return"string"==typeof t&&(t={property:t,descending:!1}),t},t.prototype._compileOrderTerm=function(t,e,r){var n=dt.of(this._baseElement,t);D(this._db,n).getOrderMapping(e).forEach(function(t){r.push({fieldPath:n.computeMappedAttributeFieldPath(t.field),descending:t.descending})})},t.prototype.getProviderExpression=function(){return this._providerOrderExpr},t}(),_t=function(){function t(t,e){this._db=t.getDatabase(),this._baseEntity=t.getBaseEntity(),this._inputEnv=e,this._providerStoreInputs=this._compileStoreInputs(t.getNormalizedEntityInputs())}return t.prototype._compileStoreInputs=function(t){for(var e=[],r=0;r<t.length;r++){var n=this._compileTerm(t[r]);Array.prototype.push.apply(e,n)}return e},t.prototype._compileTerm=function(e){var r=this;if(!this._inputEnv.isPresent(e.valueInput,!0))return[];var n=this._baseEntity.getInput(e.input);return D(this._db,n).getMapping().map(function(t){return{inputName:W.getInputFieldName(n.getField(t.field)),valueParameter:r._inputEnv.getFieldName(e.valueInput,t.field)}})},t.prototype.getProviderStoreInputs=function(){return this._providerStoreInputs},t}(),mt=function(){function e(t){this._object=t,this._baseName=null,this._baseIndex=null}return e.prototype.createCopy=function(){var t=new e(this._object);return t._baseName=this._baseName,t._baseIndex=this._baseIndex,t},e.prototype.setBaseName=function(t){this._baseName=t},e.prototype.setBaseIndex=function(t){this._baseIndex=t},e.prototype.clearBaseIndex=function(){this._baseIndex=null},e.prototype.clearBaseName=function(){this.clearBaseIndex(),this._baseName=null},e.prototype.setDefault=function(t){this.set("",t)},e.prototype.getDefault=function(){return this.get("")},e.prototype.set=function(t,e){var r=this._getFieldName(t);if(null!==this._baseIndex){var n=this._object[r];n||(this._object[r]=n=[]),n[this._baseIndex]=e}else this._object[r]=e},e.prototype.get=function(t){var e=this._getFieldName(t);if(null===this._baseIndex)return this._object[e];var r=this._object[e];return r&&r[this._baseIndex]},e.prototype._getFieldName=function(t){if(!this._baseName)throw new Error("Mapped value is no longer usable");return e.getFieldName(this._baseName,t)},e.getFieldName=function(t,e){return e?t+"_"+e:t},e}(),gt=function(){function t(t,e){this._parameters=t,this._inputValues=e}return t.prototype.isPresent=function(t,e){var r=this._inputValues.getRegisteredAccessor(t);if(!r)return!1;var n=new mt(this._parameters);return n.setBaseName(t),r.isPresent(n,e)},t.prototype.getFieldName=function(t,e){return mt.getFieldName(t,e)},t.prototype.computeInputFingerprint=function(t,e){for(var r="",n=0;n<t.length;n++)r+=this.isPresent(t[n],e)?"P":".";return r},t}(),vt=function(){function t(t,e,r,n){this._inputNames=[],this._db=t,this._baseEntity=e,this._normalizedInputs=this._normalizeInputs(r,n)}return t.prototype.getDatabase=function(){return this._db},t.prototype.getBaseEntity=function(){return this._baseEntity},t.prototype._normalizeInputs=function(e,r){var n=this;return Array.isArray(e)?e.map(function(t){return n._normalizeTerm(t,r)}):Object.keys(e).map(function(t){return n._normalizeTerm({input:t,value:e[t]},r)})},t.prototype._normalizeTerm=function(t,e){var r=this._externalizeInput(t,e);return e.isPresent(r,!0)||this._inputNames.push(r),{input:t.input,valueInput:r}},t.prototype._externalizeInput=function(t,e){var r=this._baseEntity.getInput(t.input),n=D(this._db,r);return V(t.value,!0)?e.registerExpected(n,t.valueInput):t.valueInput?e.registerExpected(n,t.valueInput,t.value):e.registerConstant(n,t.value)},t.prototype.getInputNames=function(){return this._inputNames},t.prototype.getNormalizedEntityInputs=function(){return this._normalizedInputs},t}(),Et=function(){function t(t,e,r,n){this._cache={},this._normalizedEntityInputs=new vt(t,e,r,n),this._inputValues=n}return t.prototype.compile=function(t){var e=new gt(t,this._inputValues),r=e.computeInputFingerprint(this._normalizedEntityInputs.getInputNames(),!0),n=this._cache[r];return n||(n=new _t(this._normalizedEntityInputs,e),this._cache[r]=n),n},t}();nt=rt||(rt={}),(it=nt.ExpressionWithoutCompactAnd||(nt.ExpressionWithoutCompactAnd={})).isLogicAnd=function(t){return"object"==typeof t&&"and"in t},it.isLogicOr=function(t){return"object"==typeof t&&"or"in t},it.isLogicNot=function(t){return"object"==typeof t&&"not"in t},(ot=nt.NormExpression||(nt.NormExpression={})).isLogicAnd=function(t){return"and"in t},ot.isLogicOr=function(t){return"or"in t},ot.isLogicNot=function(t){return"not"in t},(ut=st||(st={})).NOT="not",ut.AND="and",ut.OR="or",(pt=at||(at={})).EMPTY="empty",pt.NOT_EMPTY="!empty",pt.NULL="null",pt.NOT_NULL="!null",pt.IN="in",pt.NOT_IN="!in",pt.EQUAL="==",pt.EQUAL_IGNORE_CASE="==~",pt.NOT_EQUAL="!=",pt.NOT_EQUAL_IGNORE_CASE="!=~",pt.GREATER=">",pt.GREATER_OR_EQUAL=">=",pt.LESSER="<",pt.LESSER_OR_EQUAL="<=",pt.BEGINNING="beginning",pt.BEGINNING_IGNORE_CASE="beginning~",pt.NOT_BEGINNING="!beginning",pt.NOT_BEGINNING_IGNORE_CASE="!beginning~",pt.CONTAINING="containing",pt.CONTAINING_IGNORE_CASE="containing~",pt.NOT_CONTAINING="!containing",pt.NOT_CONTAINING_IGNORE_CASE="!containing~",pt.ENDING="ending",pt.ENDING_IGNORE_CASE="ending~",pt.NOT_ENDING="!ending",pt.NOT_ENDING_IGNORE_CASE="!ending~",function(e){function r(t){switch(t){case e.EMPTY:case e.NOT_EMPTY:case e.NULL:case e.NOT_NULL:return!0;default:return!1}}e.isUnary=r,e.isBinary=function(t){return!r(t)}}(at||(at={}));var bt,wt,xt=function(){function t(t,e){this._requiredInputs={expected:0,found:0},this._impliedInputs={expected:0,found:0},this._db=t.getDatabase(),this._baseElement=t.getBaseElement(),this._inputEnv=e;var r=this._compileExpression(t.getNormalizedExpression()),n=this._computeApplicableFixedResult(t.isOneImpliedInputRequired());this._providerExpr=r.providerExpr,this._fixedResult=void 0!==n?n:r.fixedResult}return t.prototype._compileExpression=function(t){if(Array.isArray(t)){if(1<t.length)return this._compileLogicAndExpression(t);if(1===t.length)return this._compileTerm(t[0]);throw new Error("Invalid 0-length array in expression")}return rt.NormExpression.isLogicAnd(t)?this._compileLogicAndExpression(t.and):rt.NormExpression.isLogicOr(t)?this._compileLogicOrExpression(t.or):rt.NormExpression.isLogicNot(t)?this._compileLogicNotExpression(t.not):this._compileTerm(t)},t.prototype._compileLogicAndExpression=function(t){return this._compileLogicBinaryExpression(t,!1,!0,st.AND)},t.prototype._compileLogicOrExpression=function(t){return this._compileLogicBinaryExpression(t,!0,!1,st.OR)},t.prototype._compileLogicBinaryExpression=function(t,e,r,n){for(var i=[],o=0;o<t.length;o++){var s=this._compileExpression(t[o]);if(!s.providerExpr){if(s.fixedResult===e)return{fixedResult:e};if(s.fixedResult===r)continue;return{fixedResult:null}}i.push(s.providerExpr)}return{providerExpr:1<i.length?{operator:n,operands:i}:i[0]}},t.prototype._compileLogicNotExpression=function(t){var e=this._compileExpression(t);return e.providerExpr?{providerExpr:{operator:st.NOT,operands:[e.providerExpr]}}:"boolean"==typeof e.fixedResult?{fixedResult:!e.fixedResult}:{fixedResult:null}},t.prototype._compileTerm=function(t){var e=this,r=t.operator,n=void 0!==t.implied?!!t.implied:null,i=null===n?this._requiredInputs:this._impliedInputs;i.expected++;var o=at.isBinary(r);if(o){var s=t.valueInput;if(!this._inputEnv.isPresent(s))return null===n?{fixedResult:null}:{fixedResult:n}}i.found++;var u,a=dt.of(this._baseElement,t.property),p=D(this._db,a).getOperatorMapping(t.operator||at.EQUAL);if(o){var c=t.valueInput,l=t.valueOperator;u=p.map(function(t){return{fieldPath:a.computeMappedAttributeFieldPath(t.field),operator:t.operator,valueParameter:e._inputEnv.getFieldName(c,t.field),internalOperator:l}})}else u=p.map(function(t){return{fieldPath:a.computeMappedAttributeFieldPath(t.field),operator:t.operator,valueParameter:void 0,internalOperator:void 0}});return{providerExpr:1<u.length?{operator:st.AND,operands:u}:u[0]}},t.prototype._computeApplicableFixedResult=function(t){var e=this._requiredInputs,r=this._impliedInputs;return 0<e.expected&&e.found<e.expected||t&&0<r.expected&&0===r.found?null:0===e.expected&&!t&&0===r.found||void 0},t.prototype.isApplicable=function(){return null!==this._fixedResult},t.prototype._checkApplicable=function(){if(null===this._fixedResult)throw new Error("Not applicable");return this._fixedResult},t.prototype.isFixed=function(){return void 0!==this._checkApplicable()},t.prototype.getFixedResult=function(){var t=this._checkApplicable();if(void 0===t)throw new Error("Result is not fixed");return t},t.prototype.getProviderExpression=function(){if(this._checkApplicable(),void 0===this._providerExpr)throw new Error("Result is fixed");return this._providerExpr},t}();(wt=bt||(bt={})).ALL="all",wt.ANY="any";var Nt,Ot,It,Pt,Ct,At=function(){function t(t,e,r,n){this._inputNames=[],this._db=t,this._baseElement=e,this._normalizedExpr=this._normalizeExpression(r,n),this._oneImpliedInputRequired=!("string"==typeof r||Array.isArray(r)||!r.config||!r.config.oneImpliedInputRequired)}return t.prototype.getDatabase=function(){return this._db},t.prototype.getBaseElement=function(){return this._baseElement},t.prototype._normalizeExpression=function(t,e){if(Array.isArray(t)){if(1<t.length)return this._normalizeLogicExpression(st.AND,t,e);if(1===t.length)return this._normalizeExpression(t[0],e);throw new Error("Invalid 0-length array in expression")}return rt.ExpressionWithoutCompactAnd.isLogicAnd(t)?this._normalizeLogicExpression(st.AND,t.and,e):rt.ExpressionWithoutCompactAnd.isLogicOr(t)?this._normalizeLogicExpression(st.OR,t.or,e):rt.ExpressionWithoutCompactAnd.isLogicNot(t)?this._normalizeLogicExpression(st.NOT,t.not,e):this._normalizeTerm(t,e)},t.prototype._normalizeLogicExpression=function(t,e,r){var n,i,o,s=this;return Array.isArray(e)?((o={})[t]=e.map(function(t){return s._normalizeExpression(t,r)}),n=o):((i={})[t]=this._normalizeExpression(e,r),n=i),n},t.prototype._normalizeTerm=function(t,e){"object"!=typeof t&&(t={property:t});var r=t.operator||at.EQUAL,n=t.valueOperator||bt.ANY;if(at.isBinary(r)){var i=this._externalizeInput(t,e);return e.isPresent(i)||this._inputNames.push(i),{property:t.property,operator:r,value:void 0,valueInput:i,valueOperator:n,implied:t.implied}}return{property:t.property,operator:r}},t.prototype._externalizeInput=function(t,e){var r=dt.of(this._baseElement,t.property),n=D(this._db,r);return V(t.value)?e.registerMultipleExpected(n,t.valueInput):t.valueInput?e.registerMultipleExpected(n,t.valueInput,t.value):e.registerMultipleConstant(n,t.value)},t.prototype.getInputNames=function(){return this._inputNames},t.prototype.getNormalizedExpression=function(){return this._normalizedExpr},t.prototype.isOneImpliedInputRequired=function(){return this._oneImpliedInputRequired},t}(),Tt=function(){function t(t,e,r,n){this._cache={},this._normalizedFilter=new At(t,e,r,n),this._inputValues=n}return t.prototype.compile=function(t){var e=new gt(t,this._inputValues),r=e.computeInputFingerprint(this._normalizedFilter.getInputNames()),n=this._cache[r];return n||(n=new xt(this._normalizedFilter,e),this._cache[r]=n),n},t}(),Rt=function(){function t(t,e){this._db=t.getDatabase(),this._baseElement=t.getBaseElement(),this._inputEnv=e,this._providerInputs=this._compileInputs(t.getNormalizedInputs())}return t.prototype._compileInputs=function(t){for(var e=[],r=0;r<t.length;r++){var n=this._compileTerm(t[r]);Array.prototype.push.apply(e,n)}return e},t.prototype._compileTerm=function(e){var r=this;if(!this._inputEnv.isPresent(e.valueInput,!0))return[];var n=dt.of(this._baseElement,e.property);return D(this._db,n).getMapping().map(function(t){return{fieldPath:n.computeMappedAttributeFieldPath(t.field),valueParameter:r._inputEnv.getFieldName(e.valueInput,t.field)}})},t.prototype.isEmpty=function(){return this._providerInputs.length<=0},t.prototype.getProviderInputs=function(){if(this.isEmpty())throw new Error("Empty");return this._providerInputs},t}(),Ft=function(){function t(t,e,r,n){this._inputNames=[],this._db=t,this._baseElement=e,this._normalizedInputs=this._normalizeInputs(r,n)}return t.prototype.getDatabase=function(){return this._db},t.prototype.getBaseElement=function(){return this._baseElement},t.prototype._normalizeInputs=function(e,r){var n=this;return Array.isArray(e)?e.map(function(t){return n._normalizeTerm(t,r)}):Object.keys(e).map(function(t){return n._normalizeTerm({property:t,value:e[t]},r)})},t.prototype._normalizeTerm=function(t,e){var r=this._externalizeInput(t,e);return e.isPresent(r,!0)||this._inputNames.push(r),{property:t.property,valueInput:r}},t.prototype._externalizeInput=function(t,e){var r=dt.of(this._baseElement,t.property),n=D(this._db,r);return V(t.value,!0)?e.registerExpected(n,t.valueInput):t.valueInput?e.registerExpected(n,t.valueInput,t.value):e.registerConstant(n,t.value)},t.prototype.getInputNames=function(){return this._inputNames},t.prototype.getNormalizedInputs=function(){return this._normalizedInputs},t}(),St=function(){function t(t,e,r,n){this._cache={},this._normalizedInputs=new Ft(t,e,r,n),this._inputValues=n}return t.prototype.compile=function(t){var e=new gt(t,this._inputValues),r=e.computeInputFingerprint(this._normalizedInputs.getInputNames(),!0),n=this._cache[r];return n||(n=new Rt(this._normalizedInputs,e),this._cache[r]=n),n},t}(),Mt=function(){function t(){this._defaults={},this._pending={},this._pendingPromises=[],this._mappedValue=new mt(this._defaults),this._constantCount=0,this._anonymousCount=0,this._expectedInputs=[],this._accessors={}}return t.prototype.registerConstant=function(t,e){return this._doRegisterConstant(!1,t,e)},t.prototype.registerMultipleConstant=function(t,e){return this._doRegisterConstant(!0,t,e)},t.prototype._doRegisterConstant=function(t,e,r){var n="_k"+this._constantCount++;return this._setDefault(e,n,t,r),this._accessors[n]=e,n},t.prototype.registerExpected=function(t,e,r){var n=this._doRegisterExpected(!1,t,e,r);return this._accessors[n]=t,n},t.prototype.registerMultipleExpected=function(t,e,r){var n=this._doRegisterExpected(!0,t,e,r);return this._accessors[n]=t,n},t.prototype.getRegisteredAccessor=function(t){return this._accessors[t]},t.prototype._doRegisterExpected=function(t,e,r,n){return r=r||String(this._anonymousCount++),void 0!==n&&this._setDefault(e,r,t,n),this._expectedInputs.push({inputName:r,multiple:t}),r},t.prototype._setDefault=function(t,e,r,n){var i,o=this;this._mappedValue.setBaseName(e),d(i=r?t.writeMultiple(this._mappedValue,n):t.write(this._mappedValue,n))&&(this._pending[e]=!0,this._pendingPromises.push(Promise.resolve(i).then(function(){o._pending[e]=!1})),this._mappedValue=this._mappedValue.createCopy()),this._mappedValue.clearBaseName()},t.prototype.isPresent=function(t,e){if(this._pending[t])return!0;var r=this._accessors[t];if(!r)return!1;var n=new mt(this._defaults);return n.setBaseName(t),r.isPresent(n,e)},t.prototype.getFieldName=function(t,e){return mt.getFieldName(t,e)},t.prototype.prepareObject=function(o){var s=this,t=this._defaults,e=Object.create(t);return Promise.all(this._pendingPromises).then(function(){if(!(s._expectedInputs.length<=0)&&o){var i=new mt(e);return Promise.all(s._expectedInputs.map(function(t){var e=o[t.inputName];if(void 0!==e){var r;i.setBaseName(t.inputName);var n=s._accessors[t.inputName];return d(r=t.multiple?n.writeMultiple(i,e):n.write(i,e))&&(i=i.createCopy()),i.clearBaseName(),r}}))}}).then(function(){return e})},t}(),jt=function(){function t(t){this._notifiedMethodName=t,this._changeTrackers=[]}return t.prototype.isEmpty=function(){return this._changeTrackers.length<=0},t.prototype.clear=function(){return 0<this._changeTrackers.length&&!(this._changeTrackers.length=0)},t.prototype.add=function(t){for(var e=0;e<this._changeTrackers.length;e++)if(this._changeTrackers[e]===t)return!1;return this._changeTrackers.push(t),!0},t.prototype.remove=function(t){for(var e=0;e<this._changeTrackers.length;e++)if(this._changeTrackers[e]===t)return this._changeTrackers.splice(e,1),!0;return!1},t.prototype.getOutputsByTargetName=function(){var r={};return this._changeTrackers.forEach(function(t,e){r["tracker:"+e]=t.tracked,t.trackedOld&&(r["tracker-old:"+e]=t.trackedOld)}),r},t.prototype.notify=function(o){var s=this._notifiedMethodName;this._changeTrackers.forEach(function(t,e){var r=o["tracker:"+e],n=void 0;t.trackedOld&&(n=o["tracker-old:"+e]);var i=t[s];i&&i.call(t,r,n)})},t}(),Lt=function(){function t(t,e,r,n){var i=this;this._outputNamesCache={},this._outputNamesCount=0,this._providerOutputs=[],this._db=t,this._baseElement=e,this._outputValues=n,Object.keys(r).forEach(function(t){i._outputValues.defineTarget(t),i._compileOutputs(r[t],t,i._providerOutputs)})}return t.prototype._compileOutputs=function(e,r,n){var i=this;"string"==typeof e?this._compileOutputTerm(e,r,null,n):Array.isArray(e)?e.forEach(function(t){i._compileOutputTerm(t,r,t,n)}):Object.keys(e).forEach(function(t){i._compileOutputTerm(e[t],r,t,n)})},t.prototype._compileOutputTerm=function(t,e,r,n){var i=this,o=dt.of(this._baseElement,t),s=D(this._db,o),u=o.toUniqueKey(),a=this._outputNamesCache[u],p=!a;(a||(this._outputNamesCache[u]=a="o"+this._outputNamesCount++),null===r?this._outputValues.registerLoneValue(s,a,e):this._outputValues.registerObjectProperty(s,a,e,r),p)&&s.getMapping().forEach(function(t){n.push({fieldPath:o.computeMappedAttributeFieldPath(t.field),before:!1,propertyName:i._outputValues.getFieldName(a,t.field)})})},t.prototype.getProviderOutputs=function(){return this._providerOutputs},t}(),kt=function(){function t(){this._extractions=[],this._extractionsByOutputName={},this._targetNames=[],this._targetTypes={}}return t.prototype.defineTarget=function(t){if(this._targetTypes.hasOwnProperty(t))throw new Error("Target "+t+" already defined");this._targetTypes[t]=void 0,this._targetNames.push(t)},t.prototype.registerObjectProperty=function(t,e,r,n){if(!this._targetTypes.hasOwnProperty(r))throw new Error("Target "+r+" not defined");var i=this._targetTypes[r];if(void 0===i)this._targetTypes[r]=!1;else if(!0===i)throw new Error("Target "+r+" constructed object conflicts with lone value");this._addExtractedOutput(t,e,r,n)},t.prototype.registerLoneValue=function(t,e,r){if(!this._targetTypes.hasOwnProperty(r))throw new Error("Target "+r+" not defined");var n=this._targetTypes[r];if(void 0===n)this._targetTypes[r]=!0;else if(!1===n)throw new Error("Target "+r+" lone value conflicts with constructed object");this._addExtractedOutput(t,e,r,null)},t.prototype._addExtractedOutput=function(t,e,r,n){var i=this._extractionsByOutputName[e];i||(i={accessor:t,outputName:e,targetProperties:Object.create(null)},this._extractionsByOutputName[e]=i,this._extractions.push(i));var o=i.targetProperties,s=o[r];if(null===n){if(void 0!==s)throw new Error("Lone value addition is always the first and only");o[r]=null}else{if(null===s)throw new Error("Lone value addition is always the first and only");void 0===s&&(o[r]=s=[]),s.push(n)}},t.prototype.getFieldName=function(t,e){return mt.getFieldName(t,e)},t.prototype.prepareTargets=function(t){var e={},r=[];return this._doPrepareTargets(e,t,this._targetNames,r),Promise.all(r).then(function(){return e})},t.prototype.prepareTarget=function(t,e){if(!this._targetTypes.hasOwnProperty(e))throw new Error("Target "+e+" not defined");var r={},n=[];return this._doPrepareTargets(r,t,[e],n),Promise.all(n).then(function(){return r[e]})},t.prototype._doPrepareTargets=function(p,t,c,l){for(var f=new mt(t),e=function(t){var s=h._extractions[t];f.setBaseName(s.outputName);for(var e=s.accessor.read(f),r=0;r<c.length;r++){var n=c[r],i=s.targetProperties[n];if(void 0!==i&&void 0!==e)if(null!==i)for(var o=p[n]||(p[n]={}),u=0;u<i.length;u++)o[i[u]]=e;else p[n]=e}var a=d(e);a&&(f=f.createCopy()),f.clearBaseName(),a&&l.push(e.then(function(t){for(var e=0;e<c.length;e++){var r=c[e],n=s.targetProperties[r];if(null!==n)for(var i=p[r],o=0;o<n.length;o++)void 0!==t?i[n[o]]=t:delete i[n[o]];else p[r]=t}}))},h=this,r=0;r<this._extractions.length;r++)e(r);for(r=0;r<c.length;r++){var n=c[r];p.hasOwnProperty(n)||(p[n]={})}},t}(),Bt=(Nt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},function(t,e){function r(){this.constructor=t}Nt(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),zt=function(){function t(t,e,r){this._adapter=t.then(function(t){if("object"!=typeof t)throw new Error("Provider result not processable as cursor");return Array.isArray(t)?new Dt(t,e,r):u(t)?new Gt(t,e,r):new Dt([t],e,r)})}return t.prototype.next=function(){return this._adapter.then(function(t){return t.next()})},t.prototype.getMetadata=function(){return this._adapter.then(function(t){return t.getMetadata()})},t}(),Vt=function(){function t(t,r,n){this.providerElements=t,this.iterElementFactory=function(e,t){return void 0===t?Promise.resolve({done:e,value:void 0}):r.call(n,t).then(function(t){return{done:e,value:t}})}}return t.prototype.getMetadata=function(){var t=this.providerElements?K(this.providerElements):null,e=new i(t);return Promise.resolve(e)},t}(),Dt=function(i){function t(t,e,r){var n=i.call(this,t,e,r)||this;return n._nextIndex=0,n}return Bt(t,i),t.prototype.next=function(){if(this._nextIndex>=this.providerElements.length)return this.iterElementFactory(!0);var t=this._nextIndex++;return this.iterElementFactory(!1,this.providerElements[t])},t}(Vt),Gt=function(n){function t(t,e,r){return n.call(this,t,e,r)||this}return Bt(t,n),t.prototype.next=function(){var e=this;return Promise.resolve(this.providerElements.next()).then(function(t){return e.iterElementFactory(t.done,t.value)})},t}(Vt),Ut=function(){function t(){this._buckets={}}return t.prototype.clear=function(){this._buckets={}},t.prototype.get=function(t){var e=this._buckets[a(t)];if(e)for(var r=0;r<e.length;r++){var n=e[r];if(p(t,n.key))return n.value}},t.prototype.put=function(t,e){var r=a(t),n=this._buckets[r];n||(this._buckets[r]=n=[]);for(var i=0;i<n.length;i++){var o=n[i];if(p(t,o.key)){var s=o.value;return o.value=e,s}}n.push({key:t,value:e})},t.prototype.remove=function(t){var e=a(t),r=this._buckets[e];if(r)for(var n=0;n<r.length;n++){var i=r[n];if(p(t,i.key))return 1<r.length?r.splice(n,1):delete this._buckets[e],i.value}},t}(),Kt=function(){function t(t){this._factoryFunction=t,this._map=new Ut}return t.prototype.clear=function(){this._map.clear()},t.prototype.get=function(t){var e=this._map.get(t);return void 0===e&&(e=this._factoryFunction(t),this._map.put(t,e)),e},t}(),qt=(Ot=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},function(t,e){function r(){this.constructor=t}Ot(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Ht=function(){function t(t,e,r){this._dispatcher=null,this._extractors=null,this._db=t,this._baseElement=e,this._changeTrackerMethodName=r}return t.prototype.addChangeTracker=function(t){this._changeTrackerMethodName&&(this._dispatcher||(this._dispatcher=new jt(this._changeTrackerMethodName)),this._dispatcher.add(t)&&this._invalidateExtractors())},t.prototype.removeChangeTracker=function(t){this._dispatcher&&(this._dispatcher.remove(t)&&this._invalidateExtractors())},t.prototype.clearChangeTrackers=function(){this._dispatcher&&(this._dispatcher.clear()&&this._invalidateExtractors())},t.prototype.getVoidExtractor=function(){return this._retrieveExtractor(Wt,void 0)},t.prototype.getFlagExtractor=function(){return this._retrieveExtractor($t,void 0)},t.prototype.getCountExtractor=function(){return this._retrieveExtractor(Zt,void 0)},t.prototype.getSingletonExtractor=function(t){return this._retrieveExtractor(Jt,t)},t.prototype.getListExtractor=function(t){return this._retrieveExtractor(Xt,t)},t.prototype.getCursorExtractor=function(t){return this._retrieveExtractor(te,t)},t.prototype._retrieveExtractor=function(t,e){return this._extractors||(this._extractors=new Kt(this._createExtractor.bind(this))),this._extractors.get({ctorKey:t.key,outputs:e})},t.prototype._invalidateExtractors=function(){this._extractors&&this._extractors.clear()},t.prototype._createExtractor=function(t){var e=ee[t.ctorKey],r=t.outputs,n=this._dispatcher,i=null,o=null;if(r||n&&!n.isEmpty()){var s={};r&&(s[Yt]=r),n&&c(s,n.getOutputsByTargetName()),o=new kt,i=new Lt(this._db,this._baseElement,s,o)}return new e(i,o,n)},t}(),Yt="output",Qt=function(){function t(t,e,r){this._compiledOutputs=t,this._outputValues=e,this._dispatcher=r}return t.prototype.getProviderOutputs=function(){return this._compiledOutputs?this._compiledOutputs.getProviderOutputs():[]},t.prototype.processForCursorResult=function(t){return new zt(t,this._prcessResultElement,this)},t.prototype.processAllForFullResult=function(t,o){var n=this;return t.then(function(t){switch(typeof t){case"boolean":case"number":return o.buildPrimitive(t);case"object":break;default:throw new Error("Unexpected provider result type")}var e=K(t);if(Array.isArray(t)){for(var r=0;r<t.length;r++)o.add(n._prcessResultElement(t[r]));return o.build(e)}return u(t)?new Promise(function(i){!function e(r){var n=this;Promise.resolve(r.next()).then(function(t){t.done?i():(o.add(n._prcessResultElement(t.value)),e(r))})}(t)}).then(function(){return o.build(e)}):(o.add(n._prcessResultElement(t)),o.build(e))})},t.prototype.processOneForFullResult=function(t,e){var r=this;return t.then(function(t){switch(typeof t){case"boolean":case"number":return e.buildPrimitive(t);case"object":break;default:throw new Error("Unexpected provider result type")}return Array.isArray(t)?(0<t.length&&e.add(r._prcessResultElement(t[0])),e.build(null)):u(t)?Promise.resolve(t.next()).then(function(t){return t.done||e.add(r._prcessResultElement(t.value)),e.build(null)}):(e.add(r._prcessResultElement(t)),e.build(null))})},t.prototype._prcessResultElement=function(t){var e=this;return this._outputValues?this._outputValues.prepareTargets(t).then(function(t){return e._dispatcher&&e._dispatcher.notify(t),t[Yt]}):(this._dispatcher&&this._dispatcher.notify({}),Promise.resolve())},t}(),Wt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return qt(e,t),e.prototype.extract=function(t){return this.processAllForFullResult(t,{add:function(t){},build:function(t){},buildPrimitive:function(){}})},e}(Qt),$t=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return qt(e,t),e.prototype.extract=function(t){var e=!1;return this.processAllForFullResult(t,{add:function(t){e=!0},build:function(t){return e},buildPrimitive:function(t){return"number"==typeof t?0<t:!!t}})},e}(Qt),Zt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return qt(e,t),e.prototype.extract=function(t){var e=0;return this.processAllForFullResult(t,{add:function(t){e++},build:function(t){return e},buildPrimitive:function(t){if("number"!=typeof t)throw new Error("Provider result not processable as count");return t}})},e}(Qt),Jt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return qt(e,t),e.prototype.extract=function(t){var e=null;return this.processOneForFullResult(t,{add:function(t){e=t},build:function(t){return e||null},buildPrimitive:function(t){throw new Error("Provider result not processable as singleton")}})},e}(Qt),Xt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return qt(e,t),e.prototype.extract=function(t){var e=[];return this.processAllForFullResult(t,{add:function(t){e.push(t)},build:function(n){return Promise.all(e).then(function(t){return e=t,r=new i(n),e.getMetadata=function(){return r},e;var e,r})},buildPrimitive:function(t){throw new Error("Provider result not processable as list")}})},e}(Qt),te=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return qt(e,t),e.prototype.extract=function(t){return this.processForCursorResult(t)},e}(Qt),ee=(It={},Pt=0,[Wt,$t,Zt,Jt,Xt,te].forEach(function(t){t.key="extractor"+Pt++,It[t.key]=t}),It),re=function(){function n(t,e,r){this.db=t,this._baseEntity=null,this._baseRelationship=null,this._baseElement=t.getSchema().getEntityOrRelationship(e),this._baseElement instanceof X?this._baseEntity=this._baseElement:this._baseRelationship=this._baseElement,this._baseElementMappedName=n._computeStoreOrRelationName(this._baseElement),this._resultProcessor=new Ht(this.db,this._baseElement,r),this._inputValues=new Mt}return n._computeStoreOrRelationName=function(t){return t instanceof X?W.getStoreName(t):W.getRelationName(t)},n.prototype.addChangeTracker=function(t){this._resultProcessor.addChangeTracker(t)},n.prototype.removeChangeTracker=function(t){this._resultProcessor.removeChangeTracker(t)},n.prototype.clearChangeTrackers=function(){this._resultProcessor.clearChangeTrackers()},n.prototype.hasBaseEntity=function(){return!!this._baseEntity},n.prototype.getBaseEntity=function(){if(!this._baseEntity)throw new Error("Base entity is not available");return this._baseEntity},n.prototype.getBaseRelationship=function(){if(!this._baseRelationship)throw new Error("Base relationship is not available");return this._baseRelationship},n.prototype.getBaseElementMappedName=function(){return this._baseElementMappedName},n.prototype.createEntityInputsCompiler=function(t){if(!(this._baseElement instanceof X))throw new Error("Entity inputs are supported only on entity-based queries");return new Et(this.db,this._baseElement,t,this._inputValues)},n.prototype.createInputsCompiler=function(t){return new St(this.db,this._baseElement,t,this._inputValues)},n.prototype.createFilterCompiler=function(t){return new Tt(this.db,this._baseElement,t,this._inputValues)},n.prototype.compileOrder=function(t){return new yt(this.db,this._baseElement,t)},n.prototype.prepareInputParameters=function(t){return this._inputValues.prepareObject(t)},n.prototype.getVoidExtractor=function(){return this._resultProcessor.getVoidExtractor()},n.prototype.getFlagExtractor=function(){return this._resultProcessor.getFlagExtractor()},n.prototype.getCountExtractor=function(){return this._resultProcessor.getCountExtractor()},n.prototype.getSingletonExtractor=function(t){return this._resultProcessor.getSingletonExtractor(t)},n.prototype.getListExtractor=function(t){return this._resultProcessor.getListExtractor(t)},n.prototype.getCursorExtractor=function(t){return this._resultProcessor.getCursorExtractor(t)},n}(),ne=(Ct=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},function(t,e){function r(){this.constructor=t}Ct(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),ie=function(i){function t(t,e,r){var n=i.call(this,t,e,"afterDelete")||this;return n._entityInputsCompiler=n._createEntityInputsCompiler(r),n._filterCompiler=n._createFilterCompiler(r),n}return ne(t,i),t.prototype._createEntityInputsCompiler=function(t){var e=t&&t.entityInputs;if(this.hasBaseEntity())return void 0===e&&(e=this.getBaseEntity().getInputs().map(function(t){var e=t.getName();return{input:e,valueInput:e}})),this.createEntityInputsCompiler(e);if(e&&0<e.length)throw new Error("Entity inputs are not supported in relationship-based queries");return null},t.prototype._createFilterCompiler=function(t){var e=t&&t.filter;return void 0===e?null:this.createFilterCompiler(e)},t.prototype._createKeyOutputs=function(){return this.hasBaseEntity()?this.getBaseEntity().getKeyAttribute().getName():[this.getBaseRelationship().getEntity1(),this.getBaseRelationship().getEntity2()].map(function(t){return t.getName()+"."+t.getKeyAttribute().getName()})},t.prototype.execute=function(t,e){return this._doExecute(t,e,this.getVoidExtractor())},t.prototype.executeGetChanged=function(t,e){return this._doExecute(t,e,this.getFlagExtractor())},t.prototype.executeGetCount=function(t,e){return this._doExecute(t,e,this.getCountExtractor())},t.prototype.executeGetKeys=function(t,e){return this._doExecute(t,e,this.getListExtractor(this._createKeyOutputs()))},t.prototype._doExecute=function(n,t,i){var o=this;return i.extract(Promise.resolve().then(function(){return o.prepareInputParameters(t)}).then(function(t){var e=o._createCommandDescriptor(t,i);if(!e)return[];var r=o.db.compileDeleteCommand(e);return z(n).executeCommand(r,t)}))},t.prototype._createCommandDescriptor=function(t,e){var r,n;if(this._filterCompiler){var i=this._filterCompiler.compile(t);if(!i.isApplicable())return null;if(i.isFixed()){if(!0!==i.getFixedResult())return null;r=void 0}else r=i.getProviderExpression()}else r=void 0;return n=this._entityInputsCompiler?this._entityInputsCompiler.compile(t).getProviderStoreInputs():[],{storeOrRelationName:this.getBaseElementMappedName(),storeInputs:n,filter:r,outputs:e.getProviderOutputs()}},t}(re),oe=function(){function t(t,e){this._db=t,this._eventListener=e}return t.prototype.begunTransaction=function(t){this._eventListener.begunTransaction?this._eventListener.begunTransaction({database:this._db,readOnly:t.readOnly}):this.begunTransaction=se},t.prototype.resolvedTransaction=function(t){this._eventListener.resolvedTransaction?this._eventListener.resolvedTransaction({database:this._db,readOnly:t.readOnly,committed:t.committed}):this.begunTransaction=se},t.prototype.executingCommand=function(t){this._eventListener.executingCommand?this._eventListener.executingCommand({database:this._db,command:t.command,commandParameters:t.commandParameters}):this.executingCommand=se},t.prototype.executedCommand=function(t){this._eventListener.executedCommand?this._eventListener.executedCommand({database:this._db,command:t.command,commandParameters:t.commandParameters,commandError:t.commandError}):this.executedCommand=se},t}();function se(){}var ue,ae,pe,ce,le,fe=(ue=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},function(t,e){function r(){this.constructor=t}ue(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),he=function(i){function t(t,e,r){var n=i.call(this,t,e,"afterInsert")||this;return n._entityInputsCompiler=n._createEntityInputsCompiler(r),n._inputsCompiler=n._createInputsCompiler(r),n}return fe(t,i),t.prototype._createEntityInputsCompiler=function(t){var e=t&&t.entityInputs;if(this.hasBaseEntity())return void 0===e&&(e=this.getBaseEntity().getInputs().map(function(t){var e=t.getName();return{input:e,valueInput:e}})),this.createEntityInputsCompiler(e);if(e&&0<e.length)throw new Error("Entity inputs are not supported in relationship-based queries");return null},t.prototype._createInputsCompiler=function(t){var e=t&&t.inserts;return void 0===e&&(this.hasBaseEntity()?(e=[],this.getBaseEntity().getAttributes().forEach(function(t){if(!t.isKey()){var e=t.getName();return{property:e,valueInput:e}}})):e=[this.getBaseRelationship().getEntity1(),this.getBaseRelationship().getEntity2()].map(function(t){var e=t.getName()+"."+t.getKeyAttribute().getName();return{property:e,valueInput:e}})),this.createInputsCompiler(e)},t.prototype._createKeyOutputs=function(){return this.hasBaseEntity()?this.getBaseEntity().getKeyAttribute().getName():[this.getBaseRelationship().getEntity1(),this.getBaseRelationship().getEntity2()].map(function(t){return t.getName()+"."+t.getKeyAttribute().getName()})},t.prototype.execute=function(t,e){return this._doExecute(t,e,this.getVoidExtractor())},t.prototype.executeGetChanged=function(t,e){return this._doExecute(t,e,this.getFlagExtractor())},t.prototype.executeGetKey=function(t,e){return this._doExecute(t,e,this.getSingletonExtractor(this._createKeyOutputs()))},t.prototype._doExecute=function(n,t,i){var o=this;return i.extract(Promise.resolve().then(function(){return o.prepareInputParameters(t)}).then(function(t){var e=o._createCommandDescriptor(t,i);if(!e)return[];var r=o.db.compileInsertCommand(e);return z(n).executeCommand(r,t)}))},t.prototype._createCommandDescriptor=function(t,e){var r,n,i=this._inputsCompiler.compile(t);return i.isEmpty()?null:(r=i.getProviderInputs(),n=this._entityInputsCompiler?this._entityInputsCompiler.compile(t).getProviderStoreInputs():[],{storeOrRelationName:this.getBaseElementMappedName(),storeInputs:n,inserts:r,outputs:e.getProviderOutputs()})},t}(re),de=(ae=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},function(t,e){function r(){this.constructor=t}ae(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),ye=function(i){function t(t,e,r){var n=i.call(this,t,e,void 0)||this;return n._entityInputsCompiler=n._createEntityInputsCompiler(r),n._distinct=n._createDistinct(r),n._outputs=n._createOutputs(r),n._filterCompiler=n._createFilterCompiler(r),n._order=n._createOrder(r),n._limit=n._createLimit(r),n}return de(t,i),t.prototype._createEntityInputsCompiler=function(t){var e=t&&t.entityInputs;if(this.hasBaseEntity())return void 0===e&&(e=this.getBaseEntity().getInputs().map(function(t){var e=t.getName();return{input:e,valueInput:e}})),this.createEntityInputsCompiler(e);if(e&&0<e.length)throw new Error("Entity inputs are not supported in relationship-based queries");return null},t.prototype._createDistinct=function(t){return t&&t.distinct||!1},t.prototype._createOutputs=function(t){var e=t&&t.output;return void 0===e&&(e=this.hasBaseEntity()?this.getBaseEntity().getAttributes().map(function(t){return t.getName()}):[this.getBaseRelationship().getEntity1(),this.getBaseRelationship().getEntity2()].map(function(t){return t.getName()+"."+t.getKeyAttribute().getName()})),e},t.prototype._createFilterCompiler=function(t){var e=t&&t.filter;return void 0===e?null:this.createFilterCompiler(e)},t.prototype._createOrder=function(t){var e=t&&t.order;return void 0===e?null:this.compileOrder(e)},t.prototype._createLimit=function(t){var e=t&&t.limit;return void 0===e?null:"number"==typeof e?{count:e,begin:void 0}:{count:e.count,begin:e.begin}},t.prototype.query=function(t,e){return this._doExecute(t,e,null,this.getCursorExtractor(this._outputs))},t.prototype.queryAll=function(t,e){return this._doExecute(t,e,null,this.getListExtractor(this._outputs))},t.prototype.queryOne=function(t,e){return this._doExecute(t,e,1,this.getSingletonExtractor(this._outputs))},t.prototype._doExecute=function(n,t,i,o){var s=this;return o.extract(Promise.resolve().then(function(){return s.prepareInputParameters(t)}).then(function(t){var e=s._createCommandDescriptor(t,i,o);if(!e)return[];var r=s.db.compileSelectCommand(e);return z(n).executeCommand(r,t,!0)}))},t.prototype._createCommandDescriptor=function(t,e,r){var n,i,o,s;if(this._filterCompiler){var u=this._filterCompiler.compile(t);if(!u.isApplicable())return null;if(u.isFixed()){if(!0!==u.getFixedResult())return null;n=void 0}else n=u.getProviderExpression()}else n=void 0;return i=this._order?this._order.getProviderExpression():[],o=null!==e?{begin:this._limit?this._limit.begin:void 0,count:e}:null!==this._limit?{begin:void 0!==this._limit.begin?this._limit.begin:0,count:this._limit.count}:null,s=this._entityInputsCompiler?this._entityInputsCompiler.compile(t).getProviderStoreInputs():[],{storeOrRelationName:this.getBaseElementMappedName(),storeInputs:s,distinct:this._distinct,outputs:r.getProviderOutputs(),filter:n,order:i,limit:o||void 0}},t}(re),_e=function(){function t(t,e){this._db=t,this._providerSession=e}return t.prototype.createTransaction=function(e){var r=this;return Promise.resolve().then(function(){var t=r._createTransactionDescriptor(e);return r._providerSession.createTransaction(t)}).then(function(t){return new s(r._db,t)})},t.prototype._createTransactionDescriptor=function(t){var e=!(!t||!t.readOnly),r=t&&t.atomic;return{readOnly:e,atomic:void 0!==r&&("number"==typeof r?{interval:r,backoff:void 0}:"boolean"==typeof r?r:{interval:r.interval,backoff:r.backoff})}},t}(),me=(pe=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},function(t,e){function r(){this.constructor=t}pe(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),ge=function(i){function t(t,e,r){var n=i.call(this,t,e,"afterUpdate")||this;return n._entityInputsCompiler=n._createEntityInputsCompiler(r),n._inputsCompiler=n._createInputsCompiler(r),n._filterCompiler=n._createFilterCompiler(r),n}return me(t,i),t.prototype._createEntityInputsCompiler=function(t){var e=t&&t.entityInputs;if(this.hasBaseEntity())return void 0===e&&(e=this.getBaseEntity().getInputs().map(function(t){var e=t.getName();return{input:e,valueInput:e}})),this.createEntityInputsCompiler(e);if(e&&0<e.length)throw new Error("Entity inputs are not supported in relationship-based queries");return null},t.prototype._createInputsCompiler=function(t){var e=t&&t.updates;return void 0===e&&(this.hasBaseEntity()?(e=[],this.getBaseEntity().getAttributes().forEach(function(t){if(!t.isKey()){var e=t.getName();return{property:e,valueInput:e}}})):e=[this.getBaseRelationship().getEntity1(),this.getBaseRelationship().getEntity2()].map(function(t){var e=t.getName()+"."+t.getKeyAttribute().getName();return{property:e,valueInput:e}})),this.createInputsCompiler(e)},t.prototype._createFilterCompiler=function(t){var e=t&&t.filter;return void 0===e?null:this.createFilterCompiler(e)},t.prototype._createKeyOutputs=function(){return this.hasBaseEntity()?this.getBaseEntity().getKeyAttribute().getName():[this.getBaseRelationship().getEntity1(),this.getBaseRelationship().getEntity2()].map(function(t){return t.getName()+"."+t.getKeyAttribute().getName()})},t.prototype.execute=function(t,e){return this._doExecute(t,e,this.getVoidExtractor())},t.prototype.executeGetChanged=function(t,e){return this._doExecute(t,e,this.getFlagExtractor())},t.prototype.executeGetCount=function(t,e){return this._doExecute(t,e,this.getCountExtractor())},t.prototype.executeGetKeys=function(t,e){return this._doExecute(t,e,this.getListExtractor(this._createKeyOutputs()))},t.prototype._doExecute=function(n,t,i){var o=this;return i.extract(Promise.resolve().then(function(){return o.prepareInputParameters(t)}).then(function(t){var e=o._createCommandDescriptor(t,i);if(!e)return[];var r=o.db.compileUpdateCommand(e);return z(n).executeCommand(r,t)}))},t.prototype._createCommandDescriptor=function(t,e){var r,n,i,o=this._inputsCompiler.compile(t);if(o.isEmpty())return null;if(r=o.getProviderInputs(),this._filterCompiler){var s=this._filterCompiler.compile(t);if(!s.isApplicable())return null;if(s.isFixed()){if(!0!==s.getFixedResult())return null;n=void 0}else n=s.getProviderExpression()}else n=void 0;return i=this._entityInputsCompiler?this._entityInputsCompiler.compile(t).getProviderStoreInputs():[],{storeOrRelationName:this.getBaseElementMappedName(),storeInputs:i,updates:r,filter:n,outputs:e.getProviderOutputs()}},t}(re),ve=function(){function t(t,e){this._typeHandler=t,this._fieldName=void 0!==e?e:null}return t.prototype.getMapping=function(){if(null!==this._fieldName)return[{field:this._fieldName}];var t=this._typeHandler.getMapping();return"object"!=typeof t?[{field:""}]:Object.keys(t).map(function(t){return{field:t}})},t.prototype.getOperatorMapping=function(t){if(null!==this._fieldName)return[{field:this._fieldName,operator:t}];var e=this._typeHandler.getOperatorMapping(t);return"object"!=typeof e?[{field:"",operator:e}]:Object.keys(e).map(function(t){return{field:t,operator:e[t]}})},t.prototype.getOrderMapping=function(t){if(null!==this._fieldName)return[{field:this._fieldName,descending:t}];var e=this._typeHandler.getOrderMapping(t);return"object"!=typeof e?[{field:"",descending:e}]:Object.keys(e).map(function(t){return{field:t,descending:e[t]}})},t.prototype.write=function(t,e){var r=t;if(null!==this._fieldName&&(r=new Ee(t,this._fieldName)),Array.isArray(e)){if(1===e.length)return this._typeHandler.write(r,e[0]);if(e.length<1)return;throw new Error("Unable to obtain a single value from input array of length "+e.length)}return this._typeHandler.write(r,e)},t.prototype.writeMultiple=function(t,e){if(!Array.isArray(e))return this.write(t,e);for(var r=[],n=t.createCopy(),i=0;i<e.length;i++){n.setBaseIndex(i);var o=this.write(n,e[i]);d(o)&&(r.push(o),n=n.createCopy())}return 0<r.length?Promise.all(r):void 0},t.prototype.read=function(t){var e=t;return null!==this._fieldName&&(e=new Ee(t,this._fieldName)),this._typeHandler.read(e)},t.prototype.isPresent=function(t,e){for(var r=this.getMapping(),n=0;n<r.length;n++)if(!V(t.get(r[n].field),e))return!0;return!1},t}(),Ee=function(){function t(t,e){this._delegate=t,this._fieldName=e}return t.prototype.setDefault=function(t){this._delegate.set(this._fieldName,t)},t.prototype.getDefault=function(){return this._delegate.get(this._fieldName)},t.prototype.set=function(t,e){if(""!==t)throw new Error("Invalid field '"+t+"'");this._delegate.set(this._fieldName,e)},t.prototype.get=function(t){if(""!==t)throw new Error("Invalid field '"+t+"'");return this._delegate.get(this._fieldName)},t}();(le=ce||(ce={})).isSimpleAuthenticationOptions=function(t){return!!t&&"username"in t},le.isOauthAuthenticationOptions=function(t){return!!t&&"identityToken"in t};var be,we=(be=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},function(t,e){function r(){this.constructor=t}be(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),xe=function(n){function i(t,e){var r=n.call(this,"Version mismatch: expected "+t+", but was "+e)||this;return r.expectedVersion=t,r.actualVersion=e,r.name="xdata.VersionError",Object.setPrototypeOf(r,i.prototype),r}return we(i,n),i}(Error),Ne={};function Oe(t,e,r){Ne[t]=new Ie(t,e,r)}var Ie=function(){function t(t,e,r){this._simpleType=t,this._textualOperators=e,this._convertFunction=r}return t.prototype.getMapping=function(){return this._simpleType},t.prototype.getOperatorMapping=function(t){if(!this._textualOperators)switch(t){case at.EMPTY:return at.NULL;case at.NOT_EMPTY:return at.NOT_NULL}return t},t.prototype.getOrderMapping=function(t){return t},t.prototype.read=function(t){return t.getDefault()},t.prototype.write=function(t,e){null==e?t.setDefault(e):t.setDefault(this._convertFunction(e))},t}();Oe(b.ARRAYBUFFER,!1,function(t){function e(t){return t instanceof ArrayBuffer||"number"==typeof t.byteLength}if(e(t))return t;if("buffer"in t&&e(t.buffer))return t.buffer;throw new Error("Value not convertible to ArrayBuffer: "+t)}),Oe(b.BOOLEAN,!1,function(t){return!0===t||"true"===t||(t instanceof Boolean?!!t.valueOf():"number"==typeof t&&0!==t)}),Oe(b.DATE,!1,function(t){if("[object Date]"===Object.prototype.toString.call(t))return t;if("number"==typeof t)return new Date(t);if("string"==typeof t)return new Date(t);throw new Error("Value not convertible to Date: "+t)}),Oe(b.DECIMAL,!1,function(t){if(t instanceof Number&&(t=t.valueOf()),"number"==typeof t){if(!isFinite(t))throw new Error("Value not convertible to decimal string: "+t);return String(t)}var e=String(t);if(!/^[+\-]?(?:\d+(?:\.\d+)?|\.\d+)$/.test(e))throw new Error("Value not convertible to decimal string: "+t);return e}),Oe(b.INTEGER,!1,function(t){var e=Number(t);if(isNaN(e))throw new Error("Value not convertible to number: "+t);if(e%1!=0)throw new Error("Value not convertible to integer: "+t);return e}),Oe(b.REAL,!1,function(t){var e=Number(t);if(isNaN(e))throw new Error("Value not convertible to number: "+t);return e}),Oe(b.STRING,!0,function(t){return String(t)});var Pe,Ce,Ae,Te,Re,Fe=function(){function r(t){this._overridden={},this._handlers=t?{}:c({},r._GLOBAL._handlers)}var n;return r.prototype.register=function(t,e){if(this._overridden.hasOwnProperty(t))throw new Error("Handler for type '"+t+"' is already registered");this._handlers[t]=e,this._overridden[t]=!0},r.prototype.get=function(t){var e=this._handlers[t];if(!e)throw new Error("Unknown type '"+t+"'");return e},r.register=function(t,e){r._GLOBAL.register(t,e)},r._GLOBAL=(n=new r(!0),l(b).forEach(function(t){var e=Ne[t];n.register(t,e)}),n),r}(),Se=(Pe=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},function(t,e){function r(){this.constructor=t}Pe(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),Me=function(n){function i(t){var e=n.call(this,"",t)||this;t=i.normalizeConfig(t);var r=new Fe;return t.typeHandlers&&h(t.typeHandlers,function(t,e){r.register(e,t)}),e._typeHandlers=r,e._rels=v(t,"relationships",ht,e,"relationship"),e._entities=v(t,"entities",X,e,"entity"),e._entities.list.forEach(function(t){if(e._rels.map.hasOwnProperty(t.getName()))throw new Error("Name '"+t.getName()+"' conflict between entities and relationships")}),e}return Se(i,n),i.normalizeConfig=function(t){if(!t)throw new Error("Missing configuration");return t.hasOwnProperty("entities")||(t.entities={}),t.hasOwnProperty("relationships")||(t.relationships={}),t},i.normalize=function(t){return t instanceof i?t:new i(t)},i.prototype.getTypeHandler=function(t){return this._typeHandlers.get(t)},i.prototype.getEntities=function(){return this._entities.list},i.prototype.hasEntity=function(t){return!!this._entities.map[t]},i.prototype.getEntity=function(t){return E(this._entities.map,t,"entity")},i.prototype.getRelationships=function(){return this._rels.list},i.prototype.hasRelationship=function(t){return!!this._rels.map[t]},i.prototype.getRelationship=function(t){return E(this._rels.map,t,"relationship")},i.prototype.getEntityOrRelationship=function(t){return this._entities.map.hasOwnProperty(t)?this._entities.map[t]:E(this._rels.map,t,"entity or relationship")},i.EMPTY=new i({}),i}(x),je=function(){function o(t,e,r,n){this._listeners=[],this._providerName=t,this._version=r,this._schemaMapper=new W(n,t);var i=o._getProvider(t,e).createDatabase(r,this._schemaMapper.getProviderSchema());this._providerDb=i,this._selectCommandCache=new Kt(i.compileSelectCommand.bind(i)),this._insertCommandCache=new Kt(i.compileInsertCommand.bind(i)),this._updateCommandCache=new Kt(i.compileUpdateCommand.bind(i)),this._deleteCommandCache=new Kt(i.compileDeleteCommand.bind(i))}return o.prototype.getVersion=function(){return this._version},o.prototype.getSchema=function(){return this._schemaMapper.getSchema()},o.prototype.createSession=function(r,t){var n=this,i=t&&t.autoCreate;void 0===i&&(i=!0);var o=this._providerDb,s=this._createSessionDescriptor(t);return Promise.resolve().then(function(){return o.createSession(r,s)}).catch(function(t){if(i&&t instanceof xe&&t.actualVersion<0){var e=n._createSchemaFactory();return Promise.resolve(o.upgradeVersion(r,e)).then(function(){return o.createSession(r,s)})}throw t}).then(function(t){return new _e(n,t)})},o.prototype._createSessionDescriptor=function(t){var e=t&&t.authentication,r=null,n=null,i=null,o=null,s={};return e&&(ce.isSimpleAuthenticationOptions(e)?(r=void 0===e.username?null:e.username,n=void 0===e.username?null:e.password):ce.isOauthAuthenticationOptions(e)&&(i=void 0===e.identityToken?null:e.identityToken,o=void 0===e.identityTokenType?null:e.identityTokenType,void 0!==e.customHeaders&&(s=e.customHeaders))),{username:r,password:n,identityToken:i,identityTokenType:o,customHeaders:s}},o.prototype.upgradeVersion=function(t,e){var r=this._providerDb,n=this._createSchemaFactory(e);return Promise.resolve().then(function(){return r.upgradeVersion(t,n)})},o.prototype._createSchemaFactory=function(r){var n=this._providerName;return function(t){var e;if(t<0)e=Me.EMPTY;else{if(!r)throw new Error("No schema available for version "+t);e=Me.normalize(r(t))}return new W(e,n).getProviderSchema()}},o.prototype.getAttributeValueAccessor=function(t,e){var r;return r=void 0!==e?this.getSchema().getTypeHandler(t.getField(e).getType()):this.getSchema().getTypeHandler(t.getType()),new ve(r,e)},o.prototype.getInputValueAccessor=function(t,e){var r;return r=void 0!==e?this.getSchema().getTypeHandler(t.getField(e).getType()):this.getSchema().getTypeHandler(t.getType()),new ve(r,e)},o.prototype.prepareSelect=function(t,e){return new ye(this,t,e)},o.prototype.compileSelectCommand=function(t){return this._selectCommandCache.get(t)},o.prototype.prepareInsert=function(t,e){return new he(this,t,e)},o.prototype.compileInsertCommand=function(t){return this._insertCommandCache.get(t)},o.prototype.prepareUpdate=function(t,e){return new ge(this,t,e)},o.prototype.compileUpdateCommand=function(t){return this._updateCommandCache.get(t)},o.prototype.prepareDelete=function(t,e){return new ie(this,t,e)},o.prototype.compileDeleteCommand=function(t){return this._deleteCommandCache.get(t)},o.prototype.attachSession=function(t){var e=this._providerDb.attachSession(t);return new _e(this,e)},o.prototype.attachTransaction=function(t){var e=this._providerDb.attachTransaction(t);return new s(this,e)},o.prototype.addListener=function(t){var e=new oe(this,t);this._providerDb.addListener(e),this._listeners.push({listener:t,providerListener:e})},o.prototype.removeListener=function(t){for(var e=0;e<this._listeners.length;e++)if(this._listeners[e].listener===t)return this._providerDb.removeListener(this._listeners[e].providerListener),void this._listeners.splice(e,1)},o.registerProviderConstructor=function(t,e){var r=o._PROVIDERS_REGISTRY;if(r.hasOwnProperty(t))throw new Error("Provider '"+t+"' already registered");r[t]={ctor:e,instance:null}},o._getProvider=function(t,e){var r=o._PROVIDERS_REGISTRY[t];if(!r)throw new Error("Unknown provider '"+t+"'");var n=r.instance;return n||(n=f(r.ctor,e),r.instance=n),n},o._PROVIDERS_REGISTRY={},o}();function Le(t,e){je.registerProviderConstructor(t,e)}function ke(t,e){Fe.register(t,e)}function Be(t,e,r,n){var i=Me.normalize(n);return new je(t,e,r,i)}((Ae=Ce||(Ce={})).FilterExpression||(Ae.FilterExpression={})).isFilterTerm=function(t){return"fieldPath"in t},(Te||(Te={})).ATOMIC_TRANSACTIONS="atomicTransactions",Re||(Re={}),r.d(e,"createDatabase",function(){return Be}),r.d(e,"registerProvider",function(){return Le}),r.d(e,"registerTypeHandler",function(){return ke}),r.d(e,"CollectionOperator",function(){return bt}),r.d(e,"LogicOperator",function(){return st}),r.d(e,"Filter",function(){return rt}),r.d(e,"Provider",function(){return Ce}),r.d(e,"ProviderFeature",function(){return Te}),r.d(e,"Query",function(){return Re}),r.d(e,"Session",function(){return ce}),r.d(e,"SimpleType",function(){return b}),r.d(e,"ValueOperator",function(){return at}),r.d(e,"VersionError",function(){return xe}),r.d(e,"Attribute",function(){return M}),r.d(e,"AttributeField",function(){return T}),r.d(e,"Element",function(){return x}),r.d(e,"Entity",function(){return X}),r.d(e,"Index",function(){return Z}),r.d(e,"Input",function(){return B}),r.d(e,"InputField",function(){return L}),r.d(e,"Property",function(){return F}),r.d(e,"Relationship",function(){return ht}),r.d(e,"Role",function(){return lt}),r.d(e,"Schema",function(){return Me}),r.d(e,"ObjectCache",function(){return Kt}),r.d(e,"ObjectMap",function(){return Ut})}])});