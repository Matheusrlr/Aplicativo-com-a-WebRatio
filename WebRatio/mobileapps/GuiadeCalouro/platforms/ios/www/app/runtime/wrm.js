(function(GLOBAL,undefined,define){if(GLOBAL["wrm"]){return};(function(n){function t(n){var f,i,e,u=this;if(!(u instanceof t))return new t(n);if(n instanceof t){u.s=n.s;u.e=n.e;u.c=n.c.slice();return}for(n===0&&1/n<0?n="-0":l.test(n+="")||r(NaN),u.s=n.charAt(0)=="-"?(n=n.slice(1),-1):1,(f=n.indexOf("."))>-1&&(n=n.replace(".","")),(i=n.search(/e/i))>0?(f<0&&(f=i),f+=+n.slice(i+1),n=n.substring(0,i)):f<0&&(f=n.length),i=0;n.charAt(i)=="0";i++);if(i==(e=n.length))u.c=[u.e=0];else{for(;n.charAt(--e)=="0";);for(u.e=f-i-1,u.c=[],f=0;i<=e;u.c[f++]=+n.charAt(i++));
}}function o(n,t,i,u){var e=n.c,f=n.e+t+1;if(i===1?u=e[f]>=5:i===2?u=e[f]>5||e[f]==5&&(u||f<0||e[f+1]!=null||e[f-1]&1):i===3?u=u||e[f]!=null||f<0:(u=!1,i!==0)&&r("!Big.RM!"),f<1||!e[0])n.c=u?(n.e=-t,[1]):[n.e=0];else{if(e.length=f--,u)for(;++e[f]>9;)e[f]=0,f--||(++n.e,e.unshift(1));for(f=e.length;!e[--f];e.pop());}return n}function r(n){var t=new Error(n);t.name="BigError";throw t;}function h(n,i,r){var u=i-(n=new t(n)).e,e=n.c;for(e.length>++i&&o(n,u,t.RM),u=e[0]?r?i:(e=n.c,n.e+u+1):u+1;e.length<
u;e.push(0));return u=n.e,r==1||r==2&&(i<=u||u<=f)?(n.s<0&&e[0]?"-":"")+(e.length>1?(e.splice(1,0,"."),e.join("")):e[0])+(u<0?"e":"e+")+u:n.toString()}t.DP=20;t.RM=1;var u=1E6,c=1E6,f=-7,e=21,i=t.prototype,l=/^-?(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,s=new t(1);i.abs=function(){var n=new t(this);return n.s=1,n};i.cmp=function(n){var o,h=this,f=h.c,e=(n=new t(n)).c,i=h.s,s=n.s,r=h.e,u=n.e;if(!f[0]||!e[0])return f[0]?i:e[0]?-s:0;if(i!=s)return i;if(o=i<0,r!=u)return r>u^o?1:-1;for(i=-1,s=(r=f.length)<(u=
e.length)?r:u;++i<s;)if(f[i]!=e[i])return f[i]>e[i]^o?1:-1;return r==u?0:r>u^o?1:-1};i.div=function(n){var b=this,l=b.c,h=(n=new t(n)).c,p=b.s==n.s?1:-1,a=t.DP;if((a!==~~a||a<0||a>u)&&r("!Big.DP!"),!l[0]||!h[0])return l[0]==h[0]&&r(NaN),h[0]||r(p/0),new t(p*0);var c,k,w,v,e,it=h.slice(),d=c=h.length,rt=l.length,i=l.slice(0,c),f=i.length,y=new t(s),g=y.c=[],nt=0,tt=a+(y.e=b.e-n.e)+1;for(y.s=p,p=tt<0?0:tt,it.unshift(0);f++<c;i.push(0));do{for(w=0;w<10;w++){if(c!=(f=i.length))v=c>f?1:-1;else for(e=-1,
v=0;++e<c;)if(h[e]!=i[e]){v=h[e]>i[e]?1:-1;break}if(v<0){for(k=f==c?h:it;f;){if(i[--f]<k[f]){for(e=f;e&&!i[--e];i[e]=9);--i[e];i[f]+=10}i[f]-=k[f]}for(;!i[0];i.shift());}else break}g[nt++]=v?w:++w;i[0]&&v?i[f]=l[d]||0:i=[l[d]]}while((d++<rt||i[0]!=null)&&p--);return g[0]||nt==1||(g.shift(),y.e--),nt>tt&&o(y,a,t.RM,i[0]!=null),y};i.eq=function(n){return!this.cmp(n)};i.gt=function(n){return this.cmp(n)>0};i.gte=function(n){return this.cmp(n)>-1};i.lt=function(n){return this.cmp(n)<0};i.lte=function(n){return this.cmp(n)<
1};i.minus=function(n){var e,o,s,l,h=this,f=h.s,r=(n=new t(n)).s;if(f!=r)return n.s=-r,h.plus(n);var i=h.c.slice(),a=h.e,u=n.c,c=n.e;if(!i[0]||!u[0])return u[0]?(n.s=-r,n):new t(i[0]?h:0);if(f=a-c){for(e=(l=f<0)?(f=-f,i):(c=a,u),e.reverse(),r=f;r--;e.push(0));e.reverse()}else for(s=((l=i.length<u.length)?i:u).length,f=r=0;r<s;r++)if(i[r]!=u[r]){l=i[r]<u[r];break}if(l&&(e=i,i=u,u=e,n.s=-n.s),(r=-((s=i.length)-u.length))>0)for(;r--;i[s++]=0);for(r=u.length;r>f;){if(i[--r]<u[r]){for(o=r;o&&!i[--o];i[o]=
9);--i[o];i[r]+=10}i[r]-=u[r]}for(;i[--s]==0;i.pop());for(;i[0]==0;i.shift(),--c);return i[0]||(n.s=1,i=[c=0]),n.c=i,n.e=c,n};i.mod=function(n){n=new t(n);var e,i=this,u=i.s,f=n.s;return n.c[0]||r(NaN),i.s=n.s=1,e=n.cmp(i)==1,i.s=u,n.s=f,e?new t(i):(u=t.DP,f=t.RM,t.DP=t.RM=0,i=i.div(n),t.DP=u,t.RM=f,this.minus(i.times(n)))};i.plus=function(n){var e,o=this,r=o.s,f=(n=new t(n)).s;if(r!=f)return n.s=-f,o.minus(n);var h=o.e,i=o.c,s=n.e,u=n.c;if(!i[0]||!u[0])return u[0]?n:new t(i[0]?o:r*0);if(i=i.slice(),
r=h-s){for(e=r>0?(s=h,u):(r=-r,i),e.reverse();r--;e.push(0));e.reverse()}for(i.length-u.length<0&&(e=u,u=i,i=e),r=u.length,f=0;r;f=(i[--r]=i[r]+u[r]+f)/10^0,i[r]%=10);for(f&&(i.unshift(f),++s),r=i.length;i[--r]==0;i.pop());return n.c=i,n.e=s,n};i.pow=function(n){var f=n<0,i=new t(this),u=s;for((n!==~~n||n<-c||n>c)&&r("!pow!"),n=f?-n:n;;){if(n&1&&(u=u.times(i)),n>>=1,!n)break;i=i.times(i)}return f?s.div(u):u};i.round=function(n,i){var f=new t(this);return n==null?n=0:(n!==~~n||n<0||n>u)&&r("!round!"),
o(f,n,i==null?t.RM:i),f};i.sqrt=function(){var f,n,e,u=this,h=u.c,i=u.s,s=u.e,c=new t("0.5");if(!h[0])return new t(u);i<0&&r(NaN);i=Math.sqrt(u.toString());i==0||i==1/0?(f=h.join(""),f.length+s&1||(f+="0"),n=new t(Math.sqrt(f).toString()),n.e=((s+1)/2|0)-(s<0||s&1)):n=new t(i.toString());i=n.e+(t.DP+=4);do e=n,n=c.times(e.plus(u.div(e)));while(e.c.slice(0,i).join("")!==n.c.slice(0,i).join(""));return o(n,t.DP-=4,t.RM),n};i.times=function(n){var i,h=this,e=h.c,o=(n=new t(n)).c,s=e.length,r=o.length,
f=h.e,u=n.e;if(n.s=h.s==n.s?1:-1,!e[0]||!o[0])return new t(n.s*0);for(n.e=f+u,s<r&&(i=e,e=o,o=i,u=s,s=r,r=u),u=s+r,i=[];u--;i.push(0));for(f=r-1;f>-1;f--){for(r=0,u=s+f;u>f;r=i[u]+o[f]*e[u-f-1]+r,i[u--]=r%10|0,r=r/10|0);r&&(i[u]=(i[u]+r)%10)}for(r&&++n.e,i[0]||i.shift(),u=i.length;!i[--u];i.pop());return n.c=i,n};i.toString=i.valueOf=i.toJSON=function(){var r=this,t=r.e,n=r.c.join(""),i=n.length;if(t<=f||t>=e)n=n.charAt(0)+(i>1?"."+n.slice(1):"")+(t<0?"e":"e+")+t;else if(t<0){for(;++t;n="0"+n);n=
"0."+n}else if(t>0)if(++t>i)for(t-=i;t--;n+="0");else t<i&&(n=n.slice(0,t)+"."+n.slice(t));else i>1&&(n=n.charAt(0)+"."+n.slice(1));return r.s<0&&r.c[0]?"-"+n:n};i.toExponential=function(n){return n==null?n=this.c.length-1:(n!==~~n||n<0||n>u)&&r("!toExp!"),h(this,n,1)};i.toFixed=function(n){var t,i=this,o=f,s=e;return f=-(e=1/0),n==null?t=i.toString():n===~~n&&n>=0&&n<=u&&(t=h(i,i.e+n),i.s<0&&i.c[0]&&t.indexOf("-")<0&&(t="-"+t)),f=o,e=s,t||r("!toFix!"),t};i.toPrecision=function(n){return n==null?
this.toString():((n!==~~n||n<1||n>u)&&r("!toPre!"),h(this,n-1,2))};typeof module!="undefined"&&module.exports?module.exports=t:typeof define=="function"&&define.amd?define(function(){return t}):n.Big=t})(this);/*
 jahashtable, a JavaScript implementation of a hash table. It creates a single constructor function called
 Hashtable in the global scope.

 http://www.timdown.co.uk/jshashtable/
 Copyright 2013 Tim Down.
 Version: 3.0
 Build date: 17 July 2013

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
var Hashtable=function(t){function n(t){return typeof t==p?t:""+t}function e(t){var r;return typeof t==p?t:typeof t.hashCode==y?(r=t.hashCode(),typeof r==p?r:e(r)):n(t)}function r(t,n){for(var e in n)n.hasOwnProperty(e)&&(t[e]=n[e])}function i(t,n){return t.equals(n)}function u(t,n){return typeof n.equals==y?n.equals(t):t===n}function o(n){return function(e){if(null===e)throw new Error("null is not a valid "+n);if(e===t)throw new Error(n+" must not be undefined");}}function s(t,n,e,r){this[0]=t,this.entries=
[],this.addEntry(n,e),null!==r&&(this.getEqualityFunction=function(){return r})}function a(t){return function(n){for(var e,r=this.entries.length,i=this.getEqualityFunction(n);r--;)if(e=this.entries[r],i(n,e[0]))switch(t){case E:return!0;case K:return e;case q:return[r,e[1]]}return!1}}function l(t){return function(n){for(var e=n.length,r=0,i=this.entries,u=i.length;u>r;++r)n[e+r]=i[r][t]}}function f(t,n){for(var e,r=t.length;r--;)if(e=t[r],n===e[0])return r;return null}function h(t,n){var e=t[n];return e&&
e instanceof s?e:null}function c(){var n=[],i={},u={replaceDuplicateKey:!0,hashCode:e,equals:null},o=arguments[0],a=arguments[1];a!==t?(u.hashCode=o,u.equals=a):o!==t&&r(u,o);var l=u.hashCode,c=u.equals;this.properties=u,this.put=function(t,e){g(t),d(e);var r,o,a=l(t),f=null;return r=h(i,a),r?(o=r.getEntryForKey(t),o?(u.replaceDuplicateKey&&(o[0]=t),f=o[1],o[1]=e):r.addEntry(t,e)):(r=new s(a,t,e,c),n.push(r),i[a]=r),f},this.get=function(t){g(t);var n=l(t),e=h(i,n);if(e){var r=e.getEntryForKey(t);
if(r)return r[1]}return null},this.containsKey=function(t){g(t);var n=l(t),e=h(i,n);return e?e.containsKey(t):!1},this.containsValue=function(t){d(t);for(var e=n.length;e--;)if(n[e].containsValue(t))return!0;return!1},this.clear=function(){n.length=0,i={}},this.isEmpty=function(){return!n.length};var y=function(t){return function(){for(var e=[],r=n.length;r--;)n[r][t](e);return e}};this.keys=y("keys"),this.values=y("values"),this.entries=y("getEntries"),this.remove=function(t){g(t);var e,r=l(t),u=
null,o=h(i,r);return o&&(u=o.removeEntryForKey(t),null!==u&&0==o.entries.length&&(e=f(n,r),n.splice(e,1),delete i[r])),u},this.size=function(){for(var t=0,e=n.length;e--;)t+=n[e].entries.length;return t}}var y="function",p="string",v="undefined";if(typeof encodeURIComponent==v||Array.prototype.splice===t||Object.prototype.hasOwnProperty===t)return null;var g=o("key"),d=o("value"),E=0,K=1,q=2;return s.prototype={getEqualityFunction:function(t){return typeof t.equals==y?i:u},getEntryForKey:a(K),getEntryAndIndexForKey:a(q),
removeEntryForKey:function(t){var n=this.getEntryAndIndexForKey(t);return n?(this.entries.splice(n[0],1),n[1]):null},addEntry:function(t,n){this.entries.push([t,n])},keys:l(0),values:l(1),getEntries:function(t){for(var n=t.length,e=0,r=this.entries,i=r.length;i>e;++e)t[n+e]=r[e].slice(0)},containsKey:a(E),containsValue:function(t){for(var n=this.entries,e=n.length;e--;)if(t===n[e][1])return!0;return!1}},c.prototype={each:function(t){for(var n,e=this.entries(),r=e.length;r--;)n=e[r],t(n[0],n[1])},
equals:function(t){var n,e,r,i=this.size();if(i==t.size()){for(n=this.keys();i--;)if(e=n[i],r=t.get(e),null===r||r!==this.get(e))return!1;return!0}return!1},putAll:function(t,n){for(var e,r,i,u,o=t.entries(),s=o.length,a=typeof n==y;s--;)e=o[s],r=e[0],i=e[1],a&&(u=this.get(r))&&(i=n(r,u,i)),this.put(r,i)},clone:function(){var t=new c(this.properties);return t.putAll(this),t}},c.prototype.toQueryString=function(){for(var t,e=this.entries(),r=e.length,i=[];r--;)t=e[r],i[r]=encodeURIComponent(n(t[0]))+
"\x3d"+encodeURIComponent(n(t[1]));return i.join("\x26")},c}();;;(function(){"use strict";'use strict';var DEBUG=!1,FILE_NAME="wrm.js",FILE_VERSION="8.10.3.201902120438",SLOWDOWN=0,TEST_LOGS=!1,TRACE=!1;var exportSymbol=function(a,b,c){_exportPath(a,b,c)},_exportPath=function(a,b,c){a=a.split(".");c=c||GLOBAL;for(var d;a.length&&(d=a.shift());){var e=c;a.length||void 0===b?c[d]?c=c[d]:(c=c[d]={},DEBUG&&_processExportedSymbol(e,d,c)):(c[d]=b,DEBUG&&_processExportedSymbol(c,d,b))}},exportProperty=function(a,b,c){a[b]=c;DEBUG&&_processExportedSymbol(a,b,c)};
if(DEBUG)var _processExportedSymbol=function(a,b,c){!c||"function"!==typeof c&&"object"!==typeof c||(a=a===GLOBAL?"":_getSymbolName(a)||null,null!==a&&(b=a?a+"."+b:b,_nameSymbol(c,b),"function"===typeof c&&_nameSymbol(c.prototype,b+".prototype")))},_nameSymbol=function(a,b){var c=!1;try{var d={};Object.defineProperty(d,"test",{value:"foo"});c="foo"===d.test}catch(e){}_nameSymbol=c=c?function(a,b){Object.prototype.hasOwnProperty.call(a,"__wr_symbol")||Object.defineProperty(a,"__wr_symbol",{value:b,
enumerable:!1,configurable:!0});"function"!==typeof a||Object.prototype.hasOwnProperty.call(a,"displayName")||Object.defineProperty(a,"displayName",{value:b,configurable:!0})}:function(a,b){};c(a,b)},_getSymbolName=function(a){return a.__wr_symbol||null};var EMPTY_FUNCTION=function(){},ABSTRACT_METHOD=function(){throw Error("Unimplemented abstract method");},newObject=function(a,b){if(a){var c=function(){};c.prototype=a;a=new c}else a={};if(b)for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);return a},_extendConstructor=function(a,b){a._super=b.prototype;a.prototype=newObject(b.prototype);a.prototype.constructor=a},extendConstructor=_extendConstructor,extendFunctionPrototype=_extendConstructor,makeCustomErrorConstructor=function(a,b,c){b=b||GLOBAL.Error;
var d=function(e){e=e||a;var f=b.call(this,e);angular.extend(this,f);this.name=a;this.message=f.message;"function"===typeof Error.captureStackTrace&&Error.captureStackTrace(f,d);void 0!==f.stack&&(this.stack=a+(e?": "+e:"")+"\n"+f.stack.split(/\n+/).slice(1).join("\n"));c&&c.apply(this,Array.prototype.slice.call(arguments,0))};_extendConstructor(d,b);return d};
if(DEBUG)var checkInterface=function(a,b){if(b=_checkInterface(b,a))throw new TypeError("Object does not fully implement interface "+a+". "+b);};
var implementsInterface=function(a,b){return null===_checkInterface(a,b)},_checkInterface=function(a,b){if("undefined"===typeof a||null===a)return"Object is null or undefined";b="function"===typeof b?b.prototype:b;var c,d,e;for(e in b){c=typeof b[e];d=typeof a[e];if("undefined"===d)return"Missing property '"+e+"'";if("function"===c&&"function"!==d||"function"!==c&&"function"===d)return"Property '"+e+"' "+("function"===c?"should be":"should not be")+" a function"}return null};
DEBUG&&(GLOBAL.Object&&GLOBAL.Object.prototype&&(GLOBAL.Object.prototype.toString=function(){var $super=GLOBAL.Object.prototype.toString;return function(){var b=this&&this.__wr_symbol;return b?String(b):$super.call(this)}}()),GLOBAL.Function&&GLOBAL.Function.prototype&&(GLOBAL.Function.prototype.toString=function(){var $super=GLOBAL.Function.prototype.toString;return function(){var b=this&&this.__wr_symbol;return b?String(b):$super.call(this)}}()));var wrm={CatcherService:function(){}};exportSymbol("wrm.CatcherService",wrm.CatcherService);wrm.CatcherService.prototype.subscribe=function(a){};exportProperty(wrm.CatcherService.prototype,"subscribe",wrm.CatcherService.prototype.subscribe);wrm.CatcherService.prototype.catchEvent=function(a,b){};exportProperty(wrm.CatcherService.prototype,"catchEvent",wrm.CatcherService.prototype.catchEvent);wrm.Constants={FAKE_FLOW_ID:"impl",USER_ENT_ID:"MUser",USER_OID_ATT_ID:"mUserOID",USER_USERNAME_ATT_ID:"mUsername",USER_ROLES_ROL_ID:"MUser2MRole",ROLE_ENT_ID:"MRole",ROLE_OID_ATT_ID:"mRoleOID",ROLE_NAME_ATT_ID:"mRoleName",ROLE_USER_ROL_ID:"MRole2MUser"};wrm.ViewComponentService=function(){};exportSymbol("wrm.ViewComponentService",wrm.ViewComponentService);wrm.ViewComponentService.prototype.computeOutput=function(a){};exportProperty(wrm.ViewComponentService.prototype,"computeOutput",wrm.ViewComponentService.prototype.computeOutput);wrm.ViewComponentService.prototype.updateView=function(a){};exportProperty(wrm.ViewComponentService.prototype,"updateView",wrm.ViewComponentService.prototype.updateView);
wrm.ViewComponentService.prototype.catchEvent=function(a,b){};exportProperty(wrm.ViewComponentService.prototype,"catchEvent",wrm.ViewComponentService.prototype.catchEvent);wrm.ViewComponentService.prototype.submitView=function(a){};exportProperty(wrm.ViewComponentService.prototype,"submitView",wrm.ViewComponentService.prototype.submitView);wrm.Service=function(){};exportSymbol("wrm.Service",wrm.Service);wrm.Service.prototype.initialize=function(a){};exportProperty(wrm.Service.prototype,"initialize",wrm.Service.prototype.initialize);wrm.Service.prototype.getId=function(){};exportProperty(wrm.Service.prototype,"getId",wrm.Service.prototype.getId);wrm.core={};wrm.core.AbstractService=function(a,b,c){this._id=a;this._manager=c;b=this._manager.getServiceType(this);this._log=this._manager.getPlatform().createLog(b,"["+a+"]")};exportSymbol("wrm.core.AbstractService",wrm.core.AbstractService);wrm.core.AbstractService.prototype.initialize=function(a){};exportProperty(wrm.core.AbstractService.prototype,"initialize",wrm.core.AbstractService.prototype.initialize);wrm.core.AbstractService.prototype.getId=function(){return this._id};
exportProperty(wrm.core.AbstractService.prototype,"getId",wrm.core.AbstractService.prototype.getId);wrm.core.AbstractService.prototype.getManager=function(){return this._manager};exportProperty(wrm.core.AbstractService.prototype,"getManager",wrm.core.AbstractService.prototype.getManager);wrm.core.AbstractService.prototype.getLog=function(){return this._log};exportProperty(wrm.core.AbstractService.prototype,"getLog",wrm.core.AbstractService.prototype.getLog);
wrm.core.AbstractService.prototype.toString=function(){var a=this._manager.getServiceType(this)||"UnknownService",b=a.lastIndexOf(".");0<=b&&(a=a.substring(b+1));return a+":"+this._id};exportProperty(wrm.core.AbstractService.prototype,"toString",wrm.core.AbstractService.prototype.toString);wrm.core.AbstractService.prototype.getDescriptorValue=function(a,b){a=a[b];if(null===a||void 0===a)throw Error("Required property '"+b+"' not found in descriptor of "+this);return a};
exportProperty(wrm.core.AbstractService.prototype,"getDescriptorValue",wrm.core.AbstractService.prototype.getDescriptorValue);wrm.core.AbstractService.prototype.getOptionalDescriptorValue=function(a,b){return a[b]};exportProperty(wrm.core.AbstractService.prototype,"getOptionalDescriptorValue",wrm.core.AbstractService.prototype.getOptionalDescriptorValue);wrm.core.AbstractViewComponentService=function(a,b,c){wrm.core.AbstractService.call(this,a,b,c)};extendConstructor(wrm.core.AbstractViewComponentService,wrm.core.AbstractService);exportSymbol("wrm.core.AbstractViewComponentService",wrm.core.AbstractViewComponentService);wrm.core.AbstractViewComponentService.prototype.computeOutput=ABSTRACT_METHOD;exportProperty(wrm.core.AbstractViewComponentService.prototype,"computeOutput",wrm.core.AbstractViewComponentService.prototype.computeOutput);
wrm.core.AbstractViewComponentService.prototype.updateView=ABSTRACT_METHOD;exportProperty(wrm.core.AbstractViewComponentService.prototype,"updateView",wrm.core.AbstractViewComponentService.prototype.updateView);wrm.core.AbstractViewComponentService.prototype.catchEvent=function(a,b){};exportProperty(wrm.core.AbstractViewComponentService.prototype,"catchEvent",wrm.core.AbstractViewComponentService.prototype.catchEvent);wrm.core.AbstractViewComponentService.prototype.submitView=function(a){return{}};
exportProperty(wrm.core.AbstractViewComponentService.prototype,"submitView",wrm.core.AbstractViewComponentService.prototype.submitView);wrm.core.AbstractCachedViewComponentService=function(a,b,c){wrm.core.AbstractViewComponentService.call(this,a,b,c)};extendConstructor(wrm.core.AbstractCachedViewComponentService,wrm.core.AbstractViewComponentService);exportSymbol("wrm.core.AbstractCachedViewComponentService",wrm.core.AbstractCachedViewComponentService);wrm.core.AbstractCachedViewComponentService.prototype.computeOutput=function(a){return this._retrieveResult(a).then(this.computeOutputFromResult.bind(this,a))};
exportProperty(wrm.core.AbstractCachedViewComponentService.prototype,"computeOutput",wrm.core.AbstractCachedViewComponentService.prototype.computeOutput);wrm.core.AbstractCachedViewComponentService.prototype.computeOutputFromResult=function(a,b){return b};exportProperty(wrm.core.AbstractCachedViewComponentService.prototype,"computeOutputFromResult",wrm.core.AbstractCachedViewComponentService.prototype.computeOutputFromResult);
wrm.core.AbstractCachedViewComponentService.prototype.updateView=function(a){return this._retrieveResult(a).then(this.updateViewFromResult.bind(this,a))};exportProperty(wrm.core.AbstractCachedViewComponentService.prototype,"updateView",wrm.core.AbstractCachedViewComponentService.prototype.updateView);wrm.core.AbstractCachedViewComponentService.prototype.updateViewFromResult=function(a,b){angular.extend(a.getView(),b)};
exportProperty(wrm.core.AbstractCachedViewComponentService.prototype,"updateViewFromResult",wrm.core.AbstractCachedViewComponentService.prototype.updateViewFromResult);wrm.core.AbstractCachedViewComponentService.prototype._retrieveResult=function(a){var b=this.getLog(),c=a._cachedResult;c&&this.isStaleResult(a,c)&&(b.debug("Discarding stale result"),c=null);return c?Promise.resolve(c):Promise.resolve(this.createResult(a)).then(function(b){b=b||{};return a._cachedResult=b})};
wrm.core.AbstractCachedViewComponentService.prototype.isStaleResult=function(a,b){return!1};exportProperty(wrm.core.AbstractCachedViewComponentService.prototype,"isStaleResult",wrm.core.AbstractCachedViewComponentService.prototype.isStaleResult);wrm.core.AbstractCachedViewComponentService.prototype.createResult=ABSTRACT_METHOD;exportProperty(wrm.core.AbstractCachedViewComponentService.prototype,"createResult",wrm.core.AbstractCachedViewComponentService.prototype.createResult);wrm.core.AbstractCatcherService=function(a,b,c){wrm.core.AbstractService.call(this,a,b,c)};extendConstructor(wrm.core.AbstractCatcherService,wrm.core.AbstractService);exportSymbol("wrm.core.AbstractCatcherService",wrm.core.AbstractCatcherService);wrm.core.AbstractCatcherService.prototype.subscribe=ABSTRACT_METHOD;exportProperty(wrm.core.AbstractCatcherService.prototype,"subscribe",wrm.core.AbstractCatcherService.prototype.subscribe);wrm.core.AbstractCatcherService.prototype.catchEvent=ABSTRACT_METHOD;
exportProperty(wrm.core.AbstractCatcherService.prototype,"catchEvent",wrm.core.AbstractCatcherService.prototype.catchEvent);wrm.nav={};wrm.nav.Destination=function(){};exportSymbol("wrm.nav.Destination",wrm.nav.Destination);wrm.nav.Destination.prototype.getFence=function(){};exportProperty(wrm.nav.Destination.prototype,"getFence",wrm.nav.Destination.prototype.getFence);wrm.nav.Notifiable=function(){};exportSymbol("wrm.nav.Notifiable",wrm.nav.Notifiable);wrm.nav.Notifiable.prototype.notify=function(a,b){};exportProperty(wrm.nav.Notifiable.prototype,"notify",wrm.nav.Notifiable.prototype.notify);wrm.core.AbstractEventHandler=function(a){this._manager=a};wrm.core.AbstractEventHandler.prototype.getManager=function(){return this._manager};wrm.core.AbstractEventHandler.prototype.getFence=function(){throw Error("Unsupported");};wrm.core.AbstractEventHandler.prototype.notify=ABSTRACT_METHOD;wrm.OperationService=function(){};exportSymbol("wrm.OperationService",wrm.OperationService);wrm.OperationService.prototype.executeOperation=function(a){};exportProperty(wrm.OperationService.prototype,"executeOperation",wrm.OperationService.prototype.executeOperation);wrm.core.AbstractOperationService=function(a,b,c){wrm.core.AbstractService.call(this,a,b,c)};extendConstructor(wrm.core.AbstractOperationService,wrm.core.AbstractService);exportSymbol("wrm.core.AbstractOperationService",wrm.core.AbstractOperationService);wrm.core.AbstractOperationService.prototype.executeOperation=ABSTRACT_METHOD;exportProperty(wrm.core.AbstractOperationService.prototype,"executeOperation",wrm.core.AbstractOperationService.prototype.executeOperation);wrm.SubService=function(){};exportSymbol("wrm.SubService",wrm.SubService);wrm.SubService.prototype.initialize=function(a){};exportProperty(wrm.SubService.prototype,"initialize",wrm.SubService.prototype.initialize);wrm.core.AbstractSubService=function(a,b,c){this._parent=a;this._manager=c;b=this._manager.getSubServiceType(this);this._log=this._manager.getPlatform().createLog(b,"["+a.getId()+"]")};exportSymbol("wrm.core.AbstractSubService",wrm.core.AbstractSubService);wrm.core.AbstractSubService.prototype.initialize=function(a){};exportProperty(wrm.core.AbstractSubService.prototype,"initialize",wrm.core.AbstractSubService.prototype.initialize);wrm.core.AbstractSubService.prototype.getParent=function(){return this._parent};
exportProperty(wrm.core.AbstractSubService.prototype,"getParent",wrm.core.AbstractSubService.prototype.getParent);wrm.core.AbstractSubService.prototype.getManager=function(){return this._manager};exportProperty(wrm.core.AbstractSubService.prototype,"getManager",wrm.core.AbstractSubService.prototype.getManager);wrm.core.AbstractSubService.prototype.getLog=function(){return this._log};exportProperty(wrm.core.AbstractSubService.prototype,"getLog",wrm.core.AbstractSubService.prototype.getLog);
wrm.core.AbstractSubService.prototype.toString=function(){var a=this._manager.getSubServiceType(this)||"UnknownSubService",b=a.lastIndexOf(".");0<=b&&(a=a.substring(b+1));return a+":"+this._parent.getId()};exportProperty(wrm.core.AbstractSubService.prototype,"toString",wrm.core.AbstractSubService.prototype.toString);wrm.ThrowerService=function(){};exportSymbol("wrm.ThrowerService",wrm.ThrowerService);wrm.ThrowerService.prototype.throwEvent=function(a){};exportProperty(wrm.ThrowerService.prototype,"throwEvent",wrm.ThrowerService.prototype.throwEvent);wrm.core.AbstractThrowerService=function(a,b,c){wrm.core.AbstractService.call(this,a,b,c)};extendConstructor(wrm.core.AbstractThrowerService,wrm.core.AbstractService);exportSymbol("wrm.core.AbstractThrowerService",wrm.core.AbstractThrowerService);wrm.core.AbstractThrowerService.prototype.throwEvent=ABSTRACT_METHOD;exportProperty(wrm.core.AbstractThrowerService.prototype,"throwEvent",wrm.core.AbstractThrowerService.prototype.throwEvent);wrm.core.UpdateParticipant=function(){};exportSymbol("wrm.core.UpdateParticipant",wrm.core.UpdateParticipant);wrm.core.UpdateParticipant.prototype.getRequiredParticipantIds=function(){};exportProperty(wrm.core.UpdateParticipant.prototype,"getRequiredParticipantIds",wrm.core.UpdateParticipant.prototype.getRequiredParticipantIds);wrm.core.UpdateParticipant.prototype.beginUpdate=function(a){};exportProperty(wrm.core.UpdateParticipant.prototype,"beginUpdate",wrm.core.UpdateParticipant.prototype.beginUpdate);
wrm.core.UpdateParticipant.prototype.prepareForExtensionUpdate=function(a){};exportProperty(wrm.core.UpdateParticipant.prototype,"prepareForExtensionUpdate",wrm.core.UpdateParticipant.prototype.prepareForExtensionUpdate);wrm.core.UpdateParticipant.prototype.performExtensionUpdate=function(a){};exportProperty(wrm.core.UpdateParticipant.prototype,"performExtensionUpdate",wrm.core.UpdateParticipant.prototype.performExtensionUpdate);wrm.core.UpdateParticipant.prototype.performCoreUpdate=function(a){};
exportProperty(wrm.core.UpdateParticipant.prototype,"performCoreUpdate",wrm.core.UpdateParticipant.prototype.performCoreUpdate);wrm.core.UpdateParticipant.prototype.prepareForReductionUpdate=function(a){};exportProperty(wrm.core.UpdateParticipant.prototype,"prepareForReductionUpdate",wrm.core.UpdateParticipant.prototype.prepareForReductionUpdate);wrm.core.UpdateParticipant.prototype.performReductionUpdate=function(a){};exportProperty(wrm.core.UpdateParticipant.prototype,"performReductionUpdate",wrm.core.UpdateParticipant.prototype.performReductionUpdate);
wrm.core.UpdateParticipant.prototype.finishUpdate=function(a){};exportProperty(wrm.core.UpdateParticipant.prototype,"finishUpdate",wrm.core.UpdateParticipant.prototype.finishUpdate);wrm.core.AbstractUpdateParticipant=function(){};exportSymbol("wrm.core.AbstractUpdateParticipant",wrm.core.AbstractUpdateParticipant);wrm.core.AbstractUpdateParticipant.prototype.getRequiredParticipantIds=function(){return[]};exportProperty(wrm.core.AbstractUpdateParticipant.prototype,"getRequiredParticipantIds",wrm.core.AbstractUpdateParticipant.prototype.getRequiredParticipantIds);wrm.core.AbstractUpdateParticipant.prototype.beginUpdate=function(a){};
exportProperty(wrm.core.AbstractUpdateParticipant.prototype,"beginUpdate",wrm.core.AbstractUpdateParticipant.prototype.beginUpdate);wrm.core.AbstractUpdateParticipant.prototype.prepareForExtensionUpdate=function(a){};exportProperty(wrm.core.AbstractUpdateParticipant.prototype,"prepareForExtensionUpdate",wrm.core.AbstractUpdateParticipant.prototype.prepareForExtensionUpdate);wrm.core.AbstractUpdateParticipant.prototype.performExtensionUpdate=function(a){};
exportProperty(wrm.core.AbstractUpdateParticipant.prototype,"performExtensionUpdate",wrm.core.AbstractUpdateParticipant.prototype.performExtensionUpdate);wrm.core.AbstractUpdateParticipant.prototype.performCoreUpdate=function(a){};exportProperty(wrm.core.AbstractUpdateParticipant.prototype,"performCoreUpdate",wrm.core.AbstractUpdateParticipant.prototype.performCoreUpdate);wrm.core.AbstractUpdateParticipant.prototype.prepareForReductionUpdate=function(a){};
exportProperty(wrm.core.AbstractUpdateParticipant.prototype,"prepareForReductionUpdate",wrm.core.AbstractUpdateParticipant.prototype.prepareForReductionUpdate);wrm.core.AbstractUpdateParticipant.prototype.performReductionUpdate=function(a){};exportProperty(wrm.core.AbstractUpdateParticipant.prototype,"performReductionUpdate",wrm.core.AbstractUpdateParticipant.prototype.performReductionUpdate);wrm.core.AbstractUpdateParticipant.prototype.finishUpdate=function(a){return!1};
exportProperty(wrm.core.AbstractUpdateParticipant.prototype,"finishUpdate",wrm.core.AbstractUpdateParticipant.prototype.finishUpdate);wrm.nav.Output=function(a,b){Object.defineProperty(this,"_result",{value:a});angular.extend(this,b)};exportSymbol("wrm.nav.Output",wrm.nav.Output);wrm.nav.Output.prototype.getResult=function(){return this._result};exportProperty(wrm.nav.Output.prototype,"getResult",wrm.nav.Output.prototype.getResult);wrm.nav.Output.prototype.toString=function(){return"\x3c"+this._result+"\x3e "+JSON.stringify(this)};exportProperty(wrm.nav.Output.prototype,"toString",wrm.nav.Output.prototype.toString);wrm.core.ActionDefOutput=function(a,b,c){wrm.nav.Output.call(this,a,c);this._success=b};extendConstructor(wrm.core.ActionDefOutput,wrm.nav.Output);wrm.core.ActionDefOutput.prototype.isSuccess=function(){return this._success};wrm.core.ActionDefOutput.prototype.getNotificationMessage=function(){return this[wrm.core.ActionDefService.NOTIFICATION_MESSAGE_OUTPUT]||null};wrm.core.ActionDefOutput.prototype.setNotificationMessage=function(a){this[wrm.core.ActionDefService.NOTIFICATION_MESSAGE_OUTPUT]=a};wrm.nav.Executable=function(){};exportSymbol("wrm.nav.Executable",wrm.nav.Executable);wrm.nav.Executable.prototype.execute=ABSTRACT_METHOD;exportProperty(wrm.nav.Executable.prototype,"execute",wrm.nav.Executable.prototype.execute);wrm.core.PASSINGS_COMPONENT_ID="__passings";wrm.core.parseParameter=function(a){var b=/^(?:([^:]+):)?(.+)$/.exec(a);if(!b)throw Error("Invalid parameter id '"+a+"'");return{componentId:b[1]||wrm.core.PASSINGS_COMPONENT_ID,name:b[2]}};wrm.util={};wrm.util.obj={};wrm.util.obj.lookup=function(a,b){if(a){var c=a.split(".");b=b||GLOBAL;try{for(var d;c.length&&(d=c.shift());)b=b[d]}catch(e){throw e instanceof TypeError&&(e=new TypeError(""+a+" is undefined")),e;}return b}};exportSymbol("wrm.util.obj.lookup",wrm.util.obj.lookup);wrm.util.obj.lookupSafe=function(a,b){if(a){a=a.split(".");b=b||GLOBAL;for(var c;a.length&&(c=a.shift())&&(b=b[c],null!==b&&void 0!==b););return b}};exportSymbol("wrm.util.obj.lookupSafe",wrm.util.obj.lookupSafe);
wrm.util.obj.createFromKeys=function(a,b){for(var c={},d=0;d<a.length;d++)c[a[d]]="function"===typeof b?b(a[d]):b;return c};exportSymbol("wrm.util.obj.createFromKeys",wrm.util.obj.createFromKeys);wrm.util.obj.findValuesDiff=function(a,b){var c={};a.forEach(function(a){c[a]=a});var d=[];b.forEach(function(a){void 0!==c[a]?delete c[a]:d.push(a)});a=Object.keys(c).map(function(a){return c[a]});return{added:d,removed:a}};exportSymbol("wrm.util.obj.findValuesDiff",wrm.util.obj.findValuesDiff);
wrm.util.obj.copyProperties=function(a,b,c){c=c||Object.keys(b);c.forEach(function(c){b.hasOwnProperty(c)&&(a[c]=b[c])});return a};exportSymbol("wrm.util.obj.copyProperties",wrm.util.obj.copyProperties);
wrm.util.obj.extractPropertyValues=function(a,b){function c(a,b,c,d,e){e=e[b];void 0!==e&&(1<d?(a[b]||(a[b]=Array(d)),a[b][c]=e):a[b]=e)}var d={};if(Array.isArray(a)){var e=a.length;a.forEach(function(a,g){(b||Object.keys(a)).forEach(function(b){c(d,b,g,e,a)})})}else(b||Object.keys(a)).forEach(function(b){c(d,b,0,1,a)});return d};exportSymbol("wrm.util.obj.extractPropertyValues",wrm.util.obj.extractPropertyValues);
wrm.util.obj.sliceList=function(a,b){for(var c=[],d=0;d<a.length;d+=b)c.push(a.slice(d,d+b));return c};wrm.util.obj._EMPTY_INFO={names:[],values:[],namesByValue:{}};wrm.util.obj._getEnumTypeInfo=function(a){var b=a._enum_type_info;if(!b){var b=[],c=[],d={},e;for(e in a)if(Object.prototype.hasOwnProperty.call(a,e)){var f=a[e];"function"!==typeof f&&/^(?!_).+/.test(e)&&(b.push(e),c.push(f),d[f]=e)}b={names:b,values:c,namesByValue:d};Object.defineProperty(a,"_enum_type_info",b)}return b};
wrm.util.obj.getEnumValues=function(a){return wrm.util.obj._getEnumTypeInfo(a).values};exportSymbol("wrm.util.obj.getEnumValues",wrm.util.obj.getEnumValues);wrm.util.obj.getEnumNames=function(a){return wrm.util.obj._getEnumTypeInfo(a).names};exportSymbol("wrm.util.obj.getEnumNames",wrm.util.obj.getEnumNames);wrm.util.obj.getEnumName=function(a,b){var c=wrm.util.obj._getEnumTypeInfo(a).namesByValue[b];if(!c)throw new TypeError("Invalid constant value '"+b+"' for enumeration type "+a);return c};
exportSymbol("wrm.util.obj.getEnumName",wrm.util.obj.getEnumName);wrm.util.obj.castEnumValue=function(a,b){if(!wrm.util.obj._getEnumTypeInfo(a).namesByValue[b])throw new TypeError("Invalid constant value '"+b+"' for enumeration type "+a);return b};exportSymbol("wrm.util.obj.castEnumValue",wrm.util.obj.castEnumValue);
wrm.util.obj.defineClass=function(){function a(a,b,e,f,g){Object.defineProperty(a,b,{enumerable:!!f,configurable:!!g,value:e})}var b=!1;return function(c,d){c=c||Object;var e=c.prototype,f=null,g=function(){c.apply(f,arguments)},h={};if(e)for(var k in e)a(h,k,function(a){return function(){return e[a].apply(f,arguments)}}(k),!0);var l=d.constructor,m=d.statics,n=Object.create(e);for(k in d)"constructor"!==k&&"statics"!==k&&d.hasOwnProperty(k)&&a(n,k,function(a){return"function"===typeof a?function(){f=
this;return a.apply(this,arguments)}:a}(d[k]),!0);d=function(){var c=!b;if(l){b=!0;f=this;a(this,"_superConstructor",g,!1,!0);try{l.apply(this,arguments)}finally{delete this._superConstructor,c&&(b=!1)}}b||a(this,"_super",h)};d.prototype=n;a(d.prototype,"constructor",d);if(m)for(k in m)m.hasOwnProperty(k)&&a(d,k,m[k],!0);Object.freeze(n);return d}}();exportSymbol("wrm.util.obj.defineClass",wrm.util.obj.defineClass);wrm.nav.Flow=function(){};exportSymbol("wrm.nav.Flow",wrm.nav.Flow);wrm.nav.Flow.prototype.getId=function(){};exportProperty(wrm.nav.Flow.prototype,"getId",wrm.nav.Flow.prototype.getId);wrm.nav.Flow.prototype.getBoundSourceId=function(){};wrm.nav.Flow.prototype.getBoundTargetId=function(){};wrm.nav.Flow.prototype.propagate=function(a,b){};exportProperty(wrm.nav.Flow.prototype,"propagate",wrm.nav.Flow.prototype.propagate);wrm.nav.Flow.prototype.propagateWithScore=function(a,b,c,d){};
exportProperty(wrm.nav.Flow.prototype,"propagateWithScore",wrm.nav.Flow.prototype.propagateWithScore);wrm.nav.AbstractFlow=function(a){this._id=a};wrm.nav.AbstractFlow.prototype.getId=function(){return this._id};wrm.nav.AbstractFlow.prototype.getBoundSourceId=ABSTRACT_METHOD;exportProperty(wrm.nav.AbstractFlow.prototype,"getBoundSourceId",wrm.nav.AbstractFlow.prototype.getBoundSourceId);wrm.nav.AbstractFlow.prototype.getBoundTargetId=ABSTRACT_METHOD;exportProperty(wrm.nav.AbstractFlow.prototype,"getBoundTargetId",wrm.nav.AbstractFlow.prototype.getBoundTargetId);
wrm.nav.AbstractFlow.prototype.propagate=function(a,b){this._doPropagate(a,0,null,b)};wrm.nav.AbstractFlow.prototype.propagateWithScore=function(a,b,c,d){this._doPropagate(a,b,c,d)};
wrm.nav.AbstractFlow.prototype._doPropagate=function(a,b,c,d){this._applyPreservations(d);var e=this.getBoundTargetId();if(e){var f=d.getComponentInput(e),g=0<b&&c?c[e]:null,h=this.getBindings();Object.keys(h).forEach(function(c){if(!(g&&(g&&g[c]||0)>=b)){var k=this._computePropagatedValue(a,d,h[c]);void 0!==k&&(f[c]=k,g&&(g[c]=b),d.registerPropagation(e,c))}},this);var k=d.getPassingData();angular.forEach(this.getPassings(),function(b,c){b=this._computePropagatedValue(a,d,b);void 0!==b&&(k[c]=b)},
this)}};
wrm.nav.AbstractFlow.prototype._computePropagatedValue=function(a,b,c){if("object"===typeof c){var d=c.k;if(void 0!==d)switch(d){case wrm.nav.SystemValueKey.TOKEN:return wrm.nav.SystemValues.token;case wrm.nav.SystemValueKey.LAST_SYNCHRONIZATION_TIMESTAMP:return wrm.nav.SystemValues.lastSynchronizationTimestamp;case wrm.nav.SystemValueKey.LANGUAGE_ISO_CODE:return wrm.nav.SystemValues.languageIsoCode;case wrm.nav.SystemValueKey.COUNTRY_ISO_CODE:return wrm.nav.SystemValues.countryIsoCode;case wrm.nav.SystemValueKey.CURRENT_TIMESTAMP:return Date.now();case wrm.nav.SystemValueKey.CURRENT_DATE:return wrm.data.Date.fromDate(new Date);
default:return d}d=c.p;if(void 0!==d)return b.getPassingData()[d]}return wrm.util.obj.lookupSafe(String(c),a)};wrm.nav.AbstractFlow.prototype._applyPreservations=function(a){var b=this.getPreserves();if(b){var c=[];angular.forEach(a.getComponentInputs(),function(a,e){var f=b[e];if(f)for(var g in a)"_"!==g.charAt(0)&&a.hasOwnProperty(g)&&!0!==f[g]&&delete a[g];else c.push(e)},this);c.forEach(function(b){a.discardComponentInput(b)})}};wrm.nav.AbstractFlow.prototype.getPreserves=function(){return null};
exportProperty(wrm.nav.AbstractFlow.prototype,"getPreserves",wrm.nav.AbstractFlow.prototype.getPreserves);wrm.nav.AbstractFlow.prototype.getBindings=function(){return{}};exportProperty(wrm.nav.AbstractFlow.prototype,"getBindings",wrm.nav.AbstractFlow.prototype.getBindings);wrm.nav.AbstractFlow.prototype.getPassings=function(){return{}};exportProperty(wrm.nav.AbstractFlow.prototype,"getPassings",wrm.nav.AbstractFlow.prototype.getPassings);wrm.nav.AbstractFlow.prototype.toString=function(){return this._id};wrm.nav.FlowImpl=function(a){wrm.nav.AbstractFlow.call(this,a.id);this._boundSourceId=a.bindFrom||null;this._boundTargetId=a.bindTo||null;this._preserves="string"===typeof a.preserve?this._createPreserves(a.preserve):null;this._bindings=a.bind||{};this._passings=a.pass||{}};extendConstructor(wrm.nav.FlowImpl,wrm.nav.AbstractFlow);
wrm.nav.FlowImpl.prototype._createPreserves=function(a){var b={};a&&angular.forEach(a.split("|"),function(a){a=wrm.core.parseParameter(a);var d=b[a.componentId];d||(b[a.componentId]=d={});d[a.name]=!0});return b};wrm.nav.FlowImpl.prototype.getBoundSourceId=function(){return this._boundSourceId};wrm.nav.FlowImpl.prototype.getBoundTargetId=function(){return this._boundTargetId};wrm.nav.FlowImpl.prototype.getPreserves=function(){return this._preserves};wrm.nav.FlowImpl.prototype.getBindings=function(){return this._bindings};
wrm.nav.FlowImpl.prototype.getPassings=function(){return this._passings};wrm.nav.NavFlow=function(){};exportSymbol("wrm.nav.NavFlow",wrm.nav.NavFlow);wrm.nav.NavFlow.prototype.getTargetId=function(){};exportProperty(wrm.nav.NavFlow.prototype,"getTargetId",wrm.nav.NavFlow.prototype.getTargetId);wrm.nav.NavFlowImpl=function(a){wrm.nav.FlowImpl.call(this,a);this._targetId=a.navTo};extendConstructor(wrm.nav.NavFlowImpl,wrm.nav.FlowImpl);wrm.nav.NavFlowImpl.prototype.getTargetId=function(){return this._targetId};wrm.nav.NavFlowImpl.prototype.getBoundTargetId=function(){return wrm.nav.NavFlowImpl._super.getBoundTargetId.call(this)||this._targetId};wrm.core.ActionDefService=function(a,b,c){wrm.core.AbstractService.call(this,a,b,c);a=b.outputPorts;c=a.success;var d=a.error,e={};e[c]=!0;angular.forEach(a.other_success,function(a){e[a]=!0});var f={};f[d]=!0;angular.forEach(a.other_error,function(a){f[a]=!0});this._inputFlowDescr=b.input;this._inputDataFlowDescrs=b["input*"]||null;this._componentFlowDescrs=b.components;this._defaultSuccessPort=c;this._defaultErrorPort=d;this._successPorts=e;this._errorPorts=f;this._progress=b.progressNotification||
null;this._notifications=b.outputNotifications||{}};extendConstructor(wrm.core.ActionDefService,wrm.core.AbstractService);exportSymbol("wrm.core.ActionDefService",wrm.core.ActionDefService);wrm.core.ActionDefService.prototype.initialize=function(){var a=this;return this.getManager().getLocalizationService().then(function(b){a._l10nService=b})};exportProperty(wrm.core.ActionDefService.prototype,"initialize",wrm.core.ActionDefService.prototype.initialize);
wrm.core.ActionDefService.prototype.execute=function(a,b){function c(){b.popIsland();f&&b.reportProgress(new wrm.nav.Progress(null))}var d=this,e=this._l10nService,f=this._progress;f&&b.reportProgress(new wrm.nav.Progress(e.formatMessage(f)));b.pushIsland();return this._doExecute(a,b).then(function(a){c();d._enrichOutput(a);return a},function(a){c();throw a;})};exportProperty(wrm.core.ActionDefService.prototype,"execute",wrm.core.ActionDefService.prototype.execute);
wrm.core.ActionDefService.prototype._doExecute=function(a,b){var c=this;a=Promise.resolve(this._executeInput(a,b));a=a.then(function(a){return c._executeChain(a,b)});return a=a.then(function(a){var e=c._successPorts.hasOwnProperty(a);return new wrm.core.ActionDefOutput(a,e,b.getComponentInput(a))})};
wrm.core.ActionDefService.prototype._executeInput=function(a,b){this._inputDataFlowDescrs&&angular.forEach(this._inputDataFlowDescrs,function(c){(new wrm.nav.FlowImpl(c)).propagate(a,b)});if(this._inputFlowDescr){var c=new wrm.nav.NavFlowImpl(this._inputFlowDescr);c.propagate(a,b);return c.getTargetId()}return this._defaultSuccessPort};
wrm.core.ActionDefService.prototype._executeChain=function(a,b){function c(a){return d._successPorts.hasOwnProperty(a)||d._errorPorts.hasOwnProperty(a)?Promise.resolve(a):d._executeComponent(a,b).then(c)}var d=this;return c(a)};
wrm.core.ActionDefService.prototype._executeComponent=function(a,b){var c=this,d=b.getComponentInput(a),e=this._componentFlowDescrs[a];return this.getManager().getService(a).then(function(a){a=implementsInterface(a,wrm.OperationService)?new wrm.core.ExecutableOperation(a):a;return c._doExecuteExecutable(a,d,e,b)})};
wrm.core.ActionDefService.prototype._doExecuteExecutable=function(a,b,c,d){var e=this,f=this.getLog(),g=Promise.resolve().then(function(){f.debug("Executing",a,"-",b);return Promise.resolve(a.execute(b,d)).then(function(b){f.debug("Executed",a,"-",b);return b})})["catch"](function(b){f.error("Executed",a,"- Thrown error",b);return new wrm.nav.Output("error")});return g=g.then(function(a){var b=e._getResult(c,a);e._propagateComponentDataFlows(c,a,d,b);b=e._createComponentNavigationFlow(c,a,b);f.debug("Following flow",
b);b.propagate(a,d);return b.getTargetId()})};wrm.core.ActionDefService.prototype._propagateComponentDataFlows=function(a,b,c,d){(a=a[d+"*"]||a["*"])&&angular.forEach(a,function(a){(new wrm.nav.FlowImpl(a)).propagate(b,c)})};wrm.core.ActionDefService.prototype._createComponentNavigationFlow=function(a,b,c){if(a=a[c])return new wrm.nav.NavFlowImpl(a);c=/^(success|error)(?:\..+)?$/.exec(c);return new wrm.core.ActionDefService._JumpFlow(c&&"success"===c[1]?this._defaultSuccessPort:this._defaultErrorPort)};
wrm.core.ActionDefService.prototype._getResult=function(a,b){b=b.getResult();if(a[b])return b;(a=/^(success|error)(?:\..+)?$/.exec(b))&&"success"===a[1]?b="success":a&&"error"===a[1]&&(b="error");return b};wrm.core.ActionDefService.NOTIFICATION_MESSAGE_OUTPUT="notificationMessage";exportProperty(wrm.core.ActionDefService,"NOTIFICATION_MESSAGE_OUTPUT",wrm.core.ActionDefService.NOTIFICATION_MESSAGE_OUTPUT);
wrm.core.ActionDefService.prototype._enrichOutput=function(a){if(!a.getNotificationMessage()){var b=this._notifications[a.getResult()];b&&a.setNotificationMessage(this._l10nService.formatMessage(b))}};wrm.core.ActionDefService._JumpFlow=function(a){wrm.nav.FlowImpl.call(this,{});this._targetId=a};extendConstructor(wrm.core.ActionDefService._JumpFlow,wrm.nav.FlowImpl);wrm.core.ActionDefService._JumpFlow.prototype.getTargetId=function(){return this._targetId};
wrm.core.ActionDefService._JumpFlow.prototype.getBoundTargetId=function(){return this._targetId};wrm.core.ActionDefService._JumpFlow.prototype.toString=function(){return"\x3cjump to "+this._targetId+"\x3e"};wrm.nav.Dialog=function(a,b,c){this._flavor=b;this._message=a;this._choices=c||[]};exportSymbol("wrm.nav.Dialog",wrm.nav.Dialog);wrm.nav.Dialog.Flavor={POSITIVE:"positive",CAUTIONAL:"cautional",NEGATIVE:"negative"};exportProperty(wrm.nav.Dialog,"Flavor",wrm.nav.Dialog.Flavor);wrm.nav.Dialog.prototype.getFlavor=function(){return this._flavor};exportProperty(wrm.nav.Dialog.prototype,"getFlavor",wrm.nav.Dialog.prototype.getFlavor);wrm.nav.Dialog.prototype.getMessage=function(){return this._message};
exportProperty(wrm.nav.Dialog.prototype,"getMessage",wrm.nav.Dialog.prototype.getMessage);wrm.nav.Dialog.prototype.getChoiceLabels=function(){return this._choices.map(function(a){return a.label})};exportProperty(wrm.nav.Dialog.prototype,"getChoiceLabels",wrm.nav.Dialog.prototype.getChoiceLabels);wrm.nav.Dialog.prototype.getDefaultChoiceIndex=function(){for(var a=0;a<this._choices.length;a++)if(this._choices[a]["default"])return a;return 0};
exportProperty(wrm.nav.Dialog.prototype,"getDefaultChoiceIndex",wrm.nav.Dialog.prototype.getDefaultChoiceIndex);wrm.nav.Dialog.prototype.getChoiceValue=function(a){a=this._choices[a];if(!a)throw Error("Invalid choice");return a.value};exportProperty(wrm.nav.Dialog.prototype,"getChoiceValue",wrm.nav.Dialog.prototype.getChoiceValue);wrm.nav.Dialog.prototype.toString=function(){return'Dialog:"'+this._message+'"'};exportProperty(wrm.nav.Dialog.prototype,"toString",wrm.nav.Dialog.prototype.toString);wrm.nav.Navigable=function(){};exportSymbol("wrm.nav.Navigable",wrm.nav.Navigable);wrm.nav.Navigable.prototype.navigate=function(a,b){};exportProperty(wrm.nav.Navigable.prototype,"navigate",wrm.nav.Navigable.prototype.navigate);wrm.core.ActionService=function(a,b,c){wrm.core.AbstractService.call(this,a,b,c);this._protectionRoles=b["protected"]||null;this._fence=b.fence||null;this._definitionId=b.definition;this._flowDescrs=b.flows||{};this._notifications=b.notifications||{}};extendConstructor(wrm.core.ActionService,wrm.core.AbstractService);exportSymbol("wrm.core.ActionService",wrm.core.ActionService);
wrm.core.ActionService.prototype.initialize=function(){var a=this,b=this.getManager();return Promise.all([b.getLocalizationService().then(function(b){a._l10nService=b}),b.getDataSyncService().then(function(b){a._dataSyncService=b})])};exportProperty(wrm.core.ActionService.prototype,"initialize",wrm.core.ActionService.prototype.initialize);wrm.core.ActionService.prototype.getFence=function(){return this._fence};exportProperty(wrm.core.ActionService.prototype,"getFence",wrm.core.ActionService.prototype.getFence);
wrm.core.ActionService.prototype.navigate=function(a,b){var c=this;return this._checkPermission(b).then(function(a){return a?a:c._navigate(b).then(function(a){return c._dataSyncService.synchronizeDuringNavigation(b).then(function(b){return b||a})})}).then(function(a){c._dataSyncService.collectSuccessEvents(b);return a})};exportProperty(wrm.core.ActionService.prototype,"navigate",wrm.core.ActionService.prototype.navigate);
wrm.core.ActionService.prototype._checkPermission=function(a){var b=this._protectionRoles;return b?this.getManager().getSecurityService().then(function(c){return c.checkPermission(b,a)}):Promise.resolve(null)};
wrm.core.ActionService.prototype._navigate=function(a){var b=wrm.nav.Dialog,c=this,d=this.getLog(),e=a.getComponentInput(this.getId()),e=this.execute(e,a);return e=e.then(function(e){c._propagateDataFlows(e,a);var g,h=c._createOutputNavigationFlow(e);h?(d.debug("Following flow",h),h.propagate(e,a),a.stepAhead(h),g=wrm.nav.Route.toService(h.getTargetId())):(d.debug("Following implicit flow"),a.stepImplicitly(),g=wrm.nav.Route.toService(a.getContextualStartPanelId()||void 0));return(h=e.getNotificationMessage())?
(e=e.isSuccess()?b.Flavor.POSITIVE:b.Flavor.NEGATIVE,a.presentDialog(new b(h,e)).then(function(){return g})):g})};wrm.core.ActionService.prototype._propagateDataFlows=function(a,b){var c=a.getResult();(c=this._flowDescrs[c+"*"])&&angular.forEach(c,function(c){(new wrm.nav.FlowImpl(c)).propagate(a,b)})};wrm.core.ActionService.prototype._createOutputNavigationFlow=function(a){a=a.getResult();return(a=this._flowDescrs[a])?new wrm.nav.NavFlowImpl(a):null};
wrm.core.ActionService.prototype.execute=function(a,b){var c=this,d={},e=this.getId()+".";angular.forEach(a,function(a,b){0===b.indexOf(e)&&(b=b.substring(e.length));d[b]=a});return this.getManager().getActionDefinitionService(this._definitionId).then(function(a){return a.execute(d,b)}).then(function(a){c._enrichOutput(a);return a})};exportProperty(wrm.core.ActionService.prototype,"execute",wrm.core.ActionService.prototype.execute);
wrm.core.ActionService.prototype._enrichOutput=function(a){if(!a.getNotificationMessage()){var b=this._notifications[a.getResult()];b&&a.setNotificationMessage(this._l10nService.formatMessage(b))}};wrm.core.AppResumeHandler=function(a,b){wrm.core.AbstractEventHandler.call(this,b);this._reAccess=a.reAccess};extendConstructor(wrm.core.AppResumeHandler,wrm.core.AbstractEventHandler);wrm.core.AppResumeHandler.prototype.notify=function(a,b){var c=this.getManager();return(this._reAccess?c.getSecurityService().then(function(a){return a.accessAgain(!1,b)}).then(function(a){return a||null}):Promise.resolve(null)).then(function(a){return a?a:c.getDataSyncService().then(function(a){return a.synchronizeOnResume(b).then(function(){return wrm.nav.Route.toNowhere()})})})};wrm.VERSION=FILE_VERSION;exportSymbol("wrm.VERSION",wrm.VERSION);wrm.tempDirectory={basePath:"tmp",name:null};wrm.persistentDirectory={basePath:"data",name:null};wrm.blobDirectoryName="objects";wrm.setTempDirectory=function(a,b){wrm.tempDirectory={basePath:a,name:b||null}};exportSymbol("wrm.setTempDirectory",wrm.setTempDirectory);wrm.setPersistentDirectory=function(a,b){wrm.persistentDirectory={basePath:a,name:b||null}};exportSymbol("wrm.setPersistentDirectory",wrm.setPersistentDirectory);
wrm.DEFINED_MODULES={};wrm.defineModule=function(a,b){if(wrm.DEFINED_MODULES.hasOwnProperty(a))throw Error("Module '"+a+"' is already defined");wrm.DEFINED_MODULES[a]=b||{}};exportSymbol("wrm.defineModule",wrm.defineModule);wrm.importModule=function(a){var b=wrm.DEFINED_MODULES[a];return b?Promise.resolve(b):Promise.reject(Error("Module '"+a+"' not found"))};
wrm.defineService=function(a,b){return wrm.util.obj.defineClass(a,angular.extend({constructor:function(a,b,e){this._superConstructor(a,b,e)}},b))};exportSymbol("wrm.defineService",wrm.defineService);wrm.util.asyncForEach=function(a,b,c){var d;if(angular.isArray(a)){d=[];for(var e=0;e<a.length;e++)d.push(e)}else d=Object.keys(a);var f=0;return wrm.util.asyncFor(void 0,function(){return f<d.length},function(){return f++},function(c){var e=d[f];return b(a[e],e,c)},c)};
wrm.util.asyncFor=function(a,b,c,d,e){function f(){return b()?Promise.resolve(d.call(e,g)).then(function(a){if(a!=g)return c(),f()}):Promise.resolve()}a=a||angular.noop;b=b||function(){return!0};c=c||angular.noop;d=d||angular.noop;e=e||GLOBAL;var g={};a();return f()};
wrm.util.sortTopologically=function(a,b){var c={};a.forEach(function(a){c[a]=b(a).slice()});var d=[];a=[];var e={},f=0;Object.keys(c).forEach(function(a){var b=c[a];0>=b.length?d.push(a):(e[a]=b.slice(0),f+=e[a])});for(var g;g=d.shift();)a.push(g),Object.keys(e).forEach(function(a){var b=e[a],c=b.indexOf(g);0<=c&&(b.splice(c,1),0>=b.length&&(d.push(a),f--))});if(0<f)throw Error("Found dependency cycles");return a};wrm.util.isPromise=function(a){return"object"===typeof a&&!!a&&"then"in a};
wrm.util.promiseAllIncrementally=function(a,b,c,d){function e(a){h.push(a);a=(new Date).valueOf();null!==k&&null!==g&&a-g<c&&(GLOBAL.clearTimeout(k),k=null);null===k&&(k=GLOBAL.setTimeout(f,b),null===g&&(g=a))}function f(){0<h.length&&d(h);k=g=null;h=[]}var g=null,h=[],k=null;a.forEach(function(a){Promise.resolve(a).then(e)});return Promise.all(a).then(function(a){f();return a}).finally(function(){null!==k&&GLOBAL.clearTimeout(k)})};exportSymbol("wrm.util.promiseAllIncrementally",wrm.util.promiseAllIncrementally);
wrm.util.newPromiseCallbackAdapter=function(a){var b=void 0;return{promise:new Promise(function(c,d){b=a?function(b){try{a(b),c()}catch(f){d(f)}}:c}),callback:b}};exportSymbol("wrm.util.newPromiseCallbackAdapter",wrm.util.newPromiseCallbackAdapter);wrm.util.sleep=function(a){return new Promise(function(b){GLOBAL.setTimeout(b,a)})};exportSymbol("wrm.util.sleep",wrm.util.sleep);wrm.util.toErrorReject=function(a){return function(b){return a(wrm.util.toError(b))}};
wrm.util.toError=function(a){return a instanceof Error?a:Error(a.message||String(a))};exportSymbol("wrm.util.toError",wrm.util.toError);wrm.util.invokePlugin=function(a){return new Promise(function(b,c){a(function(a){b(a)},wrm.util.toErrorReject(c))})};exportSymbol("wrm.util.invokePlugin",wrm.util.invokePlugin);wrm.util.fs={};wrm.util.fs.lookupFile=function(a){return wrm.util.fs.lookupFileEntry(a).then(function(a){return new Promise(function(c,d){a.file(function(a){c(a)},wrm.util.fs._tofileErrorReject(d))})})};exportSymbol("wrm.util.fs.lookupFile",wrm.util.fs.lookupFile);wrm.util.fs.createTempFile=function(a,b){var c=(a||"")+String((new Date).valueOf())+(b||"");return wrm.util.fs._retrieveTempDirectory().then(function(a){return new Promise(function(b,f){a.getFile(c,{create:!0},b,wrm.util.fs._tofileErrorReject(f))})})};
exportSymbol("wrm.util.fs.createTempFile",wrm.util.fs.createTempFile);wrm.util.fs.createNamedTempFile=function(a){var b=String((new Date).valueOf());return wrm.util.fs._retrieveTempDirectory().then(function(c){return new Promise(function(d,e){c.getDirectory(b,{create:!0},function(b){b.getFile(a,{create:!0},d,wrm.util.fs._tofileErrorReject(e))},wrm.util.fs._tofileErrorReject(e))})})};exportSymbol("wrm.util.fs.createNamedTempFile",wrm.util.fs.createNamedTempFile);
wrm.util.fs.deleteTempFile=function(a){return new Promise(function(b,c){a.getParent(function(d){a.remove(function(){d.remove(angular.noop());b(void 0)},wrm.util.fs._tofileErrorReject(c))},wrm.util.fs._tofileErrorReject(c))})};exportSymbol("wrm.util.fs.deleteTempFile",wrm.util.fs.deleteTempFile);wrm.util.fs.clearTempFiles=function(){return wrm.util.fs._retrieveTempDirectory(!0).then(function(a){if(null!=a)return new Promise(function(b,c){a.removeRecursively(function(){b(void 0)},wrm.util.fs._tofileErrorReject(c))})})};
exportSymbol("wrm.util.fs.clearTempFiles",wrm.util.fs.clearTempFiles);wrm.util.fs._retrieveTempDirectory=function(a){a=a||!1;return wrm.util.fs._lookupSystemDirectory(wrm.tempDirectory).then(function(b){return new Promise(function(c,d){b.getDirectory("temp",{create:!a},c,function(b){a&&1===b.code?c(null):d(wrm.util.toError(b))})})})};wrm.util.fs.retrievePersistentDirectory=function(){return wrm.util.fs._lookupSystemDirectory(wrm.persistentDirectory)};
wrm.util.fs._lookupSystemDirectory=function(a){return wrm.util.fs.lookupDirectoryEntry(a.basePath).then(function(b){return a.name?new Promise(function(c,d){b.getDirectory(a.name,{create:!0},c,wrm.util.toErrorReject(d))}):b})};wrm.util.fs.retrieveDirectory=function(a,b,c){c=c||!1;b=b.split("/").filter(function(a){return 0<a.length});return wrm.util.fs._retrieveDirectory(a,b,c)};
wrm.util.fs._retrieveDirectory=function(a,b,c){return 0>=b.length?Promise.resolve(a):new Promise(function(d,e){a.getDirectory(b[0],{create:!c},function(a){d(wrm.util.fs._retrieveDirectory(a,b.slice(1),c))},wrm.util.fs._tofileErrorReject(e))})};wrm.util.fs.createNamedFile=function(a,b){return new Promise(function(c,d){a.getFile(b,{create:!0},c,wrm.util.fs._tofileErrorReject(d))})};
wrm.util.fs.deleteEntry=function(a){return new Promise(function(b,c){a.isDirectory?a.removeRecursively(b,wrm.util.fs._tofileErrorReject(c)):a.remove(b,wrm.util.fs._tofileErrorReject(c))})};wrm.util.fs.lookupFileEntry=function(a){return wrm.util.fs._lookupFileSystemEntry(a).then(function(b){if(b.isFile)return b;throw Error("Not a file: "+a);})};
wrm.util.fs.lookupDirectoryEntry=function(a){return wrm.util.fs._lookupFileSystemEntry(a).then(function(b){if(b.isDirectory)return b;throw Error("Not a directory: "+a);})};
wrm.util.fs._lookupFileSystemEntry=function(a){return new Promise(function(b,c){var d=!1,e=GLOBAL.setTimeout(function(){d=!0;c(Error("Access to path '"+a+"' timed out"))},2E3);GLOBAL.resolveLocalFileSystemURL(a,function(a){d||(GLOBAL.clearTimeout(e),b(a))},function(b){b=wrm.util.fs._normalizeFileError(b);d||(GLOBAL.clearTimeout(e),c(Error("Error accessing path '"+a+"' ("+b.message+")")))})})};wrm.util.fs._tofileErrorReject=function(a){return function(b){return a(wrm.util.fs._normalizeFileError(b))}};
wrm.util.fs._normalizeFileError=function(a){var b=a&&a.code;"number"!==typeof b&&(b=1E3);(a=a&&a.message)||(a=wrm.util.fs._ERROR_CODES[b]);a||(a="Unknown erorr ("+b+")");a=Error(a);a.code=b;return a};wrm.util.fs._ERROR_CODES=[null,"Not found","Security error","Aborted","Not readable","Encoding error","No modification allowed","Invalid state","Syntax error","Invalid modification","Quota exceeded","Type mismatch","Path exists"];wrm.core.AppStartupHandler=function(a,b){wrm.core.AbstractEventHandler.call(this,b);this._homeId=a.home;this._initializeDataEnabled=!0;this._reAccess=a.reAccess;this._log=b.getPlatform().createLog("wrm.core.AppStartupHandler")};extendConstructor(wrm.core.AppStartupHandler,wrm.core.AbstractEventHandler);
wrm.core.AppStartupHandler.prototype.notify=function(a,b){var c=wrm.nav.Dialog,d=this,e=this._homeId,f=this.getManager(),g=this._log,h=!!a.getParameters().warm;a=Promise.resolve();h||(a=a.then(function(){return d._clearTempFiles()}),a=a.then(function(){return f.getUpdateService().then(function(a){return a.update(b)})}),this._initializeDataEnabled&&(a=a.then(function(a){return a?a:d._initializeData().then(function(){return a},function(a){g.error("Error initializing database",a);return b.presentDialog(new c("Error initializing database: "+
a.message,c.Flavor.NEGATIVE)).then(function(){throw a;})})})),a=a.then(function(a){if(a)return a;var b=wrm.util.obj.lookup("wrxHookAfterDataInit");return"function"===typeof b?Promise.resolve().then(function(){return b(f)}).then(function(){return a}):a}),this._reAccess&&(a=a.then(function(a){return a?a:f.getSecurityService().then(function(a){return a.accessAgain(!1,b)})})),a=a.then(function(a){return a?a:f.getDataSyncService().then(function(a){return a.synchronizeOnStartup(b)})}));a=a.then(function(a){return a?
a:f.getDataSyncService().then(function(c){return c.startPeriodicalSynchronization(b).then(function(){return a})})});return a.then(function(a){if(h){if(DEBUG&&a)throw Error("Non-home route suppressed by warm startup");return wrm.nav.Route.toNowhere()}return a||wrm.nav.Route.toService(e)})};wrm.core.AppStartupHandler.prototype._clearTempFiles=function(){var a=this._log;return wrm.util.fs.clearTempFiles().then(void 0,function(b){a.warn("Error clearing temporary files",b)})};
wrm.core.AppStartupHandler.prototype._initializeData=function(){var a=this,b=this.getManager();return Promise.all([b.getDataService(),b.getConfigurationObject("initialData")]).then(function(b){var d=b[0],e=b[1];return a._clearData(d,e).then(function(){return a._insertData(d,e)}).then(function(){})})};
wrm.core.AppStartupHandler.prototype._clearData=function(a,b){return a.execute(function(c){return Promise.all(a.getMetadata().getEntities().map(function(a){return a.getServerName()||!b[a.getName()]?Promise.resolve():c["delete"](a.getId())}))})};
wrm.core.AppStartupHandler.prototype._insertData=function(a,b){return a.execute(function(c){return a.getMetadata().getEntities().reduce(function(a,e){if(e.getServerName())return a;var f=b[e.getName()];if(!f)return a;var g=e.getProperties(),h=f.map(function(a){var b={};g.forEach(function(c){var d=a[c.getName()];void 0!==d&&(b[c.getId()]=d)});return b});return a.then(function(){return c.insert(e.getId(),h)})},Promise.resolve())})};wrm.core.BackEventHandler=function(a,b){wrm.core.AbstractEventHandler.call(this,b);this._homeId=a.home;var c={};angular.forEach(a.homeLikePanels?a.homeLikePanels.split("|"):[],function(a){c[a]=!0});this._homeLikePanelIds=c;this._backFlow=new wrm.core.BackEventHandler._Flow};extendConstructor(wrm.core.BackEventHandler,wrm.core.AbstractEventHandler);wrm.core.BackEventHandler.prototype.notify=function(a,b){this._backFlow.propagate({},b);return this._createBackRoute(a)};
wrm.core.BackEventHandler.prototype._createBackRoute=function(a){var b=[];b.push(wrm.nav.Route.toBack());(a=a.getTarget()&&a.getTarget().getId())&&!0===this._homeLikePanelIds[a]?b.push(wrm.nav.Route.toExit()):b.push(wrm.nav.Route.toService(this._homeId));return wrm.nav.Route.toFirstOf(b)};wrm.core.BackEventHandler._Flow=function(){wrm.nav.FlowImpl.call(this,{})};extendConstructor(wrm.core.BackEventHandler._Flow,wrm.nav.FlowImpl);wrm.core.BackEventHandler._Flow.prototype.getPreserves=function(){return{}};
wrm.core.BackEventHandler._Flow.prototype.toString=function(){return"\x3cjump to back\x3e"};wrm.core.EventContext=function(){};exportSymbol("wrm.core.EventContext",wrm.core.EventContext);wrm.core.EventContext.prototype.toString=function(){return"{}"};exportProperty(wrm.core.EventContext.prototype,"toString",wrm.core.EventContext.prototype.toString);wrm.core.EventSubscribeContext=function(a,b){wrm.core.EventContext.call(this);this._notifierFunction=a;this._suppressStartupFunction=b};extendConstructor(wrm.core.EventSubscribeContext,wrm.core.EventContext);exportSymbol("wrm.core.EventSubscribeContext",wrm.core.EventSubscribeContext);wrm.core.EventSubscribeContext.prototype.getNotifierFunction=function(){return this._notifierFunction};exportProperty(wrm.core.EventSubscribeContext.prototype,"getNotifierFunction",wrm.core.EventSubscribeContext.prototype.getNotifierFunction);
wrm.core.EventSubscribeContext.prototype.suppressStartupNavigation=function(){this._suppressStartupFunction()};exportProperty(wrm.core.EventSubscribeContext.prototype,"suppressStartupNavigation",wrm.core.EventSubscribeContext.prototype.suppressStartupNavigation);wrm.core.HomeEventHandler=function(a,b){wrm.core.AbstractEventHandler.call(this,b);this._homeId=a.home};extendConstructor(wrm.core.HomeEventHandler,wrm.core.AbstractEventHandler);wrm.core.HomeEventHandler.prototype.notify=function(a,b){return wrm.nav.Route.toService(this._homeId)};wrm.nav.Route=function(){};exportSymbol("wrm.nav.Route",wrm.nav.Route);wrm.nav.Route.prototype.isStationary=function(){};exportProperty(wrm.nav.Route.prototype,"isStationary",wrm.nav.Route.prototype.isStationary);wrm.nav.Route.toNowhere=function(){return wrm.nav.Route.toService()};exportProperty(wrm.nav.Route,"toNowhere",wrm.nav.Route.toNowhere);wrm.nav.Route.toService=function(a,b){return new wrm.nav.ServiceRoute(a,b)};exportProperty(wrm.nav.Route,"toService",wrm.nav.Route.toService);
wrm.nav.Route.toBack=function(){return new wrm.nav.VirtualRoute(wrm.nav.VirtualRoute.Type.BACK)};exportProperty(wrm.nav.Route,"toBack",wrm.nav.Route.toBack);wrm.nav.Route.toExit=function(){return new wrm.nav.VirtualRoute(wrm.nav.VirtualRoute.Type.EXIT)};exportProperty(wrm.nav.Route,"toExit",wrm.nav.Route.toExit);wrm.nav.Route.toFirstOf=function(a){return new wrm.nav.MultipleRoute(a)};exportProperty(wrm.nav.Route,"toFirstOf",wrm.nav.Route.toFirstOf);wrm.core.SynchronizationSuccessHandler=function(a){wrm.core.AbstractEventHandler.call(this,a)};extendConstructor(wrm.core.SynchronizationSuccessHandler,wrm.core.AbstractEventHandler);wrm.core.SynchronizationSuccessHandler.prototype.notify=function(a,b){return wrm.nav.Route.toNowhere()};wrm.core.TimerHandler=function(a){wrm.core.AbstractEventHandler.call(this,a);this._callbacks=[];this._nextHandle=0;this._runningCallbacks={};this._log=a.getPlatform().createLog("wrm.core.TimerHandler")};extendConstructor(wrm.core.TimerHandler,wrm.core.AbstractEventHandler);
wrm.core.TimerHandler.prototype.notify=function(a,b){var c=this,d=this._log,e=a.getSpecifier()||"",f=this._callbacks[e];return f?!0===this._runningCallbacks[e]?(d.debug("Skipping handling of timer "+e+" while still in progress"),wrm.nav.Route.toNowhere()):Promise.resolve().then(function(){c._runningCallbacks[e]=!0;return f(b)}).then(function(a){delete c._runningCallbacks[e];return a||wrm.nav.Route.toNowhere()},function(a){delete c._runningCallbacks[e];throw a;}):(d.debug("Ignoring unknown timer "+
e),wrm.nav.Route.toNowhere())};wrm.core.TimerHandler.prototype.registerTimer=function(a,b,c){var d=String(this._nextHandle++);this._callbacks[d]=a;c.startTimerEvents(d,b);return d};wrm.core.TimerHandler.prototype.unregisterTimer=function(a,b){delete this._callbacks[a];b.stopTimerEvents(a)};wrm.core.AppService=function(a,b,c){wrm.core.AbstractService.call(this,a,b,c);a=this._createEventInfos(b.events);this._eventInfos=a.map;this._eventInfosList=a.list;this._builtinHandlers={};this._startupDone=!1;this._timerHandler=new wrm.core.TimerHandler(c);this._builtinHandlers.AppResume=new wrm.core.AppResumeHandler(b.resume||{},c);this._builtinHandlers.AppStartup=new wrm.core.AppStartupHandler(b.startup||{},c);this._builtinHandlers.BackEvent=new wrm.core.BackEventHandler(b.back||{},c);this._builtinHandlers.HomeEvent=
new wrm.core.HomeEventHandler(b.home||{},c);this._builtinHandlers.SynchronizationSuccess=new wrm.core.SynchronizationSuccessHandler(c);this._builtinHandlers.Timer=this._timerHandler};extendConstructor(wrm.core.AppService,wrm.core.AbstractService);exportSymbol("wrm.core.AppService",wrm.core.AppService);wrm.core.AppService.ID="_app";exportProperty(wrm.core.AppService,"ID",wrm.core.AppService.ID);
wrm.core.AppService.prototype._createEventInfos=function(a){var b={map:{},list:[]};angular.forEach(a,function(a,d){d={eventId:d,type:a.type,dataFlows:(a.dataFlows||[]).map(function(a){return new wrm.nav.FlowImpl(a)}),flow:a.flow?new wrm.nav.NavFlowImpl(a.flow):null};b.map[d.type+"."+d.eventId]=d;!0===a.generic&&(b.map[d.type]=d);b.list.push(d)});return b};wrm.core.AppService.prototype.getFence=function(){return null};exportProperty(wrm.core.AppService.prototype,"getFence",wrm.core.AppService.prototype.getFence);
wrm.core.AppService.prototype.notify=function(a,b){var c=this,d=this.getLog(),e="AppStartup"===a.getType();if(!this._startupDone&&!e)return d.warn("Suppressing event before startup",a),wrm.nav.Route.toNowhere();var f=this._builtinHandlers[a.getType()];return f?Promise.resolve().then(function(){return f.notify(a,b)}).then(function(d){b.catchEvent(c,a);return c.getManager().getDataSyncService().then(function(a){a.collectSuccessEvents(b);return d})}).then(function(a){return a instanceof wrm.nav.VirtualRoute&&
a.getType()===wrm.nav.VirtualRoute.Type.EXIT?a:e?(c._startupDone=!0,c._subscribeEventCatchers(b).then(function(b){return b.suppressStartup?(d.debug("Suppressing startup route"),wrm.nav.Route.toNowhere()):a})):a}):c._handleEvent(a,b)};exportProperty(wrm.core.AppService.prototype,"notify",wrm.core.AppService.prototype.notify);
wrm.core.AppService.prototype._subscribeEventCatchers=function(a){var b=this,c=!1,d=function(){c=!0};return this._eventInfosList.reduce(function(c,f){return c.then(function(){return b._subscribeEventCatcher(f,d,a)})},Promise.resolve()).then(function(){return{suppressStartup:c}})};
wrm.core.AppService.prototype._subscribeEventCatcher=function(a,b,c){var d=this.getLog(),e=a.eventId,f=this._getEventSubscribeContext(a,b,c);return this.getManager().getCatcherService(e).then(function(a){d.debug("Subscribing for events at",a,"-",f);return Promise.resolve(a.subscribe(f))})};
wrm.core.AppService.prototype._handleEvent=function(a,b){var c=this,d=this.getLog(),e=this._getEventInfo(a);if(!e)return null;var f=e.eventId,g=this._getEventCatchContext(e,b);return this.getManager().getCatcherService(f).then(function(c){d.debug("Catching at",c,"event",a,"-",g);return Promise.resolve(c.catchEvent(g,a)).then(function(e){d.debug("Caught at",c,"-",e);b.catchEvent(c,a);return e})}).then(function(a){return c.getManager().getDataSyncService().then(function(c){c.collectSuccessEvents(b);
return a})}).then(function(a){c._propagateEventDataFlows(e,a,b);var f=c._createEventNavigationFlow(e);if(f)return d.debug("Following event flow",f),f.propagate(a,b),b.stepAhead(f),wrm.nav.Route.toService(f.getTargetId());d.debug("Following implicit flow");b.stepImplicitly();return wrm.nav.Route.toNowhere()})};wrm.core.AppService.prototype._getEventInfo=function(a){var b=this._eventInfos[a.getName()];b||(b=this._eventInfos[a.getType()]);return b||null};
wrm.core.AppService.prototype._propagateEventDataFlows=function(a,b,c){a.dataFlows.forEach(function(a){a.propagate(b,c)})};wrm.core.AppService.prototype._createEventNavigationFlow=function(a){return a.flow};wrm.core.AppService.prototype._getEventSubscribeContext=function(a,b,c){a=c.getEventNotifier(a.type,a.eventId);return new wrm.core.EventSubscribeContext(a,b)};wrm.core.AppService.prototype._getEventCatchContext=function(a,b){return new wrm.core.EventContext};
wrm.core.AppService.prototype.startTimer=function(a,b,c){return this._timerHandler.registerTimer(a,b,c)};exportProperty(wrm.core.AppService.prototype,"startTimer",wrm.core.AppService.prototype.startTimer);wrm.core.AppService.prototype.stopTimer=function(a,b){this._timerHandler.unregisterTimer(a,b)};exportProperty(wrm.core.AppService.prototype,"stopTimer",wrm.core.AppService.prototype.stopTimer);wrm.core.AuthenticationError=makeCustomErrorConstructor("wrm.core.AuthenticationError");exportSymbol("wrm.core.AuthenticationError",wrm.core.AuthenticationError);wrm.core.AutoFlow=function(a,b){wrm.nav.AbstractFlow.call(this,b.getId()+".auto-link");this._panelId=b.getId();this._preserves=a.preserve?this._createPreserves(a.preserve):null};extendConstructor(wrm.core.AutoFlow,wrm.nav.AbstractFlow);wrm.core.AutoFlow.prototype._createPreserves=function(a){var b={};angular.forEach(a.split("|"),function(a){a=wrm.core.parseParameter(a);var d=b[a.componentId];d||(b[a.componentId]=d={});d[a.name]=!0});return b};wrm.core.AutoFlow.prototype.getBoundSourceId=function(){return this._panelId};
wrm.core.AutoFlow.prototype.getBoundTargetId=function(){return this._panelId};wrm.core.AutoFlow.prototype.getTargetId=function(){return this._panelId};wrm.core.AutoFlow.prototype.getPreserves=function(){return this._preserves};wrm.core.BackEndUrlHandler=function(a,b){wrm.core.AbstractUpdateParticipant.call(this);this._currentUrl=wrm.core.BackEndUrlHandler._normalizeUrl(a);this._log=b};extendConstructor(wrm.core.BackEndUrlHandler,wrm.core.AbstractUpdateParticipant);wrm.core.BackEndUrlHandler.prototype.getUrl=function(){return this._currentUrl};wrm.core.BackEndUrlHandler.prototype.getRequiredParticipantIds=function(){return[wrm.data.DataService.UPDATE_ID]};
wrm.core.BackEndUrlHandler.prototype.beginUpdate=function(a){var b=wrm.core.BackEndUrlHandler._ORIG_URL_SNAPSHOT_KEY,c=a.getStableSnapshot(),d=wrm.core.BackEndUrlHandler._normalizeUrl(c.get(b)||null);null===d&&(d=this._currentUrl,c.set(b,String(d)));b=this._currentUrl;c=d!==b;a.setInfo({updating:c,originalUrl:d,currentUrl:b});c?this._switchCurrentUrl(d):this._log.debug("No back-end change is needed")};
wrm.core.BackEndUrlHandler.prototype.performReductionUpdate=function(a){a=a.getInfo();a.updating&&this._switchCurrentUrl(a.currentUrl)};wrm.core.BackEndUrlHandler.prototype.finishUpdate=function(a){var b=wrm.core.BackEndUrlHandler._ORIG_URL_SNAPSHOT_KEY,c=a.getInfo();c.updating&&a.getStableSnapshot().set(b,c.currentUrl||"");return c.updating};
wrm.core.BackEndUrlHandler.prototype._switchCurrentUrl=function(a){a?this._log.debug("Now using back-end",a):this._log.debug("Now using no back-end");this._currentUrl=a};wrm.core.BackEndUrlHandler._ORIG_URL_SNAPSHOT_KEY="url";wrm.core.BackEndUrlHandler._normalizeUrl=function(a){a&&!/\/$/.test(a)&&(a+="/");return a};wrm.core.ForbiddenError=makeCustomErrorConstructor("wrm.core.ForbiddenError");exportSymbol("wrm.core.ForbiddenError",wrm.core.ForbiddenError);wrm.core.NetworkError=makeCustomErrorConstructor("wrm.core.NetworkError");exportSymbol("wrm.core.NetworkError",wrm.core.NetworkError);wrm.data={};wrm.data.Comparable=function(){};exportSymbol("wrm.data.Comparable",wrm.data.Comparable);wrm.data.Comparable.prototype.compareTo=ABSTRACT_METHOD;exportProperty(wrm.data.Comparable.prototype,"compareTo",wrm.data.Comparable.prototype.compareTo);wrm.data.TypedValue=function(){};exportSymbol("wrm.data.TypedValue",wrm.data.TypedValue);wrm.data.TypedValue.prototype.hashKey=ABSTRACT_METHOD;exportProperty(wrm.data.TypedValue.prototype,"hashKey",wrm.data.TypedValue.prototype.hashKey);wrm.data.TypedValue.prototype.equals=ABSTRACT_METHOD;exportProperty(wrm.data.TypedValue.prototype,"equals",wrm.data.TypedValue.prototype.equals);wrm.data.TypedValue.prototype.getValueType=ABSTRACT_METHOD;
exportProperty(wrm.data.TypedValue.prototype,"getValueType",wrm.data.TypedValue.prototype.getValueType);wrm.data.DateTime=function(a,b,c,d,e,f,g,h){"number"===typeof h?(a=Date.UTC(a,b,c,d||0,e||0,f||0,g||0),h=new Date(a-6E4*h)):h=new Date(a,b,c,d||0,e||0,f||0,g||0);this._date=h};exportSymbol("wrm.data.DateTime",wrm.data.DateTime);wrm.data.DateTime.prototype.getYear=function(){return this._date.getFullYear()};exportProperty(wrm.data.DateTime.prototype,"getYear",wrm.data.DateTime.prototype.getYear);wrm.data.DateTime.prototype.getMonth=function(){return this._date.getMonth()};
exportProperty(wrm.data.DateTime.prototype,"getMonth",wrm.data.DateTime.prototype.getMonth);wrm.data.DateTime.prototype.getDay=function(){return this._date.getDate()};exportProperty(wrm.data.DateTime.prototype,"getDay",wrm.data.DateTime.prototype.getDay);wrm.data.DateTime.prototype.getHours=function(){return this._date.getHours()};exportProperty(wrm.data.DateTime.prototype,"getHours",wrm.data.DateTime.prototype.getHours);wrm.data.DateTime.prototype.getMinutes=function(){return this._date.getMinutes()};
exportProperty(wrm.data.DateTime.prototype,"getMinutes",wrm.data.DateTime.prototype.getMinutes);wrm.data.DateTime.prototype.getSeconds=function(){return this._date.getSeconds()};exportProperty(wrm.data.DateTime.prototype,"getSeconds",wrm.data.DateTime.prototype.getSeconds);wrm.data.DateTime.prototype.getMilliseconds=function(){return this._date.getMilliseconds()};exportProperty(wrm.data.DateTime.prototype,"getMilliseconds",wrm.data.DateTime.prototype.getMilliseconds);
wrm.data.DateTime.prototype.getTimezoneOffset=function(){return this._date.getTimezoneOffset()};exportProperty(wrm.data.DateTime.prototype,"getTimezoneOffset",wrm.data.DateTime.prototype.getTimezoneOffset);wrm.data.DateTime.prototype.asDate=function(){return this._date};exportProperty(wrm.data.DateTime.prototype,"asDate",wrm.data.DateTime.prototype.asDate);
wrm.data.DateTime.prototype.compareTo=function(a){a instanceof wrm.data.DateTime||(a=wrm.data.toTimestamp(a));return a===this?0:this._date.valueOf()-a._date.valueOf()};exportProperty(wrm.data.DateTime.prototype,"compareTo",wrm.data.DateTime.prototype.compareTo);wrm.data.DateTime.prototype.hashKey=function(){return String(this._date.valueOf())};exportProperty(wrm.data.DateTime.prototype,"hashKey",wrm.data.DateTime.prototype.hashKey);
wrm.data.DateTime.prototype.equals=function(a){return a instanceof wrm.data.DateTime?a===this?!0:this._date.valueOf()===a._date.valueOf():!1};exportProperty(wrm.data.DateTime.prototype,"equals",wrm.data.DateTime.prototype.equals);wrm.data.DateTime.prototype.getValueType=function(){return wrm.data.Type.TIMESTAMP};exportProperty(wrm.data.DateTime.prototype,"getValueType",wrm.data.DateTime.prototype.getValueType);
wrm.data.DateTime.prototype.toString=function(){var a=this.getTimezoneOffset(),b=100*Math.floor(Math.abs(a)/60)+Math.floor(Math.abs(a)%60),c=("0000"+this.getYear()).slice(-4),c=c+("-"+("00"+(this.getMonth()+1)).slice(-2)),c=c+("-"+("00"+this.getDay()).slice(-2)),c=c+("T"+("00"+this.getHours()).slice(-2)),c=c+(":"+("00"+this.getMinutes()).slice(-2)),c=c+(":"+("00"+this.getSeconds()).slice(-2)),c=c+("."+("000"+this.getMilliseconds()).slice(-3));return c+=(0>a?"+":"-")+("0000"+b).slice(-4)};
exportProperty(wrm.data.DateTime.prototype,"toString",wrm.data.DateTime.prototype.toString);wrm.data.DateTime.prototype.toJSON=function(){return this.toString()};exportProperty(wrm.data.DateTime.prototype,"toJSON",wrm.data.DateTime.prototype.toJSON);wrm.data.DateTime.now=function(){return wrm.data.DateTime.fromDate(new Date)};exportProperty(wrm.data.DateTime,"now",wrm.data.DateTime.now);
wrm.data.DateTime.fromString=function(a){var b=/^([0-9]{4})-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])T([0-9]|0[0-9]|1[0-9]|2[0-3]):([0-5][0-9]|[0-9])(?::([0-5][0-9]|[0-9])(?:\.(\d{3}))?)?(Z|([+\-])([0-9][0-9]):?([0-5][0-9])?)?$/.exec(a);if(!b)throw Error("Invalid timestamp string: "+a);a=Number(b[1]);var c=Number(b[2])-1,d=Number(b[3]),e=Number(b[4]),f=Number(b[5]),g=Number(b[6]||"0"),h=Number(b[7]||"0"),k=null;"Z"===b[8]?k=0:b[8]&&(k=("-"===b[9]?-1:1)*(60*Number(b[10]||"0")+Number(b[11]||"0")));return new wrm.data.DateTime(a,
c,d,e,f,g,h,k)};exportProperty(wrm.data.DateTime,"fromString",wrm.data.DateTime.fromString);wrm.data.DateTime.fromTimestamp=function(a){return wrm.data.DateTime.fromDate(new Date(a))};exportProperty(wrm.data.DateTime,"fromTimestamp",wrm.data.DateTime.fromTimestamp);wrm.data.DateTime.fromDate=function(a){var b=a.getFullYear(),c=a.getMonth(),d=a.getDate(),e=a.getHours(),f=a.getMinutes(),g=a.getSeconds(),h=a.getMilliseconds();a=-1*a.getTimezoneOffset();return new wrm.data.DateTime(b,c,d,e,f,g,h,a)};
exportProperty(wrm.data.DateTime,"fromDate",wrm.data.DateTime.fromDate);wrm.util.AsyncIterator=function(){};exportSymbol("wrm.util.AsyncIterator",wrm.util.AsyncIterator);wrm.util.AsyncIterator.prototype.next=function(){};exportProperty(wrm.util.AsyncIterator.prototype,"next",wrm.util.AsyncIterator.prototype.next);wrm.util.AsyncIterator.ConcurrencyError=makeCustomErrorConstructor("wrm.core.AsyncIterator.ConcurrencyError");exportProperty(wrm.util.AsyncIterator,"ConcurrencyError",wrm.util.AsyncIterator.ConcurrencyError);
wrm.util.AsyncIterator.forEach=function(a,b){return wrm.util.AsyncIterator._forEachStep(a,b,0)};exportProperty(wrm.util.AsyncIterator,"forEach",wrm.util.AsyncIterator.forEach);wrm.util.AsyncIterator._forEachStep=function(a,b,c){return a.next().then(function(d){if(!d.done)return Promise.resolve(b(d.value,c)).then(function(){return wrm.util.AsyncIterator._forEachStep(a,b,c+1)})})};wrm.core.BackEndService=function(a,b,c){wrm.core.AbstractService.call(this,a,b,c);a=this.getDescriptorValue(b,"baseUrl")||null;this._urlHandler=new wrm.core.BackEndUrlHandler(a,this.getLog())};extendConstructor(wrm.core.BackEndService,wrm.core.AbstractService);exportSymbol("wrm.core.BackEndService",wrm.core.BackEndService);
wrm.core.BackEndService.prototype.initialize=function(){var a=this,b=this.getManager();return Promise.all([b.getUpdateService().then(function(b){b.registerParticipant(wrm.core.BackEndService.UPDATE_ID,a._urlHandler)})])};exportProperty(wrm.core.BackEndService.prototype,"initialize",wrm.core.BackEndService.prototype.initialize);wrm.core.BackEndService.ID="_backend";exportProperty(wrm.core.BackEndService,"ID",wrm.core.BackEndService.ID);wrm.core.BackEndService.UPDATE_ID="backend";
exportProperty(wrm.core.BackEndService,"UPDATE_ID",wrm.core.BackEndService.UPDATE_ID);wrm.core.BackEndService.prototype.isAvailable=function(){return!!this._urlHandler.getUrl()};exportProperty(wrm.core.BackEndService.prototype,"isAvailable",wrm.core.BackEndService.prototype.isAvailable);wrm.core.BackEndService.prototype.isReachable=function(){return navigator.connection.type!==Connection.NONE};exportProperty(wrm.core.BackEndService.prototype,"isReachable",wrm.core.BackEndService.prototype.isReachable);
wrm.core.BackEndService.prototype.loginUser=function(a,b){var c=this;return Promise.resolve().then(function(){return c._retrieveDeviceInfo()}).then(function(d){var e={};e.deviceId=d.id;e.model=d.model;e.platform=d.platform;e.platformVersion=d.platformVersion;e.browser=d.webEngineType;d.notificationDeviceId&&(e.notificationDeviceId=d.notificationDeviceId);return c._makeRequest("POST","users/login",{data:{username:a,password:b,device:e},responseType:"json",errors:{400:wrm.core.AuthenticationError},
validator:function(a){return"undefined"!==typeof a.userOID&&"string"===typeof a.token&&angular.isArray(a.roles)},transformer:function(a){var b=wrm.core.BackEndService._readAndDelete;return{serverKey:b(a,"userOID"),token:b(a,"token"),roles:b(a,"roles"),record:a}}})})};exportProperty(wrm.core.BackEndService.prototype,"loginUser",wrm.core.BackEndService.prototype.loginUser);
wrm.core.BackEndService.prototype.registerUser=function(a,b,c){return this._makeRequest("POST","users/register",{data:{username:a,password:b,data:c},responseType:"json"})};exportProperty(wrm.core.BackEndService.prototype,"registerUser",wrm.core.BackEndService.prototype.registerUser);
wrm.core.BackEndService.prototype.updateUser=function(a,b,c,d,e){var f={};d&&(f.oldPassword=c,f.newPassword=d);f.data=e;return this._makeRequest("PUT","users/"+encodeURIComponent(String(b)),{authorization:a,data:f,responseType:"json",errors:{403:wrm.core.ForbiddenError,404:wrm.core.NotFoundError},transformer:function(a){return{record:a}}})};exportProperty(wrm.core.BackEndService.prototype,"updateUser",wrm.core.BackEndService.prototype.updateUser);
wrm.core.BackEndService.prototype.retrieveEntityData=function(a,b,c){var d=this;return this._retrieveEntityDataPage(a,b,c||null,0).then(function(e){var f=new wrm.core.BackEndService._DataIterator(e,function(e){return d._retrieveEntityDataPage(a,b,c||null,e)});return{timestamp:e.timestamp,recordCount:e.totalCount,recordPages:f,deletedKeys:e.deletedKeys,keysHash:e.keysHash}})};exportProperty(wrm.core.BackEndService.prototype,"retrieveEntityData",wrm.core.BackEndService.prototype.retrieveEntityData);
wrm.core.BackEndService.prototype._retrieveEntityDataPage=function(a,b,c,d){return this._makeRequest("GET","data/"+encodeURIComponent(b),{headers:{"X-Props":"_SYNC_INFO"},parameters:{delta:c?c.toString():void 0,page:0<d?d+1:void 0},authorization:a,responseType:"json",errors:{403:wrm.core.ForbiddenError},validator:function(a){return angular.isArray(a.data)&&angular.isArray(a.deletedObjectIds)&&"string"===typeof a.timestamp},transformer:function(a){return{timestamp:wrm.data.DateTime.fromString(a.timestamp),
records:a.data,deletedKeys:a.deletedObjectIds,keysHash:a.checksum||null,pageIndex:a.page||0,pageSize:a.pageSize||a.data.length,totalCount:a.totalCount||a.data.length}}})};
wrm.core.BackEndService.prototype.retrieveEntityInstanceData=function(a,b,c){return this._makeRequest("GET","data/"+encodeURIComponent(b)+"/"+encodeURIComponent(String(c)),{authorization:a,responseType:"json",errors:{403:wrm.core.ForbiddenError,404:wrm.core.NotFoundError},validator:function(a){return angular.isArray(a.data)&&1===a.data.length&&"string"===typeof a.timestamp},transformer:function(a){return a.data[0]}})};exportProperty(wrm.core.BackEndService.prototype,"retrieveEntityInstanceData",wrm.core.BackEndService.prototype.retrieveEntityInstanceData);
wrm.core.BackEndService.prototype.retrieveEntityKeys=function(a,b){return this._makeRequest("GET","data/"+encodeURIComponent(b),{headers:{"X-Props":"_OBJECT_ID"},authorization:a,responseType:"json",errors:{403:wrm.core.ForbiddenError},validator:function(a){return angular.isArray(a.objectIds)},transformer:function(a){return a.objectIds}})};exportProperty(wrm.core.BackEndService.prototype,"retrieveEntityKeys",wrm.core.BackEndService.prototype.retrieveEntityKeys);
wrm.core.BackEndService.prototype.createEntityInstance=function(a,b,c){return this._makeRequest("POST","data/"+encodeURIComponent(b),{authorization:a,data:c,responseType:"json",errors:{403:wrm.core.ForbiddenError}})};exportProperty(wrm.core.BackEndService.prototype,"createEntityInstance",wrm.core.BackEndService.prototype.createEntityInstance);
wrm.core.BackEndService.prototype.updateEntityInstance=function(a,b,c,d){return this._makeRequest("PUT","data/"+encodeURIComponent(b)+"/"+encodeURIComponent(String(c)),{authorization:a,data:d,responseType:"json",errors:{403:wrm.core.ForbiddenError,404:wrm.core.NotFoundError}})};exportProperty(wrm.core.BackEndService.prototype,"updateEntityInstance",wrm.core.BackEndService.prototype.updateEntityInstance);
wrm.core.BackEndService.prototype.deleteEntityInstance=function(a,b,c){return this._makeRequest("DELETE","data/"+encodeURIComponent(b)+"/"+encodeURIComponent(String(c)),{authorization:a,responseType:"json",errors:{204:null,404:null}})};exportProperty(wrm.core.BackEndService.prototype,"deleteEntityInstance",wrm.core.BackEndService.prototype.deleteEntityInstance);
wrm.core.BackEndService.prototype.downloadFile=function(a,b){return this._makeRequest("GET","files/download/"+encodeURIComponent(b),{authorization:a,responseType:"arraybuffer",errors:{403:wrm.core.ForbiddenError,404:wrm.core.NotFoundError},validator:function(a){return a instanceof ArrayBuffer||"number"===typeof a.byteLength},transformer:function(a,b){var e=b["content-type"];b=/\bfilename\s*=\s*(.+?)\s*(?:;.*)?$/.exec(b["content-disposition"]);return{buffer:a,contentType:e,fileName:b&&b[1]||null}}})};
exportProperty(wrm.core.BackEndService.prototype,"downloadFile",wrm.core.BackEndService.prototype.downloadFile);
wrm.core.BackEndService.prototype.uploadFile=function(a,b,c){return this._makeRequest("POST","files/upload/"+encodeURIComponent(b),{parameters:{name:c.fileName?c.fileName:void 0},headers:{"Content-Type":c.contentType||void 0},authorization:a,data:c.buffer,responseType:"json",errors:{403:wrm.core.ForbiddenError,404:wrm.core.NotFoundError},validator:function(a){return"string"===typeof a.blobId},transformer:function(a){return a.blobId}})};
exportProperty(wrm.core.BackEndService.prototype,"uploadFile",wrm.core.BackEndService.prototype.uploadFile);
wrm.core.BackEndService.prototype._makeRequest=function(a,b,c){function d(a){var b=a.data,d=a.status,e=null,f=void 0;200>d||400<=d?(e=b&&b["error-message"]||a.statusText,e||(e="Network error (status "+d+")",f=wrm.core.NetworkError)):b?c.validator&&!c.validator(b)&&(e="Received invalid response from back-end"):e="Received malformed response from back-end";if(e||f){a=f||c.errors&&c.errors[d];void 0===a&&(a=Error);if("function"!==typeof a)return a;throw new a(e||"");}c.transformer&&(b=c.transformer(b,
a.headers()));return b}var e=this.getLog(),f=this._urlHandler.getUrl();if(!f)throw Error("The back-end service is not available");c.parameters&&(b+=this._buildQueryString(c.parameters));e.debug("Invoking",a,b);e={};c.headers&&angular.extend(e,c.headers);c.authorization&&(e.Authorization=c.authorization);a={method:a,url:f+b,headers:e,responseType:c.responseType||""};c.data&&c.data instanceof ArrayBuffer?(a.data=wrm.core.BackEndService._buildBinaryData(c.data),a.transformRequest=[]):a.data=c.data;return this.getManager().getPlatform().makeHttpRequest(a).then(d,
d)};wrm.core.BackEndService.prototype._buildQueryString=function(a){var b=[];Object.keys(a).forEach(function(c){var d=a[c];void 0!==d&&b.push(encodeURIComponent(c)+"\x3d"+encodeURIComponent(d))});return 0<b.length?"?"+b.join("\x26"):""};wrm.core.BackEndService._buildBinaryData=function(a){var b=/\bChrome\/(\d+)\./.exec(GLOBAL.navigator.userAgent),b=b&&30<=Number(b[1])?function(a){return new Uint8Array(a)}:function(a){return a};wrm.core.BackEndService._buildBinaryData=b;return b(a)};
wrm.core.BackEndService._DataIterator=function(a,b){this._pageSize=a.pageSize;this._pageIndex=0;this._pageFetcher=b;this._totalCount=a.totalCount;this._pendingFirstPage=a};
wrm.core.BackEndService._DataIterator.prototype.next=function(){var a=this;if(this._pendingFirstPage){var b=this._pendingFirstPage;this._pendingFirstPage=null;return Promise.resolve({value:b.records,done:!1})}return this._pageSize*(this._pageIndex+1)>=this._totalCount?Promise.resolve({value:void 0,done:!0}):this._pageFetcher(++this._pageIndex).then(function(b){if(a._isSourceChanged(b))throw new wrm.util.AsyncIterator.ConcurrencyError("Data changed while requesting pages");a._totalCount=b.totalCount;
return{value:b.records,done:!1}})};wrm.core.BackEndService._DataIterator.prototype._isSourceChanged=function(a){return this._pageSize!==a.pageSize?!0:!1};wrm.core.BackEndService.prototype._retrieveDeviceInfo=function(){var a=this.getManager().getPlatform();return a.getNotificationDeviceId().then(function(b){return{id:a.getDeviceId(),model:a.getDeviceModel(),platform:a.getDevicePlatform(),platformVersion:a.getDevicePlatformVersion(),webEngineType:a.getWebEngineType(),notificationDeviceId:b}})};
wrm.core.BackEndService._readAndDelete=function(a,b){var c=a[b];delete a[b];return c};wrm.core.ComponentContext=function(a){this._input=a};exportSymbol("wrm.core.ComponentContext",wrm.core.ComponentContext);wrm.core.ComponentContext.prototype.getInput=function(){return this._input};exportProperty(wrm.core.ComponentContext.prototype,"getInput",wrm.core.ComponentContext.prototype.getInput);wrm.core.ComponentContext.prototype.toString=function(){return JSON.stringify(this._input)};exportProperty(wrm.core.ComponentContext.prototype,"toString",wrm.core.ComponentContext.prototype.toString);wrm.core.DescriptorLoader=function(){};exportSymbol("wrm.core.DescriptorLoader",wrm.core.DescriptorLoader);wrm.core.DescriptorLoader.prototype.loadConfigurationObject=ABSTRACT_METHOD;exportProperty(wrm.core.DescriptorLoader.prototype,"loadConfigurationObject",wrm.core.DescriptorLoader.prototype.loadConfigurationObject);wrm.core.DescriptorLoader.prototype.loadConfigurationProperties=ABSTRACT_METHOD;exportProperty(wrm.core.DescriptorLoader.prototype,"loadConfigurationProperties",wrm.core.DescriptorLoader.prototype.loadConfigurationProperties);
wrm.core.DescriptorLoader.prototype.loadServiceDescriptor=ABSTRACT_METHOD;exportProperty(wrm.core.DescriptorLoader.prototype,"loadServiceDescriptor",wrm.core.DescriptorLoader.prototype.loadServiceDescriptor);wrm.core.ExecutableOperation=function(a){this._operationService=a};exportSymbol("wrm.core.ExecutableOperation",wrm.core.ExecutableOperation);wrm.core.ExecutableOperation.prototype.execute=function(a,b){a=b.createOperationContext(this._operationService.getId());return this._operationService.executeOperation(a)};exportProperty(wrm.core.ExecutableOperation.prototype,"execute",wrm.core.ExecutableOperation.prototype.execute);wrm.core.ExecutableOperation.prototype.toString=function(){return this._operationService.toString()};
exportProperty(wrm.core.ExecutableOperation.prototype,"toString",wrm.core.ExecutableOperation.prototype.toString);wrm.core.FormInfo=function(a){this._formSubServices=a};exportSymbol("wrm.core.FormInfo",wrm.core.FormInfo);wrm.core.FormInfo.prototype.resolvePropertyFromView=function(a,b){return this._getFormSubService(a).resolvePropertyFromView(b)};exportProperty(wrm.core.FormInfo.prototype,"resolvePropertyFromView",wrm.core.FormInfo.prototype.resolvePropertyFromView);wrm.core.FormInfo.prototype.getPropertyType=function(a,b){return this._getFormSubService(a).getPropertyType(b)};
exportProperty(wrm.core.FormInfo.prototype,"getPropertyType",wrm.core.FormInfo.prototype.getPropertyType);wrm.core.FormInfo.prototype._getFormSubService=function(a){var b=this._formSubServices[a];if(!b)throw Error("Component '"+a+"' is not associated with a form");return b};wrm.nav.Environ=function(){};exportSymbol("wrm.nav.Environ",wrm.nav.Environ);wrm.nav.Environ.prototype.retrieveView=ABSTRACT_METHOD;exportProperty(wrm.nav.Environ.prototype,"retrieveView",wrm.nav.Environ.prototype.retrieveView);wrm.nav.Environ.prototype.markObjectForViewTracking=ABSTRACT_METHOD;exportProperty(wrm.nav.Environ.prototype,"markObjectForViewTracking",wrm.nav.Environ.prototype.markObjectForViewTracking);wrm.nav.Environ.prototype.retrieveFormState=ABSTRACT_METHOD;
exportProperty(wrm.nav.Environ.prototype,"retrieveFormState",wrm.nav.Environ.prototype.retrieveFormState);wrm.nav.Environ.prototype.handleEvent=ABSTRACT_METHOD;exportProperty(wrm.nav.Environ.prototype,"handleEvent",wrm.nav.Environ.prototype.handleEvent);wrm.nav.Environ.prototype.enterPanel=ABSTRACT_METHOD;exportProperty(wrm.nav.Environ.prototype,"enterPanel",wrm.nav.Environ.prototype.enterPanel);wrm.nav.Environ.prototype.startTimerEvents=ABSTRACT_METHOD;
exportProperty(wrm.nav.Environ.prototype,"startTimerEvents",wrm.nav.Environ.prototype.startTimerEvents);wrm.nav.Environ.prototype.stopTimerEvents=ABSTRACT_METHOD;exportProperty(wrm.nav.Environ.prototype,"stopTimerEvents",wrm.nav.Environ.prototype.stopTimerEvents);wrm.nav.Environ.prototype.retrieveEventNotifier=ABSTRACT_METHOD;exportProperty(wrm.nav.Environ.prototype,"retrieveEventNotifier",wrm.nav.Environ.prototype.retrieveEventNotifier);wrm.nav.Environ.prototype.presentDialog=ABSTRACT_METHOD;
exportProperty(wrm.nav.Environ.prototype,"presentDialog",wrm.nav.Environ.prototype.presentDialog);wrm.nav.Environ.prototype.reportProgress=ABSTRACT_METHOD;exportProperty(wrm.nav.Environ.prototype,"reportProgress",wrm.nav.Environ.prototype.reportProgress);wrm.core.InternalEnviron=function(){};exportSymbol("wrm.core.InternalEnviron",wrm.core.InternalEnviron);wrm.core.InternalEnviron.prototype.retrieveView=function(a,b){return null};exportProperty(wrm.core.InternalEnviron.prototype,"retrieveView",wrm.core.InternalEnviron.prototype.retrieveView);wrm.core.InternalEnviron.prototype.markObjectForViewTracking=function(a,b){};exportProperty(wrm.core.InternalEnviron.prototype,"markObjectForViewTracking",wrm.core.InternalEnviron.prototype.markObjectForViewTracking);
wrm.core.InternalEnviron.prototype.retrieveFormState=function(a,b){return null};exportProperty(wrm.core.InternalEnviron.prototype,"retrieveFormState",wrm.core.InternalEnviron.prototype.retrieveFormState);wrm.core.InternalEnviron.prototype.handleEvent=function(a){return Promise.reject(Error("Cannot handle events in the current execution environment"))};exportProperty(wrm.core.InternalEnviron.prototype,"handleEvent",wrm.core.InternalEnviron.prototype.handleEvent);
wrm.core.InternalEnviron.prototype.enterPanel=function(a,b,c){};exportProperty(wrm.core.InternalEnviron.prototype,"enterPanel",wrm.core.InternalEnviron.prototype.enterPanel);wrm.core.InternalEnviron.prototype.presentDialog=function(a){throw Error("Cannot present dialogs in the current execution environment");};exportProperty(wrm.core.InternalEnviron.prototype,"presentDialog",wrm.core.InternalEnviron.prototype.presentDialog);wrm.core.InternalEnviron.prototype.reportProgress=function(a){};
exportProperty(wrm.core.InternalEnviron.prototype,"reportProgress",wrm.core.InternalEnviron.prototype.reportProgress);wrm.core.InternalEnviron.prototype.startTimerEvents=function(a,b){throw Error("Cannot manage timer events in the current execution environment");};exportProperty(wrm.core.InternalEnviron.prototype,"startTimerEvents",wrm.core.InternalEnviron.prototype.startTimerEvents);
wrm.core.InternalEnviron.prototype.stopTimerEvents=function(a){throw Error("Cannot manage timer events in the current execution environment");};exportProperty(wrm.core.InternalEnviron.prototype,"stopTimerEvents",wrm.core.InternalEnviron.prototype.stopTimerEvents);wrm.core.InternalEnviron.prototype.retrieveEventNotifier=function(a,b){throw Error("Cannot notify events in the current execution environment");};exportProperty(wrm.core.InternalEnviron.prototype,"retrieveEventNotifier",wrm.core.InternalEnviron.prototype.retrieveEventNotifier);wrm.core.NavigableThrower=function(a){this._throwerService=a};exportSymbol("wrm.core.NavigableThrower",wrm.core.NavigableThrower);wrm.core.NavigableThrower.prototype.getFence=function(){return null};exportProperty(wrm.core.NavigableThrower.prototype,"getFence",wrm.core.NavigableThrower.prototype.getFence);
wrm.core.NavigableThrower.prototype.navigate=function(a,b){a=b.createComponentContext(this._throwerService.getId());a=Promise.resolve(this._throwerService.throwEvent(a));return a=a.then(function(a){b.dispatchEvent(a);b.stepImplicitly();return wrm.nav.Route.toService(b.getContextualStartPanelId()||void 0)})};exportProperty(wrm.core.NavigableThrower.prototype,"navigate",wrm.core.NavigableThrower.prototype.navigate);wrm.core.NavigableThrower.prototype.toString=function(){return this._throwerService.toString()};
exportProperty(wrm.core.NavigableThrower.prototype,"toString",wrm.core.NavigableThrower.prototype.toString);wrm.core.UserInfo=function(a,b,c,d,e){this._username=a;this._serverKey=c;this._key=b;this._properties=d;this._allRoleProperties=e};exportSymbol("wrm.core.UserInfo",wrm.core.UserInfo);wrm.core.UserInfo.prototype.getUsername=function(){return this._username};exportProperty(wrm.core.UserInfo.prototype,"getUsername",wrm.core.UserInfo.prototype.getUsername);wrm.core.UserInfo.prototype.getServerKey=function(){return this._serverKey};exportProperty(wrm.core.UserInfo.prototype,"getServerKey",wrm.core.UserInfo.prototype.getServerKey);
wrm.core.UserInfo.prototype.getKey=function(){return this._key};exportProperty(wrm.core.UserInfo.prototype,"getKey",wrm.core.UserInfo.prototype.getKey);wrm.core.UserInfo.prototype.getProperties=function(){return this._properties};exportProperty(wrm.core.UserInfo.prototype,"getProperties",wrm.core.UserInfo.prototype.getProperties);wrm.core.UserInfo.prototype.getRoleNames=function(){return Object.keys(this._allRoleProperties)};exportProperty(wrm.core.UserInfo.prototype,"getRoleNames",wrm.core.UserInfo.prototype.getRoleNames);
wrm.core.UserInfo.prototype.getRoleProperties=function(a){var b=this._allRoleProperties[a];if(!b)throw Error("User does not belong to role "+a);return b};exportProperty(wrm.core.UserInfo.prototype,"getRoleProperties",wrm.core.UserInfo.prototype.getRoleProperties);wrm.core.ServerStore=function(){};wrm.core.ServerStore.prototype.getEntity=ABSTRACT_METHOD;wrm.core.ServerStore.prototype.isServerAvailable=ABSTRACT_METHOD;wrm.core.ServerStore.prototype.isServerReadable=ABSTRACT_METHOD;wrm.core.ServerStore.prototype.retrieveEntityData=ABSTRACT_METHOD;wrm.core.ServerStore.prototype.retrieveEntityInstanceData=ABSTRACT_METHOD;wrm.core.ServerStore.prototype.retrieveEntityKeys=ABSTRACT_METHOD;wrm.core.ServerStore.prototype.createEntityInstance=ABSTRACT_METHOD;
wrm.core.ServerStore.prototype.updateEntityInstance=ABSTRACT_METHOD;wrm.core.ServerStore.prototype.deleteEntityInstance=ABSTRACT_METHOD;wrm.util.ArrayAsyncIterator=function(a){this._elements=a;this._nextElementIndex=0};wrm.util.ArrayAsyncIterator.prototype.next=function(){if(this._nextElementIndex<this._elements.length){var a=this._elements[this._nextElementIndex++];return Promise.resolve({value:a,done:!1})}return Promise.resolve({value:void 0,done:!0})};wrm.core.UserServerStore=function(a,b){this._entity=a;this._serverName=this._entity.getServerName();this._data=null};wrm.core.UserServerStore.prototype.getEntity=function(){return this._entity};wrm.core.UserServerStore.prototype.isServerAvailable=function(){return!0};wrm.core.UserServerStore.prototype.isServerReadable=function(){return this._data?!0:!1};wrm.core.UserServerStore.prototype.isMappedUser=function(){return this._serverName};
wrm.core.UserServerStore.prototype.setData=function(a){if(this._data)throw Error("Data already present");this._data=[a]};wrm.core.UserServerStore.prototype.clearData=function(){if(!this._data)throw Error("Data is already empty");this._data=null};
wrm.core.UserServerStore.prototype.retrieveEntityData=function(a,b){if(!this._data)throw Error("Data should not be empty");a=this._data;this._data=null;return Promise.resolve({timestamp:wrm.data.DateTime.now(),recordCount:a.length,recordPages:new wrm.util.ArrayAsyncIterator([a]),deletedKeys:[],keysHash:null})};wrm.core.UserServerStore.prototype.retrieveEntityInstanceData=function(a,b){return this._operationNotAllowed()};wrm.core.UserServerStore.prototype.retrieveEntityKeys=function(a){return this._operationNotAllowed()};
wrm.core.UserServerStore.prototype.createEntityInstance=function(a,b){return this._operationNotAllowed()};wrm.core.UserServerStore.prototype.updateEntityInstance=function(a,b,c){return this._operationNotAllowed()};wrm.core.UserServerStore.prototype.deleteEntityInstance=function(a,b){return this._operationNotAllowed()};wrm.core.UserServerStore.prototype._operationNotAllowed=function(){throw Error("Operation not allowed");};wrm.core.VolatileHolder=function(a){this._finalInstance=a;this._instance=void 0;this._usersCallbacks=[]};wrm.core.VolatileHolder.prototype.swap=function(a){if(null===this._instance)throw Error("Cannot swap away the final instance");this._instance&&implementsInterface(this._instance,wrm.core.VolatileHolder.Instance)&&this._instance.invalidate();this._instance=a;this._usersCallbacks.forEach(function(a){a(this._instance||this._finalInstance,null===this._instance)},this)};
wrm.core.VolatileHolder.prototype.use=function(a){this._usersCallbacks.push(a);a(this._instance||this._finalInstance,null===this._instance)};wrm.core.VolatileHolder.Instance=function(){};wrm.core.VolatileHolder.prototype.invalidate=function(){};wrm.data.Blob=function(a,b,c){this._uniqueId=wrm.data.Blob._nextUniqueId++;this._content=a instanceof File?a:wrm.data.Blob._constructBlob(a,b);this._metadata=angular.extend({fileName:null,contentSignature:null,availabilityStatus:wrm.data.AvailabilityStatus.AVAILABLE},c);this._contentType=wrm.data.ContentType.retrieveBestContentType([this._content.type,b,this._retrieveContentType()]).getName();this._externalFileEntry=null;this._fileUrlUsages=0;this._fileUrl=null;this._externalUrlUsages=0};
exportSymbol("wrm.data.Blob",wrm.data.Blob);wrm.data.Blob._nextUniqueId=0;
wrm.data.Blob._constructBlob=function(a,b){var c;a:{try{c=1===(new Blob([new Uint8Array([65])])).size;break a}catch(f){}c=!1}var d;a:{try{d=1===(new Blob([(new Uint8Array([65])).buffer])).size;break a}catch(f){}d=!1}var e=GLOBAL.BlobBuilder||GLOBAL.WebKitBlobBuilder;if(c)c=function(a,b){return b?new Blob([a],{type:b}):new Blob([a])};else if(d)c=function(a,b){a.buffer&&(a=a.buffer);return b?new Blob([a],{type:b}):new Blob([a])};else if(e)c=function(a,b){a.buffer&&(a=a.buffer);var c=new e;c.append(a);
return b?c.getBlob(b):c.getBlob()};else throw Error("The device does not support BLOB handling");wrm.data.Blob._constructBlob=c;return c(a,b)};wrm.data.Blob.prototype.getUniqueId=function(){return this._uniqueId};exportProperty(wrm.data.Blob.prototype,"getUniqueId",wrm.data.Blob.prototype.getUniqueId);wrm.data.Blob.prototype.getSize=function(){return this._content.size};exportProperty(wrm.data.Blob.prototype,"getSize",wrm.data.Blob.prototype.getSize);wrm.data.Blob.prototype.getContentType=function(){return this._contentType};
exportProperty(wrm.data.Blob.prototype,"getContentType",wrm.data.Blob.prototype.getContentType);wrm.data.Blob.prototype.getMetadata=function(){return this._metadata};exportProperty(wrm.data.Blob.prototype,"getMetadata",wrm.data.Blob.prototype.getMetadata);wrm.data.Blob.prototype.computeExternalFileName=function(){var a=this.getMetadata().fileName;return a?a.replace(/ /g,"_"):"file"+(wrm.data.ContentType.lookup(this.getContentType(),"application/octet-stream").getFileNameSuffix()||"")};
exportProperty(wrm.data.Blob.prototype,"computeExternalFileName",wrm.data.Blob.prototype.computeExternalFileName);wrm.data.Blob.prototype.read=function(){var a=this._content;return new Promise(function(b,c){var d=new FileReader;d.onload=function(){b(new Uint8Array(d.result))};d.onerror=function(a){c(Error("Blob read failed"))};d.readAsArrayBuffer(a)})};exportProperty(wrm.data.Blob.prototype,"read",wrm.data.Blob.prototype.read);
wrm.data.Blob.prototype.readBlob=function(){var a=this.getContentType()||void 0;return this.read().then(function(b){return wrm.data.Blob.fromBytes(b,a)._content})};exportProperty(wrm.data.Blob.prototype,"readBlob",wrm.data.Blob.prototype.readBlob);
wrm.data.Blob.prototype.createObjectURL=function(){var a=GLOBAL.URL||GLOBAL.webkitURL,b=function(){return this._isContentFile()?(0===this._fileUrlUsages&&(this._fileUrl=this._content.nativeURL+"?"+(new Date).valueOf()),this._fileUrlUsages++,Promise.resolve(this._fileUrl)):Promise.resolve(a.createObjectURL(this._content))};wrm.data.Blob.prototype.createObjectURL=b;return b.call(this)};exportProperty(wrm.data.Blob.prototype,"createObjectURL",wrm.data.Blob.prototype.createObjectURL);
wrm.data.Blob.prototype.revokeObjectURL=function(a){var b=GLOBAL.URL||GLOBAL.webkitURL,c=function(a){this._isContentFile()?(this._fileUrlUsages--,0===this._fileUrlUsages&&(this._fileUrl=null)):b.revokeObjectURL(a)};wrm.data.Blob.prototype.revokeObjectURL=c;return c.call(this,a)};exportProperty(wrm.data.Blob.prototype,"revokeObjectURL",wrm.data.Blob.prototype.revokeObjectURL);
wrm.data.Blob.prototype.createExternalURL=function(){var a=this;this._externalUrlUsages++;var b=this._externalFileEntry;b||(this._externalFileEntry=b=Promise.resolve().then(function(){var b=a.computeExternalFileName();return wrm.util.fs.createNamedTempFile(b)}).then(function(b){return a.writeIntoFileEntry(b)})["catch"](function(b){a._externalUrlUsages--;a._externalFileEntry=null;throw b;}));return b.then(function(a){return a.toURL()})};exportProperty(wrm.data.Blob.prototype,"createExternalURL",wrm.data.Blob.prototype.createExternalURL);
wrm.data.Blob.prototype.revokeExternalURL=function(a){this._externalUrlUsages--;a=this._externalFileEntry;return 0>=this._externalUrlUsages&&a?(this._externalUrlUsages=null,a.then(function(a){return wrm.util.fs.deleteTempFile(a).then(void 0,function(a){throw Error("Error deleting file: "+a);})})):Promise.resolve()};exportProperty(wrm.data.Blob.prototype,"revokeExternalURL",wrm.data.Blob.prototype.revokeExternalURL);
wrm.data.Blob.prototype.writeIntoFileEntry=function(a){return this._isContentBlob()?wrm.data.Blob._doWriteBlobIntoFilEntry(a,this._content):this._isContentFile()&&this._content.localURL?wrm.data.Blob._doCopyFileIntoFilEntry(a,this._content.localURL):this.readBlob().then(function(b){return wrm.data.Blob._doWriteBlobIntoFilEntry(a,b)})};
wrm.data.Blob._doWriteBlobIntoFilEntry=function(a,b){return new Promise(function(c,d){a.createWriter(function(e){e.onwriteend=function(){c(a)};e.onerror=function(a){d(Error("Error writing to file: "+a))};e.write(b)},function(a){d(Error("Error opening file for writing: "+a))})})};
wrm.data.Blob._doCopyFileIntoFilEntry=function(a,b){return wrm.util.fs.lookupFileEntry(b).then(function(b){return new Promise(function(d,e){a.getParent(function(f){b.copyTo(f,a.name,function(){d(a)},function(a){e(Error("Error copying file: "+a))})},function(a){e(Error("Error retrieving parent directory: "+a))})})})};wrm.data.Blob.prototype.hashKey=function(){return"Blob:"+this._uniqueId};exportProperty(wrm.data.Blob.prototype,"hashKey",wrm.data.Blob.prototype.hashKey);
wrm.data.Blob.prototype.equals=function(a){if(!(a instanceof wrm.data.Blob))return!1;if(a===this)return!0;var b=this._metadata;a=a._metadata;return null!==b.contentSignature&&null!==a.contentSignature&&b.fileName===a.fileName&&b.contentSignature===a.contentSignature?!0:!1};exportProperty(wrm.data.Blob.prototype,"equals",wrm.data.Blob.prototype.equals);wrm.data.Blob.prototype.getValueType=function(){return wrm.data.Type.BLOB};exportProperty(wrm.data.Blob.prototype,"getValueType",wrm.data.Blob.prototype.getValueType);
wrm.data.Blob.prototype.toString=function(){var a=[];a.push("Blob(");a.push(String(this.getSize()));a.push(" bytes, ");a.push(this.getContentType()||"unknown type");a.push(")");return a.join("")};exportProperty(wrm.data.Blob.prototype,"toString",wrm.data.Blob.prototype.toString);wrm.data.Blob.prototype.toJSON=function(){throw Error("Blob value not serializable to JSON");};exportProperty(wrm.data.Blob.prototype,"toJSON",wrm.data.Blob.prototype.toJSON);
wrm.data.Blob.prototype._retrieveContentType=function(){var a=this.getMetadata().fileName;if(!a)return null;a=a.replace(/ /g,"_");return(a=/[.]([^.]+)$/.exec(a))&&a[0]?(a=wrm.data.ContentType.retrieveContentTypeBySuffix(a[0]))?a.getName():null:null};wrm.data.Blob.prototype._isContentFile=function(){return this._content instanceof File};wrm.data.Blob.prototype._isContentBlob=function(){return!this._isContentFile()};wrm.data.Blob.fromFile=function(a,b,c){return new wrm.data.Blob(a,b,c)};
exportProperty(wrm.data.Blob,"fromFile",wrm.data.Blob.fromFile);wrm.data.Blob.fromBlob=function(a,b){return new wrm.data.Blob(a,a.type,b)};exportProperty(wrm.data.Blob,"fromBlob",wrm.data.Blob.fromBlob);wrm.data.Blob.fromBytes=function(a,b,c){return new wrm.data.Blob(a,b,c)};exportProperty(wrm.data.Blob,"fromBytes",wrm.data.Blob.fromBytes);
wrm.data.Blob.fromDataUri=function(a,b){a=wrm.data.Blob.fromDataUri._DATA_URI_RE.exec(a);if(!a)throw Error("Invalid data URI");if("base64"!==a[2])throw Error("Only Base64-encoded URIs are supported");return wrm.data.Blob.fromBase64(a[3],a[1],b)};exportProperty(wrm.data.Blob,"fromDataUri",wrm.data.Blob.fromDataUri);wrm.data.Blob.fromDataUri._DATA_URI_RE=/^data:(.*?)(?:;(base64))?,(.*)$/;wrm.data.Blob.fromBase64=function(a,b,c){a=wrm.data.Blob._parseBase64(a);return new wrm.data.Blob(a,b,c)};
exportProperty(wrm.data.Blob,"fromBase64",wrm.data.Blob.fromBase64);wrm.data.Blob._parseBase64=function(a){a=a.replace(/[^A-Za-z0-9\+\/]/g,"");for(var b=a.length,c=3*b+1>>2,d=new Uint8Array(c),e,f=0,g=0,h=0;h<b;h++){e=h&3;var k=a.charCodeAt(h),f=f|(64<k&&91>k?k-65:96<k&&123>k?k-71:47<k&&58>k?k+4:43===k?62:47===k?63:0)<<18-6*e;if(3===e||1===b-h){for(e=0;3>e&&g<c;e++,g++)d[g]=f>>>(16>>>e&24)&255;f=0}}return d};wrm.data.Date=function(a,b,c){this._date=new Date(a,b,c)};exportSymbol("wrm.data.Date",wrm.data.Date);wrm.data.Date.prototype.getYear=function(){return this._date.getFullYear()};exportProperty(wrm.data.Date.prototype,"getYear",wrm.data.Date.prototype.getYear);wrm.data.Date.prototype.getMonth=function(){return this._date.getMonth()};exportProperty(wrm.data.Date.prototype,"getMonth",wrm.data.Date.prototype.getMonth);wrm.data.Date.prototype.getDay=function(){return this._date.getDate()};
exportProperty(wrm.data.Date.prototype,"getDay",wrm.data.Date.prototype.getDay);wrm.data.Date.prototype.asDate=function(){return this._date};exportProperty(wrm.data.Date.prototype,"asDate",wrm.data.Date.prototype.asDate);wrm.data.Date.prototype.compareTo=function(a){a instanceof wrm.data.Date||(a=wrm.data.toDate(a));return a===this?0:this._date.valueOf()-a._date.valueOf()};exportProperty(wrm.data.Date.prototype,"compareTo",wrm.data.Date.prototype.compareTo);wrm.data.Date.prototype.hashKey=function(){return String(this._date.valueOf())};
exportProperty(wrm.data.Date.prototype,"hashKey",wrm.data.Date.prototype.hashKey);wrm.data.Date.prototype.equals=function(a){return a instanceof wrm.data.Date?a===this?!0:this._date.valueOf()===a._date.valueOf():!1};exportProperty(wrm.data.Date.prototype,"equals",wrm.data.Date.prototype.equals);wrm.data.Date.prototype.getValueType=function(){return wrm.data.Type.DATE};exportProperty(wrm.data.Date.prototype,"getValueType",wrm.data.Date.prototype.getValueType);
wrm.data.Date.prototype.toString=function(){var a=("0000"+this.getYear()).slice(-4),a=a+("-"+("00"+(this.getMonth()+1)).slice(-2));return a+="-"+("00"+this.getDay()).slice(-2)};exportProperty(wrm.data.Date.prototype,"toString",wrm.data.Date.prototype.toString);wrm.data.Date.prototype.toJSON=function(){return this.toString()};exportProperty(wrm.data.Date.prototype,"toJSON",wrm.data.Date.prototype.toJSON);
wrm.data.Date.fromString=function(a){var b=/^([0-9]{4})-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$/.exec(a);if(!b)throw Error("Invalid date string: "+a);return new wrm.data.Date(Number(b[1]),Number(b[2])-1,Number(b[3]))};exportProperty(wrm.data.Date,"fromString",wrm.data.Date.fromString);wrm.data.Date.fromTimestamp=function(a){return wrm.data.Date.fromDate(new Date(a))};exportProperty(wrm.data.Date,"fromTimestamp",wrm.data.Date.fromTimestamp);
wrm.data.Date.fromDate=function(a){var b=a.getFullYear(),c=a.getMonth();a=a.getDate();return new wrm.data.Date(b,c,a)};exportProperty(wrm.data.Date,"fromDate",wrm.data.Date.fromDate);wrm.data.Time=function(a,b,c,d){this._date=new Date(1970,0,1,a,b,c||0,d||0)};exportSymbol("wrm.data.Time",wrm.data.Time);wrm.data.Time.prototype.getHours=function(){return this._date.getHours()};exportProperty(wrm.data.Time.prototype,"getHours",wrm.data.Time.prototype.getHours);wrm.data.Time.prototype.getMinutes=function(){return this._date.getMinutes()};exportProperty(wrm.data.Time.prototype,"getMinutes",wrm.data.Time.prototype.getMinutes);wrm.data.Time.prototype.getSeconds=function(){return this._date.getSeconds()};
exportProperty(wrm.data.Time.prototype,"getSeconds",wrm.data.Time.prototype.getSeconds);wrm.data.Time.prototype.getMilliseconds=function(){return this._date.getMilliseconds()};exportProperty(wrm.data.Time.prototype,"getMilliseconds",wrm.data.Time.prototype.getMilliseconds);wrm.data.Time.prototype.asDate=function(){return this._date};exportProperty(wrm.data.Time.prototype,"asDate",wrm.data.Time.prototype.asDate);
wrm.data.Time.prototype.compareTo=function(a){a instanceof wrm.data.Time||(a=wrm.data.toTime(a));return a===this?0:this._date.valueOf()-a._date.valueOf()};exportProperty(wrm.data.Time.prototype,"compareTo",wrm.data.Time.prototype.compareTo);wrm.data.Time.prototype.hashKey=function(){return String(this._date.valueOf())};exportProperty(wrm.data.Time.prototype,"hashKey",wrm.data.Time.prototype.hashKey);
wrm.data.Time.prototype.equals=function(a){return a instanceof wrm.data.Time?a===this?!0:this._date.valueOf()===a._date.valueOf():!1};exportProperty(wrm.data.Time.prototype,"equals",wrm.data.Time.prototype.equals);wrm.data.Time.prototype.getValueType=function(){return wrm.data.Type.TIME};exportProperty(wrm.data.Time.prototype,"getValueType",wrm.data.Time.prototype.getValueType);
wrm.data.Time.prototype.toString=function(){var a=("00"+this.getHours()).slice(-2),a=a+(":"+("00"+this.getMinutes()).slice(-2)),a=a+(":"+("00"+this.getSeconds()).slice(-2));return a+="."+("000"+this.getMilliseconds()).slice(-3)};exportProperty(wrm.data.Time.prototype,"toString",wrm.data.Time.prototype.toString);wrm.data.Time.prototype.toJSON=function(){return this.toString()};exportProperty(wrm.data.Time.prototype,"toJSON",wrm.data.Time.prototype.toJSON);
wrm.data.Time.fromString=function(a){var b=/^([0-9]|0[0-9]|1[0-9]|2[0-3]):([0-5][0-9]|[0-9])(?::([0-5][0-9]|[0-9])(?:\.(\d{3}))?)?$/.exec(a);if(!b)throw Error("Invalid time string: "+a);return new wrm.data.Time(Number(b[1]),Number(b[2]),Number(b[3]||"0"),Number(b[4]||"0"))};exportProperty(wrm.data.Time,"fromString",wrm.data.Time.fromString);
wrm.data.Time.fromTimestamp=function(a){a%=864E5;var b=Math.floor(a/36E5);a%=36E5;var c=Math.floor(a/6E4);a%=6E4;return new wrm.data.Time(b,c,Math.floor(a/1E3),a%1E3)};exportProperty(wrm.data.Time,"fromTimestamp",wrm.data.Time.fromTimestamp);wrm.data.Time.fromDate=function(a){var b=a.getHours(),c=a.getMinutes(),d=a.getSeconds();a=a.getMilliseconds();return new wrm.data.Time(b,c,d,a)};exportProperty(wrm.data.Time,"fromDate",wrm.data.Time.fromDate);wrm.data.Decimal=function(a){this._decimal=this._create(a)};exportSymbol("wrm.data.Decimal",wrm.data.Decimal);wrm.data.Decimal.prototype._create=function(a){return new Big(a)};wrm.data.Decimal.prototype.compareTo=function(a){a instanceof wrm.data.Decimal||(a=wrm.data.toDecimal(a));return a===this?0:this._doCompareTo(a)};exportProperty(wrm.data.Decimal.prototype,"compareTo",wrm.data.Decimal.prototype.compareTo);wrm.data.Decimal.prototype.hashKey=function(){return this.toString()};
exportProperty(wrm.data.Decimal.prototype,"hashKey",wrm.data.Decimal.prototype.hashKey);wrm.data.Decimal.prototype.equals=function(a){return a instanceof wrm.data.Decimal?a===this?!0:this._decimal.eq(a._decimal):!1};exportProperty(wrm.data.Decimal.prototype,"equals",wrm.data.Decimal.prototype.equals);wrm.data.Decimal.prototype.getValueType=function(){return wrm.data.Type.DECIMAL};exportProperty(wrm.data.Decimal.prototype,"getValueType",wrm.data.Decimal.prototype.getValueType);
wrm.data.Decimal.prototype.toString=function(){return this._decimal.toString()};exportProperty(wrm.data.Decimal.prototype,"toString",wrm.data.Decimal.prototype.toString);wrm.data.Decimal.prototype.toJSON=function(){return this.toString()};exportProperty(wrm.data.Decimal.prototype,"toJSON",wrm.data.Decimal.prototype.toJSON);wrm.data.Decimal.prototype.toExponential=function(a){return this._decimal.toExponential(a)};exportProperty(wrm.data.Decimal.prototype,"toExponential",wrm.data.Decimal.prototype.toExponential);
wrm.data.Decimal.prototype.toFixed=function(a){return this._decimal.toFixed(a)};exportProperty(wrm.data.Decimal.prototype,"toFixed",wrm.data.Decimal.prototype.toFixed);wrm.data.Decimal.prototype.toPrecision=function(a){return this._decimal.toPrecision(a)};exportProperty(wrm.data.Decimal.prototype,"toPrecision",wrm.data.Decimal.prototype.toPrecision);
wrm.data.Decimal.prototype.toNumber=function(){var a=this._decimal.toString(),b=Number(a);if(a===String(b))return b;throw Error("Decimal too large to be converted into number");};exportProperty(wrm.data.Decimal.prototype,"toNumber",wrm.data.Decimal.prototype.toNumber);wrm.data.Decimal.prototype.toLocaleString=function(a){a=a||{groupSeparator:"",decimalSeparator:"."};return this._computeLocalizedString(a.groupSeparator,a.decimalSeparator)};
exportProperty(wrm.data.Decimal.prototype,"toLocaleString",wrm.data.Decimal.prototype.toLocaleString);wrm.data.Decimal.prototype.abs=function(){return this._wrap(this._decimal.abs())};exportProperty(wrm.data.Decimal.prototype,"abs",wrm.data.Decimal.prototype.abs);wrm.data.Decimal.prototype.divide=function(a){return this._wrap(this._decimal.div(this._unwrap(a)))};exportProperty(wrm.data.Decimal.prototype,"divide",wrm.data.Decimal.prototype.divide);wrm.data.Decimal.prototype.minus=function(a){return this._wrap(this._decimal.minus(this._unwrap(a)))};
exportProperty(wrm.data.Decimal.prototype,"minus",wrm.data.Decimal.prototype.minus);wrm.data.Decimal.prototype.module=function(a){return this._wrap(this._decimal.mod(this._unwrap(a)))};exportProperty(wrm.data.Decimal.prototype,"module",wrm.data.Decimal.prototype.module);wrm.data.Decimal.prototype.plus=function(a){return this._wrap(this._decimal.plus(this._unwrap(a)))};exportProperty(wrm.data.Decimal.prototype,"plus",wrm.data.Decimal.prototype.plus);wrm.data.Decimal.prototype.power=function(a){return this._wrap(this._decimal.pow(a))};
exportProperty(wrm.data.Decimal.prototype,"power",wrm.data.Decimal.prototype.power);wrm.data.Decimal.prototype.round=function(a,b){return this._wrap(this._decimal.round(a,b))};exportProperty(wrm.data.Decimal.prototype,"round",wrm.data.Decimal.prototype.round);wrm.data.Decimal.prototype.square=function(){return this._wrap(this._decimal.sqrt())};exportProperty(wrm.data.Decimal.prototype,"square",wrm.data.Decimal.prototype.square);wrm.data.Decimal.prototype.times=function(a){return this._wrap(this._decimal.times(this._unwrap(a)))};
exportProperty(wrm.data.Decimal.prototype,"times",wrm.data.Decimal.prototype.times);wrm.data.Decimal.prototype.inverse=function(){return this._wrap(this._decimal.times(-1))};exportProperty(wrm.data.Decimal.prototype,"inverse",wrm.data.Decimal.prototype.inverse);wrm.data.Decimal.fromString=function(a){return new wrm.data.Decimal(a)};exportProperty(wrm.data.Decimal,"fromString",wrm.data.Decimal.fromString);wrm.data.Decimal.fromNumber=function(a){return new wrm.data.Decimal(a)};
exportProperty(wrm.data.Decimal,"fromNumber",wrm.data.Decimal.fromNumber);wrm.data.Decimal.prototype._wrap=function(a){return new wrm.data.Decimal(a)};wrm.data.Decimal.prototype._unwrap=function(a){return a instanceof wrm.data.Decimal?a._decimal:a};wrm.data.Decimal.prototype._doCompareTo=function(a){return this._decimal.cmp(this._unwrap(a))};
wrm.data.Decimal.prototype._computeLocalizedString=function(a,b){for(var c=1===this._decimal.s?!1:!0,d="",e=[],f=(c?this._decimal.toString().substring(1):this._decimal.toString()).split("."),g=f[0],f=f[1]||"",h=0,k=g.length;0<=k;k--)0===(d.length-h)%3&&0!==d.length&&(d+=a,h++),d+=g.charAt(k);d=d.split("").reverse().join("");""!==f&&(d+=b+f);e.push(c?"-":"",d);return e.join("")};wrm.data.Type={BLOB:"blob",BOOLEAN:"boolean",DATE:"date",DECIMAL:"decimal",FLOAT:"float",INTEGER:"integer",PASSWORD:"password",STRING:"string",TEXT:"text",TIME:"time",TIMESTAMP:"timestamp",URL:"url"};exportSymbol("wrm.data.Type",wrm.data.Type);wrm.data.Type._KIND_NUMERIC="N";wrm.data.Type._KIND_TEXTUAL="T";wrm.data.Type._TYPE_KINDS={};wrm.data.Type._TYPE_KINDS[wrm.data.Type.DECIMAL]=wrm.data.Type._KIND_NUMERIC;wrm.data.Type._TYPE_KINDS[wrm.data.Type.FLOAT]=wrm.data.Type._KIND_NUMERIC;
wrm.data.Type._TYPE_KINDS[wrm.data.Type.INTEGER]=wrm.data.Type._KIND_NUMERIC;wrm.data.Type._TYPE_KINDS[wrm.data.Type.PASSWORD]=wrm.data.Type._KIND_TEXTUAL;wrm.data.Type._TYPE_KINDS[wrm.data.Type.STRING]=wrm.data.Type._KIND_TEXTUAL;wrm.data.Type._TYPE_KINDS[wrm.data.Type.TEXT]=wrm.data.Type._KIND_TEXTUAL;wrm.data.Type._TYPE_KINDS[wrm.data.Type.URL]=wrm.data.Type._KIND_TEXTUAL;wrm.data.Type._TYPE_LOCALIZABLE={};wrm.data.Type._TYPE_LOCALIZABLE[wrm.data.Type.BOOLEAN]=!0;
wrm.data.Type._TYPE_LOCALIZABLE[wrm.data.Type.DATE]=!0;wrm.data.Type._TYPE_LOCALIZABLE[wrm.data.Type.DECIMAL]=!0;wrm.data.Type._TYPE_LOCALIZABLE[wrm.data.Type.FLOAT]=!0;wrm.data.Type._TYPE_LOCALIZABLE[wrm.data.Type.INTEGER]=!0;wrm.data.Type._TYPE_LOCALIZABLE[wrm.data.Type.TIME]=!0;wrm.data.Type._TYPE_LOCALIZABLE[wrm.data.Type.TIMESTAMP]=!0;wrm.data.Type.isNumeric=function(a){return wrm.data.Type._TYPE_KINDS[a]===wrm.data.Type._KIND_NUMERIC};exportProperty(wrm.data.Type,"isNumeric",wrm.data.Type.isNumeric);
wrm.data.Type.isTextual=function(a){return wrm.data.Type._TYPE_KINDS[a]===wrm.data.Type._KIND_TEXTUAL};exportProperty(wrm.data.Type,"isTextual",wrm.data.Type.isTextual);wrm.data.Type.isLocalizable=function(a){return!0===wrm.data.Type._TYPE_LOCALIZABLE[a]};exportProperty(wrm.data.Type,"isLocalizable",wrm.data.Type.isLocalizable);wrm.data.Converters={};
wrm.data.Converters[wrm.data.Type.BLOB]=wrm.data.Converters.BLOB_CONVERTER=function(a,b,c){if(a instanceof wrm.data.Blob)return a;if(a instanceof Blob)return wrm.data.Blob.fromBlob(a,c);if(a instanceof File)return wrm.data.Blob.fromFile(a,a.type,{fileName:a.name});if(a instanceof Uint8Array||a instanceof ArrayBuffer)return wrm.data.Blob.fromBytes(a,b,c);if("number"===typeof a.byteLength)return wrm.data.Blob.fromBytes(a,b,c);if("string"===typeof a&&0===a.indexOf(wrm.data.Converters._DATA_URI_SCHEME))return wrm.data.Blob.fromDataUri(a,c);
throw Error("Value not convertible to blob");};wrm.data.Converters._DATA_URI_SCHEME="data:";wrm.data.Converters[wrm.data.Type.DATE]=function(a){return a instanceof wrm.data.Date?a:a instanceof Date?wrm.data.Date.fromDate(a):"number"===typeof a?wrm.data.Date.fromTimestamp(a):wrm.data.Date.fromString(String(a))};wrm.data.Converters[wrm.data.Type.TIME]=function(a){return a instanceof wrm.data.Time?a:a instanceof Date?wrm.data.Time.fromDate(a):"number"===typeof a?wrm.data.Time.fromTimestamp(a):wrm.data.Time.fromString(String(a))};
wrm.data.Converters[wrm.data.Type.TIMESTAMP]=function(a){return a instanceof wrm.data.DateTime?a:a instanceof wrm.data.Date||a instanceof wrm.data.Time?wrm.data.DateTime.fromDate(a.asDate()):a instanceof Date?wrm.data.DateTime.fromDate(a):"number"===typeof a?wrm.data.DateTime.fromTimestamp(a):wrm.data.DateTime.fromString(String(a))};
wrm.data.Converters[wrm.data.Type.DECIMAL]=function(a){return a instanceof wrm.data.Decimal?a:"string"===typeof a?wrm.data.Decimal.fromString(a):"number"===typeof a?wrm.data.Decimal.fromNumber(a):wrm.data.Decimal.fromString(String(a))};wrm.data.Converters[wrm.data.Type.FLOAT]=function(a){return wrm.data.Converters._toNumber(a)};wrm.data.Converters[wrm.data.Type.INTEGER]=function(a){var b=wrm.data.Converters._toNumber(a);if(0!==b%1)throw Error("Not an integer number: "+a);return b};
wrm.data.Converters._toNumber=function(a){if(a instanceof wrm.data.Decimal)return a.toNumber();var b=Number(a);if(isNaN(b))throw Error("Not a number: "+a);if(16<=a.length&&a!==String(b))throw Error("Value too large to be converted into number: "+a);return b};wrm.data.Converters[wrm.data.Type.PASSWORD]=function(a){return wrm.data.Converters._toString(a)};wrm.data.Converters[wrm.data.Type.STRING]=function(a){return wrm.data.Converters._toString(a)};wrm.data.Converters[wrm.data.Type.TEXT]=function(a){return wrm.data.Converters._toString(a)};
wrm.data.Converters[wrm.data.Type.URL]=function(a){return wrm.data.Converters._toString(a)};wrm.data.Converters._toString=function(a){return String(a)};wrm.data.Converters[wrm.data.Type.BOOLEAN]=function(a){return!0===a||"true"===a?!0:a instanceof Boolean?!!a.valueOf():"number"===typeof a?0!==a:!1};wrm.data.setLateEvaluationEnabled=function(a){wrm.data.lateEvaluationEnabled=a};exportSymbol("wrm.data.setLateEvaluationEnabled",wrm.data.setLateEvaluationEnabled);wrm.data.lateEvaluationEnabled=!1;wrm.data.toBlob=function(a){return wrm.data._convertToValue(wrm.data.Type.BLOB,a)};exportSymbol("wrm.data.toBlob",wrm.data.toBlob);wrm.data.toBlobArray=function(a){return wrm.data._convertToArray(wrm.data.Type.BLOB,a)};exportSymbol("wrm.data.toBlobArray",wrm.data.toBlobArray);
wrm.data.toBoolean=function(a){return wrm.data._convertToValue(wrm.data.Type.BOOLEAN,a)};exportSymbol("wrm.data.toBoolean",wrm.data.toBoolean);wrm.data.toBooleanArray=function(a){return wrm.data._convertToArray(wrm.data.Type.BOOLEAN,a)};exportSymbol("wrm.data.toBooleanArray",wrm.data.toBooleanArray);wrm.data.toDate=function(a){return wrm.data._convertToValue(wrm.data.Type.DATE,a)};exportSymbol("wrm.data.toDate",wrm.data.toDate);
wrm.data.toDateArray=function(a){return wrm.data._convertToArray(wrm.data.Type.DATE,a)};exportSymbol("wrm.data.toDateArray",wrm.data.toDateArray);wrm.data.toDecimal=function(a){return wrm.data._convertToValue(wrm.data.Type.DECIMAL,a)};exportSymbol("wrm.data.toDecimal",wrm.data.toDecimal);wrm.data.toDecimalArray=function(a){return wrm.data._convertToArray(wrm.data.Type.DECIMAL,a)};exportSymbol("wrm.data.toDecimalArray",wrm.data.toDecimalArray);
wrm.data.toFloat=function(a){return wrm.data._convertToValue(wrm.data.Type.FLOAT,a)};exportSymbol("wrm.data.toFloat",wrm.data.toFloat);wrm.data.toFloatArray=function(a){return wrm.data._convertToArray(wrm.data.Type.FLOAT,a)};exportSymbol("wrm.data.toFloatArray",wrm.data.toFloatArray);wrm.data.toInteger=function(a){return wrm.data._convertToValue(wrm.data.Type.INTEGER,a)};exportSymbol("wrm.data.toInteger",wrm.data.toInteger);
wrm.data.toIntegerArray=function(a){return wrm.data._convertToArray(wrm.data.Type.INTEGER,a)};exportSymbol("wrm.data.toIntegerArray",wrm.data.toIntegerArray);wrm.data.toString=function(a){return wrm.data._convertToValue(wrm.data.Type.STRING,a)};exportSymbol("wrm.data.toString",wrm.data.toString);wrm.data.toStringArray=function(a){return wrm.data._convertToArray(wrm.data.Type.STRING,a)};exportSymbol("wrm.data.toStringArray",wrm.data.toStringArray);
wrm.data.toText=function(a){return wrm.data._convertToValue(wrm.data.Type.TEXT,a)};exportSymbol("wrm.data.toText",wrm.data.toText);wrm.data.toTextArray=function(a){return wrm.data._convertToArray(wrm.data.Type.TEXT,a)};exportSymbol("wrm.data.toTextArray",wrm.data.toTextArray);wrm.data.toTime=function(a){return wrm.data._convertToValue(wrm.data.Type.TIME,a)};exportSymbol("wrm.data.toTime",wrm.data.toTime);wrm.data.toTimeArray=function(a){return wrm.data._convertToArray(wrm.data.Type.TIME,a)};
exportSymbol("wrm.data.toTimeArray",wrm.data.toTimeArray);wrm.data.toTimestamp=function(a){return wrm.data._convertToValue(wrm.data.Type.TIMESTAMP,a)};exportSymbol("wrm.data.toTimestamp",wrm.data.toTimestamp);wrm.data.toTimestampArray=function(a){return wrm.data._convertToArray(wrm.data.Type.TIMESTAMP,a)};exportSymbol("wrm.data.toTimestampArray",wrm.data.toTimestampArray);wrm.data.toUrl=function(a){return wrm.data._convertToValue(wrm.data.Type.URL,a)};exportSymbol("wrm.data.toUrl",wrm.data.toUrl);
wrm.data.toUrlArray=function(a){return wrm.data._convertToArray(wrm.data.Type.URL,a)};exportSymbol("wrm.data.toUrlArray",wrm.data.toUrlArray);wrm.data.toSingle=function(a,b){return wrm.data._convertToValue(a,b)};exportSymbol("wrm.data.toSingle",wrm.data.toSingle);wrm.data.toArray=function(a,b){return wrm.data._convertToArray(a,b)};exportSymbol("wrm.data.toArray",wrm.data.toArray);wrm.data.toAnySingle=function(a){return wrm.data._convertToValue(null,a)};exportSymbol("wrm.data.toAnySingle",wrm.data.toAnySingle);
wrm.data.toAnyArray=function(a){return wrm.data._convertToArray(null,a)};exportSymbol("wrm.data.toAnyArray",wrm.data.toAnyArray);wrm.data._convertToValue=function(a,b){if(Array.isArray(b)){if(1<b.length)throw new TypeError("Input array contains more than one value");b=1===b.length?b[0]:void 0}return null===b||void 0===b?b:a?wrm.data.Type.isTextual(a)||""!==b?wrm.data._invokeConverter(wrm.data.Converters[a],b,a,-1):null:b};
wrm.data._convertToArray=function(a,b){b=Array.isArray(b)?b.slice(0):null!==b&&void 0!==b?[b]:[];if(a)for(var c=wrm.data.Converters[a],d=0;d<b.length;d++){var e=b[d];b[d]=null===e||void 0===e?e:wrm.data._invokeConverter(c,e,a,d)}return b};wrm.data._invokeConverter=function(a,b,c,d){try{return a(b)}catch(e){if(0<=d)throw new TypeError("Element at position "+d+" not convertible to "+c+": "+e.message);throw new TypeError("Value not convertible to "+c+": "+e.message);}};
wrm.data.compare=function(a,b){if(null!==a&&void 0!==a||null!==b&&void 0!==b){if(!(null===a&&void 0===a||null!==b&&void 0!==b))return 1;if(!(null!==a&&void 0!==a||null===b&&void 0===b))return-1}else return 0;if(a instanceof Object){if(implementsInterface(a,wrm.data.Comparable))return a.compareTo(b);a=wrm.data.toString(a);b=wrm.data.toString(b)}return"string"===typeof a?wrm.data._compare(a,wrm.data.toString(b)):"number"===typeof a?a-wrm.data.toFloat(b):wrm.data._compare(wrm.data.toString(a),wrm.data.toString(b))};
exportSymbol("wrm.data.compare",wrm.data.compare);wrm.data.equal=function(a,b){if(wrm.data._equals(a,b))return!0;if(!(null!==a&&null!==b||void 0!==a&&void 0!==b))return!1;if(a instanceof Object)return implementsInterface(a,wrm.data.TypedValue)?a.equals(wrm.data.toSingle(a.getValueType(),b)):!1;"string"===typeof a?b=wrm.data.toString(b):"number"===typeof a?b=wrm.data.toInteger(b):(a=wrm.data.toString(a),b=wrm.data.toString(b));return wrm.data._equals(a,b)};exportSymbol("wrm.data.equal",wrm.data.equal);
wrm.data._compare=function(a,b){return a<b?-1:a>b?1:0};wrm.data._equals=function(a,b){return a===b};wrm.data.AvailabilityStatus={FAILED:0,PENDING:1,AVAILABLE:2};exportSymbol("wrm.data.AvailabilityStatus",wrm.data.AvailabilityStatus);wrm.data.cloneObject=function(a){return JSON.parse(JSON.stringify(a))};wrm.data.sync={};wrm.data.sync.BackEndServerStore=function(a,b){this._entity=a;this._serverName=this._entity.getServerName();this._backEndService=b};wrm.data.sync.BackEndServerStore.prototype.getEntity=function(){return this._entity};wrm.data.sync.BackEndServerStore.prototype.isServerAvailable=function(){return this._backEndService.isAvailable()};wrm.data.sync.BackEndServerStore.prototype.isServerReadable=function(){return this._entity.isServerReadable()};
wrm.data.sync.BackEndServerStore.prototype.retrieveEntityData=function(a,b){return this._backEndService.retrieveEntityData(a,this._serverName,b)};wrm.data.sync.BackEndServerStore.prototype.retrieveEntityInstanceData=function(a,b){return this._backEndService.retrieveEntityInstanceData(a,this._serverName,b)};wrm.data.sync.BackEndServerStore.prototype.retrieveEntityKeys=function(a){return this._backEndService.retrieveEntityKeys(a,this._serverName)};
wrm.data.sync.BackEndServerStore.prototype.createEntityInstance=function(a,b){return this._backEndService.createEntityInstance(a,this._serverName,b)};wrm.data.sync.BackEndServerStore.prototype.updateEntityInstance=function(a,b,c){return this._backEndService.updateEntityInstance(a,this._serverName,b,c)};wrm.data.sync.BackEndServerStore.prototype.deleteEntityInstance=function(a,b){return this._backEndService.deleteEntityInstance(a,this._serverName,b)};wrm.data.sync.DataSyncError=makeCustomErrorConstructor("wrm.data.sync.DataSyncError",Error,function(a,b){this._reason=b||wrm.data.sync.DataSyncError.Reason.INTERNAL_ERROR});wrm.data.sync.DataSyncError.prototype.getReason=function(){return this._reason};wrm.data.sync.DataSyncError.Reason={LOGGED_OUT:"LOGGED_OUT",LOGGED_OUT_ACCESS_DENIED:"LOGGED_OUT_ACCESS_DENIED",NETWORK_ERROR:"NETWORK_ERROR",BACKEND_UNAVAILABLE:"BACKEND_UNAVAILABLE",FORBIDDEN:"FORBIDDEN",INTERNAL_ERROR:"INTERNAL_ERROR"};wrm.nav.Input=function(){};exportSymbol("wrm.nav.Input",wrm.nav.Input);wrm.nav.InputImpl=function(){};wrm.core.OperationContext=function(a,b){wrm.core.ComponentContext.call(this,a);this.clearPastNavigationsHistory=b.clearReachedPanelsHistory.bind(b)};extendConstructor(wrm.core.OperationContext,wrm.core.ComponentContext);exportSymbol("wrm.core.OperationContext",wrm.core.OperationContext);wrm.core.OperationContext.prototype.clearPastNavigationsHistory=function(){throw Error();};exportProperty(wrm.core.OperationContext.prototype,"clearPastNavigationsHistory",wrm.core.OperationContext.prototype.clearPastNavigationsHistory);wrm.core.ViewComponentContext=function(a,b,c){wrm.core.ComponentContext.call(this,a);this._view=b;this._markForViewTracking=c};extendConstructor(wrm.core.ViewComponentContext,wrm.core.ComponentContext);exportSymbol("wrm.core.ViewComponentContext",wrm.core.ViewComponentContext);wrm.core.ViewComponentContext.prototype.getView=function(){if(!this._view)throw Error("Component is not associated with any view");return this._view};exportProperty(wrm.core.ViewComponentContext.prototype,"getView",wrm.core.ViewComponentContext.prototype.getView);
wrm.core.ViewComponentContext.prototype.markForViewTracking=function(a,b){if(DEBUG&&"object"!==typeof a||!a)throw Error("View tracking works only on non-null objects");this._markForViewTracking(a,b)};exportProperty(wrm.core.ViewComponentContext.prototype,"markForViewTracking",wrm.core.ViewComponentContext.prototype.markForViewTracking);wrm.core.ViewComponentContext.prototype.getFormRefreshMode=function(){return this._formRefreshMode};
exportProperty(wrm.core.ViewComponentContext.prototype,"getFormRefreshMode",wrm.core.ViewComponentContext.prototype.getFormRefreshMode);wrm.core.ViewComponentContext.prototype.setFormRefreshMode=function(a){this._formRefreshMode=a};wrm.core.ViewComponentContext.prototype.isFreshInput=function(a){return!0===this._freshInputs[a]};exportProperty(wrm.core.ViewComponentContext.prototype,"isFreshInput",wrm.core.ViewComponentContext.prototype.isFreshInput);
wrm.core.ViewComponentContext.prototype.setFreshInputs=function(a){this._freshInputs={};for(var b=0;b<a.length;b++)this._freshInputs[a[b]]=!0};wrm.nav.State=function(a,b){this._id=(wrm.nav.State._next_id++).toString(26);this._contextualStartPrimaryPanelId=a;this._firstFlow=this._caughtEvent=this._startPanelId=this._contextualStartPanelId=null;this._flowHistory=[];this._chainPropagatedParams={};this._clearedPanelsHistory=!1;this._reachedFence=this._reachedPanelId=this._reachedPrimaryPanelId=this._mergedPrimaryPanelId=null;this._map={};this._savedMaps=[];this._environ=b};exportSymbol("wrm.nav.State",wrm.nav.State);wrm.nav.State._next_id=0;
wrm.nav.State.prototype.getContextualStartPrimaryPanelId=function(){return this._contextualStartPrimaryPanelId};exportProperty(wrm.nav.State.prototype,"getContextualStartPrimaryPanelId",wrm.nav.State.prototype.getContextualStartPrimaryPanelId);wrm.nav.State.prototype.getContextualStartPanelId=function(){return this._contextualStartPanelId};exportProperty(wrm.nav.State.prototype,"getContextualStartPanelId",wrm.nav.State.prototype.getContextualStartPanelId);wrm.nav.State.prototype.getStartPanelId=function(){return this._startPanelId};
exportProperty(wrm.nav.State.prototype,"getStartPanelId",wrm.nav.State.prototype.getStartPanelId);wrm.nav.State.prototype.getCaughtEvent=function(){return this._caughtEvent};exportProperty(wrm.nav.State.prototype,"getCaughtEvent",wrm.nav.State.prototype.getCaughtEvent);wrm.nav.State.prototype.getFirstFlow=function(){return this._firstFlow};exportProperty(wrm.nav.State.prototype,"getFirstFlow",wrm.nav.State.prototype.getFirstFlow);wrm.nav.State.prototype.getFlowHistory=function(){return this._flowHistory};
exportProperty(wrm.nav.State.prototype,"getFlowHistory",wrm.nav.State.prototype.getFlowHistory);wrm.nav.State.prototype.getChainPropagatedParams=function(a){return this._chainPropagatedParams[a]||{}};exportProperty(wrm.nav.State.prototype,"getChainPropagatedParams",wrm.nav.State.prototype.getChainPropagatedParams);wrm.nav.State.prototype.getMergedPrimaryPanelId=function(){return this._mergedPrimaryPanelId};exportProperty(wrm.nav.State.prototype,"getMergedPrimaryPanelId",wrm.nav.State.prototype.getMergedPrimaryPanelId);
wrm.nav.State.prototype.getReachedPrimaryPanelId=function(){return this._reachedPrimaryPanelId};exportProperty(wrm.nav.State.prototype,"getReachedPrimaryPanelId",wrm.nav.State.prototype.getReachedPrimaryPanelId);wrm.nav.State.prototype.getReachedPanelId=function(){return this._reachedPanelId};exportProperty(wrm.nav.State.prototype,"getReachedPanelId",wrm.nav.State.prototype.getReachedPanelId);wrm.nav.State.prototype.getReachedFence=function(){return this._reachedFence};
exportProperty(wrm.nav.State.prototype,"getReachedFence",wrm.nav.State.prototype.getReachedFence);wrm.nav.State.prototype.getComponentInputs=function(){return this._map};exportProperty(wrm.nav.State.prototype,"getComponentInputs",wrm.nav.State.prototype.getComponentInputs);wrm.nav.State.prototype.getComponentInput=function(a){var b=this._map[a];b||(this._map[a]=b=new wrm.nav.InputImpl);return b};exportProperty(wrm.nav.State.prototype,"getComponentInput",wrm.nav.State.prototype.getComponentInput);
wrm.nav.State.prototype.discardComponentInput=function(a){delete this._map[a]};wrm.nav.State.prototype.discardComponentInputs=function(){this._map={}};wrm.nav.State.prototype.getPassingData=function(){var a=this._map[wrm.core.PASSINGS_COMPONENT_ID];a||(this._map[wrm.core.PASSINGS_COMPONENT_ID]=a={});return a};exportProperty(wrm.nav.State.prototype,"getPassingData",wrm.nav.State.prototype.getPassingData);
wrm.nav.State.prototype.getComponentView=function(a){return this._environ.retrieveView(this._getContextualPrimaryPanelId(),a)};exportProperty(wrm.nav.State.prototype,"getComponentView",wrm.nav.State.prototype.getComponentView);wrm.nav.State.prototype.getComponentFormState=function(a){return this._environ.retrieveFormState(this._getContextualPrimaryPanelId(),a)};exportProperty(wrm.nav.State.prototype,"getComponentFormState",wrm.nav.State.prototype.getComponentFormState);
wrm.nav.State.prototype._getContextualPrimaryPanelId=function(){var a=this._reachedPrimaryPanelId||this._contextualStartPrimaryPanelId;if(!a)throw Error("The navigation has no primary panel in context");return a};wrm.nav.State.prototype.toString=function(){return"("+this._id+")"};exportProperty(wrm.nav.State.prototype,"toString",wrm.nav.State.prototype.toString);wrm.nav.State.prototype.createComponentContext=function(a){a=this.getComponentInput(a);return new wrm.core.ComponentContext(a)};
exportProperty(wrm.nav.State.prototype,"createComponentContext",wrm.nav.State.prototype.createComponentContext);wrm.nav.State.prototype.createViewComponentContext=function(a){var b=this.getComponentInput(a);a=this.getComponentView(a);var c=this._environ.markObjectForViewTracking.bind(this._environ);return new wrm.core.ViewComponentContext(b,a,c)};exportProperty(wrm.nav.State.prototype,"createViewComponentContext",wrm.nav.State.prototype.createViewComponentContext);
wrm.nav.State.prototype.createOperationContext=function(a){a=this.getComponentInput(a);return new wrm.core.OperationContext(a,this)};exportProperty(wrm.nav.State.prototype,"createOperationContext",wrm.nav.State.prototype.createOperationContext);
wrm.nav.State.prototype.catchEvent=function(a,b){if(this._caughtEvent)throw Error("The current navigation has already caught its starting event");a instanceof wrm.core.PanelService&&(this._contextualStartPanelId=a.getId(),this._startPanelId=a.getId());this._caughtEvent=b};exportProperty(wrm.nav.State.prototype,"catchEvent",wrm.nav.State.prototype.catchEvent);wrm.nav.State.prototype.stepAhead=function(a){this._pushFlowOnHistory(a.getId(),a)};exportProperty(wrm.nav.State.prototype,"stepAhead",wrm.nav.State.prototype.stepAhead);
wrm.nav.State.prototype.stepJustEvent=function(a){this._pushFlowOnHistory(a+".event")};exportProperty(wrm.nav.State.prototype,"stepJustEvent",wrm.nav.State.prototype.stepJustEvent);wrm.nav.State.prototype.stepImplicitly=function(){this._pushFlowOnHistory("impl")};exportProperty(wrm.nav.State.prototype,"stepImplicitly",wrm.nav.State.prototype.stepImplicitly);wrm.nav.State.prototype._pushFlowOnHistory=function(a,b){0<this._savedMaps.length||(0>=this._flowHistory.length&&b&&(this._firstFlow=b),this._flowHistory.push(a))};
wrm.nav.State.prototype.registerPropagation=function(a,b){if(!(this._reachedPanelId||0<this._savedMaps.length)){var c=this._chainPropagatedParams[a];c||(this._chainPropagatedParams[a]=c={});c[b]=!0}};exportProperty(wrm.nav.State.prototype,"registerPropagation",wrm.nav.State.prototype.registerPropagation);wrm.nav.State.prototype.clearReachedPanelsHistory=function(){if(this._reachedPrimaryPanelId)throw Error("Already reached a panel");this._clearedPanelsHistory=!0};
exportProperty(wrm.nav.State.prototype,"clearReachedPanelsHistory",wrm.nav.State.prototype.clearReachedPanelsHistory);wrm.nav.State.prototype.reachPanel=function(a,b,c){if(this._reachedPrimaryPanelId)throw Error("Already reached a panel");if(0<this._savedMaps.length)throw Error("Reaching a panel with unfinished islands");this._reachedPrimaryPanelId=a.getId();this._reachedPanelId=b.getId();this._reachedFence=b.getFence();return this._environ.enterPanel(a.getId(),c||this._clearedPanelsHistory,this)};
exportProperty(wrm.nav.State.prototype,"reachPanel",wrm.nav.State.prototype.reachPanel);wrm.nav.State.prototype.pushIsland=function(){this._savedMaps.push(this._map);this._map={}};exportProperty(wrm.nav.State.prototype,"pushIsland",wrm.nav.State.prototype.pushIsland);wrm.nav.State.prototype.popIsland=function(){if(0>=this._savedMaps.length)throw Error("Not inside an island");this._map=this._savedMaps.pop()};exportProperty(wrm.nav.State.prototype,"popIsland",wrm.nav.State.prototype.popIsland);
wrm.nav.State.prototype.dispatchEvent=function(a){try{this._environ.handleEvent(a)}catch(b){}};exportProperty(wrm.nav.State.prototype,"dispatchEvent",wrm.nav.State.prototype.dispatchEvent);wrm.nav.State.prototype.getEventNotifier=function(a,b){return this._environ.retrieveEventNotifier(a,b)};exportProperty(wrm.nav.State.prototype,"getEventNotifier",wrm.nav.State.prototype.getEventNotifier);
wrm.nav.State.prototype.mergeOnto=function(a){var b=this;if(!a._reachedPrimaryPanelId)throw Error("Base state not at a panel");if(this._mergedPrimaryPanelId)throw Error("Already merged onto another state");this._mergedPrimaryPanelId=a._reachedPrimaryPanelId;var c=this._map;angular.forEach(a._map,function(a,e){var f=c[e]||void 0;b._map[e]=angular.extend(new wrm.nav.InputImpl,a,f)});angular.forEach(c,function(a,c){b._map.hasOwnProperty(c)||(b._map[c]=angular.extend(new wrm.nav.InputImpl,a))})};
exportProperty(wrm.nav.State.prototype,"mergeOnto",wrm.nav.State.prototype.mergeOnto);wrm.nav.State.prototype.startTimerEvents=function(a,b){return this._environ.startTimerEvents(a,b)};exportProperty(wrm.nav.State.prototype,"startTimerEvents",wrm.nav.State.prototype.startTimerEvents);wrm.nav.State.prototype.stopTimerEvents=function(a){this._environ.stopTimerEvents(a)};exportProperty(wrm.nav.State.prototype,"stopTimerEvents",wrm.nav.State.prototype.stopTimerEvents);
wrm.nav.State.prototype.presentDialog=function(a){return this._environ.presentDialog(a)};exportProperty(wrm.nav.State.prototype,"presentDialog",wrm.nav.State.prototype.presentDialog);wrm.nav.State.prototype.reportProgress=function(a){return this._environ.reportProgress(a)};exportProperty(wrm.nav.State.prototype,"reportProgress",wrm.nav.State.prototype.reportProgress);
wrm.nav.State.prototype.createBranch=function(){var a=new wrm.nav.State(this._reachedPrimaryPanelId,this._environ);a._contextualStartPanelId=this._reachedPanelId;angular.forEach(this._map,function(b,c){a._map[c]=angular.extend(new wrm.nav.InputImpl,b)});return a};exportProperty(wrm.nav.State.prototype,"createBranch",wrm.nav.State.prototype.createBranch);wrm.nav.SystemValues={token:null,lastSynchronizationTimestamp:null,languageIsoCode:null,countryIsoCode:null};wrm.nav.SystemValueKey={TOKEN:"$$TOKEN$$",LAST_SYNCHRONIZATION_TIMESTAMP:"$$LAST_SYNCHRONIZATION_TIMESTAMP$$",LANGUAGE_ISO_CODE:"$$LANGUAGE_ISO_CODE$$",COUNTRY_ISO_CODE:"$$COUNTRY_ISO_CODE$$",CURRENT_TIMESTAMP:"$$CURRENT_TIMESTAMP$$",CURRENT_DATE:"$$CURRENT_DATE$$"};wrm.nav.newInternalState=function(){return new wrm.nav.State(null,new wrm.core.InternalEnviron)};
exportSymbol("wrm.nav.newInternalState",wrm.nav.newInternalState);wrm.data.sync.DataSyncUpdater=function(a,b,c,d,e,f){wrm.core.AbstractUpdateParticipant.call(this);this._currentVersion=a;this._dataSyncService=b;this._securityService=c;this._backEndService=d;this._l10nService=e;this._log=f};extendConstructor(wrm.data.sync.DataSyncUpdater,wrm.core.AbstractUpdateParticipant);wrm.data.sync.DataSyncUpdater.prototype.getRequiredParticipantIds=function(){return[wrm.data.DataService.UPDATE_ID,wrm.core.BackEndService.UPDATE_ID]};
wrm.data.sync.DataSyncUpdater.prototype.beginUpdate=function(a){var b=wrm.data.sync.DataSyncUpdater._ORIG_VERSION_SNAPSHOT_KEY,c=a.getStableSnapshot(),d=c.get(b);null===d?(d=this._currentVersion,c.set(b,String(d))):d=Number(d);b=this._currentVersion;c=d!==b;a.setInfo({updating:c,originalVersion:d,currentVersion:b,outboundEntities:[],inboundEntities:[],outboundCleared:!1,credentialsChanged:!1,userEntityChanged:!1});c&&this._switchCurrentVersion(d)};
wrm.data.sync.DataSyncUpdater.prototype.prepareForExtensionUpdate=function(a){var b=this,c=this._dataSyncService,d=this._log,e=a.getInfo(),f=a.getInfo(wrm.data.DataService.UPDATE_ID),g;g=f.isUpdating()?this._collectOriginalEntitiesWithOutboundChanges(f).then(function(a){Array.prototype.push.apply(e.outboundEntities,a);Array.prototype.push.apply(e.inboundEntities,b._collectAddedAndChangedCurrentEntities(f));e.inboundEntities.forEach(function(a){a.getId()===wrm.Constants.USER_ENT_ID&&(e.userEntityChanged=
!0)},this)}):Promise.resolve();g=g.then(function(){return 0<e.outboundEntities.length||0<e.inboundEntities.length?b._ensureSynchronizationAvailability(a).then(function(a){return a}):!0});g=g.then(function(a){return e.outboundCleared?c.clearOutgoingChanges().then(function(){return a}):a});return g.then(function(a){if(a&&0<e.outboundEntities.length)return d.debug("Will synchronize now outbound changes found in",e.outboundEntities),c.synchronize({entities:e.outboundEntities,inbound:!1,outbound:!0},wrm.nav.newInternalState()).then(function(a){if(a)throw Error("The synchronization requires user actino");
})})};wrm.data.sync.DataSyncUpdater.prototype.performReductionUpdate=function(a){a=a.getInfo();a.updating&&this._switchCurrentVersion(a.currentVersion);0<a.inboundEntities.length&&(this._log.debug("Will re-synchronize next time all data of",a.inboundEntities),a.inboundEntities.forEach(function(a){this._dataSyncService.clearLastSynchronizationDateTime(a)},this))};
wrm.data.sync.DataSyncUpdater.prototype.finishUpdate=function(a){var b=wrm.data.sync.DataSyncUpdater._ORIG_VERSION_SNAPSHOT_KEY,c=this._securityService,d=this._log,e=a.getState(),f=a.getInfo();f.updating&&a.getStableSnapshot().set(b,String(f.currentVersion));var g=f.updating||0<f.outboundEntities.length||0<f.inboundEntities.length;return f.credentialsChanged||f.userEntityChanged?c.accessAgain(!1,e).then(function(a){a&&d.debug("Post-update access requires user action");return g},function(a){d.error("Post-update access failed",
a)}):g};wrm.data.sync.DataSyncUpdater.prototype._collectOriginalEntitiesWithOutboundChanges=function(a){var b=this._dataSyncService,c=[];return a.getOriginalMetadata().getEntities().filter(function(a){return this._dataSyncService.hasServerStore(a)},this).reduce(function(a,e){return a.then(function(){return b.hasOutboundChanges(e)}).then(function(a){a&&c.push(e)})},Promise.resolve()).then(function(){return c})};
wrm.data.sync.DataSyncUpdater.prototype._collectAddedAndChangedCurrentEntities=function(a){var b=a.getExtendedMetadataDiff(),c=[],c=c.concat(b.getAddedEntities()),c=c.concat(b.getChangedEntities()),d=a.getCurrentMetadata();return c.map(function(a){return d.getEntity(a.getId())}).filter(function(a){return this._dataSyncService.hasServerStore(a)},this)};
wrm.data.sync.DataSyncUpdater.prototype._switchCurrentVersion=function(a){this._log.debug("Now using synchronization version",a);this._currentVersion=a};wrm.data.sync.DataSyncUpdater._ORIG_VERSION_SNAPSHOT_KEY="version";wrm.data.sync.DataSyncUpdater.prototype._ensureSynchronizationAvailability=function(a){var b=this;return this._ensureBackEndReachability(a).then(function(c){return c?b._ensureTokenAvailability(a):!1})};
wrm.data.sync.DataSyncUpdater.prototype._ensureBackEndReachability=function(a){var b=this,c=this._log;if(this._backEndService.isReachable())return Promise.resolve(!0);c.debug("Back-end not reachable: prompting the user for network availability");return this._presentNetworkConfirmationDialog(a.getState()).then(function(c){if(c)return b._ensureBackEndReachability(a);a.cancel();return!1})};
wrm.data.sync.DataSyncUpdater.prototype._presentNetworkConfirmationDialog=function(a){var b=this._l10nService,c=b.formatMessage("update.networkDialog.message"),b=new wrm.nav.Dialog(c,wrm.nav.Dialog.Flavor.NEGATIVE,[{label:b.formatMessage("dialog.button.Retry"),value:0},{label:b.formatMessage("dialog.button.Exit"),value:1,"default":!0}]);return a.presentDialog(b).then(function(a){return 0===a.value})};
wrm.data.sync.DataSyncUpdater.prototype._ensureTokenAvailability=function(a){var b=this,c=this._securityService,d=this._log,e,f;return c.areAuthCredentialsComplete().then(function(a){e=a;return c.retrieveAuthUsername().then(function(a){f=a})}).then(function(){if(!e&&!f)return d.debug("Creadentials are not present"),!1;var g=f;if(e)return c.renewToken().then(function(){d.debug("Credentials are valid");return!0},function(c){if(!(c instanceof wrm.core.AuthenticationError))throw c;d.debug("Credentials are invalid: prompting the user for them");
return b._stabilizeCredentials(g,a).then(function(c){return c?b._ensureTokenAvailability(a):!1})});d.debug("Credentials are incomplete: prompting the user for them");return b._stabilizeCredentials(g,a).then(function(c){return c?b._ensureTokenAvailability(a):!1})})};
wrm.data.sync.DataSyncUpdater.prototype._stabilizeCredentials=function(a,b){var c=this._securityService,d=this,e=b.getState(),f=b.getInfo();return this._presentLoginDialog(a,e).then(function(a){return a?null===a.username&&null===a.password?Promise.resolve(0>=f.outboundEntities.length||d._presentResetConfirmationDialog(e)).then(function(a){return a?c.clearUser(!0).then(function(){f.outboundEntities=[];return f.outboundCleared=!0}):!0}):c.setAuthCredentials(a.username||"",a.password||"").then(function(){return f.credentialsChanged=
!0}):(b.cancel(),!1)})};
wrm.data.sync.DataSyncUpdater.prototype._presentLoginDialog=function(a,b){var c=this._l10nService,d=c.formatMessage("update.loginDialog.message");a=new wrm.nav.LoginDialog(d,a,!0,[{label:c.formatMessage("dialog.button.OK"),value:0},{label:c.formatMessage("dialog.button.Reset"),value:1},{label:c.formatMessage("dialog.button.Exit"),value:2,"default":!0}]);return b.presentDialog(a).then(function(a){switch(a.value){case 0:return{username:a.data.username,password:a.data.password};case 1:return{username:null,
password:null};default:return null}})};wrm.data.sync.DataSyncUpdater.prototype._presentResetConfirmationDialog=function(a){var b=this._l10nService,c=b.formatMessage("update.resetDialog.message"),b=new wrm.nav.Dialog(c,wrm.nav.Dialog.Flavor.CAUTIONAL,[{label:b.formatMessage("dialog.button.Reset"),value:0},{label:b.formatMessage("dialog.button.Cancel"),value:1,"default":!0}]);return a.presentDialog(b).then(function(a){return 0===a.value})};wrm.data.ChangeListener=function(){};exportSymbol("wrm.data.ChangeListener",wrm.data.ChangeListener);wrm.data.ChangeListener.prototype.getEntityListener=ABSTRACT_METHOD;exportProperty(wrm.data.ChangeListener.prototype,"getEntityListener",wrm.data.ChangeListener.prototype.getEntityListener);wrm.data.ChangeListener.prototype.getAssociationListener=ABSTRACT_METHOD;exportProperty(wrm.data.ChangeListener.prototype,"getAssociationListener",wrm.data.ChangeListener.prototype.getAssociationListener);wrm.data.XDChangeTrackerAdapter=function(){};wrm.data.XDChangeTrackerAdapter.prototype.afterInsert=function(a){};wrm.data.XDChangeTrackerAdapter.prototype.afterUpdate=function(a,b){};wrm.data.XDChangeTrackerAdapter.prototype.afterDelete=function(a){};wrm.data.sync.BlobCache=function(a){this._cache={};this._dataRunner=a};wrm.data.sync.BlobCache.prototype.retrieve=function(a){var b=this._cache[a];return b?this._dataRunner.execute(function(a){return a.selectOne(b.entity.getId(),{output:b.attr.getId(),outputConfig:{useNames:!0},filter:b.entity.getKeyAttribute().getId()},[b.key])}):Promise.resolve(null)};
wrm.data.sync.BlobCache.prototype.register=function(a,b){var c=a.getKeyAttribute();if(c=c&&b[c.getName()])if(b=this._extractCachableBlobAttribute(a,b),!(0>b.length))for(var d=0;d<b.length;d++){var e=b[d];this._cache[e.serverFileId]={entity:a,attr:e.attr,key:c}}};wrm.data.sync.BlobCache.prototype.unregister=function(a,b){a=this._extractCachableBlobAttribute(a,b);if(!(0>a.length)){var c=this._cache;return a.forEach(function(a){delete c[a.serverFileId]})}};
wrm.data.sync.BlobCache.prototype._extractCachableBlobAttribute=function(a,b){var c=[];a.getAttributes().forEach(function(a){if(a.getType()===wrm.data.Type.BLOB){var e=a.getMetaAttribute("serverFileId");(e=e&&b[e.getName()])&&c.push({serverFileId:e,attr:a})}});return c};wrm.data.sync.BlobCache.prototype.clear=function(){this._cache={}};wrm.data.sync.BlobCache.prototype.createChangeListener=function(){return new wrm.data.sync.BlobCache._ChangeListener(this)};
wrm.data.sync.BlobCache._ChangeListener=function(a){this._blobCache=a};wrm.data.sync.BlobCache._ChangeListener.prototype.getEntityListener=function(a){return new wrm.data.sync.BlobCache._ChangeListener.BlobChangeListener(a,this._blobCache)};wrm.data.sync.BlobCache._ChangeListener.prototype.getAssociationListener=function(a){return null};
wrm.data.sync.BlobCache._ChangeListener.BlobChangeListener=function(a,b){this._entity=a;this._blobCache=b;this.tracked=[a.getKeyAttribute().getName()];a.getServerKeyAttribute()&&this.tracked.push(a.getServerKeyAttribute().getName());this.trackedOld=[a.getKeyAttribute().getName()];a.getServerKeyAttribute()&&this.trackedOld.push(a.getServerKeyAttribute().getName())};wrm.data.sync.BlobCache._ChangeListener.BlobChangeListener.prototype.afterInsert=function(a){this._blobCache.register(this._entity,a)};
wrm.data.sync.BlobCache._ChangeListener.BlobChangeListener.prototype.afterUpdate=function(a,b){this._blobCache.register(this._entity,b)};wrm.data.sync.BlobCache._ChangeListener.BlobChangeListener.prototype.afterDelete=function(a){};wrm.data.meta={};wrm.data.meta.MigrationWay={LEAVING:-1,STAYING:0,ARRIVING:1};exportSymbol("wrm.data.meta.MigrationWay",wrm.data.meta.MigrationWay);wrm.data.meta.Element=function(a,b,c){this._id=a;this._name=b.name;this._serverName=b.serverName||null;this._serverReadable=!!b.serverName&&!1!==b.serverReadable;a=this._createMigrationInfo(b);this._migrationWay=a.way;this._migrationTempId=a.tempId;this._metadata=c;this._descr=b};exportSymbol("wrm.data.meta.Element",wrm.data.meta.Element);
wrm.data.meta.Element.prototype._createMigrationInfo=function(a){var b=a.migrationWay?wrm.util.obj.castEnumValue(wrm.data.meta.MigrationWay,a.migrationWay):wrm.data.meta.MigrationWay.STAYING;a=a.migrationTempId||null;if(b!==wrm.data.meta.MigrationWay.STAYING){if(!a)throw Error("Missing migration id for non-staying element");}else if(a)throw Error("Unexpected migration id for staying element");return{way:b,tempId:a}};
wrm.data.meta.Element.prototype.init=function(){this._descr&&(this.doInit(this._descr),this._descr=null)};exportProperty(wrm.data.meta.Element.prototype,"init",wrm.data.meta.Element.prototype.init);wrm.data.meta.Element.prototype.doInit=function(a){};exportProperty(wrm.data.meta.Element.prototype,"doInit",wrm.data.meta.Element.prototype.doInit);wrm.data.meta.Element.prototype.getId=function(){return this._id};exportProperty(wrm.data.meta.Element.prototype,"getId",wrm.data.meta.Element.prototype.getId);
wrm.data.meta.Element.prototype.getName=function(){return this._name};exportProperty(wrm.data.meta.Element.prototype,"getName",wrm.data.meta.Element.prototype.getName);wrm.data.meta.Element.prototype.getServerName=function(){return this._serverName};exportProperty(wrm.data.meta.Element.prototype,"getServerName",wrm.data.meta.Element.prototype.getServerName);wrm.data.meta.Element.prototype.isServerReadable=function(){return this._serverReadable};
exportProperty(wrm.data.meta.Element.prototype,"isServerReadable",wrm.data.meta.Element.prototype.isServerReadable);wrm.data.meta.Element.prototype.getMigrationWay=function(){return this._migrationWay};exportProperty(wrm.data.meta.Element.prototype,"getMigrationWay",wrm.data.meta.Element.prototype.getMigrationWay);wrm.data.meta.Element.prototype.getMigrationTempId=function(){return this._migrationTempId};exportProperty(wrm.data.meta.Element.prototype,"getMigrationTempId",wrm.data.meta.Element.prototype.getMigrationTempId);
wrm.data.meta.Element.prototype.getMetadata=function(){return this._metadata};wrm.data.meta.Element.prototype.toString=function(){return this.getName()+" ("+this.getId()+")"};exportProperty(wrm.data.meta.Element.prototype,"toString",wrm.data.meta.Element.prototype.toString);wrm.data.meta.Property=function(a,b,c,d){wrm.data.meta.Element.call(this,a,b,d);this._entity=c};extendConstructor(wrm.data.meta.Property,wrm.data.meta.Element);exportSymbol("wrm.data.meta.Property",wrm.data.meta.Property);wrm.data.meta.Property.prototype.getEntity=function(){return this._entity};exportProperty(wrm.data.meta.Property.prototype,"getEntity",wrm.data.meta.Property.prototype.getEntity);wrm.data.meta.Attribute=function(a,b,c,d){wrm.data.meta.Property.call(this,a,b,c,d);this._type=wrm.util.obj.castEnumValue(wrm.data.Type,b.type);this._key=b.key||!1;this._serverKey=b.serverKey||!1;this._indexed=b.indexed||!1;this._onFileSystem=b.onFileSystem||!1};extendConstructor(wrm.data.meta.Attribute,wrm.data.meta.Property);exportSymbol("wrm.data.meta.Attribute",wrm.data.meta.Attribute);wrm.data.meta.Attribute.prototype.getType=function(){return this._type};
exportProperty(wrm.data.meta.Attribute.prototype,"getType",wrm.data.meta.Attribute.prototype.getType);wrm.data.meta.Attribute.prototype.isKey=function(){return this._key};exportProperty(wrm.data.meta.Attribute.prototype,"isKey",wrm.data.meta.Attribute.prototype.isKey);wrm.data.meta.Attribute.prototype.isServerKey=function(){return this._serverKey};exportProperty(wrm.data.meta.Attribute.prototype,"isServerKey",wrm.data.meta.Attribute.prototype.isServerKey);
wrm.data.meta.Attribute.prototype.isIndexed=function(){return this._indexed};exportProperty(wrm.data.meta.Attribute.prototype,"isIndexed",wrm.data.meta.Attribute.prototype.isIndexed);wrm.data.meta.Attribute.prototype.isOnFileSystem=function(){return this._onFileSystem};exportProperty(wrm.data.meta.Attribute.prototype,"isOnFileSystem",wrm.data.meta.Attribute.prototype.isOnFileSystem);wrm.data.meta.MetaAttribute=function(a,b,c,d){wrm.data.meta.Attribute.call(this,a,b,c,d);this._newId=b.newId;c.registerAttribute(this)};extendConstructor(wrm.data.meta.MetaAttribute,wrm.data.meta.Attribute);exportSymbol("wrm.data.meta.MetaAttribute",wrm.data.meta.MetaAttribute);wrm.data.meta.MetaAttribute.prototype.getNewId=function(){return this._newId};wrm.data.meta.AuxAttribute=function(a,b,c,d,e){wrm.data.meta.Attribute.call(this,a,b,c,e);c.registerAttribute(this,!0,d)};extendConstructor(wrm.data.meta.AuxAttribute,wrm.data.meta.Attribute);exportSymbol("wrm.data.meta.AuxAttribute",wrm.data.meta.AuxAttribute);wrm.data.meta.RegularAttribute=function(a,b,c,d,e){wrm.data.meta.Attribute.call(this,a,b,c,e);this._createTimestamp=b.createTS||!1;this._updateTimestamp=b.updateTS||!1;this._trackerAttribute=this._createTrackerAttribute(b.trackerName||null,d);this._dirtyAttribute=this._createDirtyAttribute(b.dirtyName||null,d);this._metaAttributes=this._createMetaAttributes(b.meta||{},c);c.registerAttribute(this)};extendConstructor(wrm.data.meta.RegularAttribute,wrm.data.meta.Attribute);
exportSymbol("wrm.data.meta.RegularAttribute",wrm.data.meta.RegularAttribute);wrm.data.meta.RegularAttribute.prototype._createTrackerAttribute=function(a,b){if(!a)return null;if(!b)throw Error("No auxiliary entity available for attribute "+this);var c="_track_"+this.getId(),d={};d.name=a;d.type=this.getType();return new wrm.data.meta.AuxAttribute(c,d,b,!1,this.getMetadata())};
wrm.data.meta.RegularAttribute.prototype._createDirtyAttribute=function(a,b){if(!a)return null;if(!b)throw Error("No auxiliary entity available for attribute "+this);var c="_dirty_"+this.getId(),d={};d.name=a;d.type=wrm.data.Type.BOOLEAN;return new wrm.data.meta.AuxAttribute(c,d,b,!1,this.getMetadata())};
wrm.data.meta.RegularAttribute.prototype._createMetaAttributes=function(a,b){var c={},d=this.getId(),e=this.getMetadata();Object.keys(a).forEach(function(f){var g=a[f],h="_meta_"+f+"_"+d,k={};k.name=g.name;k.type=g.type;k.newId=d+"#"+f.replace(/^serverFileId$/,"remoteFileId");c[f]=new wrm.data.meta.MetaAttribute(h,k,b,e)});return c};wrm.data.meta.RegularAttribute.prototype.isCreateTimestamp=function(){return this._createTimestamp};
exportProperty(wrm.data.meta.RegularAttribute.prototype,"isCreateTimestamp",wrm.data.meta.RegularAttribute.prototype.isCreateTimestamp);wrm.data.meta.RegularAttribute.prototype.isUpdateTimestamp=function(){return this._updateTimestamp};exportProperty(wrm.data.meta.RegularAttribute.prototype,"isUpdateTimestamp",wrm.data.meta.RegularAttribute.prototype.isUpdateTimestamp);wrm.data.meta.RegularAttribute.prototype.getTrackerAuxiliaryAttribute=function(){return this._trackerAttribute};
exportProperty(wrm.data.meta.RegularAttribute.prototype,"getTrackerAuxiliaryAttribute",wrm.data.meta.RegularAttribute.prototype.getTrackerAuxiliaryAttribute);wrm.data.meta.RegularAttribute.prototype.getDirtyAuxiliaryAttribute=function(){return this._dirtyAttribute};exportProperty(wrm.data.meta.RegularAttribute.prototype,"getDirtyAuxiliaryAttribute",wrm.data.meta.RegularAttribute.prototype.getDirtyAuxiliaryAttribute);
wrm.data.meta.RegularAttribute.prototype.getMetaAttribute=function(a){return this._metaAttributes[a]||null};exportProperty(wrm.data.meta.RegularAttribute.prototype,"getMetaAttribute",wrm.data.meta.RegularAttribute.prototype.getMetaAttribute);wrm.data.meta.Role=function(a,b,c,d){wrm.data.meta.Property.call(this,a,b,c,d);this._many=this._createCardinalityMany(b);this._inverseRoleId=b.inverse;this._inverseRole=null;this._foreignKeyName=b.foreignKeyName||null};extendConstructor(wrm.data.meta.Role,wrm.data.meta.Property);exportSymbol("wrm.data.meta.Role",wrm.data.meta.Role);wrm.data.meta.Role.prototype._createCardinalityMany=function(a){var b=a.many;return"boolean"===typeof b?b:!a.foreignKeyName};
wrm.data.meta.Role.prototype.initAssociation=function(a){if(this._assoc)throw Error("Association already initialized");this._assoc=a};wrm.data.meta.Role.prototype.initInverseRole=function(a){if(this._inverseRole)throw Error("Inverse role already initialized");if(a._inverseRole)throw Error("Inverse role already initialized on the inverse being set");this._inverseRole=a;a._inverseRole=this};wrm.data.meta.Role.prototype.isMany=function(){return this._many};
exportProperty(wrm.data.meta.Role.prototype,"isMany",wrm.data.meta.Role.prototype.isMany);wrm.data.meta.Role.prototype.getAssociation=function(){return this._assoc};exportProperty(wrm.data.meta.Role.prototype,"getAssociation",wrm.data.meta.Role.prototype.getAssociation);wrm.data.meta.Role.prototype.getInverseRole=function(){var a=this._inverseRole;a||(this._inverseRole=a=this.getMetadata().getRole(this._inverseRoleId));return a};exportProperty(wrm.data.meta.Role.prototype,"getInverseRole",wrm.data.meta.Role.prototype.getInverseRole);
wrm.data.meta.Role.prototype.getInverseEntity=function(){return this.getInverseRole().getEntity()};exportProperty(wrm.data.meta.Role.prototype,"getInverseEntity",wrm.data.meta.Role.prototype.getInverseEntity);wrm.data.meta.Role.prototype.isForeignKey=function(){return!!this._foreignKeyName};exportProperty(wrm.data.meta.Role.prototype,"isForeignKey",wrm.data.meta.Role.prototype.isForeignKey);wrm.data.meta.Role.prototype.getForeignKeyName=function(){return this._foreignKeyName};
exportProperty(wrm.data.meta.Role.prototype,"getForeignKeyName",wrm.data.meta.Role.prototype.getForeignKeyName);wrm.data.meta.AuxRole=function(a,b,c,d,e){wrm.data.meta.Role.call(this,a,b,c,e);c.registerRole(this,!0,d)};extendConstructor(wrm.data.meta.AuxRole,wrm.data.meta.Role);exportSymbol("wrm.data.meta.AuxRole",wrm.data.meta.AuxRole);wrm.data.meta.RegularRole=function(a,b,c,d,e){wrm.data.meta.Role.call(this,a,b,c,e);this._auxEntity=d;this._addTimestampAttriubte=this._createAddTimestampAttribute(b.addTimestampName||null,d);this._removeTimestampAttriubte=this._createRemoveTimestampAttribute(b.removeTimestampName||null,d);this._bridgeHeadRole=this._createBridgeHeadRole(b.bridgeHeadRole||null);c.registerRole(this)};extendConstructor(wrm.data.meta.RegularRole,wrm.data.meta.Role);exportSymbol("wrm.data.meta.RegularRole",wrm.data.meta.RegularRole);
wrm.data.meta.RegularRole.prototype._createServerTrackerAttribute=function(a,b){if(!a)return null;if(!b)throw Error("No auxiliary entity available for role "+this);var c="_track_"+this.getId(),d={};d.name=a;d.type=this.getInverseEntity().getServerKeyAttribute().getType();return new wrm.data.meta.AuxAttribute(c,d,b,!1,this.getMetadata())};
wrm.data.meta.RegularRole.prototype._createAddTimestampAttribute=function(a,b){if(!a)return null;if(!b)throw Error("No auxiliary entity available for role "+this);var c="_addts_"+this.getId(),d={};d.name=a;d.type=wrm.data.Type.TIMESTAMP;return new wrm.data.meta.AuxAttribute(c,d,b,!1,this.getMetadata())};
wrm.data.meta.RegularRole.prototype._createRemoveTimestampAttribute=function(a,b){if(!a)return null;if(!b)throw Error("No auxiliary entity available for role "+this);var c="_remts_"+this.getId(),d={};d.name=a;d.type=wrm.data.Type.TIMESTAMP;return new wrm.data.meta.AuxAttribute(c,d,b,!1,this.getMetadata())};wrm.data.meta.RegularRole.prototype._createBridgeHeadRole=function(a){return a?new wrm.data.meta.AuxRole("_brdgh_"+this.getId(),a,this.getEntity(),!0,this.getMetadata()):null};
wrm.data.meta.RegularRole.prototype.doInit=function(a){wrm.data.meta.RegularRole._super.doInit.call(this,a);this._serverTrackerAttriubte=this._createServerTrackerAttribute(a.serverTrackerName||null,this._auxEntity)};exportProperty(wrm.data.meta.RegularRole.prototype,"doInit",wrm.data.meta.RegularRole.prototype.doInit);wrm.data.meta.RegularRole.prototype.getAddTimestampAuxiliaryAttribute=function(){return this._addTimestampAttriubte};
exportProperty(wrm.data.meta.RegularRole.prototype,"getAddTimestampAuxiliaryAttribute",wrm.data.meta.RegularRole.prototype.getAddTimestampAuxiliaryAttribute);wrm.data.meta.RegularRole.prototype.getRemoveTimestampAuxiliaryAttribute=function(){return this._removeTimestampAttriubte};exportProperty(wrm.data.meta.RegularRole.prototype,"getRemoveTimestampAuxiliaryAttribute",wrm.data.meta.RegularRole.prototype.getRemoveTimestampAuxiliaryAttribute);
wrm.data.meta.RegularRole.prototype.getServerTrackerAuxiliaryAttribute=function(){return this._serverTrackerAttriubte};exportProperty(wrm.data.meta.RegularRole.prototype,"getServerTrackerAuxiliaryAttribute",wrm.data.meta.RegularRole.prototype.getServerTrackerAuxiliaryAttribute);wrm.data.meta.RegularRole.prototype.getBridgeHeadRole=function(){return this._bridgeHeadRole};exportProperty(wrm.data.meta.RegularRole.prototype,"getBridgeHeadRole",wrm.data.meta.RegularRole.prototype.getBridgeHeadRole);wrm.data.meta.Entity=function(a,b,c){wrm.data.meta.Element.call(this,a,b,c);this._setName=b.setName;this._attributesById={};this._serverKeyAttribute=this._keyAttribute=this._attributesList=null;this._metaAttributesById={};this._rolesById={};this._assocs=this._rolesList=null;this._foreignKeyRoles=[]};extendConstructor(wrm.data.meta.Entity,wrm.data.meta.Element);exportSymbol("wrm.data.meta.Entity",wrm.data.meta.Entity);
wrm.data.meta.Entity.prototype.createAttributes=function(a,b){var c=this.getMetadata();angular.forEach(a,function(a,e){new wrm.data.meta.RegularAttribute(e,a,this,b||null,c)},this)};exportProperty(wrm.data.meta.Entity.prototype,"createAttributes",wrm.data.meta.Entity.prototype.createAttributes);wrm.data.meta.Entity.prototype.createRoles=function(a,b){var c=this.getMetadata();angular.forEach(a,function(a,e){new wrm.data.meta.RegularRole(e,a,this,b||null,c)},this)};
exportProperty(wrm.data.meta.Entity.prototype,"createRoles",wrm.data.meta.Entity.prototype.createRoles);wrm.data.meta.Entity.prototype.doInit=function(a){wrm.data.meta.Entity._super.doInit.call(this,a);this.getProperties().forEach(function(a){a.init()})};exportProperty(wrm.data.meta.Entity.prototype,"doInit",wrm.data.meta.Entity.prototype.doInit);wrm.data.meta.Entity.prototype.getSetName=function(){return this._setName};exportProperty(wrm.data.meta.Entity.prototype,"getSetName",wrm.data.meta.Entity.prototype.getSetName);
wrm.data.meta.Entity.prototype.getProperties=function(){return this.getAttributes().concat(this.getRoles())};exportProperty(wrm.data.meta.Entity.prototype,"getProperties",wrm.data.meta.Entity.prototype.getProperties);wrm.data.meta.Entity.prototype.getProperty=function(a,b){var c=this._attributesById[a]||this._rolesById[a];!c&&b&&(c=this._metaAttributesById[a]);if(!c)throw Error("Unknown property '"+a+"' in entity "+this);return c};exportProperty(wrm.data.meta.Entity.prototype,"getProperty",wrm.data.meta.Entity.prototype.getProperty);
wrm.data.meta.Entity.prototype.getAttributes=function(){this._attributesList||(this._attributesList=Object.keys(this._attributesById).map(function(a){return this._attributesById[a]},this));return this._attributesList};exportProperty(wrm.data.meta.Entity.prototype,"getAttributes",wrm.data.meta.Entity.prototype.getAttributes);wrm.data.meta.Entity.prototype.getMetaAttributes=function(a){var b=[];angular.forEach(this._metaAttributesById,function(a){b.push(a)});return b};
exportProperty(wrm.data.meta.Entity.prototype,"getMetaAttributes",wrm.data.meta.Entity.prototype.getMetaAttributes);wrm.data.meta.Entity.prototype.getKeyAttribute=function(){return this._keyAttribute};exportProperty(wrm.data.meta.Entity.prototype,"getKeyAttribute",wrm.data.meta.Entity.prototype.getKeyAttribute);wrm.data.meta.Entity.prototype.getServerKeyAttribute=function(){return this._serverKeyAttribute};exportProperty(wrm.data.meta.Entity.prototype,"getServerKeyAttribute",wrm.data.meta.Entity.prototype.getServerKeyAttribute);
wrm.data.meta.Entity.prototype.getAttribute=function(a,b){var c=this._attributesById[a];!c&&b&&(c=this._metaAttributesById[a]);if(!c)throw Error("Unknown attribute '"+a+"' in entity "+this);return c};exportProperty(wrm.data.meta.Entity.prototype,"getAttribute",wrm.data.meta.Entity.prototype.getAttribute);wrm.data.meta.Entity.prototype.getRoles=function(){this._rolesList||(this._rolesList=Object.keys(this._rolesById).map(function(a){return this._rolesById[a]},this));return this._rolesList};
exportProperty(wrm.data.meta.Entity.prototype,"getRoles",wrm.data.meta.Entity.prototype.getRoles);wrm.data.meta.Entity.prototype.getRole=function(a){var b=this._rolesById[a];if(!b)throw Error("Unknown role '"+a+"' in entity "+this);return b};exportProperty(wrm.data.meta.Entity.prototype,"getRole",wrm.data.meta.Entity.prototype.getRole);wrm.data.meta.Entity.prototype.getForeignKeyRoles=function(){return this._foreignKeyRoles};exportProperty(wrm.data.meta.Entity.prototype,"getForeignKeyRoles",wrm.data.meta.Entity.prototype.getForeignKeyRoles);
wrm.data.meta.Entity.prototype.getAssociations=function(){var a=this._assocs;if(a)return a;var b={},a=[];this.getRoles().forEach(function(c){c=c.getAssociation();var d=c.getId();!0!==b[d]&&(b[d]=!0,a.push(c))});return this._assocs=a};exportProperty(wrm.data.meta.Entity.prototype,"getAssociations",wrm.data.meta.Entity.prototype.getAssociations);
wrm.data.meta.Entity.prototype.registerAttribute=function(a,b,c){if(a.isKey()&&this._keyAttribute)throw Error("Entity already has a key attribute");if(a.isServerKey()&&this._serverKeyAttribute)throw Error("Entity already has a server key attribute");a instanceof wrm.data.meta.MetaAttribute?this._doRegisterElement(this._metaAttributesById,a,c):(this._doRegisterElement(this._attributesById,a,c),this._attributesList=null);a.isKey()&&(this._keyAttribute=a);a.isServerKey()&&(this._serverKeyAttribute=a);
this.getMetadata().registerAttribute(a,b)};wrm.data.meta.Entity.prototype.registerRole=function(a,b,c){this._doRegisterElement(this._rolesById,a,c);this._assocs=this._rolesList=null;a.isForeignKey()&&this._foreignKeyRoles.push(a);this.getMetadata().registerRole(a,b)};wrm.data.meta.Entity.prototype._doRegisterElement=function(a,b,c){c||(a[b.getId()]=b);this._initd&&b.init()};wrm.data.meta.AuxEntity=function(a,b,c){wrm.data.meta.Entity.call(this,a,b,c);this.createAttributes(b.attributes||{});this.createRoles(b.roles||{});c.registerEntity(this)};extendConstructor(wrm.data.meta.AuxEntity,wrm.data.meta.Entity);exportSymbol("wrm.data.meta.AuxEntity",wrm.data.meta.AuxEntity);wrm.data.meta.RegularEntity=function(a,b,c){wrm.data.meta.Entity.call(this,a,b,c);this._updateTimestampAttribute=this._createTimestampAttribute=null;this._auxEntity=this._createAuxEntity(b.auxEntity||null);this._dirtyAttribute=this._createDirtyAttribute(b.dirtyName||null,this._auxEntity);this._deleteTimestampAttribute=this._createDeleteTimestampAttribute(b.deleteTimestampName||null,this._auxEntity);this.createAttributes(b.attributes||{},this._auxEntity);this.createRoles(b.roles||{},this._auxEntity);
if(this.getId()!==wrm.Constants.USER_ENT_ID&&this.getServerName()&&!this.getServerKeyAttribute())throw Error("Server-mapped entity "+this+" has no server key attribute");c.registerEntity(this)};extendConstructor(wrm.data.meta.RegularEntity,wrm.data.meta.Entity);exportSymbol("wrm.data.meta.RegularEntity",wrm.data.meta.RegularEntity);wrm.data.meta.RegularEntity.prototype._createAuxEntity=function(a){return a?new wrm.data.meta.AuxEntity("_aux_"+this.getId(),a,this.getMetadata()):null};
wrm.data.meta.RegularEntity.prototype._createDirtyAttribute=function(a,b){if(!a)return null;if(!b)throw Error("No auxiliary entity available for entity "+this);var c=this.getId()+"_dirty",d={};d.name=a;d.type=wrm.data.Type.BOOLEAN;return new wrm.data.meta.AuxAttribute(c,d,b,!1,this.getMetadata())};
wrm.data.meta.RegularEntity.prototype._createDeleteTimestampAttribute=function(a,b){if(!a)return null;if(!b)throw Error("No auxiliary entity available for entity "+this);var c=this.getId()+"_deletedAt",d={};d.name=a;d.type=wrm.data.Type.TIMESTAMP;return new wrm.data.meta.AuxAttribute(c,d,b,!1,this.getMetadata())};wrm.data.meta.RegularEntity.prototype.getCreateTimestampAttribute=function(){return this._createTimestampAttribute};
exportProperty(wrm.data.meta.RegularEntity.prototype,"getCreateTimestampAttribute",wrm.data.meta.RegularEntity.prototype.getCreateTimestampAttribute);wrm.data.meta.RegularEntity.prototype.getUpdateTimestampAttribute=function(){return this._updateTimestampAttribute};exportProperty(wrm.data.meta.RegularEntity.prototype,"getUpdateTimestampAttribute",wrm.data.meta.RegularEntity.prototype.getUpdateTimestampAttribute);wrm.data.meta.RegularEntity.prototype.getAuxiliaryEntity=function(){return this._auxEntity};
exportProperty(wrm.data.meta.RegularEntity.prototype,"getAuxiliaryEntity",wrm.data.meta.RegularEntity.prototype.getAuxiliaryEntity);wrm.data.meta.RegularEntity.prototype.getDirtyAuxiliaryAttribute=function(){return this._dirtyAttribute};exportProperty(wrm.data.meta.RegularEntity.prototype,"getDirtyAuxiliaryAttribute",wrm.data.meta.RegularEntity.prototype.getDirtyAuxiliaryAttribute);wrm.data.meta.RegularEntity.prototype.getDeleteTimestampAuxiliaryAttribute=function(){return this._deleteTimestampAttribute};
exportProperty(wrm.data.meta.RegularEntity.prototype,"getDeleteTimestampAuxiliaryAttribute",wrm.data.meta.RegularEntity.prototype.getDeleteTimestampAuxiliaryAttribute);
wrm.data.meta.RegularEntity.prototype.registerAttribute=function(a){var b=!1,c=!1;a instanceof wrm.data.meta.RegularAttribute&&(b=a.isCreateTimestamp(),c=a.isUpdateTimestamp());if(b&&this._createTimestampAttribute)throw Error("Entity already has a create timestamp attribute");if(c&&this._updateTimestampAttribute)throw Error("Entity already has an update timestamp attribute");wrm.data.meta.RegularEntity._super.registerAttribute.call(this,a);b&&(this._createTimestampAttribute=a);c&&(this._updateTimestampAttribute=
a)};exportProperty(wrm.data.meta.RegularEntity.prototype,"registerAttribute",wrm.data.meta.RegularEntity.prototype.registerAttribute);wrm.data.meta.Association=function(a,b,c){wrm.data.meta.Element.call(this,a,b,c)};extendConstructor(wrm.data.meta.Association,wrm.data.meta.Element);exportSymbol("wrm.data.meta.Association",wrm.data.meta.Association);wrm.data.meta.Association.prototype.initRoles=function(a,b){if(this._role1||this._role2)throw Error("Roles already initialized");this._role1=a;a.initAssociation(this);this._role2=b;b.initAssociation(this)};wrm.data.meta.Association.prototype.getEntity1=function(){return this._role1.getEntity()};
exportProperty(wrm.data.meta.Association.prototype,"getEntity1",wrm.data.meta.Association.prototype.getEntity1);wrm.data.meta.Association.prototype.getEntity2=function(){return this._role2.getEntity()};exportProperty(wrm.data.meta.Association.prototype,"getEntity2",wrm.data.meta.Association.prototype.getEntity2);
wrm.data.meta.Association.prototype.getEntity=function(a){if(a===this._role1.getEntity().getId())return this._role1.getEntity();if(a===this._role2.getEntity().getId())return this._role2.getEntity();throw Error("Unknown entity '"+a+"' connected to association "+this);};exportProperty(wrm.data.meta.Association.prototype,"getEntity",wrm.data.meta.Association.prototype.getEntity);wrm.data.meta.Association.prototype.getRole1=function(){return this._role1};
exportProperty(wrm.data.meta.Association.prototype,"getRole1",wrm.data.meta.Association.prototype.getRole1);wrm.data.meta.Association.prototype.getRole2=function(){return this._role2};exportProperty(wrm.data.meta.Association.prototype,"getRole2",wrm.data.meta.Association.prototype.getRole2);wrm.data.meta.AuxAssociation=function(a,b,c){wrm.data.meta.Association.call(this,a,b,c);c.registerAssociation(this,!0)};extendConstructor(wrm.data.meta.AuxAssociation,wrm.data.meta.Association);exportSymbol("wrm.data.meta.AuxAssociation",wrm.data.meta.AuxAssociation);wrm.data.meta.RegularAssociation=function(a,b,c){wrm.data.meta.Association.call(this,a,b,c);c.registerAssociation(this)};extendConstructor(wrm.data.meta.RegularAssociation,wrm.data.meta.Association);exportSymbol("wrm.data.meta.RegularAssociation",wrm.data.meta.RegularAssociation);
wrm.data.meta.RegularAssociation.prototype.doInit=function(a){wrm.data.meta.RegularAssociation._super.doInit.call(this,a);var b=this.getMetadata(),c=a.roles||[],d=c[0]&&b.getRole(c[0]);if(!d)throw Error("Missing or invalid role 1 '"+c[0]+"'");b=c[1]&&b.getRole(c[1]);if(!b)throw Error("Missing or invalid role 2 '"+c[1]+"'");this.initRoles(d,b);this._bridgeEntity=this._createBridgeEntity(a.bridgeEntity||null,d,b);this._hemiAssoc1=(a=this._createHemiAssociations(this._bridgeEntity))&&a[0];this._hemiAssoc2=
a&&a[1]};exportProperty(wrm.data.meta.RegularAssociation.prototype,"doInit",wrm.data.meta.RegularAssociation.prototype.doInit);wrm.data.meta.RegularAssociation.prototype._createBridgeEntity=function(a,b,c){return a?new wrm.data.meta.BridgeEntity("_brdg_"+this.getId(),a,b,c,this.getMetadata()):null};
wrm.data.meta.RegularAssociation.prototype._createHemiAssociations=function(a){if(!a)return null;var b=this.getId(),c=this.getName(),d=a.getRole1();a=a.getRole2();var e=this.getMetadata(),f=new wrm.data.meta.AuxAssociation(b+"_1",{name:c+"_half_1"},e);f.initRoles(d.getInverseRole(),d);b=new wrm.data.meta.AuxAssociation(b+"_2",{name:c+"_half_2"},e);b.initRoles(a,a.getInverseRole());return[f,b]};wrm.data.meta.RegularAssociation.prototype.getBridgeEntity=function(){return this._bridgeEntity};
exportProperty(wrm.data.meta.RegularAssociation.prototype,"getBridgeEntity",wrm.data.meta.RegularAssociation.prototype.getBridgeEntity);wrm.data.meta.RegularAssociation.prototype.getHemiAssociation1=function(){return this._hemiAssoc1};exportProperty(wrm.data.meta.RegularAssociation.prototype,"getHemiAssociation1",wrm.data.meta.RegularAssociation.prototype.getHemiAssociation1);wrm.data.meta.RegularAssociation.prototype.getHemiAssociation2=function(){return this._hemiAssoc2};
exportProperty(wrm.data.meta.RegularAssociation.prototype,"getHemiAssociation2",wrm.data.meta.RegularAssociation.prototype.getHemiAssociation2);wrm.util.Semaphore=function(a){if(1>a)throw Error("Must supply at least 1 permit");this._free=this._total=a;this._queue=[]};wrm.util.Semaphore.prototype.acquire=function(){var a=this;return 0<this._free?(this._free--,Promise.resolve()):new Promise(function(b){a._queue.push(b)})};wrm.util.Semaphore.prototype.release=function(){if(0<this._queue.length)this._queue.shift()();else if(this._free<this._total)this._free++;else throw Error("No permits to release");};wrm.data.sync.EntityOrchestrator=function(a,b,c){this._functions={};this._promises={};this._requiredEntityIds={};this._registeredEntityIdsSet={};this._semaphore=new wrm.util.Semaphore(c);this._startPromises={};this._entities=a;b?this._initPreservingOrder(a):this._init(a)};
wrm.data.sync.EntityOrchestrator.prototype._init=function(a){var b=[],c={};a.forEach(function(d){d.getRoles().forEach(function(e){var f=e.getAssociation(),g=f.getId();!0!==c[g]&&(c[g]=!0,e.getServerName()||e.getInverseRole().getServerName())&&(e=e.getInverseEntity(),d!==e&&(0>a.indexOf(e)||b.push(f)))},this)},this);b.forEach(function(a){var b=this._compare(a);0!==b&&(-1===b?this._registerDependence(a.getEntity1(),a.getEntity2()):this._registerDependence(a.getEntity2(),a.getEntity1()))},this);this._removeDeadlocks()};
wrm.data.sync.EntityOrchestrator.prototype._initPreservingOrder=function(a){var b=null;a.forEach(function(a){b&&this._registerDependence(a,b);b=a},this)};wrm.data.sync.EntityOrchestrator.prototype._compare=function(a){var b=a.getRole1();a=a.getRole2();var c=null!==b.getServerName(),d=null!==a.getServerName();if(c&&!d)return-1;if(!c&&d)return 1;b=b.isForeignKey();a=a.isForeignKey();return b&&!a?-1:!b&&a?1:0};
wrm.data.sync.EntityOrchestrator.prototype._removeDeadlocks=function(){Object.keys(this._requiredEntityIds).forEach(function(a){this._doRemoveDeadlocks(a,a,{})},this)};wrm.data.sync.EntityOrchestrator.prototype._doRemoveDeadlocks=function(a,b,c){!0!==c[b]&&(c[b]=!0,b=this._requiredEntityIds[b])&&(delete b[a],Object.keys(b).forEach(function(b){this._doRemoveDeadlocks(a,b,c)},this))};
wrm.data.sync.EntityOrchestrator.prototype._registerDependence=function(a,b){var c=a.getId(),d=b.getId(),e=this._requiredEntityIds[c];e||(this._requiredEntityIds[c]=e={});e[d]=!0;!0!==this._registeredEntityIdsSet[c]&&(this._registeredEntityIdsSet[c]=!0,this._preparePromise(a));!0!==this._registeredEntityIdsSet[d]&&(this._registeredEntityIdsSet[d]=!0,this._preparePromise(b))};
wrm.data.sync.EntityOrchestrator.prototype._preparePromise=function(a){var b=a.getId();if(DEBUG&&this._promises[b])throw Error("Promise already created for entity id "+b);this._promises[b]=new Promise(function(a,d){this._functions[b]=a}.bind(this))};wrm.data.sync.EntityOrchestrator.prototype.getEntities=function(){return this._entities};
wrm.data.sync.EntityOrchestrator.prototype.getSortedEntities=function(){var a=this,b=this._entities[0].getMetadata(),c=this._entities.map(function(a){return a.getId()});return wrm.util.sortTopologically(c,function(c){c=b.getEntity(c);return a.getRequiredEntities(c).map(function(a){return a.getId()})}).map(function(a){return b.getEntity(a)})};
wrm.data.sync.EntityOrchestrator.prototype.notifySynchronizationStarted=function(a){var b=a.getId(),c=this._startPromises[b];c||(this._startPromises[b]=c=this._createStartPromise(a));return c};wrm.data.sync.EntityOrchestrator.prototype._createStartPromise=function(a){var b=this;a=(a=this._requiredEntityIds[a.getId()])?Object.keys(a):[];a=0>=a.length?Promise.resolve():Promise.map(a,function(a){return b._promises[a]});return a=a.then(function(){return b._semaphore.acquire()})};
wrm.data.sync.EntityOrchestrator.prototype.getRequiredEntities=function(a){var b=this._requiredEntityIds[a.getId()];if(!b)return[];var c=a.getMetadata();return Object.keys(b).map(function(a){return c.getEntity(a)},this)};wrm.data.sync.EntityOrchestrator.prototype.notifySynchronizationFinished=function(a){(a=this._functions[a.getId()])&&a();this._semaphore.release()};wrm.data.DataContext=function(){};exportSymbol("wrm.data.DataContext",wrm.data.DataContext);wrm.data.DataContext.prototype.getMetadata=function(){};exportProperty(wrm.data.DataContext.prototype,"getMetadata",wrm.data.DataContext.prototype.getMetadata);wrm.data.DataContext.prototype.getQueryFactory=function(){};exportProperty(wrm.data.DataContext.prototype,"getQueryFactory",wrm.data.DataContext.prototype.getQueryFactory);wrm.data.DataContext.prototype.castToSingleValue=ABSTRACT_METHOD;
exportProperty(wrm.data.DataContext.prototype,"castToSingleValue",wrm.data.DataContext.prototype.castToSingleValue);wrm.data.DataContext.prototype.castToArrayValue=ABSTRACT_METHOD;exportProperty(wrm.data.DataContext.prototype,"castToArrayValue",wrm.data.DataContext.prototype.castToArrayValue);wrm.data.DataContext.prototype.addChangeListener=ABSTRACT_METHOD;exportProperty(wrm.data.DataContext.prototype,"addChangeListener",wrm.data.DataContext.prototype.addChangeListener);
wrm.data.DataContext.prototype.removeChangeListener=ABSTRACT_METHOD;exportProperty(wrm.data.DataContext.prototype,"removeChangeListener",wrm.data.DataContext.prototype.removeChangeListener);wrm.data.DataContext.prototype.disableChangeTracking=ABSTRACT_METHOD;exportProperty(wrm.data.DataContext.prototype,"disableChangeTracking",wrm.data.DataContext.prototype.disableChangeTracking);wrm.data.DataContext.prototype.isChangeTrackingEnabled=ABSTRACT_METHOD;
exportProperty(wrm.data.DataContext.prototype,"isChangeTrackingEnabled",wrm.data.DataContext.prototype.isChangeTrackingEnabled);wrm.data.DataContext.prototype.setExposedMetaAttributes=ABSTRACT_METHOD;exportProperty(wrm.data.DataContext.prototype,"setExposedMetaAttributes",wrm.data.DataContext.prototype.setExposedMetaAttributes);wrm.data.DataContext.prototype.select=ABSTRACT_METHOD;exportProperty(wrm.data.DataContext.prototype,"select",wrm.data.DataContext.prototype.select);
wrm.data.DataContext.prototype.selectOld=ABSTRACT_METHOD;exportProperty(wrm.data.DataContext.prototype,"selectOld",wrm.data.DataContext.prototype.selectOld);wrm.data.DataContext.prototype.selectOne=ABSTRACT_METHOD;exportProperty(wrm.data.DataContext.prototype,"selectOne",wrm.data.DataContext.prototype.selectOne);wrm.data.DataContext.prototype.selectOneOld=ABSTRACT_METHOD;exportProperty(wrm.data.DataContext.prototype,"selectOneOld",wrm.data.DataContext.prototype.selectOneOld);
wrm.data.DataContext.prototype.insert=ABSTRACT_METHOD;exportProperty(wrm.data.DataContext.prototype,"insert",wrm.data.DataContext.prototype.insert);wrm.data.DataContext.prototype.update=ABSTRACT_METHOD;exportProperty(wrm.data.DataContext.prototype,"update",wrm.data.DataContext.prototype.update);wrm.data.DataContext.prototype.updateNoResult=ABSTRACT_METHOD;exportProperty(wrm.data.DataContext.prototype,"updateNoResult",wrm.data.DataContext.prototype.updateNoResult);
wrm.data.DataContext.prototype["delete"]=ABSTRACT_METHOD;wrm.data.DataContext.prototype.deleteOld=ABSTRACT_METHOD;exportProperty(wrm.data.DataContext.prototype,"deleteOld",wrm.data.DataContext.prototype.deleteOld);wrm.data.DataContext.prototype.deleteGetChanged=ABSTRACT_METHOD;exportProperty(wrm.data.DataContext.prototype,"deleteGetChanged",wrm.data.DataContext.prototype.deleteGetChanged);wrm.data.DataContext.prototype.deleteGetCount=ABSTRACT_METHOD;
exportProperty(wrm.data.DataContext.prototype,"deleteGetCount",wrm.data.DataContext.prototype.deleteGetCount);wrm.data.AbstractAtomNode=function(a,b,c,d,e,f,g){this._arrayTest=b;this._property=c.getProperty();a?(a=d.inputName,d=d.value,b=a,b=/^[A-Za-z_][A-Za-z0-9_]*$/.test(b)?"this."+b:isNaN(Number(b))?"this["+("'"+b.replace(/(['\\])/g,"\\$1")+"'")+"]":"this["+b+"]"):(a=null,d=void 0,b=null);this._propertyRef=c;this._rightExpr=b;this._inputName=a;this._inputValue=d;this._rightValueConj=e;this._impliedResult=f;this._evaluateRequired=g};
wrm.data.AbstractAtomNode.prototype.compile=function(a){var b=this._impliedResult,c=null===b?a.requiredInputs:a.impliedInputs;c.expected++;if(this._inputName){var d=this._extractInputValue(a);if(void 0===d||null===d||angular.isArray(d)&&0>=d.length)return null===b?{predicate:null,evaluator:null}:{predicate:String(b),evaluator:b?wrm.data.AbstractAtomNode._TRUE_EVALUATOR:wrm.data.AbstractAtomNode._FALSE_EVALUATOR};a.actualInputs[this._inputName]=d}c.found++;b=null;if(a.compileEvaluator)b=this._createEvaluator(a);
else if(this._evaluateRequired)throw new wrm.data.AbstractAtomNode.EvaluationRequiredError;return this._evaluateRequired?{predicate:String(a.verity),evaluator:b}:{predicate:this._createPredicate(a),evaluator:b}};
wrm.data.AbstractAtomNode.prototype._extractInputValue=function(a){if(DEBUG&&!this._inputName)throw Error("No input expected");var b=this._inputValue;void 0===b&&(b=a.inputs[this._inputName]);b=a.dataContext.castToArrayValue(this._property,b);!this._arrayTest&&1>=b.length&&(b=a.dataContext.castToSingleValue(this._property,b));return this.prepareInputValue(b)};wrm.data.AbstractAtomNode.prototype.prepareInputValue=function(a){return a};
wrm.data.AbstractAtomNode.prototype._createPredicate=function(a){var b="it."+this._propertyRef.getResolvedReference(),c=this._rightExpr;a=null!==this._inputName?a.actualInputs[this._inputName]:void 0;return!this._arrayTest&&c&&a&&angular.isArray(a)?"("+a.map(function(a,e){return this.createPredicatePiece(b,c+"["+e+"]",!a)},this).join(") "+(this._rightValueConj?"\x26\x26":"||")+" (")+")":this.createPredicatePiece(b,c,null!==this._inputName?!a:!1)};
wrm.data.AbstractAtomNode.prototype.createPredicatePiece=ABSTRACT_METHOD;wrm.data.AbstractAtomNode.EvaluationRequiredError=makeCustomErrorConstructor("wrm.data.AbstractAtomNode.EvaluationRequiredError");wrm.data.AbstractAtomNode._TRUE_EVALUATOR=function(a){return Promise.resolve(!0)};wrm.data.AbstractAtomNode._FALSE_EVALUATOR=function(a){return Promise.resolve(!1)};
wrm.data.AbstractAtomNode.prototype._createEvaluator=function(a){var b=this.evaluate.bind(this);a=new wrm.data.JDPropertyEvaluator(b,this._propertyRef,null!==this._inputName?a.actualInputs[this._inputName]:void 0,this._arrayTest?null:this._rightValueConj);return a.evaluate.bind(a)};wrm.data.AbstractAtomNode.prototype.evaluate=ABSTRACT_METHOD;wrm.data.AbstractCompoundNode=function(a){this._operands=a};wrm.data.AbstractCompoundNode.prototype.compile=function(a){var b=a.verity;a.verity=this.propagateVerity(a.verity);var c=[],d=[];try{this._operands.forEach(function(b){b=b.compile(a);if(!b.predicate)return{predicate:null,evaluator:null};c.push(b.predicate);d.push(b.evaluator)})}finally{a.verity=b}return{predicate:this.mergePredicates(c),evaluator:a.compileEvaluator?this._mergeEvaluators(d):null}};
wrm.data.AbstractCompoundNode.prototype.mergePredicates=ABSTRACT_METHOD;wrm.data.AbstractCompoundNode.prototype.propagateVerity=function(a){return a};wrm.data.AbstractCompoundNode.prototype._mergeEvaluators=function(a){var b=this.evaluate.bind(this);return function(c,d){return Promise.resolve(b(a,c,d))}};wrm.data.AbstractCompoundNode.prototype.evaluate=ABSTRACT_METHOD;wrm.data.ConditionNodes={};wrm.data.ConditionNodes.Atoms={};wrm.data.ConditionNodes.Compounds={};wrm.data.ConditionNodes.registerUnaryAtomOperators=function(a){Object.keys(a).forEach(function(b){wrm.data.ConditionNodes.Atoms[b]=wrm.data.ConditionNodes._newUnaryAtomCtor(a[b])})};
wrm.data.ConditionNodes._newUnaryAtomCtor=function(a){var b=a.fragmentTemplate,c=wrm.data.ConditionNodes._createIsEvaluateRequiredFunction(a.isEvaluateRequired);a=a.evaluate;var d=function(a,b,d,h){wrm.data.AbstractAtomNode.call(this,!1,!1,a,b,d,h,c(a))};extendConstructor(d,wrm.data.AbstractAtomNode);d.prototype.createPredicatePiece=function(a,c,d){return b.replace(/\$([0])/g,function(b,c){return a})};d.prototype.evaluate=a;d.binary=!1;return d};
wrm.data.ConditionNodes.registerBinaryAtomOperators=function(a){Object.keys(a).forEach(function(b){wrm.data.ConditionNodes.Atoms[b]=wrm.data.ConditionNodes._newBinaryAtomCtor(a[b])})};
wrm.data.ConditionNodes._newBinaryAtomCtor=function(a){var b=a.fragmentTemplate,c=a.mapExpression,d=a.prepareRightValue,e=wrm.data.ConditionNodes._createIsEvaluateRequiredFunction(a.isEvaluateRequired),f=a.evaluate,g=function(b,c,d,f){wrm.data.AbstractAtomNode.call(this,!0,a.arrayTest||!1,b,c,d,f,e(b))};extendConstructor(g,wrm.data.AbstractAtomNode);g.prototype.createPredicatePiece=function(a,d,e){return b.replace(/\$([01])/g,function(b,f){f=(b="0"===f)?a:d;!c||!b&&e||(f+=c);return f})};d&&(g.prototype.prepareInputValue=
d);g.prototype.evaluate=function(a,b,c){return null===a?!1:f(a,b,c)};g.binary=!0;return g};wrm.data.ConditionNodes.registerUnaryCompoundOperators=function(a){Object.keys(a).forEach(function(b){wrm.data.ConditionNodes.Compounds[b]=wrm.data.ConditionNodes._newUnaryCompoundCtor(a[b])})};
wrm.data.ConditionNodes._newUnaryCompoundCtor=function(a){var b=a.predicatePrefix,c=a.propagateVerity,d=function(a){wrm.data.AbstractCompoundNode.call(this,a)};extendConstructor(d,wrm.data.AbstractCompoundNode);d.prototype.mergePredicates=function(a){return b+"("+a[0]+")"};c&&(d.prototype.propagateVerity=function(a){return c(a)});d.prototype.evaluate=a.evaluate;return d};
wrm.data.ConditionNodes.registerBinaryCompoundOperators=function(a){Object.keys(a).forEach(function(b){wrm.data.ConditionNodes.Compounds[b]=wrm.data.ConditionNodes._newBinaryCompoundCtor(a[b])})};
wrm.data.ConditionNodes._newBinaryCompoundCtor=function(a){var b=a.predicateInfix,c=a.propagateVerity,d=function(a){wrm.data.AbstractCompoundNode.call(this,a)};extendConstructor(d,wrm.data.AbstractCompoundNode);d.prototype.mergePredicates=function(a){return a.map(function(a){return"("+a+")"}).join(b)};c&&(d.prototype.propagateVerity=function(a){return c(a)});d.prototype.evaluate=a.evaluate;return d};
wrm.data.ConditionNodes._createIsEvaluateRequiredFunction=function(a){return function(b){return wrm.data.lateEvaluationEnabled||a&&a(b)?!0:!1}};wrm.data.PropertyRef=function(a,b,c){this._baseEntity=a;this._properties=b;this._metaAttrFamily=c;a=wrm.data.PropertyRef._resolveProperties(a,b,c);this._property=a.property;this._roles=a.roles;this._resolvedReference=a.resolvedReference;this._resolvedRoleReference=a.resolvedRoleReference;this._lastRoleRef=this._physicalRef=void 0};exportSymbol("wrm.data.PropertyRef",wrm.data.PropertyRef);
wrm.data.PropertyRef._resolveProperties=function(a,b,c){if(0>=b.length)throw Error("Empty chain of referenced properties");var d=[],e=a;a=null;for(var f=0;f<b.length;f++)if(a=b[f],d.push(a.getName()),a instanceof wrm.data.meta.Role)e=a.getInverseEntity();else if(e=null,f<b.length-1)throw Error("Found attribute not at the end of the chain of referenced properties");b=(e=!!e)?b:b.slice(0,b.length-1);e=e?d:d.slice(0,d.length-1);c=null!==c?"#"+c:"";return{property:a,resolvedReference:d.join(".")+c,roles:b,
resolvedRoleReference:0<e.length?e.join("."):null}};wrm.data.PropertyRef.prototype.getBaseEntity=function(){return this._baseEntity};exportProperty(wrm.data.PropertyRef.prototype,"getBaseEntity",wrm.data.PropertyRef.prototype.getBaseEntity);wrm.data.PropertyRef.prototype.getProperty=function(){return this._property};exportProperty(wrm.data.PropertyRef.prototype,"getProperty",wrm.data.PropertyRef.prototype.getProperty);wrm.data.PropertyRef.prototype.getRoles=function(){return this._roles};
exportProperty(wrm.data.PropertyRef.prototype,"getRoles",wrm.data.PropertyRef.prototype.getRoles);wrm.data.PropertyRef.prototype.getResolvedReference=function(){return this._resolvedReference};wrm.data.PropertyRef.prototype.getResolvedRoleReference=function(){return this._resolvedRoleReference};wrm.data.PropertyRef.prototype.getLastRoleRef=function(){void 0===this._lastRoleRef&&(this._lastRoleRef=0<this._roles.length?new wrm.data.PropertyRef(this._baseEntity,this._roles,null):null);return this._lastRoleRef};
wrm.data.PropertyRef.prototype.getPhysicalRef=function(){if(void 0===this._physicalRef){var a=[];this._properties.forEach(function(b){var c=b instanceof wrm.data.meta.RegularRole?b.getBridgeHeadRole():null;if(c){b=c.getInverseRole();var d=b.getEntity();b=b===d.getRole1()?d.getRole2():d.getRole1();a.push(c)}a.push(b)});this._physicalRef=new wrm.data.PropertyRef(this._baseEntity,a,this._metaAttrFamily)}return this._physicalRef};
wrm.data.PropertyRef.prototype.toString=function(){return"["+this._baseEntity.getName()+"]."+this._resolvedReference};exportProperty(wrm.data.PropertyRef.prototype,"toString",wrm.data.PropertyRef.prototype.toString);
wrm.data.PropertyRef.of=function(a,b,c){var d=b.split("."),e;if(!d[0])throw Error("Empty entity property id expresison '"+b+"'");e=d[d.length-1];var f=e.indexOf("#");0<f?(d[d.length-1]=e.substring(0,f),e=e.substring(f+1)):e=null;for(var f=[],g=a,h=null,k=0;k<d.length;k++)if(h=g.getProperty(d[k],c),f.push(h),h instanceof wrm.data.meta.Role)g=h.getInverseEntity();else if(g=null,k<d.length-1)throw Error("Found attribute not at the end of id expression '"+b+"'");if(null!==e&&!(h instanceof wrm.data.meta.Attribute))throw Error("Found meta-attribute reference after a non-attribute");
return new wrm.data.PropertyRef(a,f,e)};exportProperty(wrm.data.PropertyRef,"of",wrm.data.PropertyRef.of);wrm.data.meta.Metadata=function(a){if("number"!==typeof a.version)throw Error("Invalid metadata version");this._descriptor=wrm.data.cloneObject(a);this._version=a.version;this._entitiesById={};this._attributesById={};this._rolesById={};this._assocsById={};this._initd=!1;this._createEntities(a.entities||{});this._createAssociations(a.associations||{});this._init()};exportSymbol("wrm.data.meta.Metadata",wrm.data.meta.Metadata);
wrm.data.meta.Metadata.prototype._createEntities=function(a){angular.forEach(a,function(a,c){new wrm.data.meta.RegularEntity(c,a,this)},this)};wrm.data.meta.Metadata.prototype._createAssociations=function(a){angular.forEach(a,function(a,c){new wrm.data.meta.RegularAssociation(c,a,this)},this)};wrm.data.meta.Metadata.prototype._init=function(){this._initd=!0;this.getEntities().forEach(function(a){a.init()});this.getAssociations().forEach(function(a){a.init()})};
wrm.data.meta.Metadata.prototype.getDescriptor=function(){return this._descriptor};wrm.data.meta.Metadata.prototype.getVersion=function(){return this._version};exportProperty(wrm.data.meta.Metadata.prototype,"getVersion",wrm.data.meta.Metadata.prototype.getVersion);wrm.data.meta.Metadata.prototype.getEntities=function(){var a=[];angular.forEach(this._entitiesById,function(b){a.push(b)});return a};exportProperty(wrm.data.meta.Metadata.prototype,"getEntities",wrm.data.meta.Metadata.prototype.getEntities);
wrm.data.meta.Metadata.prototype.getEntity=function(a){var b=this._entitiesById[a];if(!b)throw Error("Unknown entity '"+a+"'");return b};exportProperty(wrm.data.meta.Metadata.prototype,"getEntity",wrm.data.meta.Metadata.prototype.getEntity);wrm.data.meta.Metadata.prototype.getAssociations=function(){var a=[];angular.forEach(this._assocsById,function(b){a.push(b)});return a};exportProperty(wrm.data.meta.Metadata.prototype,"getAssociations",wrm.data.meta.Metadata.prototype.getAssociations);
wrm.data.meta.Metadata.prototype.getAssociation=function(a){var b=this._assocsById[a];if(!b)throw Error("Unknown association '"+a+"'");return b};exportProperty(wrm.data.meta.Metadata.prototype,"getAssociation",wrm.data.meta.Metadata.prototype.getAssociation);wrm.data.meta.Metadata.prototype.getAttribute=function(a){var b=this._attributesById[a];if(!b)throw Error("Unknown attribute '"+a+"'");return b};exportProperty(wrm.data.meta.Metadata.prototype,"getAttribute",wrm.data.meta.Metadata.prototype.getAttribute);
wrm.data.meta.Metadata.prototype.getRole=function(a){var b=this._rolesById[a];if(!b)throw Error("Unknown role '"+a+"'");return b};exportProperty(wrm.data.meta.Metadata.prototype,"getRole",wrm.data.meta.Metadata.prototype.getRole);wrm.data.meta.Metadata.prototype.registerEntity=function(a,b){this._doRegisterElement(this._entitiesById,a,b)};wrm.data.meta.Metadata.prototype.registerAssociation=function(a,b){this._doRegisterElement(this._assocsById,a,b)};
wrm.data.meta.Metadata.prototype.registerAttribute=function(a,b){this._doRegisterElement(this._attributesById,a,b)};wrm.data.meta.Metadata.prototype.registerRole=function(a,b){this._doRegisterElement(this._rolesById,a,b)};wrm.data.meta.Metadata.prototype._doRegisterElement=function(a,b,c){c||(a[b.getId()]=b);this._initd&&b.init()};wrm.data.meta.Metadata.EMPTY=new wrm.data.meta.Metadata({version:-1});wrm.data.Condition=function(a,b,c){this._entity=a.getEntity(b);this._constantInputsCount=this._implicitInputsCount=0;this._includeRoleRefs={};this._explicitInputNames=[];this._tree=c?this._buildNode(c):null;this._oneImpliedInputRequired=(c&&c.config||{}).oneImpliedInputRequired||!1;this._compileEvaluator=!1;this._onlyKeyConditionInputName=this._retrieveOnlyKeyConditionInputName(c)};exportSymbol("wrm.data.Condition",wrm.data.Condition);exportProperty(wrm.data.Condition,"Config",wrm.data.Condition.Config);
exportProperty(wrm.data.Condition,"Expression",wrm.data.Condition.Expression);
wrm.data.Condition.prototype.createFilter=function(a,b){if(!this._tree)return{predicate:null,evaluator:null,inputs:{},notApplicable:!1};var c=new wrm.data.Condition.CompileContext(a,b,this._compileEvaluator),d;try{d=this._tree.compile(c)}catch(e){if(e instanceof wrm.data.AbstractAtomNode.EvaluationRequiredError)return this._compileEvaluator=!0,this.createFilter(a,b);throw e;}a=c.requiredInputs;b=c.impliedInputs;return 0<a.expected&&a.found<a.expected||this._oneImpliedInputRequired&&0<b.expected&&
0===b.found?{predicate:null,evaluator:null,inputs:{},notApplicable:!0}:0!==a.expected||this._oneImpliedInputRequired||0!==b.found?{predicate:d.predicate,evaluator:d.evaluator,inputs:c.actualInputs,notApplicable:!1}:{predicate:null,evaluator:null,inputs:{},notApplicable:!1}};exportProperty(wrm.data.Condition.prototype,"createFilter",wrm.data.Condition.prototype.createFilter);wrm.data.Condition.prototype.getExplicitInputNames=function(){return this._explicitInputNames};
exportProperty(wrm.data.Condition.prototype,"getExplicitInputNames",wrm.data.Condition.prototype.getExplicitInputNames);wrm.data.Condition.prototype.getIncludedRoleRefs=function(){var a=this._includeRoleRefs;return Object.keys(a).map(function(b){return a[b]})};wrm.data.Condition.prototype.getOnlyKeyConditionInputName=function(){return this._onlyKeyConditionInputName};wrm.data.Condition.Node=function(){};wrm.data.Condition.Node.prototype.compile=ABSTRACT_METHOD;
wrm.data.Condition._DEFAULT_COMPOUND_OP="and";wrm.data.Condition._DEFAULT_ATOM_OP="eq";wrm.data.Condition._TEXTUAL_OPERATOR_CONVERSION={e:"n","!e":"!n"};
wrm.data.Condition.prototype._buildNode=function(a){if(angular.isArray(a)){if(1<a.length)return this._buildCompoundNode(wrm.data.Condition._DEFAULT_COMPOUND_OP,a);if(1===a.length)return this._buildAtomNode(a[0]);throw Error("Invalid 0-length array in expression");}for(var b in wrm.data.ConditionNodes.Compounds)if(wrm.data.ConditionNodes.Compounds.hasOwnProperty(b)&&a[b])return this._buildCompoundNode(b,a[b]);return this._buildAtomNode(a)};
wrm.data.Condition.prototype._buildCompoundNode=function(a,b){angular.isArray(b)||(b=[b]);var c=wrm.data.ConditionNodes.Compounds[a];if(!c)throw Error("Invalid operator '"+a+"'");var d=[];b.forEach(function(a){d.push(this._buildNode(a))},this);return new c(d)};
wrm.data.Condition.prototype._buildAtomNode=function(a){"object"!==typeof a&&(a={property:a});var b=wrm.data.PropertyRef.of(this._entity,a.property,!0),c=b.getLastRoleRef();c&&(this._includeRoleRefs[c.getResolvedReference()]=c);var d=a.operator||wrm.data.Condition._DEFAULT_ATOM_OP;if(!wrm.data.Type.isTextual(b.getProperty().getType())){if(-1!==d.indexOf(".ic"))throw Error("Ignore case operator used on non textual attribute");d=wrm.data.Condition._TEXTUAL_OPERATOR_CONVERSION[d]||d}(c=wrm.data.ConditionNodes.Atoms[d+
("and"===a.valueOp?"[and]":"[or]")])||(c=wrm.data.ConditionNodes.Atoms[d]);if(!c)throw Error("Invalid value operator '"+d+"'");if(c.binary){var e;null!==a.value&&void 0!==a.value?(d="_k"+this._constantInputsCount++,e=a.value):(null===a.valueInput||void 0===a.valueInput?d=String(this._implicitInputsCount++):(d=a.valueInput,this._explicitInputNames.push(d)),e=void 0);d={inputName:d,value:e}}else d=null;e="and"===a.valueOp;a=void 0!==a.implied?!!a.implied:null;return new c(b.getPhysicalRef(),d,e,a)};
wrm.data.Condition.CompileContext=function(a,b,c){this.inputs=b;this.dataContext=a;this.compileEvaluator=c;this.verity=!0;this.actualInputs={};this.requiredConditionTested=!1;this.requiredInputs={expected:0,found:0};this.impliedInputs={expected:0,found:0}};wrm.data.Condition.prototype._retrieveOnlyKeyConditionInputName=function(a){return"string"===typeof a&&a===this._entity.getKeyAttribute().getId()?0:null};wrm.data.Purger=function(){this._nextRuleId=0;this._entitiesByRuleIds={};this._conditionsByEntityId={};this._touchedEntities={}};exportSymbol("wrm.data.Purger",wrm.data.Purger);wrm.data.Purger.prototype.registerRule=function(a,b){var c=a.getId(),d=String(this._nextRuleId++);this._entitiesByRuleIds[d]=a;(a=this._conditionsByEntityId[c])||(this._conditionsByEntityId[c]=a=[]);a.push.apply(a,b);return d};exportProperty(wrm.data.Purger.prototype,"registerRule",wrm.data.Purger.prototype.registerRule);
wrm.data.Purger.prototype.touch=function(a){(a=this._entitiesByRuleIds[a])&&(this._touchedEntities[a.getId()]=a)};exportProperty(wrm.data.Purger.prototype,"touch",wrm.data.Purger.prototype.touch);
wrm.data.Purger.prototype.purge=function(a,b){var c=this,d=this._conditionsByEntityId,e=this._touchedEntities;this._touchedEntities=[];var f=Object.keys(e);b.resize(f.length);return f.reduce(function(f,h){var k=e[h],l=d[h];return!k||!l||0>=l.length?(b.worked(1),f):f.then(function(){return c._purgeEntity(a,k,l)}).tap(function(){b.worked(1)})},Promise.resolve())};exportProperty(wrm.data.Purger.prototype,"purge",wrm.data.Purger.prototype.purge);
wrm.data.Purger.prototype._purgeEntity=function(a,b,c){return Promise.resolve().then(function(){a.disableChangeTracking();return a.deleteGetChanged(b.getId(),{filter:c})})};wrm.data.sync.computeKeysHash=function(a){if(0>=a.length)return-1;for(var b=0,c=0;c<a.length;c++){for(var d=String(a[c]),e=0,f=0;f<d.length;f++)e=(31*e&4294967295)+d.charCodeAt(f)&4294967295;b^=e}return b};wrm.data.sync.findKey=function(a,b,c,d){return wrm.data.sync._retrieveFindKeyQuery(a.getQueryFactory(),b,d).queryOne(a,[c])};wrm.data.sync._FIND_KEY_QUERY_CACHE={};
wrm.data.sync._retrieveFindKeyQuery=function(a,b,c){var d=wrm.data.sync._FIND_KEY_QUERY_CACHE,e=String(b.getMetadata().getVersion())+","+b.getId()+","+String(!!c),f=d[e];if(void 0!==f)return f;var f=b.getKeyAttribute(),g=b.getServerKeyAttribute(),h=b.getCreateTimestampAttribute(),k=[];k.push({property:g.getId()});!c&&h&&k.push({property:h.getId(),operator:"n"});f=a.prepareSelect(b.getId(),{output:f.getId(),outputConfig:{useNames:!0},filter:k});return d[e]=f};wrm.data.sync._FIND_ALL_KEYS_CHUNK=600;
wrm.data.sync.findAllKeys=function(a,b,c,d,e){var f=wrm.data.sync._retrieveFindAllKeysQuery(a.getQueryFactory(),b,e);return Promise.map(wrm.util.obj.sliceList(c,wrm.data.sync._FIND_ALL_KEYS_CHUNK),function(b){return f.query(a,[b])},{concurrency:d}).then(function(a){return Array.prototype.concat.apply([],a)})};wrm.data.sync._FIND_ALL_KEYS_QUERY_CACHE={};
wrm.data.sync._retrieveFindAllKeysQuery=function(a,b,c){var d=wrm.data.sync._FIND_ALL_KEYS_QUERY_CACHE,e=String(b.getMetadata().getVersion())+","+b.getId()+","+String(!!c),f=d[e];if(void 0!==f)return f;var f=b.getKeyAttribute(),g=b.getServerKeyAttribute(),h=b.getCreateTimestampAttribute(),k=[];k.push({property:g.getId()});!c&&h&&k.push({property:h.getId(),operator:"n"});f=a.prepareSelect(b.getId(),{output:{key:f.getId(),serverKey:g.getId()},outputConfig:{useNames:!0},filter:k});return d[e]=f};
wrm.data.sync.findServerKey=function(a,b,c,d){return wrm.data.sync._retrieveFindServerKeyQuery(a.getQueryFactory(),b,d).queryOne(a,[c])};wrm.data.sync._FIND_SERVER_KEY_QUERY_CACHE={};
wrm.data.sync._retrieveFindServerKeyQuery=function(a,b,c){var d=wrm.data.sync._FIND_SERVER_KEY_QUERY_CACHE,e=String(b.getMetadata().getVersion())+","+b.getId()+","+String(!!c),f=d[e];if(void 0!==f)return f;var f=b.getKeyAttribute(),g=b.getServerKeyAttribute(),h=b.getCreateTimestampAttribute(),k=[];k.push({property:f.getId()});!c&&h&&k.push({property:h.getId(),operator:"n"});f=a.prepareSelect(b.getId(),{output:g.getId(),outputConfig:{useNames:!0},filter:k});return d[e]=f};
wrm.data.sync.findFarServerKeys=function(a,b,c,d,e){return(b=wrm.data.sync._retrieveFindFarServerKeysQuery(a.getQueryFactory(),b,d,e))?b.query(a,[c]):Promise.resolve([])};wrm.data.sync._FIND_FAR_SERVER_KEYS_QUERY_CACHE={};
wrm.data.sync._retrieveFindFarServerKeysQuery=function(a,b,c,d){var e=wrm.data.sync._FIND_FAR_SERVER_KEYS_QUERY_CACHE,f=String(b.getMetadata().getVersion())+","+b.getId()+","+c.getId()+","+String(!!d),g=e[f];if(void 0!==g)return g;b=b.getKeyAttribute();g=c.getInverseEntity();c=c.getInverseRole();var h=g.getServerKeyAttribute();if(h){var k=g.getCreateTimestampAttribute(),l=[];l.push({property:c.getId()+"."+b.getId()});!d&&k&&l.push({property:k.getId(),operator:"n"});g=a.prepareSelect(g.getId(),{output:h.getId(),
outputConfig:{useNames:!0},filter:l})}else g=null;return e[f]=g};wrm.data.sync.AbstractTupleStore=function(){this.selectConcurrency=Infinity};wrm.data.sync.AbstractTupleStore.prototype.setSelectConcurrency=function(a){this.selectConcurrency=a};wrm.data.sync.AbstractTupleStore.TrackType={ADDITION:"A",REMOVAL:"R"};wrm.data.sync.AbstractTupleStore.prototype.getPreferredLookupServerKeyIndex=ABSTRACT_METHOD;wrm.data.sync.AbstractTupleStore.prototype.isUpdateRequired=ABSTRACT_METHOD;wrm.data.sync.AbstractTupleStore.prototype.select=ABSTRACT_METHOD;
wrm.data.sync.AbstractTupleStore.prototype.insert=ABSTRACT_METHOD;wrm.data.sync.AbstractTupleStore.prototype.update=ABSTRACT_METHOD;wrm.data.sync.AbstractTupleStore.prototype["delete"]=ABSTRACT_METHOD;wrm.data.sync.AbstractTupleStore.prototype.selectTracks=ABSTRACT_METHOD;wrm.data.sync.AbstractTupleStore.prototype.insertTrack=ABSTRACT_METHOD;wrm.data.sync.AbstractTupleStore.prototype.updateTracks=ABSTRACT_METHOD;wrm.data.sync.AbstractTupleStore.prototype.deleteTracks=ABSTRACT_METHOD;
wrm.data.sync.AbstractTupleStore.prototype.extractNewValues=function(a){return{"key1.new":a.key1,"key2.new":a.key2,"serverKey1.new":a.serverKey1,"serverKey2.new":a.serverKey2}};wrm.data.sync.AbstractTupleStore._FILTER_KEYS=["key1","key2","serverKey1","serverKey2"];
wrm.data.sync.AbstractTupleStore.prototype.sliceBulkFilter=function(a,b){for(var c=wrm.data.sync.AbstractTupleStore._FILTER_KEYS,d=[a],e=0;e<c.length;e++){var f=c[e];if(1<d.length){if(Array.isArray(a[f]))throw Error("Found multiple array properties in bulk filter");}else if(1===d.length)d=this._sliceBulkFilterOnProperty(d[0],f,b);else return null}return d};
wrm.data.sync.AbstractTupleStore.prototype._sliceBulkFilterOnProperty=function(a,b,c){if(DEBUG&&0>wrm.data.sync.AbstractTupleStore._FILTER_KEYS.indexOf(b))throw Error("Invalid property key '"+b+"'");var d=a[b];return Array.isArray(d)?wrm.util.obj.sliceList(d,c).map(function(c){var d=Object.create(a);d[b]=c;return d}):[a]};wrm.data.sync.BridgedTupleStore=function(a,b,c){wrm.data.sync.AbstractTupleStore.call(this);b=wrm.data.sync.AbstractTupleStore.TrackType;this._resolvedQueries=this._createResolvedQueries(a,c);this._unresolvedQueries=this._createAuxiliaryQueries(a,null,c);this._tracksQueries={};this._tracksQueries[b.ADDITION]=this._createAuxiliaryQueries(a,b.ADDITION,c);this._tracksQueries[b.REMOVAL]=this._createAuxiliaryQueries(a,b.REMOVAL,c)};extendConstructor(wrm.data.sync.BridgedTupleStore,wrm.data.sync.AbstractTupleStore);
wrm.data.sync.BridgedTupleStore.prototype._createResolvedQueries=function(a,b){var c=a.getEntity1(),d=a.getEntity2(),e=a.getId(),f=a.getRole1().getId()+"."+c.getKeyAttribute().getId(),g=a.getRole2().getId()+"."+d.getKeyAttribute().getId(),c=a.getRole1().getId()+"."+c.getServerKeyAttribute().getId(),d=a.getRole2().getId()+"."+d.getServerKeyAttribute().getId();a={filter:[{property:f,valueInput:"key1",implied:!0},{property:g,valueInput:"key2",implied:!0},{property:c,valueInput:"serverKey1",implied:!0},
{property:d,valueInput:"serverKey2",implied:!0}]};c=b.prepareNewAssociationSelect(e,angular.extend({},a,{output:{key1:f,key2:g,serverKey1:c,serverKey2:d},outputConfig:{useNames:!0}}));d=b.prepareNewAssociationInsert(e,function(a){var b={};b[f]=a["key1.new"];b[g]=a["key2.new"];return b});b=b.prepareNewAssociationDelete(e,a);return{select:c,insert:d,"delete":b}};
wrm.data.sync.BridgedTupleStore.prototype._createAuxiliaryQueries=function(a,b,c){var d=wrm.data.sync.AbstractTupleStore.TrackType,e=a.getBridgeEntity();a=e.getAuxiliaryEntity().getId();var f=e.getAddTimestampAuxiliaryAttribute(),g=e.getRemoveTimestampAuxiliaryAttribute(),h=e.getRole1().getServerTrackerAuxiliaryAttribute().getId(),k=e.getRole2().getServerTrackerAuxiliaryAttribute().getId(),l=f&&f.getId(),m=g&&g.getId(),g={filter:function(){var a=[{property:h,valueInput:"serverKey1",implied:!0},{property:k,
valueInput:"serverKey2",implied:!0}];l&&a.push({property:l,operator:b===d.ADDITION?"!n":"n"});m&&a.push({property:m,operator:b===d.REMOVAL?"!n":"n"});return a}()},e=c.prepareSelect(a,angular.extend({},g,{output:{serverKey1:h,serverKey2:k},outputConfig:{useNames:!0}})),f=c.prepareNewInsert(a,function(a){var c={};c[h]=a["serverKey1.new"];c[k]=a["serverKey2.new"];l&&b===d.ADDITION&&(c[l]=a.timestamp);m&&b===d.REMOVAL&&(c[m]=a.timestamp);return c});c=c.prepareDelete(a,g);return{select:e,insert:f,"delete":c}};
wrm.data.sync.BridgedTupleStore.prototype.getPreferredLookupServerKeyIndex=function(){return 1};wrm.data.sync.BridgedTupleStore.prototype.isUpdateRequired=function(){return!1};wrm.data.sync.BridgedTupleStore._SELECT_CHUNK_SIZE=600;
wrm.data.sync.BridgedTupleStore.prototype.select=function(a,b,c){var d=b?this._resolvedQueries.select:this._unresolvedQueries.select;return(b=this.sliceBulkFilter(c,wrm.data.sync.BridgedTupleStore._SELECT_CHUNK_SIZE))?Promise.map(b,function(b){return d.query(a,b)},{concurrency:this.selectConcurrency}).then(function(a){return Array.prototype.concat.apply([],a)}):Promise.resolve([])};
wrm.data.sync.BridgedTupleStore.prototype.insert=function(a,b,c){b=b?this._resolvedQueries.insert:this._unresolvedQueries.insert;c=this.extractNewValues(c);return b.executeGetChanged(a,c)};wrm.data.sync.BridgedTupleStore.prototype.update=function(a,b,c,d){throw Error("Bridged association tuples cannot be updated directly");};wrm.data.sync.BridgedTupleStore.prototype["delete"]=function(a,b,c){return(b?this._resolvedQueries["delete"]:this._unresolvedQueries["delete"]).executeGetChanged(a,c)};
wrm.data.sync.BridgedTupleStore.prototype.selectTracks=function(a,b,c){return this._tracksQueries[b].select.query(a,c)};wrm.data.sync.BridgedTupleStore.prototype.insertTrack=function(a,b,c,d){b=this._tracksQueries[b].insert;c=angular.extend(this.extractNewValues(c),{timestamp:d});return b.executeGetChanged(a,c)};wrm.data.sync.BridgedTupleStore.prototype.updateTracks=function(a,b,c,d,e){throw Error("Bridged association tracks cannot be updated directly");};
wrm.data.sync.BridgedTupleStore.prototype.deleteTracks=function(a,b,c){return this._tracksQueries[b]["delete"].executeGetChanged(a,c)};wrm.data.sync.CollapsedTupleStore=function(a,b,c){wrm.data.sync.AbstractTupleStore.call(this);var d=wrm.data.sync.AbstractTupleStore.TrackType;this._resolvedQueries=this._createResolvedQueries(a,c);this._unresolvedQueries=this._createAuxiliaryQueries(a,null,c);this._tracksQueries={};this._tracksQueries[d.ADDITION]=this._createAuxiliaryQueries(a,d.ADDITION,c);this._tracksQueries[d.REMOVAL]=this._createAuxiliaryQueries(a,d.REMOVAL,c);this._preferredIndex=this._computePreferredLookupServerKeyIndex(a);
this._purger=b;this._purgeRuleId=this._registerPurgeRule(a,b,c)};extendConstructor(wrm.data.sync.CollapsedTupleStore,wrm.data.sync.AbstractTupleStore);
wrm.data.sync.CollapsedTupleStore.prototype._createResolvedQueries=function(a,b){var c=wrm.data.sync.CollapsedTupleStore._findNearInfo(a),d=c.role,e=d.getEntity();a=a.getId();var f=d.getId()+"."+e.getKeyAttribute().getId(),g=d.getId()+"."+e.getServerKeyAttribute().getId(),h=d.getId()+"."+e.getKeyAttribute().getId(),k=d.getInverseRole().getId()+"."+d.getInverseEntity().getKeyAttribute().getId(),e=d.getId()+"."+e.getServerKeyAttribute().getId(),d=d.getInverseRole().getId()+"."+d.getInverseEntity().getServerKeyAttribute().getId();
c.inverted&&(c=h,h=k,k=c,c=e,e=d,d=c);c={filter:{or:[{property:f,valueInput:f==h?"key1":"key2",implied:!1},{property:g,valueInput:g==e?"serverKey1":"serverKey2",implied:!1}]}};g=b.prepareNewAssociationSelect(a,angular.extend({},{filter:[{property:h,valueInput:"key1",implied:!0},{property:k,valueInput:"key2",implied:!0},{property:e,valueInput:"serverKey1",implied:!0},{property:d,valueInput:"serverKey2",implied:!0}]},{output:{key1:h,key2:k,serverKey1:e,serverKey2:d},outputConfig:{useNames:!0}}));b=
b.prepareNewAssociationUpdate(a,angular.extend({},c,{update:function(a){var b={};h!==f&&(b[h]=a["key1.new"]);k!==f&&(b[k]=a["key2.new"]);return b}}));return{select:g,update:b}};
wrm.data.sync.CollapsedTupleStore.prototype._createAuxiliaryQueries=function(a,b,c){var d=wrm.data.sync.AbstractTupleStore.TrackType,e=wrm.data.sync.CollapsedTupleStore._findNearInfo(a),f=e.role,g=f.getEntity();a=g.getAuxiliaryEntity().getId();var h=f.getAddTimestampAuxiliaryAttribute(),k=f.getRemoveTimestampAuxiliaryAttribute(),l=g.getServerKeyAttribute().getTrackerAuxiliaryAttribute().getId(),m=g.getServerKeyAttribute().getTrackerAuxiliaryAttribute().getId(),n=f.getServerTrackerAuxiliaryAttribute().getId(),
p=g.getKeyAttribute().getTrackerAuxiliaryAttribute().getId(),q=void 0,r=h&&h.getId(),t=k&&k.getId();e.inverted&&(e=m,m=n,n=e,q=p,p=void 0);f={filter:function(){var a=[{property:m,valueInput:"serverKey1",implied:!0},{property:n,valueInput:"serverKey2",implied:!0}];r&&a.push({property:r,operator:b===d.ADDITION?"!n":"n"});t&&a.push({property:t,operator:b===d.REMOVAL?"!n":"n"});return a}()};e={filter:function(){var a=[{property:l,valueInput:l==m?"serverKey1":"serverKey2",implied:!1},{property:l==m?n:
m,valueInput:l==m?"serverKey2":"serverKey1",implied:!0}];r&&a.push({property:r,operator:b===d.ADDITION?"!n":"n"});t&&a.push({property:t,operator:b===d.REMOVAL?"!n":"n"});return a}()};g={output:{serverKey1:m,serverKey2:n}};void 0!==p?g.output.localKey1=p:g.output.localKey2=q;f=c.prepareSelect(a,angular.extend({outputConfig:{useNames:!0}},f,g));g=c.prepareNewInsert(a,function(a){var c={};void 0!==p?c[p]=a["key1.new"]:c[q]=a["key2.new"];c[m]=a["serverKey1.new"];c[n]=a["serverKey2.new"];r&&b===d.ADDITION&&
(c[r]=a.timestamp);t&&b===d.REMOVAL&&(c[t]=a.timestamp);return c});c=c.prepareNewUpdate(a,angular.extend({},e,{update:function(a){var c={};m!==l&&(c[m]=a["serverKey1.new"]);n!==l&&(c[n]=a["serverKey2.new"]);r&&b===d.ADDITION&&(c[r]=a.timestamp);t&&b===d.REMOVAL&&(c[t]=a.timestamp);return c}}));return{select:f,insert:g,update:c}};wrm.data.sync.CollapsedTupleStore.prototype._computePreferredLookupServerKeyIndex=function(a){return wrm.data.sync.CollapsedTupleStore._findNearInfo(a).inverted?2:1};
wrm.data.sync.CollapsedTupleStore.prototype._registerPurgeRule=function(a,b,c){a=wrm.data.sync.CollapsedTupleStore._findNearInfo(a).role.getEntity();if(b["_registered_collapsed_role_filters"+a.getId()])return b["_registered_collapsed_role_filters"+a.getId()];var d=[];a.getRoles().forEach(function(a){(a=a.getServerTrackerAuxiliaryAttribute())&&d.push({property:a.getId(),operator:"n"})});b["_registered_collapsed_role_filters"+a.getId()]=b.registerRule(a.getAuxiliaryEntity(),d);return b["_registered_collapsed_role_filters"+
a.getId()]};wrm.data.sync.CollapsedTupleStore._findNearInfo=function(a){var b=a.getRole1();a=a.getRole2();var c=a.isForeignKey();return{role:c?a:b,inverted:c}};wrm.data.sync.CollapsedTupleStore.prototype.getPreferredLookupServerKeyIndex=function(){return this._preferredIndex};wrm.data.sync.CollapsedTupleStore.prototype.isUpdateRequired=function(){return!0};wrm.data.sync.CollapsedTupleStore._SELECT_CHUNK_SIZE=600;
wrm.data.sync.CollapsedTupleStore.prototype.select=function(a,b,c){var d=b?this._resolvedQueries.select:this._unresolvedQueries.select;return(b=this.sliceBulkFilter(c,wrm.data.sync.CollapsedTupleStore._SELECT_CHUNK_SIZE))?Promise.map(b,function(b){return d.query(a,b)},{concurrency:this.selectConcurrency}).then(function(a){return Array.prototype.concat.apply([],a)}):Promise.resolve([])};
wrm.data.sync.CollapsedTupleStore.prototype.insert=function(a,b,c){if(b)throw Error("Collapsed resolved association tuples cannot be inserted directly");var d=this._unresolvedQueries.insert;c=this.extractNewValues(c);b||this._requirePurging();return d.executeGetChanged(a,c)};
wrm.data.sync.CollapsedTupleStore.prototype.update=function(a,b,c,d){var e=b?this._resolvedQueries.update:this._unresolvedQueries.update;c=this.extractNewValues(c);d=angular.extend({},d,c);b||this._requirePurging();return e.executeGetChanged(a,d)};wrm.data.sync.CollapsedTupleStore.prototype["delete"]=function(a,b,c){throw Error("Collapsed association tuples cannot be deleted directly");};
wrm.data.sync.CollapsedTupleStore.prototype.selectTracks=function(a,b,c){return this._tracksQueries[b].select.query(a,c)};wrm.data.sync.CollapsedTupleStore.prototype.insertTrack=function(a,b,c,d){b=this._tracksQueries[b].insert;c=angular.extend(this.extractNewValues(c),{timestamp:d});this._requirePurging();return b.executeGetChanged(a,c)};
wrm.data.sync.CollapsedTupleStore.prototype.updateTracks=function(a,b,c,d,e){b=this._tracksQueries[b].update;c=angular.extend(this.extractNewValues(c),{timestamp:d});e=angular.extend({},e,c);this._requirePurging();return b.executeGetChanged(a,e)};wrm.data.sync.CollapsedTupleStore.prototype.deleteTracks=function(a,b,c){throw Error("Collapsed association tracks cannot be deleted directly");};wrm.data.sync.CollapsedTupleStore.prototype._requirePurging=function(){this._purger.touch(this._purgeRuleId)};wrm.data.sync.AssociationPersister=function(a,b,c){this.assoc=a;this._store=wrm.data.sync.AssociationPersister._createTupleStore(a,b,c)};wrm.data.sync.AssociationPersister._createTupleStore=function(a,b,c){var d=a.getRole1(),e=a.getRole2();if(d.isForeignKey()&&e.isForeignKey())throw Error("Association has two foreign keys");return d.isForeignKey()||e.isForeignKey()?new wrm.data.sync.CollapsedTupleStore(a,b,c):new wrm.data.sync.BridgedTupleStore(a,b,c)};
wrm.data.sync.AssociationPersister.prototype.setSelectConcurrency=function(a){this._store.setSelectConcurrency(a)};wrm.data.sync.AssociationPersister.prototype.getPreferredLookupKeyIndex=function(){return this._store.getPreferredLookupServerKeyIndex()};
wrm.data.sync.AssociationPersister.prototype.select=function(a,b,c){return this.selectTuples(a,null,null,b,c).then(function(a){var b=[];a.forEach(function(a){null!==a.serverKey1&&null!==a.serverKey2&&b.push({serverKey1:a.serverKey1,serverKey2:a.serverKey2})});return b})};wrm.data.sync.AssociationPersister.prototype.add=function(a,b,c,d,e){return this.insertTuple(a,this._constructTuple(b,c,d,e))};
wrm.data.sync.AssociationPersister.prototype.remove=function(a,b,c){return this.deleteTuple(a,this._constructTuple(null,null,b,c))};wrm.data.sync.AssociationPersister.prototype.selectAdditionTracks=function(a,b,c){return this._doSelectTracks(a,wrm.data.sync.AbstractTupleStore.TrackType.ADDITION,b,c)};wrm.data.sync.AssociationPersister.prototype.selectRemovalTracks=function(a,b,c){return this._doSelectTracks(a,wrm.data.sync.AbstractTupleStore.TrackType.REMOVAL,b,c)};
wrm.data.sync.AssociationPersister.prototype._doSelectTracks=function(a,b,c,d){return this.selectTracks(a,b,null,null,c,d).then(function(a){var b=[];a.forEach(function(a){null!==a.serverKey1&&null!==a.serverKey2&&b.push({serverKey1:a.serverKey1,serverKey2:a.serverKey2})});return b})};wrm.data.sync.AssociationPersister.prototype.addAdditionTrack=function(a,b,c,d){return this._addTrack(a,wrm.data.sync.AbstractTupleStore.TrackType.ADDITION,this._constructTuple(null,null,b,c),d)};
wrm.data.sync.AssociationPersister.prototype.addRemovalTrack=function(a,b,c,d){return this._addTrack(a,wrm.data.sync.AbstractTupleStore.TrackType.REMOVAL,this._constructTuple(null,null,b,c),d)};wrm.data.sync.AssociationPersister.prototype.removeAdditionTrack=function(a,b,c){return this._removeTrack(a,wrm.data.sync.AbstractTupleStore.TrackType.ADDITION,this._constructTuple(null,null,b,c))};
wrm.data.sync.AssociationPersister.prototype.removeRemovalTrack=function(a,b,c){return this._removeTrack(a,wrm.data.sync.AbstractTupleStore.TrackType.REMOVAL,this._constructTuple(null,null,b,c))};wrm.data.sync.AssociationPersister.prototype._addTrack=function(a,b,c,d){var e=wrm.data.sync.AbstractTupleStore.TrackType,f=this;return this.deleteTrack(a,b===e.ADDITION?e.REMOVAL:e.ADDITION,c).then(function(e){if(!e)return f.insertTrack(a,b,c,d)})};
wrm.data.sync.AssociationPersister.prototype._removeTrack=function(a,b,c){return this.deleteTrack(a,b,c)};wrm.data.sync.AssociationPersister.prototype._constructTuple=function(a,b,c,d){return{key1:void 0!==a?a:null,key2:void 0!==b?b:null,serverKey1:void 0!==c?c:null,serverKey2:void 0!==d?d:null}};
wrm.data.sync.AssociationPersister.prototype.selectTuples=function(a,b,c,d,e,f){var g=this,h=this._store,k={list:[],map:{}},l=this._prepareFilterForKeys(b,c,d,e);b=Promise.resolve();!1!==f&&(b=b.then(function(){return h.select(a,!0,l).then(function(a){a.forEach(function(a){g._extractAndMergeTupleFromResultValues(k,a)})})}));!0!==f&&(b=b.then(function(){return h.select(a,!1,l).then(function(a){a.forEach(function(a){g._extractAndMergeTupleFromResultValues(k,a)})})}));return b.then(function(){return k.list})};
wrm.data.sync.AssociationPersister.prototype._extractAndMergeTupleFromResultValues=function(a,b){var c=this._extractTupleFromResultValues(b),d=b=null,e=null;null!==c.serverKey1&&null!==c.serverKey2&&(b=String(c.serverKey1)+"###"+String(c.serverKey2),d=a.map[b],void 0===d?(a.list.push(c),d=a.list.length-1,a.map[b]=d,e=null):e=a.list[d]);e&&Object.keys(e).forEach(function(a){var b=e[a],d=c[a];if(null===d||void 0===d)c[a]=b});null!==d?a.list[d]=c:a.list.push(c)};
wrm.data.sync.AssociationPersister.prototype.updateTuple=function(a,b,c){var d=this._store,e=this._isResolvedTuple(b),f=this._isResolvedTuple(c);if(e!==f)return this.insertTuple(a,c);var g=this._prepareValuesForTuple(c);b=this._prepareFilterForTuple(b);return d.isUpdateRequired()?d.update(a,e,g,b):d["delete"](a,e,b).then(function(){return d.insert(a,e,g)})};
wrm.data.sync.AssociationPersister.prototype.insertTuple=function(a,b){var c=this,d=this._store,e=this._isResolvedTuple(b);return this.deleteTuple(a,b,!e).then(function(){var f=c._prepareValuesForTuple(b);if(d.isUpdateRequired()){var g=c._prepareFilterForTuple(b);return d.update(a,e,f,g).then(function(b){if(!b)return d.insert(a,e,f)})}return d.insert(a,e,f)})};
wrm.data.sync.AssociationPersister.prototype.deleteTuple=function(a,b,c){var d=this._store,e=this._prepareFilterForTuple(b);return Promise.all((void 0!==c?[c]:[!0,!1]).map(function(b){return d.isUpdateRequired()?d.update(a,b,{key1:null,key2:null,serverKey1:null,serverKey2:null},e):d["delete"](a,b,e)}))};wrm.data.sync.AssociationPersister.prototype._isResolvedTuple=function(a){return null!==a.key1&&null!==a.key2};
wrm.data.sync.AssociationPersister.prototype.selectTracks=function(a,b,c,d,e,f){var g=this,h=this._store;c=this._prepareValuesForKeys(c,d,e,f);return h.selectTracks(a,b,c).then(function(a){return a.map(function(a){return g._extractTupleFromResultValues(a)})})};
wrm.data.sync.AssociationPersister.prototype.insertTrack=function(a,b,c,d){var e=this._store,f=this._prepareValuesForTuple(c);return e.isUpdateRequired()?(c=this._prepareFilterForTuple(c),e.updateTracks(a,b,f,d,c).then(function(c){if(!c)return e.insertTrack(a,b,f,d)})):e.insertTrack(a,b,f,d)};
wrm.data.sync.AssociationPersister.prototype.deleteTrack=function(a,b,c){var d=this._store;c=this._prepareFilterForTuple(c);return d.isUpdateRequired()?d.updateTracks(a,b,{key1:null,key2:null,serverKey1:null,serverKey2:null},null,c):d.deleteTracks(a,b,c)};wrm.data.sync.AssociationPersister.prototype._extractTupleFromResultValues=function(a){return{key1:a.key1||null,key2:a.key2||null,serverKey1:a.serverKey1||null,serverKey2:a.serverKey2||null}};
wrm.data.sync.AssociationPersister.prototype._prepareValuesForTuple=function(a){return{key1:a.key1,key2:a.key2,serverKey1:a.serverKey1,serverKey2:a.serverKey2}};wrm.data.sync.AssociationPersister.prototype._prepareValuesForKeys=function(a,b,c,d){return{key1:null!==a?a:void 0,key2:null!==b?b:void 0,serverKey1:null!==c?c:void 0,serverKey2:null!==d?d:void 0}};
wrm.data.sync.AssociationPersister.prototype._prepareFilterForKeys=function(a,b,c,d){return{key1:null!==a?a:void 0,key2:null!==b?b:void 0,serverKey1:null!==c?c:void 0,serverKey2:null!==d?d:void 0}};wrm.data.sync.AssociationPersister.prototype._prepareFilterForTuple=function(a){return{key1:null!==a.key1?a.key1:void 0,key2:null!==a.key2?a.key2:void 0,serverKey1:null!==a.serverKey1?a.serverKey1:void 0,serverKey2:null!==a.serverKey2?a.serverKey2:void 0}};wrm.util.ListProcessor=function(){this._list=[];this._processors=[];this._allIndexesToProcess=[];this._processed=this._finalizer=null};wrm.util.ListProcessor.prototype.registerValueProcessor=function(a,b,c,d){if(0<this._list.length)throw Error("Cannot register processors after adding elements");this._processors.push(new wrm.util.ListProcessor._Processor(this,a,b,c,d))};
wrm.util.ListProcessor.prototype.registerFinalizer=function(a){if(this._finalizer)throw Error("Finalizer already registered");this._finalizer=a};wrm.util.ListProcessor.prototype.add=function(a){if(null!==this._processed)throw Error("Cannot add element after processing has started");this._list.push(a);for(var b=this._list.length-1,c=!1,d=0;d<this._processors.length;d++)c=this._processors[d].enlist(a,b)||c;c&&this._allIndexesToProcess.push(b)};
wrm.util.ListProcessor.prototype.addAll=function(a){for(var b=0;b<a.length;b++)this.add(a[b])};wrm.util.ListProcessor.prototype.process=function(){if(null!==this._processed)throw Error("Cannot start another processing");this._processed=!1;return this._doProcess().then(function(){this._processed=!0;return this._list}.bind(this))};
wrm.util.ListProcessor.prototype._doProcess=function(){return 0>=this._allIndexesToProcess.length?Promise.resolve():Promise.all(this._processors.map(function(a){return a.process()})).then(function(){var a=this._finalizer;if(a)for(var b=0;b<this._allIndexesToProcess.length;b++){var c=this._allIndexesToProcess[b],d=a(this._list[c]);void 0!==d&&(this._list[c]=d)}}.bind(this))};
wrm.util.ListProcessor._Processor=function(a,b,c,d,e){this._parent=a;this._valueGetter=b;this._bulkProcessor=c;this._originalValueMatcher=d;this._valueSetter=e;this._indexesByValue={}};wrm.util.ListProcessor._Processor.prototype.enlist=function(a,b){a=this._valueGetter(a);if(void 0!==a){var c=this._indexesByValue[a];c||(this._indexesByValue[a]=c=[]);c.push(b);return!0}return!1};
wrm.util.ListProcessor._Processor.prototype.process=function(){var a=Object.keys(this._indexesByValue);if(0>=a.length)return Promise.resolve();var b=this._parent._list;return Promise.resolve(this._bulkProcessor(a)).then(function(a){for(var d=0;d<a.length;d++){var e=a[d],f=this._originalValueMatcher(e);if(void 0!==f){f=this._indexesByValue[f];if(DEBUG&&!f)throw Error("Unknown value: check values providers, setter, and values processor.");for(var g=0;g<f.length;g++)this._valueSetter(b[f[g]],e)}}}.bind(this))};wrm.data.sync.AssociationResolvingPersister=function(a,b,c,d){wrm.data.sync.AssociationPersister.call(this,a,c,d);this._keyResolver=b;this._selectConcurrency=Infinity};extendConstructor(wrm.data.sync.AssociationResolvingPersister,wrm.data.sync.AssociationPersister);wrm.data.sync.AssociationResolvingPersister.prototype.setSelectConcurrency=function(a){wrm.data.sync.AssociationResolvingPersister._super.setSelectConcurrency.call(this,a);this._selectConcurrency=a};
wrm.data.sync.AssociationResolvingPersister.prototype.resolve=function(a,b){var c=this,d=0;return this.selectTuples(a,null,null,null,null,!1).then(function(e){return c._resolveTuples(a,e).then(function(f){return Promise.map(e,function(b,e){if(e=f[e])return d++,c.updateTuple(a,b,e)},{concurrency:b})})}).then(function(){return d})};
wrm.data.sync.AssociationResolvingPersister.prototype.updateTuple=function(a,b,c){c=this._resolveTupleFromCache(c)||c;return wrm.data.sync.AssociationResolvingPersister._super.updateTuple.call(this,a,b,c)};
wrm.data.sync.AssociationResolvingPersister.prototype._resolveTuples=function(a,b){var c=this,d=this._keyResolver,e=this.assoc,f=new wrm.util.ListProcessor;f.registerValueProcessor(function(a){if(null!==a&&null===a.key1)return String(a.serverKey1)},function(b){var f=e.getRole1().getEntity();return d.resolveAll(a,f,b,c._selectConcurrency)},function(a){if(null!==a.key)return a.serverKey},function(a,b){a.key1=b.key});f.registerValueProcessor(function(a){if(null!==a&&null===a.key2)return String(a.serverKey2)},
function(b){var f=e.getRole2().getEntity();return d.resolveAll(a,f,b,c._selectConcurrency)},function(a){if(null!==a.key)return a.serverKey},function(a,b){a.key2=b.key});f.registerFinalizer(function(a){if(null===a.key1||null===a.key2)return null});b.forEach(function(a,b){null!==a.key1&&null!==a.key2?f.add(null):null===a.serverKey1||null===a.serverKey2?f.add(null):f.add(angular.extend({},a))});return f.process()};
wrm.data.sync.AssociationResolvingPersister.prototype._resolveTupleFromCache=function(a){var b=null!==a.key1,c=null!==a.key2;if(b&&c)return null;var d=this.assoc.getRole1().getEntity(),e=this.assoc.getRole2().getEntity(),b=b?null:this._keyResolver.resolveFromCache(d,a.serverKey1),c=c?null:this._keyResolver.resolveFromCache(e,a.serverKey2);return null===b&&null===c?null:{key1:null!==b?b:a.key1,key2:null!==c?c:a.key2,serverKey1:a.serverKey1,serverKey2:a.serverKey2}};wrm.data.sync.AssociationAligner=function(a,b,c,d){this._assoc=a;this._persister=new wrm.data.sync.AssociationResolvingPersister(a,b,c,d);c=null;a.getRole1().isForeignKey()&&a.getRole1().getServerName()?c=a.getRole1():a.getRole2().isForeignKey()&&a.getRole2().getServerName()&&(c=a.getRole2());this._inlinedRole=c;this._keyResolver=b;this._selectConcurrency=Infinity;this._desiredPairings1={};this._desiredPairings2={};this._deletedPairings=[]};
wrm.data.sync.AssociationAligner.prototype.getAssociation=function(){return this._assoc};wrm.data.sync.AssociationAligner.prototype.setSelectConcurrency=function(a){this._persister.setSelectConcurrency(a);this._selectConcurrency=a};wrm.data.sync.AssociationAligner.prototype.createdRecord=function(a,b){this._trackDesiredRecord(a,b)};wrm.data.sync.AssociationAligner.prototype.updatedRecord=function(a,b){this._trackDesiredRecord(a,b)};
wrm.data.sync.AssociationAligner.prototype._trackDesiredRecord=function(a,b){var c=this._assoc.getRole1().getEntity(),d=this._assoc.getRole2().getEntity(),e;if(c===a)e=this._assoc.getRole1(),d=this._desiredPairings1,c=this._desiredPairings2;else if(d===a)e=this._assoc.getRole2(),d=this._desiredPairings2,c=this._desiredPairings1;else return;a=a.getServerKeyAttribute().getServerName();e=e.getServerName();if(void 0!==b[e])for(a=wrm.data.toAnySingle(b[a]),b=wrm.data.toAnyArray(b[e]),(e=d[a])||(d[a]=e=
{}),d=0;d<b.length;d++){var f=b[d];e[f]=!0;(f=c[f])&&(f[a]=!0)}};
wrm.data.sync.AssociationAligner.prototype.deletedRecord=function(a,b){var c=this._assoc.getRole1().getEntity(),d=this._assoc.getRole2().getEntity();if(null!==b){if(c===a)a={serverKey1:b,serverKey2:null};else if(d===a)a={serverKey1:null,serverKey2:b};else return;if(null!==a.serverKey1)for(this._desiredPairings1[a.serverKey1]={},b=Object.keys(this._desiredPairings2),c=0;c<b.length;c++)(d=this._desiredPairings2[b[c]])&&delete d[a.serverKey1];else for(this._desiredPairings2[a.serverKey2]={},b=Object.keys(this._desiredPairings1),
c=0;c<b.length;c++)(d=this._desiredPairings1[b[c]])&&delete d[a.serverKey2];this._deletedPairings.push(a)}};wrm.data.sync.AssociationAligner.prototype.reset=function(){this._desiredPairings1={};this._desiredPairings2={};this._deletedPairings=[]};
wrm.data.sync.AssociationAligner.prototype.resolveInlineKeyValues=function(a,b,c){var d=this,e=this._keyResolver,f=this._inlinedRole;if(!f||f.getEntity()!==b)return Promise.resolve();var g=f.getId(),h=f.getServerName();b=new wrm.util.ListProcessor;b.registerValueProcessor(function(a){a=a[h];if(null!==a&&void 0!==a)return String(a)},function(b){var c=f.getInverseEntity();return e.resolveAll(a,c,b,d._selectConcurrency)},function(a){if(null!==a.key)return a.serverKey},function(a,b){var c=a.__INLINE_KEYS;
c||(a.__INLINE_KEYS=c={});c[g]=b.key});b.addAll(c);return b.process()};
wrm.data.sync.AssociationAligner.prototype.save=function(a,b,c){var d=this,e=this._deletePairings(a,this._deletedPairings,c).then(function(){d._deletedPairings=[]}),e=e.then(function(){var e=Object.keys(d._desiredPairings1);return d._selectCurrentTuples(a,1,e).then(function(g){return d._alignToDesiredPairings(a,g,1,e,d._desiredPairings1,b,c)})}).then(function(){d._desiredPairings1={}});return e.then(function(){var e=Object.keys(d._desiredPairings2);return d._selectCurrentTuples(a,2,e).then(function(g){return d._alignToDesiredPairings(a,
g,2,e,d._desiredPairings2,b,c)})}).then(function(){d._desiredPairings2={}})};wrm.data.sync.AssociationAligner.prototype._deletePairings=function(a,b,c){var d=this._persister;return Promise.all(b.map(function(b){return d.remove(a,b.serverKey1,b.serverKey2).then(function(){c.disconnected++})}))};
wrm.data.sync.AssociationAligner.prototype._alignToDesiredPairings=function(a,b,c,d,e,f,g){var h=this,k={};b.forEach(function(a){var b=String(1===c?a.serverKey1:a.serverKey2);if(e[b]){var d=k[b];d||(k[b]=d=[]);d.push(1===c?a.serverKey2:a.serverKey1)}},this);var l=[],m=[];d.forEach(function(a){var b=k[a]||[],c=Object.keys(e[a]),b=wrm.util.obj.findValuesDiff(b,c);b.removed.forEach(function(b){l.push({nearServerKey:a,farServerKey:b})},this);b.added.forEach(function(b){m.push({nearServerKey:a,farServerKey:b})},
this)});return Promise.resolve().then(function(){return h._doRemoveTuples(a,c,l,f)}).then(function(){return h._doAddTuples(a,c,m,f)}).then(function(){g.disconnected+=l.length;g.connected+=m.length})};
wrm.data.sync.AssociationAligner.prototype._selectCurrentTuples=function(a,b,c){var d=this,e=this._assoc;return this._persister.select(a,1===b?c:null,2===b?c:null).then(function(b){var c=new wrm.util.ListProcessor;c.registerValueProcessor(function(a){if(null!==a.serverKey1)return String(a.serverKey1)},function(b){var c=e.getRole1().getEntity();return wrm.data.sync.findAllKeys(a,c,b,d._selectConcurrency)},function(a){return a.serverKey},function(a,b){null===b.key&&(a.serverKey1=null)});c.registerValueProcessor(function(a){if(null!==
a.serverKey2)return String(a.serverKey2)},function(b){var c=e.getRole2().getEntity();return wrm.data.sync.findAllKeys(a,c,b,d._selectConcurrency)},function(a){return a.serverKey},function(a,b){null===b.key&&(a.serverKey2=null)});c.addAll(b);return c.process()}).then(function(a){return a.filter(function(a){return null!==a.serverKey1&&null!==a.serverKey2})})};
wrm.data.sync.AssociationAligner.prototype._doAddTuples=function(a,b,c,d){var e=this,f=this._assoc,g=this._keyResolver,h=this._persister,k=new wrm.util.ListProcessor;k.registerValueProcessor(function(a){if(null!==a.serverKey1)return String(a.serverKey1)},function(b){var c=f.getRole1().getEntity();return g.resolveAll(a,c,b,e._selectConcurrency)},function(a){if(null!==a.key)return a.serverKey},function(a,b){a.key1=b.key});k.registerValueProcessor(function(a){if(null!==a.serverKey2)return String(a.serverKey2)},
function(b){var c=f.getRole2().getEntity();return g.resolveAll(a,c,b,e._selectConcurrency)},function(a){if(null!==a.key)return a.serverKey},function(a,b){a.key2=b.key});c.forEach(function(a){k.add({key1:null,key2:null,serverKey1:1===b?a.nearServerKey:a.farServerKey,serverKey2:2===b?a.nearServerKey:a.farServerKey})});return k.process().then(function(b){return Promise.map(b,function(b){return h.add(a,b.key1,b.key2,b.serverKey1,b.serverKey2)},{concurrency:d})})};
wrm.data.sync.AssociationAligner.prototype._doRemoveTuples=function(a,b,c,d){var e=this._persister;return Promise.map(c,function(c){return e.remove(a,1===b?c.nearServerKey:c.farServerKey,2===b?c.nearServerKey:c.farServerKey)},{concurrency:d})};wrm.data.sync.AssociationAligner.prototype.align=function(a,b,c){return this._persister.resolve(a,b).then(function(a){c.aligned+=a})};wrm.data.sync.AssociationSetAligner=function(a){this._aligners=a};wrm.data.sync.AssociationSetAligner.prototype.getAligners=function(){return this._aligners};wrm.data.sync.AssociationSetAligner.prototype.setSelectConcurrency=function(a){this._aligners.forEach(function(b){b.setSelectConcurrency(a)})};wrm.data.sync.AssociationSetAligner.prototype.createdRecord=function(a,b){return this._aligners.forEach(function(c){c.createdRecord(a,b)})};
wrm.data.sync.AssociationSetAligner.prototype.updatedRecord=function(a,b){return this._aligners.forEach(function(c){c.updatedRecord(a,b)})};wrm.data.sync.AssociationSetAligner.prototype.deletedRecord=function(a,b){return this._aligners.forEach(function(c){c.deletedRecord(a,b)})};wrm.data.sync.AssociationSetAligner.prototype.resolveKeys=function(a,b,c){return Promise.all(this._aligners.map(function(d){return d.resolveInlineKeyValues(a,b,c)},this))};
wrm.data.sync.AssociationSetAligner.prototype.reset=function(){return this._aligners.forEach(function(a){a.reset()})};wrm.data.sync.AssociationSetAligner.prototype.saveAndAlign=function(a,b,c){return this._aligners.reduce(function(d,e){return d.then(function(){return e.save(a,b,c)})})};wrm.data.sync.AssociationSetAligner.prototype.align=function(a,b,c){return this._aligners.reduce(function(d,e){return d.then(function(){return e.align(a,b,c)})})};wrm.data.sync.AssociationSyncStats=function(){this.aligned=this.disconnected=this.connected=0};wrm.data.sync.AssociationSyncStats.prototype.hasChanges=function(){return 0<this.connected||0<this.disconnected||0<this.aligned};wrm.data.sync.AssociationSyncStats.prototype.toString=function(){return"{connected: "+this.connected+", disconnected: "+this.disconnected+", aligned: "+this.aligned+"}"};wrm.data.sync.AssociationTracker=function(a,b,c){this._assoc=a;this._persister=new wrm.data.sync.AssociationPersister(a,b,c)};wrm.data.sync.AssociationTracker.isRelevantAssociation=function(a){var b=a.getRole1();a=a.getRole2();return!!b.getAddTimestampAuxiliaryAttribute()||!!b.getRemoveTimestampAuxiliaryAttribute()||!!a.getAddTimestampAuxiliaryAttribute()||!!a.getRemoveTimestampAuxiliaryAttribute()};
wrm.data.sync.AssociationTracker.prototype.trackClientAdd=function(a,b,c){return this._persister.addAdditionTrack(a,b,c,wrm.data.DateTime.now())};wrm.data.sync.AssociationTracker.prototype.trackClientRemove=function(a,b,c){return this._persister.addRemovalTrack(a,b,c,wrm.data.DateTime.now())};wrm.data.sync.AssociationTracker.prototype.collectAdditions=function(a,b,c){return this._persister.selectAdditionTracks(a,b,c)};
wrm.data.sync.AssociationTracker.prototype.settleAddition=function(a,b){return this._persister.removeAdditionTrack(a,b.serverKey1,b.serverKey2)};wrm.data.sync.AssociationTracker.prototype.collectRemovals=function(a,b,c){return this._persister.selectRemovalTracks(a,b,c)};wrm.data.sync.AssociationTracker.prototype.settleRemoval=function(a,b){return this._persister.removeRemovalTrack(a,b.serverKey1,b.serverKey2)};wrm.data.sync.EntityTracksPersister=function(a,b,c){this._entity=a;var d=this._createMainQueries(a,c);c=this._createAuxiliaryQueries(a,c);this._mainSelect=d&&d.selectQuery;this._mainSelectCreated=d&&d.selectCreatedQuery;this._mainSelectUpdated=d&&d.selectUpdatedQuery;this._mainUpdate=d&&d.updateQuery;this._auxSelectUpdate=c&&c.selectUpdatedQuery;this._auxSelectDelete=c&&c.selectDeleteQuery;this._auxInsert=c&&c.insertQuery;this._auxUpdate=c&&c.updateQuery;this._purger=b;this._purgeRuleId=this._registerPurgeRule(a,
b)};
wrm.data.sync.EntityTracksPersister.prototype._createMainQueries=function(a,b){var c=a.getCreateTimestampAttribute(),d=a.getUpdateTimestampAttribute();if(!c&&!d)return null;var e=a.getId(),f=a.getKeyAttribute().getId();a=a.getServerKeyAttribute().getId();var g=c&&c.getId(),h=d&&d.getId(),c={key:f,serverKey:a};g&&(c.createdAt=g);h&&(c.updatedAt=h);c=b.prepareSelect(e,{output:c,outputConfig:{useNames:!0},filter:[{property:f,valueInput:"key"}]});d=g&&b.prepareSelect(e,{output:{key:f,serverKey:a},outputConfig:{useNames:!0},
filter:[{property:g,operator:"!n"}]});a=h&&b.prepareSelect(e,{output:{key:f,serverKey:a},outputConfig:{useNames:!0},filter:[{property:h,operator:"!n"}]});b=b.prepareUpdate(e,{update:function(a){var b={};g&&void 0!==a.createdAt&&(b[g]=a.createdAt||null);h&&void 0!==a.updatedAt&&(b[h]=a.updatedAt||null);return b},filter:[{property:f,valueInput:"key"}]});return{selectQuery:c,selectCreatedQuery:d,selectUpdatedQuery:a,updateQuery:b}};
wrm.data.sync.EntityTracksPersister.prototype._createAuxiliaryQueries=function(a,b){var c=a.getAuxiliaryEntity();if(!c)return null;var d=a.getKeyAttribute().getTrackerAuxiliaryAttribute(),e=a.getServerKeyAttribute().getTrackerAuxiliaryAttribute(),f=a.getDirtyAuxiliaryAttribute(),g=a.getDeleteTimestampAuxiliaryAttribute();if(!f)return null;var c=c.getId(),h=d.getId(),k=e.getId(),l=f.getId(),m=g&&g.getId(),n={},p={},q={};a.getAttributes().forEach(function(a){var b=a.getDirtyAuxiliaryAttribute();b&&
(n[b.getId()]=null,p["dirty_"+a.getId()]=b.getId(),q["dirty_"+a.getId()]=b.getId())});var r=function(a){var b={};b[l]=!0;m&&void 0!==a.deletedAt&&(b[m]=a.deletedAt);a.dirtyAttrsMerge||angular.extend(b,n);Object.keys(a).forEach(function(c){var d=p[c];d&&(b[d]=!!a[c])});return b},f={filter:[{property:l,value:!0}]};a=b.prepareSelect(c,angular.extend({},f,{output:angular.extend({key:h,serverKey:k},q),outputConfig:{useNames:!0},filter:[{property:h,valueInput:"key"},{property:l,value:!0}]}));d=m&&b.prepareSelect(c,
angular.extend({},f,{output:{key:h,serverKey:k},outputConfig:{useNames:!0},filter:[{property:m,operator:"!n"},{property:l,value:!0}]}));e=b.prepareInsert(c,function(a){var b=r(a);b[h]=a.key;b[k]=a.serverKey;return b});b=b.prepareUpdate(c,angular.extend({},f,{update:function(a){return r(a)},filter:[{property:h,valueInput:"key"},{property:l,value:!0}]}));return{selectUpdatedQuery:a,selectDeleteQuery:d,insertQuery:e,updateQuery:b}};
wrm.data.sync.EntityTracksPersister.prototype._registerPurgeRule=function(a,b){var c=a.getAuxiliaryEntity();if(!c)return null;var d=[],e=a.getDeleteTimestampAuxiliaryAttribute();e&&d.push({property:e.getId(),operator:"n"});a.getAttributes().forEach(function(a){(a=a.getDirtyAuxiliaryAttribute())&&d.push({property:a.getId(),operator:"!eq",value:!0})});return b.registerRule(c,d)};
wrm.data.sync.EntityTracksPersister.prototype.selectOneCreateTrack=function(a){return this._selectOneCreatedMainRowPossible()?this._selectOneCreatedMainRow(a):Promise.resolve(null)};
wrm.data.sync.EntityTracksPersister.prototype.selectOneUpdateTrack=function(a){var b=this;return this._selectOneUpdatedMainRowPossible()&&this._selectUpdatedAuxiliaryRowPossible()?b._selectOneUpdatedMainRow(a).then(function(c){return c?b._selectUpdatedAuxiliaryRow(c.key,a).then(function(a){return a?{key:a.key,serverKey:a.serverKey,attributes:a.dirtyAttrs}:{key:c.key,serverKey:c.serverKey,attributes:[]}}):null}):Promise.resolve(null)};
wrm.data.sync.EntityTracksPersister.prototype.selectOneDeleteTrack=function(a){return this._selectOneDeletedAuxiliaryRowPossible()?this._selectOneDeletedAuxiliaryRow(a):Promise.resolve(null)};
wrm.data.sync.EntityTracksPersister.prototype.addCreateTrack=function(a,b,c,d){var e=this;return this._updateMainRowPossible()||this._createOrUpdateAuxiliaryRowPossible()?e._updateMainRow(b,{createdAt:d,updatedAt:null},a).then(function(d){if(d)return e._createOrUpdateAuxiliaryRow(b,c,{deletedAt:null,dirtyAttrs:[]},a)}):Promise.resolve()};
wrm.data.sync.EntityTracksPersister.prototype.addUpdateTrack=function(a,b,c,d,e){var f=this;return this._updateMainRowPossible()||this._createOrUpdateAuxiliaryRowPossible()?f._selectMainRow(b,a).then(function(g){if(!g||!g.createdAt)return f._updateMainRow(b,{createdAt:null,updatedAt:d},a).then(function(d){if(d)return f._createOrUpdateAuxiliaryRow(b,c,{deletedAt:null,dirtyAttrs:e,dirtyAttrsMerge:!0},a)})}):Promise.resolve()};
wrm.data.sync.EntityTracksPersister.prototype.addDeleteTrack=function(a,b,c,d){return this._createOrUpdateAuxiliaryRowPossible()?this._createOrUpdateAuxiliaryRow(b,c,{deletedAt:d,dirtyAttrs:[]},a):Promise.resolve()};wrm.data.sync.EntityTracksPersister.prototype.removeCreateTracks=function(a,b){return this._updateMainRowPossible()?this._updateMainRow(b,{createdAt:null},a):Promise.resolve()};
wrm.data.sync.EntityTracksPersister.prototype.removeUpdateTracks=function(a,b){var c=this;return this._updateMainRowPossible()||this._createOrUpdateAuxiliaryRowPossible()?c._updateMainRow(b,{updatedAt:null},a).then(function(d){if(d)return c._createOrUpdateAuxiliaryRow(b,null,{dirtyAttrs:[]},a)}):Promise.resolve()};
wrm.data.sync.EntityTracksPersister.prototype.removeDeleteTracks=function(a,b){return this._createOrUpdateAuxiliaryRowPossible()?this._createOrUpdateAuxiliaryRow(b,null,{deletedAt:null},a):Promise.resolve()};wrm.data.sync.EntityTracksPersister.prototype._selectMainRowPossible=function(){return!!this._mainSelect};
wrm.data.sync.EntityTracksPersister.prototype._selectMainRow=function(a,b){var c=this._mainSelect;return c?c.queryOne(b,{key:a}).then(function(a){return a?{key:a.key,serverKey:a.serverKey,createdAt:a.createdAt||null,updatedAt:a.updatedAt||null}:null}):Promise.resolve(null)};wrm.data.sync.EntityTracksPersister.prototype._selectOneCreatedMainRowPossible=function(){return!!this._mainSelectCreated};
wrm.data.sync.EntityTracksPersister.prototype._selectOneCreatedMainRow=function(a){var b=this._mainSelectCreated;return b?b.queryOne(a).then(function(a){return a?{key:a.key,serverKey:a.serverKey}:null}):Promise.resolve(null)};wrm.data.sync.EntityTracksPersister.prototype._selectOneUpdatedMainRowPossible=function(){return!!this._mainSelectUpdated};
wrm.data.sync.EntityTracksPersister.prototype._selectOneUpdatedMainRow=function(a){var b=this._mainSelectUpdated;return b?b.queryOne(a).then(function(a){return a?{key:a.key,serverKey:a.serverKey}:null}):Promise.resolve(null)};wrm.data.sync.EntityTracksPersister.prototype._updateMainRowPossible=function(){return!!this._mainUpdate};
wrm.data.sync.EntityTracksPersister.prototype._updateMainRow=function(a,b,c){var d=this._mainUpdate;return d?d.execute(c,{key:a,createdAt:b.createdAt,updatedAt:b.updatedAt}).then(function(a){return 0<a.length}):Promise.resolve(!0)};wrm.data.sync.EntityTracksPersister.prototype._selectUpdatedAuxiliaryRowPossible=function(){return!!this._auxSelectUpdate};
wrm.data.sync.EntityTracksPersister.prototype._selectUpdatedAuxiliaryRow=function(a,b){var c=this._entity,d=this._auxSelectUpdate;return d?d.queryOne(b,{key:a}).then(function(a){if(!a)return null;var b=[];c.getAttributes().forEach(function(c){a["dirty_"+c.getId()]&&b.push(c)});return{key:a.key,serverKey:a.serverKey,dirtyAttrs:b}}):Promise.resolve(null)};wrm.data.sync.EntityTracksPersister.prototype._selectOneDeletedAuxiliaryRowPossible=function(){return!!this._auxSelectDelete};
wrm.data.sync.EntityTracksPersister.prototype._selectOneDeletedAuxiliaryRow=function(a){var b=this._auxSelectDelete;return b?b.queryOne(a).then(function(a){return a?{key:a.key,serverKey:a.serverKey}:null}):Promise.resolve(null)};wrm.data.sync.EntityTracksPersister.prototype._createOrUpdateAuxiliaryRowPossible=function(){return!!this._auxInsert||!!this._auxUpdate};
wrm.data.sync.EntityTracksPersister.prototype._createOrUpdateAuxiliaryRow=function(a,b,c,d){var e=this._auxInsert,f=this._auxUpdate;if(!e&&!f)return Promise.resolve();this._requirePurging();var g=Promise.resolve(),h={key:a,serverKey:b,deletedAt:c.deletedAt};c.dirtyAttrs&&c.dirtyAttrs.forEach(function(a){h["dirty_"+a.getId()]=!0});f&&(g=g.then(function(){return f.execute(d,angular.extend({},h,{dirtyAttrsMerge:c.dirtyAttrsMerge}))}).then(function(a){return 0<a.length}));e&&(c.deletedAt||c.dirtyAttrs&&
0<c.dirtyAttrs.length)&&(g=g.then(function(a){if(!a)return e.execute(d,h)}));return g};wrm.data.sync.EntityTracksPersister.prototype._requirePurging=function(){this._purgeRuleId&&this._purger.touch(this._purgeRuleId)};wrm.data.sync.EntityTracker=function(a,b,c){this._entity=a;this._persister=new wrm.data.sync.EntityTracksPersister(a,b,c)};wrm.data.sync.EntityTracker.isRelevantEntity=function(a){if(!(a instanceof wrm.data.meta.RegularEntity))return!1;var b=a.getCreateTimestampAttribute(),c=a.getUpdateTimestampAttribute();a=a.getDeleteTimestampAuxiliaryAttribute();return!!b||!!c||!!a};wrm.data.sync.EntityTracker.prototype.trackClientCreate=function(a,b,c){return this._persister.addCreateTrack(a,b,c,wrm.data.DateTime.now())};
wrm.data.sync.EntityTracker.prototype.trackClientUpdate=function(a,b,c,d){return this._persister.addUpdateTrack(a,b,c,wrm.data.DateTime.now(),d)};wrm.data.sync.EntityTracker.prototype.trackClientDelete=function(a,b,c){return this._persister.addDeleteTrack(a,b,c,wrm.data.DateTime.now())};
wrm.data.sync.EntityTracker.prototype.collectNextCreate=function(a){function b(){return d.selectOneCreateTrack(a).then(function(d){return d?c._fetchAttributeValues(a,d.key).then(function(f){var g={key:d.key,serverKey:d.serverKey,attributeValues:f};return f?g:c.settleCreate(a,g).then(function(){return b()})}):null})}var c=this,d=this._persister;return b()};wrm.data.sync.EntityTracker.prototype.settleCreate=function(a,b){return this._persister.removeCreateTracks(a,b.key)};
wrm.data.sync.EntityTracker.prototype.collectNextUpdate=function(a){function b(){return d.selectOneUpdateTrack(a).then(function(d){return d?c._fetchAttributeValues(a,d.key,d.attributes).then(function(f){var g={key:d.key,serverKey:d.serverKey,attributeValues:f};return f?g:c.settleUpdate(a,g).then(function(){return b()})}):null})}var c=this,d=this._persister;return b()};wrm.data.sync.EntityTracker.prototype.settleUpdate=function(a,b){return this._persister.removeUpdateTracks(a,b.key)};
wrm.data.sync.EntityTracker.prototype.collectNextDelete=function(a){return this._persister.selectOneDeleteTrack(a).then(function(a){return a?{key:a.key,serverKey:a.serverKey,serverRecord:null}:null})};wrm.data.sync.EntityTracker.prototype.settleDelete=function(a,b){return this._persister.removeDeleteTracks(a,b.key)};
wrm.data.sync.EntityTracker.prototype._fetchAttributeValues=function(a,b,c){var d=this._entity,e={};(c||d.getAttributes()).forEach(function(a){a=a.getId();e[a]=a});return a.selectOne(d.getId(),{output:e,outputConfig:{useNames:!0},filter:[{property:d.getKeyAttribute().getId()}]},[b])};wrm.data.Query=function(){};exportSymbol("wrm.data.Query",wrm.data.Query);wrm.data.Query.prototype.getBaseElement=function(){};exportProperty(wrm.data.Query.prototype,"getBaseElement",wrm.data.Query.prototype.getBaseElement);wrm.data.DeleteQuery=function(){};exportSymbol("wrm.data.DeleteQuery",wrm.data.DeleteQuery);exportProperty(wrm.data.DeleteQuery,"Options",wrm.data.DeleteQuery.Options);wrm.data.SelectQuery=function(){};exportSymbol("wrm.data.SelectQuery",wrm.data.SelectQuery);exportProperty(wrm.data.SelectQuery,"OutputConfig",wrm.data.SelectQuery.OutputConfig);exportProperty(wrm.data.SelectQuery,"Options",wrm.data.SelectQuery.Options);wrm.data.QueryFactory=function(){};exportSymbol("wrm.data.QueryFactory",wrm.data.QueryFactory);wrm.data.QueryFactory.prototype.prepareSelect=ABSTRACT_METHOD;exportProperty(wrm.data.QueryFactory.prototype,"prepareSelect",wrm.data.QueryFactory.prototype.prepareSelect);wrm.data.QueryFactory.prototype.prepareOldSelect=ABSTRACT_METHOD;exportProperty(wrm.data.QueryFactory.prototype,"prepareOldSelect",wrm.data.QueryFactory.prototype.prepareOldSelect);wrm.data.QueryFactory.prototype.prepareInsert=ABSTRACT_METHOD;
exportProperty(wrm.data.QueryFactory.prototype,"prepareInsert",wrm.data.QueryFactory.prototype.prepareInsert);wrm.data.QueryFactory.prototype.prepareUpdate=ABSTRACT_METHOD;exportProperty(wrm.data.QueryFactory.prototype,"prepareUpdate",wrm.data.QueryFactory.prototype.prepareUpdate);wrm.data.QueryFactory.prototype.prepareDelete=ABSTRACT_METHOD;exportProperty(wrm.data.QueryFactory.prototype,"prepareDelete",wrm.data.QueryFactory.prototype.prepareDelete);
wrm.data.QueryFactory.prototype.prepareOldDelete=ABSTRACT_METHOD;exportProperty(wrm.data.QueryFactory.prototype,"prepareOldDelete",wrm.data.QueryFactory.prototype.prepareOldDelete);wrm.data.QueryFactory.prototype.prepareCondition=ABSTRACT_METHOD;exportProperty(wrm.data.QueryFactory.prototype,"prepareCondition",wrm.data.QueryFactory.prototype.prepareCondition);wrm.data.DataRunner=function(){};exportSymbol("wrm.data.DataRunner",wrm.data.DataRunner);wrm.data.DataRunner.prototype.execute=ABSTRACT_METHOD;exportProperty(wrm.data.DataRunner.prototype,"execute",wrm.data.DataRunner.prototype.execute);wrm.data.sync.UntrackedDataRunner=function(a){this._dataRunner=a};wrm.data.sync.UntrackedDataRunner.prototype.prepareSelect=function(a,b){return this._dataRunner.prepareSelect(a,b)};wrm.data.sync.UntrackedDataRunner.prototype.prepareOldSelect=function(a,b){return this._dataRunner.prepareOldSelect(a,b)};wrm.data.sync.UntrackedDataRunner.prototype.prepareInsert=function(a,b){return this._dataRunner.prepareInsert(a,b)};
wrm.data.sync.UntrackedDataRunner.prototype.prepareNewInsert=function(a,b){return this._dataRunner.prepareNewInsert(a,b)};wrm.data.sync.UntrackedDataRunner.prototype.prepareUpdate=function(a,b){return this._dataRunner.prepareUpdate(a,b)};wrm.data.sync.UntrackedDataRunner.prototype.prepareNewUpdate=function(a,b){return this._dataRunner.prepareNewUpdate(a,b)};wrm.data.sync.UntrackedDataRunner.prototype.prepareOldDelete=function(a,b){return this._dataRunner.prepareOldDelete(a,b)};
wrm.data.sync.UntrackedDataRunner.prototype.prepareDelete=function(a,b){return this._dataRunner.prepareDelete(a,b)};wrm.data.sync.UntrackedDataRunner.prototype.prepareNewAssociationSelect=function(a,b){return this._dataRunner.prepareNewAssociationSelect(a,b)};wrm.data.sync.UntrackedDataRunner.prototype.prepareNewAssociationInsert=function(a,b){return this._dataRunner.prepareNewAssociationInsert(a,b)};
wrm.data.sync.UntrackedDataRunner.prototype.prepareNewAssociationUpdate=function(a,b){return this._dataRunner.prepareNewAssociationUpdate(a,b)};wrm.data.sync.UntrackedDataRunner.prototype.prepareNewAssociationDelete=function(a,b){return this._dataRunner.prepareNewAssociationDelete(a,b)};wrm.data.sync.UntrackedDataRunner.prototype.prepareCondition=function(a,b){return this._dataRunner.prepareCondition(a,b)};
wrm.data.sync.UntrackedDataRunner.prototype.execute=function(a,b){return this._dataRunner.execute(function(b){b.disableChangeTracking();return a(b)},b)};wrm.data.sync.DataTrackerService=function(a,b,c){wrm.core.AbstractService.call(this,a,b,c)};extendConstructor(wrm.data.sync.DataTrackerService,wrm.core.AbstractService);exportSymbol("wrm.data.sync.DataTrackerService",wrm.data.sync.DataTrackerService);wrm.data.sync.DataTrackerService.prototype.initialize=function(a){return this.getManager().getDataService().then(function(a){a.useUnstable(this._reinitFromDataService.bind(this))}.bind(this))};
exportProperty(wrm.data.sync.DataTrackerService.prototype,"initialize",wrm.data.sync.DataTrackerService.prototype.initialize);wrm.data.sync.DataTrackerService.ID="_datatrack";exportProperty(wrm.data.sync.DataTrackerService,"ID",wrm.data.sync.DataTrackerService.ID);
wrm.data.sync.DataTrackerService.prototype._reinitFromDataService=function(a){this._dataRunner=new wrm.data.sync.UntrackedDataRunner(a);var b=wrm.data.sync.DataTrackerService._createMaps(a.getMetadata());this._entityTrackers=b.entityTrackers;this._assocTrackers=b.assocTrackers;this._relevantEntities=b.relevantEntities;this._purger=a.getPurger()};
wrm.data.sync.DataTrackerService._createMaps=function(a){var b={},c={};a.getEntities().forEach(function(a){wrm.data.sync.EntityTracker.isRelevantEntity(a)&&(c[a.getId()]=null,b[a.getId()]=!0)});var d={};a.getAssociations().forEach(function(a){wrm.data.sync.AssociationTracker.isRelevantAssociation(a)&&(d[a.getId()]=null,b[a.getEntity1().getId()]=!0,b[a.getEntity2().getId()]=!0)});return{entityTrackers:c,assocTrackers:d,relevantEntities:b}};
wrm.data.sync.DataTrackerService.prototype.isRelevantEntity=function(a){return this._relevantEntities.hasOwnProperty(a.getId())};exportProperty(wrm.data.sync.DataTrackerService.prototype,"isRelevantEntity",wrm.data.sync.DataTrackerService.prototype.isRelevantEntity);
wrm.data.sync.DataTrackerService.prototype.trackEntityCreate=function(a,b){var c=this,d=this._dataRunner;return this._isTrackableEntity(a)?d.execute(function(d){return wrm.data.sync.findServerKey(d,a,b).then(function(f){return c._doTrackEntityCreate(d,a,b,f)})}):Promise.resolve()};exportProperty(wrm.data.sync.DataTrackerService.prototype,"trackEntityCreate",wrm.data.sync.DataTrackerService.prototype.trackEntityCreate);
wrm.data.sync.DataTrackerService.prototype.trackEntityUpdate=function(a,b,c){var d=this,e=this._dataRunner;return!this._isTrackableEntity(a)||0>=c.length?Promise.resolve():e.execute(function(e){return wrm.data.sync.findServerKey(e,a,b).then(function(g){if(null!==g)return d._doTrackEntityUpdate(e,a,b,g,c)})})};exportProperty(wrm.data.sync.DataTrackerService.prototype,"trackEntityUpdate",wrm.data.sync.DataTrackerService.prototype.trackEntityUpdate);
wrm.data.sync.DataTrackerService.prototype.trackEntityDelete=function(a,b,c){var d=this,e=this._dataRunner;return this._isTrackableEntity(a)&&null!==c?e.execute(function(e){return d._doTrackEntityDelete(e,a,b,c)}):Promise.resolve()};exportProperty(wrm.data.sync.DataTrackerService.prototype,"trackEntityDelete",wrm.data.sync.DataTrackerService.prototype.trackEntityDelete);
wrm.data.sync.DataTrackerService.prototype.trackEntityServerKeyUpdate=function(a,b,c,d){var e=this,f=this._dataRunner,g=this.getLog();if(!this.isRelevantEntity(a)||c===d)return Promise.resolve();g.isDebugEnabled()&&g.debug("Entity",a,"changing server key of","{key:"+b,", serverKey: "+c+"}","to",d);return f.execute(function(f){return e._doTrackEntityServerKeyUpdate(f,a,b,c,d)})};exportProperty(wrm.data.sync.DataTrackerService.prototype,"trackEntityServerKeyUpdate",wrm.data.sync.DataTrackerService.prototype.trackEntityServerKeyUpdate);
wrm.data.sync.DataTrackerService.prototype._doTrackEntityServerKeyUpdate=function(a,b,c,d,e,f){var g=this;f=f||{};return wrm.data.sync.DataTrackerService.retrieveTrackableAssociations(b).reduce(function(h,k){if(!0===f[k.getId()])return h;var l=b===k.getEntity2(),m=l?k.getRole2():k.getRole1();return h.then(function(){return wrm.data.sync.findFarServerKeys(a,b,c,m).then(function(b){return l?b.reduce(function(b,c){return b.then(function(){return g._doTrackAssociationRemove(a,k,c,d)}).then(function(){return g._doTrackAssociationAdd(a,
k,c,e)})},Promise.resolve()):b.reduce(function(b,c){return b.then(function(){return g._doTrackAssociationRemove(a,k,d,c)}).then(function(){return g._doTrackAssociationAdd(a,k,e,c)})},Promise.resolve())})})},Promise.resolve())};
wrm.data.sync.DataTrackerService.prototype.trackAssociationAdd=function(a,b,c){var d=this,e=this._dataRunner;return this._isTrackableAssociation(a)?e.execute(function(e){return wrm.data.sync.findServerKey(e,a.getEntity1(),b).then(function(b){return wrm.data.sync.findServerKey(e,a.getEntity2(),c).then(function(c){if(null!==b&&null!==c)return d._doTrackAssociationAdd(e,a,b,c)})})}):Promise.resolve()};exportProperty(wrm.data.sync.DataTrackerService.prototype,"trackAssociationAdd",wrm.data.sync.DataTrackerService.prototype.trackAssociationAdd);
wrm.data.sync.DataTrackerService.prototype.trackAssociationRemove=function(a,b,c){var d=this,e=this._dataRunner;return this._isTrackableAssociation(a)?e.execute(function(e){return wrm.data.sync.findServerKey(e,a.getEntity1(),b).then(function(b){return wrm.data.sync.findServerKey(e,a.getEntity2(),c).then(function(c){if(null!==b&&null!==c)return d._doTrackAssociationRemove(e,a,b,c)})})}):Promise.resolve()};exportProperty(wrm.data.sync.DataTrackerService.prototype,"trackAssociationRemove",wrm.data.sync.DataTrackerService.prototype.trackAssociationRemove);
wrm.data.sync.DataTrackerService.retrieveTrackableAssociations=function(a){var b=[];a.getAssociations().forEach(function(a){a.getServerName()&&b.push(a)});return b};wrm.data.sync.DataTrackerService.prototype.createChangeCollector=function(a,b){return new wrm.data.sync.DataTrackerService._ChangeCollector(this,a,b)};exportProperty(wrm.data.sync.DataTrackerService.prototype,"createChangeCollector",wrm.data.sync.DataTrackerService.prototype.createChangeCollector);
wrm.data.sync.DataTrackerService._ChangeCollector=function(a,b,c){this._parent=a;this._dataContext=b;this._entity=c;this._entityState={entity:c,tracker:a._getEntityTracker(c),expendedForDeletes:!1,expendedForCreates:!1,expendedForUpdates:!1};this._assocStates=[];wrm.data.sync.DataTrackerService.retrieveTrackableAssociations(c).forEach(function(b){this._assocStates.push({assoc:b,tracker:a._getAssociationTracker(b)})},this);this._assocOnlyEntityChanges=null;this._currentChange=void 0;this._finished=
!1};wrm.data.sync.DataTrackerService._ChangeCollector.prototype.next=function(){var a=this;if(this._finished)throw Error("No more changes available");var b=Promise.resolve().then(function(){return a._settleCurrentChange()});return b=b.then(function(){return a._collectNextChange()}).then(function(b){a._currentChange=b;b||(a._finished=!0);return b})};
wrm.data.sync.DataTrackerService._ChangeCollector.prototype._collectNextChange=function(){var a=wrm.data.sync.DataTrackerService.Change,b=wrm.data.sync.DataTrackerService.Change.Type,c=this,d=this._entity,e=this._entityState,f=this._dataContext,g=Promise.resolve(null);e.expendedForDeletes||(g=g.then(function(){return e.tracker.collectNextDelete(f).then(function(f){return f?c._collectAttachedAssociationChanges(f).then(function(c){return new a(d,b.DELETE,f,c)}):(e.expendedForDeletes=!0,null)})}));e.expendedForCreates||
(g=g.then(function(g){return g?g:e.tracker.collectNextCreate(f).then(function(f){if(!f)return e.expendedForCreates=!0,null;c._filterUnmappedAttributes(f);return c._collectAttachedAssociationChanges(f,!0).then(function(c){return new a(d,b.CREATE,f,c)})})}));e.expendedForUpdates||(g=g.then(function(g){return g?g:e.tracker.collectNextUpdate(f).then(function(f){if(!f)return e.expendedForUpdates=!0,null;c._filterUnmappedAttributes(f);return c._collectAttachedAssociationChanges(f).then(function(c){return new a(d,
b.UPDATE,f,c)})})}));return g=g.then(function(e){return e?e:c._getAssocOnlyEntityChanges().then(function(e){if(0>=e.length)return null;var f=e.shift();return c._collectAttachedAssociationChanges(f).then(function(c){return new a(d,b.UPDATE,f,c)})})})};wrm.data.sync.DataTrackerService._ChangeCollector.prototype._filterUnmappedAttributes=function(a){var b=this._entity,c=a.attributeValues;c&&b.getAttributes().forEach(function(a){a.getServerName()||delete c[a.getId()]})};
wrm.data.sync.DataTrackerService._ChangeCollector.prototype._collectAttachedAssociationChanges=function(a,b){var c=this,d=this._entity,e=this._assocStates,f=this._dataContext;b=b||!1;var g=a.key,h=a.serverKey;if(null===h&&!b)return Promise.resolve({});var k={};return e.reduce(function(a,e){var n=e.assoc,p=n.getId(),q=n.getEntity2()===d;if(!(q?n.getRole2():n.getRole1()).getServerName())return a;var r=[],t=[];null!==h&&(a=a.then(function(){var a=q?null:h,b=q?h:null;return e.tracker.collectAdditions(f,
a,b).then(function(c){return e.tracker.collectRemovals(f,a,b).then(function(a){Array.prototype.push.apply(r,c);Array.prototype.push.apply(t,a)})})}));b&&(a=a.then(function(){return c._mergeCurrentAssociations(r,n,d,g,h)}));return a.then(function(){if(0<r.length||0<t.length)k[p]={additions:r,removals:t}})},Promise.resolve()).then(function(){return k})};
wrm.data.sync.DataTrackerService._ChangeCollector.prototype._mergeCurrentAssociations=function(a,b,c,d,e){var f={},g=this._dataContext;a.forEach(function(a){f[String(a.serverKey1)+"###"+String(a.serverKey2)]=!0});var h=b.getEntity2()===c;b=h?b.getRole2():b.getRole1();return wrm.data.sync.findFarServerKeys(g,c,d,b).then(function(b){b.forEach(function(b){var c=h?b:e;b=h?e:b;var d=String(c)+"###"+String(b);!0!==f[d]&&(f[d]=!0,a.push({serverKey1:c,serverKey2:b}))})})};
wrm.data.sync.DataTrackerService._ChangeCollector.prototype._getAssocOnlyEntityChanges=function(){var a=this,b=this._entity,c=this._assocStates,d=this._dataContext;if(this._assocOnlyEntityChanges)return Promise.resolve(this._assocOnlyEntityChanges);var e={},c=c.reduce(function(a,c){var h=c.assoc.getEntity2()===b,k=c.tracker;return a.then(function(){return k.collectAdditions(d,null,null)}).then(function(a){a.forEach(function(a){a=h?a.serverKey2:a.serverKey1;e[String(a)]=a});return k.collectRemovals(d,
null,null)}).then(function(a){a.forEach(function(a){a=h?a.serverKey2:a.serverKey1;e[String(a)]=a})})},Promise.resolve()),c=c.then(function(){var a=[];return Object.keys(e).reduce(function(c,h){var k=e[h];return c.then(function(){return wrm.data.sync.findKey(d,b,k)}).then(function(b){null!==b&&a.push({key:b,serverKey:k,attributeValues:{}})})},Promise.resolve()).then(function(){return a})});return c.then(function(b){return a._assocOnlyEntityChanges=b})};
wrm.data.sync.DataTrackerService._ChangeCollector.prototype._settleCurrentChange=function(){var a=wrm.data.sync.DataTrackerService.Change.Type,b=this,c=this._entityState,d=this._assocStates,e=this._dataContext,f=this._currentChange;if(!f)return Promise.resolve();var g=Promise.resolve();switch(f.getType()){case a.CREATE:g=g.then(function(){return c.tracker.settleCreate(e,f._entityChange)});break;case a.UPDATE:g=g.then(function(){return c.tracker.settleUpdate(e,f._entityChange)});break;case a.DELETE:g=
g.then(function(){return c.tracker.settleDelete(e,f._entityChange)})}d.forEach(function(a){var b=a.assoc.getId(),c=(b=f._assocChanges[b])&&b.additions;c&&0<c.length&&c.forEach(function(b){g=g.then(function(){a.tracker.settleAddition(e,b)})});(b=b&&b.removals)&&0<b.length&&b.forEach(function(b){g=g.then(function(){a.tracker.settleRemoval(e,b)})})});f.getType()===a.CREATE&&(g=g.then(function(){return b._retrackAfterCreateSettlement(f)}));return g};
wrm.data.sync.DataTrackerService._ChangeCollector.prototype._retrackAfterCreateSettlement=function(a){var b=this._parent,c=this._dataContext,d=a._entity,e=a._entityChange.key;return Promise.resolve().then(function(){return wrm.data.sync.findServerKey(c,d,e)}).then(function(f){if(null!==f){var g={};Object.keys(a._assocChanges).forEach(function(a){g[a]=!0});return b._doTrackEntityServerKeyUpdate(c,d,e,null,f,g)}})};
wrm.data.sync.DataTrackerService.prototype._doTrackEntityCreate=function(a,b,c,d){this._logEntityTracking(b,"created",c,d);return this._getEntityTracker(b).trackClientCreate(a,c,d)};wrm.data.sync.DataTrackerService.prototype._doTrackEntityUpdate=function(a,b,c,d,e){this._logEntityTracking(b,"updated",c,d,e);return this._getEntityTracker(b).trackClientUpdate(a,c,d,e)};
wrm.data.sync.DataTrackerService.prototype._doTrackEntityDelete=function(a,b,c,d){this._logEntityTracking(b,"deleted",c,d);return this._getEntityTracker(b).trackClientDelete(a,c,d)};wrm.data.sync.DataTrackerService.prototype._doTrackAssociationAdd=function(a,b,c,d){this._logAssociationTracking(b,"added",c,d);return this._getAssociationTracker(b).trackClientAdd(a,c,d)};
wrm.data.sync.DataTrackerService.prototype._doTrackAssociationRemove=function(a,b,c,d){this._logAssociationTracking(b,"removed",c,d);return this._getAssociationTracker(b).trackClientRemove(a,c,d)};wrm.data.sync.DataTrackerService.prototype._getEntityTracker=function(a){var b=this._entityTrackers[a.getId()];b||(b=new wrm.data.sync.EntityTracker(a,this._purger,this._dataRunner),this._entityTrackers[a.getId()]=b);return b};
wrm.data.sync.DataTrackerService.prototype._getAssociationTracker=function(a){if(DEBUG&&!a.getServerName())throw Error("Association "+a.getName()+" is connected to a non-synchronized class and can not be tracked.");var b=this._assocTrackers[a.getId()];b||(b=new wrm.data.sync.AssociationTracker(a,this._purger,this._dataRunner),this._assocTrackers[a.getId()]=b);return b};wrm.data.sync.DataTrackerService.prototype._isTrackableEntity=function(a){return this._entityTrackers.hasOwnProperty(a.getId())};
wrm.data.sync.DataTrackerService.prototype._isTrackableAssociation=function(a){return this._assocTrackers.hasOwnProperty(a.getId())};
wrm.data.sync.DataTrackerService.prototype._logEntityTracking=function(a,b,c,d,e){var f=this.getLog();if(f.isDebugEnabled()){var g=function(){var a=[];a.push("{key: ");a.push(String(c));a.push(", serverKey: ");a.push(String(d));void 0!==e&&(a.push(", updatedAttributes: ["),a.push(e.map(function(a){return String(a)}).join(", ")),a.push("]"));a.push("}");return a.join("")}();f.debug("Entity",a,b,g)}};
wrm.data.sync.DataTrackerService.prototype._logAssociationTracking=function(a,b,c,d){var e=this.getLog();if(e.isDebugEnabled()){var f=[];f.push("{serverKeys: (");f.push(String(c));f.push(", ");f.push(String(d));f.push(")}");c=f.join("");e.debug("Association",a,b,c)}};
wrm.data.sync.DataTrackerService.Change=function(a,b,c,d){this._entity=a;this._entityChange=c;this._type=b;this._assocChanges=d||{};a=this._createRoleServerKeysMaps(this._entity,this._assocChanges);this._roleAddedServerKeys=a.additions;this._roleRemovedServerKeys=a.removals};
wrm.data.sync.DataTrackerService.Change.prototype._createRoleServerKeysMaps=function(a,b){var c={additions:{},removals:{}};a.getAssociations().forEach(function(d){var e=a===d.getEntity2(),f=e?d.getRole2():d.getRole1(),g=(d=b[d.getId()])&&d.additions;if(g&&0<g.length){var h=[];c.additions[f.getId()]=h;g.forEach(function(a){h.push(e?a.serverKey1:a.serverKey2)})}if((d=d&&d.removals)&&0<d.length){var k=[];c.removals[f.getId()]=k;d.forEach(function(a){k.push(e?a.serverKey1:a.serverKey2)})}});return c};
wrm.data.sync.DataTrackerService.Change.prototype.getType=function(){return this._type};wrm.data.sync.DataTrackerService.Change.prototype.getEntity=function(){return this._entity};wrm.data.sync.DataTrackerService.Change.prototype.getKey=function(){return this._entityChange.key};wrm.data.sync.DataTrackerService.Change.prototype.getServerKey=function(){return this._entityChange.serverKey};wrm.data.sync.DataTrackerService.Change.prototype.getAttributeValues=function(){return this._entityChange.attributeValues};
wrm.data.sync.DataTrackerService.Change.prototype.getRoleAddedServerKeys=function(){return this._roleAddedServerKeys};wrm.data.sync.DataTrackerService.Change.prototype.getRoleRemovedServerKeys=function(){return this._roleRemovedServerKeys};
wrm.data.sync.DataTrackerService.Change.prototype.toString=function(){var a=wrm.data.sync.DataTrackerService.Change.Type,b=this._entity,c=[];switch(this._type){case a.CREATE:c.push("Create of ");break;case a.UPDATE:c.push("Update of ");break;case a.DELETE:c.push("Delete of ")}c.push(String(b));c.push(" {key: ");c.push(String(this.getKey()));c.push(", serverKey: ");c.push(String(this.getServerKey()));c.push("}");if(this._type!==a.DELETE){var d=this.getAttributeValues(),e=this.getRoleAddedServerKeys(),
f=this.getRoleRemovedServerKeys(),g=!1;c.push("\r\n\tAttributes: {");b.getAttributes().forEach(function(a){var b=a.getId();d.hasOwnProperty(b)&&(b=d[b],c.push("\r\n\t\t"),c.push(String(a)),c.push(": "),c.push(String(b)),g=!0)});g&&c.push("\r\n\t");c.push("}");g=!1;c.push("\r\n\tRoles: {");b.getRoles().forEach(function(a){var b=a.getId();if(e.hasOwnProperty(b)||f.hasOwnProperty(b))c.push("\r\n\t\t"),c.push(String(a)),c.push(": {addedServerKeys: ["),c.push((e[b]||[]).join(", ")),c.push("], removedServerKeys: ["),
c.push((f[b]||[]).join(", ")),c.push("]}"),g=!0});g&&c.push("\r\n\t");c.push("}")}return c.join("")};wrm.data.sync.DataTrackerService.Change.Type={CREATE:"create",UPDATE:"update",DELETE:"delete"};wrm.data.sync.EntityDiff=function(a,b,c,d,e){this.timestamp=a;this.serverRecordCount=b;Array.isArray(c)?this.serverRecordPages=new wrm.util.ArrayAsyncIterator([c]):this.serverRecordPages=c;this.deletedServerKeys=d;this.serverKeysHash="number"===typeof e?e:null};wrm.data.sync.EntityDiff.empty=function(){return new wrm.data.sync.EntityDiff(null,0,[],[])};wrm.data.sync.EntityDiff.createFixed=function(a,b,c,d){return new wrm.data.sync.EntityDiff(a,b.length,b,c,d)};
wrm.data.sync.EntityDiff.createIterable=function(a,b,c,d,e){return new wrm.data.sync.EntityDiff(a,b,c,d,e)};wrm.util.PromisedValue=function(a){var b=this;this._promise=a.finally(function(){b._pending=!1});this._pending=!0};wrm.util.PromisedValue.prototype.isPending=function(){return this._pending};wrm.util.PromisedValue.prototype.then=function(a,b){return this._promise.then(a,b)};wrm.util.PromisedValue.prototype["catch"]=function(a){return this._promise["catch"](a)};wrm.util.PromisedValue.prototype.toString=function(){return this._promise.toString()};wrm.data.sync.EntityDiffApplier=function(a,b,c,d,e,f,g){this._entity=a;this._token=b;this._dataContext=c;this._puller=d;this._binaryValueProcessQueue=e;this._assocsAligner=f;this._retryDownload=g;this._selectConcurrency=this._concurrency=Infinity;this._createOrUpdateInitd=!1;this._promisedValues=[];this._finalized=!1};wrm.data.sync.EntityDiffApplier.prototype.setConcurrency=function(a,b){this._concurrency=a;this._selectConcurrency=b};wrm.data.sync.EntityDiffApplier._DELETE_CHUNK_SIZE=200;
wrm.data.sync.EntityDiffApplier.prototype.deleteObjects=function(a,b,c){var d=this;if(this._finalized)return Promise.reject(Error("Diff applier is finalized"));var e=wrm.data.sync.EntityDiffApplier._DELETE_CHUNK_SIZE,f=this._entity,g=f.getId(),h=f.getServerKeyAttribute().getId(),k=Promise.resolve();c.resize(a.length);if(0>=a.length)return k;wrm.util.obj.sliceList(a,e).forEach(function(a){k=k.then(function(){return d._delete(g,{filter:{property:h,operator:"in"}},[a])}).then(function(e){a.forEach(function(a){d._assocsAligner.deletedRecord(f,
a)});b.deleted+=e;c.worked(1)})});return k};
wrm.data.sync.EntityDiffApplier.prototype.createOrUpdateObjects=function(a,b,c,d){var e=this;if(this._finalized)return Promise.reject(Error("Diff applier is finalized"));if(0>=a.length)return Promise.resolve();this._initBeforeAllCreateOrUpdate();return this._recordsToRetry.then(function(b){if(!b)return a;var c=e._entity.getServerKeyAttribute().getServerName();return a.map(function(a){var d=b[a[c]];d&&(a=angular.extend({},d,a),delete b[a[c]]);return a})}).then(function(a){return e._doCreateOrUpdateObjects(a,b,
c,d)})};wrm.data.sync.EntityDiffApplier.prototype.finalizeApplication=function(a,b,c){var d=this;if(this._finalized)return Promise.reject(Error("Diff applier is finalized"));this._finalized=!0;this._initBeforeAllCreateOrUpdate();return this._recordsToRetry.then(function(a){if(!a)return[];var b=d._entity.getServerKeyAttribute().getServerName();return Object.keys(a).map(function(c){var d=a[c];d[b]=c;return d})}).then(function(e){return d._doCreateOrUpdateObjects(e,a,b,c)}).then(function(){return{promisedValues:d._promisedValues}})};
wrm.data.sync.EntityDiffApplier.prototype._doCreateOrUpdateObjects=function(a,b,c,d){var e=this,f=this._entity,g=f.getId(),h=f.getKeyAttribute().getId();f.getServerKeyAttribute().getServerName();d.resize(a.length);return 0>=a.length?Promise.resolve():Promise.try(function(){return e._oldBlobValuesReady}).then(function(){return e._resolveExistingKeys(a)}).then(function(){return e._assocsAligner.resolveKeys(e._dataContext,e._entity,a)}).then(function(){return Promise.map(a,function(a,l){if(!0===a.__SKIP)d.worked(1);
else{var m=a.__KEY,n=a.__INLINE_KEYS;return e._puller.prepareObjectValues(a,m,e._token).then(function(c){n&&angular.extend(c,n);return null!==m?c?e._updateNoResult(g,{update:c,filter:h},[m]).then(function(){e._assocsAligner.updatedRecord(f,a);b.updated++;return m}):m:e._insert(g,c||{}).then(function(c){e._assocsAligner.createdRecord(f,a);b.created++;return c[0]})}).then(function(b){return e._finalizeUpdate(c,b,a)}).tap(function(){d.worked(1)})}},{concurrency:e._concurrency})})};
wrm.data.sync.EntityDiffApplier.prototype._finalizeUpdate=function(a,b,c){var d=this;b=this._puller.finalizeValues(c,b,this._token,a?this._dataContext:void 0);if(a){var e=this._binaryValueProcessQueue.isSuspended();this._binaryValueProcessQueue.resume();return Promise.all(b).then(function(){e&&d._binaryValueProcessQueue.suspend()})}b.forEach(function(a){d._promisedValues.push(new wrm.util.PromisedValue(a))});return Promise.resolve()};
wrm.data.sync.EntityDiffApplier.prototype._initBeforeAllCreateOrUpdate=function(){this._createOrUpdateInitd||(this._createOrUpdateInitd=!0,this._recordsToRetry=this._retryDownload?this._puller.retrieveMissingDownloads(this._dataContext):Promise.resolve({}),this._oldBlobValuesReady=this._puller.fetchOldBlobValues(this._dataContext))};wrm.data.sync.EntityDiffApplier._KEY_RESOLVE_CHUNK_SIZE=280;
wrm.data.sync.EntityDiffApplier.prototype._resolveExistingKeys=function(a){var b=this,c=wrm.data.sync.EntityDiffApplier._KEY_RESOLVE_CHUNK_SIZE,d=this._entity,e=d.getId(),f=d.getKeyAttribute().getId(),g=d.getServerKeyAttribute().getId(),h=d.getServerKeyAttribute().getServerName();return Promise.try(function(){var c={},d=[];a.forEach(function(b,e){var f=b[h];if(null===f||void 0===f)throw Error("Created or updated record has no server key");if(void 0!==b.__KEY)d.push(b);else{var g=c[f];"number"===typeof g&&
(a[g].__SKIP=!0);c[f]=e;b.__KEY=null}});return Promise.map(d,function(a){return b._selectOne(e,{output:{key:f},filter:{or:[g,{property:f,implied:!1}]}},[a[h],a.__KEY]).then(function(b){a.__KEY=b?b.key:null})},{concurrency:b._concurrency}).return(c)}).then(function(d){var h=wrm.util.obj.sliceList(Object.keys(d),c);return Promise.map(h,function(c){return b._select(e,{output:{serverKey:g,key:f},filter:g},[c]).then(function(b){b.forEach(function(b){a[d[b.serverKey]].__KEY=b.key})})},{concurrency:b._selectConcurrency})})};
wrm.data.sync.EntityDiffApplier.prototype._select=function(a,b,c){return this._dataContext.select(a,angular.extend({},b,{outputConfig:{useNames:!0}}),c)};wrm.data.sync.EntityDiffApplier.prototype._selectOne=function(a,b,c){return this._dataContext.selectOne(a,angular.extend({},b,{outputConfig:{useNames:!0}}),c)};wrm.data.sync.EntityDiffApplier.prototype._insert=function(a,b,c){c=c||{};c.useNewishQueries=!0;return this._dataContext.insert(a,b,c).finally(function(){c.useNewishQueries=!1})};
wrm.data.sync.EntityDiffApplier.prototype._updateNoResult=function(a,b,c){c=c||{};c.useNewishQueries=!0;return this._dataContext.updateNoResult(a,b,c).finally(function(){c.useNewishQueries=!1})};wrm.data.sync.EntityDiffApplier.prototype._delete=function(a,b,c){c=c||{};c.useNewishQueries=!0;return this._dataContext["delete"](a,b,c).finally(function(){c.useNewishQueries=!1})};wrm.data.sync.EntitySyncStats=function(){this.deleted=this.updated=this.created=0};wrm.data.sync.EntitySyncStats.prototype.hasChanges=function(){return 0<this.created||0<this.updated||0<this.deleted};wrm.data.sync.EntitySyncStats.prototype.toString=function(){return"{created: "+this.created+", updated: "+this.updated+", deleted: "+this.deleted+"}"};wrm.data.sync.KeyResolver=function(){this._cache={}};wrm.data.sync.KeyResolver.prototype.resolveFromCache=function(a,b){a=this._retrieveEntityCache(a);if(!a)return null;b=a[b];return void 0!==b?b:null};wrm.data.sync.KeyResolver.prototype.resolve=function(a,b,c){var d=this._retrieveEntityCache(b);if(!d)return Promise.resolve(null);var e=d[c];return void 0!==e?Promise.resolve(e):wrm.data.sync.findKey(a,b,c,!0).then(function(a){return d[c]=a})};
wrm.data.sync.KeyResolver.prototype.resolveAll=function(a,b,c,d){var e=this._retrieveEntityCache(b);if(!e)return Promise.resolve([]);for(var f=[],g=[],h=0;h<c.length;h++){var k=c[h],l=e[k];void 0!==l?f.push({key:l,serverKey:k}):g.push(k)}return 0>=g.length?Promise.resolve(f):wrm.data.sync.findAllKeys(a,b,g,d,!0).then(function(a){for(var b=0;b<a.length;b++){var c=a[b];e[c.serverKey]=c.key}return f.concat(a)})};
wrm.data.sync.KeyResolver.prototype.register=function(a,b){var c=this._retrieveEntityCache(a);if(c){var d=b[a.getServerKeyAttribute().getName()];null!==d&&(a=b[a.getKeyAttribute().getName()],c[d]=a)}};wrm.data.sync.KeyResolver.prototype.unregister=function(a,b){var c=this._retrieveEntityCache(a);c&&(a=b[a.getServerKeyAttribute().getName()],null!==a&&delete c[a])};
wrm.data.sync.KeyResolver.prototype._retrieveEntityCache=function(a){var b=a.getId(),c=this._cache[b];void 0===c&&(c=a.getServerKeyAttribute()?{}:null,this._cache[b]=c);return c};wrm.data.sync.KeyResolver.prototype.clear=function(){this._cache={}};wrm.data.sync.KeyResolver.prototype.createChangeListener=function(){return new wrm.data.sync.KeyResolver._ChangeListener(this)};wrm.data.sync.KeyResolver._ChangeListener=function(a){this._keyResolver=a};
wrm.data.sync.KeyResolver._ChangeListener.prototype.getEntityListener=function(a){return new wrm.data.sync.KeyResolver._ChangeListener.KeyChangeListener(a,this._keyResolver)};wrm.data.sync.KeyResolver._ChangeListener.prototype.getAssociationListener=function(a){return null};
wrm.data.sync.KeyResolver._ChangeListener.KeyChangeListener=function(a,b){this._entity=a;this._keyResolver=b;this.tracked=[a.getKeyAttribute().getName()];a.getServerKeyAttribute()&&this.tracked.push(a.getServerKeyAttribute().getName());this.trackedOld=[a.getKeyAttribute().getName()];a.getServerKeyAttribute()&&this.trackedOld.push(a.getServerKeyAttribute().getName())};
wrm.data.sync.KeyResolver._ChangeListener.KeyChangeListener.prototype.afterInsert=function(a){this._keyResolver.register(this._entity,a)};wrm.data.sync.KeyResolver._ChangeListener.KeyChangeListener.prototype.afterUpdate=function(a,b){this._keyResolver.register(this._entity,b)};wrm.data.sync.KeyResolver._ChangeListener.KeyChangeListener.prototype.afterDelete=function(a){this._keyResolver.unregister(this._entity,a)};wrm.data.sync.AbstractObjectMover=function(a,b,c){this._entity=a;var d;implementsInterface(b,wrm.data.DataRunner)?(d=b,b=null):d=null;this._dataRunner=d;this._dataObject=b;this._log=c;this._mappedAttributes=this._createMappedAttributes(a)};wrm.data.sync.AbstractObjectMover.prototype._createMappedAttributes=function(a){return a.getAttributes().filter(function(a){return!!a.getServerName()})};wrm.data.sync.AbstractObjectMover.prototype.getLog=function(){return this._log};
wrm.data.sync.AbstractObjectMover.prototype.getMappedAttributes=function(){return this._mappedAttributes};wrm.data.sync.AbstractObjectMover.prototype.getEntity=function(){return this._entity};wrm.data.sync.AbstractObjectMover.prototype.readTargetValue=function(a,b,c){return this._dataRunner?this._readTargetValueFromRunner(a,b,c||null):this._readTargetValueFromObject(a,b)};
wrm.data.sync.AbstractObjectMover.prototype._readTargetValueFromRunner=function(a,b,c){var d=this._entity,e=d.getKeyAttribute();return this._executeDataOperations(c,function(c){c.setExposedMetaAttributes("serverFileId");var g=b instanceof wrm.data.meta.MetaAttribute?b.getNewId():b.getId();return c.selectOne(d.getId(),{output:g,outputConfig:{useNames:!0},filter:e.getId()},[a])})};wrm.data.sync.AbstractObjectMover.prototype._readTargetValueFromObject=function(a,b){return Promise.resolve(this._dataObject[a][b.getId()])};
wrm.data.sync.AbstractObjectMover.prototype.writeTargetValue=function(a,b,c,d){var e={};e[b.getId()]=c;return this.writeTargetValues(a,e,d)};wrm.data.sync.AbstractObjectMover.prototype.writeTargetValues=function(a,b,c){return this._dataRunner?this._writeTargetValuesToRunner(a,b,c||null):this._writeTargetValuesToObject(a,b)};
wrm.data.sync.AbstractObjectMover.prototype._writeTargetValuesToRunner=function(a,b,c){var d=this._entity,e=d.getKeyAttribute();return this._executeDataOperations(c,function(c){c.setExposedMetaAttributes("serverFileId");return c.update(d.getId(),{update:b,filter:e.getId()},[a])})};wrm.data.sync.AbstractObjectMover.prototype._writeTargetValuesToObject=function(a,b){(a=this._dataObject[a])&&angular.extend(a,b);return Promise.resolve()};
wrm.data.sync.AbstractObjectMover.prototype._executeDataOperations=function(a,b){if(DEBUG&&!this._dataRunner)throw Error("Object mover is not backed by a data runner store");return a?Promise.resolve(b(a)):this._dataRunner.execute(b)};wrm.data.sync.ObjectPuller=function(a,b,c,d){wrm.data.sync.AbstractObjectMover.call(this,a,b,d);this._backEndService=c;this._oldBlobServerfileId=this._binaryValueProcessQueue=this._blobCache=null};wrm.data.sync.ObjectPuller._pendingBlob={};extendConstructor(wrm.data.sync.ObjectPuller,wrm.data.sync.AbstractObjectMover);wrm.data.sync.ObjectPuller.prototype.setBlobCache=function(a){this._blobCache=a};
wrm.data.sync.ObjectPuller.prototype.setBinaryValueProcessQueue=function(a){this._binaryValueProcessQueue=a};
wrm.data.sync.ObjectPuller.prototype.prepareObjectValues=function(a,b,c,d){if(DEBUG&&!this._oldBlobServerfileId)throw Error("oldBlobServerfileId must be ferched before");d=d||null;for(var e={},f=!1,g=null,h=this.getMappedAttributes(),k=0;k<h.length;k++){var l=h[k],m=a[l.getServerName()];void 0!==m&&(l=this._prepareAttributeObjectValue(e,l,m,b,c,d),"boolean"===typeof l?f=f||l:(g||(g=[]),g.push(l)))}return g?Promise.all(g).then(function(a){return f||0<=a.indexOf(!0)?e:null}):Promise.resolve(f?e:null)};
wrm.data.sync.ObjectPuller.prototype._prepareAttributeObjectValue=function(a,b,c,d,e,f){if(b.getType()===wrm.data.Type.BLOB&&!(c instanceof wrm.data.Blob))return this._prepareBinaryAttributeObjectValue(a,b,null!==c?String(c):null,d,e,f);a[b.getId()]=wrm.data.toAnySingle(c);return!0};
wrm.data.sync.ObjectPuller.prototype._prepareBinaryAttributeObjectValue=function(a,b,c,d,e,f){if(null===c)return a[b.getId()]=null,a[b.getMetaAttribute("status").getId()]=wrm.data.AvailabilityStatus.AVAILABLE,!0;if((d=this._oldBlobServerfileId[d])&&d[b.getServerName()]===c||wrm.data.sync.ObjectPuller._pendingBlob[this.getEntity().getId()+"_"+b.getId()+"_"+c])return!0;a[b.getId()]=new wrm.data.BlobReference(c,wrm.data.AvailabilityStatus.PENDING);wrm.data.sync.ObjectPuller._pendingBlob[this.getEntity().getId()+
"_"+b.getId()+"_"+c]=!0;return!1};wrm.data.sync.ObjectPuller.prototype.finalizeValues=function(a,b,c,d){d=d||null;for(var e=[],f=this.getMappedAttributes(),g=0;g<f.length;g++){var h=f[g],k=a[h.getServerName()];void 0!==k&&(h=this._finalizeAttributeValue(h,k,b,c,d))&&e.push(h)}return e};
wrm.data.sync.ObjectPuller.prototype._finalizeAttributeValue=function(a,b,c,d,e){var f=wrm.data.Type;if(a.getType()===f.BLOB&&!(b instanceof wrm.data.Blob))return this._finalizeBinaryAttributeValue(a,null!==b?String(b):null,c,d,e)};
wrm.data.sync.ObjectPuller.prototype._finalizeBinaryAttributeValue=function(a,b,c,d,e){if(null!==b){if(null===d||void 0===d)throw Error("Token is required for finalizing non-null binary values");return this._binaryValueProcessQueue?this._binaryValueProcessQueue.post(this._doFinalizeBinaryAttributeValue.bind(this,a,b,c,d,e)):this._doFinalizeBinaryAttributeValue(a,b,c,d,e)}};
wrm.data.sync.ObjectPuller.prototype._doFinalizeBinaryAttributeValue=function(a,b,c,d,e){var f=this,g={},h=a.getMetaAttribute("serverFileId"),k=a.getMetaAttribute("status").getId();return f._fetchBinaryValue(String(b),d).then(function(d){d?(g[a.getId()]=d,g[k]=wrm.data.AvailabilityStatus.AVAILABLE):g[k]=wrm.data.AvailabilityStatus.FAILED;delete wrm.data.sync.ObjectPuller._pendingBlob[f.getEntity().getId()+"_"+a.getId()+"_"+b];g[a.getId()]=d;g[h.getId()]=b;return f.writeTargetValues(c,g,e)})};
wrm.data.sync.ObjectPuller.prototype._fetchBinaryValue=function(a,b){var c=this._backEndService,d=this.getLog();return this._retrieveCachedBlob(a).then(function(e){return e?(d.isDebugEnabled()&&d.debug("Reusing previously downloaded content for file",a),e):c.downloadFile(b,a).then(function(b){var c=b.buffer,e=b.contentType;d.isDebugEnabled()&&d.debug("Received content for file",a,": size "+c.byteLength+", type "+e+", fileName "+b.fileName);return wrm.data.Blob.fromBytes(c,e||void 0,{fileName:b.fileName,
contentSignature:a})})["catch"](function(b){d.error("Failed download of file",a,":",b);return null})})};wrm.data.sync.ObjectPuller.prototype._retrieveCachedBlob=function(a){return this._blobCache?this._blobCache.retrieve(a):Promise.resolve(null)};
wrm.data.sync.ObjectPuller.prototype.fetchOldBlobValues=function(a){var b=this._retrieveAttributeOfSpecificType(wrm.data.Type.BLOB);if(0===b.length)return this._oldBlobServerfileId={},Promise.resolve();var c=this.getEntity(),d=c.getServerKeyAttribute(),e={};e[d.getServerName()]=d.getId();b.forEach(function(a){e[a.getMetaAttribute("status").getId()]=a.getMetaAttribute("status").getNewId();e[a.getServerName()]=a.getMetaAttribute("serverFileId").getNewId()});var f=this;return a.select(c.getId(),{output:e,
outputConfig:{useNames:!0}}).then(function(a){var c={};a.forEach(function(a){var e={},f=a[d.getServerName()],g=wrm.data.AvailabilityStatus.AVAILABLE;b.forEach(function(b){a[b.getMetaAttribute("status").getId()]===g&&(e[b.getServerName()]=a[b.getServerName()])});c[f]=e});f._oldBlobServerfileId=c})};
wrm.data.sync.ObjectPuller.prototype.retrieveMissingDownloads=function(a){var b=this._retrieveAttributeOfSpecificType(wrm.data.Type.BLOB);if(0===b.length)return Promise.resolve();var c=this.getEntity(),d=wrm.data.AvailabilityStatus.AVAILABLE,e=c.getServerKeyAttribute(),f=[],g={};g[e.getServerName()]=e.getId();b.forEach(function(a){var b={property:a.getMetaAttribute("status").getNewId(),operator:"!eq",value:d};f.push(b);g[a.getServerName()]=a.getMetaAttribute("serverFileId").getNewId()});return a.select(c.getId(),
{filter:{or:f},output:g,outputConfig:{useNames:!0}}).then(function(a){if(0!==a.length){var b={};a.forEach(function(a){var c=a[e.getServerName()];delete a[e.getServerName()];b[c]=a});return b}})};wrm.data.sync.ObjectPuller.prototype._retrieveAttributeOfSpecificType=function(a){return this.getEntity().getAttributes().filter(function(b){return b.getType()===a})};wrm.data.sync.ObjectPusher=function(a,b,c,d){wrm.data.sync.AbstractObjectMover.call(this,a,b,d);this._backEndService=c};extendConstructor(wrm.data.sync.ObjectPusher,wrm.data.sync.AbstractObjectMover);
wrm.data.sync.ObjectPusher.prototype.prepareRecordValues=function(a,b,c,d){var e=this,f=d||null,g={},h=[];this.getMappedAttributes().forEach(function(d){var l=a[d.getId()];void 0!==l&&h.push(e._prepareAttributeRecordValue(g,d,l,b,c,f))});return Promise.all(h).then(function(a){return 0<=a.indexOf(!0)?g:null})};
wrm.data.sync.ObjectPusher.prototype._prepareAttributeRecordValue=function(a,b,c,d,e,f){var g=this.getLog(),h=b.getType();if(h===wrm.data.Type.BLOB){if(null===c||c instanceof wrm.data.Blob)return this._prepareBinaryAttributeRecordValue(a,b,c,d,e,f);g.warn("Ignoring non-blob value");return!1}a[b.getServerName()]=wrm.data.sync.ObjectPusher.convertToRecordValue(h,c);return!0};
wrm.data.sync.ObjectPusher.prototype._prepareBinaryAttributeRecordValue=function(a,b,c,d,e,f){if(!c)return a[b.getServerName()]=null,!0;c=b.getMetaAttribute("serverFileId");return this.readTargetValue(d,c,f).then(function(c){if(c)return!1;a[b.getServerName()]="empty";return!0})};wrm.data.sync.ObjectPusher.convertToRecordValue=function(a,b){var c=wrm.data.Type;a!==c.STRING&&a!==c.INTEGER&&a!==c.FLOAT&&a!==c.BOOLEAN&&(a=c.STRING);return wrm.data.toSingle(a,b)};
wrm.data.sync.ObjectPusher.prototype.finalizeValues=function(a,b,c,d,e){var f=this,g=e||null,h=[];this.getMappedAttributes().forEach(function(e){var l=b[e.getId()];void 0!==l&&(e=f._finalizeAttributeValue(a,e,l,c,d,g))&&h.push(e)});return h};wrm.data.sync.ObjectPusher.prototype._finalizeAttributeValue=function(a,b,c,d,e,f){var g=wrm.data.Type;if(b.getType()===g.BLOB&&(null===c||c instanceof wrm.data.Blob))return this._finalizeBinaryAttributeValue(a,b,c,d,e,f)};
wrm.data.sync.ObjectPusher.prototype._finalizeBinaryAttributeValue=function(a,b,c,d,e,f){var g=this,h=this._backEndService,k=this.getLog();if(c){if(null===e||void 0===e)throw Error("Token is required for finalizing non-null binary values");var l=b.getServerName(),m=b.getMetaAttribute("serverFileId");a&&a[l]?(b=Promise.resolve(a[l]),delete a[l]):b=this.readTargetValue(d,m,f);b=b.then(function(a){return Promise.resolve().then(function(){return c.read()}).then(function(b){b=b.buffer;var d=c.getContentType(),
f=c.computeExternalFileName();k.isDebugEnabled()&&k.debug("Sending content for file",a,": size "+b.byteLength+", type "+d+", fileName "+f);return h.uploadFile(e,a,{buffer:b,contentType:d||void 0,fileName:f||void 0})["catch"](function(b){k.error("Failed upload of file",a,":",b)})})});return b.then(function(a){return g.writeTargetValue(d,m,a,f)})}};wrm.util.ProgressMonitor=function(){};exportSymbol("wrm.util.ProgressMonitor",wrm.util.ProgressMonitor);wrm.util.ProgressMonitor.prototype.resize=function(a){};exportProperty(wrm.util.ProgressMonitor.prototype,"resize",wrm.util.ProgressMonitor.prototype.resize);wrm.util.ProgressMonitor.prototype.worked=function(a){};exportProperty(wrm.util.ProgressMonitor.prototype,"worked",wrm.util.ProgressMonitor.prototype.worked);wrm.util.ProgressMonitor.prototype.sub=function(a){};
exportProperty(wrm.util.ProgressMonitor.prototype,"sub",wrm.util.ProgressMonitor.prototype.sub);wrm.util.ProgressMonitor.prototype.done=function(){};exportProperty(wrm.util.ProgressMonitor.prototype,"done",wrm.util.ProgressMonitor.prototype.done);wrm.util.FakeProgressMonitor=function(){};exportSymbol("wrm.util.FakeProgressMonitor",wrm.util.FakeProgressMonitor);wrm.util.FakeProgressMonitor.prototype.resize=function(a){};exportProperty(wrm.util.FakeProgressMonitor.prototype,"resize",wrm.util.FakeProgressMonitor.prototype.resize);wrm.util.FakeProgressMonitor.prototype.worked=function(a){};exportProperty(wrm.util.FakeProgressMonitor.prototype,"worked",wrm.util.FakeProgressMonitor.prototype.worked);wrm.util.FakeProgressMonitor.prototype.sub=function(a){return this};
exportProperty(wrm.util.FakeProgressMonitor.prototype,"sub",wrm.util.FakeProgressMonitor.prototype.sub);wrm.util.FakeProgressMonitor.prototype.done=function(){};exportProperty(wrm.util.FakeProgressMonitor.prototype,"done",wrm.util.FakeProgressMonitor.prototype.done);wrm.util.FakeProgressMonitor.INSTANCE=new wrm.util.FakeProgressMonitor;exportProperty(wrm.util.FakeProgressMonitor,"INSTANCE",wrm.util.FakeProgressMonitor.INSTANCE);wrm.util.TaskQueue=function(a){this._tasks=[];this._activeWorkers=0;this._maxWorkers=a&&a.maxWorkers||1;this._suspended=!1;this._idleWaiters=[]};exportSymbol("wrm.util.TaskQueue",wrm.util.TaskQueue);wrm.util.TaskQueue.DEFAULT_PRIORITY=0;exportProperty(wrm.util.TaskQueue,"DEFAULT_PRIORITY",wrm.util.TaskQueue.DEFAULT_PRIORITY);wrm.util.TaskQueue.prototype.post=function(a,b){var c=this;return new Promise(function(b,e){c._enqueueTask({work:a,priority:wrm.util.TaskQueue.DEFAULT_PRIORITY,resolve:b,reject:e})})};
exportProperty(wrm.util.TaskQueue.prototype,"post",wrm.util.TaskQueue.prototype.post);wrm.util.TaskQueue.prototype._enqueueTask=function(a){for(var b=0,c=this._tasks.length-1;0<=c;c--)if(this._tasks[c].priority>=a.priority){b=c+1;break}this._tasks.splice(b,0,a);this._startWorker()};wrm.util.TaskQueue.prototype.suspend=function(){this._suspended=!0};exportProperty(wrm.util.TaskQueue.prototype,"suspend",wrm.util.TaskQueue.prototype.suspend);
wrm.util.TaskQueue.prototype.resume=function(){if(this._suspended){this._suspended=!1;for(var a=Math.min(this._maxWorkers-this._activeWorkers,this._tasks.length),b=0;b<a;b++)this._startWorker()}};exportProperty(wrm.util.TaskQueue.prototype,"resume",wrm.util.TaskQueue.prototype.resume);wrm.util.TaskQueue.prototype.isSuspended=function(){return this._suspended};exportProperty(wrm.util.TaskQueue.prototype,"isSuspended",wrm.util.TaskQueue.prototype.isSuspended);
wrm.util.TaskQueue.prototype.isIdle=function(){return 0>=this._activeWorkers&&0>=this._tasks.length};exportProperty(wrm.util.TaskQueue.prototype,"isIdle",wrm.util.TaskQueue.prototype.isIdle);wrm.util.TaskQueue.prototype._startWorker=function(){!this._suspended&&this._activeWorkers<this._maxWorkers&&(this._activeWorkers++,this._work())};
wrm.util.TaskQueue.prototype._work=function(){var a=this;if(0>=this._tasks.length)this._activeWorkers--,this.isIdle()&&this._notifyIdleWaiters();else{var b=this._tasks.shift();Promise.resolve().then(function(){return b.work()}).then(function(a){b.resolve(a)},function(a){b.reject(a)}).then(function(){a._work()})}};wrm.util.TaskQueue.prototype.waitForIdle=function(){if(this.isIdle())return Promise.resolve();var a=this._idleWaiters;return new Promise(function(b,c){a.push({resolve:b})})};
exportProperty(wrm.util.TaskQueue.prototype,"waitForIdle",wrm.util.TaskQueue.prototype.waitForIdle);wrm.util.TaskQueue.prototype._notifyIdleWaiters=function(){if(!(0>=this._idleWaiters.length)){var a=this._idleWaiters;this._idleWaiters=[];a.forEach(function(a){a.resolve(void 0)})}};wrm.util.TaskQueue.prototype.toString=function(){return"TaskQueue with "+this._tasks.length+" tasks"};exportProperty(wrm.util.TaskQueue.prototype,"toString",wrm.util.TaskQueue.prototype.toString);wrm.data.sync.EntitySynchronizer=function(a,b,c,d,e,f,g,h,k,l,m,n,p,q,r){this._serverStore=a;this._entity=a.getEntity();this._token=b;this._waitForAllValues=c;this._dataContext=d;this._pusher=e;this._puller=f;this._dataTrackerService=g;this._binaryValueProcessQueue=k;this._purger=l;this._keyResolverListener=m.createChangeListener();this._blobCacheListener=p;this._assocAligners={};this._assocsAligner=this._createAssociationSetAligner(m,n);this._selectConcurrency=this._concurrency=Infinity;this._log=
r.getPlatform().createLog("wrm.data.sync.EntitySynchronizer","["+this._entity+"]");this._permitWaiter=q;this._sinceTimestamp=null;this._includeInbound=this._includeOutbound=!0;this._fetchTimestamp=null;this._changed=!1;this._promisedValues=[]};
wrm.data.sync.EntitySynchronizer.prototype._createAssociationSetAligner=function(a,b){var c={},d=[];this._entity.getRoles().forEach(function(e){if(e.getInverseEntity().getServerName()){e=e.getAssociation();var f=e.getId();if(!0!==c[f]){c[f]=!0;var g=this._assocAligners[f];g||(g=new wrm.data.sync.AssociationAligner(e,a,this._purger,b),this._assocAligners[f]=g);d.push(g)}}},this);return new wrm.data.sync.AssociationSetAligner(d)};wrm.data.sync.EntitySynchronizer.prototype.getEntity=function(){return this._entity};
wrm.data.sync.EntitySynchronizer.prototype.setMonitor=function(a){var b=wrm.data.sync.EntitySynchronizer,c={fn:function(){var a=new wrm.util.TaskQueue({maxWorkers:1});return function(b){return a.post(b.bind(this))}}(),inUse:!1};a={fn:a.workWithNetwork,inUse:!1};this._doSerialSynchronization=this._monitorFunction(b.prototype._doSerialSynchronization,"_doSerialSynchronization",c,this._permitWaiter);this._doSynchronizeOutbound=this._monitorFunction(b.prototype._doSynchronizeOutbound,"_doSynchronizeOutbound",
c,this._permitWaiter);this._finalizeUpdateAtomic=this._monitorFunction(b.prototype._finalizeUpdateAtomic,"_finalizeUpdateAtomic",c);this._fetchDiff=this._monitorFunction(b.prototype._fetchDiff,"_fetchDiff",a);this._fetchVisibleServerKeysDiff=this._monitorFunction(b.prototype._fetchVisibleServerKeysDiff,"_fetchVisibleServerKeysDiff",a);this._postCreateChange=this._monitorFunction(b.prototype._postCreateChange,"_postCreateChange",a);this._postDeleteChange=this._monitorFunction(b.prototype._postDeleteChange,
"_postDeleteChange",a);this._postUpdateChange=this._monitorFunction(b.prototype._postUpdateChange,"_postUpdateChange",a)};
wrm.data.sync.EntitySynchronizer.prototype._monitorFunction=function(a,b,c,d){var e=this;if(!d)d=function(){var a=Promise.resolve();return function(){return a}}();else if(TRACE){var f=d;d=function(){e._log.debug(b,"awaiting permit");return f().finally(function(){e._log.debug(b,"granted permit")})}}return function(){var e=this;if(c.inUse)return a.apply(this,arguments);var f=this,k=arguments;return d().then(function(){TRACE&&e._log.debug(b,"awaiting worker");return c.fn(function(){TRACE&&e._log.debug(b,
"acquired worker");c.inUse=!0;return a.apply(f,k)}).finally(function(){c.inUse=!1;TRACE&&e._log.debug(b,"released worker")})})}};wrm.data.sync.EntitySynchronizer.prototype.setConcurrency=function(a,b){this._concurrency=a;this._selectConcurrency=b;this._assocsAligner.setSelectConcurrency(b)};
wrm.data.sync.EntitySynchronizer.prototype._reset=function(a){this._sinceTimestamp=a&&a.since||null;this._includeOutbound=a?!1!==a.outbound:!0;this._includeInbound=a?!1!==a.inbound:!0;this._changed=!1;this._promisedValues=[];this._fetchTimestamp=null};
wrm.data.sync.EntitySynchronizer.prototype.synchronize=function(a,b){var c=this,d=this._dataContext,e=this._keyResolverListener,f=this._blobCacheListener,g=this._purger,h=this._log;this._reset(b);h.info("Synchronizing","("+this._computeDescription()+")");a.resize((c._includeOutbound?1:0)+(c._includeInbound?115:0)+2);d.addChangeListener(e);d.addChangeListener(f);d.setExposedMetaAttributes("serverFileId");d.setExposedMetaAttributes("status");b=Promise.resolve().then(function(){if(c._includeOutbound)return c._doSynchronizeOutbound(a.sub(1))});
b=b.then(function(){if(c._includeInbound)return c._fetchDiff(a.sub(5)).then(function(b){return c._doSerialSynchronization(b,a.sub(110))})});b=b.then(function(){return g.purge(d,a.sub(2))});b=b.finally(function(){c._assocsAligner.reset();d.removeChangeListener(f);d.removeChangeListener(e);a.done()});return b.then(function(){return{timestamp:c._fetchTimestamp||c._sinceTimestamp,changed:c._changed,promisedValues:c._promisedValues}})};
wrm.data.sync.EntitySynchronizer.prototype._computeDescription=function(){var a=this._sinceTimestamp?"differentially since "+this._sinceTimestamp:"fully";return this._includeInbound&&this._includeOutbound?a:this._includeInbound?"inbound only, "+a:this._includeOutbound?"outbound only":"no-op"};
wrm.data.sync.EntitySynchronizer.prototype._doSynchronizeOutbound=function(a){var b=this,c=this._entity,d=this._dataContext,e=this._log,f=new wrm.data.sync.EntitySyncStats,g=!1,h=this._dataTrackerService.createChangeCollector(d,c);return function l(){return h.next().then(function(a){if(a){g=!0;var c=Promise.resolve().then(function(){return b._postChange(a)}),c=c.then(function(a){return b._applyDiff(a,f,!1,"resulting",!0,wrm.util.FakeProgressMonitor.INSTANCE)});return c.then(function(){return l()})}})}().then(function(){a.done();
g&&e.debug("Resulting differences applied",":",f)},function(a){e.error("Error in outbound synchronization",a);throw a;})};wrm.data.sync.EntitySynchronizer.prototype._doSerialSynchronization=function(a,b){var c=this,d=Promise.resolve().then(function(){return c._doSynchronizeInbound(a,b.sub(20))}),d=d.then(function(){return c._doAlignAssociations(b.sub(80))});return d=d.then(function(){c._fetchTimestamp=a.timestamp})};
wrm.data.sync.EntitySynchronizer.prototype._doSynchronizeInbound=function(a,b){var c=this,d=this._log,e=new wrm.data.sync.EntitySyncStats,f=Promise.resolve().then(function(){return c._applyDiff(a,e,!0,"inbound",!1,b.sub(75))}),f=f.then(function(){return c._fetchVisibleServerKeysDiff(a.serverKeysHash,b.sub(5))}),f=f.then(function(a){return c._applyDiff(a,e,!1,null,!1,b.sub(20))});return f.then(function(){d.debug("Inbound differences applied",":",e)},function(a){if(-1!==a.message.indexOf("operation is not allowed on class"))throw d.debug("Skipped synchronization of due to missing permission"),
a;d.error("Error in inbound synchronization",a);throw a;})};
wrm.data.sync.EntitySynchronizer.prototype._doAlignAssociations=function(a){var b=this,c=this._assocsAligner,d=this._log,e=!1,f=c.getAligners();a.resize(f.length);return c.getAligners().reduce(function(c,f){var k=f.getAssociation(),l=new wrm.data.sync.AssociationSyncStats;c=c.then(function(){d.debug("Aligning association",k);return f.save(b._dataContext,b._concurrency,l)}).then(function(){return f.align(b._dataContext,b._concurrency,l)});return c.then(function(){d.debug("Aligned association",k,":",
l);e=e||l.hasChanges();a.worked(1)},function(a){d.error("Error in alignment of association",k,a);throw a;})},Promise.resolve()).then(function(){b._changed|=e;a.done()})};
wrm.data.sync.EntitySynchronizer.prototype._postChange=function(a){this._log.debug("Posting",a);var b=wrm.data.sync.DataTrackerService.Change.Type;switch(a.getType()){case b.CREATE:return this._postCreateChange(a);case b.UPDATE:return this._postUpdateChange(a);case b.DELETE:return this._postDeleteChange(a);default:throw Error("Invalid change");}};
wrm.data.sync.EntitySynchronizer.prototype._postCreateChange=function(a){var b=this,c=a.getKey();return Promise.resolve().then(function(){return b._prepareOutboundServerRecord(a)}).then(function(a){return b._serverStore.createEntityInstance(b._token,a)}).then(function(d){return b._finalizeOutboundValues(d,a).then(function(){d.__KEY=c;return wrm.data.sync.EntityDiff.createFixed(null,[d],[])})})};
wrm.data.sync.EntitySynchronizer.prototype._postUpdateChange=function(a){var b=this,c=a.getKey(),d=a.getServerKey();if(null===d)throw Error("Server key required for posting an update");return Promise.resolve().then(function(){return b._prepareOutboundServerRecord(a)}).then(function(a){return a?b._serverStore.updateEntityInstance(b._token,d,a):null}).then(function(d){return b._finalizeOutboundValues(d,a).then(function(){if(!d)return wrm.data.sync.EntityDiff.empty();d.__KEY=c;return wrm.data.sync.EntityDiff.createFixed(null,
[d],[])})},function(a){if(a instanceof wrm.core.NotFoundError)return wrm.data.sync.EntityDiff.createFixed(null,[],[d]);throw a;})};wrm.data.sync.EntitySynchronizer.prototype._postDeleteChange=function(a){a=a.getServerKey();if(null===a)throw Error("Server key required for posting a delete");return this._serverStore.deleteEntityInstance(this._token,a).then(function(){return wrm.data.sync.EntityDiff.createFixed(null,[],[])})};
wrm.data.sync.EntitySynchronizer.prototype._prepareOutboundServerRecord=function(a){var b=wrm.data.sync.DataTrackerService.Change.Type;if(a.getType()===b.DELETE)return Promise.resolve({});var c=this,d=wrm.data.sync.ObjectPusher,e=a.getEntity(),f=a.getAttributeValues(),g=a.getRoleAddedServerKeys(),h=a.getRoleRemovedServerKeys(),k={},l=!1,m=Promise.resolve();f&&(m=m.then(function(){return c._pusher.prepareRecordValues(f,a.getKey(),c._token,c._dataContext)}).then(function(a){a&&(angular.extend(k,a),
l=!0)}));e.getRoles().forEach(function(a){var b=a.getServerName();if(b){var c=g[a.getId()],e=h[a.getId()];if(c&&0<c.length||e&&0<e.length){var f=a.getInverseEntity().getServerKeyAttribute();a={};c&&0<c.length&&(a.added=c.map(function(a){return d.convertToRecordValue(f.getType(),a)}));e&&0<e.length&&(a.removed=e.map(function(a){return d.convertToRecordValue(f.getType(),a)}));k[b]=a;l=!0}}});return m.then(function(){return l||a.getType()===b.CREATE?k:null})};
wrm.data.sync.EntitySynchronizer.prototype._finalizeOutboundValues=function(a,b){if(b.getType()===wrm.data.sync.DataTrackerService.Change.Type.DELETE)return Promise.resolve();var c=b.getAttributeValues();return c?Promise.all(this._pusher.finalizeValues(a,c,b.getKey(),this._token,this._dataContext)):Promise.resolve()};
wrm.data.sync.EntitySynchronizer.prototype._fetchDiff=function(a){var b=this,c=this._serverStore,d=this._sinceTimestamp,e=this._token;if(!this._serverStore.isServerReadable())return Promise.resolve(wrm.data.sync.EntityDiff.empty());this._log.debug("Fetching inbound differences");var f=Promise.resolve();d?f=f.then(function(){return c.retrieveEntityData(e,d)}).then(function(b){a.done();return wrm.data.sync.EntityDiff.createIterable(b.timestamp,b.recordCount,b.recordPages,b.deletedKeys,b.keysHash)}):
(f=f.then(function(){return b._selectAllServerKeys()}),f=f.then(function(b){a.worked(50);return c.retrieveEntityData(e).then(function(c){a.done();return wrm.data.sync.EntityDiff.createIterable(c.timestamp,c.recordCount,c.recordPages,b,c.keysHash)})}));return f};
wrm.data.sync.EntitySynchronizer.prototype._fetchVisibleServerKeysDiff=function(a,b){var c=this,d=this._serverStore,e=this._log;return null===a?Promise.resolve(wrm.data.sync.EntityDiff.empty()):Promise.resolve().then(function(){return c._selectAllServerKeys()}).then(function(f){var g=wrm.data.sync.computeKeysHash(f);if(g===a)return wrm.data.sync.EntityDiff.empty();e.debug("Instances have changed scope -",a,"!\x3d",g);return d.retrieveEntityKeys(c._token).then(function(a){a=wrm.util.obj.findValuesDiff(f,
a);var g=a.removed;0<g.length&&e.debug("Found",g.length,"instances that went out of scope");a=a.added;0<a.length?(e.debug("Found",a.length,"instances that came into scope"),a=a.reduce(function(a,b){return a.then(function(a){return d.retrieveEntityInstanceData(c._token,b).then(function(b){a.push(b);return a},function(a){if(!(a instanceof wrm.core.NotFoundError))throw a;})})},Promise.resolve([]))):a=Promise.resolve([]);return a.then(function(a){b.done();return wrm.data.sync.EntityDiff.createFixed(null,
a,g)})})})["catch"](function(a){e.error("Error fetching differences in visible keys",a);throw a;})};wrm.data.sync.EntitySynchronizer.prototype._selectAllServerKeys=function(){var a=this._entity;return this._select(a.getId(),{output:a.getServerKeyAttribute().getId()})};
wrm.data.sync.EntitySynchronizer.prototype._applyDiff=function(a,b,c,d,e,f){var g=this,h=e||this._waitForAllValues;e=Promise.resolve();d&&this._log.debug("Applying "+d+" differences");var k=a.deletedServerKeys.length;d=a.serverRecordCount;var l=Math.ceil(d/10);f.resize(k+d+l);var m=new wrm.data.sync.EntityDiffApplier(this._entity,this._token,this._dataContext,this._puller,this._binaryValueProcessQueue,this._assocsAligner,c);m.setConcurrency(this._concurrency,this._selectConcurrency);e=e.then(function(){return m.deleteObjects(a.deletedServerKeys,
b,f.sub(k))});e=e.then(function(){return wrm.util.AsyncIterator.forEach(a.serverRecordPages,function(a){return m.createOrUpdateObjects(a,b,h,f.sub(a.length))})});e=e.then(function(){return m.finalizeApplication(b,h,f.sub(l))}).then(function(a){Array.prototype.push.apply(g._promisedValues,a.promisedValues)});return e.then(function(){g._changed|=b.hasChanges()})};
wrm.data.sync.EntitySynchronizer.prototype._select=function(a,b,c){return this._dataContext.select(a,angular.extend({},b,{outputConfig:{useNames:!0}}),c)};wrm.data.sync.Synchronizer=function(a,b,c,d){var e=wrm.data.sync.Synchronizer._CONFIG;this._manager=d;this._dataService=a;this._dataTrackerService=b;this._dataRunner=new wrm.data.sync.UntrackedDataRunner(a);this._backEndService=c;this._serverStoreMap={};this._jobQueue=new wrm.util.TaskQueue;this._keyResolver=new wrm.data.sync.KeyResolver;this._blobCache=new wrm.data.sync.BlobCache(this._dataRunner);this._binaryValueProcessQueue=new wrm.util.TaskQueue({maxWorkers:e.maxBinaryDownloads});this._purger=
a.getPurger();this._log=d.getPlatform().createLog("wrm.data.sync.Synchronizer");this._preferredOrder=null};wrm.data.sync.Synchronizer._CONFIG={useParallel:!0,maxParallelSyncs:4,perSyncConcurrency:100,perSyncSelectConcurrencyRatio:20,maxNetworkRequests:4,maxBinaryDownloads:2};wrm.data.sync.Synchronizer.CURRENT_VERSION=1;wrm.data.sync.Synchronizer.DEFAULT_PRIORITY=wrm.util.TaskQueue.DEFAULT_PRIORITY;
wrm.data.sync.Synchronizer.prototype.checkAvailable=function(a){var b=this,c=!0;a.forEach(function(a){c&&(c=b._retrieveServerStore(a).isServerAvailable())});return c};wrm.data.sync.Synchronizer.prototype.isBackgroundDownloading=function(){return!this._binaryValueProcessQueue.isIdle()};wrm.data.sync.Synchronizer.prototype.synchronize=function(a,b){"undefined"===typeof b&&(b=wrm.util.TaskQueue.DEFAULT_PRIORITY);return this._jobQueue.post(this._runJob.bind(this,a),b)};
wrm.data.sync.Synchronizer.prototype._runJob=function(a){var b=this,c=this._log;c.info("Synchronization started");this._binaryValueProcessQueue.suspend();return this._dataRunner.execute(function(d){function e(d){var e=d.getEntity();return Promise.resolve().then(function(){return b._synchronizeEntity(d,a,g,f.sub(1))}).then(function(a){a.changed&&l.push(e);Array.prototype.push.apply(m,a.promisedValues)})["catch"](function(a){if(a instanceof wrm.core.ForbiddenError){var b=a.message;if("Invalid authorization token"===
b){n=a;return}if(-1!==b.indexOf("operation is not allowed on class"))return}c.error("Entity",e,"synchronization failed",a);!k&&a instanceof wrm.core.NetworkError&&(k=wrm.core.NetworkError);h.push(e)})}var f=a.progressMonitor,g=b._createEntityOrchestrator(a);d=b._createEntitySynchronizers(d,a,g);f.resize(d.length);var h=[],k=null,l=[],m=[],n=null;d=wrm.data.sync.Synchronizer._CONFIG.useParallel?Promise.all(d.map(e)):d.reduce(function(a,b){return a.then(function(){return e(b)})},Promise.resolve());
d=d.then(function(){if(n)throw n;});d=d.finally(function(){b._keyResolver.clear();Promise.all(m).then(function(){b._blobCache.clear()});b._binaryValueProcessQueue.resume();f.done()});return d.then(function(){if(0<h.length)throw new (k||Error)("The following entities failed to synchronize: "+h);return{changed:0<l.length,changedEntities:l,promisedValues:m}})},!0).then(function(a){0<a.changed?c.info("Synchronization finished - Changed local data of",a.changedEntities):c.info("Synchronization finished - No changes to local data");
return a})["catch"](function(a){a instanceof wrm.core.ForbiddenError?c.info("Synchronization halted (forbidden)"):c.error("Synchronization failed:",a);throw a;})};wrm.data.sync.Synchronizer.prototype.hasServerStore=function(a){return!!this._retrieveServerStore(a)};wrm.data.sync.Synchronizer.prototype.registerServerStore=function(a,b){this._serverStoreMap[a.getId()]=b};wrm.data.sync.Synchronizer.prototype._retrieveServerStore=function(a){return this._serverStoreMap[a.getId()]||null};
wrm.data.sync.Synchronizer.prototype.setPreferredOrder=function(a){this._preferredOrder=a?a.map(function(a){return a.getId()}):null};wrm.data.sync.Synchronizer.prototype.hasOutboundChanges=function(a){var b=this;return this._dataRunner.execute(function(c){return b._dataTrackerService.createChangeCollector(c,a).next().then(function(a){return!!a})})};
wrm.data.sync.Synchronizer.prototype._createEntityOrchestrator=function(a){var b=wrm.data.sync.Synchronizer._CONFIG,c=this._log,d=this._preferredOrder;a=a.entities.slice();d&&(a.forEach(function(a){0>d.indexOf(a.getId())&&c.warn("No order specified for",a)}),a.sort(function(a,b){a=d.indexOf(a.getId());b=d.indexOf(b.getId());return a-b}));return new wrm.data.sync.EntityOrchestrator(a,!!d,b.maxParallelSyncs)};
wrm.data.sync.Synchronizer.prototype._createEntitySynchronizers=function(a,b,c){var d=wrm.data.sync.Synchronizer._CONFIG,e=d.useParallel?c.getEntities():c.getSortedEntities(),f=new wrm.data.sync.Synchronizer.Monitor,g=[];e.forEach(function(e){var k=this._retrieveServerStore(e);if(k){var l=this._blobCache.createChangeListener(),m=new wrm.data.sync.ObjectPusher(e,this._dataRunner,this._backEndService,this._log),n=new wrm.data.sync.ObjectPuller(e,this._dataRunner,this._backEndService,this._log);n.setBlobCache(this._blobCache);
n.setBinaryValueProcessQueue(this._binaryValueProcessQueue);e=c.notifySynchronizationStarted.bind(c,e);k=new wrm.data.sync.EntitySynchronizer(k,b.token,b.waitForAllValues,a,m,n,this._dataTrackerService,this._backEndService,this._binaryValueProcessQueue,this._purger,this._keyResolver,this._dataRunner,l,e,this._manager);k.setMonitor(f);k.setConcurrency(d.perSyncConcurrency,Math.max(1,Math.round(d.perSyncConcurrency/d.perSyncSelectConcurrencyRatio)));g.push(k)}},this);return g};
wrm.data.sync.Synchronizer.prototype._synchronizeEntity=function(a,b,c,d){var e=this,f=a.getEntity(),g=this.getLastSynchronizationDateTime(f);return a.synchronize(d,{since:g,outbound:b.outbound,inbound:b.inbound}).then(function(a){e._setLastSynchronizationDateTime(f,a.timestamp);return a}).finally(function(){c.notifySynchronizationFinished(f)})};
wrm.data.sync.Synchronizer.prototype.getLastSynchronizationDateTime=function(a){return(a=this._dataService.getAuxiliaryDictionary().get(a.getId()+".lastSync"))?wrm.data.DateTime.fromString(a):null};wrm.data.sync.Synchronizer.prototype._setLastSynchronizationDateTime=function(a,b){var c=this._dataService.getAuxiliaryDictionary();b?(c.set(a.getId()+".lastSync",b.toString()),wrm.nav.SystemValues.lastSynchronizationTimestamp=b):c.remove(a.getId()+".lastSync")};
wrm.data.sync.Synchronizer.prototype.clearLastSynchronizationDateTime=function(a){this._setLastSynchronizationDateTime(a,null)};wrm.data.sync.Synchronizer.Monitor=function(){var a=new wrm.util.TaskQueue({maxWorkers:wrm.data.sync.Synchronizer._CONFIG.maxNetworkRequests});this.workWithNetwork=function(b){return a.post(b.bind(this))}};
wrm.data.sync.Synchronizer.prototype.clearOutgoingChanges=function(a){var b=this;return this._dataService.execute(function(c){var d=b._dataTrackerService.createChangeCollector(c,a);return function f(){return d.next().then(function(a){if(a)return f()})}()})};wrm.nav.Event=function(a,b,c){this._type=a;this._specifier=b||null;this._parameters=c||{};this._target=null};exportSymbol("wrm.nav.Event",wrm.nav.Event);wrm.nav.Event.prototype.getName=function(){return this._specifier?this._type+"."+this._specifier:this._type};exportProperty(wrm.nav.Event.prototype,"getName",wrm.nav.Event.prototype.getName);wrm.nav.Event.prototype.getType=function(){return this._type};exportProperty(wrm.nav.Event.prototype,"getType",wrm.nav.Event.prototype.getType);
wrm.nav.Event.prototype.getSpecifier=function(){return this._specifier};exportProperty(wrm.nav.Event.prototype,"getSpecifier",wrm.nav.Event.prototype.getSpecifier);wrm.nav.Event.prototype.getParameters=function(){return this._parameters};exportProperty(wrm.nav.Event.prototype,"getParameters",wrm.nav.Event.prototype.getParameters);wrm.nav.Event.prototype.initTarget=function(a){if(this._target)throw Error("Event already dispatched to a target");this._target=a};
exportProperty(wrm.nav.Event.prototype,"initTarget",wrm.nav.Event.prototype.initTarget);wrm.nav.Event.prototype.getTarget=function(){return this._target};exportProperty(wrm.nav.Event.prototype,"getTarget",wrm.nav.Event.prototype.getTarget);wrm.nav.Event.prototype.toString=function(){return this.getName()+" "+JSON.stringify(this._parameters)};exportProperty(wrm.nav.Event.prototype,"toString",wrm.nav.Event.prototype.toString);wrm.nav.Progress=function(a){this._message=a};exportSymbol("wrm.nav.Progress",wrm.nav.Progress);wrm.nav.Progress.prototype.getMessage=function(){return this._message};exportProperty(wrm.nav.Progress.prototype,"getMessage",wrm.nav.Progress.prototype.getMessage);wrm.nav.Progress.prototype.toString=function(){return'Progress:"'+this._message+'"'};exportProperty(wrm.nav.Progress.prototype,"toString",wrm.nav.Progress.prototype.toString);wrm.util.DefaultProgressMonitor=function(a,b){var c=this;this._callback=a;this._minInterval=void 0!==b?b:1E3;this._callbackTimeout=null;this._fireCallbackBound=function(){c._fireCallback()};this._ticks=0;this._totalTicks=100;this._progress=0};exportSymbol("wrm.util.DefaultProgressMonitor",wrm.util.DefaultProgressMonitor);wrm.util.DefaultProgressMonitor.prototype.resize=function(a){this._totalTicks=Math.max(a,1E-20);0>=a&&this.done()};
exportProperty(wrm.util.DefaultProgressMonitor.prototype,"resize",wrm.util.DefaultProgressMonitor.prototype.resize);wrm.util.DefaultProgressMonitor.prototype.worked=function(a){var b=a/this._totalTicks;this._ticks+=a;this._contribute(b)};exportProperty(wrm.util.DefaultProgressMonitor.prototype,"worked",wrm.util.DefaultProgressMonitor.prototype.worked);
wrm.util.DefaultProgressMonitor.prototype.sub=function(a){var b=a/this._totalTicks;this._ticks+=a;return new wrm.util.DefaultProgressMonitor._Sub(this,b)};exportProperty(wrm.util.DefaultProgressMonitor.prototype,"sub",wrm.util.DefaultProgressMonitor.prototype.sub);wrm.util.DefaultProgressMonitor.prototype.done=function(){var a=(this._totalTicks-this._ticks)/this._totalTicks;this._ticks=this._totalTicks;this._contribute(a);null!==this._callbackTimeout&&GLOBAL.clearTimeout(this._callbackTimeout)};
exportProperty(wrm.util.DefaultProgressMonitor.prototype,"done",wrm.util.DefaultProgressMonitor.prototype.done);wrm.util.DefaultProgressMonitor.prototype._contribute=function(a){0>=a||(this._progress+=a,null===this._callbackTimeout&&(this._callbackTimeout=GLOBAL.setTimeout(this._fireCallbackBound,this._minInterval)))};
wrm.util.DefaultProgressMonitor.prototype._fireCallback=function(){this._callbackTimeout=null;try{this._callback(this._progress)}catch(a){DEBUG&&console.error("Error in progress monitor callback",a)}};wrm.util.DefaultProgressMonitor._Sub=function(a,b){this._root=a;this._fraction=b;this._ticks=0;this._totalTicks=100};wrm.util.DefaultProgressMonitor._Sub.prototype.resize=function(a){this._totalTicks=Math.max(a,1E-20);0>=a&&this.done()};
wrm.util.DefaultProgressMonitor._Sub.prototype.worked=function(a){var b=a/this._totalTicks*this._fraction;this._ticks+=a;this._root._contribute(b)};wrm.util.DefaultProgressMonitor._Sub.prototype.sub=function(a){var b=a/this._totalTicks*this._fraction;this._ticks+=a;return new wrm.util.DefaultProgressMonitor._Sub(this._root,b)};wrm.util.DefaultProgressMonitor._Sub.prototype.done=function(){var a=(this._totalTicks-this._ticks)/this._totalTicks*this._fraction;this._ticks=this._totalTicks;this._root._contribute(a)};wrm.data.sync.DataSyncService=function(a,b,c){wrm.core.AbstractService.call(this,a,b,c);this._lastAccessSynchroSerial=null;this._nonPeriodicalSyncRunning=0;this._asyncErrorsSuppressed=!1;this._syncResult={changed:!1,promisedValues:[]};this._stable=!1;this._unstableInstance=new wrm.core.VolatileHolder(this)};extendConstructor(wrm.data.sync.DataSyncService,wrm.core.AbstractService);exportSymbol("wrm.data.sync.DataSyncService",wrm.data.sync.DataSyncService);
wrm.data.sync.DataSyncService.prototype.initialize=function(a){var b=this,c=this.getManager();return Promise.all([c.getDataTrackerService().then(function(a){b._dataTrackerService=a}),c.getSecurityService().then(function(a){b._securityService=a}),c.getBackEndService().then(function(a){b._backEndService=a}),c.getLocalizationService().then(function(a){b._l10nService=a})]).then(function(){return c.getUpdateService().then(function(a){var c=b._createUpdater();a.registerParticipant(wrm.data.sync.DataSyncService.UPDATE_ID,
c)})}).then(function(){return c.getDataService().then(function(c){c.useUnstable(b._reinitFromDataService.bind(b,a))})})};exportProperty(wrm.data.sync.DataSyncService.prototype,"initialize",wrm.data.sync.DataSyncService.prototype.initialize);wrm.data.sync.DataSyncService.prototype._createUpdater=function(){return new wrm.data.sync.DataSyncUpdater(wrm.data.sync.Synchronizer.CURRENT_VERSION,this,this._securityService,this._backEndService,this._l10nService,this.getLog())};
wrm.data.sync.DataSyncService.prototype._reinitFromDataService=function(a,b,c){this._dataService=b;this._entityLists=c?wrm.data.sync.DataSyncService._createEntityLists(a.entities,b.getMetadata()):null;this._synchronizer=null;this._stable=c;this._unstableInstance.swap(c?null:new wrm.data.sync.UnstableDataSyncService(this))};
wrm.data.sync.DataSyncService._createEntityLists=function(a,b){var c={onStartup:[],onReopen:[],onPeriod:[]};Object.keys(a).forEach(function(d){var e=b.getEntity(d);d=a[d];!0===d.startup&&c.onStartup.push(e);"number"===typeof d.reopen&&c.onReopen.push({entity:e,interval:6E4*d.reopen});"number"===typeof d.period&&c.onPeriod.push({entity:e,interval:6E4*d.period})});return c};wrm.data.sync.DataSyncService.ID="_datasync";exportProperty(wrm.data.sync.DataSyncService,"ID",wrm.data.sync.DataSyncService.ID);
wrm.data.sync.DataSyncService.UPDATE_ID="datasync";exportProperty(wrm.data.sync.DataSyncService,"UPDATE_ID",wrm.data.sync.DataSyncService.UPDATE_ID);wrm.data.sync.DataSyncService.prototype.handleUnstableUse=function(){throw Error("The Data Sync Service is not stable");};exportProperty(wrm.data.sync.DataSyncService.prototype,"handleUnstableUse",wrm.data.sync.DataSyncService.prototype.handleUnstableUse);wrm.data.sync.DataSyncService.prototype.useUnstable=function(a){this._unstableInstance.use(a)};
wrm.data.sync.DataSyncService.prototype.hasServerStore=function(a){return this._getSynchronizer().hasServerStore(a)};wrm.data.sync.DataSyncService.prototype.registerServerStore=function(a,b){this._getSynchronizer().registerServerStore(a,b)};wrm.data.sync.DataSyncService.prototype.hasOutboundChanges=function(a){return this._getSynchronizer().hasOutboundChanges(a)};
wrm.data.sync.DataSyncService.prototype._getSynchronizer=function(){if(!this._synchronizer){var a=new wrm.data.sync.Synchronizer(this._dataService,this._dataTrackerService,this._backEndService,this.getManager());this._dataService.getMetadata().getEntities().forEach(function(b){b.getServerName()&&a.registerServerStore(b,new wrm.data.sync.BackEndServerStore(b,this._backEndService))},this);this._synchronizer=a}return this._synchronizer};
wrm.data.sync.DataSyncService.prototype.synchronizeOnStartup=function(a){var b=wrm.data.sync.DataSyncService._Trigger,c=this,d=this.getLog(),e=this._securityService.getLastAuth();this._lastAccessSynchroSerial=e&&e.serial;e=!1;this._isPendingFirstSynchronization()&&(d.debug("Will perform a pending 'first' synchronization"),e=!0);if(e)return this._setPendingFirstSynchronization(!0),this._doSynchronizeSync(b.FIRST_STARTUP,{},a);this._doSynchronizeAsync(b.SUBSEQUENT_STARTUP,{},a).then(function(){c.collectSuccessEvents(a)});
return Promise.resolve(null)};exportProperty(wrm.data.sync.DataSyncService.prototype,"synchronizeOnStartup",wrm.data.sync.DataSyncService.prototype.synchronizeOnStartup);
wrm.data.sync.DataSyncService.prototype.synchronizeDuringNavigation=function(a){var b=wrm.data.sync.DataSyncService._Trigger,c=this,d=this.getLog(),e=this._securityService.getLastAuth(),f=e&&e.serial;if(f!==this._lastAccessSynchroSerial){this._lastAccessSynchroSerial=f;e=e.usernameChanged;!e&&this._isPendingFirstSynchronization()&&(d.debug("Will perform a pending 'first' synchronization"),e=!0);if(e)return this._setPendingFirstSynchronization(!0),this._doSynchronizeSync(b.FIRST_ACCESS,{},a);this._doSynchronizeAsync(b.SUBSEQUENT_ACCESS,
{},a).then(function(){c.collectSuccessEvents(a)})}return Promise.resolve(null)};exportProperty(wrm.data.sync.DataSyncService.prototype,"synchronizeDuringNavigation",wrm.data.sync.DataSyncService.prototype.synchronizeDuringNavigation);wrm.data.sync.DataSyncService.prototype.synchronizeOnResume=function(a){return this._doSynchronizeAsync(wrm.data.sync.DataSyncService._Trigger.RESUME,{},a)};exportProperty(wrm.data.sync.DataSyncService.prototype,"synchronizeOnResume",wrm.data.sync.DataSyncService.prototype.synchronizeOnResume);
wrm.data.sync.DataSyncService.prototype.startPeriodicalSynchronization=function(a){var b=this;return this.getManager().getAppService().then(function(c){c.startTimer(b._syncrhonizePeriodically.bind(b),3E4,a)})};exportProperty(wrm.data.sync.DataSyncService.prototype,"startPeriodicalSynchronization",wrm.data.sync.DataSyncService.prototype.startPeriodicalSynchronization);
wrm.data.sync.DataSyncService.prototype._syncrhonizePeriodically=function(a){return this._doSynchronizeAsync(wrm.data.sync.DataSyncService._Trigger.PERIOD,{},a)};wrm.data.sync.DataSyncService.prototype.synchronize=function(a,b){return this._doSynchronizeSync(wrm.data.sync.DataSyncService._Trigger.REQUEST,a,b)};exportProperty(wrm.data.sync.DataSyncService.prototype,"synchronize",wrm.data.sync.DataSyncService.prototype.synchronize);
wrm.data.sync.DataSyncService.prototype._doSynchronizeSync=function(a,b,c){var d=wrm.data.sync.DataSyncService._Trigger,e=wrm.data.sync.DataSyncError,f=this,g=this.getLog();if(0<this._nonPeriodicalSyncRunning&&a!==d.REQUEST)return g.debug("Skipping synchronous synchronization during another synchronous attempt"),Promise.resolve(null);a!==d.PERIOD&&this._nonPeriodicalSyncRunning++;return Promise.resolve().then(function(){return f._runSynchronization(a,b,!1,c)}).then(function(b){f._setSynchronizedOnceOnSync();
a!==d.PERIOD&&f._nonPeriodicalSyncRunning--;f._handleNoError();f._finalizeSynchronization(b);return null})["catch"](function(g){a!==d.PERIOD&&f._nonPeriodicalSyncRunning--;g=g instanceof e?g.getReason():e.Reason.INTERNAL_ERROR;var k=f._doSynchronizeSync.bind(f,a,b,c);return f._handleErrorSync(g,a,k,c)})};
wrm.data.sync.DataSyncService.prototype._doSynchronizeAsync=function(a,b,c){var d=wrm.data.sync.DataSyncService._Trigger,e=wrm.data.sync.DataSyncError,f=this;if(!this._backEndService.isReachable()||0<this._nonPeriodicalSyncRunning&&a!==d.REQUEST)return Promise.resolve(null);a!==d.PERIOD&&this._nonPeriodicalSyncRunning++;return Promise.resolve().then(function(){return f._runSynchronization(a,b,!0,c)}).then(function(b){a!==d.PERIOD&&f._nonPeriodicalSyncRunning--;f._handleNoError();f._finalizeSynchronization(b);
return null})["catch"](function(g){a!==d.PERIOD&&f._nonPeriodicalSyncRunning--;g=g instanceof e?g.getReason():e.Reason.INTERNAL_ERROR;var h=f._doSynchronizeAsync.bind(f,a,b,c);return f._handleErrorAsync(g,a,h,c)})};wrm.data.sync.DataSyncService.prototype._finalizeSynchronization=function(a){this._syncResult.changed=this._syncResult.changed||a.changed;this._syncResult.promisedValues=this._syncResult.promisedValues.concat(a.promisedValues)};
wrm.data.sync.DataSyncService.prototype.isBackgroundDownloading=function(){return this._getSynchronizer().isBackgroundDownloading()};exportProperty(wrm.data.sync.DataSyncService.prototype,"isBackgroundDownloading",wrm.data.sync.DataSyncService.prototype.isBackgroundDownloading);
wrm.data.sync.DataSyncService.prototype.collectSuccessEvents=function(a){var b=this.getLog();if(!this._nonPeriodicalSyncRunning){this._syncResult.changed&&a.dispatchEvent(new wrm.nav.Event("SynchronizationSuccess"));var c=this._syncResult.promisedValues.filter(function(a){return a.isPending()});0<c.length&&(b.debug("Expecting",c.length,"pending values to update later"),wrm.util.promiseAllIncrementally(c,1E3,5E3,function(c){b.debug("Updated",c.length,"more pending values from previous synchronization");
a.dispatchEvent(new wrm.nav.Event("SynchronizationSuccess"))}));this._syncResult.changed=!1;this._syncResult.promisedValues=[]}};exportProperty(wrm.data.sync.DataSyncService.prototype,"collectSuccessEvents",wrm.data.sync.DataSyncService.prototype.collectSuccessEvents);wrm.data.sync.DataSyncService.prototype.scheduleFirstSynchronization=function(){this._setPendingFirstSynchronization(!0)};wrm.data.sync.DataSyncService.prototype._isPendingFirstSynchronization=function(){return"true"===this.getManager().getPlatform().retrieveDictionary("_dataSync").get("pendingFirst")};
wrm.data.sync.DataSyncService.prototype._setPendingFirstSynchronization=function(a){this.getManager().getPlatform().retrieveDictionary("_dataSync").set("pendingFirst",String(a))};wrm.data.sync.DataSyncService.prototype.setPreferredSynchronizationOrder=function(a){this._getSynchronizer().setPreferredOrder(a)};exportProperty(wrm.data.sync.DataSyncService.prototype,"setPreferredSynchronizationOrder",wrm.data.sync.DataSyncService.prototype.setPreferredSynchronizationOrder);
wrm.data.sync.DataSyncService._Trigger={FIRST_STARTUP:"first startup",SUBSEQUENT_STARTUP:"subsequent startup",FIRST_ACCESS:"first access",SUBSEQUENT_ACCESS:"subsequent access",RESUME:"resume",PERIOD:"period",REQUEST:"request"};
wrm.data.sync.DataSyncService.prototype._runSynchronization=function(a,b,c,d){var e=wrm.data.sync.DataSyncError,f=wrm.data.sync.DataSyncError.Reason,g=wrm.data.sync.DataSyncService._Trigger,h=this,k=this.getLog(),l=this._getSynchronizer(),m;switch(a){case g.FIRST_STARTUP:case g.FIRST_ACCESS:m=this._getEntityLists().onStartup.slice();break;case g.SUBSEQUENT_STARTUP:case g.SUBSEQUENT_ACCESS:m=this._filterTimedEntityList(this._getEntityLists().onReopen,l);break;case g.RESUME:m=this._filterTimedEntityList(this._getEntityLists().onReopen,
l,wrm.data.DateTime.now());break;case g.PERIOD:m=this._filterTimedEntityList(this._getEntityLists().onPeriod,l,wrm.data.DateTime.now());break;case g.REQUEST:m=b.entities.slice()||[];break;default:if(DEBUG)throw Error("Unsupported trigger");m=[]}if(0>=m.length)return Promise.resolve({changed:!1,promisedValues:[]});if(!l.checkAvailable(m))return Promise.reject(new e("Back-end not available",f.BACKEND_UNAVAILABLE));c=c?0:10;var n=!this._isAccessTrigger(a);b=angular.extend({},b,{entities:m});m=a===g.REQUEST;
k.debug("Attempting synchronization triggered by",a);this._reportSynchronizationProgress(!0,d);return this._doRunSynchronization(n,m,l,b,c).then(function(b){h._reportSynchronizationProgress(!1,d);a!==g.FIRST_STARTUP&&a!==g.FIRST_ACCESS||h._setPendingFirstSynchronization(!1);return b},function(a){h._reportSynchronizationProgress(!1,d);if(a instanceof e)throw a;var b=f.INTERNAL_ERROR;a instanceof wrm.core.ForbiddenError?b=f.FORBIDDEN:a instanceof wrm.core.NetworkError&&(b=f.NETWORK_ERROR);throw new e(a.message,
b);})};wrm.data.sync.DataSyncService.prototype._getEntityLists=function(){if(!this._entityLists)throw this.handleUnstableUse(),Error("Operation not available on unstable Data Sync Service");return this._entityLists};
wrm.data.sync.DataSyncService.prototype._doRunSynchronization=function(a,b,c,d,e){var f=wrm.data.sync.DataSyncError,g=wrm.data.sync.DataSyncError.Reason,h=this,k=this.getLog(),l;l=k.isDebugEnabled()?new wrm.util.DefaultProgressMonitor(function(a){k.debug("Synchronization progress:",(100*a).toFixed(2)+"%")},1E4):wrm.util.FakeProgressMonitor.INSTANCE;var m=d.token||null,n=function(a){return c.synchronize({entities:d.entities||[],outbound:!1!==d.outbound,inbound:!1!==d.inbound,token:a,waitForAllValues:b,
progressMonitor:l},e)},p=!1;return Promise.resolve().then(function(){return h._actionAttempt(!1,m,n)["catch"](function(b){if(a&&b instanceof wrm.core.ForbiddenError)return p=!0,k.debug("Authentication token appears to be no longer valid: will attempt to re-access"),{success:!1,value:void 0};throw b;})}).then(function(b){if(b.success)return b.value;if(!a||!p)throw new f("Not logged in",g.LOGGED_OUT);return h._actionAttempt(!0,m,n).then(function(a){if(a.success)return a.value;throw new f("Not logged in and access denied",
g.LOGGED_OUT_ACCESS_DENIED);})})};wrm.data.sync.DataSyncService.prototype._actionAttempt=function(a,b,c){var d=this,e=this._securityService;return(a?e.access(!1,wrm.nav.newInternalState()):Promise.resolve(null)).then(function(f){if(null!==f)return{success:!1,value:void 0};a&&(f=e.getLastAuth(),d._lastAccessSynchroSerial=f&&f.serial);return(b?Promise.resolve(b):e.retrieveCurrentToken()).then(function(a){return a?c(a).then(function(a){return{success:!0,value:a}}):{success:!1,value:void 0}})})};
wrm.data.sync.DataSyncService.prototype._reportSynchronizationProgress=function(a,b){a=a?this._l10nService.formatMessage("notification.synchronizationProgress"):null;b.reportProgress(new wrm.nav.Progress(a))};wrm.data.sync.DataSyncService.prototype._hasSynchronizedOnceSync=function(){var a=this._dataService.getAuxiliaryDictionary();return wrm.data.toBoolean(a.get("synchronization.onceSync"))||!1};
wrm.data.sync.DataSyncService.prototype._setSynchronizedOnceOnSync=function(){this._dataService.getAuxiliaryDictionary().set("synchronization.onceSync",wrm.data.toString(!0))};wrm.data.sync.DataSyncService.prototype._handleNoError=function(){this._asyncErrorsSuppressed=!1};
wrm.data.sync.DataSyncService.prototype._handleErrorSync=function(a,b,c,d){var e=wrm.data.sync.DataSyncError.Reason,f=wrm.data.sync.DataSyncService._Trigger,g=this,h=this._securityService;if(a===e.LOGGED_OUT&&(b==f.FIRST_STARTUP||b==f.SUBSEQUENT_STARTUP))return this.getLog().debug("Synchronization aborted: the user is logged out during startup"),Promise.resolve(null);var f=this._getErrorDialogMessage(a),k=d.getContextualStartPanelId(),l=this._isAccessTrigger(b);k?(a=wrm.nav.Dialog.Flavor.NEGATIVE,
b=[{label:"dialog.button.OK",callback:function(){return(l?h.clearUser(!1):Promise.resolve()).then(function(){d.stepImplicitly();return wrm.nav.Route.toService(k||void 0)})}}]):this._hasSynchronizedOnceSync()?a===e.LOGGED_OUT_ACCESS_DENIED?(a=wrm.nav.Dialog.Flavor.NEGATIVE,b=[{label:"dialog.button.OK",callback:function(){return h.clearUser(!1).then(function(){return h.access(!0,d)})}}]):(a=wrm.nav.Dialog.Flavor.CAUTIONAL,b=[{label:"dialog.button.Retry",callback:function(){return null},"default":!0},
{label:"dialog.button.Continue",callback:function(){g._asyncErrorsSuppressed=!0;return c=null}}]):(a=wrm.nav.Dialog.Flavor.NEGATIVE,b=[{label:"dialog.button.Retry",callback:function(){return null},"default":!0},{label:"dialog.button.Exit",callback:function(){return h.clearUser(!1).then(function(){return h.access(!0,d)})}}]);return this._presentDialog(a,f,b,d).then(function(a){return a?a:c?Promise.resolve(c()):null})};
wrm.data.sync.DataSyncService.prototype._handleErrorAsync=function(a,b,c,d){var e=wrm.data.sync.DataSyncError.Reason,f=this,g=this._securityService;if(this._asyncErrorsSuppressed)return Promise.resolve(null);b=this._getErrorDialogMessage(a);switch(a){case e.LOGGED_OUT:case e.BACKEND_UNAVAILABLE:return Promise.resolve(null);case e.FORBIDDEN:a=wrm.nav.Dialog.Flavor.NEGATIVE;e=[{label:"dialog.button.OK",callback:function(){return g.access(!0,d)}}];break;default:a=wrm.nav.Dialog.Flavor.CAUTIONAL,e=[{label:"dialog.button.Retry",
callback:function(){return null},"default":!0},{label:"dialog.button.Continue",callback:function(){f._asyncErrorsSuppressed=!0;return wrm.nav.Route.toNowhere()}}]}return this._presentDialog(a,b,e,d).then(function(a){return a?a:c?Promise.resolve(c()):wrm.nav.Route.toNowhere()})};wrm.data.sync.DataSyncService.prototype._isAccessTrigger=function(a){var b=wrm.data.sync.DataSyncService._Trigger;return a===b.FIRST_ACCESS||a===b.SUBSEQUENT_ACCESS};
wrm.data.sync.DataSyncService.prototype._getErrorDialogMessage=function(a){var b=wrm.data.sync.DataSyncError.Reason;switch(a){case b.LOGGED_OUT_ACCESS_DENIED:case b.FORBIDDEN:return"notification.synchronizationForbidden";case b.NETWORK_ERROR:return navigator.connection.type===Connection.NONE?"notification.synchronizationNetworkUnavailable":"notification.synchronizationNetworkError"}return"notification.synchronizationError"};
wrm.data.sync.DataSyncService.prototype._presentDialog=function(a,b,c,d){var e=this._l10nService;b=e.formatMessage(b);var f=[];c.forEach(function(a,b){f.push({label:e.formatMessage(a.label),value:b,"default":a["default"]})});return d.presentDialog(new wrm.nav.Dialog(b,a,f)).then(function(a){return c[a.value].callback()})};
wrm.data.sync.DataSyncService.prototype.clearOutgoingChanges=function(){var a=this._getSynchronizer();return this._dataService.getMetadata().getEntities().reduce(function(b,c){return c instanceof wrm.data.meta.AuxEntity||c instanceof wrm.data.meta.BridgeEntity||c.getId()===wrm.Constants.USER_ENT_ID||c.getId()===wrm.Constants.ROLE_ENT_ID?b:b.then(function(){return a.clearOutgoingChanges(c)})},Promise.resolve())};exportProperty(wrm.data.sync.DataSyncService.prototype,"clearOutgoingChanges",wrm.data.sync.DataSyncService.prototype.clearOutgoingChanges);
wrm.data.sync.DataSyncService.prototype.clearLastSynchronizationDateTime=function(a){this._getSynchronizer().clearLastSynchronizationDateTime(a)};exportProperty(wrm.data.sync.DataSyncService.prototype,"clearLastSynchronizationDateTime",wrm.data.sync.DataSyncService.prototype.clearLastSynchronizationDateTime);
wrm.data.sync.DataSyncService.prototype._filterTimedEntityList=function(a,b,c){if(!c)return a.map(function(a){return a.entity});var d=c.asDate().valueOf(),e=[];a.forEach(function(a){var c=b.getLastSynchronizationDateTime(a.entity),c=c?c.asDate().valueOf():0;d-c>a.interval&&e.push(a.entity)});return e};wrm.core.SecurityService=function(a,b,c){wrm.core.AbstractService.call(this,a,b,c);this._requireAllowRoles=b.requireAllowRoles;this._authScreen=this.getOptionalDescriptorValue(b,"authScreen")||null;this._authActionDef=this.getOptionalDescriptorValue(b,"authActionDefinition")||null;this._accountManagerConfig=this.getOptionalDescriptorValue(b,"accountManager")||{};this._accountManagerAvailable=!1;this._userInfo=this._lastAuth=null};extendConstructor(wrm.core.SecurityService,wrm.core.AbstractService);
exportSymbol("wrm.core.SecurityService",wrm.core.SecurityService);
wrm.core.SecurityService.prototype.initialize=function(){var a=this,b=this.getManager(),c=b.getPlatform(),d=this.getLog();return Promise.all([b.getBackEndService().then(function(b){a._backEndService=b})]).then(function(){return b.getDataService().then(function(b){b.useUnstable(a._reinitFromDataService.bind(a))})}).then(function(){return a._initializeAccountManager()}).then(function(){c.addNotificationStatusListener(function(){d.debug("Platform notification status changed: attempting to re-authenticate");a._authenticateAgain().catch(function(a){d.error("Error re-authenticating",
a)})})}).then(function(){if(a._accountManagerAvailable)return a._loadPlatformAuth()})};exportProperty(wrm.core.SecurityService.prototype,"initialize",wrm.core.SecurityService.prototype.initialize);wrm.core.SecurityService.ID="_security";exportProperty(wrm.core.SecurityService,"ID",wrm.core.SecurityService.ID);wrm.core.SecurityService.prototype._reinitFromDataService=function(a,b){this._dataService=a;this._userServerStore=this._userEntity=null};
wrm.core.SecurityService.prototype._getUserEntity=function(){this._userEntity||(this._userEntity=this._dataService.getMetadata().getEntity(wrm.Constants.USER_ENT_ID));return this._userEntity};wrm.core.SecurityService.prototype._getRoleEntity=function(){this._roleEntity||(this._roleEntity=this._dataService.getMetadata().getEntity(wrm.Constants.ROLE_ENT_ID));return this._roleEntity};
wrm.core.SecurityService.prototype._getUserServerStore=function(){this._userServerStore||(this._userServerStore=new wrm.core.UserServerStore(this._getUserEntity(),this._backEndService));return this._userServerStore};wrm.core.SecurityService.prototype._getDataSyncService=function(){var a=this;this._dataSyncService||(this._dataSyncService=this.getManager().getDataSyncService().then(function(b){var c=a._getUserEntity(),d=a._getUserServerStore();b.registerServerStore(c,d);return b}));return this._dataSyncService};
wrm.core.SecurityService.prototype.getLastAuth=function(){return this._lastAuth};wrm.core.SecurityService.prototype.isUserServiceAvailable=function(){return!!this._getUserEntity().getServerName()};exportProperty(wrm.core.SecurityService.prototype,"isUserServiceAvailable",wrm.core.SecurityService.prototype.isUserServiceAvailable);wrm.core.SecurityService.prototype.getUserEntity=function(){return this._getUserEntity()};exportProperty(wrm.core.SecurityService.prototype,"getUserEntity",wrm.core.SecurityService.prototype.getUserEntity);
wrm.core.SecurityService.prototype.checkPermission=function(a,b){var c=this;return this._checkPermissionAttempt(!1,!1,a,b).then(function(d){return d?c._checkPermissionAttempt(!0,!1,a,b).then(function(d){return d?c._checkPermissionAttempt(!0,!0,a,b):null}):null})};exportProperty(wrm.core.SecurityService.prototype,"checkPermission",wrm.core.SecurityService.prototype.checkPermission);
wrm.core.SecurityService.prototype._checkPermissionAttempt=function(a,b,c,d){var e=this;return(a?this.access(b,d):Promise.resolve(null)).then(function(a){return null!==a?a:e.getUserInfo().then(function(a){return a&&e._hasPermission(a,c)?null:wrm.nav.Route.toNowhere()})})};wrm.core.SecurityService.prototype._hasPermission=function(a,b){if(!this._requireAllowRoles&&0===b.length)return!!a;a=a.getRoleNames();for(var c=0;c<b.length;c++)if(0<=a.indexOf(b[c]))return!0;return!1};
wrm.core.SecurityService.prototype.access=function(a,b){var c=this;return(a?Promise.resolve(!1):this._accessAutomatic(b)).then(function(a){return a?null:c._accessInteractive(b)})};exportProperty(wrm.core.SecurityService.prototype,"access",wrm.core.SecurityService.prototype.access);wrm.core.SecurityService.prototype.accessAgain=function(a,b){var c=this,d=this._loadPlatformAuth();return d=d.then(function(d){return d?c.access(a,b):null})};
exportProperty(wrm.core.SecurityService.prototype,"accessAgain",wrm.core.SecurityService.prototype.accessAgain);wrm.core.SecurityService.prototype.accessDefault=function(a){return Promise.resolve(this._accessInteractive(a))};exportProperty(wrm.core.SecurityService.prototype,"accessDefault",wrm.core.SecurityService.prototype.accessDefault);wrm.core.SecurityService.prototype._accessInteractive=function(a){if(!this._authScreen)throw Error("Authentication screen not available");a.stepImplicitly();return wrm.nav.Route.toService(this._authScreen)};
wrm.core.SecurityService.prototype._accessAutomatic=function(a){if(!this._authActionDef)return Promise.resolve(!1);var b=this.getManager().getActionDefinitionService(this._authActionDef);return this._loadPlatformAuth().then(function(c){if(!c)return!1;var d={username:c.username,password:c.password};return b.then(function(b){return b.execute(d,a)}).then(function(a){return a.isSuccess()})})};wrm.core.SecurityService.prototype.retrieveAuthUsername=function(){return this._loadPartialPlatformAuth().then(function(a){return a.username})};
exportProperty(wrm.core.SecurityService.prototype,"retrieveAuthUsername",wrm.core.SecurityService.prototype.retrieveAuthUsername);wrm.core.SecurityService.prototype.areAuthCredentialsComplete=function(){return this._loadPlatformAuth().then(function(a){return!!a})};exportProperty(wrm.core.SecurityService.prototype,"areAuthCredentialsComplete",wrm.core.SecurityService.prototype.areAuthCredentialsComplete);
wrm.core.SecurityService.prototype.setAuthCredentials=function(a,b){var c=this;return this._loadPartialPlatformAuth().then(function(d){return c._savePlatformAuth(a,b,d.token)})};exportProperty(wrm.core.SecurityService.prototype,"setAuthCredentials",wrm.core.SecurityService.prototype.setAuthCredentials);
wrm.core.SecurityService.prototype.renewToken=function(a,b){var c=this;return void 0===a||void 0===b?this._loadPlatformAuth().then(function(a){if(!a)throw Error("Incomplete auth credentials");return c._doRenewToken(a.username,a.password)}):this._doRenewToken(a,b)};exportProperty(wrm.core.SecurityService.prototype,"renewToken",wrm.core.SecurityService.prototype.renewToken);
wrm.core.SecurityService.prototype._doRenewToken=function(a,b){var c=this;return this._authenticate(a,b).then(function(d){return c._savePlatformAuth(a,b,d.token)})};wrm.core.SecurityService.prototype.retrieveCurrentToken=function(){return this._loadPlatformAuth().then(function(a){return a?a.token:null})};exportProperty(wrm.core.SecurityService.prototype,"retrieveCurrentToken",wrm.core.SecurityService.prototype.retrieveCurrentToken);
wrm.core.SecurityService.prototype.authenticateChangeUser=function(a,b){var c=this,d=a!==this._getLastUsername();return this._authenticate(a,b).then(function(d){return c._replaceUserInfoFromServer(d.record,d.serverKey,d.token,d.roles).then(function(){c._setLastUsername(a);return c._savePlatformAuth(a,b,d.token)})}).then(function(){c._lastAuth={serial:(c._lastAuth&&c._lastAuth.serial||0)+1,usernameChanged:d}})};exportProperty(wrm.core.SecurityService.prototype,"authenticateChangeUser",wrm.core.SecurityService.prototype.authenticateChangeUser);
wrm.core.SecurityService.prototype.changeUser=function(a,b,c){var d=this,e=a!==this._getLastUsername();return this._replaceUserInfoFromClient(a,null,{},[]).then(function(){d._setLastUsername(a);return d._savePlatformAuth(a,b,c)}).then(function(){d._lastAuth={serial:(d._lastAuth&&d._lastAuth.serial||0)+1,usernameChanged:e}})};exportProperty(wrm.core.SecurityService.prototype,"changeUser",wrm.core.SecurityService.prototype.changeUser);
wrm.core.SecurityService.prototype._authenticate=function(a,b){if(!this.isUserServiceAvailable())throw Error("User services are not available");return this._backEndService.loginUser(a,b)};wrm.core.SecurityService.prototype._authenticateAgain=function(){var a=this;return this._loadPlatformAuth().then(function(b){if(b)return a._authenticate(b.username,b.password)})};wrm.core.SecurityService.prototype.clearUser=function(a){var b=this;return this._clearUserInfo().then(function(){return b._clearPlatformAuth(a)})};
exportProperty(wrm.core.SecurityService.prototype,"clearUser",wrm.core.SecurityService.prototype.clearUser);wrm.core.SecurityService.prototype.getUserInfo=function(){this._userInfo||(this._userInfo=this._doGetUserInfo());return this._userInfo};exportProperty(wrm.core.SecurityService.prototype,"getUserInfo",wrm.core.SecurityService.prototype.getUserInfo);
wrm.core.SecurityService.prototype._doGetUserInfo=function(){var a=this;return this._dataService.execute(function(b){return a._selectUserAndRoles(b)}).then(function(a){if(!a)return null;var c={};a.roleNames.forEach(function(a){c[a]={}});return new wrm.core.UserInfo(a.username,a.key,a.serverKey,a.properties,c)})};
wrm.core.SecurityService.prototype.updateUserInfo=function(a,b,c){var d=this;if(!this.isUserServiceAvailable())throw Error("User services are not available");var e=this._getUserEntity(),f=e.getProperty(wrm.Constants.USER_USERNAME_ATT_ID).getServerName();if(!f)throw Error("Username attribute is not server-mapped");var g={},h=new wrm.data.sync.ObjectPusher(e,g,this._backEndService,this.getLog()),k=null,l=null;return Promise.try(function(){return Promise.all([d.getUserInfo(),d._loadPlatformAuth()])}).then(function(d){k=
d[0];l=d[1]||null;if(!k||!l)throw Error("Must be logged in to update user information");if(c&&b!==l.password)throw Error("Old password is invalid");g[1]=angular.extend({},k.getProperties(),a);return h.prepareRecordValues(a,1,l.token)}).then(function(a){return a||c?d._backEndService.updateUser(l.token,k.getServerKey(),b,c,a||{}):null}).then(function(b){if(b){var e=b.record[f],p=c||l.password,q=l.token;return Promise.try(function(){return Promise.all(h.finalizeValues(b.record,a,1,q))}).then(function(){return d._replaceUserInfoFromClient(k.getUsername(),
k.getServerKey(),g[1],k.getRoleNames())}).then(function(){return d._mergeUserInfoFromServer(b.record,k.getServerKey(),q,k.getRoleNames())}).then(function(){wrm.nav.SystemValues.token=q;d._setLastUsername(e);return d._savePlatformAuth(e,p,q)})}}).then(function(){return d.getUserInfo()})};exportProperty(wrm.core.SecurityService.prototype,"updateUserInfo",wrm.core.SecurityService.prototype.updateUserInfo);
wrm.core.SecurityService.prototype.registerUser=function(a,b,c){var d=this;if(!this.isUserServiceAvailable())throw Error("User services are not available");var e=this._getUserEntity(),f={},g=new wrm.data.sync.ObjectPusher(e,f,this._backEndService,this.getLog());return Promise.try(function(){f[1]=c;return g.prepareRecordValues(c,1,null)}).then(function(c){c=c||{};return d._backEndService.registerUser(a,b,c)}).then(function(a){return Promise.all(g.finalizeValues(a,c,1,null))}).then(function(){return d._replaceUserInfoFromClient(a,
null,f[1],[])}).then(function(){return d.getUserInfo()})};exportProperty(wrm.core.SecurityService.prototype,"registerUser",wrm.core.SecurityService.prototype.registerUser);
wrm.core.SecurityService.prototype._mergeUserInfoFromServer=function(a,b,c,d){var e=this;return this._dataService.execute(function(f){return e._selectExistingUserServerKey(f).then(function(a){return a!==b?e._deleteUserAndRoles(f):e._deleteRoles(f)}).then(function(){return e._synchronizeUserInbound(f,!1,a,b,c).then(function(a){return e._insertRoles(f,d,a).then(function(){e._userInfo=null;return a})})})})};
wrm.core.SecurityService.prototype._replaceUserInfoFromServer=function(a,b,c,d){var e=this;return this._dataService.execute(function(f){return e._deleteUserAndRoles(f).then(function(){return e._synchronizeUserInbound(f,!0,a,b,c).then(function(a){return e._insertRoles(f,d,a).then(function(){e._userInfo=null;return a})})})})};
wrm.core.SecurityService.prototype._replaceUserInfoFromClient=function(a,b,c,d){var e=this;return this._dataService.execute(function(f){return e._deleteUserAndRoles(f).then(function(){return e._insertUser(f,a,b,c).then(function(a){return e._insertRoles(f,d,a).then(function(){e._userInfo=null;return a})})})})};wrm.core.SecurityService.prototype._clearUserInfo=function(){var a=this;return this._dataService.execute(function(b){return a._deleteUserAndRoles(b)}).then(function(){a._userInfo=null})};
wrm.core.SecurityService.prototype._selectUserAndRoles=function(a){var b=this._getUserEntity(),c=b.getKeyAttribute(),d=b.getAttribute(wrm.Constants.USER_USERNAME_ATT_ID),e=b.getServerKeyAttribute(),f=this._getRoleEntity().getAttribute(wrm.Constants.ROLE_NAME_ATT_ID);return a.selectOne(wrm.Constants.USER_ENT_ID,{outputConfig:{useNames:!0}}).then(function(g){if(!g)return null;var h=g[c.getName()];delete g[c.getName()];var k=g[d.getName()];delete g[d.getName()];var l=null;e&&(l=g[e.getName()],delete g[e.getName()]);
var m={};b.getAttributes().forEach(function(a){a!==c&&a!==d&&a!==e&&(m[a.getId()]=g[a.getName()])});return a.select(wrm.Constants.ROLE_ENT_ID,{outputConfig:{useNames:!0},filter:wrm.Constants.ROLE_USER_ROL_ID+"."+wrm.Constants.USER_OID_ATT_ID},[h]).then(function(a){a=a.map(function(a){return a[f.getName()]});return{key:h,username:k,properties:m,serverKey:l,roleNames:a}})})};
wrm.core.SecurityService.prototype._deleteUserAndRoles=function(a){var b=[];b.push(a["delete"](wrm.Constants.ROLE_ENT_ID));b.push(a["delete"](wrm.Constants.USER_ENT_ID));return Promise.all(b)};wrm.core.SecurityService.prototype._deleteRoles=function(a){var b=[];b.push(a["delete"](wrm.Constants.ROLE_ENT_ID));return Promise.all(b)};
wrm.core.SecurityService.prototype._selectExistingUserKey=function(a){var b=this._getUserEntity();return a.selectOne(wrm.Constants.USER_ENT_ID,{outputConfig:{useNames:!0},output:b.getKeyAttribute().getId()})};wrm.core.SecurityService.prototype._selectExistingUserServerKey=function(a){var b=this._getUserEntity();return a.selectOne(wrm.Constants.USER_ENT_ID,{outputConfig:{useNames:!0},output:b.getServerKeyAttribute().getId()})};
wrm.core.SecurityService.prototype._synchronizeUserInbound=function(a,b,c,d,e){var f=this,g=this._getUserEntity(),h=this._getUserServerStore();c=angular.extend({},c);c[g.getServerKeyAttribute().getServerName()]=d;h.setData(c);return this._getDataSyncService().then(function(a){b&&a.clearLastSynchronizationDateTime(g);return a.synchronize({entities:[g],token:e||void 0},wrm.nav.newInternalState())}).then(function(){return f._selectExistingUserKey(a)})};
wrm.core.SecurityService.prototype._insertUser=function(a,b,c,d){var e=this._getUserEntity().getServerKeyAttribute(),f={};angular.extend(f,d);f[wrm.Constants.USER_USERNAME_ATT_ID]=b;e&&(f[e.getId()]=c);return a.insert(wrm.Constants.USER_ENT_ID,f).then(function(a){return a[0]})};
wrm.core.SecurityService.prototype._insertRoles=function(a,b,c){b=b.map(function(a,b){var f={};f[wrm.Constants.ROLE_OID_ATT_ID]=b+1;f[wrm.Constants.ROLE_NAME_ATT_ID]=a;f[wrm.Constants.ROLE_USER_ROL_ID]=c;return f});return a.insert(wrm.Constants.ROLE_ENT_ID,b)};wrm.core.SecurityService.prototype._setLastUsername=function(a){this._dataService.getAuxiliaryDictionary().set("_security.lastUsername",a)};wrm.core.SecurityService.prototype._getLastUsername=function(){return this._dataService.getAuxiliaryDictionary().get("_security.lastUsername")};
wrm.core.SecurityService.prototype._initializeAccountManager=function(){var a=this,b=this._accountManagerConfig,c=[],d=!1;b.packageName&&(d=!0,c.push(wrm.util.invokePlugin(accountmanager.setPackage.bind(accountmanager,b.packageName))));b.groupId&&b.teamId&&(d=!0,c.push(wrm.util.invokePlugin(accountmanager.enableSharing.bind(accountmanager,b.groupId,b.teamId))));return Promise.all(c).then(function(){a._accountManagerAvailable=d})};
wrm.core.SecurityService.prototype._checkAccountManagerAvailable=function(){if(!this._accountManagerAvailable)throw Error("Account manager not available");};
wrm.core.SecurityService.prototype._clearPlatformAuth=function(a){DEBUG&&this._checkAccountManagerAvailable();var b=[];a&&b.push(wrm.util.invokePlugin(accountmanager.setUsername.bind(accountmanager,null)));b.push(wrm.util.invokePlugin(accountmanager.setPassword.bind(accountmanager,null)));b.push(wrm.util.invokePlugin(accountmanager.setToken.bind(accountmanager,null)));wrm.nav.SystemValues.token=null;return Promise.all(b)};
wrm.core.SecurityService.prototype._savePlatformAuth=function(a,b,c){DEBUG&&this._checkAccountManagerAvailable();var d=[];d.push(wrm.util.invokePlugin(accountmanager.setUsername.bind(accountmanager,a)));d.push(wrm.util.invokePlugin(accountmanager.setPassword.bind(accountmanager,b)));d.push(wrm.util.invokePlugin(accountmanager.setToken.bind(accountmanager,c)));wrm.nav.SystemValues.token=c;return Promise.all(d)};wrm.core.SecurityService.prototype._loadPlatformAuth=function(){return this._doLoadPlatformAuth(!1)};
wrm.core.SecurityService.prototype._loadPartialPlatformAuth=function(){return this._doLoadPlatformAuth(!0)};
wrm.core.SecurityService.prototype._doLoadPlatformAuth=function(a){DEBUG&&this._checkAccountManagerAvailable();var b=[];b.push(wrm.util.invokePlugin(accountmanager.getUsername.bind(accountmanager)));b.push(wrm.util.invokePlugin(accountmanager.getPassword.bind(accountmanager)));b.push(wrm.util.invokePlugin(accountmanager.getToken.bind(accountmanager)));return Promise.all(b).then(function(b){var d=b[0],e=b[1];b=b[2];wrm.nav.SystemValues.token=b;return a||d&&e?{username:d,password:e,token:b}:null})};wrm.data.DataMigrator=function(a){this._log=a};
wrm.data.DataMigrator.prototype.migrate=function(a,b){var c=a.getChangedEntities(),d=a.getReplacedAssociationsIdPairs();return 0>=c.length&&0>=d.length?Promise.resolve():Promise.resolve().then(function(){return c.reduce(function(a,c){return a.then(function(){return this._migrateEntity(c,b)}.bind(this))}.bind(this),Promise.resolve())}.bind(this)).then(function(){return d.reduce(function(a,c){return a.then(function(){return this._migrateAssociation(c,b)}.bind(this))}.bind(this),Promise.resolve())}.bind(this))};
wrm.data.DataMigrator.prototype._migrateEntity=function(a,b){var c=this._log,d=b.getMetadata(),e=b.getQueryFactory(),f=d.getEntity(a.getId()),g=f.getKeyAttribute(),h=0,k=a.getReplacedAttributesIdPairs().map(function(a){return{older:d.getAttribute(a.older),newer:d.getAttribute(a.newer),failedCount:0}}),k=k.filter(function(a){return f.getServerName()&&a.newer.getType()===wrm.data.Type.BLOB&&a.newer.isOnFileSystem()?(c.warn("Skipping migration of values in",f,"from",a.older,"to file-stored",a.newer,
"(expecting to synchronize the files later)"),!1):!0});if(0>=k.length)return Promise.resolve();c.isDebugEnabled()&&c.debug("Migrating values in",f,"\n"+k.map(function(a){return" from "+a.older+" to "+a.newer}).join("\n"));var l={};k.map(function(a){l[a.older.getId()]=a.older.getId()});var m=e.prepareSelect(f.getId(),{output:l,outputConfig:{useNames:!0},filter:[{property:f.getKeyAttribute().getId(),valueInput:"_key"}]}),n=e.prepareNewUpdate(f.getId(),{update:function(a){var b={};k.forEach(function(c){var d=
null;try{d=wrm.data.toSingle(c.newer.getType(),a[c.older.getId()])}catch(e){c.failedCount++}b[c.newer.getId()]=d});return b},filter:{property:g.getId(),valueInput:"_key"}});return b.select(f.getId(),{output:g.getId(),outputConfig:{useNames:!0}}).then(function(a){h=a.length;return a.reduce(function(a,c){return a.then(function(){return m.queryOne(b,{_key:c})}).then(function(a){a._key=c;return n.executeGetChanged(b,a)})},Promise.resolve())}).then(function(){k.forEach(function(a){0<a.failedCount&&c.warn("Failed conversion of",
a.failedCount,"value from",a.older,"to",a.newer)});c.debug("Migration of values in",h,"instances done")})};
wrm.data.DataMigrator.prototype._migrateAssociation=function(a,b){var c=this._log,d=b.getMetadata(),e=b.getQueryFactory(),f=d.getAssociation(a.older),g=f.getEntity1().getKeyAttribute(),h=f.getEntity2().getKeyAttribute(),g=f.getRole1().getId()+"."+g.getId(),h=f.getRole2().getId()+"."+h.getId();a=d.getAssociation(a.newer);var k=a.getEntity1().getKeyAttribute(),l=a.getEntity2().getKeyAttribute(),m=a.getRole1().getId()+"."+k.getId(),n=a.getRole2().getId()+"."+l.getId();c.debug("Migrating connections from",
f,"to",a);var p=0,q=0,r=e.prepareNewAssociationInsert(a.getId(),function(a){var b={};try{return b[m]=wrm.data.toSingle(k.getType(),a.key1),b[n]=wrm.data.toSingle(l.getType(),a.key2),b}catch(c){return q++,{}}});return b.selectAssociationNew(f.getId(),{output:{key1:g,key2:h},outputConfig:{useNames:!0}}).then(function(a){p=a.length;return a.reduce(function(a,c){return a.then(function(){return r.execute(b,c)})},Promise.resolve())}).then(function(){0<q&&c.warn("Failed conversion of",q,"connections");c.debug("Migration of",
p,"connections done")})};wrm.data.JQuery=function(a,b){this._metadata=a;this._entity=a.getEntity(b);this._includedRoles={};this._includedRoleRefs=[];this._changeListeners=[];this._changeTracker=null;this._exposedMetaAttributes=[]};exportSymbol("wrm.data.JQuery",wrm.data.JQuery);wrm.data.JQuery.prototype.getEntity=function(){return this._entity};exportProperty(wrm.data.JQuery.prototype,"getEntity",wrm.data.JQuery.prototype.getEntity);
wrm.data.JQuery.prototype.addIncludedRole=function(a){if(DEBUG&&!(a&&a.getProperty()instanceof wrm.data.meta.Role))throw Error("Invalid included role ref");var b=a.getPhysicalRef().getRoles(),b=wrm.data.JDPropertyFiller.getIncludableRoles(b);this._doAddIncludedRole(b.map(function(a){return a.getName()}).join("."))&&this._includedRoleRefs.push(a)};exportProperty(wrm.data.JQuery.prototype,"addIncludedRole",wrm.data.JQuery.prototype.addIncludedRole);
wrm.data.JQuery.prototype._doAddIncludedRole=function(a){var b=!0!==this._includedRoles[a];this._includedRoles[a]=!0;var c=a.lastIndexOf(".");0<=c&&this._doAddIncludedRole(a.substring(0,c));return b};wrm.data.JQuery.prototype.getIncludedRoles=function(){return Object.keys(this._includedRoles)};exportProperty(wrm.data.JQuery.prototype,"getIncludedRoles",wrm.data.JQuery.prototype.getIncludedRoles);wrm.data.JQuery.prototype.getIncludedRoleRefs=function(){return this._includedRoleRefs};
exportProperty(wrm.data.JQuery.prototype,"getIncludedRoleRefs",wrm.data.JQuery.prototype.getIncludedRoleRefs);wrm.data.JQuery.prototype.checkDataContext=function(a){if(a.getMetadata()!==this._metadata)throw Error("The query was created against a different set of metadata");};exportProperty(wrm.data.JQuery.prototype,"checkDataContext",wrm.data.JQuery.prototype.checkDataContext);wrm.data.JQuery.prototype.retrieveEntitySet=function(a,b){return wrm.data.DataContextHelper.retrieveEntitySet(a,b||this._entity)};
wrm.data.JQuery.prototype.createQueryable=function(a,b){var c=this.retrieveEntitySet(a);angular.forEach(this._includedRoles,function(a,b){c=c.include(b)});return c};wrm.data.JQuery.prototype.includeInContext=function(a,b){return wrm.data.DataContextHelper.includeInContext(a,b)};wrm.data.JQuery.prototype.iterateResults=function(a,b,c){return wrm.data.DataContextHelper.iterateResults(a,b,c)};wrm.data.JQuery.prototype.loadResults=function(a,b){return wrm.data.DataContextHelper.loadResults(a,b)};
wrm.data.JQuery.prototype.saveChanges=function(a){return wrm.data.DataContextHelper.saveChanges(a)};wrm.data.JQuery.prototype.addChangeListener=function(a){this._changeListeners.push(a)};exportProperty(wrm.data.JQuery.prototype,"addChangeListener",wrm.data.JQuery.prototype.addChangeListener);wrm.data.JQuery.prototype.removeChangeListener=function(a){for(var b=0;b<this._changeListeners.length;b++)if(this._changeListeners[b]===a){this._changeListeners.splice(b,1);break}};
exportProperty(wrm.data.JQuery.prototype,"removeChangeListener",wrm.data.JQuery.prototype.removeChangeListener);wrm.data.JQuery.prototype.hasChangeListeners=function(){return 0<this._changeListeners.length};exportProperty(wrm.data.JQuery.prototype,"hasChangeListeners",wrm.data.JQuery.prototype.hasChangeListeners);
wrm.data.JQuery.prototype.notifyInstanceInserted=function(a){var b=this._entity;this._changeListeners.forEach(function(c){try{c.instanceInserted(b,a)}catch(d){console.error("Change listener failed",d)}})};exportProperty(wrm.data.JQuery.prototype,"notifyInstanceInserted",wrm.data.JQuery.prototype.notifyInstanceInserted);
wrm.data.JQuery.prototype.notifyInstanceUpdated=function(a,b){var c=this._entity;this._changeListeners.forEach(function(d){try{d.instanceUpdated(c,a,b)}catch(e){console.error("Change listener failed",e)}})};exportProperty(wrm.data.JQuery.prototype,"notifyInstanceUpdated",wrm.data.JQuery.prototype.notifyInstanceUpdated);
wrm.data.JQuery.prototype.notifyInstanceDeleted=function(a){var b=this._entity;this._changeListeners.forEach(function(c){try{c.instanceDeleted(b,a)}catch(d){console.error("Change listener failed",d)}})};exportProperty(wrm.data.JQuery.prototype,"notifyInstanceDeleted",wrm.data.JQuery.prototype.notifyInstanceDeleted);wrm.data.JQuery.prototype.setChangeTracker=function(a){this._changeTracker=a};wrm.data.JQuery.prototype.getChangeTracker=function(){return this._changeTracker};
wrm.data.JQuery.prototype.enlistForInsert=function(a){return this._changeTracker?this._changeTracker.enlistForInsert(a):Promise.resolve(a)};wrm.data.JQuery.prototype.enlistForUpdate=function(a){return this._changeTracker?this._changeTracker.enlistForUpdate(a):Promise.resolve(a)};wrm.data.JQuery.prototype.enlistForDelete=function(a){return this._changeTracker?this._changeTracker.enlistForDelete(a):Promise.resolve(a)};
wrm.data.JQuery.prototype.setExposedMetaAttributes=function(a){var b=this,c=[];Array.prototype.forEach.call(arguments,function(a){b._entity.getAttributes().forEach(function(b){b instanceof wrm.data.meta.RegularAttribute&&(b=b.getMetaAttribute(a))&&c.push(b)})});this._exposedMetaAttributes=c};exportProperty(wrm.data.JQuery.prototype,"setExposedMetaAttributes",wrm.data.JQuery.prototype.setExposedMetaAttributes);wrm.data.JQuery.prototype.getExposedMetaAttributes=function(){return this._exposedMetaAttributes};
exportProperty(wrm.data.JQuery.prototype,"getExposedMetaAttributes",wrm.data.JQuery.prototype.getExposedMetaAttributes);wrm.util.ObjectMapper=function(a){this._object=a||{};this._flattenArrays=!1};exportSymbol("wrm.util.ObjectMapper",wrm.util.ObjectMapper);wrm.util.ObjectMapper.prototype.getObject=function(){return this._object};exportProperty(wrm.util.ObjectMapper.prototype,"getObject",wrm.util.ObjectMapper.prototype.getObject);wrm.util.ObjectMapper.prototype.setFlattenArrays=function(a){this._flattenArrays=a};exportProperty(wrm.util.ObjectMapper.prototype,"setFlattenArrays",wrm.util.ObjectMapper.prototype.setFlattenArrays);
wrm.util.ObjectMapper.prototype.getValue=function(a){var b=void 0;this._walkValues(this._object,this._parseSteps(a),!1,!1,function(a){b=a});return b};exportProperty(wrm.util.ObjectMapper.prototype,"getValue",wrm.util.ObjectMapper.prototype.getValue);wrm.util.ObjectMapper.prototype.getValues=function(a){var b=this._flattenArrays,c=[];this._walkValues(this._object,this._parseSteps(a),!1,!0,function(a){b&&angular.isArray(a)?Array.prototype.push.apply(c,a):c.push(a)});return c};
exportProperty(wrm.util.ObjectMapper.prototype,"getValues",wrm.util.ObjectMapper.prototype.getValues);wrm.util.ObjectMapper.prototype.setValue=function(a,b){var c=void 0;this._walkValues(this._object,this._parseSteps(a),!0,!1,function(a,e,f){f[e]=b;c=a});return c};exportProperty(wrm.util.ObjectMapper.prototype,"setValue",wrm.util.ObjectMapper.prototype.setValue);
wrm.util.ObjectMapper.prototype._parseSteps=function(a){if(!a||0>=a.length)throw Error("Path is empty");return angular.isArray(a)?a:"string"!==typeof a?[String(a)]:a.split(".")};
wrm.util.ObjectMapper.prototype._walkValues=function(a,b,c,d,e){if("object"!==typeof a)throw Error("Cannot access a single value across primitives");if(angular.isArray(a)){if(!d)throw Error("Cannot access a single value across arrays");for(var f=0;f<a.length;f++)this._walkValues(a[f],b,c,d,e)}else if(f=b[0],1<b.length){var g=a[f];c&&!g&&(a[f]=g={});g&&this._walkValues(g,b.slice(1),c,d,e)}else b=a[f],(c||void 0!==b)&&e(b,f,a)};wrm.data.LateFilteredQueryable=function(a,b,c,d){this._queryable=a;this._entity=b;this._includedRoleRefs=c;this._dataContext=d;this._takeAmount=this._skipAmount=this._mapFunction=this._includedRolesTree=this._mapperFunction=this._filterFunction=null};wrm.data.LateFilteredQueryable.prototype.initFilterFunction=function(a){if(this._filterFunction)throw Error("Filter function already initialized");this._filterFunction=a};
wrm.data.LateFilteredQueryable.prototype.initMapperFunction=function(a){if(this._mapperFunction)throw Error("Includer function already initialized");this._mapperFunction=a};wrm.data.LateFilteredQueryable.prototype.filter=function(a,b){throw Error("Further filtering not possible");};wrm.data.LateFilteredQueryable.prototype.removeAll=function(a,b){throw Error("RemoveAll not supported");};wrm.data.LateFilteredQueryable.prototype.include=function(a){return this._wrap(this._queryable.include(a))};
wrm.data.LateFilteredQueryable.prototype.orderBy=function(a,b){return this._wrap(this._queryable.orderBy(a,b))};wrm.data.LateFilteredQueryable.prototype.orderByDescending=function(a,b){return this._wrap(this._queryable.orderByDescending(a,b))};wrm.data.LateFilteredQueryable.prototype.map=function(a,b){if(this._mapFunction)throw Error("Already called 'map' on this queryable");a=this._normalizeLambdaFunction(!0,a);b=b?a.bind(b):a;return this._wrap(this._queryable,{mapFunction:b})};
wrm.data.LateFilteredQueryable.prototype.skip=function(a){if(null!==this._skipAmount)throw Error("Already called 'skip' on this queryable");return this._wrap(this._queryable,{skipAmount:a})};wrm.data.LateFilteredQueryable.prototype.take=function(a){if(null!==this._takeAmount)throw Error("Already called 'take' on this queryable");return this._wrap(this._queryable,{takeAmount:a})};
wrm.data.LateFilteredQueryable.prototype.first=function(a,b,c){var d=this._normalizeLambdaFunction(!this._mapFunction,a);return this._runQueryOperation(function(a){for(var b=0;b<a.length;b++){var c=a[b];if(d(c))return c}throw Error("Found no element");},b,c)};
wrm.data.LateFilteredQueryable.prototype.single=function(a,b,c){var d=this._normalizeLambdaFunction(!this._mapFunction,a);return this._runQueryOperation(function(a){for(var b=void 0,c=0;c<a.length;c++){var h=a[c];if(d(h))if(void 0===b)b=h;else throw Error("Found more than one element");}if(void 0===b)throw Error("Found no element");return b},b,c)};
wrm.data.LateFilteredQueryable.prototype.some=function(a,b,c){var d=this._normalizeLambdaFunction(!this._mapFunction,a);return this._runQueryOperation(function(a){return a.some(d)},b,c)};wrm.data.LateFilteredQueryable.prototype.every=function(a,b,c){var d=this._normalizeLambdaFunction(!this._mapFunction,a);return this._runQueryOperation(function(a){return a.every(d)},b,c)};wrm.data.LateFilteredQueryable.prototype.length=function(a,b){return this._runQueryOperation(function(a){return a.length},a,b)};
wrm.data.LateFilteredQueryable.prototype.forEach=function(a,b){return this._runQueryOperation(function(b){b.forEach(a);return b},void 0,b)};wrm.data.LateFilteredQueryable.prototype._runQueryOperation=function(a,b,c){var d=this,e=Promise.resolve().then(function(){return d.toArray(void 0,c)}).then(function(b){return a(b)});if(b){var f;"function"===typeof b?(f=b,b=void 0):(f=b.success||void 0,b=b.error||void 0);e=e.then(f,b)}return e};
wrm.data.LateFilteredQueryable.prototype.toArray=function(a,b){var c=this._dataContext,d=this._filterFunction,e=this._mapperFunction,f=this._mapFunction||angular.identity,g=this._skipAmount||0,h=null!==this._takeAmount?this._takeAmount:-1,k=[];return this._queryable.toArray(a,b).then(function(a){return a.reduce(function(a,b){return a.then(function(){return d?d(b,c):!0}).then(function(a){if(a)if(0<g)g--;else if(0!==h){0<h&&h--;var d=f(b);if(e)return e(d,b,c).then(function(){k.push(d)});k.push(d)}})},
Promise.resolve())}).then(function(){return k})};wrm.data.LateFilteredQueryable.wrap=function(a,b,c,d){if(a instanceof wrm.data.LateFilteredQueryable){if(DEBUG&&(a._entity!==b||a._dataContext!==d))throw Error("The late-filtered queryable being wrapped has a different configuration");return a}return new wrm.data.LateFilteredQueryable(a,b,c,d)};
wrm.data.LateFilteredQueryable.prototype._wrap=function(a,b){if(DEBUG&&a instanceof wrm.data.LateFilteredQueryable)throw Error("Must wrap a real queryable");a=new wrm.data.LateFilteredQueryable(a,this._entity,this._includedRoleRefs,this._dataContext);a._mapperFunction=this._mapperFunction;a._filterFunction=this._filterFunction;a._mapFunction=b&&void 0!==b.mapFunction?b.mapFunction:this._mapFunction;a._skipAmount=b&&void 0!==b.skipAmount?b.skipAmount:this._skipAmount;a._takeAmount=b&&void 0!==b.takeAmount?
b.takeAmount:this._takeAmount;return a};wrm.data.LateFilteredQueryable.prototype._normalizeLambdaFunction=function(a,b){if("undefined"===typeof b)return function(a){return!0};b="function"===typeof b?b:this._createCoreLambdaFunction(String(b));a&&(b=this._createSafeLambdaFunction(b));return b};
wrm.data.LateFilteredQueryable.prototype._createSafeLambdaFunction=function(a){var b=this._createSafeInstanceObject.bind(this),c=this._isNullLikeValue.bind(this);return function(d){var e=a(b(d));if(c(e))return null;"object"===typeof e&&Object.keys(e).forEach(function(a){c(e[a])&&(e[a]=null)});return e}};wrm.data.LateFilteredQueryable.prototype._createCoreLambdaFunction=function(a){return new Function(["it"],"return "+a)};
wrm.data.LateFilteredQueryable.prototype._createSafeInstanceObject=function(a){function b(a,c){for(var f in c)if(c.hasOwnProperty(f)){var g=a[f];if(null===g||void 0===g)g={},Object.defineProperty(g,"_wr_null",{value:!0}),a[f]=g;b(g,c[f])}}var c={};this._entity.getProperties().forEach(function(b){b=b.getName();c[b]=a[b]});b(c,this._getIncludedRolesTree());return c};wrm.data.LateFilteredQueryable.prototype._isNullLikeValue=function(a){return!!a&&!0===a._wr_null};
wrm.data.LateFilteredQueryable.prototype._getIncludedRolesTree=function(){if(this._includedRolesTree)return this._includedRolesTree;var a=new wrm.util.ObjectMapper;this._includedRoleRefs.forEach(function(b){a.setValue(b,{})});return this._includedRolesTree=a.getObject()};wrm.data.KeyOnlyQueryable=function(a,b,c){this._queryable=a;this._entity=b;this._keyValues=c};wrm.data.KeyOnlyQueryable.prototype.filter=function(a,b){throw Error("Further filtering not possible");};wrm.data.KeyOnlyQueryable.prototype.removeAll=function(a,b){throw Error("RemoveAll not supported");};wrm.data.KeyOnlyQueryable.prototype.include=function(a){throw Error("Further include not possible");};
wrm.data.KeyOnlyQueryable.prototype.orderBy=function(a,b){throw Error("Further order not possible");};wrm.data.KeyOnlyQueryable.prototype.orderByDescending=function(a,b){throw Error("Further order not possible");};wrm.data.KeyOnlyQueryable.prototype.map=function(a,b){throw Error("Further map not possible");};wrm.data.KeyOnlyQueryable.prototype.skip=function(a){throw Error("Further skip not possible");};wrm.data.KeyOnlyQueryable.prototype.take=function(a){throw Error("Further take not possible");};
wrm.data.KeyOnlyQueryable.prototype.first=function(a,b,c){throw Error("First method not supported");};wrm.data.KeyOnlyQueryable.prototype.single=function(a,b,c){throw Error("Single method not supported");};wrm.data.KeyOnlyQueryable.prototype.some=function(a,b,c){throw Error("Some method not supported");};wrm.data.KeyOnlyQueryable.prototype.every=function(a,b,c){throw Error("Every method not supported");};
wrm.data.KeyOnlyQueryable.prototype.length=function(a,b){throw Error("Length method not supported");};wrm.data.KeyOnlyQueryable.prototype.forEach=function(a,b){return this._runQueryOperation(function(b){b.forEach(a);return b},b)};wrm.data.KeyOnlyQueryable.prototype._runQueryOperation=function(a,b){var c=this;return Promise.resolve().then(function(){return c.toArray(void 0,b)}).then(function(b){return a(b)})};
wrm.data.KeyOnlyQueryable.prototype.toArray=function(a,b){var c=[],d=this._entity,e=d.getKeyAttribute().getName(),f=function(){return d.getName()};this._keyValues.forEach(function(a){var b={};b[e]=a;b.getType=f;c.push(b)});return Promise.resolve(c)};
wrm.data.KeyOnlyQueryable.wrap=function(a,b,c){if(a instanceof wrm.data.KeyOnlyQueryable)return a;if(DEBUG&&!(a instanceof $data.EntitySet))throw Error("Must receive an EntitySet");"number"===typeof c&&(c=[c]);return new wrm.data.KeyOnlyQueryable(a,b,c)};wrm.data.FilteredQuery=function(a,b,c,d){wrm.data.JQuery.call(this,a,b);this._processExplicitIncludes(c);this._condition=this._createCondition(a,b,d);this._fastQuerySupport=!1};extendConstructor(wrm.data.FilteredQuery,wrm.data.JQuery);exportSymbol("wrm.data.FilteredQuery",wrm.data.FilteredQuery);
wrm.data.FilteredQuery.prototype._processExplicitIncludes=function(a){a&&(angular.isArray(a)||(a=[a]),angular.forEach(a,function(a){var c=wrm.data.PropertyRef.of(this.getEntity(),a);if(!(c.getProperty()instanceof wrm.data.meta.Role))throw Error("Cannot include non-role '"+a+"'");this.addIncludedRole(c)},this))};
wrm.data.FilteredQuery.prototype._createCondition=function(a,b,c){if(!c)return null;a=c instanceof wrm.data.Condition?c:new wrm.data.Condition(a,b,c);angular.forEach(a.getIncludedRoleRefs(),function(a){this.addIncludedRole(a)},this);return a};wrm.data.FilteredQuery.prototype.getCondition=function(){return this._condition};
wrm.data.FilteredQuery.prototype.createQueryable=function(a,b){var c=wrm.data.FilteredQuery._super.createQueryable.call(this,a,b);if(!c)return null;if(this._condition){var d=this._condition.getOnlyKeyConditionInputName();if(this._fastQuerySupport&&d)return c=wrm.data.KeyOnlyQueryable.wrap(c,this.getEntity(),b[d]);b=this._condition.createFilter(a,b);if(b.notApplicable)return null;b.predicate&&(c=c.filter(b.predicate,b.inputs));b.evaluator&&(c=wrm.data.LateFilteredQueryable.wrap(c,this.getEntity(),
this.getIncludedRoles(),a),c.initFilterFunction(b.evaluator))}return c};wrm.data.FilteredQuery.prototype.setFastQuery=function(a){this._fastQuerySupported=a};exportProperty(wrm.data.FilteredQuery.prototype,"setFastQuery",wrm.data.FilteredQuery.prototype.setFastQuery);wrm.data.JDeleteQuery=function(a,b,c){wrm.data.FilteredQuery.call(this,a,b,c&&c.include,c&&c.filter);this._cascadeDeleteFunction=this._createCascadeDeleteFunction()};extendConstructor(wrm.data.JDeleteQuery,wrm.data.FilteredQuery);exportSymbol("wrm.data.JDeleteQuery",wrm.data.JDeleteQuery);
wrm.data.JDeleteQuery.prototype._createCascadeDeleteFunction=function(){var a=[],b={};this.getEntity().getRoles().forEach(function(c){var d=c.getAssociation().getId();!0!==b[d]&&(b[d]=!0,c=wrm.data.RoleAccessor.get(c),c.isCascadeDeleteRequired()&&a.push(c.cascadeDelete.bind(c)))});return 0<a.length?function(b,d){return a.reduce(function(a,f){return a.then(function(){return f(b,d)})},Promise.resolve())}:null};
wrm.data.JDeleteQuery.prototype.execute=function(a,b){var c=this;this.checkDataContext(a);var d=this.retrieveEntitySet(a),e=this.createQueryable(a,b||{});if(!e)return Promise.resolve(0);var f=[];b=Promise.resolve().then(function(b){var h=Promise.resolve();return c.iterateResults(a,e,function(a){h=h.then(function(){return c.enlistForDelete(a)}).then(function(a){d.remove(a);f.push(a)})}).then(function(){return h})});b=b.then(function(){return c.saveChanges(a)});b=b.then(function(){var b=c.getEntity().getKeyAttribute().getName(),
d=f.map(function(a){return a[b]}),d=[c._disconnectDeletedObjects(d,a)].concat(c._postDeleteBlobs(d));return Promise.all(d)});return b.then(function(){c.hasChangeListeners()&&f.forEach(c.notifyInstanceDeleted.bind(c));return f.length})};exportProperty(wrm.data.JDeleteQuery.prototype,"execute",wrm.data.JDeleteQuery.prototype.execute);wrm.data.JDeleteQuery.prototype._disconnectDeletedObjects=function(a,b){return this._cascadeDeleteFunction?this._cascadeDeleteFunction(a,b):Promise.resolve()};
wrm.data.JDeleteQuery.prototype._postDeleteBlobs=function(a){var b=[];b.push(Promise.resolve());var c=this.getEntity().getAttributes();a.forEach(function(a){var e=!1;c.forEach(function(c){!e&&wrm.data.JDDataMover.isPostOperationRequired(c)&&(e=!0,b.push(wrm.data.JDDataMover.postDelete(c,a)))})});return b};wrm.data.JDDataMover={};wrm.data.JDDataMover.load=function(a,b,c){return angular.isArray(c)?c.reduce(function(c,e,f){return c.then(function(){return wrm.data.JDDataMover._doLoad(a,b,f,e)})},Promise.resolve()):wrm.data.JDDataMover._doLoad(a,b,null,c)};wrm.data.JDDataMover._doLoad=function(a,b,c,d){if(b instanceof wrm.data.meta.Attribute&&d instanceof wrm.data.Blob)return wrm.data.JDDataMover._loadBlob(a,b,c,d);wrm.data.JDDataMover._set(a,b.getName(),c,d)};
wrm.data.JDDataMover.computeAdditionalUnloadProperties=function(a){var b=[];a.forEach(function(a){a instanceof wrm.data.meta.Attribute&&a.getType()===wrm.data.Type.BLOB&&wrm.data.JDDataMover._addBlobUnloadProperties(b,a)});return b};wrm.data.JDDataMover.unload=function(a,b,c,d){var e=a[c];return angular.isArray(e)?Promise.all(e.map(function(e,g){return wrm.data.JDDataMover._doUnload(a,b,c,g,d)})):wrm.data.JDDataMover._doUnload(a,b,c,null,d)};
wrm.data.JDDataMover._doUnload=function(a,b,c,d,e){c=wrm.data.JDDataMover._get(a,c,d);return void 0===c?void 0:b instanceof wrm.data.meta.Attribute&&b.getType()===wrm.data.Type.BLOB?wrm.data.JDDataMover._unloadBlob(a,b,d,c):b instanceof wrm.data.meta.Role?c:e.castToSingleValue(b,c)};
wrm.data.JDDataMover._loadBlob=function(a,b,c,d){var e=b.getName(),f=b.getMetaAttribute("contentType");f&&wrm.data.JDDataMover._set(a,f.getName(),c,d.getContentType());(f=b.getMetaAttribute("fileName"))&&wrm.data.JDDataMover._set(a,f.getName(),c,d.getMetadata().fileName);(f=b.getMetaAttribute("status"))&&wrm.data.JDDataMover._set(a,f.getName(),c,d.getMetadata().availabilityStatus);return wrm.data.JDDataMover.isPostOperationRequired(b)?Promise.resolve():d.read().then(function(b){wrm.data.JDDataMover._set(a,
e,c,b)})};wrm.data.JDDataMover._addBlobUnloadProperties=function(a,b){var c=b.getMetaAttribute("contentType");c&&a.push(c);(c=b.getMetaAttribute("fileName"))&&a.push(c);(c=b.getMetaAttribute("serverFileId"))&&a.push(c);(b=b.getMetaAttribute("status"))&&a.push(b)};
wrm.data.JDDataMover._unloadBlob=function(a,b,c,d){if(null===d)return(c=b.getMetaAttribute("status"))&&a[c.getId()]!==wrm.data.AvailabilityStatus.AVAILABLE?Promise.resolve(new wrm.data.Blob(new Uint8Array([]),void 0,{availabilityStatus:a[b.getMetaAttribute("status").getId()]})):Promise.resolve(null);var e=void 0,f=b.getMetaAttribute("contentType");f&&(e=wrm.data.JDDataMover._get(a,f.getId(),c)||void 0);var f=null,g=b.getMetaAttribute("fileName");g&&(f=wrm.data.JDDataMover._get(a,g.getId(),c)||null);
var g=null,h=b.getMetaAttribute("serverFileId");h&&(g=wrm.data.JDDataMover._get(a,h.getId(),c)||null);var h=null,k=b.getMetaAttribute("status");k&&(h=wrm.data.JDDataMover._get(a,k.getId(),c)||null);return wrm.data.JDDataMover.isPostOperationRequired(b)?wrm.data.JDDataMover._postRetrieveBlob(d,e,f,g,h):Promise.resolve(wrm.data.Converters.BLOB_CONVERTER(d,e,{fileName:f,contentSignature:g,availabilityStatus:h}))};wrm.data.JDDataMover._get=function(a,b,c){return null!==c?(a=a[b])&&a[c]:a[b]};
wrm.data.JDDataMover._set=function(a,b,c,d){null!==c?a[b][c]=d:a[b]=d};wrm.data.JDDataMover.isPostOperationRequired=function(a){return a.isOnFileSystem()};wrm.data.JDDataMover.postCreate=function(a,b,c,d){var e=wrm.data.JDDataMover._computePath(a,b),f=a.getId();return wrm.data.JDDataMover._retrieveFileEntry(e,f).then(function(g){return wrm.data.JDDataMover._computeInsert(g,a,c,b,e,f,d)})};
wrm.data.JDDataMover._postRetrieveBlob=function(a,b,c,d,e){a=/(^.+)[/]([^/]+)$/.exec(a);return wrm.data.JDDataMover._retrieveFileEntry(a[1],a[2]).then(function(a){return new Promise(function(d,e){a.file(function(a){d(wrm.data.Blob.fromFile(a,b,{fileName:c}))},wrm.util.toErrorReject(e))})})};wrm.data.JDDataMover.postUpdate=function(a,b,c,d){if(c)return wrm.data.JDDataMover.postCreate(a,b,c,d);b=wrm.data.JDDataMover._computePath(a,b);a=a.getId();return wrm.data.JDDataMover._retrieveFileEntry(b,a).then(function(a){return wrm.data.JDDataMover._doDeleteEntry(a)})};
wrm.data.JDDataMover.postDelete=function(a,b){a=wrm.data.JDDataMover._computePath(a,b);return wrm.data.JDDataMover._retrieveDirectoryEntry(a).then(function(a){return wrm.data.JDDataMover._doDeleteEntry(a)})};wrm.data.JDDataMover._computePath=function(a,b){return wrm.blobDirectoryName+"/"+a.getEntity().getId()+"/"+b+"/"};wrm.data.JDDataMover._retrieveDirectoryEntry=function(a){return wrm.util.fs.retrievePersistentDirectory().then(function(b){return wrm.util.fs.retrieveDirectory(b,a)})};
wrm.data.JDDataMover._retrieveFileEntry=function(a,b){return wrm.data.JDDataMover._retrieveDirectoryEntry(a).then(function(a){return wrm.util.fs.createNamedFile(a,b)})};wrm.data.JDDataMover._doDeleteEntry=function(a){return wrm.util.fs.deleteEntry(a)};
wrm.data.JDDataMover._computeInsert=function(a,b,c,d,e,f,g){var h=wrm.data.DataContextHelper.retrieveEntitySet(g,b.getEntity());return c.writeIntoFileEntry(a).then(function(){return h.filter("it."+b.getEntity().getKeyAttribute().getName()+" \x3d\x3d\x3d this.key",{key:d}).first()}).then(function(a){a=h.attachOrGet(a);a[b.getName()]=e+f})};wrm.data.DataContextHelper={};wrm.data.DataContextHelper.retrieveEntitySet=function(a,b){b=b.getSetName();a=wrm.data.DataContextHelper._getEntityContext(a)[b];if(!a)throw Error("Invalid entity set '"+b+"'");return a};wrm.data.DataContextHelper.includeInContext=function(a,b){return wrm.data.DataContextHelper._getEntityContext(a).attachOrGet(b)};wrm.data.DataContextHelper._getEntityContext=function(a){return wrm.data.DataContextHelper._callDataContextMethod(a,"getEntityContext")};
wrm.data.DataContextHelper.getTransaction=function(a){return wrm.data.DataContextHelper._callDataContextMethod(a,"getTransaction")};wrm.data.DataContextHelper.iterateResults=function(a,b,c){return wrm.data.DataContextHelper._callDataContextMethod(a,"iterateResults",[b,c])};wrm.data.DataContextHelper.loadResults=function(a,b){return wrm.data.DataContextHelper._callDataContextMethod(a,"loadResults",[b])};
wrm.data.DataContextHelper.saveChanges=function(a){return wrm.data.DataContextHelper._callDataContextMethod(a,"saveChanges")};wrm.data.DataContextHelper.getXDataDatabase=function(a){return wrm.data.DataContextHelper._callDataContextMethod(a,"getXDataDatabase")};wrm.data.DataContextHelper.getXDataTransaction=function(a,b){return wrm.data.DataContextHelper._callDataContextMethod(a,"getXDataTransaction",[!1,b])};
wrm.data.DataContextHelper.getXDataTransactionNew=function(a,b){return wrm.data.DataContextHelper._callDataContextMethod(a,"getXDataTransaction",[!0,b])};wrm.data.DataContextHelper.openXDataSession=function(a){return wrm.data.DataContextHelper._callDataContextMethod(a,"openXDataSession")};wrm.data.DataContextHelper._callDataContextMethod=function(a,b,c){if(DEBUG&&!(b in a))throw Error("Unsupported data context");return a[b].apply(a,c||[])};wrm.data.NewQueries={};
wrm.data.NewQueries.insert=function(a,b,c,d){var e=a.getEntity(),f=e.getKeyAttribute().getName(),g=wrm.data.DataContextHelper.getXDataTransaction(c,!0);b=b.map(function(a){a="function"===typeof a?a(d):a;return wrm.data.NewQueries._convertAttributeKeys(e,a)});var h=Object.keys(b[0]),k=wrm.data.NewQueries._getXDataInsertQuery(e,h,c);return Promise.all(b.map(function(b){return k.executeGetKey(g,b).then(function(c){a.hasChangeListeners()&&(angular.extend({},b),b[f]=c,a.notifyInstanceInserted(b));return c})}))};
wrm.data.NewQueries._INSERT_QUERY_CACHE={};wrm.data.NewQueries._getXDataInsertQuery=function(a,b,c){var d=String(a.getMetadata().getVersion())+"_"+a.getId()+"_"+b.join(","),e=wrm.data.NewQueries._INSERT_QUERY_CACHE[d];e||(e=wrm.data.DataContextHelper.getXDataDatabase(c).prepareInsert(a.getSetName(),{inserts:b.map(function(a){return{property:a,valueInput:a}})}),wrm.data.NewQueries._INSERT_QUERY_CACHE[d]=e);return e};
wrm.data.NewQueries.update=function(a,b,c,d){return wrm.data.NewQueries._update(a,b,!0,c,d)};wrm.data.NewQueries.updateNoResult=function(a,b,c,d){return wrm.data.NewQueries._update(a,b,!1,c,d)};
wrm.data.NewQueries._update=function(a,b,c,d,e){var f=a.getEntity(),g=f.getKeyAttribute().getName(),h=a.getCondition(),k=wrm.data.DataContextHelper.getXDataTransaction(d,!0),l=function(){var a;a="function"===typeof b?b(e):b;return wrm.data.NewQueries._convertAttributeKeys(f,a)}(),m=Object.keys(l);if(h){h=h.getOnlyKeyConditionInputName();if(null!==h)l._keyFilter=e[h];else throw Error("New queries support only conditions on the key attribute");h=!0}else h=!1;return wrm.data.NewQueries._getXDataUpdateQuery(f,
m,h,d).execute(k,l).then(function(){if(a.hasChangeListeners()){var b=l._keyFilter;Array.isArray(b)||(b=[b]);b.forEach(function(b){var c=angular.extend({},l);l[g]=b;delete l._keyFilter;a.notifyInstanceUpdated({},c)})}if(c)return b})};wrm.data.NewQueries._UPDATE_QUERY_CACHE={};
wrm.data.NewQueries._getXDataUpdateQuery=function(a,b,c,d){var e=String(a.getMetadata().getVersion())+"_"+a.getId()+"_"+b.join(",")+(c?"":"_nofilter"),f=wrm.data.NewQueries._UPDATE_QUERY_CACHE[e];f||(f=wrm.data.DataContextHelper.getXDataDatabase(d).prepareUpdate(a.getSetName(),{updates:b.map(function(a){return{property:a,valueInput:a}}),filter:c?{property:a.getKeyAttribute().getName(),valueInput:"_keyFilter"}:void 0}),wrm.data.NewQueries._UPDATE_QUERY_CACHE[e]=f);return f};
wrm.data.NewQueries._convertAttributeKeys=function(a,b){for(var c={},d=a.getAttributes(),e=0,f=d.length;e<f;e++){var g=b[d[e].getId()];void 0!==g&&(c[d[e].getName()]=g)}a=a.getRoles();e=0;for(f=a.length;e<f;e++)if(d=a[e],d.isForeignKey()){var h=d.getInverseEntity().getKeyAttribute(),g=b[d.getId()];void 0!==g&&(c[d.getName()+"."+h.getName()]=g)}return c};wrm.data.RoleAccessor=function(){};wrm.data.RoleAccessor.prototype.set=ABSTRACT_METHOD;wrm.data.RoleAccessor.prototype.postSet=ABSTRACT_METHOD;wrm.data.RoleAccessor.prototype.isCascadeDeleteRequired=ABSTRACT_METHOD;wrm.data.RoleAccessor.prototype.cascadeDelete=ABSTRACT_METHOD;wrm.data.RoleAccessor._CACHE={};
wrm.data.RoleAccessor.get=function(a){var b=wrm.data.RoleAccessor,c=String(a.getMetadata().getVersion())+","+a.getId(),d=b._CACHE[c];d||(d=a.isForeignKey()?new b._CollapsedFK(a):a.getInverseRole().isForeignKey()?new b._CollapsedPK(a):new b._Bridged(a),b._CACHE[c]=d);return d};wrm.data.RoleAccessor._Base=function(a){this._role=a};wrm.data.RoleAccessor._Base.prototype._convertToSingleValue=function(a,b){return b.castToSingleValue(this._role,a)};
wrm.data.RoleAccessor._Base.prototype._convertToArrayValue=function(a,b){return b.castToArrayValue(this._role,a)};wrm.data.RoleAccessor._CollapsedFK=function(a){wrm.data.RoleAccessor._Base.call(this,a);this._roleName=a.getName()};extendConstructor(wrm.data.RoleAccessor._CollapsedFK,wrm.data.RoleAccessor._Base);wrm.data.RoleAccessor._CollapsedFK.prototype.set=function(a,b,c){var d=this._roleName;b=this._convertToSingleValue(b,c);a[d]=b;return!1};
wrm.data.RoleAccessor._CollapsedFK.prototype.postSet=function(a,b,c,d){return Promise.resolve()};wrm.data.RoleAccessor._CollapsedFK.prototype.isCascadeDeleteRequired=function(){return!1};wrm.data.RoleAccessor._CollapsedFK.prototype.cascadeDelete=function(a,b){return Promise.resolve()};
wrm.data.RoleAccessor._CollapsedPK=function(a){wrm.data.RoleAccessor._Base.call(this,a);this._keyName=a.getEntity().getKeyAttribute().getName();this._farEntity=a.getInverseEntity();this._farKeyName=this._farEntity.getKeyAttribute().getName();this._farForeignKeyName=this._role.getInverseRole().getForeignKeyName()};extendConstructor(wrm.data.RoleAccessor._CollapsedPK,wrm.data.RoleAccessor._Base);wrm.data.RoleAccessor._CollapsedPK.prototype.set=function(a,b,c){return!0};
wrm.data.RoleAccessor._CollapsedPK.prototype.postSet=function(a,b,c,d){var e=wrm.data.DataContextHelper,f=this._role,g=this._keyName,h=this._farKeyName,k=this._farForeignKeyName,l=e.getTransaction(d),m=e.retrieveEntitySet(d,this._farEntity),n=this._convertToArrayValue(b,d),p=a[g],q={};n.forEach(function(a){a=a[h];if(void 0===a||null===a)throw Error("One of the objects being connected has no key");q[a]=!0});a=m.filter("it."+k+" \x3d\x3d\x3d this.nearKey",{nearKey:p}).forEach(function(a){var b=a[h];
!0===q[b]?delete q[b]:(e.includeInContext(d,a),a[k]=null,c&&c.trackRemovedRoleValue(f,p,b))},l);a=a.then(function(){n.forEach(function(a){var b=a[h];!0===q[b]&&(a=m.attachOrGet(a),a[k]=p,c&&c.trackAddedRoleValue(f,p,b))})});return a.then(function(){return e.saveChanges(d)})};wrm.data.RoleAccessor._CollapsedPK.prototype.isCascadeDeleteRequired=function(){return!0};
wrm.data.RoleAccessor._CollapsedPK.prototype.cascadeDelete=function(a,b){var c=wrm.data.DataContextHelper,d=this._farForeignKeyName,e=c.getTransaction(b);return c.retrieveEntitySet(b,this._farEntity).filter("it."+d+" in this.nearKeys",{nearKeys:a}).forEach(function(a){c.includeInContext(b,a);a[d]=null},e).then(function(){return c.saveChanges(b)})};
wrm.data.RoleAccessor._Bridged=function(a){wrm.data.RoleAccessor._Base.call(this,a);this._keyName=a.getEntity().getKeyAttribute().getName();this._farKeyName=a.getInverseEntity().getKeyAttribute().getName();var b=a.getAssociation(),c=b.getBridgeEntity(),d=a===b.getRole1()?c.getRole1():c.getRole2();a=a===b.getRole1()?c.getRole2():c.getRole1();this._bridgeEntity=c;this._nearBridgeRoleName=d.getName();this._farBridgeRoleName=a.getName();this._nearBridgeForeignKeyName=d.getForeignKeyName();this._farBridgeForeignKeyName=
a.getForeignKeyName()};extendConstructor(wrm.data.RoleAccessor._Bridged,wrm.data.RoleAccessor._Base);wrm.data.RoleAccessor._Bridged.prototype.set=function(a,b,c){return!0};
wrm.data.RoleAccessor._Bridged.prototype.postSet=function(a,b,c,d){var e=wrm.data.DataContextHelper,f=this._role,g=this._keyName,h=this._farKeyName,k=this._nearBridgeRoleName,l=this._farBridgeRoleName,m=this._nearBridgeForeignKeyName,n=this._farBridgeForeignKeyName,p=e.getTransaction(d),q=e.retrieveEntitySet(d,this._bridgeEntity),r=this._convertToArrayValue(b,d),t=a[g],u={};r.forEach(function(a){a=a[h];if(void 0===a||null===a)throw Error("One of the objects being connected has no key");u[a]=!0});
b=this._bridgeEntity.getKeyAttribute().getName();m=q.map("{"+b+":it."+b+", "+n+":it."+n+"}").filter("it."+m+" \x3d\x3d\x3d this.nearKey",{nearKey:t}).forEach(function(a){var b=a[n];!0===u[b]?delete u[b]:(q.remove(a),c&&c.trackRemovedRoleValue(f,t,b))},p);m=m.then(function(){r.forEach(function(b){var d=b[h];if(!0===u[d]){var e={};e[k]=a;e[l]=b;q.add(e);c&&c.trackAddedRoleValue(f,t,d)}})});return m.then(function(){return e.saveChanges(d)})};
wrm.data.RoleAccessor._Bridged.prototype.isCascadeDeleteRequired=function(){return!0};wrm.data.RoleAccessor._Bridged.prototype.cascadeDelete=function(a,b){var c=wrm.data.DataContextHelper,d=this._nearBridgeForeignKeyName,e=c.getTransaction(b),f=c.retrieveEntitySet(b,this._bridgeEntity);return f.filter("it."+d+" in this.nearKeys",{nearKeys:a}).forEach(function(a){f.remove(a)},e).then(function(){return c.saveChanges(b)})};wrm.data.InsertQuery=function(a,b,c){wrm.data.JQuery.call(this,a,b);if(angular.isArray(c))this._inserts=c.slice(0);else if(c)this._inserts=[c];else throw Error("Insert values not specified");};extendConstructor(wrm.data.InsertQuery,wrm.data.JQuery);exportSymbol("wrm.data.InsertQuery",wrm.data.InsertQuery);
wrm.data.InsertQuery.prototype.execute=function(a,b){if(b&&b.useNewishQueries)return wrm.data.NewQueries.insert(this,this._inserts,a,b);var c=this;this.checkDataContext(a);var d=this.getEntity().getKeyAttribute(),e=d&&d.getName(),f=this.retrieveEntitySet(a),g=[],h=[],k=b||{};b=Promise.all(this._inserts.map(function(b){return c._createInsertObjects(a,b,k).then(function(a){var b=f.add(a.propertyInserts);a.postInsertFunction&&g.push(a.postInsertFunction.bind(null,b));return c.enlistForInsert(b)}).then(function(a){h.push(a)})}));
b=b.then(function(){return c.saveChanges(a)});b=b.then(function(){return g.reduce(function(a,b){return a.then(function(){return b()})},Promise.resolve())}).then(function(){if(0<g.length)return c.saveChanges(a)});return b.then(function(){c.hasChangeListeners()&&h.forEach(c.notifyInstanceInserted.bind(c));return h.map(function(a){return e?a[e]:null})})};exportProperty(wrm.data.InsertQuery.prototype,"execute",wrm.data.InsertQuery.prototype.execute);
wrm.data.InsertQuery.prototype._createInsertObjects=function(a,b,c){var d=wrm.data.JDDataMover,e=this.getEntity(),f=this.getChangeTracker();b="function"===typeof b?b(c):b;var g={},h=[],k=[];angular.forEach(b,function(b,c){var l=e.getProperty(c,!0);if(l instanceof wrm.data.meta.Role){var q=wrm.data.RoleAccessor.get(l);(c=q.set(g,b,a))&&h.push(function(c){return q.postSet(c,b,f,a)})}else{c=d.isPostOperationRequired(l);var r=a.castToSingleValue(l,b);k.push(d.load(g,l,r));c&&r&&h.push(function(b){return d.postCreate(l,
b[l.getEntity().getKeyAttribute().getName()],r,a)})}});var l;l=0<h.length?function(a){return h.reduce(function(b,c){return b.then(function(){return c(a)})},Promise.resolve())}:null;return Promise.all(k).then(function(){return{propertyInserts:g,postInsertFunction:l}})};wrm.data.XDConfiguration=function(a){this._changeListeners=a.slice()};wrm.data.XDConfiguration.prototype.configureQuery=function(a,b){a.clearChangeTrackers();this._changeListeners.forEach(function(c){if(b instanceof wrm.data.meta.Entity)c=c.getEntityListener(b);else if(b instanceof wrm.data.meta.Association)c=c.getAssociationListener(b);else throw Error("Unsupported element "+b);null!==c&&a.addChangeTracker(c)})};wrm.data.AbstractDataContext=function(a){this._dataService=a;this._changeListeners=[];this._exposedMetaAttributeFamilies=[];this._xdConfiguration=new wrm.data.XDConfiguration([])};wrm.data.AbstractDataContext.prototype.getMetadata=function(){return this._dataService.getMetadata()};wrm.data.AbstractDataContext.prototype.getDataService=function(){return this._dataService};wrm.data.AbstractDataContext.prototype.getQueryFactory=function(){return this._dataService};
wrm.data.AbstractDataContext.prototype.castToSingleValue=function(a,b){b=wrm.data.toAnySingle(b);void 0!==b&&(b=this.doCastValue(a,b));return b};wrm.data.AbstractDataContext.prototype.castToArrayValue=function(a,b){b=wrm.data.toAnyArray(b);for(var c=0;c<b.length;c++)b[c]=this.doCastValue(a,b[c]);return b};wrm.data.AbstractDataContext.prototype.doCastValue=ABSTRACT_METHOD;wrm.data.AbstractDataContext.prototype.addChangeListener=function(a){this._changeListeners.push(a);this._xdConfiguration=new wrm.data.XDConfiguration(this._changeListeners)};
wrm.data.AbstractDataContext.prototype.removeChangeListener=function(a){for(var b=0;b<this._changeListeners.length;b++)if(this._changeListeners[b]===a){this._changeListeners.splice(b,1);break}};wrm.data.AbstractDataContext.prototype.getQueryConfiguration=function(){return this._xdConfiguration};wrm.data.AbstractDataContext.prototype.disableChangeTracking=function(){};wrm.data.AbstractDataContext.prototype.isChangeTrackingEnabled=function(){return!1};
wrm.data.AbstractDataContext.prototype.setExposedMetaAttributes=function(a){this._exposedMetaAttributeFamilies=Array.prototype.slice.call(arguments)};wrm.data.AbstractDataContext.prototype.configureQuery=function(a){0<this._changeListeners.length&&this._changeListeners.forEach(function(b){b=new wrm.data.ChangeListenerOld(b);a.addChangeListener(b)});0<this._exposedMetaAttributeFamilies.length&&a.setExposedMetaAttributes.apply(a,this._exposedMetaAttributeFamilies)};
wrm.data.AbstractDataContext.prototype.configureQueryNew=function(a){if(0<this._changeListeners.length&&!(a instanceof wrm.data.XSelectQuery||a instanceof wrm.data.XDeleteQuery))throw Error("Change listening not possible with new queries");if(0<this._exposedMetaAttributeFamilies.length&&!(a instanceof wrm.data.XSelectQuery||a instanceof wrm.data.XDeleteQuery))throw Error("Exposing meta-attributes is not supported with new queries");};
wrm.data.AbstractDataContext.prototype.interceptQueryResult=function(a,b){return b};wrm.data.AbstractDataContext.prototype.interceptQueryResultNew=function(a,b){return b};wrm.data.AbstractDataContext.prototype.select=function(a,b,c){a=this._dataService.prepareSelect(a,b);this.configureQueryNew(a);return this.interceptQueryResultNew(a,a.query(this,c))};
wrm.data.AbstractDataContext.prototype.selectOne=function(a,b,c){a=this._dataService.prepareSelect(a,b);this.configureQueryNew(a);return this.interceptQueryResultNew(a,a.queryOne(this,c))};wrm.data.AbstractDataContext.prototype.selectOld=function(a,b,c){a=this._dataService.prepareOldSelect(a,b);this.configureQuery(a);return this.interceptQueryResult(a,a.query(this,c))};
wrm.data.AbstractDataContext.prototype.selectOneOld=function(a,b,c){a=this._dataService.prepareOldSelect(a,b);this.configureQuery(a);return this.interceptQueryResult(a,a.queryOne(this,c))};wrm.data.AbstractDataContext.prototype.insert=function(a,b,c){a=this._dataService.prepareInsert(a,b);this.configureQuery(a);return this.interceptQueryResult(a,a.execute(this,c))};wrm.data.AbstractDataContext.prototype.insertNew=function(a,b,c){return this._dataService.prepareNewInsert(a,b).execute(this,c)};
wrm.data.AbstractDataContext.prototype.insertGetChangedNew=function(a,b,c){return this._dataService.prepareNewInsert(a,b).executeGetChanged(this,c)};wrm.data.AbstractDataContext.prototype.update=function(a,b,c){a=this._dataService.prepareUpdate(a,b);this.configureQuery(a);return this.interceptQueryResult(a,a.execute(this,c))};wrm.data.AbstractDataContext.prototype.updateNoResult=function(a,b,c){a=this._dataService.prepareUpdate(a,b);this.configureQuery(a);return a.executeNoResult(this,c)};
wrm.data.AbstractDataContext.prototype.updateNew=function(a,b,c){return this._dataService.prepareNewUpdate(a,b).execute(this,c)};wrm.data.AbstractDataContext.prototype.updateGetChangedNew=function(a,b,c){return this._dataService.prepareNewUpdate(a,b).executeGetChanged(this,c)};wrm.data.AbstractDataContext.prototype.deleteOld=function(a,b,c){a=this._dataService.prepareOldDelete(a,b);this.configureQuery(a);return this.interceptQueryResult(a,a.execute(this,c))};
wrm.data.AbstractDataContext.prototype["delete"]=function(a,b,c){var d=!1;this._dataService.getMetadata().getEntity(a).getAttributes().forEach(function(a){a.getType()===wrm.data.Type.BLOB&&(d=!0)});if(d)return this.deleteOld(a,b,c);a=this._dataService.prepareDelete(a,b);this.configureQueryNew(a);return this.interceptQueryResultNew(a,a.execute(this,c))};
wrm.data.AbstractDataContext.prototype.deleteGetChanged=function(a,b,c){var d=!1;this._dataService.getMetadata().getEntity(a).getAttributes().forEach(function(a){a.getType()===wrm.data.Type.BLOB&&(d=!0)});if(d)return this.deleteGetChangedOld(a,b,c);a=this._dataService.prepareDelete(a,b);this.configureQueryNew(a);return this.interceptQueryResultNew(a,a.executeGetChanged(this,c))};
wrm.data.AbstractDataContext.prototype.deleteGetChangedOld=function(a,b,c){a=this._dataService.prepareOldDelete(a,b);this.configureQuery(a);return this.interceptQueryResult(a,a.execute(this,c)).then(function(a){return Promise.resolve(0<a)})};
wrm.data.AbstractDataContext.prototype.deleteGetCount=function(a,b,c){var d=!1;this._dataService.getMetadata().getEntity(a).getAttributes().forEach(function(a){a.getType()===wrm.data.Type.BLOB&&(d=!0)});if(d)return this.deleteGetCountOld(a,b,c);a=this._dataService.prepareDelete(a,b);this.configureQueryNew(a);return this.interceptQueryResultNew(a,a.executeGetCount(this,c))};
wrm.data.AbstractDataContext.prototype.deleteGetCountOld=function(a,b,c){a=this._dataService.prepareOldDelete(a,b);this.configureQuery(a);return this.interceptQueryResult(a,a.execute(this,c))};wrm.data.AbstractDataContext.prototype.selectAssociationNew=function(a,b,c){return this._dataService.prepareNewAssociationSelect(a,b).query(this,c)};wrm.data.AbstractDataContext.prototype.selectAssociationOneNew=function(a,b,c){return this._dataService.prepareNewAssociationSelect(a,b).queryOne(this,c)};
wrm.data.AbstractDataContext.prototype.insertAssociationNew=function(a,b,c){return this._dataService.prepareNewAssociationInsert(a,b).execute(this,c)};wrm.data.AbstractDataContext.prototype.updateAssociationNew=function(a,b,c){return this._dataService.prepareNewAssociationUpdate(a,b).execute(this,c)};wrm.data.AbstractDataContext.prototype.deleteAssociationNew=function(a,b,c){return this._dataService.prepareNewAssociationDelete(a,b).executeGetChanged(this,c)};wrm.data.JDChangeTracker=function(a,b,c){this._entity=a;this._dataRunner=b;this._dataTrackerService=c;this._keyAttributeName=a.getKeyAttribute().getName();this._serverKeyAttributeName=a.getServerKeyAttribute()&&a.getServerKeyAttribute().getName();c=this._createUpdateMonitorInfo(a);this._monitoredAttributesByName=c.attributes;this._monitoredRolesByName=c.roles;this._monitoredRolesIds=c.roleIds;this._roleValuesSelectQuery=this._createRoleValuesSelectQuery(a,c.roleIds,b);this._inserts=[];this._updates=
[];this._deletes=[];this._assocAdditions={};this._assocRemovals={};this._serverKeyUpdates={}};wrm.data.JDChangeTracker.prototype._createUpdateMonitorInfo=function(a){var b=a.getServerKeyAttribute(),c={};a.getAttributes().forEach(function(a){a!==b&&(c[a.getName()]=a)});var d={},e=[];a.getRoles().forEach(function(a){a.isForeignKey()&&(d[a.getName()]=a,e.push(a.getId()))});return{attributes:c,roles:d,roleIds:e}};
wrm.data.JDChangeTracker.prototype._createRoleValuesSelectQuery=function(a,b,c){return c.prepareOldSelect(a.getId(),{output:b,filter:[{property:a.getKeyAttribute().getId(),valueInput:"key"}]})};wrm.data.JDChangeTracker.prototype.enlistForInsert=function(a){var b=this,c=this._keyAttributeName,d={key:void 0};this._inserts.push(d);this._observePropertyChanges(a,function(a,f){f.propertyName===c&&null!==f.newValue&&(d.key=f.newValue,b._trackTuplesForKeyInit(a))});return Promise.resolve(a)};
wrm.data.JDChangeTracker.prototype.enlistForUpdate=function(a){var b=this,c=this._monitoredAttributesByName,d=this._monitoredRolesByName,e=this._roleValuesSelectQuery,f=this._serverKeyAttributeName,g=this._extractKey(a),h=null,k=this._dataRunner.execute(function(a){return e.queryOne(a,{key:g}).then(function(a){h=a})}),l={key:g,attributes:{}};this._updates.push(l);this._observePropertyChanges(a,function(a,e){var g=e.propertyName,k=e.newValue,r=c[g];r?(e=e.oldValue,k!==e&&(l.attributes[r.getId()]=r)):
(r=d[g])?(e=h[g],k!==e&&b._trackTuplesForRoleUpdate(a,r,e,k)):g===f&&(e=e.oldValue,b._trackServerKeyUpdate(a,e,k))});return k.then(function(){return a})};wrm.data.JDChangeTracker.prototype.enlistForDelete=function(a){var b=this._extractKey(a),c=this._extractServerKey(a);this._deletes.push({key:b,serverKey:c});return Promise.resolve(a)};wrm.data.JDChangeTracker.prototype._observePropertyChanges=function(a,b){a.propertyChanged.attach(b)};
wrm.data.JDChangeTracker.prototype._trackTuplesForKeyInit=function(a){var b=this,c=this._entity,d=this._monitoredRolesIds,e=this._extractKey(a);d.forEach(function(d){var g=a[d];if(g){d=c.getRole(d);var h=d.getInverseEntity(),g=b._extractKey(g,h);b._trackAddedAssociationTuple(d,e,g)}})};
wrm.data.JDChangeTracker.prototype._trackTuplesForRoleUpdate=function(a,b,c,d){if(c!==d){var e=b.getInverseEntity();a=this._extractKey(a);c=c?this._extractKey(c,e):null;d=d?this._extractKey(d,e):null;null!==c&&this._trackRemovedAssociationTuple(b,a,c);null!==d&&this._trackAddedAssociationTuple(b,a,d)}};wrm.data.JDChangeTracker.prototype.trackAddedRoleValue=function(a,b,c){a.getEntity()===this._entity&&this._trackAddedAssociationTuple(a,b,c)};
wrm.data.JDChangeTracker.prototype.trackRemovedRoleValue=function(a,b,c){a.getEntity()===this._entity&&this._trackRemovedAssociationTuple(a,b,c)};wrm.data.JDChangeTracker.prototype._trackAddedAssociationTuple=function(a,b,c){this._trackAssociationChange(this._assocAdditions,this._assocRemovals,a,b,c)};wrm.data.JDChangeTracker.prototype._trackRemovedAssociationTuple=function(a,b,c){this._trackAssociationChange(this._assocRemovals,this._assocAdditions,a,b,c)};
wrm.data.JDChangeTracker.prototype._trackAssociationChange=function(a,b,c,d,e){c=c.getId();var f=String(d)+"###"+String(e);(b=b[c])&&delete b[f];(b=a[c])||(a[c]=b={});b[f]={nearKey:d,farKey:e}};wrm.data.JDChangeTracker.prototype._trackServerKeyUpdate=function(a,b,c){a=this._extractKey(a);var d=String(a),e=this._serverKeyUpdates[d];e?e.newServerKey=c:this._serverKeyUpdates[d]={key:a,oldServerKey:b,newServerKey:c}};
wrm.data.JDChangeTracker.prototype.submitChanges=function(){var a=this._entity,b=this._dataTrackerService,c=this._assocAdditions,d=this._assocRemovals,e=this._serverKeyUpdates,f=Promise.resolve();0<this._inserts.length&&(f=this._inserts.reduce(function(c,d){return void 0===d.key?c:c.then(function(){return b.trackEntityCreate(a,d.key)})},f));0<this._updates.length&&(f=this._updates.reduce(function(c,d){var e=Object.keys(d.attributes).map(function(a){return d.attributes[a]});return 0>=e.length?c:c.then(function(){return b.trackEntityUpdate(a,
d.key,e)})},f));f=Object.keys(e).reduce(function(c,d){var f=e[d];return c.then(function(){return b.trackEntityServerKeyUpdate(a,f.key,f.oldServerKey,f.newServerKey)})},f);f=a.getRoles().reduce(function(a,e){var f=e.getId(),l=c[f],m=d[f];if(!l&&!m)return a;var n=e.getAssociation(),p=e!==n.getRole1();m&&Object.keys(m).forEach(function(c){c=m[c];var d=p?c.farKey:c.nearKey,e=p?c.nearKey:c.farKey;a=a.then(function(){return b.trackAssociationRemove(n,d,e)})});l&&Object.keys(l).forEach(function(c){c=l[c];
var d=p?c.farKey:c.nearKey,e=p?c.nearKey:c.farKey;a=a.then(function(){return b.trackAssociationAdd(n,d,e)})});return a},f);0<this._deletes.length&&(f=this._deletes.reduce(function(c,d){return c.then(function(){return b.trackEntityDelete(a,d.key,d.serverKey)})},f));this._clearChanges();return f};wrm.data.JDChangeTracker.prototype.discardChanges=function(){this._clearChanges()};
wrm.data.JDChangeTracker.prototype._clearChanges=function(){this._inserts=[];this._updates=[];this._deletes=[];this._assocAdditions={};this._assocRemovals={};this._serverKeyUpdates={}};wrm.data.JDChangeTracker.prototype._extractKey=function(a,b){b=b?b.getKeyAttribute().getName():this._keyAttributeName;a=a[b];if(!a)throw Error("Object has no key");return a};
wrm.data.JDChangeTracker.prototype._extractServerKey=function(a,b){a=(b=b?b.getServerKeyAttribute()&&b.getServerKeyAttribute().getName():this._serverKeyAttributeName)?a[b]:null;return void 0!==a?a:null};wrm.data.TrackingListener=function(a){this._dataTrackerService=a;this._inserts=[];this._updates=[];this._deletes=[];this._assocAdditions=[];this._assocRemovals=[]};exportSymbol("wrm.data.TrackingListener",wrm.data.TrackingListener);wrm.data.TrackingListener.prototype.getEntityListener=function(a){var b=this._createEntityMonitorInfo(a);return new wrm.data.TrackingListener._EntityChangeTracker(a,b,this._dataTrackerService,this)};
exportProperty(wrm.data.TrackingListener.prototype,"getEntityListener",wrm.data.TrackingListener.prototype.getEntityListener);wrm.data.TrackingListener.prototype.getAssociationListener=function(a){return new wrm.data.TrackingListener._AssocChangeTracker(a,this._dataTrackerService,this)};exportProperty(wrm.data.TrackingListener.prototype,"getAssociationListener",wrm.data.TrackingListener.prototype.getAssociationListener);
wrm.data.TrackingListener.prototype.submitChanges=function(){var a=Promise.resolve(),b=this._dataTrackerService;0<this._inserts.length&&(a=this._inserts.reduce(function(a,d){return void 0===d.key?a:a.then(function(){return b.trackEntityCreate(d.entity,d.key)})},a));0<this._updates.length&&(a=this._updates.reduce(function(a,d){var e=Object.keys(d.attributes).map(function(a){return d.attributes[a]});return 0>=e.length?a:a.then(function(){return b.trackEntityUpdate(d.entity,d.key,e)})},a));0<this._assocRemovals.length&&
(a=this._assocRemovals.reduce(function(a,d){return a.then(function(){return b.trackAssociationRemove(d.assoc,d.farKey,d.nearKey)})},a));0<this._assocAdditions.length&&(a=this._assocAdditions.reduce(function(a,d){return a.then(function(){return b.trackAssociationAdd(d.assoc,d.farKey,d.nearKey)})},a));0<this._deletes.length&&(a=this._deletes.reduce(function(a,d){return a.then(function(){return b.trackEntityDelete(d.entity,d.key,d.serverKey)})},a));this._clearChanges();return a};
wrm.data.TrackingListener.prototype.discardChanges=function(){this._clearChanges()};wrm.data.TrackingListener.prototype.enlistForInsert=function(a,b){this._inserts.push({entity:a,key:b})};wrm.data.TrackingListener.prototype.enlistForDelete=function(a,b,c){this._deletes.push({entity:a,key:b,serverKey:c})};wrm.data.TrackingListener.prototype.enlistForUpdate=function(a,b,c){this._updates.push({entity:a,key:b,attributes:c})};
wrm.data.TrackingListener.prototype.trackAddedRoleValue=function(a,b,c){this._assocAdditions.push({assoc:a,nearKey:b,farKey:c})};wrm.data.TrackingListener.prototype.trackRemovedRoleValue=function(a,b,c){this._assocRemovals.push({assoc:a,nearKey:b,farKey:c})};wrm.data.TrackingListener.prototype._clearChanges=function(){this._inserts=[];this._updates=[];this._deletes=[];this._assocAdditions=[];this._assocRemovals=[]};
wrm.data.TrackingListener.prototype._createEntityMonitorInfo=function(a){var b=a.getServerKeyAttribute(),c={};a.getAttributes().forEach(function(a){a!==b&&(c[a.getName()]=a)});return c};
wrm.data.TrackingListener._EntityChangeTracker=function(a,b,c,d){this._monitorInfo=b;this._entity=a;this._keyAttributeName=a.getKeyAttribute().getName();this._serverKeyAttributeName=a.getServerKeyAttribute()&&a.getServerKeyAttribute().getName();this._dataTrackerService=c;this.tracked=[a.getKeyAttribute().getName()];a.getServerKeyAttribute()&&this.tracked.push(a.getServerKeyAttribute().getName());this.trackedOld=[a.getKeyAttribute().getName()];a.getServerKeyAttribute()&&this.trackedOld.push(a.getServerKeyAttribute().getName());
this._trackingListener=d};wrm.data.TrackingListener._EntityChangeTracker.prototype.afterInsert=function(a){a=this._extractKey(a,this._entity);this._trackingListener.enlistForInsert(this._entity,a)};wrm.data.TrackingListener._EntityChangeTracker.prototype.afterUpdate=function(a,b){var c=this._extractKey(a,this._entity),d=[];Object.keys(a).forEach(function(c){var f=this._monitorInfo[c];f&&a[c]!==b[c]&&d.push(f)});this._trackingListener.enlistForUpdate(this._entity,c,d)};
wrm.data.TrackingListener._EntityChangeTracker.prototype.afterDelete=function(a){var b=this._extractKey(a,this._entity);a=this._extractServerKey(a,this._entity);this._trackingListener.enlistForDelete(this._entity,b,a)};wrm.data.TrackingListener._EntityChangeTracker.prototype._extractKey=function(a,b){b=b?b.getKeyAttribute().getName():this._keyAttributeName;a=a[b];if(!a)throw Error("Object has no key");return a};
wrm.data.TrackingListener._EntityChangeTracker.prototype._extractServerKey=function(a,b){a=(b=b?b.getServerKeyAttribute()&&b.getServerKeyAttribute().getName():this._serverKeyAttributeName)?a[b]:null;return void 0!==a?a:null};
wrm.data.TrackingListener._AssocChangeTracker=function(a,b,c){this._assoc=a;var d=a.getRole1().isForeignKey()?a.getRole1():a.getRole2();a=a.getRole1().isForeignKey()?a.getRole2():a.getRole1();this._nearKey=d.getId()+"."+d.getEntity().getKeyAttribute().getName();this._farKey=a.getId()+"."+a.getEntity().getKeyAttribute().getName();this.tracked=[this._nearKey,this._farKey];this.trackedOld=[this._nearKey,this._farKey];this._dataTrackerService=b;this._trackingListener=c};
wrm.data.TrackingListener._AssocChangeTracker.prototype.afterInsert=function(a){};wrm.data.TrackingListener._AssocChangeTracker.prototype.afterUpdate=function(a,b){};wrm.data.TrackingListener._AssocChangeTracker.prototype.afterDelete=function(a){a.hasOwnProperty(this._nearKey)&&a.hasOwnProperty(this._farKey)&&this._trackingListener.trackRemovedRoleValue(this._assoc,a[this._nearKey],a[this._farKey])};wrm.data.JDDataContext=function(a,b,c,d){wrm.data.AbstractDataContext.call(this,d);this._entityContext=a;this._transaction=b;this._xdataTransaction=null;this._subRunner=(this._dataTrackerService=c)?new wrm.data.JDDataContext._SubRunner(this):null;this._trackingListener=new wrm.data.TrackingListener(c)};extendConstructor(wrm.data.JDDataContext,wrm.data.AbstractDataContext);wrm.data.JDDataContext.prototype.getEntityContext=function(){return this._entityContext};
wrm.data.JDDataContext.prototype.getTransaction=function(){return this._transaction||void 0};wrm.data.JDDataContext.prototype.getXDataDatabase=function(){return this.getDataService().getXDataDatabase()};wrm.data.JDDataContext.prototype.getXDataTransaction=function(a,b){if(!a&&!b)return null;b=this._xdataTransaction;if(!b){b=this._transaction;if(!b){if(a)return null;throw Error("The new query implementation requires transactions");}this._xdataTransaction=b=this.getDataService().getXDataDatabase().attachTransaction(b.retrieveTransaction())}return b};
wrm.data.JDDataContext.prototype.openXDataSession=function(){var a=this._entityContext._wr_databaseName,b=this.getXDataDatabase(),a=GLOBAL.openDatabase(a,"",a,1048576);return Promise.resolve(b.attachSession(a))};
wrm.data.JDDataContext.prototype.doCastValue=function(a,b){if(a instanceof wrm.data.meta.Attribute)return a=a.getType(),wrm.data.toSingle(a,b);var c=a.getInverseEntity();if(b instanceof this._getEntityConstructor(c))return b;if(null===b)return null;a=this._entityContext[c.getSetName()];var d={},c=c.getKeyAttribute().getName();d[c]=b;return a.attachOrGet(d)};wrm.data.JDDataContext.prototype._getEntityConstructor=function(a){return wrm.util.obj.lookup(a.getName())};
wrm.data.JDDataContext.prototype.iterateResults=function(a,b){return a.forEach(b,this._transaction||void 0)};wrm.data.JDDataContext.prototype.loadResults=function(a){return a.toArray(void 0,this._transaction||void 0)};wrm.data.JDDataContext.prototype.saveChanges=function(){return this._entityContext.saveChanges(void 0,this._transaction||void 0)};wrm.data.JDDataContext.prototype.disableChangeTracking=function(){this._dataTrackerService=null};
wrm.data.JDDataContext.prototype.isChangeTrackingEnabled=function(){return!!this._dataTrackerService};wrm.data.JDDataContext.prototype.configureQuery=function(a){wrm.data.JDDataContext._super.configureQuery.call(this,a);if(this._dataTrackerService&&!(a instanceof wrm.data.JSelectQuery)&&this._dataTrackerService.isRelevantEntity(a.getEntity())){if(!this._subRunner)throw Error("Sub-runner not available");var b=new wrm.data.JDChangeTracker(a.getEntity(),this._subRunner,this._dataTrackerService);a.setChangeTracker(b)}};
wrm.data.JDDataContext.prototype.configureQueryNew=function(a){wrm.data.JDDataContext._super.configureQueryNew.call(this,a);if(this._dataTrackerService&&!(a instanceof wrm.data.XSelectQuery||a instanceof wrm.data.XDeleteQuery)&&this._dataTrackerService.isRelevantEntity(a.getBaseElement()))throw Error("Change tracking not possible with new queries");this.isChangeTrackingEnabled()&&this.addChangeListener(this._trackingListener)};
wrm.data.JDDataContext.prototype.interceptQueryResult=function(a,b){b=wrm.data.JDDataContext._super.interceptQueryResult.call(this,a,b);var c=a.getChangeTracker();return c?b.then(function(a){return c.submitChanges().then(function(){return a})},function(a){c.discardChanges();throw a;}):b};
wrm.data.JDDataContext.prototype.interceptQueryResultNew=function(a,b){b=wrm.data.JDDataContext._super.interceptQueryResultNew.call(this,a,b);if(this.isChangeTrackingEnabled()){var c=this._trackingListener;return b.then(function(a){return c.submitChanges().then(function(){return a})},function(a){c.discardChanges();throw a;})}return b};wrm.data.JDDataContext._SubRunner=function(a){this._entityContext=a._entityContext;this._parentInTransaction=!!a._transaction;this._dataService=a.getDataService()};
wrm.data.JDDataContext._SubRunner.prototype.prepareSelect=function(a,b){return this._dataService.prepareSelect(a,b)};wrm.data.JDDataContext._SubRunner.prototype.prepareOldSelect=function(a,b){return this._dataService.prepareOldSelect(a,b)};wrm.data.JDDataContext._SubRunner.prototype.prepareInsert=function(a,b){return this._dataService.prepareInsert(a,b)};wrm.data.JDDataContext._SubRunner.prototype.prepareNewInsert=function(a,b){return this._dataService.prepareNewInsert(a,b)};
wrm.data.JDDataContext._SubRunner.prototype.prepareUpdate=function(a,b){return this._dataService.prepareUpdate(a,b)};wrm.data.JDDataContext._SubRunner.prototype.prepareNewUpdate=function(a,b){return this._dataService.prepareNewUpdate(a,b)};wrm.data.JDDataContext._SubRunner.prototype.prepareOldDelete=function(a,b){return this._dataService.prepareOldDelete(a,b)};wrm.data.JDDataContext._SubRunner.prototype.prepareDelete=function(a,b){return this._dataService.prepareDelete(a,b)};
wrm.data.JDDataContext._SubRunner.prototype.prepareNewAssociationSelect=function(a,b){return this._dataService.prepareNewAssociationSelect(a,b)};wrm.data.JDDataContext._SubRunner.prototype.prepareNewAssociationInsert=function(a,b){return this._dataService.prepareNewAssociationInsert(a,b)};wrm.data.JDDataContext._SubRunner.prototype.prepareNewAssociationUpdate=function(a,b){return this._dataService.prepareNewAssociationUpdate(a,b)};
wrm.data.JDDataContext._SubRunner.prototype.prepareNewAssociationDelete=function(a,b){return this._dataService.prepareNewAssociationDelete(a,b)};wrm.data.JDDataContext._SubRunner.prototype.prepareCondition=function(a,b){return this._dataService.prepareCondition(a,b)};
wrm.data.JDDataContext._SubRunner.prototype.execute=function(a,b){var c=this._entityContext,d=this._dataService;return(b&&!this._parentInTransaction?c.beginTransaction(!0,function(a){a.keepAlive(300,500)}):Promise.resolve(null)).then(function(b){var f=new wrm.data.JDDataContext(c,b,null,d);return Promise.resolve(a(f)).finally(function(){b&&b.release()})})};wrm.data.JDPropertyFiller=function(a,b){this._targetPropertyName=a;this._roles=b.getRoles();this._resolvedReference=b.getResolvedReference();this._many=this._roles.some(function(a){return a.isMany()})};wrm.data.JDPropertyFiller.prototype.fill=function(a,b,c){var d=this;return this._doFill(b,this._roles,c).then(function(){d._setTargetValue(a,b)})};
wrm.data.JDPropertyFiller.prototype._doFill=function(a,b,c){var d=this;return 0<b.length?wrm.data.JDPropertyFiller.retrieveRoleValues(a,b,c).then(function(a){var f=b.slice(1);return a.reduce(function(a,b){return a.then(function(){return d._doFill(b,f,c)})},Promise.resolve())}):Promise.resolve()};
wrm.data.JDPropertyFiller.prototype._setTargetValue=function(a,b){b=new wrm.util.ObjectMapper(b);b.setFlattenArrays(!0);b=b.getValues(this._resolvedReference);this._many||(b=wrm.data.toAnySingle(b));a[this._targetPropertyName]=b};wrm.data.JDPropertyFiller.retrieveRoleValues=function(a,b,c){var d=b[0],e=a[d.getName()];return e||null===e&&d.isForeignKey()?Promise.resolve(wrm.data.toAnyArray(e)):wrm.data.JDPropertyFiller._fillRole(a,b,c).then(function(){return wrm.data.toAnyArray(a[d.getName()])})};
wrm.data.JDPropertyFiller._fillRole=function(a,b,c){var d=wrm.data.DataContextHelper;if(0>=b.length)return Promise.resolve();var e=b[0],f=e.getInverseRole();b=wrm.data.JDPropertyFiller.getIncludableRoles(b.slice(1));var g=e.getEntity(),h=f.getEntity(),k=b.map(function(a){return a.getName()}).join("."),l=d.retrieveEntitySet(c,g),m=d.retrieveEntitySet(c,h);return(e.isForeignKey()?Promise.resolve().then(function(){var b=l.filter("it."+g.getKeyAttribute().getName()+" \x3d\x3d\x3d this.key",{key:a[g.getKeyAttribute().getName()]}).map("it."+
e.getName()+"."+h.getKeyAttribute().getName());return d.loadResults(c,b)}).then(function(a){if(0<a.length){var b=m;k&&(b=b.include(k));b=b.filter("it."+h.getKeyAttribute().getName()+" \x3d\x3d\x3d this.farKey",{farKey:a[0]});return d.loadResults(c,b).then(function(a){return a[0]||null})}return null}):Promise.resolve().then(function(){var b=m;k&&(b=b.include(k));b=b.filter("it."+f.getName()+"."+g.getKeyAttribute().getName()+" \x3d\x3d\x3d this.key",{key:a[g.getKeyAttribute().getName()]});return d.loadResults(c,
b)})).then(function(b){b=e.isMany()?wrm.data.toAnyArray(b):wrm.data.toAnySingle(b);a[e.getName()]=b})};wrm.data.JDPropertyFiller.getIncludableRoles=function(a){for(var b=-1,c=0;c<a.length;c++)if(a[c].isMany()){b=c;break}return 0<=b?a.slice(0,b+1):a.slice(0)};wrm.data.JDPropertyFiller.isFillingRequired=function(a){var b=a.getRoles();a=a.getProperty()instanceof wrm.data.meta.Role?b.length-1:b.length;for(var c=0;c<a;c++)if(b[c].isMany())return!0;return!1};wrm.data.JSelectQuery=function(a,b,c){wrm.data.FilteredQuery.call(this,a,b,c&&c.include,c&&c.filter);this._output=c&&c.output;this._projector=null;this._distinct=c&&c.distinct||!1;this._orderCriteria=this._createOrderCriteria(c&&c.order);this._limits=this._createLimits(c&&c.limit)};extendConstructor(wrm.data.JSelectQuery,wrm.data.FilteredQuery);exportSymbol("wrm.data.JSelectQuery",wrm.data.JSelectQuery);
wrm.data.JSelectQuery.prototype._createProjector=function(a){function b(a){a=wrm.data.PropertyRef.of(e.getEntity(),a,0<g.length);var b=a.getLastRoleRef();b&&e.addIncludedRole(b);return a}function c(a,b){return wrm.data.JDPropertyFiller.isFillingRequired(b)?(a=new wrm.data.JDPropertyFiller(a.getId(),b),h.push(a.fill.bind(a)),!0):!1}var d=wrm.data.JDDataMover,e=this,f=this.getEntity(),g=this.getExposedMetaAttributes(),h=[],k=[],l=[];if(a)if("string"===typeof a)a=b(a),k.push({expose:!0,property:a.getProperty(),
resolvedReference:a.getPhysicalRef().getResolvedReference(),filled:c(a.getProperty(),a.getPhysicalRef())}),l.push(a.getProperty());else{var m=!angular.isArray(a);angular.forEach(a,function(a,d){var e=b(a),g=e.getProperty();a=m?d:g.getEntity()!==f?a.replace(".","_"):g.getName();k.push({expose:a,property:g,resolvedReference:e.getPhysicalRef().getResolvedReference(),filled:c(g,e.getPhysicalRef())});l.push(g)},this)}else a=f.getAttributes().slice(0),Array.prototype.push.apply(a,g),a.forEach(function(a){k.push({expose:a.getName(),
property:a,resolvedReference:a.getName(),filled:!1});l.push(a)}),this.getIncludedRoleRefs().forEach(function(a){var b=a.getProperty();k.push({expose:b.getName(),property:b,resolvedReference:a.getPhysicalRef().getResolvedReference(),filled:c(b,a.getPhysicalRef())});l.push(b)});d.computeAdditionalUnloadProperties(l).forEach(function(a){k.push({expose:!1,property:a,resolvedReference:a.getName(),filled:!1})});return{expression:"{"+k.map(function(a){return a.property.getId()+": "+(a.filled?"null":"it."+
a.resolvedReference)}).join(", ")+"}",filler:0<h.length?function(a,b,c){return h.reduce(function(d,e){return d.then(function(){return e(a,b,c)})},Promise.resolve())}:null,infos:k,exposedInfos:k.filter(function(a){return!1!==a.expose}),multipleExposed:1<l.length}};
wrm.data.JSelectQuery.prototype._createOrderCriteria=function(a){if(!a)return[];angular.isArray(a)||(a=[a]);var b=[];angular.forEach(a,function(a){var d=a.property||a;a=a.reverse||!1;var e=wrm.data.PropertyRef.of(this.getEntity(),d);if(!(e.getProperty()instanceof wrm.data.meta.Attribute))throw Error("Cannot order by non-attribute '"+d+"'");(d=e.getLastRoleRef())&&this.addIncludedRole(d);b.push({property:"it."+e.getPhysicalRef().getResolvedReference(),reverse:a})},this);return b};
wrm.data.JSelectQuery.prototype._createLimits=function(a){var b;"number"===typeof a?b=null:(b=a&&a.begin||null,a=a&&a.count||null);return{begin:b,count:a}};wrm.data.JSelectQuery.prototype.setExposedMetaAttributes=function(a){wrm.data.JSelectQuery._super.setExposedMetaAttributes.apply(this,arguments);this._projector=null};exportProperty(wrm.data.JSelectQuery.prototype,"setExposedMetaAttributes",wrm.data.JSelectQuery.prototype.setExposedMetaAttributes);
wrm.data.JSelectQuery.prototype.query=function(a,b){var c=this;this.checkDataContext(a);return(b=this._createQueryableWithMaxCount(a,b||{},null))?this.loadResults(a,b).then(function(b){return c._processResults(a,b)}):Promise.resolve([])};exportProperty(wrm.data.JSelectQuery.prototype,"query",wrm.data.JSelectQuery.prototype.query);
wrm.data.JSelectQuery.prototype.queryOne=function(a,b){var c=this;this.checkDataContext(a);return(b=this._createQueryableWithMaxCount(a,b||{},1))?this.loadResults(a,b).then(function(b){return c._processResults(a,b).then(function(a){return a[0]||null})}):Promise.resolve(null)};exportProperty(wrm.data.JSelectQuery.prototype,"queryOne",wrm.data.JSelectQuery.prototype.queryOne);wrm.data.JSelectQuery.prototype.createQueryable=function(a,b){return this._createQueryableWithMaxCount(a,b,null)};
wrm.data.JSelectQuery.prototype._createQueryableWithMaxCount=function(a,b,c){this._projector||(this._projector=this._createProjector(this._output));var d=wrm.data.JSelectQuery._super.createQueryable.call(this,a,b);if(!d)return null;this._projector.filler&&(d=wrm.data.LateFilteredQueryable.wrap(d,this.getEntity(),this.getIncludedRoles(),a),d.initMapperFunction(this._projector.filler));d=d.map(this._projector.expression);angular.forEach(this._orderCriteria,function(a){d=a.reverse?d.orderByDescending(a.property):
d.orderBy(a.property)});null!==this._limits.begin&&(d=d.skip(this._limits.begin));if(null!==this._limits.count||null!==c)d=null!==c?d.take(c):d.take(this._limits.count);return d};
wrm.data.JSelectQuery.prototype._processResults=function(a,b){var c=wrm.data.JDDataMover,d=this._projector.exposedInfos,e=null;if(this._distinct){var f=[];null!==this._projector.multipleExposed&&d.forEach(function(a){"string"===typeof a.expose&&f.push(a.expose)});e=new wrm.data.ObjectSet(f)}for(var g=[],h=[],k=0;k<b.length;k++){var l=b[k],m={};g[k]=m={};for(var n=0;n<d.length;n++){var p=d[n],q=p.property,p=p.expose,r=c.unload(l,q,q.getId(),a);void 0!==r&&(!0!==p?m[p]=r:g[k]=r);wrm.util.isPromise(r)&&
h.push(function(a,b){h.push(r.then(function(c){!0!==b?void 0!==c?g[a][b]=c:delete g[a][b]:g[a]=c}))}(k,p))}}return Promise.all(h).then(function(){if(e)for(var a=0;a<g.length;a++)e.add(g[a])||g.splice(a--,1);return g})};wrm.data.UpdateQuery=function(a,b,c){wrm.data.FilteredQuery.call(this,a,b,c&&c.include,c&&c.filter);a=c&&c.update;if(!a)throw Error("Update values not specified");this._update=a};extendConstructor(wrm.data.UpdateQuery,wrm.data.FilteredQuery);exportSymbol("wrm.data.UpdateQuery",wrm.data.UpdateQuery);
wrm.data.UpdateQuery.prototype.execute=function(a,b){if(b&&b.useNewishQueries)return wrm.data.NewQueries.update(this,this._update,a,b);var c=this;this.checkDataContext(a);var d=this.getEntity().getKeyAttribute(),e=d&&d.getName(),f=this.createQueryable(a,b||{});if(!f)return Promise.resolve([]);var g=[];b=this._createUpdateObjects(a,b);var h=this.hasChangeListeners()?[]:null,k=[];b=b.then(function(b){var d=Promise.resolve();return c.iterateResults(a,f,function(e){d=d.then(function(){e=c.includeInContext(a,
e);return c.enlistForUpdate(e)}).then(function(a){h&&h.push(c._extractValues(a));b.updateFunction(a);b.postUpdateFunction&&g.push(b.postUpdateFunction.bind(null,a));k.push(a)})}).then(function(){return d})});b=b.then(function(){return c.saveChanges(a)});b=b.then(function(){return g.reduce(function(a,b){return a.then(function(){return b()})},Promise.resolve())}).then(function(){if(0<g.length)return c.saveChanges(a)});return b.then(function(){c.hasChangeListeners()&&k.forEach(function(a,b){c.notifyInstanceUpdated(h[b],
a)});return k.map(function(a){return e?a[e]:null})})};exportProperty(wrm.data.UpdateQuery.prototype,"execute",wrm.data.UpdateQuery.prototype.execute);wrm.data.UpdateQuery.prototype.executeNoResult=function(a,b){var c=this;if(b&&b.useNewishQueries)return wrm.data.NewQueries.updateNoResult(this,this._update,a,b);this.checkDataContext(a);this.setFastQuery(!0);return this.execute(a,b).finally(function(){c.setFastQuery(!1)})};exportProperty(wrm.data.UpdateQuery.prototype,"executeNoResult",wrm.data.UpdateQuery.prototype.executeNoResult);
wrm.data.UpdateQuery.prototype._createUpdateObjects=function(a,b){var c=wrm.data.JDDataMover,d=this.getEntity(),e=this.getChangeTracker();b="function"===typeof this._update?this._update(b):this._update;var f={},g=[],h=[];angular.forEach(b,function(b,k){var n=d.getProperty(k,!0);if(n instanceof wrm.data.meta.Role){var p=wrm.data.RoleAccessor.get(n);(k=p.set(f,b,a))&&g.push(function(c){return p.postSet(c,b,e,a)})}else{k=c.isPostOperationRequired(n);var q=a.castToSingleValue(n,b);h.push(c.load(f,n,q));
k&&g.push(function(b){return c.postUpdate(n,b[n.getEntity().getKeyAttribute().getName()],q,a)})}});var k;k=0<g.length?function(a){return g.reduce(function(b,c){return b.then(function(){return c(a)})},Promise.resolve())}:null;return Promise.all(h).then(function(){return{updateFunction:function(a){for(var b in f)f.hasOwnProperty(b)&&(a[b]=f[b])},postUpdateFunction:k}})};
wrm.data.UpdateQuery.prototype._extractValues=function(a){var b={};a&&this.getEntity().getProperties().forEach(function(c){c=c.getName();b[c]=a[c]});return b};wrm.data.XQuery=function(a){this.baseElement=a;this._lastConfig=null};wrm.data.XQuery.prototype.getBaseElement=function(){return this.baseElement};wrm.data.XQuery.prototype.getXDataBaseElementName=ABSTRACT_METHOD;wrm.data.XQuery.prototype.getXDataPropertyPath=ABSTRACT_METHOD;wrm.data.XQuery.prototype.checkDataContext=function(a){if(a.getMetadata()!==this.baseElement.getMetadata())throw Error("The query was created against a different set of metadata");};
exportProperty(wrm.data.XQuery.prototype,"checkDataContext",wrm.data.XQuery.prototype.checkDataContext);wrm.data.XQuery.getEntityXDataName=function(a){return a.getSetName()};wrm.data.XQuery.getEntityXDataPropertyPath=function(a,b){return wrm.data.PropertyRef.of(a,b).getResolvedReference()};wrm.data.XQuery.getAssociationXDataName=function(a){return a.getId()};
wrm.data.XQuery.getAssociationXDataPropertyPath=function(a,b){var c=b.indexOf("."),d=0<=c?b.substring(0,c):b;b=0<=c?b.substring(c+1):null;if(a.getRole1().getId()===d)a=a.getEntity1();else if(a.getRole2().getId()===d)a=a.getEntity2();else throw Error("Unknown role '"+d+"' connect to association "+a);return b?d+"."+wrm.data.PropertyRef.of(a,b).getResolvedReference():d};
wrm.data.XQuery.prototype.configureXDataQuery=function(a,b){b=b.getQueryConfiguration();b!==this._lastConfig&&(b.configureQuery(a,this.getBaseElement()),this._lastConfig=b)};exportProperty(wrm.data.XQuery.prototype,"configureXDataQuery",wrm.data.XQuery.prototype.configureXDataQuery);wrm.data.XFilteredQuery=function(a){wrm.data.XQuery.call(this,a)};extendConstructor(wrm.data.XFilteredQuery,wrm.data.XQuery);wrm.data.XFilteredQuery.prototype.prepareXDataFilterExpression=function(a){return Array.isArray(a)?this._prepareXDataFilterLogicAndArrayExpression(a):"object"===typeof a?a.and?this._prepareXDataFilterLogicAndExpression(a):a.or?this._prepareXDataFilterLogicOrExpression(a):a.not?this._prepareXDataFilterLogicNotExpression(a):this._prepareXDataFilterGenericTerm(a):this._prepareXDataFilterSingleEqualTerm(a)};
wrm.data.XFilteredQuery.prototype._prepareXDataFilterLogicAndArrayExpression=function(a){return a.map(this.prepareXDataFilterExpression,this)};wrm.data.XFilteredQuery.prototype._prepareXDataFilterLogicAndExpression=function(a){var b={};b.and=a.and.map(this.prepareXDataFilterExpression,this);a.config&&(b.config=this._prepareXDataFilterConfig(a.config));return b};
wrm.data.XFilteredQuery.prototype._prepareXDataFilterLogicOrExpression=function(a){var b={};b.or=a.or.map(this.prepareXDataFilterExpression,this);a.config&&(b.config=this._prepareXDataFilterConfig(a.config));return b};wrm.data.XFilteredQuery.prototype._prepareXDataFilterLogicNotExpression=function(a){var b={};b.not=this.prepareXDataFilterExpression(a.not);a.config&&(b.config=this._prepareXDataFilterConfig(a.config));return b};
wrm.data.XFilteredQuery._VALUE_OPERATOR_MAP=function(a){var b=xdata.ValueOperator;a.e=b.EMPTY;a["!e"]=b.NOT_EMPTY;a.n=b.NULL;a["!n"]=b.NOT_NULL;a["in"]=b.IN;a["!in"]=b.NOT_IN;a.eq=b.EQUAL;a["eq.ic"]=b.EQUAL_IGNORE_CASE;a["!eq"]=b.NOT_EQUAL;a["!eq.ic"]=b.NOT_EQUAL_IGNORE_CASE;a.gt=b.GREATER;a.gte=b.GREATER_OR_EQUAL;a.lt=b.LESSER;a.lte=b.LESSER_OR_EQUAL;a.bw=b.BEGINNING;a["bw.ic"]=b.BEGINNING_IGNORE_CASE;a["!bw"]=b.NOT_BEGINNING;a["!bw.ic"]=b.NOT_BEGINNING_IGNORE_CASE;a.co=b.CONTAINING;a["co.ic"]=b.CONTAINING_IGNORE_CASE;
a["!co"]=b.NOT_CONTAINING;a["!co.ic"]=b.NOT_CONTAINING_IGNORE_CASE;a.ew=b.ENDING;a["ew.ic"]=b.ENDING_IGNORE_CASE;a["!ew"]=b.NOT_ENDING;a["!ew.ic"]=b.NOT_ENDING_IGNORE_CASE;return a}({});wrm.data.XFilteredQuery._COLLECTION_OPERATOR_MAP=function(a){var b=xdata.CollectionOperator;a.and=b.ALL;a.or=b.ANY;return a}({});
wrm.data.XFilteredQuery.prototype._prepareXDataFilterGenericTerm=function(a){var b={};b.property=this.getXDataPropertyPath(a.property);a.operator&&(b.operator=wrm.data.XFilteredQuery._VALUE_OPERATOR_MAP[a.operator]);void 0!==a.value&&(b.value=a.value);a.valueInput&&(b.valueInput=a.valueInput);a.valueOp&&(b.valueOperator=wrm.data.XFilteredQuery._COLLECTION_OPERATOR_MAP[a.valueOp]);void 0!==a.implied&&(b.implied=a.implied);a.config&&(b.config=this._prepareXDataFilterConfig(a.config));return b};
wrm.data.XFilteredQuery.prototype._prepareXDataFilterSingleEqualTerm=function(a){return this.getXDataPropertyPath(a)};wrm.data.XFilteredQuery.prototype._prepareXDataFilterConfig=function(a){return{oneImpliedInputRequired:a.oneImpliedInputRequired}};wrm.data.XDeleteQuery=function(a,b){wrm.data.XFilteredQuery.call(this,a);this._xdataFilter=this._constructXDataFilter(b);this._xdataQuery=null};extendConstructor(wrm.data.XDeleteQuery,wrm.data.XFilteredQuery);wrm.data.XDeleteQuery.prototype._constructXDataFilter=function(a){return(a=a&&a.filter)?this.prepareXDataFilterExpression(a):null};
wrm.data.XDeleteQuery.prototype.executeXDataQuery=function(a,b,c){this.checkDataContext(a);var d=this._xdataQuery;d||(this._xdataQuery=d=this._createXDataQuery(a));this.configureXDataQuery(d,a);var e=!1;return Promise.resolve(wrm.data.DataContextHelper.getXDataTransactionNew(a,b&&b.useNewishQueries)).then(function(b){return b?b:(e=!0,wrm.data.DataContextHelper.openXDataSession(a).then(function(a){return a.createTransaction()}))}).then(function(a){return c(a,d,b).then(function(b){return e?a.resolve().then(function(){return b}):
b})})};wrm.data.XDeleteQuery.prototype._createXDataQuery=function(a){return wrm.data.DataContextHelper.getXDataDatabase(a).prepareDelete(this.getXDataBaseElementName(),{filter:this._xdataFilter||void 0})};wrm.data.XAssocDeleteQuery=function(a,b,c){wrm.data.XDeleteQuery.call(this,a.getAssociation(b),c)};extendConstructor(wrm.data.XAssocDeleteQuery,wrm.data.XDeleteQuery);wrm.data.XAssocDeleteQuery.prototype.getXDataBaseElementName=function(){return wrm.data.XQuery.getAssociationXDataName(this.baseElement)};wrm.data.XAssocDeleteQuery.prototype.getXDataPropertyPath=function(a){return wrm.data.XQuery.getAssociationXDataPropertyPath(this.baseElement,a)};
wrm.data.XAssocDeleteQuery.prototype.execute=function(a,b){return this.executeXDataQuery(a,b,function(a,b,e){return b.execute(a,e)})};wrm.data.XAssocDeleteQuery.prototype.executeGetChanged=function(a,b){return this.executeXDataQuery(a,b,function(a,b,e){return b.executeGetChanged(a,e)})};wrm.data.XAssocDeleteQuery.prototype.executeGetCount=function(a,b){return Promise.reject(Error("Execution with result count is not supported yet"))};wrm.data.XInsertQuery=function(a,b){wrm.data.XQuery.call(this,a);this._inserts=this._constructInserts(b);this._xdataQueries={}};extendConstructor(wrm.data.XInsertQuery,wrm.data.XQuery);wrm.data.XInsertQuery.prototype._constructInserts=function(a){return Array.isArray(a)?a.slice(0):[a]};
wrm.data.XInsertQuery.prototype.executeXDataQuery=function(a,b,c){this.checkDataContext(a);var d={},e=this._inserts.map(function(a){a="function"===typeof a?a(b):a;for(var c=Object.keys(a),e=0;e<c.length;e++)d[c[e]]=!0;return a}),f=Object.keys(d);f.sort();var g=this.baseElement.getId()+"_"+f.join(","),h=this._xdataQueries[g];h||(h=this._createXDataQuery(f,a),this._xdataQueries[g]=h);var k=!1;return Promise.resolve(wrm.data.DataContextHelper.getXDataTransactionNew(a,b&&b.useNewishQueries)).then(function(b){return b?
b:(k=!0,wrm.data.DataContextHelper.openXDataSession(a).then(function(a){return a.createTransaction()}))}).then(function(a){return Promise.all(e.map(function(b){return c(a,h,b)})).then(function(b){return k?a.resolve().then(function(){return b}):b})})};
wrm.data.XInsertQuery.prototype._createXDataQuery=function(a,b){return wrm.data.DataContextHelper.getXDataDatabase(b).prepareInsert(this.getXDataBaseElementName(),{inserts:a.map(function(a){return{property:this.getXDataPropertyPath(a),valueInput:a}},this)})};wrm.data.XAssocInsertQuery=function(a,b,c){wrm.data.XInsertQuery.call(this,a.getAssociation(b),c)};extendConstructor(wrm.data.XAssocInsertQuery,wrm.data.XInsertQuery);wrm.data.XAssocInsertQuery.prototype.getXDataBaseElementName=function(){return wrm.data.XQuery.getAssociationXDataName(this.baseElement)};wrm.data.XAssocInsertQuery.prototype.getXDataPropertyPath=function(a){return wrm.data.XQuery.getAssociationXDataPropertyPath(this.baseElement,a)};
wrm.data.XAssocInsertQuery.prototype.execute=function(a,b){return this.executeXDataQuery(a,b,function(a,b,e){return b.executeGetChanged(a,e)}).then(function(a){return 0<=a.indexOf(!0)})};wrm.data.XAssocInsertQuery.prototype.executeGetChanged=function(a,b){return this.executeXDataQuery(a,b,function(a,b,e){return b.executeGetChanged(a,e)}).then(function(a){return 0<=a.indexOf(!0)})};wrm.data.XSelectQuery=function(a,b){wrm.data.XFilteredQuery.call(this,a);this._validateOutputConfig(b);this._xdataDistinct=this._constructXDataDistinct(b);this._xdataOutput=this._constructXDataOutput(b);this._xdataFilter=this._constructXDataFilter(b);this._xdataOrder=this._constructXDataOrder(b);this._xdataLimit=this._constructXDataLimit(b);this._xdataQuery=null};extendConstructor(wrm.data.XSelectQuery,wrm.data.XFilteredQuery);
wrm.data.XSelectQuery.prototype._validateOutputConfig=function(a){a=a&&a.outputConfig;if(!a||!a.useNames)throw Error("The output must be configured to use names");};wrm.data.XSelectQuery.prototype._constructXDataDistinct=function(a){a=a&&a.distinct;return void 0===a?null:a};
wrm.data.XSelectQuery.prototype._constructXDataOutput=function(a){var b=a&&a.output;if(!b)return null;if("object"===typeof b){if(Array.isArray(b))return b.map(this.getXDataPropertyPath,this);var c={};Object.keys(b).forEach(function(a){c[a]=this.getXDataPropertyPath(b[a])},this);return c}return this.getXDataPropertyPath(b)};wrm.data.XSelectQuery.prototype._constructXDataFilter=function(a){return(a=a&&a.filter)?this.prepareXDataFilterExpression(a):null};
wrm.data.XSelectQuery.prototype._constructXDataOrder=function(a){a=a&&a.order;if(!a)return null;Array.isArray(a)||(a=[a]);return a.map(function(a){return"string"===typeof a?this.getXDataPropertyPath(a):{property:this.getXDataPropertyPath(a.property),descending:a.reverse}},this)};wrm.data.XSelectQuery.prototype._constructXDataLimit=function(a){return(a=a&&a.limit)?"number"===typeof a?a:{begin:a.begin,count:a.count}:null};
wrm.data.XSelectQuery.prototype.executeXDataQuery=function(a,b,c){this.checkDataContext(a);var d=this._xdataQuery;d||(this._xdataQuery=d=this._createXDataQuery(a));var e=!1;return Promise.resolve(wrm.data.DataContextHelper.getXDataTransactionNew(a,b&&b.useNewishQueries)).then(function(b){return b?b:(e=!0,wrm.data.DataContextHelper.openXDataSession(a).then(function(a){return a.createTransaction()}))}).then(function(a){return c(a,d,b).then(function(b){return e?a.resolve().then(function(){return b}):
b})})};wrm.data.XSelectQuery.prototype._createXDataQuery=function(a){return wrm.data.DataContextHelper.getXDataDatabase(a).prepareSelect(this.getXDataBaseElementName(),{distinct:null!==this._xdataDistinct?this._xdataDistinct:void 0,output:this._xdataOutput||void 0,filter:this._xdataFilter||void 0,order:null!==this._xdataOrder?this._xdataOrder:void 0,limit:null!==this._xdataLimit?this._xdataLimit:void 0})};wrm.data.XAssocSelectQuery=function(a,b,c){wrm.data.XSelectQuery.call(this,a.getAssociation(b),c)};extendConstructor(wrm.data.XAssocSelectQuery,wrm.data.XSelectQuery);wrm.data.XAssocSelectQuery.prototype.getXDataBaseElementName=function(){return wrm.data.XQuery.getAssociationXDataName(this.baseElement)};wrm.data.XAssocSelectQuery.prototype.getXDataPropertyPath=function(a){return wrm.data.XQuery.getAssociationXDataPropertyPath(this.baseElement,a)};
wrm.data.XAssocSelectQuery.prototype.query=function(a,b){return this.executeXDataQuery(a,b,function(a,b,e){return b.queryAll(a,e)})};wrm.data.XAssocSelectQuery.prototype.queryOne=function(a,b){return this.executeXDataQuery(a,b,function(a,b,e){return b.queryOne(a,e)})};wrm.data.XUpdateQuery=function(a,b){wrm.data.XFilteredQuery.call(this,a);this._update=this._constructUpdate(b);this._xdataFilter=this._constructXDataFilter(b);this._xdataQueries={}};extendConstructor(wrm.data.XUpdateQuery,wrm.data.XFilteredQuery);wrm.data.XUpdateQuery.prototype._constructUpdate=function(a){a=a&&a.update;if(!a)throw Error("Update values not specified");return a};
wrm.data.XUpdateQuery.prototype._constructXDataFilter=function(a){return(a=a&&a.filter)?this.prepareXDataFilterExpression(a):null};
wrm.data.XUpdateQuery.prototype.executeXDataQuery=function(a,b,c){this.checkDataContext(a);var d;d="function"===typeof this._update?this._update(b):this._update;var e=Object.keys(d);e.sort();var f=this.baseElement.getId()+"_"+e.join(","),g=this._xdataQueries[f];g||(g=this._createXDataQuery(e,a),this._xdataQueries[f]=g);var h=b?Object.create(b):{};e.forEach(function(a){h["_u_"+a]=d[a]});var k=!1;return Promise.resolve(wrm.data.DataContextHelper.getXDataTransactionNew(a,b&&b.useNewishQueries)).then(function(b){return b?
b:(k=!0,wrm.data.DataContextHelper.openXDataSession(a).then(function(a){return a.createTransaction()}))}).then(function(a){return c(a,g,h).then(function(b){return k?a.resolve().then(function(){return b}):b})})};wrm.data.XUpdateQuery.prototype._createXDataQuery=function(a,b){return wrm.data.DataContextHelper.getXDataDatabase(b).prepareUpdate(this.getXDataBaseElementName(),{updates:a.map(function(a){return{property:this.getXDataPropertyPath(a),valueInput:"_u_"+a}},this),filter:this._xdataFilter||void 0})};wrm.data.XAssocUpdateQuery=function(a,b,c){wrm.data.XUpdateQuery.call(this,a.getAssociation(b),c)};extendConstructor(wrm.data.XAssocUpdateQuery,wrm.data.XUpdateQuery);wrm.data.XAssocUpdateQuery.prototype.getXDataBaseElementName=function(){return wrm.data.XQuery.getAssociationXDataName(this.baseElement)};wrm.data.XAssocUpdateQuery.prototype.getXDataPropertyPath=function(a){return wrm.data.XQuery.getAssociationXDataPropertyPath(this.baseElement,a)};
wrm.data.XAssocUpdateQuery.prototype.execute=function(a,b){return this.executeXDataQuery(a,b,function(a,b,e){return b.executeGetChanged(a,e)})};wrm.data.XAssocUpdateQuery.prototype.executeGetChanged=function(a,b){return this.executeXDataQuery(a,b,function(a,b,e){return b.executeGetChanged(a,e)})};wrm.data.EntityDeleteQuery=function(){};exportSymbol("wrm.data.EntityDeleteQuery",wrm.data.EntityDeleteQuery);wrm.data.EntityDeleteQuery.prototype.execute=function(a,b){};exportProperty(wrm.data.EntityDeleteQuery.prototype,"execute",wrm.data.EntityDeleteQuery.prototype.execute);wrm.data.EntityDeleteQuery.prototype.executeGetChanged=function(a,b){};exportProperty(wrm.data.EntityDeleteQuery.prototype,"executeGetChanged",wrm.data.EntityDeleteQuery.prototype.executeGetChanged);
wrm.data.EntityDeleteQuery.prototype.executeGetCount=function(a,b){};exportProperty(wrm.data.EntityDeleteQuery.prototype,"executeGetCount",wrm.data.EntityDeleteQuery.prototype.executeGetCount);wrm.data.XEntityDeleteQuery=function(a,b,c){wrm.data.XDeleteQuery.call(this,a.getEntity(b),c);this._casdcadeQueryLastConfig=null};extendConstructor(wrm.data.XEntityDeleteQuery,wrm.data.XDeleteQuery);wrm.data.XEntityDeleteQuery.prototype.getXDataBaseElementName=function(){return wrm.data.XQuery.getEntityXDataName(this.baseElement)};wrm.data.XEntityDeleteQuery.prototype.getXDataPropertyPath=function(a){return wrm.data.XQuery.getEntityXDataPropertyPath(this.baseElement,a)};
wrm.data.XEntityDeleteQuery.prototype.execute=function(a,b){var c=this;return this.executeXDataQuery(a,b,function(b,e,f){return c._doQueryWithCascade(e,a,b,f).then(function(a){return Promise.resolve()})})};wrm.data.XEntityDeleteQuery.prototype.executeGetChanged=function(a,b){var c=this;return this.executeXDataQuery(a,b,function(b,e,f){return c._doQueryWithCascade(e,a,b,f).then(function(a){return Promise.resolve(0<a)})})};
wrm.data.XEntityDeleteQuery.prototype.executeGetCount=function(a,b){var c=this;return this.executeXDataQuery(a,b,function(b,e,f){return c._doQueryWithCascade(e,a,b,f)})};
wrm.data.XEntityDeleteQuery.prototype._doQueryWithCascade=function(a,b,c,d){var e=this,f=this.getBaseElement(),g=[];f.getRoles().forEach(function(a){a.isForeignKey()||g.push(a)});return 0<g.length?a.executeGetKeys(c,d).then(function(a){return 0<a.length?e._doCascade(f,a,g,b,c).then(function(){return a.length}):0}):a.executeGetCount(c,d)};
wrm.data.XEntityDeleteQuery.prototype._doCascade=function(a,b,c,d,e){var f=this;return Promise.all(c.map(function(a){var c=a.getAssociation(),k=c.getId(),l=c.getEntity1(),m=c.getEntity2(),l=c.getRole1().getId()+"."+l.getKeyAttribute().getName(),m=c.getRole2().getId()+"."+m.getKeyAttribute().getName(),n=c.getRole1().getId()===a.getId()?l:m,p=[];b.map(function(a){"object"===typeof a?a.hasOwnPropery(n)&&p.push(a[n]):"number"===typeof a&&p.push(a)});a=wrm.data.DataContextHelper.getXDataDatabase(d).prepareDelete(k,
{filter:{property:n,operator:"in",value:p}});k=d.getQueryConfiguration();k!==f._casdcadeQueryLastConfig&&(k.configureQuery(a,c),f._casdcadeQueryLastConfig=k);return a.executeGetKeys(e,{})}))};wrm.data.XEntityInsertQuery=function(a,b,c){wrm.data.XInsertQuery.call(this,a.getEntity(b),c)};extendConstructor(wrm.data.XEntityInsertQuery,wrm.data.XInsertQuery);wrm.data.XEntityInsertQuery.prototype.getXDataBaseElementName=function(){return wrm.data.XQuery.getEntityXDataName(this.baseElement)};wrm.data.XEntityInsertQuery.prototype.getXDataPropertyPath=function(a){return wrm.data.XQuery.getEntityXDataPropertyPath(this.baseElement,a)};wrm.data.XEntityInsertQuery.prototype.execute=function(a,b){return Promise.reject(Error("Execution with result keys is not supported yet"))};
wrm.data.XEntityInsertQuery.prototype.executeGetChanged=function(a,b){return this.executeXDataQuery(a,b,function(a,b,e){return b.executeGetChanged(a,e)}).then(function(a){return 0<=a.indexOf(!0)})};wrm.data.EntitySelectQuery=function(){};exportSymbol("wrm.data.EntitySelectQuery",wrm.data.EntitySelectQuery);wrm.data.EntitySelectQuery.prototype.query=function(a,b){};exportProperty(wrm.data.EntitySelectQuery.prototype,"query",wrm.data.EntitySelectQuery.prototype.query);wrm.data.EntitySelectQuery.prototype.queryOne=function(a,b){};exportProperty(wrm.data.EntitySelectQuery.prototype,"queryOne",wrm.data.EntitySelectQuery.prototype.queryOne);wrm.data.XEntitySelectQuery=function(a,b,c){wrm.data.XSelectQuery.call(this,a.getEntity(b),c)};extendConstructor(wrm.data.XEntitySelectQuery,wrm.data.XSelectQuery);wrm.data.XEntitySelectQuery.prototype.getXDataBaseElementName=function(){return wrm.data.XQuery.getEntityXDataName(this.baseElement)};wrm.data.XEntitySelectQuery.prototype.getXDataPropertyPath=function(a){return wrm.data.XQuery.getEntityXDataPropertyPath(this.baseElement,a)};
wrm.data.XEntitySelectQuery.prototype.query=function(a,b){return this.executeXDataQuery(a,b,function(a,b,e){return b.queryAll(a,e)})};wrm.data.XEntitySelectQuery.prototype.queryOne=function(a,b){return this.executeXDataQuery(a,b,function(a,b,e){return b.queryOne(a,e)})};wrm.data.XEntityUpdateQuery=function(a,b,c){wrm.data.XUpdateQuery.call(this,a.getEntity(b),c)};extendConstructor(wrm.data.XEntityUpdateQuery,wrm.data.XUpdateQuery);wrm.data.XEntityUpdateQuery.prototype.getXDataBaseElementName=function(){return wrm.data.XQuery.getEntityXDataName(this.baseElement)};wrm.data.XEntityUpdateQuery.prototype.getXDataPropertyPath=function(a){return wrm.data.XQuery.getEntityXDataPropertyPath(this.baseElement,a)};wrm.data.XEntityUpdateQuery.prototype.execute=function(a,b){return Promise.reject(Error("Execution with result keys is not supported yet"))};
wrm.data.XEntityUpdateQuery.prototype.executeGetChanged=function(a,b){return this.executeXDataQuery(a,b,function(a,b,e){return b.executeGetChanged(a,e)})};wrm.util.ObjectPool=function(a,b,c){this._factoryFunction=a;this._destroyFunction=b||angular.noop;this._lifetime=c&&c.lifetime||wrm.util.ObjectPool.DEFAULT_LIFETIME;this._free=[]};exportSymbol("wrm.util.ObjectPool",wrm.util.ObjectPool);wrm.util.ObjectPool.DEFAULT_LIFETIME=3E4;exportProperty(wrm.util.ObjectPool,"DEFAULT_LIFETIME",wrm.util.ObjectPool.DEFAULT_LIFETIME);wrm.util.ObjectPool.prototype.acquire=function(){if(0<this._free.length){var a=this._free.shift();clearTimeout(a.destroyTimeout);return Promise.resolve(a.object)}return Promise.resolve(this._factoryFunction())};
exportProperty(wrm.util.ObjectPool.prototype,"acquire",wrm.util.ObjectPool.prototype.acquire);wrm.util.ObjectPool.prototype.release=function(a){var b=this;if(a){var c=setTimeout(function(){b._destroyObject(a)},this._lifetime);this._free.push({object:a,destroyTimeout:c})}};exportProperty(wrm.util.ObjectPool.prototype,"release",wrm.util.ObjectPool.prototype.release);
wrm.util.ObjectPool.prototype._destroyObject=function(a){for(var b=0;b<this._free.length;b++)if(this._free[b].object===a){this._free.splice(b,1);this._destroyFunction(a);break}};wrm.data.DataService=function(a,b,c){wrm.core.AbstractService.call(this,a,b,c);this._entityContextName=this.getDescriptorValue(b,"contextName");this._entityDisabledDataRestore=wrm.util.obj.createFromKeys(b.dataRestoreDisabled,!0);a=this.getDescriptorValue(b,"databaseName");b=new wrm.data.meta.Metadata(b.metadata||{});this._dbHandler=new wrm.data.DatabaseHandler(a,b,c.getPlatform(),this.getLog());this._dbHandler.setUnstableUseHandler(function(a){a.handleUnstableUse()});this._dbHandler.setMigrationHandler(this._migrateData.bind(this));
this._stable=!1;this._unstableInstance=new wrm.core.VolatileHolder(this);this._dbHandler.addStabilityListener(function(a){this.entityContextPool=wrm.data.DataService.createEntityContextPool(this);this._connectionTested=!1;this._purger=new wrm.data.Purger;this._stable=a;this._unstableInstance.swap(a?null:new wrm.data.UnstableDataService(this))}.bind(this))};exportSymbol("wrm.data.DataService",wrm.data.DataService);wrm.data.DataService.createEntityContextPool=function(a){return new wrm.util.ObjectPool(a._createEntityContext.bind(a))};
extendConstructor(wrm.data.DataService,wrm.core.AbstractService);exportProperty(wrm.data.DataService,"createEntityContextPool",wrm.data.DataService.createEntityContextPool);wrm.data.DataService.prototype.initialize=function(){var a=this,b=this.getManager();return Promise.all([b.getUpdateService().then(function(b){b.registerParticipant(wrm.data.DataService.UPDATE_ID,a._dbHandler)})])};exportProperty(wrm.data.DataService.prototype,"initialize",wrm.data.DataService.prototype.initialize);
wrm.data.DataService.ID="_data";exportProperty(wrm.data.DataService,"ID",wrm.data.DataService.ID);wrm.data.DataService.UPDATE_ID="data";exportProperty(wrm.data.DataService,"UPDATE_ID",wrm.data.DataService.UPDATE_ID);wrm.data.DataService.prototype.handleUnstableUse=function(){throw Error("The Data Service is not stable");};exportProperty(wrm.data.DataService.prototype,"handleUnstableUse",wrm.data.DataService.prototype.handleUnstableUse);wrm.data.DataService.prototype.useUnstable=function(a){this._unstableInstance.use(a)};
wrm.data.DataService.prototype.getMetadata=function(){return this._dbHandler.getMetadata(this)};exportProperty(wrm.data.DataService.prototype,"getMetadata",wrm.data.DataService.prototype.getMetadata);wrm.data.DataService.prototype.extractPropertyValuesByName=function(a,b,c){return this._extractPropertyValues(a,b,c,!1)};exportProperty(wrm.data.DataService.prototype,"extractPropertyValuesByName",wrm.data.DataService.prototype.extractPropertyValuesByName);
wrm.data.DataService.prototype.extractPropertyValuesById=function(a,b,c){return this._extractPropertyValues(a,b,c,!0)};exportProperty(wrm.data.DataService.prototype,"extractPropertyValuesById",wrm.data.DataService.prototype.extractPropertyValuesById);
wrm.data.DataService.prototype._extractPropertyValues=function(a,b,c,d){if(angular.isArray(a)&&0>=a.length)return{};"string"===typeof c&&(c=[c]);var e={},f=this.getMetadata().getEntity(b);c?c.forEach(function(a){a=f.getProperty(a);var b=d?a.getId():a.getName();e[b]=a}):f.getProperties().forEach(function(a){var b=d?a.getId():a.getName();e[b]=a});b=Object.keys(e);var g=wrm.util.obj.extractPropertyValues(a,b),h={};b.forEach(function(a){var b=e[a];g.hasOwnProperty(a)&&(h[b.getId()]=g[a])});return h};
wrm.data.DataService.prototype.prepareSelect=function(a,b){return new wrm.data.XEntitySelectQuery(this.getMetadata(),a,b)};exportProperty(wrm.data.DataService.prototype,"prepareSelect",wrm.data.DataService.prototype.prepareSelect);wrm.data.DataService.prototype.prepareOldSelect=function(a,b){return new wrm.data.JSelectQuery(this.getMetadata(),a,b)};exportProperty(wrm.data.DataService.prototype,"prepareOldSelect",wrm.data.DataService.prototype.prepareOldSelect);
wrm.data.DataService.prototype.prepareInsert=function(a,b){return new wrm.data.InsertQuery(this.getMetadata(),a,b)};exportProperty(wrm.data.DataService.prototype,"prepareInsert",wrm.data.DataService.prototype.prepareInsert);wrm.data.DataService.prototype.prepareNewInsert=function(a,b){return new wrm.data.XEntityInsertQuery(this.getMetadata(),a,b)};wrm.data.DataService.prototype.prepareUpdate=function(a,b){return new wrm.data.UpdateQuery(this.getMetadata(),a,b)};
exportProperty(wrm.data.DataService.prototype,"prepareUpdate",wrm.data.DataService.prototype.prepareUpdate);wrm.data.DataService.prototype.prepareNewUpdate=function(a,b){return new wrm.data.XEntityUpdateQuery(this.getMetadata(),a,b)};wrm.data.DataService.prototype.prepareOldDelete=function(a,b){return new wrm.data.JDeleteQuery(this.getMetadata(),a,b)};exportProperty(wrm.data.DataService.prototype,"prepareOldDelete",wrm.data.DataService.prototype.prepareOldDelete);
wrm.data.DataService.prototype.prepareDelete=function(a,b){return new wrm.data.XEntityDeleteQuery(this.getMetadata(),a,b)};exportProperty(wrm.data.DataService.prototype,"prepareDelete",wrm.data.DataService.prototype.prepareDelete);wrm.data.DataService.prototype.prepareNewAssociationSelect=function(a,b){return new wrm.data.XAssocSelectQuery(this.getMetadata(),a,b)};wrm.data.DataService.prototype.prepareNewAssociationInsert=function(a,b){return new wrm.data.XAssocInsertQuery(this.getMetadata(),a,b)};
wrm.data.DataService.prototype.prepareNewAssociationUpdate=function(a,b){return new wrm.data.XAssocUpdateQuery(this.getMetadata(),a,b)};wrm.data.DataService.prototype.prepareNewAssociationDelete=function(a,b){return new wrm.data.XAssocDeleteQuery(this.getMetadata(),a,b)};wrm.data.DataService.prototype.prepareCondition=function(a,b){return new wrm.data.Condition(this.getMetadata(),a,b)};exportProperty(wrm.data.DataService.prototype,"prepareCondition",wrm.data.DataService.prototype.prepareCondition);
wrm.data.DataService.prototype.execute=function(a,b){var c=this,d=this.getManager(),e=this.entityContextPool;return e.acquire().then(function(f){return new Promise(function(g,h){f._wr_txErrorHandlers=wrm.util.toErrorReject(h);return d.getDataTrackerService().then(function(d){return(b?f.beginTransaction(!0,function(a){a.keepAlive(300,500)}):Promise.resolve(null)).then(function(b){var e=new wrm.data.JDDataContext(f,b,d,c);return Promise.resolve(a(e)).finally(function(){b&&b.release()})})}).then(g,h).finally(function(){f._wr_txErrorHandlers=
null;e.release(f)})})})};exportProperty(wrm.data.DataService.prototype,"execute",wrm.data.DataService.prototype.execute);
wrm.data.DataService.prototype._createEntityContext=function(){var a=this,b=this._dbHandler.getConcreteDatabaseName(this),c=this._entityContextName;return Promise.resolve().then(function(){if(!this._connectionTested)return this._dbHandler.getDatabase(this).createSession(b,{autoCreate:!1}).then(function(){this._connectionTested=!0}.bind(this))}.bind(this)).then(function(){var d=GLOBAL[c];if("function"!==typeof d)throw Error("Entity context '"+c+"' not found");var e=newObject(d.prototype);d.call(e,
{provider:"sqLite",databaseName:b,dbCreation:$data.storageProviders.DbCreationType.AssumeUnchanged});e._wr_databaseName=b;return new Promise(function(b,c){e.onReady(function(){a._patchEntityContext(e);b(e)})["catch"](wrm.util.toErrorReject(c))})})};
wrm.data.DataService.prototype._patchEntityContext=function(a){function b(b){b.onerror.attach(function(b,d){(b=a._wr_txErrorHandlers)?b(d):c.error("Unhandled transaction error",d)})}var c=this.getLog();a.beginTransaction=function(a){return function(){for(var c=[],f,g=0;3>g;g++)"function"===typeof arguments[g]?(f=arguments[g],c[g]=function(a){b(a);return f.apply(this,arguments)}):c[g]=arguments[g];return f?a.apply(this,c):a.apply(this,arguments).then(function(a){b(a);return a})}}(a.beginTransaction)};
wrm.data.DataService.prototype.getPurger=function(){this._stable||this.handleUnstableUse();return this._purger};exportProperty(wrm.data.DataService.prototype,"getPurger",wrm.data.DataService.prototype.getPurger);wrm.data.DataService.prototype.getXDataDatabase=function(){return this._dbHandler.getDatabase(this)};
wrm.data.DataService.prototype._migrateData=function(a){var b=this.getManager(),c=new wrm.data.DataMigrator(this.getLog()),d=new wrm.data.UnstableDataService(this);return d.execute(function(b){return c.migrate(a,b)},!0).then(function(){d.invalidate()}).then(function(){var a=wrm.util.obj.lookup("wrxHookAfterDataMigration");if("function"===typeof a)return a(b)})};wrm.data.DataService.prototype.getAuxiliaryDictionary=function(){return this._dbHandler.getAuxiliaryDictionary()};
exportProperty(wrm.data.DataService.prototype,"getAuxiliaryDictionary",wrm.data.DataService.prototype.getAuxiliaryDictionary);
wrm.data.DataService.prototype.restoreInitialData=function(){var a=this,b=this.getManager(),c=this.getMetadata(),d=this._entityDisabledDataRestore;return b.getDataSyncService().then(function(a){return a.clearOutgoingChanges()}).then(function(){return a.execute(function(a){return c.getEntities().reduce(function(b,c){var h=c.getId();return c instanceof wrm.data.meta.AuxEntity||c.getServerName()||h===wrm.Constants.USER_ENT_ID||h===wrm.Constants.ROLE_ENT_ID||d[h]||c instanceof wrm.data.meta.BridgeEntity&&
c.getRole1().getInverseEntity().getServerName()&&c.getRole2().getInverseEntity().getServerName()?b:b.then(function(){return a["delete"](h,{},{})})},Promise.resolve())})}).then(function(){return b.getConfigurationObject("initialData")}).then(function(b){return a._insertInitialData(b)})};exportProperty(wrm.data.DataService.prototype,"restoreInitialData",wrm.data.DataService.prototype.restoreInitialData);
wrm.data.DataService.prototype._insertInitialData=function(a){var b=this.getMetadata(),c=this._entityDisabledDataRestore;return this.execute(function(d){return b.getEntities().reduce(function(b,f){if(f.getServerName())return b;var g=a[f.getName()];if(!g||c[f.getId()])return b;var h=f.getProperties(),k=g.map(function(a){var b={};h.forEach(function(c){var d=a[c.getName()];void 0!==d&&(b[c.getId()]=d)});return b});return b.then(function(){return d.insert(f.getId(),k)})},Promise.resolve())})};wrm.l10n={};wrm.l10n.LocalizationService=function(a,b,c){wrm.core.AbstractService.call(this,a,b,c);this._defaultLocale=this.getDescriptorValue(b,"defaultLocale");this._parseLocale(this._defaultLocale);this._localePrefs=this._createLocalePrefs(b.locales)};extendConstructor(wrm.l10n.LocalizationService,wrm.core.AbstractService);exportSymbol("wrm.l10n.LocalizationService",wrm.l10n.LocalizationService);wrm.l10n.LocalizationService.ID="_l10n";exportProperty(wrm.l10n.LocalizationService,"ID",wrm.l10n.LocalizationService.ID);
wrm.l10n.LocalizationService.prototype._createLocalePrefs=function(a){var b={};Object.keys(a).forEach(function(c){var d={};d.patterns=a[c].patterns;b[c]=d});return b};wrm.l10n.LocalizationService.prototype._parseLocale=function(a){var b=/^([a-z]{2})(?:[_\-]([A-Z]{2}))?$/i.exec(a);if(!b)throw Error("Invalid locale: "+a);return{language:b[1].toLowerCase(),country:b[2]?b[2].toUpperCase():null}};
wrm.l10n.LocalizationService.prototype.refreshLocale=function(){var a=this,b=this.getManager().getPlatform().getCurrentLocale();if(b===this._currentLocale)return Promise.resolve(!1);this._currentLocale=b;return Promise.resolve().then(function(){return a._reloadResources()}).then(function(){a._reloadPatterns();var b=a._parseLocale(a._currentResourcesLocale);wrm.nav.SystemValues.languageIsoCode=b.language;wrm.nav.SystemValues.countryIsoCode=b.country?b.country:null;return!0})};
exportProperty(wrm.l10n.LocalizationService.prototype,"refreshLocale",wrm.l10n.LocalizationService.prototype.refreshLocale);
wrm.l10n.LocalizationService.prototype._reloadResources=function(){var a=this,b=this.getManager(),c=this._parseLocale(this._currentLocale),d=null,e=null,f=[];c.country&&f.push(c.language+"_"+c.country);f.push(c.language);f.push(this._defaultLocale);return f.reduce(function(a,c){return a.then(function(){return d?null:b.getOptionalConfigurationObject("resources_"+c)}).then(function(a){a&&(d=a,e=c)})},Promise.resolve()).then(function(){if(d)a._resources=d,a._currentResourcesLocale=e;else throw a._resources=
{},a._currentResourcesLocale=a._currentLocale,Error("Resources not found for locale");})};
wrm.l10n.LocalizationService.prototype._reloadPatterns=function(){var a=this._parseLocale(this._currentLocale),b=null;a.country&&(b=this._localePrefs[a.language+"_"+a.country]||null);b||(b=this._localePrefs[a.language]||null);b||(b={patterns:{}});this._patterns=b.patterns;a=(this._patterns[wrm.data.Type.BOOLEAN]||"\u2713|\u2715").split("|",2);this._resources["boolean.yes"]=a[0];this._resources["boolean.no"]=a[1]};
wrm.l10n.LocalizationService.prototype.getCurrentLocale=function(){if(DEBUG&&!this._currentLocale)throw Error("Current locale not available");return this._currentLocale};exportProperty(wrm.l10n.LocalizationService.prototype,"getCurrentLocale",wrm.l10n.LocalizationService.prototype.getCurrentLocale);wrm.l10n.LocalizationService.prototype.getCurrentLocaleInfo=function(){return this.getManager().getPlatform().getCurrentLocaleInfo()};
exportProperty(wrm.l10n.LocalizationService.prototype,"getCurrentLocaleInfo",wrm.l10n.LocalizationService.prototype.getCurrentLocaleInfo);wrm.l10n.LocalizationService.prototype.getPreferredTypePattern=function(a){if(DEBUG&&!this._patterns)throw Error("Preferred patterns not available");return this._patterns[a]||null};exportProperty(wrm.l10n.LocalizationService.prototype,"getPreferredTypePattern",wrm.l10n.LocalizationService.prototype.getPreferredTypePattern);
wrm.l10n.LocalizationService.prototype.formatMessage=function(a,b){if(DEBUG&&!this._resources)throw Error("Resources not available");if(!this._resources.hasOwnProperty(a))return a;a=this._resources[a];b&&(a=a.replace(/\$\{([^}]+)\}/g,function(a,d){d=b[d];return void 0!==d?d:a}));return a};exportProperty(wrm.l10n.LocalizationService.prototype,"formatMessage",wrm.l10n.LocalizationService.prototype.formatMessage);wrm.core.Manager=function(a,b){this._loader=a;this._platform=b;this._variableProperties=null;this._serviceInstances={};this._log=b.createLog("wrm.core.Manager");this._log.info("WebRatio Mobile Runtime",wrm.VERSION,"started on",b.getWebEngineType())};exportSymbol("wrm.core.Manager",wrm.core.Manager);wrm.core.Manager.prototype.getNavigable=function(a){return this.getService(a).then(function(a){return implementsInterface(a,wrm.ThrowerService)?new wrm.core.NavigableThrower(a):a})};
exportProperty(wrm.core.Manager.prototype,"getNavigable",wrm.core.Manager.prototype.getNavigable);wrm.core.Manager.prototype.getNotifiable=function(a){return this.getService(a)};exportProperty(wrm.core.Manager.prototype,"getNotifiable",wrm.core.Manager.prototype.getNotifiable);wrm.core.Manager.prototype.getPlatform=function(){return this._platform};exportProperty(wrm.core.Manager.prototype,"getPlatform",wrm.core.Manager.prototype.getPlatform);wrm.core.Manager.prototype.getUpdateService=function(){return this.getService(wrm.core.UpdateService.ID)};
exportProperty(wrm.core.Manager.prototype,"getUpdateService",wrm.core.Manager.prototype.getUpdateService);wrm.core.Manager.prototype.getBackEndService=function(){return this.getService(wrm.core.BackEndService.ID)};exportProperty(wrm.core.Manager.prototype,"getBackEndService",wrm.core.Manager.prototype.getBackEndService);wrm.core.Manager.prototype.getDataService=function(){return this.getService(wrm.data.DataService.ID)};exportProperty(wrm.core.Manager.prototype,"getDataService",wrm.core.Manager.prototype.getDataService);
wrm.core.Manager.prototype.getDataSyncService=function(){return this.getService(wrm.data.sync.DataSyncService.ID)};exportProperty(wrm.core.Manager.prototype,"getDataSyncService",wrm.core.Manager.prototype.getDataSyncService);wrm.core.Manager.prototype.getDataTrackerService=function(){return this.getService(wrm.data.sync.DataTrackerService.ID)};exportProperty(wrm.core.Manager.prototype,"getDataTrackerService",wrm.core.Manager.prototype.getDataTrackerService);
wrm.core.Manager.prototype.getAppService=function(){return this.getService(wrm.core.AppService.ID)};exportProperty(wrm.core.Manager.prototype,"getAppService",wrm.core.Manager.prototype.getAppService);wrm.core.Manager.prototype.getSecurityService=function(){return this.getService(wrm.core.SecurityService.ID)};exportProperty(wrm.core.Manager.prototype,"getSecurityService",wrm.core.Manager.prototype.getSecurityService);wrm.core.Manager.prototype.getLocalizationService=function(){return this.getService(wrm.l10n.LocalizationService.ID)};
exportProperty(wrm.core.Manager.prototype,"getLocalizationService",wrm.core.Manager.prototype.getLocalizationService);wrm.core.Manager.prototype.getCatcherService=function(a){return this.getService(a)};exportProperty(wrm.core.Manager.prototype,"getCatcherService",wrm.core.Manager.prototype.getCatcherService);wrm.core.Manager.prototype.getViewService=function(a){return this.getService(a)};exportProperty(wrm.core.Manager.prototype,"getViewService",wrm.core.Manager.prototype.getViewService);
wrm.core.Manager.prototype.getViewComponentService=function(a){a=this.getService(a);0<SLOWDOWN&&(a=a.then(function(a){a.updateView=wrm.core.Manager._slowdownMethod(a.updateView,SLOWDOWN);return a}));return a};exportProperty(wrm.core.Manager.prototype,"getViewComponentService",wrm.core.Manager.prototype.getViewComponentService);wrm.core.Manager.prototype.hasFormSubService=function(a){return this.hasSubService(a,"form")};exportProperty(wrm.core.Manager.prototype,"hasFormSubService",wrm.core.Manager.prototype.hasFormSubService);
wrm.core.Manager.prototype.getFormSubService=function(a){return this.getSubService(a,"form")};exportProperty(wrm.core.Manager.prototype,"getFormSubService",wrm.core.Manager.prototype.getFormSubService);wrm.core.Manager.prototype.hasValidationSubService=function(a){return this.hasSubService(a,"validation")};exportProperty(wrm.core.Manager.prototype,"hasValidationSubService",wrm.core.Manager.prototype.hasValidationSubService);
wrm.core.Manager.prototype.getValidationSubService=function(a){a=this.getSubService(a,"validation");0<SLOWDOWN&&(a=a.then(function(a){a.validateEvent=wrm.core.Manager._slowdownMethod(a.validateEvent,SLOWDOWN);a.validateFormObject=wrm.core.Manager._slowdownMethod(a.validateFormObject,SLOWDOWN);a.validateFormProperty=wrm.core.Manager._slowdownMethod(a.validateFormProperty,SLOWDOWN);return a}));return a};exportProperty(wrm.core.Manager.prototype,"getValidationSubService",wrm.core.Manager.prototype.getValidationSubService);
wrm.core.Manager.prototype.getActionDefinitionService=function(a){return this.getService(a)};exportProperty(wrm.core.Manager.prototype,"getActionDefinitionService",wrm.core.Manager.prototype.getActionDefinitionService);wrm.core.Manager.prototype.getOperationService=function(a){return this.getService(a)};exportProperty(wrm.core.Manager.prototype,"getOperationService",wrm.core.Manager.prototype.getOperationService);wrm.core.Manager.prototype.getService=function(a){return this._doGetService(a).then(function(a){return a.main})};
exportProperty(wrm.core.Manager.prototype,"getService",wrm.core.Manager.prototype.getService);wrm.core.Manager.prototype.hasSubService=function(a,b){return this._doGetService(a.getId()).then(function(a){return!!a.sub[b]})};exportProperty(wrm.core.Manager.prototype,"hasSubService",wrm.core.Manager.prototype.hasSubService);
wrm.core.Manager.prototype.getSubService=function(a,b){return this._doGetService(a.getId()).then(function(c){c=c.sub[b];if(!c)throw Error("Sub-service '"+b+"' of service '"+a.getId()+"' is not available");return c})};exportProperty(wrm.core.Manager.prototype,"getSubService",wrm.core.Manager.prototype.getSubService);wrm.core.Manager.prototype.instantiateService=function(a,b){return this._instantiateService(a,b)};
wrm.core.Manager.prototype._doGetService=function(a){var b=this._serviceInstances[a];b||(b=this._createServiceInstances(a),this._serviceInstances[a]=b);return b};
wrm.core.Manager.prototype._createServiceInstances=function(a){var b=this,c=this._log,d=this._loader.loadServiceDescriptor(a),e=this.getVariableProperties();return Promise.all([d,e]).then(function(c){var d=c[0];c=c[1];if(!d)throw Error("Service '"+a+"' descriptor not found");b._replaceProperties(d,c);return b._instantiateService(a,d).then(function(a){return a})})["catch"](function(b){c.error("Error creating service '"+a+"'",b);throw b;})};
wrm.core.Manager.prototype._replaceProperties=function(a,b){angular.forEach(a,function(c,d){"object"===typeof c?this._replaceProperties(c,b):"string"===typeof c&&(a[d]=c.replace(/\$\{([^}]+)}/g,function(a,c){a=b[c];return void 0!==a?a:"${"+c+"}"}))},this)};
wrm.core.Manager.prototype._instantiateService=function(a,b){var c=this,d={};Object.keys(b).forEach(function(a){if(0===a.indexOf("_")&&1<a.length){var e=b[a];null!==e&&"object"===typeof e&&c._hasConstructor(e)&&(delete b[a],d[a.substring(1)]=e)}});var e=Promise.resolve().then(function(){return c._extractConstructor(b)})["catch"](function(b){throw Error("Cannot instantiate service '"+a+"': "+b.message);}),e=e.then(function(d){var e=newObject(d.prototype);d.call(e,a,b,c);return e});return e.then(function(a){return Promise.resolve(a.initialize(b)).then(function(){return a})}).then(function(a){var b=
{},e=Object.keys(d).map(function(e){return c._instantiateSubService(a,e,d[e]).then(function(a){b[e]=a})});return Promise.all(e).then(function(){return{main:a,sub:b}})})};
wrm.core.Manager.prototype._instantiateSubService=function(a,b,c){var d=this,e=Promise.resolve().then(function(){return d._extractConstructor(c)})["catch"](function(c){throw Error("Cannot instantiate sub-service '"+b+"' of service '"+a.getId()+"': "+c.message);}),e=e.then(function(b){var e=newObject(b.prototype);b.call(e,a,c,d);return e});return e.then(function(a){return Promise.resolve(a.initialize(c)).then(function(){return a})})};
wrm.core.Manager.prototype.getServiceType=function(a){return a.constructor._serviceType||"wrm.Service"};exportProperty(wrm.core.Manager.prototype,"getServiceType",wrm.core.Manager.prototype.getServiceType);wrm.core.Manager.prototype.getSubServiceType=function(a){return a.constructor._serviceType||"wrm.SubService"};exportProperty(wrm.core.Manager.prototype,"getSubServiceType",wrm.core.Manager.prototype.getSubServiceType);
wrm.core.Manager.prototype.getVariableProperties=function(){this._variableProperties||(this._variableProperties=this.getOptionalConfigurationProperties("WebRatio").then(function(a){return a||{}}));return this._variableProperties};exportProperty(wrm.core.Manager.prototype,"getVariableProperties",wrm.core.Manager.prototype.getVariableProperties);wrm.core.Manager.prototype.getConfigurationObject=function(a){return this._doGetConfigurationObject(a,!1)};
exportProperty(wrm.core.Manager.prototype,"getConfigurationObject",wrm.core.Manager.prototype.getConfigurationObject);wrm.core.Manager.prototype.getOptionalConfigurationObject=function(a){return this._doGetConfigurationObject(a,!0)};exportProperty(wrm.core.Manager.prototype,"getOptionalConfigurationObject",wrm.core.Manager.prototype.getOptionalConfigurationObject);
wrm.core.Manager.prototype._doGetConfigurationObject=function(a,b){var c=this._loader.loadConfigurationObject(a);b||(c=c.then(function(b){if(!b)throw Error("Configuration object '"+a+"' not found");return b}));return c};wrm.core.Manager.prototype.getConfigurationProperties=function(a){return this._doGetConfigurationProperties(a,!1)};exportProperty(wrm.core.Manager.prototype,"getConfigurationProperties",wrm.core.Manager.prototype.getConfigurationProperties);
wrm.core.Manager.prototype.getOptionalConfigurationProperties=function(a){return this._doGetConfigurationProperties(a,!0)};exportProperty(wrm.core.Manager.prototype,"getOptionalConfigurationProperties",wrm.core.Manager.prototype.getOptionalConfigurationProperties);wrm.core.Manager.prototype._doGetConfigurationProperties=function(a,b){var c=this._loader.loadConfigurationProperties(a);b||(c=c.then(function(b){if(!b)throw Error("Configuration properties '"+a+"' not found");return b}));return c};
wrm.core.Manager.prototype._hasConstructor=function(a){return"string"===typeof a._||"string"===typeof a.service};
wrm.core.Manager.prototype._extractConstructor=function(a){var b=this._log,c=a._,d=a.service;if(!c&&!d)throw Error("No constructor specified in descriptor");delete a._;delete a.service;a=Promise.resolve();a=c?a.then(function(){d&&b.warn("Ignoring reference to module '"+d+"', instead looking for global '"+c+"'");var a=wrm.util.obj.lookup(c);if("function"!==typeof a)throw Error("Missing or invalid constructor '"+c+"'");return a}):a.then(function(){return wrm.importModule(d.replace(/\./g,"/"))}).then(function(a){a=
a["default"];if("function"!==typeof a)throw Error("Missing or invalid constructor as default export in module '"+d+"'");return a});return a.then(function(a){a._serviceType=c||d;return a})};wrm.core.Manager._slowdownMethod=function(a,b){return function(){var c=this,d=arguments;return wrm.util.sleep(b/2).then(function(){return a.apply(c,d)}).then(function(a){return wrm.util.sleep(b/2).then(function(){return a})})}};wrm.core.MasterAwareFlow=function(a,b){wrm.nav.AbstractFlow.call(this,a.getId());this._mainFlow=a;this._autoFlows=b;var c=[a];angular.forEach(b,function(a){c.push(a)},this);this._preserves=wrm.core.MasterAwareFlow._constructMergedPreserves(c);this._bindings=wrm.core.MasterAwareFlow._constructMergedBindings(c);this._passings=wrm.core.MasterAwareFlow._constructMergedPassings(c)};extendConstructor(wrm.core.MasterAwareFlow,wrm.nav.AbstractFlow);
wrm.core.MasterAwareFlow._constructMergedPreserves=function(a){var b=null;a.forEach(function(a){if(a=a.getPreserves())b||(b={}),angular.forEach(a,function(a,c){var f=b[c];f||(b[c]=f={});angular.extend(f,a)})});return b};wrm.core.MasterAwareFlow._constructMergedBindings=function(a){var b={};angular.forEach(a,function(a){a=a.getBindings();angular.extend(b,a)});return b};
wrm.core.MasterAwareFlow._constructMergedPassings=function(a){var b={};angular.forEach(a,function(a){a=a.getPassings();angular.extend(b,a)});return b};wrm.core.MasterAwareFlow.prototype.getBoundSourceId=function(){return this._mainFlow.getBoundSourceId()};wrm.core.MasterAwareFlow.prototype.getBoundTargetId=function(){return this._mainFlow.getBoundTargetId()};wrm.core.MasterAwareFlow.prototype.getTargetId=function(){return this._mainFlow.getTargetId()};
wrm.core.MasterAwareFlow.prototype.getPreserves=function(){return this._preserves};wrm.core.MasterAwareFlow.prototype.getBindings=function(){return this._bindings};wrm.core.MasterAwareFlow.prototype.getPassings=function(){return this._passings};
wrm.core.MasterAwareFlow.prototype.removeUselessPreserves=function(a,b){var c=[this._mainFlow];this._autoFlows[a]&&angular.forEach(this._autoFlows,function(b,d){d!==a&&c.push(b)});var d=wrm.core.MasterAwareFlow._constructMergedPreserves(c);angular.forEach(b.getComponentInputs(),function(a,c){var g=this._preserves[c]||{},h=d[c]||{};c=b.getChainPropagatedParams(c);for(var k in a)"_"!==k.charAt(0)&&a.hasOwnProperty(k)&&!0!==c[k]&&!0===g[k]&&!0!==h[k]&&delete a[k]},this)};wrm.core.ScenarioCondition=function(a){var b;a.navs?(b={},angular.forEach(a.navs.split("|"),function(a){b[a]=!0},this)):b=null;a=a.effects?a.effects.split("|"):[];this._navigations=b;this._requiredEffects=a};
wrm.core.ScenarioCondition.prototype.matchesNavigation=function(a,b){if(null!=this._navigations&&!this._navigations.hasOwnProperty(a.name))return!1;if(0<this._requiredEffects.length){a=!1;for(var c=0;c<this._requiredEffects.length;c++){var d=this._requiredEffects[c];if("-"===d){if(0>=b.length){a=!0;break}}else if(0<=b.indexOf(d)){a=!0;break}}if(!a)return!1}return!0};wrm.core.NavigationConditions=function(a){var b=[];angular.forEach(a,function(a){var d=!0!==a.fr;a=new wrm.core.ScenarioCondition(a);b.push({selectiveRefresh:d,scenarioCondition:a})},this);this._conditions=b};
wrm.core.NavigationConditions.prototype.matchesNavigation=function(a,b){var c=!1;if(0<this._conditions.length)for(var d=0;d<this._conditions.length;d++){var e=this._conditions[d];if(e.selectiveRefresh===a.selectiveRefresh&&(c=!0,e.scenarioCondition.matchesNavigation(a,b)))return!0}return!c&&!a.selectiveRefresh};wrm.core.Navigations=function(a){a=this._createNavigations(a);this._navigations=a.byName;this._lookupsFullRefresh=this._computeLookupsByFlows(!1,a.list);this._lookupsSelectiveRefresh=this._computeLookupsByFlows(!0,a.list);this._firstFlows=this._computeFirstFlows(a.list)};wrm.core.Navigations.prototype._createNavigations=function(a){var b={list:[],byName:{}};angular.forEach(a,function(a,d){a=this._createNavigation(d,a);b.list.push(a);b.byName[d]=a},this);return b};
wrm.core.Navigations.prototype._createNavigation=function(a,b){var c=!0===b.nc,d=b.flows.split("|"),e=!0!==b.fr;b=b.effects?b.effects.split("|"):[];return{name:a,nonContextual:c,flows:d,selectiveRefresh:e,causedEffects:b,toString:function(){return a}}};
wrm.core.Navigations.prototype._computeLookupsByFlows=function(a,b){var c={};angular.forEach(b,function(a){var b=a.flows[0]+","+a.flows[a.flows.length-1],d=c[b];d||(c[b]=d=[]);d.push(a)},this);var d={};angular.forEach(c,function(b,c){d[c]=this._computeLookups([],a,b)},this);return d};
wrm.core.Navigations.prototype._computeLookups=function(a,b,c){var d={},e={};angular.forEach(c,function(c){if(c.selectiveRefresh==b){var d="\x3cnull\x3e";c.flows.length>a.length&&(d=c.flows[a.length]);var h=e[d];h||(e[d]=h=[]);h.push(c)}},this);angular.forEach(e,function(c,e){if("\x3cnull\x3e"===e){if(1<c.length)throw Error("Found multiple matching navigations for prefix "+a+" with "+(b?"selective":"full")+" refresh");d["\x3cnull\x3e"]=c}else{var h=a.slice(0);h.push(e);d[e]=this._computeLookups(h,
b,c)}},this);return d};wrm.core.Navigations.prototype._computeFirstFlows=function(a){var b={};angular.forEach(a,function(a){b[a.flows[0]]=!0},this);return b};wrm.core.Navigations.prototype.get=function(a){var b=this._navigations[a];if(!b)throw Error("Unknown navigation '"+a+"'");return b};wrm.core.Navigations.prototype.getMaxLength=function(a){for(var b=-1,c=a.length-1;0<=c;c--)this._firstFlows.hasOwnProperty(a[c])&&(b=c);return 0<=b?a.length-b:0};
wrm.core.Navigations.prototype.lookup=function(a,b,c){var d=this._doLookup(a,b,c);0>=d.length&&2>=c&&2<=a.length&&(d=this._doLookup([a[0],"*",a[a.length-1]],b,3));return d};wrm.core.Navigations.prototype._doLookup=function(a,b,c){b=b?this._lookupsSelectiveRefresh:this._lookupsFullRefresh;for(var d=a[a.length-1],e=0,f=null,g=0;g<a.length;g++)if(this._firstFlows.hasOwnProperty(a[g])&&(f=b[a[g]+","+d])){e=g;break}return f?this._doLookupStep(a.slice(e,a.length),c,f):[]};
wrm.core.Navigations.prototype._doLookupStep=function(a,b,c){var d=0>=b,e;do e=null,0<a.length&&(e=a.shift()),e=c[e||"\x3cnull\x3e"];while(!e&&0<a.length&&d);return e&&!angular.isArray(e)?this._doLookupStep(a,b-1,e):e?e:d?(a=[],this._collectNavigations(a,c),a):[]};wrm.core.Navigations.prototype._collectNavigations=function(a,b){angular.forEach(b,function(b){b&&!angular.isArray(b)?this._collectNavigations(a,b):Array.prototype.push.apply(a,b)})};wrm.core.NotFoundError=makeCustomErrorConstructor("wrm.core.NotFoundError");exportSymbol("wrm.core.NotFoundError",wrm.core.NotFoundError);wrm.core.PanelService=function(a,b,c){wrm.core.AbstractService.call(this,a,b,c);this._protectionRoles=b["protected"]||null;this._fence=b.fence||null;this._master=!0===b.master;this._gateway=!0===b.gateway;this._navigations=new wrm.core.Navigations(b.navigations);var d={};angular.forEach(b.knownEffects?b.knownEffects.split("|"):[],function(a){d[a]=!0});this._knownEffects=d;a=this._createPropagationFlows(b.propagations);this._propagationSequence=this._createPropagationSequence(b.propagationSequence,
a,"propagation sequence");c=this._createComponentComputations(b.components);this._components=c.compIds;this._componentComps=c.map;this._eventInfos=this._createEventInfos(b.events,a);this._autoFlow=new wrm.core.AutoFlow(b.autoFlow,this);this._autoFlowFull=new wrm.core.AutoFlow(b.autoFlowFull,this);this._navigateTasks=new wrm.util.TaskQueue({maxWorkers:10});this._pendingRefreshEventsHandling=!1};extendConstructor(wrm.core.PanelService,wrm.core.AbstractService);exportSymbol("wrm.core.PanelService",wrm.core.PanelService);
wrm.core.PanelService.prototype.initialize=function(a){var b=this,c=this.getManager(),d=c.getDataSyncService().then(function(a){b._dataSyncService=a});if(a.masters){var e=[];angular.forEach(a.masters,function(a){e.push(c.getViewService(a))});d=d.then(function(){return Promise.all(e).then(function(a){b._masterPanelServices=a})})}else this._masterPanelServices=[];return d};exportProperty(wrm.core.PanelService.prototype,"initialize",wrm.core.PanelService.prototype.initialize);
wrm.core.PanelService.prototype._createPropagationFlows=function(a){var b={};Object.keys(a).forEach(function(c){b[c]=new wrm.nav.FlowImpl(a[c])});return b};wrm.core.PanelService.prototype._createPropagationSequence=function(a,b,c){return a?a.split("|").map(function(a){var e=b[a];if(!e)throw Error("Invalid flow id '"+a+"' in "+c);return e},this):[]};
wrm.core.PanelService.prototype._createComponentComputations=function(a){var b={map:{},compIds:[]};angular.forEach(a,function(a,d){a=this._createComponentComputation(d,a);b.map[d]=a;b.compIds.push(d)},this);return b};
wrm.core.PanelService.prototype._createComponentComputation=function(a,b){var c=!0===b.fb,d=!0!==b.nv,e=new wrm.core.NavigationConditions(b.conds||[]),f=[];b.rf&&angular.forEach(b.rf,function(a){var b=!0!==a.fr,c=new wrm.core.ScenarioCondition(a),d=!0===a.all,e=[];a.inputs&&angular.forEach(a.inputs.split("|"),function(a){a=wrm.core.parseParameter(a).name;e.push(a)});f.push({selectiveRefresh:b,scenarioCondition:c,all:d,inputs:e})},this);return{compId:a,formBased:c,hasView:d,navConditions:e,refreshFormInfos:f}};
wrm.core.PanelService.prototype._createEventInfos=function(a,b){var c={};Object.keys(a).forEach(function(d){var e=a[d],f={eventId:d,compId:e.component||null,type:e.type,flow:e.flow?new wrm.nav.NavFlowImpl(e.flow):null,secondaryFlows:this._createPropagationSequence(e.secondaryFlows||null,b,"secondaries of event '"+d+"'")};c[f.type+"."+d]=f;!0===e.generic&&(c[f.type]=f)},this);return c};
wrm.core.PanelService.prototype.getFormInfo=function(){var a=this;if(this._master)throw Error("FormInfo of master panel can not be computed directly");var b={};return this._getOwnFormSubservices().then(function(c){Object.keys(c).forEach(function(a){b[a]=c[a]});return a._masterPanelServices.reduce(function(a,c){return a.then(function(){return c._getOwnFormSubservices()}).then(function(a){Object.keys(a).forEach(function(c){b[c]=a[c]})})},Promise.resolve())}).then(function(){return new wrm.core.FormInfo(b)})};
exportProperty(wrm.core.PanelService.prototype,"getFormInfo",wrm.core.PanelService.prototype.getFormInfo);wrm.core.PanelService.prototype._getOwnFormSubservices=function(){var a=this._components,b=this._componentComps,c=this.getManager(),d={};return a.reduce(function(a,f){return b[f].formBased?a.then(function(){return c.getViewComponentService(f)}).then(function(a){return c.getFormSubService(a)}).then(function(a){d[f]=a}):a},Promise.resolve()).then(function(){return d})};
wrm.core.PanelService.prototype.validate=function(a,b,c){var d=this.getManager();return Promise.resolve().then(function(){return d.getViewComponentService(a)}).then(function(a){return d.hasValidationSubService(a).then(function(b){return b?d.getValidationSubService(a):null})}).then(function(a){return a?b?a.validateFormProperty(b,c):a.validateFormObject(c):!0})};exportProperty(wrm.core.PanelService.prototype,"validate",wrm.core.PanelService.prototype.validate);
wrm.core.PanelService.prototype.getFence=function(){return this._fence};exportProperty(wrm.core.PanelService.prototype,"getFence",wrm.core.PanelService.prototype.getFence);wrm.core.PanelService.prototype.navigate=function(a,b){var c=this;return c._checkPermission(b).then(function(a){return a||c._dataSyncService.synchronizeDuringNavigation(b)}).then(function(d){c._dataSyncService.collectSuccessEvents(b);return d||c._navigateInternal(a,!0,b)})};
exportProperty(wrm.core.PanelService.prototype,"navigate",wrm.core.PanelService.prototype.navigate);wrm.core.PanelService.prototype._checkPermission=function(a){var b=this._protectionRoles;return b?this.getManager().getSecurityService().then(function(c){return c.checkPermission(b,a)}):Promise.resolve(null)};wrm.core.PanelService.prototype._navigateInternal=function(a,b,c){var d=[],e=this._navigate(this,b,d,c);this._navigateTasks.post(function(){return e.then(function(){return Promise.all(d)})});return e};
wrm.core.PanelService.prototype._navigate=function(a,b,c,d){var e=this.getLog();if(this._master){var f=d.getContextualStartPrimaryPanelId();return f?this.getManager().getViewService(f).then(function(e){return e._navigate(a,b,c,d)}):(e.error("Invalid direct navigation to master panel",this),wrm.nav.Route.toNowhere())}f=d.getFirstFlow();f instanceof wrm.core.MasterAwareFlow&&f.removeUselessPreserves(a.getId(),d);f=null;b&&(f=d.reachPanel(this,a,this._gateway));f=this._locateAllNavigations(f,d);return this._computePanel(f,
c,d).then(function(){e.debug("Panel navigation finished");return wrm.nav.Route.toNowhere()})};
wrm.core.PanelService.prototype.notify=function(a,b){var c=this,d=this.getLog();if(wrm.core.PanelService._REFRESH_EVENTS.hasOwnProperty(a.getType()))return this._handleEventWithRefresh(a,wrm.core.PanelService._REFRESH_EVENTS[a.getType()],b);if(!this._isKnownEvent(a)){for(var e=0;e<this._masterPanelServices.length;e++){var f=this._masterPanelServices[e];if(f._isKnownEvent(a))return f.notify(a,b)}if(!this._isKnownEvent(a))return this.getManager().getAppService().then(function(c){return c.notify(a,b)})}return Promise.resolve().then(function(){return c._validateEvent(a,
b)}).then(function(e){if(!e)return d.debug("Validation failed"),wrm.nav.Route.toNowhere();c._components.forEach(function(a){b.getComponentFormState(a).publishValidViewValues()});return c._handleEvent(a,b).then(function(a){return a?wrm.nav.Route.toService(a.getTargetId()):(a=b.getContextualStartPanelId())?wrm.nav.Route.toService(a):wrm.nav.Route.toNowhere()})})};exportProperty(wrm.core.PanelService.prototype,"notify",wrm.core.PanelService.prototype.notify);
wrm.core.PanelService.prototype._handleEventWithRefresh=function(a,b,c){var d=this,e=this.getLog();c.stepAhead(this._autoFlowFull);c.catchEvent(this,a);if(this._pendingRefreshEventsHandling)return e.debug("Ignoring further refresh after",b),Promise.resolve(wrm.nav.Route.toNowhere());this._pendingRefreshEventsHandling=!0;return this._navigateTasks.waitForIdle().then(function(){d._pendingRefreshEventsHandling=!1;e.debug("Refreshing after",b);return d._navigateInternal(null,!1,c).then(function(){return wrm.nav.Route.toNowhere()})})};
wrm.core.PanelService._REFRESH_EVENTS={SynchronizationSuccess:"data synchronization",CurrentLocaleChange:"locale change"};
wrm.core.PanelService.prototype._validateEvent=function(a,b){var c=this._components,d=this.getManager(),e=!0;return c.reduce(function(c,g){return c.then(function(){return d.getViewComponentService(g)}).then(function(a){return d.hasValidationSubService(a).then(function(b){return b?d.getValidationSubService(a):null})}).then(function(c){return c?c.validateEvent(a,b):!0}).then(function(a){a||(e=!1)})},Promise.resolve()).then(function(){return e})};
wrm.core.PanelService.prototype._handleEvent=function(a,b){var c=this,d=this.getLog(),e=this._createFlashState(),f=this._getEventInfo(a);if(!f)throw Error("Unknown event "+a);var g=f.compId,h=Promise.resolve();g&&(h=this._catchEvent(g,a,e,b));var h=h.then(function(){b.catchEvent(c,a)}),k=this._createEventNavigationFlow(f);if(k)var l={},h=f.secondaryFlows.reduce(function(a,d){return a.then(function(){var a=d.getBoundSourceId();if(!a||!c._componentComps[a])return{};var f=l[a];return f?f:c._submitView(a,
e,b).then(function(b){return l[a]=b})}).then(function(a){d.propagate(a,b)})},h),h=h.then(function(){return g?c._submitView(g,e,b):{}}),h=h.then(function(a){d.debug("Following event flow",k);k.propagate(a,b);b.stepAhead(k)});else b.stepJustEvent(f.eventId);return h.then(function(){return k})};wrm.core.PanelService.prototype._isKnownEvent=function(a){return!!this._getEventInfo(a)};
wrm.core.PanelService.prototype._getEventInfo=function(a){var b=this._eventInfos[a.getName()];b||(b=this._eventInfos[a.getType()]);return b||null};wrm.core.PanelService.prototype._createEventNavigationFlow=function(a){if((a=a.flow)&&0<this._masterPanelServices.length){var b={};b[this.getId()]=this._autoFlow;angular.forEach(this._masterPanelServices,function(a){b[a.getId()]=a._autoFlow});a=new wrm.core.MasterAwareFlow(a,b)}return a};wrm.core.PanelService.prototype.isMaster=function(){return this._master};
exportProperty(wrm.core.PanelService.prototype,"isMaster",wrm.core.PanelService.prototype.isMaster);
wrm.core.PanelService.prototype._computePanel=function(a,b,c){var d=this,e=this.getLog();if(this._master)throw Error("Master panels cannot be computed directly");e.isDebugEnabled()&&function(){var b=Object.keys(a).map(function(b){return b+":"+a[b].name}).join(", ");e.debug("Computing panel ("+b+")")}();var f=this._createFlashState(a);this._initFormInfo(f,c);var g=this._propagateParameters(f,c);return g=g.then(function(){var a=[];b.push(d._updateViews(a,f,c)["catch"](function(a){e.error("Error during view update",
a)}));e.isDebugEnabled()&&0<a.length&&e.debug("Will update views of",a.join(", "));return null})};
wrm.core.PanelService.prototype._initFormInfo=function(a,b){var c=this,d=wrm.core.RefreshMode,e=this._getNavigation(a),f=this._getObservedSideEffects(a);angular.forEach(this._componentComps,function(g){if(g.formBased){for(var h=null,k=0;k<g.refreshFormInfos.length;k++){var l=g.refreshFormInfos[k];if(l.selectiveRefresh===e.selectiveRefresh&&l.scenarioCondition.matchesNavigation(e,f)){h=l;break}}g=c._getViewComponentContext(g.compId,a,b);h?(g.setFormRefreshMode(h.all?d.REFRESH_ALL:d.REFRESH),g.setFreshInputs(h.inputs)):
(g.setFormRefreshMode(d.PRESERVE),g.setFreshInputs([]))}});this._master||angular.forEach(this._masterPanelServices,function(c){c._initFormInfo(a,b)})};
wrm.core.PanelService.prototype._propagateParameters=function(a,b){var c=this,d=Promise.resolve();angular.forEach(this._propagationSequence,function(e){var f=e.getBoundSourceId();this._isComponentExecuted(f,a)&&(d=d.then(function(){return c._computeOutput(f,a,b)}).then(function(c){e.propagateWithScore(c,1,a.parameterScores,b)}))},this);this._master||angular.forEach(this._masterPanelServices,function(c){d=d.then(function(){return c._propagateParameters(a,b)})},this);return d};
wrm.core.PanelService.prototype._updateViews=function(a,b,c){var d=[];angular.forEach(this._components,function(e){if(this._hasView(e)&&this._isComponentExecuted(e,b)){var f=this._updateView(e,b,c);d.push(f);a.push(e)}},this);this._master||angular.forEach(this._masterPanelServices,function(e){d.push(e._updateViews(a,b,c))},this);return Promise.all(d)};
wrm.core.PanelService.prototype._computeOutput=function(a,b,c){var d=this.getLog(),e=this._getViewComponentContext(a,b,c);return this.getManager().getViewComponentService(a).then(function(a){d.debug("Computing output of",a,"-",e);return Promise.resolve(a.computeOutput(e)).then(function(b){d.debug("Computed output of",a,"-",b);return b})})};
wrm.core.PanelService.prototype._updateView=function(a,b,c){var d=wrm.core.PanelService._REFRESH_EVENTS,e=wrm.core.PanelService,f=this.getLog(),g=this.getManager(),h=this._getViewComponentContext(a,b,c),k=h.getView(),l=!(!c.getCaughtEvent()||!d.hasOwnProperty(c.getCaughtEvent().getType()));e._setViewUpdateStatus(k,!0,l);d=g.getViewComponentService(a);a=this._getViewComponentFormPropertyChangeTracker(a,b,c);return Promise.all([d,a]).then(function(a){var b=a[0],d=a[1];f.debug("Updating view of",b,"-",
h);var q=d.updatesStarted(k);return Promise.try(function(){return b.updateView(h)}).finally(function(){d.updatesFinished(k,q);e._setViewUpdateStatus(k,!1,l)}).then(function(){return g.hasFormSubService(b)}).then(function(a){return a?g.getFormSubService(b):null}).then(function(a){if(a)return a.publishFormState(c)}).then(function(){f.debug("Updated view of",b,"-",k)})}).then(function(){k.applyChanges()})};
wrm.core.PanelService.prototype._catchEvent=function(a,b,c,d){var e=this.getLog(),f=this._getViewComponentContext(a,c,d);return this.getManager().getViewComponentService(a).then(function(a){e.debug("Catching at",a,"event",b,"-",f);return a.catchEvent(f,b)}).then(function(){f.getView().applyChanges()})};
wrm.core.PanelService.prototype._submitView=function(a,b,c){var d=this.getLog(),e=this._getViewComponentContext(a,b,c);return this.getManager().getService(a).then(function(a){d.debug("Submitting view of",a,"-",e);return Promise.resolve(a.submitView(e)).then(function(b){d.debug("Submitted view of",a,"-",b);return b})})};wrm.core.PanelService.prototype._getViewComponentContext=function(a,b,c){var d="context_"+a;b=b.cache;var e=b[d];e||(e=c.createViewComponentContext(a),b[d]=e);return e};
wrm.core.PanelService.prototype._getViewComponentFormPropertyChangeTracker=function(a,b,c){var d="fpChangeTracker_"+a,e=b.cache;b=this._componentComps;var f=this.getManager(),d=e[d];if(!d)var d=b[a],g=c.getComponentFormState(a),d=d.formBased&&g?Promise.resolve().then(function(){return f.getViewComponentService(a)}).then(function(a){return f.getFormSubService(a)}).then(function(a){return new wrm.form.FormPropertyTracker(g,a)}):Promise.resolve(new wrm.form.FormPropertyTracker(null,null));return d};
wrm.core.PanelService._setViewUpdateStatus=function(a,b,c){c?a._updatingBG=b:a.updating=b};wrm.core.PanelService.prototype._hasView=function(a){return this._componentComps[a].hasView};wrm.core.PanelService.prototype._isComponentExecuted=function(a,b){return this._checkNavigationConditions(this._componentComps[a].navConditions,b)};wrm.core.PanelService.prototype._checkNavigationConditions=function(a,b){var c=this._getNavigation(b);b=this._getObservedSideEffects(b);return a.matchesNavigation(c,b)};
wrm.core.PanelService.prototype._getNavigation=function(a){a=a.navigations[this.getId()];if(!a)throw Error("Navigation still not available");return a};wrm.core.PanelService.prototype._getObservedSideEffects=function(a){var b={},c=this._knownEffects;angular.forEach(a.navigations,function(a,e){e!==this.getId()&&angular.forEach(a.causedEffects,function(a){!0===c[a]&&(b[a]=!0)},this)},this);return Object.keys(b)};
wrm.core.PanelService.prototype._locateAllNavigations=function(a,b){var c=this._computeInterView(a,b),d={};d[this.getId()]=this._locateOwnNavigation(c,b);angular.forEach(this._masterPanelServices,function(a){d[a.getId()]=a._locateOwnNavigation(c,b)});return d};wrm.core.PanelService.prototype._computeInterView=function(a,b){return b.getContextualStartPrimaryPanelId()===this.getId()||b.getMergedPrimaryPanelId()===this.getId()&&a===wrm.nav.Reuse.FULL?!1:!0};
wrm.core.PanelService.prototype._locateOwnNavigation=function(a,b){var c=wrm.core.PanelService._REFRESH_EVENTS,d;b.getReachedPanelId()==this.getId()?(d=this._computeMainNavigatedFlows(b),b.getCaughtEvent()&&"BackEvent"===b.getCaughtEvent().getType()&&0>=d.length&&b.getMergedPrimaryPanelId()&&(d=this._computeAuxiliaryNavigatedFlows(a))):d=this._computeAuxiliaryNavigatedFlows(a);c=b.getCaughtEvent()&&c.hasOwnProperty(b.getCaughtEvent().getType());a=!a&&!c;b=this._locateNavigation(d,a,!0,b);if(null==
b)throw Error("Found no navigations on panel "+this.getId()+" matching flows "+d+" ("+(a?"selective":"full")+" refresh)");return b};wrm.core.PanelService.prototype._computeMainNavigatedFlows=function(a){var b=[];Array.prototype.push.apply(b,a.getFlowHistory());a=b[b.length-1]||null;var c=this.getId();for(c+".link"!==a&&c+".enter"!==a||b.pop();0<b.length&&wrm.Constants.FAKE_FLOW_ID===b[0];)b.shift();return b};
wrm.core.PanelService.prototype._computeAuxiliaryNavigatedFlows=function(a){return a?[this.getId()]:[this._autoFlow.getId()]};
wrm.core.PanelService.prototype._locateNavigation=function(a,b,c,d){var e=this._navigations.lookup(a,b,1);if(c&&0>=e.length&&(e=this._navigations.lookup([this.getId()],!1,1),0>=e.length))throw Error("Found no default navigation for flows "+a+" ("+(b?"selective":"full")+" refresh)");for(var f=null,g=0;g<e.length;g++){var h=e[g];if(this._checkNavigationConditionsForNavigationViability(h,d)){if(f){e=null;f=this._navigations.getMaxLength(a);0<f&&(e=this._locateNavigation(a.slice(a.length-f+1,a.length),
b,c,d));if(null!=e)return e;throw Error("Found multiple navigations matching flows "+a+" ("+(b?"selective":"full")+" refresh)");}f=h}}return f};wrm.core.PanelService.prototype._checkNavigationConditionsForNavigationViability=function(a,b){return!0};wrm.core.PanelService.prototype._createFlashState=function(a){return{navigations:a||{},parameterScores:{},cache:{}}};wrm.core.RefreshMode={PRESERVE:"preserve",REFRESH:"refresh",REFRESH_ALL:"refreshAll"};exportSymbol("wrm.core.RefreshMode",wrm.core.RefreshMode);wrm.core.UpdateContext=function(a,b,c,d,e,f){this._stableSnapshot=a;this._updateSnapshot=b;this._infoSetter=c;this._infoGetter=d;this._canceler=e;this._state=f};exportSymbol("wrm.core.UpdateContext",wrm.core.UpdateContext);wrm.core.UpdateContext.prototype.getStableSnapshot=function(){return this._stableSnapshot};exportProperty(wrm.core.UpdateContext.prototype,"getStableSnapshot",wrm.core.UpdateContext.prototype.getStableSnapshot);wrm.core.UpdateContext.prototype.getUpdateSnapshot=function(){return this._updateSnapshot};
exportProperty(wrm.core.UpdateContext.prototype,"getUpdateSnapshot",wrm.core.UpdateContext.prototype.getUpdateSnapshot);wrm.core.UpdateContext.prototype.setInfo=function(a){this._infoSetter(a)};exportProperty(wrm.core.UpdateContext.prototype,"setInfo",wrm.core.UpdateContext.prototype.setInfo);wrm.core.UpdateContext.prototype.getInfo=function(a){return this._infoGetter(a)};exportProperty(wrm.core.UpdateContext.prototype,"getInfo",wrm.core.UpdateContext.prototype.getInfo);
wrm.core.UpdateContext.prototype.cancel=function(){this._canceler()};exportProperty(wrm.core.UpdateContext.prototype,"cancel",wrm.core.UpdateContext.prototype.cancel);wrm.core.UpdateContext.prototype.getState=function(){return this._state};exportProperty(wrm.core.UpdateContext.prototype,"getState",wrm.core.UpdateContext.prototype.getState);wrm.data.Dictionary=function(){};exportSymbol("wrm.data.Dictionary",wrm.data.Dictionary);wrm.data.Dictionary.prototype.getKeys=function(){};exportProperty(wrm.data.Dictionary.prototype,"getKeys",wrm.data.Dictionary.prototype.getKeys);wrm.data.Dictionary.prototype.get=ABSTRACT_METHOD;exportProperty(wrm.data.Dictionary.prototype,"get",wrm.data.Dictionary.prototype.get);wrm.data.Dictionary.prototype.set=ABSTRACT_METHOD;exportProperty(wrm.data.Dictionary.prototype,"set",wrm.data.Dictionary.prototype.set);
wrm.data.Dictionary.prototype.remove=ABSTRACT_METHOD;exportProperty(wrm.data.Dictionary.prototype,"remove",wrm.data.Dictionary.prototype.remove);wrm.data.Dictionary.prototype.clear=ABSTRACT_METHOD;exportProperty(wrm.data.Dictionary.prototype,"clear",wrm.data.Dictionary.prototype.clear);wrm.data.WriteBackDictionary=function(a){this._delegate=a;this._modified={};this._removed={};this._dirty=!1};wrm.data.WriteBackDictionary.prototype.getKeys=function(){var a=this._delegate.getKeys();if(!this._dirty)return a;var b={};a.forEach(function(a){this._removed[a]||(b[a]=!0)},this);Object.keys(this._modified).forEach(function(a){b[a]=!0},this);return Object.keys(b)};wrm.data.WriteBackDictionary.prototype.get=function(a){if(this._dirty){if(this._removed.hasOwnProperty(a))return null;if(this._modified.hasOwnProperty(a))return this._modified[a]}return this._delegate.get(a)};
wrm.data.WriteBackDictionary.prototype.set=function(a,b){this._dirty&&delete this._removed[a];this._modified[a]=b;this._dirty=!0};wrm.data.WriteBackDictionary.prototype.remove=function(a){this._dirty&&delete this._modified[a];this._dirty=this._removed[a]=!0};wrm.data.WriteBackDictionary.prototype.clear=function(){this._dirty&&(this._modified={});this.getKeys().forEach(function(a){this._removed[a]=!0},this);this._dirty=!0};wrm.data.WriteBackDictionary.prototype.isDirty=function(){return this._dirty};
wrm.data.WriteBackDictionary.prototype.commitChanges=function(){this._dirty&&(Object.keys(this._removed).forEach(function(a){this._delegate.remove(a)},this),Object.keys(this._modified).forEach(function(a){this._delegate.set(a,this._modified[a])},this),this._modified={},this._removed={},this._dirty=!1)};wrm.core.UpdateService=function(a,b,c){wrm.core.AbstractService.call(this,a,b,c);this._participantInfosById={};this._participantsLocked=!1;this._contextsById={};this._infosById={};this._canceled=!1};extendConstructor(wrm.core.UpdateService,wrm.core.AbstractService);exportSymbol("wrm.core.UpdateService",wrm.core.UpdateService);wrm.core.UpdateService.prototype.initialize=function(a){var b=this;a=this.getManager();return Promise.all([a.getLocalizationService().then(function(a){b._l10nService=a})])};
exportProperty(wrm.core.UpdateService.prototype,"initialize",wrm.core.UpdateService.prototype.initialize);wrm.core.UpdateService.ID="_update";exportProperty(wrm.core.UpdateService,"ID",wrm.core.UpdateService.ID);
wrm.core.UpdateService.prototype.registerParticipant=function(a,b){if("string"!==typeof a)throw Error("Update participant id must be a string");if(this._participantsLocked)throw Error("Participants can no longer be registered");if(this._participantInfosById[a])throw Error("Participant "+a+" already registered");this._participantInfosById[a]={id:a,participant:b,requiredIds:b.getRequiredParticipantIds().slice()}};exportProperty(wrm.core.UpdateService.prototype,"registerParticipant",wrm.core.UpdateService.prototype.registerParticipant);
wrm.core.UpdateService.prototype._computeSortedParticipantIds=function(){var a=this;return wrm.util.sortTopologically(Object.keys(this._participantInfosById),function(b){var c=a._participantInfosById[b].requiredIds;c.forEach(function(c){if(!a._participantInfosById[c])throw Error("Unable to find participant "+c+" required by "+b);});return c})};
wrm.core.UpdateService.prototype.update=function(a){var b=this.getManager(),c=this.getLog();return this._solicitParticipatingServices().then(function(){this._reportUpdateProgress(!0,a);return this._doUpdate(a)}.bind(this)).then(function(c){this._reportUpdateProgress(!1,a);return c.canceled?wrm.nav.Route.toExit():c.updated?b.getDataSyncService().then(function(a){a.scheduleFirstSynchronization();return null}):null}.bind(this),function(b){this._reportUpdateProgress(!1,a);c.error("Update failed",b);return this._showErrorDialog(a).then(function(){return wrm.nav.Route.toExit()})}.bind(this))};
exportProperty(wrm.core.UpdateService.prototype,"update",wrm.core.UpdateService.prototype.update);wrm.core.UpdateService.prototype._solicitParticipatingServices=function(){var a=this.getManager();return Promise.all([a.getDataService(),a.getDataSyncService(),a.getBackEndService()])};
wrm.core.UpdateService.prototype._doUpdate=function(a){var b=this,c=this.getLog();this._participantsLocked=!0;var d=this._computeSortedParticipantIds(),e=this._callParticipants.bind(this,d,!1,a),f=this._callParticipants.bind(this,d,!0,a);this._clearUpdateState();a=Promise.resolve().then(function(){return e(function(a,b){return a.beginUpdate(b)})}).then(function(){return f(function(a,b){return a.prepareForExtensionUpdate(b)})}).then(function(){return e(function(a,b){return a.performExtensionUpdate(b)})}).then(function(){return e(function(a,
b){return a.performCoreUpdate(b)})}).then(function(){return f(function(a,b){return a.prepareForReductionUpdate(b)})}).then(function(){return e(function(a,b){return a.performReductionUpdate(b)})}).then(function(){return e(function(a,b,c){return Promise.resolve(a.finishUpdate(b)).then(function(a){return c||a})},!1)});a=a.then(function(a){this._commitUpdate();return{updated:a,canceled:!1}}.bind(this),function(a){c.debug("Update process canceled");if(a instanceof wrm.core.UpdateService._CanceledError)return{updated:!1,
canceled:!0};throw a;});return a.finally(function(){b._clearUpdateState()})};wrm.core.UpdateService.prototype._callParticipants=function(a,b,c,d,e){var f=this;return(b?Array.prototype.reduceRight:Array.prototype.reduce).call(a,function(a,b){var e=f._participantInfosById[b];return a.then(function(a){var b=f._getUpdateContext(e.id,c);return d.call(f,e.participant,b,a)})},Promise.resolve(e)).then(function(a){if(f._canceled)throw new wrm.core.UpdateService._CanceledError("Update canceled");return a})};
wrm.core.UpdateService.prototype._commitUpdate=function(){Object.keys(this._contextsById).forEach(function(a){this._contextsById[a].getStableSnapshot().commitChanges()},this);Object.keys(this._contextsById).forEach(function(a){this._contextsById[a].getUpdateSnapshot().clear()},this)};wrm.core.UpdateService.prototype._clearUpdateState=function(){this._contextsById={};this._infosById={};this._canceled=!1};
wrm.core.UpdateService.prototype._getUpdateContext=function(a,b){var c=this.getManager();if(!this._participantInfosById.hasOwnProperty(a))throw Error("Unknown participant "+a);var d=this._participantInfosById[a],e=this._contextsById[a];if(!e){var e=new wrm.data.WriteBackDictionary(c.getPlatform().retrieveDictionary("_update.stable."+a)),c=c.getPlatform().retrieveDictionary("_update.progress."+a),f=[a].concat(d.requiredIds),d=this._createInfoSetter(a),f=this._createInfoGetter(a,f),g=this._cancelUpdate.bind(this);
this._contextsById[a]=e=new wrm.core.UpdateContext(e,c,d,f,g,b)}return e};wrm.core.UpdateService.prototype._createInfoSetter=function(a){return function(b){this._infosById[a]=b}.bind(this)};wrm.core.UpdateService.prototype._createInfoGetter=function(a,b){return function(c){c=c||a;if(0>b.indexOf(c))throw Error("Unable to access update info of "+c);var d=this._infosById[c];if(!d)throw Error("Update info of "+c+" is not available");return d}.bind(this)};
wrm.core.UpdateService.prototype._cancelUpdate=function(){this._canceled=!0};wrm.core.UpdateService._CanceledError=makeCustomErrorConstructor("wrm.core.UpdateService._CanceledError");wrm.core.UpdateService.prototype._showErrorDialog=function(a){return this.getManager().getLocalizationService().then(function(b){var c=b.formatMessage("notification.updateError");b=new wrm.nav.Dialog(c,wrm.nav.Dialog.Flavor.NEGATIVE,[{label:b.formatMessage("dialog.button.Exit"),value:0}]);return a.presentDialog(b)})};
wrm.core.UpdateService.prototype._reportUpdateProgress=function(a,b){a=a?this._l10nService.formatMessage("notification.updateProgress"):null;b.reportProgress(new wrm.nav.Progress(a))};wrm.core.View=function(){};exportSymbol("wrm.core.View",wrm.core.View);exportProperty(wrm.core.View.prototype,"updating",wrm.core.View.prototype.updating);wrm.core.View.prototype.applyChanges=function(){};exportProperty(wrm.core.View.prototype,"applyChanges",wrm.core.View.prototype.applyChanges);wrm.data.BlobReference=function(a,b){this._serverFileId=a;this._status=b};wrm.data.BlobReference.prototype.getServerFileId=function(){return this._serverFileId};wrm.data.BlobReference.prototype.getStatus=function(){return this._status};wrm.data.ChangeListenerOld=function(a){this._changeListener=a;this._entityMap={}};exportSymbol("wrm.data.ChangeListenerOld",wrm.data.ChangeListenerOld);wrm.data.ChangeListenerOld.prototype.instanceInserted=function(a,b){var c;a instanceof wrm.data.meta.Entity&&(c=this._changeListener.getEntityListener(a),a=this._mapValuesForEntity(a,c.tracked,b),c.afterInsert(a))};exportProperty(wrm.data.ChangeListenerOld.prototype,"instanceInserted",wrm.data.ChangeListenerOld.prototype.instanceInserted);
wrm.data.ChangeListenerOld.prototype.instanceUpdated=function(a,b,c){var d;a instanceof wrm.data.meta.Entity&&(d=this._changeListener.getEntityListener(a),c=this._mapValuesForEntity(a,d.tracked,c),a=this._mapValuesForEntity(a,d.trackedOld,b),d.afterUpdate(a,c))};exportProperty(wrm.data.ChangeListenerOld.prototype,"instanceUpdated",wrm.data.ChangeListenerOld.prototype.instanceUpdated);
wrm.data.ChangeListenerOld.prototype.instanceDeleted=function(a,b){var c;a instanceof wrm.data.meta.Entity&&(c=this._changeListener.getEntityListener(a),a=this._mapValuesForEntity(a,c.trackedOld,b),c.afterDelete(a))};exportProperty(wrm.data.ChangeListenerOld.prototype,"instanceDeleted",wrm.data.ChangeListenerOld.prototype.instanceDeleted);
wrm.data.ChangeListenerOld.prototype._mapValuesForEntity=function(a,b,c){var d={},e=this._entityMap;void 0!==b&&null!==b&&Object.keys(b).forEach(function(f){f=b[f];if(c.hasOwnProperty(f))d[f]=c[f];else try{var g=e[a.getId()+"#"+f];void 0===g&&(g=a.getProperty(f,!1),e[a.getId()+"#"+f]=g);var h=g.getName();d[f]=c[h]}catch(k){d[f]=c[f]}});return d};wrm.data.ChangeTracker=function(){};exportSymbol("wrm.data.ChangeTracker",wrm.data.ChangeTracker);wrm.data.ChangeTracker.prototype.instanceInserted=ABSTRACT_METHOD;exportProperty(wrm.data.ChangeTracker.prototype,"instanceInserted",wrm.data.ChangeTracker.prototype.instanceInserted);wrm.data.ChangeTracker.prototype.instanceUpdated=ABSTRACT_METHOD;exportProperty(wrm.data.ChangeTracker.prototype,"instanceUpdated",wrm.data.ChangeTracker.prototype.instanceUpdated);
wrm.data.ChangeTracker.prototype.instanceDeleted=ABSTRACT_METHOD;exportProperty(wrm.data.ChangeTracker.prototype,"instanceDeleted",wrm.data.ChangeTracker.prototype.instanceDeleted);wrm.data.ContentType=function(a,b,c){this._type=a;this._subType=b;this._info=c};wrm.data.ContentType.prototype.getName=function(){return wrm.data.ContentType._computeName(this._type,this._subType)};wrm.data.ContentType._computeName=function(a,b){return b?a+"/"+b:a};wrm.data.ContentType.prototype.getType=function(){return this._type};wrm.data.ContentType.prototype.getSubType=function(){return this._subType};wrm.data.ContentType.prototype.getFileNameSuffix=function(){return this._info.fileNameSuffix};
wrm.data.ContentType.prototype.toString=function(){return this.getName()};wrm.data.ContentType._BY_NAME={};wrm.data.ContentType._BY_SUFFIX={};wrm.data.ContentType.register=function(a){var b=wrm.data.ContentType._BY_NAME,c=wrm.data.ContentType._BY_SUFFIX,d=a.getName(),e=a.getFileNameSuffix();if(b.hasOwnProperty(d))throw Error("Content type '"+d+"' is already registered");e&&!c.hasOwnProperty(e)&&(c[e]=a);b[d]=a};
wrm.data.ContentType.lookup=function(a,b){var c=wrm.data.ContentType,d=c._BY_NAME,e=null,f=null,g=/^(.+?)(?:\/(.+?))?(?:\s*;.*)?$/.exec(a);g&&(e=g[1],f=g[2]);g=null;f&&e&&(g=d[c._computeName(e,f)]);!g&&e&&(g=d[c._computeName(e,null)]);if(!g){if(b)return c.lookup(b);throw Error("Unknown content type '"+a+"'");}return g};wrm.data.ContentType.retrieveContentTypeBySuffix=function(a){return wrm.data.ContentType._BY_SUFFIX[a]||null};
wrm.data.ContentType.retrieveBestContentType=function(a){var b=null;a.forEach(function(a){null!=a&&(a=wrm.data.ContentType.lookup(a,"application/octet-stream"),null===b?b=a:null===b.getSubType()?null!==a.getSubType()&&(b=a):"octet-stream"===b.getSubType()&&(b=a))});return b};
(function(){var a=wrm.data.ContentType;[new a("application","doc",{fileNameSuffix:".doc"}),new a("application","gzip",{fileNameSuffix:".gz"}),new a("application","javascript",{fileNameSuffix:".js"}),new a("application","msword",{fileNameSuffix:".doc"}),new a("application","octet-stream",{fileNameSuffix:".bin"}),new a("application","pdf",{fileNameSuffix:".pdf"}),new a("application","vnd.adobe.flash-movie",{fileNameSuffix:".swf"}),new a("application","vnd.ms-excel",{fileNameSuffix:".xls"}),new a("application",
"vnd.ms-powerpoint",{fileNameSuffix:".ppt"}),new a("application","vnd.oasis.opendocument.presentation",{fileNameSuffix:".odp"}),new a("application","vnd.oasis.opendocument.spreadsheet",{fileNameSuffix:".ods"}),new a("application","vnd.oasis.opendocument.text",{fileNameSuffix:".odt"}),new a("application","vnd.openxmlformats-officedocument.presentationml.presentation",{fileNameSuffix:".pptx"}),new a("application","vnd.openxmlformats-officedocument.spreadsheetml.sheet",{fileNameSuffix:".xlsx"}),new a("application",
"vnd.openxmlformats-officedocument.wordprocessingml.document",{fileNameSuffix:".docx"}),new a("application","x-7z-compressed",{fileNameSuffix:".7z"}),new a("application","x-bzpdf",{fileNameSuffix:".pdf"}),new a("application","x-gzpdf",{fileNameSuffix:".pdf"}),new a("application","x-pdf",{fileNameSuffix:".pdf"}),new a("application","x-rar-compressed",{fileNameSuffix:".rar"}),new a("application","x-shockwave-flash",{fileNameSuffix:".swf"}),new a("application","x-tar",{fileNameSuffix:".tar"}),new a("application",
"xml",{fileNameSuffix:".xml"}),new a("application","zip",{fileNameSuffix:".zip"}),new a("audio",null,{fileNameSuffix:null}),new a("audio","mpeg",{fileNameSuffix:".mp3"}),new a("audio","ogg",{fileNameSuffix:".ogg"}),new a("image",null,{fileNameSuffix:null}),new a("image","gif",{fileNameSuffix:".gif"}),new a("image","jpeg",{fileNameSuffix:".jpg"}),new a("image","jpg",{fileNameSuffix:".jpg"}),new a("image","png",{fileNameSuffix:".png"}),new a("image","tiff",{fileNameSuffix:".tif"}),new a("image","tiff-fx",
{fileNameSuffix:".tif"}),new a("text",null,{fileNameSuffix:null}),new a("text","html",{fileNameSuffix:".html"}),new a("text","javascript",{fileNameSuffix:".js"}),new a("text","plain",{fileNameSuffix:".txt"}),new a("text","xml",{fileNameSuffix:".xml"}),new a("video",null,{fileNameSuffix:null}),new a("video","x-matroska",{fileNameSuffix:".mkv"}),new a("video","mpeg",{fileNameSuffix:".mpg"}),new a("video","quicktime",{fileNameSuffix:".mov"}),new a("video","webm",{fileNameSuffix:".webm"})].forEach(a.register)})();wrm.data.DataServiceUpdateState=function(a,b,c,d,e){this._originalMetadata=a;this._pastExtendedMetadata=b;this._extendedMetadata=c;this._extendedMetadataDiff=d;this._currentMetadata=e};exportSymbol("wrm.data.DataServiceUpdateState",wrm.data.DataServiceUpdateState);wrm.data.DataServiceUpdateState.prototype.isUpdating=function(){return!!this._originalMetadata&&!!this._extendedMetadata&&!!this._extendedMetadataDiff};exportProperty(wrm.data.DataServiceUpdateState.prototype,"isUpdating",wrm.data.DataServiceUpdateState.prototype.isUpdating);
wrm.data.DataServiceUpdateState.prototype._checkUpdating=function(){if(!this.isUpdating())throw Error("Not updating");};wrm.data.DataServiceUpdateState.prototype.getOriginalMetadata=function(){this._checkUpdating();return this._originalMetadata};exportProperty(wrm.data.DataServiceUpdateState.prototype,"getOriginalMetadata",wrm.data.DataServiceUpdateState.prototype.getOriginalMetadata);wrm.data.DataServiceUpdateState.prototype.getPastExtendedMetadata=function(){return this._pastExtendedMetadata};
wrm.data.DataServiceUpdateState.prototype.getExtendedMetadata=function(){this._checkUpdating();return this._extendedMetadata};exportProperty(wrm.data.DataServiceUpdateState.prototype,"getExtendedMetadata",wrm.data.DataServiceUpdateState.prototype.getExtendedMetadata);wrm.data.DataServiceUpdateState.prototype.getExtendedMetadataDiff=function(){this._checkUpdating();return this._extendedMetadataDiff};exportProperty(wrm.data.DataServiceUpdateState.prototype,"getExtendedMetadataDiff",wrm.data.DataServiceUpdateState.prototype.getExtendedMetadataDiff);
wrm.data.DataServiceUpdateState.prototype.getCurrentMetadata=function(){return this._currentMetadata};exportProperty(wrm.data.DataServiceUpdateState.prototype,"getCurrentMetadata",wrm.data.DataServiceUpdateState.prototype.getCurrentMetadata);wrm.data.MetadataRegistry=function(a){this._auxDictionary=a;this._metadataByVersion={};this.register(wrm.data.meta.Metadata.EMPTY)};wrm.data.MetadataRegistry.prototype.register=function(a,b){var c=a.getVersion();if(!b&&this._metadataByVersion[c]&&this._metadataByVersion[c]!==a)throw Error("Different metadata already registerd for version "+c);this._metadataByVersion[c]=a};
wrm.data.MetadataRegistry.prototype.getDatabaseVersion=function(a){var b=this._doGetDatabaseVersion(a);return null!==b?Number(b):a};wrm.data.MetadataRegistry.prototype.retrieveByDatabaseVersion=function(a){var b=this._metadataByVersion[a];if(b)return b;b=this._doGetMetadataVersion(a);if(null!==b)return this._metadataByVersion[b];throw Error("Unknown metadata for database version "+a);};
wrm.data.MetadataRegistry.prototype.initDatabaseVersion=function(a,b){if(null!==this._doGetDatabaseVersion(a))throw Error("Version "+a+" already mapped to the database");if(null!==this._doGetMetadataVersion(b))throw Error("Database version "+b+" already mapped to metadata");this._auxDictionary.set("_versions."+a,String(b))};wrm.data.MetadataRegistry.prototype._doGetDatabaseVersion=function(a){return(a=this._auxDictionary.get("_versions."+a))?Number(a):null};
wrm.data.MetadataRegistry.prototype._doGetMetadataVersion=function(a){var b=null;Object.keys(this._metadataByVersion).forEach(function(c){c=Number(c);if(this._doGetDatabaseVersion(c)===a)if(null===b)b=c;else throw Error("Found multiple metadata for database version "+a);},this);return b};wrm.data.XDMetadata=function(a,b,c){this._migrationWay=null!==b?b:wrm.data.meta.MigrationWay.STAYING;this._schema=xdata.Schema.normalize(wrm.data.XDMetadata._createSchemaConfig(a,this._extractId.bind(this)));this._version=c};wrm.data.XDMetadata._createSchemaConfig=function(a,b){var c=wrm.data.XDMetadata._createEntitiesSchemaConfig(a,b);a=wrm.data.XDMetadata._createRelationshipsSchemaConfig(a,b);return{typeHandlers:wrm.data.XDTypeHandlers.MAP,entities:c,relationships:a}};
wrm.data.XDMetadata._createEntitiesSchemaConfig=function(a,b){var c={};a.getEntities().forEach(function(a){if(a instanceof wrm.data.meta.RegularEntity||a instanceof wrm.data.meta.AuxEntity)c[a.getSetName()]=wrm.data.XDMetadata._createEntitySchemaConfig(a,b)});return c};
wrm.data.XDMetadata._createEntitySchemaConfig=function(a,b){var c={},d=[];a.getAttributes().forEach(function(a){var e=a.isOnFileSystem()?"fs":void 0;c[a.getName()]={type:wrm.data.XDTypeHandlers.getName(a.getType(),e),key:a.isKey(),identity:b(a)};a.isIndexed()&&d.push({unique:!0,attributes:a.getName()})});var e={};a.getRoles().forEach(function(a){e[a.getName()]=b(a.getAssociation())+"."+b(a)});return{attributes:c,indexes:d,roles:e,identity:b(a)}};
wrm.data.XDMetadata._createRelationshipsSchemaConfig=function(a,b){var c={};a.getAssociations().forEach(function(a){a instanceof wrm.data.meta.RegularAssociation&&(c[b(a)]=wrm.data.XDMetadata._createRelationshipSchemaConfig(a,b))});return c};
wrm.data.XDMetadata._createRelationshipSchemaConfig=function(a,b){function c(b){var c={};c.cardinality=b.getInverseRole().isMany()?"N":"1";var e={};d?(b=b===a.getRole1()?d.getRole1():d.getRole2(),e["websql.bridgeColumnName."+b.getInverseEntity().getKeyAttribute().getName()]=b.getForeignKeyName()):b.isForeignKey()&&(e["websql.collapsedSide"]=!0,e["websql.columnName."+b.getInverseEntity().getKeyAttribute().getName()]=b.getForeignKeyName());c.provider=e;return c}var d=a.getBridgeEntity(),e={};e[b(a.getRole1())]=
c(a.getRole1());e[b(a.getRole2())]=c(a.getRole2());b={};d&&(b["websql.bridgeTableName"]=a.getBridgeEntity().getSetName());return{roles:e,provider:b}};wrm.data.XDMetadata.prototype._extractId=function(a){var b=wrm.data.meta.MigrationWay,c=a.getMigrationWay();if(this._migrationWay===b.STAYING){if(c!==this._migrationWay)throw Error("Found migrating element: "+a);return a.getId()}return this._migrationWay===b.ARRIVING?a.getMigrationTempId()||a.getId():a.getId()};
wrm.data.XDMetadata.prototype.getSchema=function(){return this._schema};wrm.data.XDMetadata.prototype.getVersion=function(){return this._version};wrm.data.meta.EntityDiff=function(a){this._id=a.id;this._attributes=this._createGroup(a.attributes||{});this._roles=this._createGroup(a.roles||{})};exportSymbol("wrm.data.meta.EntityDiff",wrm.data.meta.EntityDiff);wrm.data.meta.EntityDiff.prototype._createGroup=function(a){return{added:(a.added||[]).slice(),removed:(a.removed||[]).slice(),replaced:(a.replaced||[]).map(function(a){return{older:a.older,newer:a.newer}})}};wrm.data.meta.EntityDiff.prototype.getId=function(){return this._id};
exportProperty(wrm.data.meta.EntityDiff.prototype,"getId",wrm.data.meta.EntityDiff.prototype.getId);wrm.data.meta.EntityDiff.prototype.getAddedAttributesIds=function(){return this._attributes.added};exportProperty(wrm.data.meta.EntityDiff.prototype,"getAddedAttributesIds",wrm.data.meta.EntityDiff.prototype.getAddedAttributesIds);wrm.data.meta.EntityDiff.prototype.getRemovedAttributesIds=function(){return this._attributes.removed};
exportProperty(wrm.data.meta.EntityDiff.prototype,"getRemovedAttributesIds",wrm.data.meta.EntityDiff.prototype.getRemovedAttributesIds);wrm.data.meta.EntityDiff.prototype.getReplacedAttributesIdPairs=function(){return this._attributes.replaced};exportProperty(wrm.data.meta.EntityDiff.prototype,"getReplacedAttributesIdPairs",wrm.data.meta.EntityDiff.prototype.getReplacedAttributesIdPairs);wrm.data.meta.EntityDiff.prototype.getAddedRolesIds=function(){return this._roles.added};
exportProperty(wrm.data.meta.EntityDiff.prototype,"getAddedRolesIds",wrm.data.meta.EntityDiff.prototype.getAddedRolesIds);wrm.data.meta.EntityDiff.prototype.getRemovedRolesIds=function(){return this._roles.removed};exportProperty(wrm.data.meta.EntityDiff.prototype,"getRemovedRolesIds",wrm.data.meta.EntityDiff.prototype.getRemovedRolesIds);wrm.data.meta.EntityDiff.prototype.getReplacedRolesIdPairs=function(){return this._roles.replaced};
exportProperty(wrm.data.meta.EntityDiff.prototype,"getReplacedRolesIdPairs",wrm.data.meta.EntityDiff.prototype.getReplacedRolesIdPairs);wrm.data.meta.MetadataDiff=function(a){this._descriptor=wrm.data.cloneObject(a);this._entities=this._createEntityDiffs(a.entities||{});this._assocs=this._createGroup(a.associations||{})};exportSymbol("wrm.data.meta.MetadataDiff",wrm.data.meta.MetadataDiff);wrm.data.meta.MetadataDiff.prototype._createEntityDiffs=function(a){function b(a){return a.map(function(a){return new wrm.data.meta.EntityDiff(a)})}return{added:b(a.added||[]),removed:b(a.removed||[]),changed:b(a.changed||[])}};
wrm.data.meta.MetadataDiff.prototype._createGroup=function(a){return{added:(a.added||[]).slice(),removed:(a.removed||[]).slice(),replaced:(a.replaced||[]).map(function(a){return{older:a.older,newer:a.newer}})}};wrm.data.meta.MetadataDiff.prototype.getDescriptor=function(){return this._descriptor};wrm.data.meta.MetadataDiff.prototype.getAddedEntities=function(){return this._entities.added};exportProperty(wrm.data.meta.MetadataDiff.prototype,"getAddedEntities",wrm.data.meta.MetadataDiff.prototype.getAddedEntities);
wrm.data.meta.MetadataDiff.prototype.getRemovedEntities=function(){return this._entities.removed};exportProperty(wrm.data.meta.MetadataDiff.prototype,"getRemovedEntities",wrm.data.meta.MetadataDiff.prototype.getRemovedEntities);wrm.data.meta.MetadataDiff.prototype.getChangedEntities=function(){return this._entities.changed};exportProperty(wrm.data.meta.MetadataDiff.prototype,"getChangedEntities",wrm.data.meta.MetadataDiff.prototype.getChangedEntities);
wrm.data.meta.MetadataDiff.prototype.getAddedAssociationsIds=function(){return this._assocs.added};exportProperty(wrm.data.meta.MetadataDiff.prototype,"getAddedAssociationsIds",wrm.data.meta.MetadataDiff.prototype.getAddedAssociationsIds);wrm.data.meta.MetadataDiff.prototype.getRemovedAssociationsIds=function(){return this._assocs.removed};exportProperty(wrm.data.meta.MetadataDiff.prototype,"getRemovedAssociationsIds",wrm.data.meta.MetadataDiff.prototype.getRemovedAssociationsIds);
wrm.data.meta.MetadataDiff.prototype.getReplacedAssociationsIdPairs=function(){return this._assocs.replaced};exportProperty(wrm.data.meta.MetadataDiff.prototype,"getReplacedAssociationsIdPairs",wrm.data.meta.MetadataDiff.prototype.getReplacedAssociationsIdPairs);wrm.data.meta.MetadataComparator=function(){};wrm.data.meta.MetadataComparator.prototype.generateExtended=function(a,b){var c=new wrm.data.meta.MetadataComparator._Context(a,b);this._findMigrationsInMetadata(a,b,c);a=this._computeExtendedMetadataDescr(a,b,c);c=this._createMetadataDiffDescr(c);return{metadata:new wrm.data.meta.Metadata(a),diff:new wrm.data.meta.MetadataDiff(c)}};
wrm.data.meta.MetadataComparator.prototype._findMigrationsInMetadata=function(a,b,c){wrm.data.meta.MetadataComparator._checkMetadataDescr(a);wrm.data.meta.MetadataComparator._checkMetadataDescr(b);this._findMigrations([],a&&a.entities,b&&b.entities,this._findMigrationsInEntity.bind(this),c);this._findMigrations([],a&&a.associations,b&&b.associations,this._findMigrationsInAssociation.bind(this),c)};
wrm.data.meta.MetadataComparator.prototype._findMigrationsInEntity=function(a,b,c,d){var e=wrm.data.meta.MetadataComparator._MigrationType;wrm.data.meta.MetadataComparator._checkEntityDescr(b);wrm.data.meta.MetadataComparator._checkEntityDescr(c);e=b?c?null:e.REMOVAL:e.ADDITION;this._findMigrations([a],b&&b.attributes,c&&c.attributes,this._findMigrationsInAttribute.bind(this),d);this._findMigrations([a],b&&b.roles,c&&c.roles,this._findMigrationsInRole.bind(this),d);null!==e&&(b&&this._markEntityForMigration(a,
b,!0,e,d),c&&this._markEntityForMigration(a,c,!1,e,d))};
wrm.data.meta.MetadataComparator.prototype._findMigrationsInAttribute=function(a,b,c,d){var e=wrm.data.meta.MetadataComparator._MigrationType;wrm.data.meta.MetadataComparator._checkAttributeDescr(b);wrm.data.meta.MetadataComparator._checkAttributeDescr(c);var f=b?c?null:e.REMOVAL:e.ADDITION;null===f&&["type","key","onFileSystem"].forEach(function(a){null===f&&b[a]!==c[a]&&(f=e.CHANGE)},this);null===f&&(b.meta||c.meta)&&function(){var a=this._computeObjectsDiff(b.meta||{},c.meta||{});0<a.added.length||
0<a.removed.length?f=e.CHANGE:a.replaced.forEach(function(a){wrm.data.meta.MetadataComparator._checkMetaAttributeDescr(a.oldDescr);wrm.data.meta.MetadataComparator._checkMetaAttributeDescr(a.newDescr);a.oldDescr.type!==a.newDescr.type&&(f=e.CHANGE)},this)}.call(this);var g=f;null!==g&&(b&&this._markAttributeForMigration(a,b,!0,g,d),c&&this._markAttributeForMigration(a,c,!1,g,d))};
wrm.data.meta.MetadataComparator.prototype._findMigrationsInRole=function(a,b,c,d){var e=wrm.data.meta.MetadataComparator._MigrationType;wrm.data.meta.MetadataComparator._checkRoleDescr(b);wrm.data.meta.MetadataComparator._checkRoleDescr(c);var f=b?c?null:e.REMOVAL:e.ADDITION;null===f&&b.many!==c.many&&(f=e.CHANGE);null!==f&&(b&&this._markRoleForMigration(a,b,!0,f,d),c&&this._markRoleForMigration(a,c,!1,f,d))};
wrm.data.meta.MetadataComparator.prototype._findMigrationsInAssociation=function(a,b,c,d){var e=wrm.data.meta.MetadataComparator._MigrationType;wrm.data.meta.MetadataComparator._checkAssociationDescr(b);wrm.data.meta.MetadataComparator._checkAssociationDescr(c);e=b?c?null:e.REMOVAL:e.ADDITION;null!==e&&(b&&this._markAssociationForMigration(a,b,!0,e,d),c&&this._markAssociationForMigration(a,c,!1,e,d))};
wrm.data.meta.MetadataComparator.prototype._findMigrations=function(a,b,c,d,e){b=this._computeObjectsDiff(b||{},c||{});b.added.forEach(function(b){d(b.id,null,b.descr,e);e.saveDescriptors(a.concat(b.id),null,b.descr)},this);b.replaced.forEach(function(b){d(b.id,b.oldDescr,b.newDescr,e);e.saveDescriptors(a.concat(b.id),b.oldDescr,b.newDescr)},this);b.removed.forEach(function(b){d(b.id,b.descr,null,e);e.saveDescriptors(a.concat(b.id),b.descr,null)},this)};
wrm.data.meta.MetadataComparator.prototype._markEntityForMigration=function(a,b,c,d,e){e.markForMigration([a],d)};wrm.data.meta.MetadataComparator.prototype._markAttributeForMigration=function(a,b,c,d,e){var f=e.getParentEntityId(a,c);e.markForMigration([f,a],d)&&!0===b.key&&(a=e.get(f,c).roles)&&Object.keys(a).forEach(function(a){this._markRoleForMigration(a,e.get(a,c),c,wrm.data.meta.MetadataComparator._MigrationType.CHANGE,e)},this)};
wrm.data.meta.MetadataComparator.prototype._markRoleForMigration=function(a,b,c,d,e){var f=e.getParentEntityId(a,c);e.markForMigration([f,a],d)&&(b=b.inverse,f=e.get(b,c),this._markRoleForMigration(b,f,c,d,e),a=e.getParentAssociationId(a,c),b=e.get(a,c),this._markAssociationForMigration(a,b,c,d,e))};
wrm.data.meta.MetadataComparator.prototype._markAssociationForMigration=function(a,b,c,d,e){e.markForMigration([a],d)&&b.roles.forEach(function(a){var b=e.get(a,c);this._markRoleForMigration(a,b,c,d,e)},this)};
wrm.data.meta.MetadataComparator.prototype._computeObjectsDiff=function(a,b){a=void 0!==a?a:{};b=void 0!==b?b:{};var c={added:[],replaced:[],removed:[]},d={};Object.keys(a).forEach(function(a){d[a]=!0});Object.keys(b).forEach(function(e){!0===d[e]?(c.replaced.push({id:e,oldDescr:a[e],newDescr:b[e]}),delete d[e]):c.added.push({id:e,descr:b[e]})});Object.keys(d).forEach(function(b){c.removed.push({id:b,descr:a[b]})});return c};
wrm.data.meta.MetadataComparator.prototype._computeExtendedMetadataDescr=function(a,b,c){var d;d=b.version-a.version;d=2<=Math.abs(d)?a.version+Math.floor(d/2):Math.min(a.version,b.version)-1;var e=this._computeExtenedObjectMap([],a.entities,b.entities,this._createLeavingEntityDescr.bind(this),this._createEntityDescr.bind(this),c);a=this._computeExtenedObjectMap([],a.associations,b.associations,this._createLeavingAssociationDescr.bind(this),this._createAssociationDescr.bind(this),c);a={version:d,
entities:e,associations:a};this._disambiguateNamesInMetadata(a);return a};wrm.data.meta.MetadataComparator.prototype._createLeavingEntityDescr=function(a,b,c){var d=wrm.util.obj.copyProperties({},b,["name","setName"]);d.attributes=this._computeExtenedObjectMap([a],b.attributes,null,this._createLeavingAttributeDescr.bind(this),this._createAttributeDescr.bind(this),c);d.roles=this._computeExtenedObjectMap([a],b.roles,null,this._createLeavingRoleDescr.bind(this),this._createRoleDescr.bind(this),c);return d};
wrm.data.meta.MetadataComparator.prototype._createEntityDescr=function(a,b,c,d){var e=wrm.util.obj.copyProperties({},c,"name setName serverName serverReadable disableDataRestore auxEntity dirtyName deleteTimestampName".split(" "));e.attributes=this._computeExtenedObjectMap([a],b&&b.attributes,c.attributes,this._createLeavingAttributeDescr.bind(this),this._createAttributeDescr.bind(this),d);e.roles=this._computeExtenedObjectMap([a],b&&b.roles,c.roles,this._createLeavingRoleDescr.bind(this),this._createRoleDescr.bind(this),
d);this._disambiguateNamesInEntity(e);return e};wrm.data.meta.MetadataComparator.prototype._createLeavingAttributeDescr=function(a,b,c){var d=wrm.data.meta.MetadataComparator._MigrationType,e=wrm.util.obj.copyProperties({},b,["name","type","indexed","onFileSystem","meta"]),f=c.getParentEntityId(a,!0),g=c.getDelta([f]).migration;a=c.getDelta([f,a]).migration;g===a&&g===d.REMOVAL&&(e.key=b.key);return e};
wrm.data.meta.MetadataComparator.prototype._createAttributeDescr=function(a,b,c,d){return wrm.util.obj.copyProperties({},c,"name type key indexed createTS updateTS onFileSystem meta serverName trackerName dirtyName serverKey".split(" "))};wrm.data.meta.MetadataComparator.prototype._createLeavingRoleDescr=function(a,b,c){a=wrm.util.obj.copyProperties({},b,["name","foreignKeyName","many","bridgeHeadRole"]);a.inverse=this._computeLeavingId(b.inverse);return a};
wrm.data.meta.MetadataComparator.prototype._createRoleDescr=function(a,b,c,d){return wrm.util.obj.copyProperties({},c,"name foreignKeyName many inverse bridgeHeadRole serverName serverTrackerName addTimestampName removeTimestampName".split(" "))};wrm.data.meta.MetadataComparator.prototype._createLeavingAssociationDescr=function(a,b,c){a=wrm.util.obj.copyProperties({},b,["name","bridgeEntity"]);a.roles=b.roles.map(this._computeLeavingId.bind(this));return a};
wrm.data.meta.MetadataComparator.prototype._createAssociationDescr=function(a,b,c,d){return wrm.util.obj.copyProperties({},c,["name","roles","bridgeEntity","serverName"])};
wrm.data.meta.MetadataComparator.prototype._computeExtenedObjectMap=function(a,b,c,d,e,f){function g(b){if(!0!==l[b]){l[b]=!0;var c=f.getDelta(a.concat(b));null!==c.migration?(c.oldDescr&&c.migration!==h.ADDITION&&this._putLeavingDescriptor(k,b,d(b,c.oldDescr,f)),c.newDescr&&c.migration!==h.REMOVAL&&this._putArrivingDescriptor(k,b,e(b,c.oldDescr,c.newDescr,f))):c.newDescr&&(k[b]=e(b,c.oldDescr,c.newDescr,f))}}var h=wrm.data.meta.MetadataComparator._MigrationType,k={},l={};b&&Object.keys(b).forEach(g,
this);c&&Object.keys(c).forEach(g,this);return k};wrm.data.meta.MetadataComparator.prototype._putLeavingDescriptor=function(a,b,c){c.migrationTempId=b;c.migrationWay=wrm.data.meta.MigrationWay.LEAVING;a[this._computeLeavingId(b)]=c};wrm.data.meta.MetadataComparator.prototype._putArrivingDescriptor=function(a,b,c){c.migrationTempId=this._computeArrivingId(b);c.migrationWay=wrm.data.meta.MigrationWay.ARRIVING;a[b]=c};
wrm.data.meta.MetadataComparator.prototype._computeLeavingId=function(a){return a+"@old"};wrm.data.meta.MetadataComparator.prototype._computeArrivingId=function(a){return a+"@new"};
wrm.data.meta.MetadataComparator.prototype._disambiguateNamesInMetadata=function(a){var b={},c={},d=[];this._doCollectNameUsage(a.entities,"entity","name",b,d);this._doCollectNameUsage(a.entities,"entity","setName",c,null);d.forEach(function(a){var d=a.name,e=a.setName;if(!0===b[d]||!0===c[e])a.name=d+"_OLD",a.setName=e+"_OLD"},this);var e={},d=[];this._doCollectNameUsage(a.associations,"association","name",e,d);d.forEach(function(a){var b=a.name;!0===e[b]&&(a.name=b+"_OLD")},this)};
wrm.data.meta.MetadataComparator.prototype._disambiguateNamesInEntity=function(a){var b={},c=[];this._doCollectNameUsage(a.attributes,"attribute","name",b,c);this._doCollectNameUsage(a.roles,"attribute/role","name",b,c);c.forEach(function(a){var c=a.name;!0===b[c]&&(a.name=c+"_OLD")},this)};
wrm.data.meta.MetadataComparator.prototype._doCollectNameUsage=function(a,b,c,d,e){var f=wrm.data.meta.MigrationWay;Object.keys(a).forEach(function(g){g=a[g];var h=g[c];switch(this._getMigrationWay(g)){case f.ARRIVING:case f.STAYING:if(d[h])throw Error("Found conflicting "+b+" name '"+h+"'");d[h]=!0;break;default:e&&e.push(g)}},this)};wrm.data.meta.MetadataComparator.prototype._getMigrationWay=function(a){return a.migrationWay||wrm.data.meta.MigrationWay.STAYING};
wrm.data.meta.MetadataComparator._checkMetadataDescr=function(a){DEBUG&&wrm.data.meta.MetadataComparator._checkDescrKnownKeys(a,"metadata",["version","entities","associations"])};wrm.data.meta.MetadataComparator._checkEntityDescr=function(a){DEBUG&&wrm.data.meta.MetadataComparator._checkDescrKnownKeys(a,"entity","name setName serverName serverReadable disableDataRestore auxEntity dirtyName deleteTimestampName attributes roles".split(" "))};
wrm.data.meta.MetadataComparator._checkAttributeDescr=function(a){DEBUG&&wrm.data.meta.MetadataComparator._checkDescrKnownKeys(a,"attribute","name type key createTS updateTS onFileSystem meta serverName trackerName dirtyName serverKey indexed".split(" "))};wrm.data.meta.MetadataComparator._checkMetaAttributeDescr=function(a){DEBUG&&wrm.data.meta.MetadataComparator._checkDescrKnownKeys(a,"meta-attribute",["name","type"])};
wrm.data.meta.MetadataComparator._checkRoleDescr=function(a){DEBUG&&wrm.data.meta.MetadataComparator._checkDescrKnownKeys(a,"role","name foreignKeyName many inverse bridgeHeadRole serverName serverTrackerName addTimestampName removeTimestampName".split(" "))};wrm.data.meta.MetadataComparator._checkAssociationDescr=function(a){DEBUG&&wrm.data.meta.MetadataComparator._checkDescrKnownKeys(a,"association",["name","roles","bridgeEntity","serverName"])};
wrm.data.meta.MetadataComparator._checkDescrKnownKeys=function(a,b,c){if(DEBUG&&null!==a){var d={};c.forEach(function(a){d[a]=!0});Object.keys(a).forEach(function(a){if(!0!==d[a])throw Error("Unknown object key in "+b+" descriptor: "+a);})}};
wrm.data.meta.MetadataComparator.prototype._createMetadataDiffDescr=function(a){function b(a){a=a.join("/");return!0===l[a]?!1:l[a]=!0}function c(a,b,c){switch(c){case h.ADDITION:a=a.added||(a.added=[]);a.push(b);break;case h.REMOVAL:a=a.removed||(a.removed=[]);a.push(k(b));break;case h.CHANGE:a=a.replaced||(a.replaced=[]),a.push({older:k(b),newer:b})}}function d(d,e){d=a.getParentEntityId(e,d);var f=[d,e];if(b(f)&&(f=a.getDelta(f).migration,null!==f)){var g=m[d];g||(m[d]=g={attributes:{},roles:{}});
c(g.attributes,e,f)}}function e(d,e){d=a.getParentEntityId(e,d);var f=[d,e];if(b(f)&&(f=a.getDelta(f).migration,null!==f)){var g=m[d];g||(m[d]=g={attributes:{},roles:{}});c(g.roles,e,f)}}function f(d){var e=[d];b(e)&&(e=a.getDelta(e).migration,null!==e&&c(n,d,e))}function g(c){var d=[c];if(b(d)){var e=a.getDelta(d).migration,d=m[c];if(null!==e||d)e===h.ADDITION?e=p.added||(p.added=[]):e===h.REMOVAL?(e=p.removed||(p.removed=[]),c=k(c)):e=p.changed||(p.changed=[]),e.push({id:c,attributes:d&&d.attributes,
roles:d&&d.roles})}}var h=wrm.data.meta.MetadataComparator._MigrationType,k=this._computeLeavingId.bind(this),l={},m={};a.getAttributeIds(!1).forEach(d.bind(null,!1));a.getAttributeIds(!0).forEach(d.bind(null,!0));a.getRoleIds(!1).forEach(e.bind(null,!1));a.getRoleIds(!0).forEach(e.bind(null,!0));var n={};a.getAssociationIds(!1).forEach(f);a.getAssociationIds(!0).forEach(f);var p={};a.getEntityIds(!1).forEach(g);a.getEntityIds(!0).forEach(g);return{entities:p,associations:n}};
wrm.data.meta.MetadataComparator._Context=function(a,b){this._older=wrm.data.meta.MetadataComparator._Context._createMaps(a);this._newer=wrm.data.meta.MetadataComparator._Context._createMaps(b);this._deltas={}};
wrm.data.meta.MetadataComparator._Context._createMaps=function(a){var b={ids:{entity:{},association:{},attribute:{},role:{}},descrsById:{},entityIdByPropertyId:{},assocIdByRoleId:{}},c=a.entities||{},d=a.associations||{};Object.keys(c).forEach(function(a){var d=c[a];b.descrsById[a]=d;b.ids.entity[a]=!0;var g=d.attributes||{};Object.keys(g).forEach(function(c){b.descrsById[c]=g[c];b.entityIdByPropertyId[c]=a;b.ids.attribute[c]=!0});var h=d.roles||{};Object.keys(h).forEach(function(c){b.descrsById[c]=
h[c];b.entityIdByPropertyId[c]=a;b.ids.role[c]=!0})});Object.keys(d).forEach(function(a){var c=d[a];b.descrsById[a]=c;b.ids.association[a]=!0;c.roles.forEach(function(c){b.assocIdByRoleId[c]=a;b.ids.role[c]=!0})});return b};wrm.data.meta.MetadataComparator._Context.prototype.get=function(a,b){return this._doGetDescr(b?this._older:this._newer,a)};wrm.data.meta.MetadataComparator._Context.prototype.getEntityIds=function(a){return Object.keys((a?this._older:this._newer).ids.entity)};
wrm.data.meta.MetadataComparator._Context.prototype.getAssociationIds=function(a){return Object.keys((a?this._older:this._newer).ids.association)};wrm.data.meta.MetadataComparator._Context.prototype.getAttributeIds=function(a){return Object.keys((a?this._older:this._newer).ids.attribute)};wrm.data.meta.MetadataComparator._Context.prototype.getRoleIds=function(a){return Object.keys((a?this._older:this._newer).ids.role)};
wrm.data.meta.MetadataComparator._Context.prototype.getParentEntityId=function(a,b){b=(b?this._older:this._newer).entityIdByPropertyId[a];if(!b)throw Error("Unknown parent entity of property '"+a+"'");return b};wrm.data.meta.MetadataComparator._Context.prototype.getParentAssociationId=function(a,b){b=(b?this._older:this._newer).assocIdByRoleId[a];if(!b)throw Error("Unknown parent association of role '"+a+"'");return b};
wrm.data.meta.MetadataComparator._Context.prototype._doGetDescr=function(a,b){a=a.descrsById[b];if(!a)throw Error("Unknown element '"+b+"'");return a};wrm.data.meta.MetadataComparator._Context.prototype.getDelta=function(a){a=a.join("/");var b=this._deltas[a];if(!b)throw Error("No delta available for '"+a+"'");if(void 0===b.oldDescr||void 0===b.newDescr)throw Error("No delta available for '"+a+"'");return b};
wrm.data.meta.MetadataComparator._Context.prototype.saveDescriptors=function(a,b,c){a=this._getOrCreateDelta(a);if(void 0!==a.oldDescr||void 0!==a.newDescr)throw Error("Delta descriptors already saved");a.oldDescr=b;a.newDescr=c};
wrm.data.meta.MetadataComparator._Context.prototype.markForMigration=function(a,b){var c=wrm.data.meta.MetadataComparator._MigrationType;a=this._getOrCreateDelta(a);if(a.migration===c.ADDITION&&b==c.REMOVAL||a.migration===c.REMOVAL&&b==c.ADDITION)throw Error("Incompatible migration type");if(null!==a.migration&&b===c.CHANGE)return!1;c=a.migration!==b;a.migration=b;return c};
wrm.data.meta.MetadataComparator._Context.prototype._getOrCreateDelta=function(a){a=a.join("/");var b=this._deltas[a];b||(b={oldDescr:void 0,newDescr:void 0,migration:null},this._deltas[a]=b);return b};wrm.data.meta.MetadataComparator._MigrationType={REMOVAL:-1,CHANGE:0,ADDITION:1};wrm.data.DatabaseHandler=function(a,b,c,d){wrm.core.AbstractUpdateParticipant.call(this);this._concreteDbName=a;this._currentMetadata=b;this._currentMigrationWay=null;this._stable=!1;this._unstableUseHandler=wrm.data.DatabaseHandler.DEFAULT_UNSTABLE_USE_HANDLER;this._stabilityListeners=[];this._platform=c;this._log=d;this._auxDictionary=c.retrieveDictionary(this._concreteDbName);this._db=this._migrationHandler=null};extendConstructor(wrm.data.DatabaseHandler,wrm.core.AbstractUpdateParticipant);
wrm.data.DatabaseHandler.prototype.getConcreteDatabaseName=function(a){return this._checkStable(a,this._concreteDbName)};wrm.data.DatabaseHandler.prototype.getMetadata=function(a){return this._checkStable(a,this._currentMetadata)};wrm.data.DatabaseHandler.prototype.getDatabase=function(a){return this._checkStable(a,this._doGetDatabase())};wrm.data.DatabaseHandler.prototype._doGetDatabase=function(){this._db||(this._db=this._createDatabase());return this._db};
wrm.data.DatabaseHandler.prototype.getAuxiliaryDictionary=function(){return this._auxDictionary};wrm.data.DatabaseHandler.prototype._checkStable=function(a,b){this._stable||this._unstableUseHandler(a);return b};wrm.data.DatabaseHandler.DEFAULT_UNSTABLE_USE_HANDLER=function(a){throw Error("The database is still unstable");};wrm.data.DatabaseHandler.prototype.setUnstableUseHandler=function(a){this._unstableUseHandler=a||wrm.data.DatabaseHandler.DEFAULT_UNSTABLE_USE_HANDLER};
wrm.data.DatabaseHandler.prototype.addStabilityListener=function(a){a(this._stable);this._stable||this._stabilityListeners.push(a)};wrm.data.DatabaseHandler.prototype._handleChangedStability=function(){this._db=null;for(var a=0;a<this._stabilityListeners.length;a++)(0,this._stabilityListeners[a])(this._stable),this._stable&&this._stabilityListeners.splice(a--,1)};wrm.data.DatabaseHandler.prototype.setMigrationHandler=function(a){this._migrationHandler=a};
wrm.data.DatabaseHandler.prototype.beginUpdate=function(a){var b=wrm.data.DatabaseHandler,c=wrm.data.DatabaseHandler._ORIG_MD_SNAPSHOT_KEY,d=wrm.data.DatabaseHandler._EXT_MD_SNAPSHOT_KEY_PREFIX,e=wrm.data.meta.MigrationWay,f=this._log,g=a.getStableSnapshot(),h=a.getUpdateSnapshot(),k=this._transferLegacySnapshot(g,h),l=b._readMetadata(g,c)||wrm.data.meta.Metadata.EMPTY,m=b._readMetadataMap(h,d),c=this._currentMetadata;if(l.getVersion()===c.getVersion())f.debug("No database upgrade is needed"),a.setInfo(new wrm.data.DataServiceUpdateState(null,
{},null,null,c));else return f.info("Database upgrade started"),f=(new wrm.data.meta.MetadataComparator).generateExtended(l.getDescriptor(),c.getDescriptor()),a.setInfo(new wrm.data.DataServiceUpdateState(l,m,f.metadata,f.diff,c)),Promise.resolve().then(function(){if(null!==k)return this._bumpVersionFromEmpty(k)}.bind(this)).then(function(){this._currentMetadata=b._findNewestMetadata(m)||l;this._currentMigrationWay=this._currentMetadata!==l?e.ARRIVING:null;this._handleChangedStability()}.bind(this))};
wrm.data.DatabaseHandler.prototype.performExtensionUpdate=function(a){var b=wrm.data.DatabaseHandler,c=wrm.data.DatabaseHandler._EXT_MD_SNAPSHOT_KEY_PREFIX,d=wrm.data.meta.MigrationWay,e=a.getInfo();if(e.isUpdating()){var f=b._mergeMetadataMaps(e.getPastExtendedMetadata(),e.getOriginalMetadata()),g=e.getExtendedMetadata();return this._performUpdateStep("Extension:",f,g,d.ARRIVING).then(function(){var f=a.getUpdateSnapshot(),k=b._mergeMetadataMaps(e.getPastExtendedMetadata(),g);b._writeMetadataMap(f,
c,k);this._currentMetadata=g;this._currentMigrationWay=d.LEAVING;this._handleChangedStability()}.bind(this))}};wrm.data.DatabaseHandler.prototype.performCoreUpdate=function(a){a=a.getInfo();if(a.isUpdating()&&this._migrationHandler)return this._migrationHandler(a.getExtendedMetadataDiff())};
wrm.data.DatabaseHandler.prototype.performReductionUpdate=function(a){var b=wrm.data.DatabaseHandler,c=wrm.data.meta.MigrationWay;a=a.getInfo();if(a.isUpdating()){var b=b._mergeMetadataMaps({},a.getExtendedMetadata()),d=a.getCurrentMetadata();return this._performUpdateStep("Reduction:",b,d,c.LEAVING).then(function(){this._currentMetadata=d;this._currentMigrationWay=null;this._handleChangedStability()}.bind(this))}};
wrm.data.DatabaseHandler.prototype.finishUpdate=function(a){var b=wrm.data.DatabaseHandler,c=wrm.data.DatabaseHandler._ORIG_MD_SNAPSHOT_KEY,d=a.getInfo();d.isUpdating()&&(a=a.getStableSnapshot(),b._writeMetadata(a,c,d.getCurrentMetadata()),this._log.info("Database upgrade finished"));this._stable=!0;this._handleChangedStability();return d.isUpdating()};
wrm.data.DatabaseHandler.prototype._bumpVersionFromEmpty=function(a){this._log.debug("Bumping database version to",a);return xdata.createDatabase("websql",{},a,{}).upgradeVersion(this._concreteDbName,function(a){throw Error("Bumping non-empty version");})};
wrm.data.DatabaseHandler.prototype._performUpdateStep=function(a,b,c,d){var e=this._log,f=this._newMetadataRegistry(c);Object.keys(b).forEach(function(a){f.register(b[Number(a)],!0)});var g=this._createDatabase(c,d),h=c.getVersion();f.getDatabaseVersion(h)<g.getVersion()&&(f.initDatabaseVersion(h,g.getVersion()+1),g=this._createDatabase(c,d));e.debug(a,"upgrading to version",g.getVersion(),"with metadata",h);return g.upgradeVersion(this._concreteDbName,function(b){e.debug(a,"previous version was",
b);var c=f.retrieveByDatabaseVersion(b);return(new wrm.data.XDMetadata(c,d,b)).getSchema()}).then(function(){e.debug(a,"done")})};wrm.data.DatabaseHandler._mergeMetadataMaps=function(a,b){a=wrm.util.obj.copyProperties({},a);a[b.getVersion()]=b;return a};wrm.data.DatabaseHandler._findNewestMetadata=function(a){var b=-1;Object.keys(a).forEach(function(a){a=Number(a);a>b&&(b=a)});return-1<b?a[b]:null};wrm.data.DatabaseHandler._ORIG_MD_SNAPSHOT_KEY="metadata";
wrm.data.DatabaseHandler._EXT_MD_SNAPSHOT_KEY_PREFIX="extendedMetadata.";
wrm.data.DatabaseHandler.prototype._transferLegacySnapshot=function(a,b){var c=wrm.data.DatabaseHandler._ORIG_MD_SNAPSHOT_KEY,d=wrm.data.DatabaseHandler,e=d._readMetadata(this._auxDictionary,"metadata",0);e||(e=d._readMetadata(b,"legacyMetadata",0));if(e){if(d._readMetadata(a,c))throw Error("Conflict between legacy and new saved metadata");d._writeMetadata(b,"legacyMetadata",e);d._writeMetadata(a,c,e);this._auxDictionary.remove("metadata");return 0}return null};
wrm.data.DatabaseHandler._readMetadataMap=function(a,b){var c=wrm.data.DatabaseHandler,d={};a.getKeys().forEach(function(e){if(0===e.indexOf(b)){var f=Number(e.substring(b.length));e=c._readMetadata(a,e);if(e.getVersion()!==f)throw Error("Mismatching stored metadata version "+f);d[f]=e}});return d};wrm.data.DatabaseHandler._readMetadata=function(a,b,c){a=a.get(b);if(!a)return null;a=JSON.parse(a);void 0===a.version&&void 0!==c&&(a.version=c);return new wrm.data.meta.Metadata(a)};
wrm.data.DatabaseHandler._writeMetadataMap=function(a,b,c){var d=wrm.data.DatabaseHandler;a.getKeys().forEach(function(c){0===c.indexOf(b)&&a.remove(c)});Object.keys(c).forEach(function(e){e=Number(e);var f=c[e];if(f.getVersion()!==e)throw Error("Unmatching metadata version "+e);d._writeMetadata(a,b+e,f)})};wrm.data.DatabaseHandler._writeMetadata=function(a,b,c){c=c.getDescriptor();c=JSON.stringify(c);a.set(b,c)};
wrm.data.DatabaseHandler.prototype._createDatabase=function(a,b){var c=wrm.data.DatabaseHandler;a=a||this._currentMetadata;b=null!==b&&void 0!==b?b:this._currentMigrationWay;var d=this._newMetadataRegistry(this._currentMetadata).getDatabaseVersion(a.getVersion());a=new wrm.data.XDMetadata(a,b,d);var c=xdata.createDatabase(c._PROVIDER_NAME,c._PROVIDER_CONFIG,a.getVersion(),a.getSchema()),e=this._platform.createLog("database","["+this._concreteDbName+"]");e.isDebugEnabled()&&c.addListener(new function(){this.begunTransaction=
function(a){e.debug("Transaction begun",a.readOnly?"(read)":"(read/write)")};this.resolvedTransaction=function(a){e.debug("Transaction "+(a.committed?"committed":"rolled back"))};this.executingCommand=function(a){e.debug("Command",a.command,a.commandParameters)};this.executedCommand=function(a){}});return c};wrm.data.DatabaseHandler._PROVIDER_NAME="websql";wrm.data.DatabaseHandler._PROVIDER_CONFIG={};
wrm.data.DatabaseHandler.prototype._newMetadataRegistry=function(a){var b=new wrm.data.MetadataRegistry(this._auxDictionary);a&&b.register(a);return b};wrm.data.DefaultQueryFactory=function(a){this._metadata=a};exportSymbol("wrm.data.DefaultQueryFactory",wrm.data.DefaultQueryFactory);wrm.data.DefaultQueryFactory.prototype.prepareSelect=function(a,b){return new wrm.data.XEntitySelectQuery(this._metadata,a,b)};exportProperty(wrm.data.DefaultQueryFactory.prototype,"prepareSelect",wrm.data.DefaultQueryFactory.prototype.prepareSelect);
wrm.data.DefaultQueryFactory.prototype.prepareOldSelect=function(a,b){return new wrm.data.JSelectQuery(this._metadata,a,b)};exportProperty(wrm.data.DefaultQueryFactory.prototype,"prepareOldSelect",wrm.data.DefaultQueryFactory.prototype.prepareOldSelect);wrm.data.DefaultQueryFactory.prototype.prepareInsert=function(a,b){return new wrm.data.InsertQuery(this._metadata,a,b)};exportProperty(wrm.data.DefaultQueryFactory.prototype,"prepareInsert",wrm.data.DefaultQueryFactory.prototype.prepareInsert);
wrm.data.DefaultQueryFactory.prototype.prepareUpdate=function(a,b){return new wrm.data.UpdateQuery(this._metadata,a,b)};exportProperty(wrm.data.DefaultQueryFactory.prototype,"prepareUpdate",wrm.data.DefaultQueryFactory.prototype.prepareUpdate);wrm.data.DefaultQueryFactory.prototype.prepareDelete=function(a,b){return new wrm.data.XEntityDeleteQuery(this._metadata,a,b)};exportProperty(wrm.data.DefaultQueryFactory.prototype,"prepareDelete",wrm.data.DefaultQueryFactory.prototype.prepareDelete);
wrm.data.DefaultQueryFactory.prototype.prepareOldDelete=function(a,b){return new wrm.data.JDeleteQuery(this._metadata,a,b)};exportProperty(wrm.data.DefaultQueryFactory.prototype,"prepareOldDelete",wrm.data.DefaultQueryFactory.prototype.prepareOldDelete);wrm.data.DefaultQueryFactory.prototype.prepareCondition=function(a,b){return new wrm.data.Condition(this._metadata,a,b)};exportProperty(wrm.data.DefaultQueryFactory.prototype,"prepareCondition",wrm.data.DefaultQueryFactory.prototype.prepareCondition);wrm.data.JDAtomOperators={};wrm.data.JDAtomOperators._UNARY_OPERATORS={e:{fragmentTemplate:"$0 \x3d\x3d ''",evaluate:function(a,b,c){return""===String(a)}},"!e":{fragmentTemplate:"$0 !\x3d ''",evaluate:function(a,b,c){return""!==String(a)}},n:{fragmentTemplate:"$0 \x3d\x3d null",evaluate:function(a,b,c){return null===a}},"!n":{fragmentTemplate:"$0 !\x3d null",evaluate:function(a,b,c){return null!==a}}};
wrm.data.JDAtomOperators._BINARY_OPERATORS={"in":{fragmentTemplate:"$0 in $1",arrayTest:!0,evaluate:function(a,b,c){return 0<=b.indexOf(a)}},"!in":{fragmentTemplate:"!($0 in $1)",arrayTest:!0,evaluate:function(a,b,c){return 0>b.indexOf(a)}},eq:{fragmentTemplate:"$0 \x3d\x3d\x3d $1",evaluate:function(a,b,c){return wrm.data.equal(a,b)}},"eq[or]":{fragmentTemplate:"$0 in $1",arrayTest:!0,evaluate:function(a,b,c){for(c=0;c<b.length;c++)if(wrm.data.equal(a,b[c]))return!0;return!1}},"eq.ic":{fragmentTemplate:"$0 \x3d\x3d\x3d $1",
mapExpression:".toLowerCase()",evaluate:function(a,b,c){a=String(a).toLowerCase();b=String(b).toLowerCase();return a===b}},"eq.ic[or]":{fragmentTemplate:"$0.toLowerCase() in $1",arrayTest:!0,prepareRightValue:function(a){return a.map(function(a){return String(a).toLowerCase()})},evaluate:function(a,b,c){a=String(a).toLowerCase();return 0<=b.indexOf(a)}},"!eq":{fragmentTemplate:"$0 !\x3d\x3d $1",evaluate:function(a,b,c){return!wrm.data.equal(a,b)}},"!eq[and]":{fragmentTemplate:"!($0 in $1)",arrayTest:!0,
evaluate:function(a,b,c){for(c=0;c<b.length;c++)if(wrm.data.equal(a,b[c]))return!1;return!0}},"!eq.ic":{fragmentTemplate:"$0 !\x3d\x3d $1",mapExpression:".toLowerCase()",evaluate:function(a,b,c){a=String(a).toLowerCase();b=String(b).toLowerCase();return a!==b}},"!eq.ic[and]":{fragmentTemplate:"!($0.toLowerCase() in $1)",arrayTest:!0,prepareRightValue:function(a){return a.map(function(a){return String(a).toLowerCase()})},evaluate:function(a,b,c){a=String(a).toLowerCase();return 0>b.indexOf(a)}},gt:{fragmentTemplate:"$0 \x3e $1",
evaluate:function(a,b,c){return 0<wrm.data.compare(a,b)}},gte:{fragmentTemplate:"$0 \x3e\x3d $1",evaluate:function(a,b,c){return 0<=wrm.data.compare(a,b)}},lt:{fragmentTemplate:"$0 \x3c $1",evaluate:function(a,b,c){return 0>wrm.data.compare(a,b)}},lte:{fragmentTemplate:"$0 \x3c\x3d $1",evaluate:function(a,b,c){return 0>=wrm.data.compare(a,b)}},bw:{fragmentTemplate:"$0.startsWith($1)",evaluate:function(a,b,c){a=String(a);b=String(b);return a.slice(0,b.length)===b}},co:{fragmentTemplate:"$0.contains($1)",
evaluate:function(a,b,c){a=String(a);b=String(b);return 0<=a.indexOf(b)}},ew:{fragmentTemplate:"$0.endsWith($1)",evaluate:function(a,b,c){a=String(a);b=String(b);return a.slice(-b.length)===b}},"bw.ic":{fragmentTemplate:"$0.startsWith($1)",mapExpression:".toLowerCase()",evaluate:function(a,b,c){a=String(a).toLowerCase();b=String(b).toLowerCase();return a.slice(0,b.length)===b}},"co.ic":{fragmentTemplate:"$0.contains($1)",mapExpression:".toLowerCase()",evaluate:function(a,b,c){a=String(a).toLowerCase();
b=String(b).toLowerCase();return 0<=a.indexOf(b)}},"ew.ic":{fragmentTemplate:"$0.endsWith($1)",mapExpression:".toLowerCase()",evaluate:function(a,b,c){a=String(a).toLowerCase();b=String(b).toLowerCase();return a.slice(-b.length)===b}},"!bw":{fragmentTemplate:"!$0.startsWith($1)",evaluate:function(a,b,c){a=String(a);b=String(b);return a.slice(0,b.length)!==b}},"!co":{fragmentTemplate:"!$0.contains($1)",evaluate:function(a,b,c){a=String(a);b=String(b);return 0>a.indexOf(b)}},"!ew":{fragmentTemplate:"!$0.endsWith($1)",
evaluate:function(a,b,c){a=String(a);b=String(b);return a.slice(-b.length)!==b}},"!bw.ic":{fragmentTemplate:"!$0.startsWith($1)",mapExpression:".toLowerCase()",evaluate:function(a,b,c){a=String(a).toLowerCase();b=String(b).toLowerCase();return a.slice(0,b.length)!==b}},"!co.ic":{fragmentTemplate:"!$0.contains($1)",mapExpression:".toLowerCase()",evaluate:function(a,b,c){a=String(a).toLowerCase();b=String(b).toLowerCase();return 0>a.indexOf(b)}},"!ew.ic":{fragmentTemplate:"!$0.endsWith($1)",mapExpression:".toLowerCase()",
evaluate:function(a,b,c){a=String(a).toLowerCase();b=String(b).toLowerCase();return a.slice(-b.length)!==b}}};wrm.data.JDAtomOperators._registerUnaryOperator=function(a){wrm.data.JDAtomOperators._doAugmentOperators(a);wrm.data.ConditionNodes.registerUnaryAtomOperators(a)};wrm.data.JDAtomOperators._registerBinaryOperator=function(a){wrm.data.JDAtomOperators._doAugmentOperators(a);wrm.data.ConditionNodes.registerBinaryAtomOperators(a)};
wrm.data.JDAtomOperators._doAugmentOperators=function(a){Object.keys(a).forEach(function(b){b=a[b];var c=b.isEvaluateRequired;b.isEvaluateRequired=function(a){return c&&c(a)?!0:wrm.data.JDPropertyEvaluator.isEvaluationRequired(a)}})};wrm.data.JDAtomOperators._registerUnaryOperator(wrm.data.JDAtomOperators._UNARY_OPERATORS);wrm.data.JDAtomOperators._registerBinaryOperator(wrm.data.JDAtomOperators._BINARY_OPERATORS);wrm.data.JDCompoundOperators={};wrm.data.ConditionNodes.registerUnaryCompoundOperators({not:{predicatePrefix:"!",propagateVerity:function(a){return!a},evaluate:function(a,b,c){return a[0](b,c).then(function(a){return!a})}}});
wrm.data.ConditionNodes.registerBinaryCompoundOperators({and:{predicateInfix:" \x26\x26 ",evaluate:function(a,b,c){return a.reduce(function(a,e){return a.then(function(a){return!1===a?a:e(b,c)}).then(function(a){return!1===a?!1:null})},Promise.resolve()).then(function(a){return!1===a?!1:!0})}},or:{predicateInfix:" || ",evaluate:function(a,b,c){return a.reduce(function(a,e){return a.then(function(a){return!0===a?a:e(b,c)}).then(function(a){return!0===a?!0:null})},Promise.resolve()).then(function(a){return!0===
a?!0:!1})}}});wrm.data.JDDataConverters={};wrm.data.JDDataConverters["$data.Blob"]={"$data.Object":function(a){if(a instanceof Uint8Array)return a;throw Error("Invalid blob object: "+a);}};wrm.data.JDDataConverters["$data.Date"]={"$data.Object":function(a){if(a instanceof wrm.data.Date||a instanceof wrm.data.DateTime)return a.asDate();throw Error("Invalid date object: "+a);}};
wrm.data.JDDataConverters["$data.Time"]={"$data.Object":function(a){if(a instanceof wrm.data.Time)return a.toString();throw Error("Invalid time object: "+a);}};wrm.data.JDDataConverters["$data.Decimal"]={"$data.Object":function(a){if(a instanceof wrm.data.Decimal)return a.toString();throw Error("Invalid decimal object: "+a);}};wrm.data.JDDataConverters["$data.Float"]={"default":function(a){a=+a;if(isNaN(a))throw 0;return a}};
angular.forEach(wrm.data.JDDataConverters,function(a,b){$data.Container.registerConverter(b,a)});wrm.data.JDPropertyEvaluator=function(a,b,c,d){var e=b.getProperty();if(!(e instanceof wrm.data.meta.Attribute))throw Error("The referenced property must be an attribute");this._evaluateFn=a;this._roles=b.getRoles();this._attribute=e;this._rightValue=c;this._rightValueArrayConj=d};wrm.data.JDPropertyEvaluator.prototype.evaluate=function(a,b){return this._doEvaluate(a,this._roles,this._attribute,b)};
wrm.data.JDPropertyEvaluator.prototype._doEvaluate=function(a,b,c,d){var e=this;return 0<b.length?wrm.data.JDPropertyFiller.retrieveRoleValues(a,b,d).then(function(a){var g=b.slice(1);return a.reduce(function(a,b){return a.then(function(a){return a?a:e._doEvaluate(b,g,c,d)})},Promise.resolve(!1))}):this._doEvaluateAttribute(a,c,d)};
wrm.data.JDPropertyEvaluator.prototype._doEvaluateAttribute=function(a,b,c){var d=this._adaptAndEvaluate.bind(this),e=a[b.getName()],f=this._rightValue;if(null!==this._rightValueArrayConj&&f&&angular.isArray(f)){var g=!this._rightValueArrayConj;return f.reduce(function(a,b){return a.then(function(a){return a===g?a:d(e,b,c)}).then(function(a){return a===g?g:null})},Promise.resolve()).then(function(a){return a===g?g:!g})}return Promise.resolve().then(function(){return d(e,f,c)})};
wrm.data.JDPropertyEvaluator.prototype._adaptAndEvaluate=function(a,b,c){var d=this._attribute.getType();a=Array.isArray(a)?wrm.data.toArray(d,a):wrm.data.toSingle(d,a);b=Array.isArray(b)?wrm.data.toArray(d,b):wrm.data.toSingle(d,b);return this._evaluateFn(a,b,c)};wrm.data.JDPropertyEvaluator.isEvaluationRequired=function(a){return a.getProperty()instanceof wrm.data.meta.Attribute?wrm.data.JDPropertyFiller.isFillingRequired(a):!1};wrm.data.meta.BridgeEntity=function(a,b,c,d,e){wrm.data.meta.Entity.call(this,a,b,e);this._auxEntity=this._createAuxEntity(b.auxEntity||null);this._addTimestampAttriubte=this._createAddTimestampAttribute(b.addTimestampName||null,this._auxEntity);this._removeTimestampAttriubte=this._createRemoveTimestampAttribute(b.removeTimestampName||null,this._auxEntity);this.createAttributes(b.attributes||{},null);a=b.bridgeRoles||[];c=this._createBridgeRole(a[0],c,this._auxEntity);d=this._createBridgeRole(a[1],
d,this._auxEntity);this._role1=c;this._role2=d;e.registerEntity(this)};extendConstructor(wrm.data.meta.BridgeEntity,wrm.data.meta.Entity);exportSymbol("wrm.data.meta.BridgeEntity",wrm.data.meta.BridgeEntity);wrm.data.meta.BridgeEntity.prototype._createAuxEntity=function(a){return a?new wrm.data.meta.AuxEntity("_aux_"+this.getId(),a,this.getMetadata()):null};
wrm.data.meta.BridgeEntity.prototype._createAddTimestampAttribute=function(a,b){if(!a)return null;if(!b)throw Error("No auxiliary entity available for entity "+this);var c="_addts"+this.getId(),d={};d.name=a;d.type=wrm.data.Type.TIMESTAMP;return new wrm.data.meta.AuxAttribute(c,d,b,!1,this.getMetadata())};
wrm.data.meta.BridgeEntity.prototype._createRemoveTimestampAttribute=function(a,b){if(!a)return null;if(!b)throw Error("No auxiliary entity available for entity "+this);var c="_remts"+this.getId(),d={};d.name=a;d.type=wrm.data.Type.TIMESTAMP;return new wrm.data.meta.AuxAttribute(c,d,b,!1,this.getMetadata())};
wrm.data.meta.BridgeEntity.prototype._createBridgeRole=function(a,b,c){if(!a)throw Error("No descriptor found for bridge role of role "+b);if(!b.getBridgeHeadRole())throw Error("Role "+b+" has no bridge-head role");return new wrm.data.meta.BridgeRole("_brdg_"+b.getId(),a,this,b.getBridgeHeadRole(),c,this.getMetadata())};wrm.data.meta.BridgeEntity.prototype.getAuxiliaryEntity=function(){return this._auxEntity};exportProperty(wrm.data.meta.BridgeEntity.prototype,"getAuxiliaryEntity",wrm.data.meta.BridgeEntity.prototype.getAuxiliaryEntity);
wrm.data.meta.BridgeEntity.prototype.getAddTimestampAuxiliaryAttribute=function(){return this._addTimestampAttriubte};exportProperty(wrm.data.meta.BridgeEntity.prototype,"getAddTimestampAuxiliaryAttribute",wrm.data.meta.BridgeEntity.prototype.getAddTimestampAuxiliaryAttribute);wrm.data.meta.BridgeEntity.prototype.getRemoveTimestampAuxiliaryAttribute=function(){return this._removeTimestampAttriubte};exportProperty(wrm.data.meta.BridgeEntity.prototype,"getRemoveTimestampAuxiliaryAttribute",wrm.data.meta.BridgeEntity.prototype.getRemoveTimestampAuxiliaryAttribute);
wrm.data.meta.BridgeEntity.prototype.getRole1=function(){return this._role1};exportProperty(wrm.data.meta.BridgeEntity.prototype,"getRole1",wrm.data.meta.BridgeEntity.prototype.getRole1);wrm.data.meta.BridgeEntity.prototype.getRole2=function(){return this._role2};exportProperty(wrm.data.meta.BridgeEntity.prototype,"getRole2",wrm.data.meta.BridgeEntity.prototype.getRole2);wrm.data.meta.BridgeRole=function(a,b,c,d,e,f){wrm.data.meta.Role.call(this,a,b,c,f);this._auxEntity=e;this.initInverseRole(d);c.registerRole(this,!0)};extendConstructor(wrm.data.meta.BridgeRole,wrm.data.meta.Role);exportSymbol("wrm.data.meta.BridgeRole",wrm.data.meta.BridgeRole);
wrm.data.meta.BridgeRole.prototype._createServerTrackerAttribute=function(a,b){if(!a)return null;if(!b)throw Error("No auxiliary entity available for bridge role "+this);var c="_track"+this.getId(),d={};d.name=a;d.type=this.getInverseEntity().getServerKeyAttribute().getType();return new wrm.data.meta.AuxAttribute(c,d,b,!1,this.getMetadata())};
wrm.data.meta.BridgeRole.prototype.doInit=function(a){wrm.data.meta.BridgeRole._super.doInit.call(this,a);this._serverTrackerAttriubte=this._createServerTrackerAttribute(a.serverTrackerName||null,this._auxEntity)};exportProperty(wrm.data.meta.BridgeRole.prototype,"doInit",wrm.data.meta.BridgeRole.prototype.doInit);wrm.data.meta.BridgeRole.prototype.getServerTrackerAuxiliaryAttribute=function(){return this._serverTrackerAttriubte};
exportProperty(wrm.data.meta.BridgeRole.prototype,"getServerTrackerAuxiliaryAttribute",wrm.data.meta.BridgeRole.prototype.getServerTrackerAuxiliaryAttribute);wrm.data.ObjectSet=function(a){this._hashSet=new Hashtable(this._createOptions(a))};exportSymbol("wrm.data.ObjectSet",wrm.data.ObjectSet);wrm.data.ObjectSet.prototype._createOptions=function(a){return{hashCode:this._computeHashCode(a),equals:this._computeEquals(a),replaceDuplicateKey:!1}};
wrm.data.ObjectSet.prototype._computeHashCode=function(a){function b(a){var b="";a instanceof Object?implementsInterface(a,wrm.data.TypedValue)?b+=a.hashKey():(b+="{",Object.keys(a).forEach(function(e){b+=e+":"+String(a[e])+","}),b=b.substring(0,b.length-1),b+="}"):b+=String(a);return b}return function(c){var d="";0<a.length?a.forEach(function(a){d=b(c[a])}):d=b(c);return d}};
wrm.data.ObjectSet.prototype._computeEquals=function(a){function b(a,b){if(a instanceof Object)if(implementsInterface(a,wrm.data.TypedValue)){if(!a.equals(b))return!1}else{if(a!==b)return!1}else if(String(a)!==String(b))return!1;return!0}return function(c,d){if(null===c||null===d)return!0;if(0<a.length)for(var e=0;e<a.length;e++){if(!b(c[a[e]],d[a[e]]))return!1}else if(!b(c,d))return!1;return!0}};wrm.data.ObjectSet.prototype.add=function(a){return null!==a&&null===this._hashSet.put(a,!0)?!0:!1};
exportProperty(wrm.data.ObjectSet.prototype,"add",wrm.data.ObjectSet.prototype.add);wrm.data.ObjectSet.prototype.toArray=function(){var a=[];this._hashSet.each(function(b){a.push(b)});return a};exportProperty(wrm.data.ObjectSet.prototype,"toArray",wrm.data.ObjectSet.prototype.toArray);wrm.data.ObjectSet.prototype.toString=function(){return"["+this.toArray().map(function(a){return String(a)}).join(", ")+"]"};exportProperty(wrm.data.ObjectSet.prototype,"toString",wrm.data.ObjectSet.prototype.toString);wrm.data.sync.UnstableDataSyncService=function(a){Object.keys(a).forEach(function(b){this[b]=a[b]},this);this._invalidated=!1};extendConstructor(wrm.data.sync.UnstableDataSyncService,wrm.data.sync.DataSyncService);wrm.data.sync.UnstableDataSyncService.prototype.handleUnstableUse=function(){if(this._invalidated)throw Error("Unstable Data Sync Service view is no longer valid");};wrm.data.sync.UnstableDataSyncService.prototype.invalidate=function(){this._invalidated=!0};wrm.data.UnstableDataService=function(a){Object.keys(a).forEach(function(b){this[b]=a[b]},this);this.entityContextPool=wrm.data.DataService.createEntityContextPool(this);this._invalidated=!1};extendConstructor(wrm.data.UnstableDataService,wrm.data.DataService);wrm.data.UnstableDataService.prototype.handleUnstableUse=function(){if(this._invalidated)throw Error("Unstable Data Service view is no longer valid");};wrm.data.UnstableDataService.prototype.invalidate=function(){this._invalidated=!0};wrm.data.XDTypeHandlers={};wrm.data.XDTypeHandlers._Blob=function(){};wrm.data.XDTypeHandlers._Blob.prototype.getMapping=function(){return{"":xdata.SimpleType.ARRAYBUFFER,contentType:xdata.SimpleType.STRING,fileName:xdata.SimpleType.STRING,remoteFileId:xdata.SimpleType.STRING,status:xdata.SimpleType.INTEGER}};
wrm.data.XDTypeHandlers._Blob.prototype.getOperatorMapping=function(a){var b=xdata.ValueOperator;switch(a){case b.EMPTY:case b.NOT_EMPTY:case b.NULL:case b.NOT_NULL:return a;default:throw Error("Operator '"+a+"' not supported for BLOB values");}};wrm.data.XDTypeHandlers._Blob.prototype.getOrderMapping=function(a){throw Error("Ordering not supported for BLOB values");};
wrm.data.XDTypeHandlers._Blob.prototype.read=function(a){var b=a.get("");if(!b)return null;var c=a.get("contentType")||void 0,d=a.get("fileName")||null,e=a.get("remoteFileId")||null;a=a.get("status")||null;return wrm.data.Blob.fromBytes(b,c,{fileName:d,contentSignature:e,availabilityStatus:a})};
wrm.data.XDTypeHandlers._Blob.prototype.write=function(a,b){if(b instanceof wrm.data.BlobReference)a.set("contentType",null),a.set("fileName",null),a.set("remoteFileId",b.getServerFileId()),a.set("status",b.getStatus());else{if(b)return a.set("contentType",b.getContentType()),a.set("fileName",b.getMetadata().fileName),a.set("remoteFileId",b.getMetadata().contentSignature),a.set("status",b.getMetadata().availabilityStatus),b.read().then(function(b){a.set("",b)});a.set("contentType",null);a.set("fileName",
null);a.set("remoteFileId",null);a.set("status",null)}a.set("",null)};wrm.data.XDTypeHandlers._BlobFS=function(){};wrm.data.XDTypeHandlers._BlobFS.prototype.getMapping=function(){return{"":xdata.SimpleType.STRING,contentType:xdata.SimpleType.STRING,fileName:xdata.SimpleType.STRING,remoteFileId:xdata.SimpleType.STRING,status:xdata.SimpleType.INTEGER}};
wrm.data.XDTypeHandlers._BlobFS.prototype.getOperatorMapping=function(a){var b=xdata.ValueOperator;switch(a){case b.EMPTY:case b.NOT_EMPTY:case b.NULL:case b.NOT_NULL:return a;default:throw Error("Operator '"+a+"' not supported for BLOB values");}};wrm.data.XDTypeHandlers._BlobFS.prototype.getOrderMapping=function(a){throw Error("Ordering not supported for BLOB values");};
wrm.data.XDTypeHandlers._BlobFS.prototype.read=function(a){var b=a.get("");if(!b)return null;var c=a.get("contentType")||void 0,d=a.get("fileName")||null,e=a.get("remoteFileId")||null,f=a.get("status")||null;return this._retrieveFile(b).then(function(a){return wrm.data.Blob.fromFile(a,c,{fileName:d,contentSignature:e,availabilityStatus:f})})};
wrm.data.XDTypeHandlers._BlobFS.prototype._retrieveFile=function(a){a=/(^.+)[/]([^/]+)$/.exec(a);return this._retrieveFileEntry(a[1],a[2]).then(function(a){return new Promise(function(c,d){a.file(function(a){c(a)},wrm.util.toErrorReject(d))})})};wrm.data.XDTypeHandlers._BlobFS.prototype._retrieveFileEntry=function(a,b){return this._retrieveDirectoryEntry(a).then(function(a){return wrm.util.fs.createNamedFile(a,b)})};
wrm.data.XDTypeHandlers._BlobFS.prototype._retrieveDirectoryEntry=function(a){return wrm.util.fs.retrievePersistentDirectory().then(function(b){return wrm.util.fs.retrieveDirectory(b,a)})};
wrm.data.XDTypeHandlers._BlobFS.prototype.write=function(a,b){if(b instanceof wrm.data.BlobReference)a.set("contentType",null),a.set("fileName",null),a.set("remoteFileId",b.getServerFileId()),a.set("status",b.getStatus());else{if(b)throw Error("Write handling of file-system-stored BLOBs is not implemented");a.set("contentType",null);a.set("fileName",null);a.set("remoteFileId",null);a.set("status",null)}a.set("",null)};wrm.data.XDTypeHandlers._Decimal=function(){};
wrm.data.XDTypeHandlers._Decimal.prototype.getMapping=function(){return xdata.SimpleType.DECIMAL};wrm.data.XDTypeHandlers._Decimal.prototype.getOperatorMapping=function(a){return a};wrm.data.XDTypeHandlers._Decimal.prototype.getOrderMapping=function(a){return a};wrm.data.XDTypeHandlers._Decimal.prototype.read=function(a){return(a=a.getDefault())&&wrm.data.Decimal.fromString(a)};wrm.data.XDTypeHandlers._Decimal.prototype.write=function(a,b){b=wrm.data.toDecimal(b);a.setDefault(b&&b.toString())};
wrm.data.XDTypeHandlers._Date=function(){};wrm.data.XDTypeHandlers._Date.prototype.getMapping=function(){return xdata.SimpleType.DATE};wrm.data.XDTypeHandlers._Date.prototype.getOperatorMapping=function(a){return a};wrm.data.XDTypeHandlers._Date.prototype.getOrderMapping=function(a){return a};wrm.data.XDTypeHandlers._Date.prototype.read=function(a){return(a=a.getDefault())&&wrm.data.Date.fromDate(a)};
wrm.data.XDTypeHandlers._Date.prototype.write=function(a,b){b=wrm.data.toDate(b);a.setDefault(b&&b.asDate())};wrm.data.XDTypeHandlers._Time=function(){};wrm.data.XDTypeHandlers._Time.prototype.getMapping=function(){return xdata.SimpleType.STRING};wrm.data.XDTypeHandlers._Time.prototype.getOperatorMapping=function(a){return a};wrm.data.XDTypeHandlers._Time.prototype.getOrderMapping=function(a){return a};wrm.data.XDTypeHandlers._Time.prototype.read=function(a){return(a=a.getDefault())&&wrm.data.Time.fromString(a)};
wrm.data.XDTypeHandlers._Time.prototype.write=function(a,b){b=wrm.data.toTime(b);a.setDefault(b&&b.toString())};wrm.data.XDTypeHandlers._Timestamp=function(){};wrm.data.XDTypeHandlers._Timestamp.prototype.getMapping=function(){return xdata.SimpleType.DATE};wrm.data.XDTypeHandlers._Timestamp.prototype.getOperatorMapping=function(a){return a};wrm.data.XDTypeHandlers._Timestamp.prototype.getOrderMapping=function(a){return a};
wrm.data.XDTypeHandlers._Timestamp.prototype.read=function(a){return(a=a.getDefault())&&wrm.data.DateTime.fromDate(a)};wrm.data.XDTypeHandlers._Timestamp.prototype.write=function(a,b){b=wrm.data.toTimestamp(b);a.setDefault(b&&b.asDate())};wrm.data.XDTypeHandlers._Direct=function(a,b){this._type=a;this._xdSimpleType=b};wrm.data.XDTypeHandlers._Direct.prototype.getMapping=function(){return this._xdSimpleType};wrm.data.XDTypeHandlers._Direct.prototype.getOperatorMapping=function(a){return a};
wrm.data.XDTypeHandlers._Direct.prototype.getOrderMapping=function(a){return a};wrm.data.XDTypeHandlers._Direct.prototype.read=function(a){return wrm.data.toSingle(this._type,a.getDefault())};wrm.data.XDTypeHandlers._Direct.prototype.write=function(a,b){a.setDefault(wrm.data.toSingle(this._type,b))};wrm.data.XDTypeHandlers.getName=function(a,b){a="wr-"+a;return b?a+"-"+b:a};
wrm.data.XDTypeHandlers.MAP=function(){var a=wrm.data.XDTypeHandlers,b=wrm.data.Type,c={};c[a.getName(b.BLOB)]=new wrm.data.XDTypeHandlers._Blob;c[a.getName(b.BLOB,"fs")]=new wrm.data.XDTypeHandlers._BlobFS;c[a.getName(b.BOOLEAN)]=new a._Direct(b.BOOLEAN,xdata.SimpleType.BOOLEAN);c[a.getName(b.DATE)]=new wrm.data.XDTypeHandlers._Date;c[a.getName(b.DECIMAL)]=new wrm.data.XDTypeHandlers._Decimal;c[a.getName(b.FLOAT)]=new a._Direct(b.FLOAT,xdata.SimpleType.REAL);c[a.getName(b.INTEGER)]=new a._Direct(b.INTEGER,
xdata.SimpleType.INTEGER);c[a.getName(b.PASSWORD)]=new a._Direct(b.PASSWORD,xdata.SimpleType.STRING);c[a.getName(b.STRING)]=new a._Direct(b.STRING,xdata.SimpleType.STRING);c[a.getName(b.TEXT)]=new a._Direct(b.TEXT,xdata.SimpleType.STRING);c[a.getName(b.TIME)]=new wrm.data.XDTypeHandlers._Time;c[a.getName(b.TIMESTAMP)]=new wrm.data.XDTypeHandlers._Timestamp;c[a.getName(b.URL)]=new a._Direct(b.URL,xdata.SimpleType.STRING);return c}();wrm.val={};wrm.val.Element=function(){};exportSymbol("wrm.val.Element",wrm.val.Element);wrm.val.Element.prototype.addError=ABSTRACT_METHOD;exportProperty(wrm.val.Element.prototype,"addError",wrm.val.Element.prototype.addError);wrm.form={};wrm.form.AbstractValidatedElement=function(){this._errorMessages=[]};exportSymbol("wrm.form.AbstractValidatedElement",wrm.form.AbstractValidatedElement);wrm.form.AbstractValidatedElement.prototype.addError=function(a,b){a=this.getErrorMessageKey()||a;b=this.augmentErrorMessageVariables(b||{});b=this.getLocalizationService().formatMessage(a,b);this.recordErrorMessage(b)};exportProperty(wrm.form.AbstractValidatedElement.prototype,"addError",wrm.form.AbstractValidatedElement.prototype.addError);
wrm.form.AbstractValidatedElement.prototype.augmentErrorMessageVariables=function(a){return angular.extend({},{objectName:this.getFormSubService().getFormLabel()},a)};exportProperty(wrm.form.AbstractValidatedElement.prototype,"augmentErrorMessageVariables",wrm.form.AbstractValidatedElement.prototype.augmentErrorMessageVariables);wrm.form.AbstractValidatedElement.prototype.recordErrorMessage=ABSTRACT_METHOD;exportProperty(wrm.form.AbstractValidatedElement.prototype,"recordErrorMessage",wrm.form.AbstractValidatedElement.prototype.recordErrorMessage);
wrm.form.AbstractValidatedElement.prototype.getErrorMessageKey=ABSTRACT_METHOD;exportProperty(wrm.form.AbstractValidatedElement.prototype,"getErrorMessageKey",wrm.form.AbstractValidatedElement.prototype.getErrorMessageKey);wrm.form.AbstractValidatedElement.prototype.getFormSubService=ABSTRACT_METHOD;exportProperty(wrm.form.AbstractValidatedElement.prototype,"getFormSubService",wrm.form.AbstractValidatedElement.prototype.getFormSubService);
wrm.form.AbstractValidatedElement.prototype.getLocalizationService=ABSTRACT_METHOD;exportProperty(wrm.form.AbstractValidatedElement.prototype,"getLocalizationService",wrm.form.AbstractValidatedElement.prototype.getLocalizationService);wrm.form.AbstractValidatedElement.prototype.getErrorMessages=function(){return this._errorMessages};wrm.form.FormSubService=function(){};exportSymbol("wrm.form.FormSubService",wrm.form.FormSubService);wrm.form.FormSubService.prototype.getFormLabel=function(){};exportProperty(wrm.form.FormSubService.prototype,"getFormLabel",wrm.form.FormSubService.prototype.getFormLabel);wrm.form.FormSubService.prototype.resolvePropertyFromView=function(a){};exportProperty(wrm.form.FormSubService.prototype,"resolvePropertyFromView",wrm.form.FormSubService.prototype.resolvePropertyFromView);
wrm.form.FormSubService.prototype.getPropertyNames=function(){};exportProperty(wrm.form.FormSubService.prototype,"getPropertyNames",wrm.form.FormSubService.prototype.getPropertyNames);wrm.form.FormSubService.prototype.getPropertyViewReference=function(a){};exportProperty(wrm.form.FormSubService.prototype,"getPropertyViewReference",wrm.form.FormSubService.prototype.getPropertyViewReference);wrm.form.FormSubService.prototype.getPropertyType=function(a){};
exportProperty(wrm.form.FormSubService.prototype,"getPropertyType",wrm.form.FormSubService.prototype.getPropertyType);wrm.form.FormSubService.prototype.getPropertyLabel=function(a){};exportProperty(wrm.form.FormSubService.prototype,"getPropertyLabel",wrm.form.FormSubService.prototype.getPropertyLabel);wrm.form.FormSubService.prototype.publishFormState=ABSTRACT_METHOD;exportProperty(wrm.form.FormSubService.prototype,"publishFormState",wrm.form.FormSubService.prototype.publishFormState);wrm.form.DefaultFormSubService=function(a,b,c){wrm.core.AbstractSubService.call(this,a,b,c);this._parentService=a;this._formLabel=b.formLabel;this._viewPropertyRefPrefix=b.viewFormRef?b.viewFormRef+".":"";this._propertyInfos=this._createPropertyInfos(b.properties||{});this._propertyNames=Object.keys(this._propertyInfos)};extendConstructor(wrm.form.DefaultFormSubService,wrm.core.AbstractSubService);exportSymbol("wrm.form.DefaultFormSubService",wrm.form.DefaultFormSubService);
wrm.form.DefaultFormSubService.prototype._createPropertyInfos=function(a){var b={};Object.keys(a).forEach(function(c){var d=a[c],e=d.type,e=e?wrm.util.obj.castEnumValue(wrm.data.Type,e):null;b[c]={type:e,label:d.label||c}});return b};wrm.form.DefaultFormSubService.prototype.getFormLabel=function(){return this._formLabel};exportProperty(wrm.form.DefaultFormSubService.prototype,"getFormLabel",wrm.form.DefaultFormSubService.prototype.getFormLabel);
wrm.form.DefaultFormSubService.prototype.resolvePropertyFromView=function(a){if(0>a.indexOf(this._viewPropertyRefPrefix))return null;a=a.substring(this._viewPropertyRefPrefix.length);return/^\w+$/.test(a)?a:null};exportProperty(wrm.form.DefaultFormSubService.prototype,"resolvePropertyFromView",wrm.form.DefaultFormSubService.prototype.resolvePropertyFromView);wrm.form.DefaultFormSubService.prototype.getPropertyNames=function(){return this._propertyNames};
exportProperty(wrm.form.DefaultFormSubService.prototype,"getPropertyNames",wrm.form.DefaultFormSubService.prototype.getPropertyNames);wrm.form.DefaultFormSubService.prototype.getPropertyViewReference=function(a){return this._viewPropertyRefPrefix+a};exportProperty(wrm.form.DefaultFormSubService.prototype,"getPropertyViewReference",wrm.form.DefaultFormSubService.prototype.getPropertyViewReference);wrm.form.DefaultFormSubService.prototype.getPropertyType=function(a){return this._getPropertyInfo(a).type};
exportProperty(wrm.form.DefaultFormSubService.prototype,"getPropertyType",wrm.form.DefaultFormSubService.prototype.getPropertyType);wrm.form.DefaultFormSubService.prototype.getPropertyLabel=function(a){return this._getPropertyInfo(a).label};exportProperty(wrm.form.DefaultFormSubService.prototype,"getPropertyLabel",wrm.form.DefaultFormSubService.prototype.getPropertyLabel);
wrm.form.DefaultFormSubService.prototype.retrievePublishedFormState=function(a){var b=this._parentService.getId(),c=this._propertyNames,d=a.getComponentView(b);a=a.getComponentFormState(b);if(!d||!a)return null;b=d.formState;b||(b=new wrm.form.PublishedFormState(a,c),d.formState=b);return b};wrm.form.DefaultFormSubService.prototype.publishFormState=function(a){this.retrievePublishedFormState(a)};exportProperty(wrm.form.DefaultFormSubService.prototype,"publishFormState",wrm.form.DefaultFormSubService.prototype.publishFormState);
wrm.form.DefaultFormSubService.prototype._getPropertyInfo=function(a){var b=this._propertyInfos[a];if(!b)throw Error("Unknown form property '"+a+"'");return b};wrm.form.PublishedFormState=function(a,b){Object.defineProperties(this,{_formState:{value:a},_propertyNames:{value:b},_errorInfos:{value:[]}});b.forEach(function(b){Object.defineProperty(this,b,{value:wrm.form.PublishedFormState._createPublishedPropertyState(a,b),enumerable:!0})},this)};
wrm.form.PublishedFormState.prototype=Object.create(Object.prototype,{republishErrors:{value:function(a,b){a=wrm.form.PublishedFormState._republishErrors(this,a,b);this._formState.setValidity(!a);return a}},errors:{get:function(){return this._errorInfos.map(function(a){return a.message})},enumerable:!0},valid:{get:function(){if(0<this._errorInfos.length)return!1;for(var a=0;a<this._propertyNames.length;a++)if(!this[this._propertyNames[a]].valid)return!1;return!0},enumerable:!0},invalid:{get:function(){if(0<
this._errorInfos.length)return!0;for(var a=0;a<this._propertyNames.length;a++)if(this[this._propertyNames[a]].invalid)return!0;return!1},enumerable:!0},dirty:{get:function(){for(var a=0;a<this._propertyNames.length;a++)if(this[this._propertyNames[a]].dirty)return!0;return!1},enumerable:!0}});wrm.form.PublishedFormState._createPublishedPropertyState=function(a,b){return Object.create(wrm.form.PublishedFormState._PROPERTY_STATE_PROTOTYPE,{_formState:{value:a},_propertyName:{value:b},_errorInfos:{value:[]}})};
wrm.form.PublishedFormState._PROPERTY_STATE_PROTOTYPE=Object.create(Object.prototype,{republishErrors:{value:function(a,b){a=wrm.form.PublishedFormState._republishErrors(this,a,b);this._formState.setPropertyValidity(this._propertyName,!a);return a}},errors:{get:function(){return this._formState.getPropertyPlatformErrors(this._propertyName).concat(this._errorInfos.map(function(a){return a.message}))},enumerable:!0},valid:{get:function(){if(0<this._errorInfos.length)return!1;var a=this._formState.getProperty(this._propertyName);
return!a||a.valid},enumerable:!0},invalid:{get:function(){if(0<this._errorInfos.length)return!0;var a=this._formState.getProperty(this._propertyName);return!!a&&a.invalid},enumerable:!0},dirty:{get:function(){var a=this._formState.getProperty(this._propertyName);return!!a&&a.dirty},enumerable:!0}});
wrm.form.PublishedFormState._republishErrors=function(a,b,c){var d=a._errorInfos,e=-1;for(a=0;a<d.length;a++)d[a].vruleId===b&&(d.splice(a,1),0>e&&(e=a),a--);0>e&&(e=d.length);if(!c)return!1;c.forEach(function(a){d[e++]={message:a,vruleId:b}});return!0};wrm.val.Object=function(){};exportSymbol("wrm.val.Object",wrm.val.Object);wrm.val.Object.prototype.getLabel=ABSTRACT_METHOD;exportProperty(wrm.val.Object.prototype,"getLabel",wrm.val.Object.prototype.getLabel);wrm.val.Object.prototype.getProperties=ABSTRACT_METHOD;exportProperty(wrm.val.Object.prototype,"getProperties",wrm.val.Object.prototype.getProperties);wrm.val.Object.prototype.getProperty=ABSTRACT_METHOD;exportProperty(wrm.val.Object.prototype,"getProperty",wrm.val.Object.prototype.getProperty);wrm.form.ValidatedForm=function(a,b,c,d,e){wrm.form.AbstractValidatedElement.call(this);this._formLabel=d.getFormLabel();this._propertyNames=a;this._formState=b;this._errorMessageKey=c;this._formSubService=d;this._l10nService=e;this._validatedProperties={};this._errorsMap={}};extendConstructor(wrm.form.ValidatedForm,wrm.form.AbstractValidatedElement);wrm.form.ValidatedForm.prototype.getFormState=function(){return this._formState};wrm.form.ValidatedForm.prototype.getErrorsMap=function(){return this._errorsMap};
wrm.form.ValidatedForm.prototype.clearErrors=function(){this._errorsMap={}};wrm.form.ValidatedForm.prototype.recordErrorMessage=function(a){var b=this._errorsMap[""];b||(this._errorsMap[""]=b=[]);b.push(a)};wrm.form.ValidatedForm.prototype.getErrorMessageKey=function(){return this._errorMessageKey};wrm.form.ValidatedForm.prototype.getFormSubService=function(){return this._formSubService};wrm.form.ValidatedForm.prototype.getLocalizationService=function(){return this._l10nService};
wrm.form.ValidatedForm.prototype.getLabel=function(){return this._formLabel};wrm.form.ValidatedForm.prototype.getProperties=function(){return this._propertyNames.map(function(a){return this.getProperty(a)},this)};wrm.form.ValidatedForm.prototype.getProperty=function(a){var b=this._validatedProperties[a];b||(b=new wrm.form.ValidatedFormProperty(this,a),this._validatedProperties[a]=b);return b};wrm.form.ValidatedForm.prototype.toString=function(){return this._formLabel};wrm.form.ValidationSubService=function(){};exportSymbol("wrm.form.ValidationSubService",wrm.form.ValidationSubService);wrm.form.ValidationSubService.prototype.validateEvent=function(a,b){};exportProperty(wrm.form.ValidationSubService.prototype,"validateEvent",wrm.form.ValidationSubService.prototype.validateEvent);wrm.form.ValidationSubService.prototype.validateFormObject=function(a){};exportProperty(wrm.form.ValidationSubService.prototype,"validateFormObject",wrm.form.ValidationSubService.prototype.validateFormObject);
wrm.form.ValidationSubService.prototype.validateFormProperty=function(a,b){};exportProperty(wrm.form.ValidationSubService.prototype,"validateFormProperty",wrm.form.ValidationSubService.prototype.validateFormProperty);wrm.val.RuleContext=function(a,b){this._input=a;this._element=b};exportSymbol("wrm.val.RuleContext",wrm.val.RuleContext);wrm.val.RuleContext.prototype.getInput=function(){return this._input};exportProperty(wrm.val.RuleContext.prototype,"getInput",wrm.val.RuleContext.prototype.getInput);wrm.val.RuleContext.prototype.getElement=function(){return this._element};exportProperty(wrm.val.RuleContext.prototype,"getElement",wrm.val.RuleContext.prototype.getElement);
wrm.val.RuleContext.prototype.toString=function(){return String(this._element)+" "+JSON.stringify(this._input)};exportProperty(wrm.val.RuleContext.prototype,"toString",wrm.val.RuleContext.prototype.toString);wrm.val.ObjectRuleContext=function(a,b){wrm.val.RuleContext.call(this,a,b)};extendConstructor(wrm.val.ObjectRuleContext,wrm.val.RuleContext);exportSymbol("wrm.val.ObjectRuleContext",wrm.val.ObjectRuleContext);wrm.val.ObjectRuleContext.prototype.getElement=function(){return wrm.val.ObjectRuleContext._super.getElement.call(this)};exportProperty(wrm.val.ObjectRuleContext.prototype,"getElement",wrm.val.ObjectRuleContext.prototype.getElement);wrm.val.PropertyRuleContext=function(a,b){wrm.val.RuleContext.call(this,a,b)};extendConstructor(wrm.val.PropertyRuleContext,wrm.val.RuleContext);exportSymbol("wrm.val.PropertyRuleContext",wrm.val.PropertyRuleContext);wrm.val.PropertyRuleContext.prototype.getElement=function(){return wrm.val.PropertyRuleContext._super.getElement.call(this)};exportProperty(wrm.val.PropertyRuleContext.prototype,"getElement",wrm.val.PropertyRuleContext.prototype.getElement);wrm.form.DefaultValidationSubService=function(a,b,c){wrm.core.AbstractSubService.call(this,a,b,c);this._parentService=a};extendConstructor(wrm.form.DefaultValidationSubService,wrm.core.AbstractSubService);exportSymbol("wrm.form.DefaultValidationSubService",wrm.form.DefaultValidationSubService);
wrm.form.DefaultValidationSubService.prototype.initialize=function(a){var b=this,c=this.getManager();return Promise.all([c.getLocalizationService().then(function(a){b._l10nService=a})]).then(function(){return b._createVInfo(a,!0).then(function(a){b._formInfo=a})}).then(function(){return b._createVInfos(a.properties||{}).then(function(a){b._propertyInfos=a;b._propertyNames=Object.keys(a)})})};exportProperty(wrm.form.DefaultValidationSubService.prototype,"initialize",wrm.form.DefaultValidationSubService.prototype.initialize);
wrm.form.DefaultValidationSubService.prototype._createVInfos=function(a){var b=this,c={};return Object.keys(a).reduce(function(d,e){return d.then(function(){return b._createVInfo(a[e])}).then(function(a){c[e]=a})},Promise.resolve()).then(function(){return c})};
wrm.form.DefaultValidationSubService.prototype._createVInfo=function(a,b){var c=this,d=this._createEventsConfiguration(a.events);b&&0<Object.keys(d).length&&(d._live=!0);var e=[];return(a.rules||[]).reduce(function(a,b){return a.then(function(){return c._createVRuleInfo(b)}).then(function(a){e.push(a)})},Promise.resolve()).then(function(){return{events:d,vruleInfos:e}})};
wrm.form.DefaultValidationSubService.prototype._createVRuleInfo=function(a){var b=this._createEventsConfiguration(a.events),c=a.inputs?a.inputs.split("|"):[],d=a.errorMessage||null,e=null,f=a.id;a=a.descr;return this.getManager().instantiateService(f,a).then(function(a){e=a.main}).then(function(){return{events:b,service:e,inputNames:c,errorMessageKey:d}})};
wrm.form.DefaultValidationSubService.prototype._createEventsConfiguration=function(a){if("string"===typeof a){var b={};a&&a.split("|").forEach(function(a){b[a]=!0});return b}return a?a:{}};
wrm.form.DefaultValidationSubService.prototype.validateEvent=function(a,b){var c=this,d=this._parentService.getId(),e=this._propertyNames,f=a.getSpecifier(),g=b.getComponentFormState(d);if(!f||!g)return Promise.resolve(!0);var h=new wrm.form.DefaultValidationSubService._ErrorFlags;return e.reduce(function(a,d){return a.then(function(){return c._validateFormProperty(f,g,d,h,b)})},Promise.resolve()).then(function(){return c._validateForm(f,g,h,b)}).then(function(){c._applyViewChanges(b);return!h.any})};
exportProperty(wrm.form.DefaultValidationSubService.prototype,"validateEvent",wrm.form.DefaultValidationSubService.prototype.validateEvent);wrm.form.DefaultValidationSubService.prototype.validateFormObject=function(a){var b=this,c=this._parentService.getId(),c=a.getComponentFormState(c);if(!c)return Promise.resolve(!0);var d=new wrm.form.DefaultValidationSubService._ErrorFlags;return this._validateForm("_live",c,d,a).then(function(){b._applyViewChanges(a);return!d.onForm})};
exportProperty(wrm.form.DefaultValidationSubService.prototype,"validateFormObject",wrm.form.DefaultValidationSubService.prototype.validateFormObject);wrm.form.DefaultValidationSubService.prototype.validateFormProperty=function(a,b){var c=this,d=this._parentService.getId(),d=b.getComponentFormState(d);if(!d)return Promise.resolve(!0);var e=new wrm.form.DefaultValidationSubService._ErrorFlags;return this._validateFormProperty("_live",d,a,e,b).then(function(){c._applyViewChanges(b);return!e.onProperties[a]})};
exportProperty(wrm.form.DefaultValidationSubService.prototype,"validateFormProperty",wrm.form.DefaultValidationSubService.prototype.validateFormProperty);
wrm.form.DefaultValidationSubService.prototype._validateForm=function(a,b,c,d){var e=this,f=this._formInfo;if(!b.getPlatformValidity())return c.addToForm(!0),Promise.resolve();var g=[];f.vruleInfos.forEach(function(b){var k=b.events[a];void 0===k&&(k=f.events[a]||!1);k?g.push(b):e._clearPublishedErrors(b.service.getId(),c,d)});return this._applyValidationRules(g,b,null,c,d)};
wrm.form.DefaultValidationSubService.prototype._validateFormProperty=function(a,b,c,d,e){var f=this,g=this._formInfo;if(!b.getPropertyPlatformValidity(c))return d.addToProperty(c,!0),Promise.resolve();var h=this._propertyInfos[c];if(!h)return Promise.resolve();var k=[];h.vruleInfos.forEach(function(b){var c=b.events[a];void 0===c&&(c=h.events[a]);void 0===c&&(c=g.events[a]||!1);c?k.push(b):f._clearPublishedErrors(b.service.getId(),d,e)});return this._applyValidationRules(k,b,c,d,e)};
wrm.form.DefaultValidationSubService.prototype._applyValidationRules=function(a,b,c,d,e){var f=this,g=!1;return a.reduce(function(a,k){return a.then(function(){if(g)f._clearPublishedErrors(k.service.getId(),d,e);else return f._applyValidationRule(k,b,c,d,e).then(function(a){a===wrm.val.RulePolicy.STOP&&(g=!0)})})},Promise.resolve())};
wrm.form.DefaultValidationSubService.prototype._applyValidationRule=function(a,b,c,d,e){var f=this,g=this._propertyNames,h=this._l10nService,k=this._parentService,l=this.getManager(),m=void 0,n=Promise.resolve().then(function(){return l.getFormSubService(k)}).then(function(c){m=new wrm.form.ValidatedForm(g,b,a.errorMessageKey,c,h)}),n=n.then(function(){var b=e.getComponentInput(k.getId());return c?f._invokeFormPropertyValidationRule(a,b,m,c):f._invokeFormValidationRule(a,b,m)}),p;return n.then(function(b){p=
b;return f._republishErrors(a.service.getId(),m.getErrorsMap(),d,e)}).then(function(){return p})};wrm.form.DefaultValidationSubService.prototype._invokeFormValidationRule=function(a,b,c){b=new wrm.form.DefaultValidationSubService._RuleInput(a.inputNames,b);b=new wrm.val.ObjectRuleContext(b,c);c.clearErrors();return this._invokeValidationRule(a.service,b)};
wrm.form.DefaultValidationSubService.prototype._invokeFormPropertyValidationRule=function(a,b,c,d){b=new wrm.form.DefaultValidationSubService._RuleInput(a.inputNames,b);d=new wrm.val.PropertyRuleContext(b,c.getProperty(d));c.clearErrors();return this._invokeValidationRule(a.service,d)};wrm.form.DefaultValidationSubService._RuleInput=function(a,b){a.forEach(function(a){var d=b[a];void 0!==d&&(this[a]=d)},this)};
wrm.form.DefaultValidationSubService.prototype._invokeValidationRule=function(a,b){var c=this.getLog();return Promise.resolve().then(function(){c.debug("Validating with",a,"-",b);return a.validate(b)}).then(function(a){return a||wrm.val.RulePolicy.CONTINUE},function(a){c.error("Validation internal error",a);throw a;})};wrm.form.DefaultValidationSubService._ErrorFlags=function(){this.onForm=this.any=!1;this.onProperties={}};
wrm.form.DefaultValidationSubService._ErrorFlags.prototype.addToForm=function(a){a&&(this.onForm=this.any=!0)};wrm.form.DefaultValidationSubService._ErrorFlags.prototype.addToProperty=function(a,b){b&&(this.any=!0,this.onProperties[a]=!0)};
wrm.form.DefaultValidationSubService.prototype._republishErrors=function(a,b,c,d){var e=this._propertyNames,f=this.getManager(),g=this._parentService;return f.hasFormSubService(g).then(function(a){return a?f.getFormSubService(g):null}).then(function(f){if(f){var g=f.retrievePublishedFormState(d);g&&(c.addToForm(g.republishErrors(a,b[""])),e.forEach(function(d){var e=g[d].republishErrors(a,b[d]);c.addToProperty(d,e)}))}})};
wrm.form.DefaultValidationSubService.prototype._clearPublishedErrors=function(a,b,c){return this._republishErrors(a,{},b,c)};wrm.form.DefaultValidationSubService.prototype._applyViewChanges=function(a){var b=this._parentService.getId();(a=a.getComponentView(b))&&a.applyChanges()};wrm.form.FormPropertyTracker=function(a,b){this._formState=a;this._formSubService=b};wrm.form.FormPropertyTracker.prototype.updatesStarted=function(a){var b=this._formSubService;if(!this._formState||!b)return{};var c={};b.getPropertyNames().forEach(function(d){var e=b.getPropertyViewReference(d),e=wrm.util.obj.lookupSafe(e,a);c[d]=e});return c};
wrm.form.FormPropertyTracker.prototype.updatesFinished=function(a,b){var c=this._formState,d=this._formSubService;c&&d&&d.getPropertyNames().forEach(function(e){var f=d.getPropertyViewReference(e),f=wrm.util.obj.lookupSafe(f,a);wrm.data.equal(b[e],f)||c.clearPropertyDirtiness(e)})};wrm.form.FormState=function(){};exportSymbol("wrm.form.FormState",wrm.form.FormState);wrm.form.FormState.prototype.setValidity=ABSTRACT_METHOD;exportProperty(wrm.form.FormState.prototype,"setValidity",wrm.form.FormState.prototype.setValidity);wrm.form.FormState.prototype.publishValidViewValues=ABSTRACT_METHOD;exportProperty(wrm.form.FormState.prototype,"publishValidViewValues",wrm.form.FormState.prototype.publishValidViewValues);wrm.form.FormState.prototype.getProperty=ABSTRACT_METHOD;
exportProperty(wrm.form.FormState.prototype,"getProperty",wrm.form.FormState.prototype.getProperty);wrm.form.FormState.prototype.setPropertyValidity=ABSTRACT_METHOD;exportProperty(wrm.form.FormState.prototype,"setPropertyValidity",wrm.form.FormState.prototype.setPropertyValidity);wrm.form.FormState.prototype.getPlatformValidity=ABSTRACT_METHOD;exportProperty(wrm.form.FormState.prototype,"getPlatformValidity",wrm.form.FormState.prototype.getPlatformValidity);
wrm.form.FormState.prototype.getPropertyPlatformValidity=ABSTRACT_METHOD;exportProperty(wrm.form.FormState.prototype,"getPropertyPlatformValidity",wrm.form.FormState.prototype.getPropertyPlatformValidity);wrm.form.FormState.prototype.getPropertyPlatformErrors=ABSTRACT_METHOD;exportProperty(wrm.form.FormState.prototype,"getPropertyPlatformErrors",wrm.form.FormState.prototype.getPropertyPlatformErrors);wrm.form.FormState.prototype.clearPropertyDirtiness=ABSTRACT_METHOD;
exportProperty(wrm.form.FormState.prototype,"clearPropertyDirtiness",wrm.form.FormState.prototype.clearPropertyDirtiness);wrm.val.Property=function(){};exportSymbol("wrm.val.Property",wrm.val.Property);wrm.val.Property.prototype.getLabel=ABSTRACT_METHOD;exportProperty(wrm.val.Property.prototype,"getLabel",wrm.val.Property.prototype.getLabel);wrm.val.Property.prototype.getValue=ABSTRACT_METHOD;exportProperty(wrm.val.Property.prototype,"getValue",wrm.val.Property.prototype.getValue);wrm.val.Property.prototype.getObject=ABSTRACT_METHOD;exportProperty(wrm.val.Property.prototype,"getObject",wrm.val.Property.prototype.getObject);wrm.form.ValidatedFormProperty=function(a,b){wrm.form.AbstractValidatedElement.call(this);this._validatedForm=a;this._propertyName=b;var c=a.getFormState().getProperty(b);if(!c)throw Error("Form property '"+b+"' not found");this._propertyState=c;this._propertyLabel=a.getFormSubService().getPropertyLabel(b)};extendConstructor(wrm.form.ValidatedFormProperty,wrm.form.AbstractValidatedElement);
wrm.form.ValidatedFormProperty.prototype.augmentErrorMessageVariables=function(a){a=wrm.form.ValidatedFormProperty._super.augmentErrorMessageVariables.call(this,a);return angular.extend({},{propertyName:this._propertyLabel,propertyValue:this._propertyState.value},a)};wrm.form.ValidatedFormProperty.prototype.recordErrorMessage=function(a){var b=this._validatedForm.getErrorsMap(),c=b[this._propertyName];c||(b[this._propertyName]=c=[]);c.push(a)};
wrm.form.ValidatedFormProperty.prototype.getErrorMessageKey=function(){return this._validatedForm.getErrorMessageKey()};wrm.form.ValidatedFormProperty.prototype.getFormSubService=function(){return this._validatedForm.getFormSubService()};wrm.form.ValidatedFormProperty.prototype.getLocalizationService=function(){return this._validatedForm.getLocalizationService()};wrm.form.ValidatedFormProperty.prototype.getLabel=function(){return this._propertyLabel};
wrm.form.ValidatedFormProperty.prototype.getValue=function(){return this._propertyState.value};wrm.form.ValidatedFormProperty.prototype.getObject=function(){return this._validatedForm};wrm.form.ValidatedFormProperty.prototype.toString=function(){return String(this._validatedForm)+"/"+this._propertyLabel+" ("+this._propertyName+")"};wrm.l10n.LocaleInfo=function(){};exportSymbol("wrm.l10n.LocaleInfo",wrm.l10n.LocaleInfo);wrm.l10n.LocaleInfo.prototype.getMonthNames=ABSTRACT_METHOD;exportProperty(wrm.l10n.LocaleInfo.prototype,"getMonthNames",wrm.l10n.LocaleInfo.prototype.getMonthNames);wrm.l10n.LocaleInfo.prototype.getDayNames=ABSTRACT_METHOD;exportProperty(wrm.l10n.LocaleInfo.prototype,"getDayNames",wrm.l10n.LocaleInfo.prototype.getDayNames);wrm.l10n.LocaleInfo.prototype.getFirstDayOfWeek=ABSTRACT_METHOD;
exportProperty(wrm.l10n.LocaleInfo.prototype,"getFirstDayOfWeek",wrm.l10n.LocaleInfo.prototype.getFirstDayOfWeek);wrm.l10n.NameWidth={NARROW:"narrow",ABBREVIATED:"abbreviated",SHORT:"short",WIDE:"wide"};exportSymbol("wrm.l10n.NameWidth",wrm.l10n.NameWidth);wrm.Log=function(){};exportSymbol("wrm.Log",wrm.Log);wrm.Log.prototype.error=ABSTRACT_METHOD;exportProperty(wrm.Log.prototype,"error",wrm.Log.prototype.error);wrm.Log.prototype.warn=ABSTRACT_METHOD;exportProperty(wrm.Log.prototype,"warn",wrm.Log.prototype.warn);wrm.Log.prototype.info=ABSTRACT_METHOD;exportProperty(wrm.Log.prototype,"info",wrm.Log.prototype.info);wrm.Log.prototype.debug=ABSTRACT_METHOD;exportProperty(wrm.Log.prototype,"debug",wrm.Log.prototype.debug);
wrm.Log.prototype.isDebugEnabled=ABSTRACT_METHOD;exportProperty(wrm.Log.prototype,"isDebugEnabled",wrm.Log.prototype.isDebugEnabled);wrm.nav.LoginDialog=function(a,b,c,d){wrm.nav.Dialog.call(this,a,wrm.nav.Dialog.Flavor.POSITIVE,d);this._defaultUsername=b||null;this._usernameChangeForbidden=c||!1};extendConstructor(wrm.nav.LoginDialog,wrm.nav.Dialog);exportSymbol("wrm.nav.LoginDialog",wrm.nav.LoginDialog);wrm.nav.LoginDialog.prototype.getDefualtUsername=function(){return this._defaultUsername};exportProperty(wrm.nav.LoginDialog.prototype,"getDefualtUsername",wrm.nav.LoginDialog.prototype.getDefualtUsername);
wrm.nav.LoginDialog.prototype.isUsernameChangeForbidden=function(){return this._usernameChangeForbidden};exportProperty(wrm.nav.LoginDialog.prototype,"isUsernameChangeForbidden",wrm.nav.LoginDialog.prototype.isUsernameChangeForbidden);wrm.nav.LoginDialog.prototype.toString=function(){return'LoginDialog:"'+this.getMessage()+'"'};exportProperty(wrm.nav.LoginDialog.prototype,"toString",wrm.nav.LoginDialog.prototype.toString);wrm.nav.MultipleRoute=function(a){this._routes=a.slice()};exportSymbol("wrm.nav.MultipleRoute",wrm.nav.MultipleRoute);wrm.nav.MultipleRoute.prototype.isStationary=function(){for(var a=0;a<this._routes.length;a++)if(!this._routes[a].isStationary())return!1;return!0};exportProperty(wrm.nav.MultipleRoute.prototype,"isStationary",wrm.nav.MultipleRoute.prototype.isStationary);wrm.nav.MultipleRoute.prototype.getRoutes=function(){return this._routes};
exportProperty(wrm.nav.MultipleRoute.prototype,"getRoutes",wrm.nav.MultipleRoute.prototype.getRoutes);wrm.nav.MultipleRoute.prototype.toString=function(){return"["+this._routes.join(", ")+"]"};exportProperty(wrm.nav.MultipleRoute.prototype,"toString",wrm.nav.MultipleRoute.prototype.toString);wrm.nav.Reuse={NONE:"none",PARTIAL:"partial",FULL:"full"};exportSymbol("wrm.nav.Reuse",wrm.nav.Reuse);wrm.nav.ServiceRoute=function(a,b){if(null===a||null===b)throw Error("Invalid service or gate");this._serviceId=a||null;this._gate=b||a||null};exportSymbol("wrm.nav.ServiceRoute",wrm.nav.ServiceRoute);wrm.nav.ServiceRoute.prototype.isStationary=function(){return!this._serviceId};exportProperty(wrm.nav.ServiceRoute.prototype,"isStationary",wrm.nav.ServiceRoute.prototype.isStationary);wrm.nav.ServiceRoute.prototype.getServiceId=function(){return this._serviceId};
exportProperty(wrm.nav.ServiceRoute.prototype,"getServiceId",wrm.nav.ServiceRoute.prototype.getServiceId);wrm.nav.ServiceRoute.prototype.getGate=function(){return this._gate};exportProperty(wrm.nav.ServiceRoute.prototype,"getGate",wrm.nav.ServiceRoute.prototype.getGate);wrm.nav.ServiceRoute.prototype.toString=function(){var a=[];this._serviceId||this._gate?(a.push(this._serviceId||""),this._gate&&a.push(":",this._gate)):a.push("\x3cstationary\x3e");return a.join("")};
exportProperty(wrm.nav.ServiceRoute.prototype,"toString",wrm.nav.ServiceRoute.prototype.toString);wrm.nav.VirtualRoute=function(a){this._type=a};exportSymbol("wrm.nav.VirtualRoute",wrm.nav.VirtualRoute);wrm.nav.VirtualRoute.prototype.isStationary=function(){return!1};exportProperty(wrm.nav.VirtualRoute.prototype,"isStationary",wrm.nav.VirtualRoute.prototype.isStationary);wrm.nav.VirtualRoute.prototype.getType=function(){return this._type};exportProperty(wrm.nav.VirtualRoute.prototype,"getType",wrm.nav.VirtualRoute.prototype.getType);
wrm.nav.VirtualRoute.prototype.toString=function(){return"\x3c"+this._type+"\x3e"};exportProperty(wrm.nav.VirtualRoute.prototype,"toString",wrm.nav.VirtualRoute.prototype.toString);wrm.nav.VirtualRoute.Type={BACK:"back",EXIT:"exit"};exportProperty(wrm.nav.VirtualRoute,"Type",wrm.nav.VirtualRoute.Type);wrm.Platform=function(){};exportSymbol("wrm.Platform",wrm.Platform);wrm.Platform.prototype.getDeviceId=ABSTRACT_METHOD;exportProperty(wrm.Platform.prototype,"getDeviceId",wrm.Platform.prototype.getDeviceId);wrm.Platform.prototype.getDeviceModel=ABSTRACT_METHOD;exportProperty(wrm.Platform.prototype,"getDeviceModel",wrm.Platform.prototype.getDeviceModel);wrm.Platform.prototype.getDevicePlatform=ABSTRACT_METHOD;exportProperty(wrm.Platform.prototype,"getDevicePlatform",wrm.Platform.prototype.getDevicePlatform);
wrm.Platform.prototype.getDevicePlatformVersion=ABSTRACT_METHOD;exportProperty(wrm.Platform.prototype,"getDevicePlatformVersion",wrm.Platform.prototype.getDevicePlatformVersion);wrm.Platform.prototype.getWebEngineType=ABSTRACT_METHOD;exportProperty(wrm.Platform.prototype,"getWebEngineType",wrm.Platform.prototype.getWebEngineType);wrm.Platform.prototype.createLog=ABSTRACT_METHOD;exportProperty(wrm.Platform.prototype,"createLog",wrm.Platform.prototype.createLog);
wrm.Platform.prototype.retrieveDictionary=ABSTRACT_METHOD;exportProperty(wrm.Platform.prototype,"retrieveDictionary",wrm.Platform.prototype.retrieveDictionary);wrm.Platform.prototype.readAppFile=ABSTRACT_METHOD;exportProperty(wrm.Platform.prototype,"readAppFile",wrm.Platform.prototype.readAppFile);wrm.Platform.prototype.makeHttpRequest=ABSTRACT_METHOD;exportProperty(wrm.Platform.prototype,"makeHttpRequest",wrm.Platform.prototype.makeHttpRequest);wrm.Platform.prototype.getNotificationDeviceId=ABSTRACT_METHOD;
exportProperty(wrm.Platform.prototype,"getNotificationDeviceId",wrm.Platform.prototype.getNotificationDeviceId);wrm.Platform.prototype.hasPendingNotifications=ABSTRACT_METHOD;exportProperty(wrm.Platform.prototype,"hasPendingNotifications",wrm.Platform.prototype.hasPendingNotifications);wrm.Platform.prototype.addNotificationStatusListener=ABSTRACT_METHOD;exportProperty(wrm.Platform.prototype,"addNotificationStatusListener",wrm.Platform.prototype.addNotificationStatusListener);
wrm.Platform.prototype.subscribeNotifications=ABSTRACT_METHOD;exportProperty(wrm.Platform.prototype,"subscribeNotifications",wrm.Platform.prototype.subscribeNotifications);wrm.Platform.prototype.getCurrentLocale=ABSTRACT_METHOD;exportProperty(wrm.Platform.prototype,"getCurrentLocale",wrm.Platform.prototype.getCurrentLocale);wrm.Platform.prototype.getCurrentLocaleInfo=ABSTRACT_METHOD;exportProperty(wrm.Platform.prototype,"getCurrentLocaleInfo",wrm.Platform.prototype.getCurrentLocaleInfo);
wrm.Platform.prototype.overrideLocale=ABSTRACT_METHOD;exportProperty(wrm.Platform.prototype,"overrideLocale",wrm.Platform.prototype.overrideLocale);wrm.util.AsyncWorker=function(a,b){this._workerFunction=a;this._maxBatchDuration=b&&b.maxBatchDuration||100;this._batchInterval=b&&b.batchInterval||30;this._queue=[];this._working=!1};exportSymbol("wrm.util.AsyncWorker",wrm.util.AsyncWorker);wrm.util.AsyncWorker.prototype.post=function(a){this._queue.push(a);this._working||(setTimeout(this._workBatch.bind(this),this._batchInterval),this._working=!0)};exportProperty(wrm.util.AsyncWorker.prototype,"post",wrm.util.AsyncWorker.prototype.post);
wrm.util.AsyncWorker.prototype._workBatch=function(){var a=this._queue,b=(new Date).valueOf(),c=this._maxBatchDuration;do{var d=a.shift();try{this._workerFunction(d)}catch(e){}}while(0<a.length&&(new Date).valueOf()-b<c);0<a.length?setTimeout(this._workBatch.bind(this),this._batchInterval):this._working=!1};wrm.util.Deferred=function(){var a=this;this._promise=new Promise(function(b,c){a._resolve=b;a._reject=c})};exportSymbol("wrm.util.Deferred",wrm.util.Deferred);wrm.util.Deferred.prototype.then=function(a,b){return this._promise.then(a,b)};exportProperty(wrm.util.Deferred.prototype,"then",wrm.util.Deferred.prototype.then);wrm.util.Deferred.prototype["catch"]=function(a){return this._promise["catch"](a)};wrm.util.Deferred.prototype.toString=function(){return this._promise.toString()};
exportProperty(wrm.util.Deferred.prototype,"toString",wrm.util.Deferred.prototype.toString);wrm.util.ListenerList=function(){this._listeners=[]};exportSymbol("wrm.util.ListenerList",wrm.util.ListenerList);wrm.util.ListenerList.prototype.add=function(a){if(a){for(var b=0;b<this._listeners.length;b++)if(this._listeners[b]===a)return;this._listeners.push(a)}};exportProperty(wrm.util.ListenerList.prototype,"add",wrm.util.ListenerList.prototype.add);
wrm.util.ListenerList.prototype.remove=function(a){if(a)for(var b=0;b<this._listeners.length;b++)if(this._listeners[b]===a){this._listeners.splice(b,1);break}};exportProperty(wrm.util.ListenerList.prototype,"remove",wrm.util.ListenerList.prototype.remove);wrm.util.ListenerList.prototype.notifyAll=function(a){for(var b=null,c=0;c<this._listeners.length;c++)try{this._listeners[c](a)}catch(d){b?b.push(d):b=[d]}if(b)return Error("Error thrown by listeners:\n",b.map(function(a){return"---\n"+a.stack}).join("\n"))};
exportProperty(wrm.util.ListenerList.prototype,"notifyAll",wrm.util.ListenerList.prototype.notifyAll);wrm.val.ValidationRuleService=function(){};exportSymbol("wrm.val.ValidationRuleService",wrm.val.ValidationRuleService);wrm.val.ValidationRuleService.prototype.validate=ABSTRACT_METHOD;exportProperty(wrm.val.ValidationRuleService.prototype,"validate",wrm.val.ValidationRuleService.prototype.validate);wrm.val.AbstractValidationRuleService=function(a,b,c){wrm.core.AbstractService.call(this,a,b,c);this._messageKeyPrefix=b.messageKeyPrefix||""};extendConstructor(wrm.val.AbstractValidationRuleService,wrm.core.AbstractService);exportSymbol("wrm.val.AbstractValidationRuleService",wrm.val.AbstractValidationRuleService);wrm.val.AbstractValidationRuleService.prototype.validate=ABSTRACT_METHOD;exportProperty(wrm.val.AbstractValidationRuleService.prototype,"validate",wrm.val.AbstractValidationRuleService.prototype.validate);
wrm.val.AbstractValidationRuleService.prototype.getMessageKey=function(a){return this._messageKeyPrefix+a};exportProperty(wrm.val.AbstractValidationRuleService.prototype,"getMessageKey",wrm.val.AbstractValidationRuleService.prototype.getMessageKey);wrm.val.ObjectValidationRuleService=function(){};exportSymbol("wrm.val.ObjectValidationRuleService",wrm.val.ObjectValidationRuleService);wrm.val.AbstractObjectValidationRuleService=function(a,b,c){wrm.val.AbstractValidationRuleService.call(this,a,b,c)};extendConstructor(wrm.val.AbstractObjectValidationRuleService,wrm.val.AbstractValidationRuleService);exportSymbol("wrm.val.AbstractObjectValidationRuleService",wrm.val.AbstractObjectValidationRuleService);wrm.val.PropertyValidationRuleService=function(){};exportSymbol("wrm.val.PropertyValidationRuleService",wrm.val.PropertyValidationRuleService);wrm.val.AbstractPropertyValidationRuleService=function(a,b,c){wrm.val.AbstractValidationRuleService.call(this,a,b,c)};extendConstructor(wrm.val.AbstractPropertyValidationRuleService,wrm.val.AbstractValidationRuleService);exportSymbol("wrm.val.AbstractPropertyValidationRuleService",wrm.val.AbstractPropertyValidationRuleService);wrm.val.RulePolicy={CONTINUE:"continue",STOP:"stop"};exportSymbol("wrm.val.RulePolicy",wrm.val.RulePolicy);})();})(this);