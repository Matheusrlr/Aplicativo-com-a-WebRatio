!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@webratio/xdata")):"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["xdata-websql"]=t(require("@webratio/xdata")):e["xdata-websql"]=t(e.xdata)}(window,function(n){return function(n){var r={};function o(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}return o.m=n,o.c=r,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)o.d(n,r,function(e){return t[e]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=3)}([function(e,t){e.exports=n},,,function(e,t,n){"use strict";n.r(t);var d=n(0);function a(e,t,n,r,o,i){var a=e.getListeners();(n?t.transaction:t.readTransaction).call(t,function(e){a.notifyBegunTransaction(n),r(e)},function(e){a.notifyResolvedTransaction(n,!1),o&&o(e)},function(){a.notifyResolvedTransaction(n,!0),i&&i()})}function s(e,t,r,o,n,i){var a=e.getListeners();a.notifyExecutingSql(r,o),t.executeSql(r,o,function(e,t){u=e;try{a.notifyExecutedSql(r,o),n&&n(e,t)}finally{u=null}},function(e,t){u=e;try{a.notifyExecutedSql(r,o,t);var n=!0;return i&&(n=i(e,t)),!1!==n}finally{u=null}})}var u=null;function c(o){return function(e,t,n,r){return o(l(t,n,r))}}function l(e,t,n){var r="SQL"+e.code+" ("+e.message+")";return r+="\nQuery text: "+(t||"<n/a>"),r+="\nQuery parameters: "+(n?JSON.stringify(n):"<n/a>"),new Error(r)}var f={};function h(e,t,n){return{dbContext:e,realTxFactory:t,canYield:n,realTx:null,callbackDepth:0,activeQueries:0,queuedQueries:[],pollerRunning:!1,keepAlive:!1,yieldTimer:null,yielding:!1}}var m="__instrumented_"+Math.random();!function(){var u=window.openDatabase;if("function"==typeof u&&!0!==u._xdata){var s={};Object.defineProperty(e,"_xdata",{value:!0}),window.openDatabase=e}function e(e,t,n,r,o){var i=e+"__"+String(t)+"__"+n+"__"+r,a=s[i];return a||(a=u.call(null,e,t,n,r,o),s[i]=a),a}}();var p,_=window.openDatabase;function i(e,t,n,r,o){_||(_=window.openDatabase);var i=_.call(window,e,t,n,r,o);if(!0===i[m])return i;Object.defineProperty(i,m,{value:!0});var a,u,s=((u=f[a=e])||(u={requestedTxs:0},f[a]=u),u),l=i.transaction.bind(i),p=i.readTransaction.bind(i);return i.transaction=function(e,t,n){return y(h(s,l,!0),e,t,n)},i.readTransaction=function(e,t,n){return y(h(s,p,!1),e,t,n)},i}function y(t,n,r,e){var o=this,i=t.dbContext,a=!0;function u(){a&&(a=!1,i.requestedTxs--)}return i.requestedTxs++,t.realTxFactory(function(e){u(),t.realTx=e,t.callbackDepth++;try{return n.call(o,b(t))}finally{t.callbackDepth--,E(t)}},function(e){if(u(),r)return r.call(o,e)},e)}function b(e,t){return new r(e,t)}(p||(p={})).is=function(e){return"release"in e&&"keepAlive"in e};var r=function(){function e(e,t){this._context=e,this._dontQueue=t}return e.prototype.executeSql=function(e,t,n,r){var o=this._context,i=this._dontQueue,a=o.realTx;if(!(!a||o.keepAlive&&o.callbackDepth<=0&&!i))return o.activeQueries++,a.executeSql(e,t,function(e,t){o.activeQueries--;try{if(n){o.callbackDepth++;try{return n.call(this,b(o),t)}finally{o.callbackDepth--}}}finally{E(o)}},function(e,t){o.activeQueries--;try{if(r){o.callbackDepth++;try{return r.call(this,b(o),t)}finally{o.callbackDepth--}}}finally{E(o)}});o.queuedQueries.push([e,t,n,r])},e.prototype.keepAlive=function(e,t){var n=this._context;if(n.callbackDepth<=0)throw new Error("Keep alive called too late");e=e||0,t=t||0,n.keepAlive=!0,n.yieldTimer&&window.clearInterval(n.yieldTimer),n.yieldTimer=0<e?window.setInterval(o.bind(this,n,t),e):null},e.prototype.yield=function(e){o(this._context,e)},e.prototype.release=function(){var e=this._context;e.keepAlive=!1,e.yieldTimer&&window.clearInterval(e.yieldTimer),e.yieldTimer=null,v(e)},e}();function o(e,t){var n=e.dbContext;e.yielding||!e.canYield||n.requestedTxs<=0||(e.realTx=null,e.yielding=!0,v(e),window.setTimeout(function(){y(e,function(){e.yielding=!1})},t||0))}function E(e){e.realTx&&e.keepAlive&&e.callbackDepth<=0&&e.activeQueries<=0?function(e){if(e.pollerRunning)return;e.pollerRunning=!0,function n(r){var e=r.realTx;if(!e||!r.pollerRunning)return;e.executeSql("SELECT '$polling'",[],function(e,t){r.callbackDepth++;try{!function(e){if(e.queuedQueries.length<=0)return;var t=e.queuedQueries;e.queuedQueries=[];for(var n=b(e,!0),r=0;r<t.length;r++)n.executeSql.apply(n,t[r])}(r)}finally{r.callbackDepth--,E(r)}n(r)},function(e,t){return console.error("Poller failed"),!1})}(e)}(e):v(e)}function v(e){e.pollerRunning=!1}var g,T,O,w=function(){function e(e,t,n,r){this._db=e,this._dbConn=t,this._writeEnabled=n,this._dbTx=r,this._resolved=!1}return e.prototype.getDatabase=function(){return this._db},e.prototype.executeCommand=function(n,r,e){var o=this;if(this._checkNotResolved(),"isUpdate"in n){var t=n;return t.isUpdate?this._executeUpdateCommandOLD(this._dbTx,t,r):this._executeInsertCommandOLD(this._dbTx,t,r)}return new Promise(function(e,t){n.execute(o,r,e,t)})},e.prototype._executeInsertCommandOLD=function(e,o,i){if(!e)throw new Error("Must be run in a transaction");var t=o.parameterNames.map(function(e,t){return(0,o.parameterConvs[t])(i[e])});return new Promise(function(n,r){e.executeSql(o.sql,t,function(e,t){o.resultConv(e,i,t,n,r)},function(e,t){return r(new Error("[SQL"+t.code+"]: "+t.message)),!1})})},e.prototype._executeUpdateCommandOLD=function(e,o,i){if(!e)throw new Error("Must be run in a transaction");var t=o.parameterNames.map(function(e,t){return(0,o.parameterConvs[t])(i[e])});return new Promise(function(n,r){e.executeSql(o.sql,t,function(e,t){o.resultConv(e,i,t,n,r)},function(e,t){return r(new Error("[SQL"+t.code+"]: "+t.message)),!1})})},e.prototype.runInTransaction=function(e){u?e(u):this._dbTx?e(this._dbTx):a(this._db,this._dbConn,this._writeEnabled,e)},e.prototype.resolve=function(){this._checkNotResolved(),this._dbTx&&p.is(this._dbTx)&&this._dbTx.release(),this._resolved=!0},e.prototype._checkNotResolved=function(){if(this._resolved)throw new Error("Transaction is no longer available")},e}(),N=function(){function e(e,t){this._db=e,this._dbConn=t}return e.prototype.getDatabase=function(){return this._db},e.prototype.createTransaction=function(r){var o=this._db,i=this._dbConn;return new Promise(function(t,e){var n=r.atomic;!1!==n?a(o,i,!0,function(e){if(!p.is(e))throw new Error("Transaction atomicity is not supported");!0===n?e.keepAlive():e.keepAlive(n.interval,n.backoff),t(new w(o,i,!r.readOnly,e))},e):t(new w(o,i,!r.readOnly,null))})},e}();(T=g||(g={}))[T.ONE=0]="ONE",T[T.TWO=1]="TWO",(O=g||(g={})).oppositeOf=function(e){return e===O.ONE?O.TWO:O.ONE};var S=":name:";function R(e,t){return 0<e.length?e.slice():[S+t]}function A(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return e.reduce(function(e,t,n){for(var r=1<n||Array.isArray(e)?e:[e],o=Array.isArray(t)?t:[t],i=[],a=0;a<r.length;a++)for(var u=0;u<o.length;u++)i.push(String(r[a])+o[u]);return i})}function C(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return e.reduce(function(e,t,n){var r=1<n||Array.isArray(e)?e:[e],o=Array.isArray(t)?t:[t],i=[];if(r.length!==o.length)throw new Error("Attempting to merge different numbers of identities");for(var a=0;a<r.length;a++)i.push(String(r[a])+o[a]);return i})}var x,I=function(){function e(){this._sealed=!1}return e.prototype.seal=function(){this._sealed=!0},e.prototype.ensureNotSealed=function(){if(this._sealed)throw new Error("The element cannot be modified")},e}(),q=(x=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}x(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),L=function(r){function t(e,t){var n=r.call(this)||this;return n.name=e,n.identities=R(t,e),n}return q(t,r),t.prototype.initTables=function(e,t){if(this.ensureNotSealed(),this.table1||this.table2)throw new Error("Relation already assigned to a pair of tables");this.table1=e,this.table2=t},t.prototype.initAccessor=function(e){if(this.ensureNotSealed(),this.accessor)throw new Error("Relation already assigned an accessor");this.accessor=e},t.prototype.toString=function(){return this.name},t.fromRelationProviderSchema=function(e){return new t(e.name,e.identities)},t}(I),P=function(e){return String(e)};function F(e,t,r){void 0===r&&(r=P);var l={},o=0;function n(e,a){var u={};function s(){return String(o++)}function n(e){var t,n=function(e){if(1===e.length)return void 0===l[e[0]]?[l[e[0]]=s()]:[l[e[0]]];var n={};e.forEach(function(e){var t=l[e];void 0!==t&&(n[t]=!0)});var t,r=Object.keys(n);return t=1===r.length?r[0]:s(),e.forEach(function(e){l[e]=t}),1<r.length?[t].concat(r):[t]}(e);if(1===n.length)return(t=u[n[0]])||(u[n[0]]=t=[]),t;var r=n[0],o=n.slice(1);function i(n,e,t){var r=[];return t.forEach(function(e){var t=n[e];t&&(Array.prototype.push.apply(r,t),delete n[e])}),n[e]=r}return t=i(u,r,o),a.forEach(function(e){i(e,r,o)}),t}return e.forEach(function(e){if(null==e)throw new Error("Found null/undefined objects");var t=r(e);if(Array.isArray(t)||(t=[t]),t.length<=0)throw new Error("Found objects with no keys");n(t).push(e)}),u}var i=n(e,[]),a=n(t,[i]),u={added:[],replaced:[],removed:[]},s={};return Object.keys(i).forEach(function(e){s[e]=!0}),Object.keys(a).forEach(function(e){if(!0===s[e]){delete s[e];var t=i[e],n=a[e];(t.length!=n.length||1<t.length||1===t.length&&t[0]!==n[0])&&u.replaced.push({older:t,newer:n})}else Array.prototype.push.apply(u.added,a[e])}),Object.keys(s).forEach(function(e){Array.prototype.push.apply(u.removed,i[e])}),u}var k=function(){throw new Error("Not supported")};function B(e,t){if(!0!==function(t){var e=t[D];if(!e){var n=Object.keys(t).filter(function(e){return/^[A-Z_\d]+$/.test(e)}).map(function(e){return t[e]}),r={};n.forEach(function(e){return r[e]=!0}),e={list:n,set:r},Object.defineProperty(t,D,{value:e})}return e}(e).set[t])throw new TypeError("Invalid constant value '"+t+"' for enumeration type "+e);return t}var D="__enum_values";var Q,W,U=(Q=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}Q(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});!function(e){var t=function(){function e(e,t){this._baseTable=e,this._connectedTable=t,this.hasSameStructure=k,this.getUniqueSide=k,this.appendTupleSelection=k,this.insertsByUpdating=k,this.appendTupleInsertion=k,this.appendTupleUpdating=k,this.appendTupleDeletion=k,this.mayImportKeys=k,this.appendKeyImportJoin=k}return e.prototype.getBaseTable=function(){return this._baseTable},e.prototype.getConnectedTable=function(){return this._connectedTable},e.prototype.getEquivalentColumn=function(e,t){return e!==g.ONE?null:this.getConnectedEquivalentColumn(t)},e.prototype.appendTableJoin=function(e,t,n){if(t!==g.ONE)throw new Error("Cannot join from side "+t);return this.appendConnectedTableJoin(e,n)},e.prototype.getConnectionRelation=function(){return null},e}(),n=function(){function t(e,t,n){var r=this;this._connectionRels={},this._bridgeTable=e,this._cols=[t.bridgeCols.slice(),n.bridgeCols.slice()],this._tables=[t.table,n.table],this._self=t.table===n.table,[t,n].forEach(function(e,t){var n=s(new o(r._bridgeTable,e.bridgeCols,e.table));r._connectionRels[e.endName]=n,r._self||(r._connectionRels[e.table.name]=n)})}return t.prototype.hasSameStructure=function(e){return e instanceof t},t.prototype.getBaseTable=function(){return this.getBridgeTable()},t.prototype.getBridgeTable=function(){return this._bridgeTable},t.prototype.getUniqueSide=function(){return null},t.prototype.appendTupleSelection=function(e,t){var n=this._cols;return u(e,this._bridgeTable,n,t)},t.prototype.insertsByUpdating=function(){return!1},t.prototype.appendTupleInsertion=function(t,n){var e=this._cols[0].concat(this._cols[1]);t.sql("INSERT INTO"),t.quotedName(this._bridgeTable.dbName,this._bridgeTable.name),t.groupStart("("),e.forEach(function(e){t.quotedName(e.name),t.separator(", ")}),t.groupEnd(")"),t.sql("VALUES"),t.groupStart("("),e.forEach(function(e){n(t,e),t.separator(", ")}),t.groupEnd(")")},t.prototype.appendTupleUpdating=function(t,n,r){var e=this._cols[0].concat(this._cols[1]),o=!1;if(t.sql("UPDATE"),t.quotedName(this._bridgeTable.dbName,this._bridgeTable.name),t.sql("SET"),t.groupStart(),e.forEach(function(e){r(e)&&(o=!0,t.quotedName(e.name),t.sql("="),n(t,e),t.separator(", "))}),t.groupEnd(),!o)throw new Error("Must provide an input for at least one column")},t.prototype.appendTupleDeletion=function(e){e.sql("DELETE FROM"),e.quotedName(this._bridgeTable.dbName,this._bridgeTable.name)},t.prototype.mayImportKeys=function(e){return!1},t.prototype.appendKeyImportJoin=function(e,t,n,r,o){throw new Error("Not supported for bridged relations")},t.prototype.appendTableJoin=function(e,t,n){var r=g.oppositeOf(t),o=e.createAlias("t"),i=this._tables[t],a=this._tables[r],u=this._cols[t],s=this._cols[r],l=this._bridgeTable,p=n+"_"+o;return c(e,n,i.keyColumns,l,p,u),c(e,p,s,a,o,a.keyColumns),{table:a,many:!0,alias:o}},t.prototype.getEquivalentColumn=function(e,t){return null},t.prototype.getConnectionRelation=function(e){var t=this._connectionRels[e];return t?{relation:t,side:g.ONE}:null},t}();e.Bridged=n;var o=function(o){function e(e,t,n){var r=o.call(this,e,n)||this;return r._cols=t.slice(),r}return U(e,o),e.prototype.getConnectedEquivalentColumn=function(e){if(e.key&&e.table===this.getConnectedTable()){var t=e.table.keyColumns.indexOf(e);return this._cols[t]}return null},e.prototype.appendConnectedTableJoin=function(e,t){var n=e.createAlias("t"),r=this.getConnectedTable();return c(e,t,this._cols,r,n,r.keyColumns),{table:r,many:!1,alias:n}},e}(t),r=function(){function t(e,t,n){this._connectionRels={},this._collapsedSide=e,this._collapsedTable=t.table,this._collapsedCols=t.columns,this._collapsedMany=t.many,this._otherTable=n.table,this._self=this._collapsedTable===this._otherTable;var r=s(new a(this._collapsedTable));this._connectionRels[t.endName]=r,this._self||(this._connectionRels[this._collapsedTable.name]=r);r=s(new i(this._collapsedTable,this._collapsedCols,this._otherTable));this._connectionRels[n.endName]=r,this._self||(this._connectionRels[this._otherTable.name]=r)}return t.prototype.hasSameStructure=function(e){return e instanceof t&&e._collapsedSide===this._collapsedSide},t.prototype.getBaseTable=function(){return this.getCollapsedTable()},t.prototype.getCollapsedTable=function(){return this._collapsedTable},t.prototype.getCollapsedColumns=function(){return this._collapsedCols},t.prototype.getUniqueSide=function(){return this._collapsedSide},t.prototype.appendTupleSelection=function(e,t){var n;return n=this._collapsedSide===g.ONE?[this._collapsedTable.keyColumns,this._collapsedCols]:[this._collapsedCols,this._collapsedTable.keyColumns],u(e,this._collapsedTable,n,t)},t.prototype.insertsByUpdating=function(){return!0},t.prototype.appendTupleInsertion=function(t,n){t.sql("UPDATE"),t.quotedName(this._collapsedTable.dbName,this._collapsedTable.name),t.sql("SET"),t.groupStart(),this._collapsedCols.forEach(function(e){t.quotedName(e.name),t.sql("="),n(t,e),t.separator(", ")}),t.groupEnd(),t.sql("WHERE"),t.groupStart(),this._collapsedTable.keyColumns.forEach(function(e){t.quotedName(e.name),t.sql("="),n(t,e),t.separator(" AND ")}),t.groupEnd()},t.prototype.appendTupleUpdating=function(t,n,e){t.sql("UPDATE"),t.quotedName(this._collapsedTable.dbName,this._collapsedTable.name),t.sql("SET"),t.groupStart(),this._collapsedCols.forEach(function(e){t.quotedName(e.name),t.sql("="),n(t,e),t.separator(", ")}),t.groupEnd()},t.prototype.appendTupleDeletion=function(t){t.sql("UPDATE"),t.quotedName(this._collapsedTable.dbName,this._collapsedTable.name),t.sql("SET"),t.groupStart(),this._collapsedCols.forEach(function(e){t.quotedName(e.name),t.sql("= NULL"),t.separator(", ")}),t.groupEnd()},t.prototype.mayImportKeys=function(e){return e===this._collapsedSide},t.prototype.appendKeyImportJoin=function(e,t,n,r,o){if(t!==this._collapsedSide)throw new Error("Not supported on the other side of collapsed relations");c(e,"",this._collapsedTable.keyColumns,n,r,o)},t.prototype.appendTableJoin=function(e,t,n){var r,o,i,a,u=e.createAlias("t");return t===this._collapsedSide?(r=this._collapsedTable,o=this._otherTable,i=this._collapsedCols,a=o.keyColumns):(r=this._otherTable,o=this._collapsedTable,i=r.keyColumns,a=this._collapsedCols),c(e,n,i,o,u,a),{table:o,many:t!==this._collapsedSide&&this._collapsedMany,alias:u}},t.prototype.getEquivalentColumn=function(e,t){if(t.key&&t.table===this._otherTable){var n=t.table.keyColumns.indexOf(t);return this._collapsedCols[n]}return null},t.prototype.getConnectionRelation=function(e){var t=this._connectionRels[e];return t?{relation:t,side:g.ONE}:null},t}();e.Collapsed=r;var i=function(o){function e(e,t,n){var r=o.call(this,e,n)||this;return r._collapsedCols=t,r}return U(e,o),e.prototype.getConnectedEquivalentColumn=function(e){if(e.key&&e.table===this.getConnectedTable()){var t=e.table.keyColumns.indexOf(e);return this._collapsedCols[t]}return null},e.prototype.appendConnectedTableJoin=function(e,t){var n=e.createAlias("t"),r=this.getConnectedTable();return c(e,t,this._collapsedCols,r,n,r.keyColumns),{table:r,many:!1,alias:n}},e}(t),a=function(t){function e(e){return t.call(this,e,e)||this}return U(e,t),e.prototype.getConnectedEquivalentColumn=function(e){return e.table===this.getBaseTable()?e:null},e.prototype.appendConnectedTableJoin=function(e,t){return{table:this.getBaseTable(),many:!1,alias:t}},e}(t);function u(i,e,t,n){var a=[];return i.sql("SELECT").groupStart(),t.forEach(function(e,r){var o=[];e.forEach(function(e,t){var n="side"+r+"_"+t;o.push(n),i.quotedName(e.name).sql("AS").quotedName(n).separator(", ")}),a.push(o)}),i.groupEnd(),i.sql("FROM").quotedName(e.dbName,e.name),"number"==typeof n&&(i.sql("GROUP BY").groupStart(),a[n].forEach(function(e){i.quotedName(e).separator(", ")}),i.groupEnd(),i.sql("HAVING COUNT(*) = 1")),{aliases:a}}function c(n,r,e,t,o,i){n.sql("LEFT OUTER JOIN"),n.quotedName(t.dbName,t.name).sql("AS").quotedName(o),n.sql("ON").groupStart(),e.forEach(function(e,t){n.quotedName(r,e.name),n.sql("="),n.quotedName(o,i[t].name),n.separator(" AND ")}),n.groupEnd()}function s(e){var t=new L("_connection",[]);return t.initTables(e.getBaseTable(),e.getConnectedTable()),t.initAccessor(e),t}e._appendTupleSelect=u,e._appendLeftOuterJoin=c,e._createConnectionRelation=s}(W||(W={}));var V=function(e,t){this.sql=e,this.inputData=t?t.slice():[]},j=function(){function e(e){this._text="",this._pendingSeparator=null,this._outerGroups=null,this._inputData=null,this._aliasCounts=null,this._aliasPrefix=e&&e.aliasPrefix||""}return e.prototype.groupStart=function(e){return e=e||"",this._doAppend(e),this._outerGroups||(this._outerGroups=[]),this._outerGroups.push({pendingSeparator:this._pendingSeparator}),this._pendingSeparator=null,this},e.prototype.separator=function(e){return this._pendingSeparator=e,this},e.prototype.groupEnd=function(e){if(e=e||"",!this._outerGroups||this._outerGroups.length<=0)throw new Error("No current group");var t=this._outerGroups.pop();return this._doAppend(e,!0),this._pendingSeparator=t.pendingSeparator,this},e.prototype.sql=function(e){return e&&this._doAppend(e),this},e.prototype.name=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(e.length<=0)return this;for(var n=[],r=0;r<e.length;r++)n[r]=e[r];return this._doAppendName(n),this},e.prototype._doAppendName=function(e){if(1===e.length)return this._doAppend(e[0]);if(2===e.length&&"main"===e[0])return this._doAppendName(e.slice(1));for(var t="",n=0;n<e.length;n++)0<n&&(t=t.concat(".")),t=t.concat(e[n]);return this._doAppend(t)},e.prototype.quotedName=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(e.length<=0)return this;for(var n=[],r=0;r<e.length;r++)n[r]=e[r];return this._doAppendQuotedName(n),this},e.prototype._doAppendQuotedName=function(e){if(1===e.length)return this._doAppend('"'+e[0].replace(/"/g,'""')+'"');if(2===e.length&&("main"===e[0]||""===e[0]))return this._doAppendQuotedName(e.slice(1));for(var t='"',n=0;n<e.length;n++)0<n&&(t=t.concat('"."')),t=t.concat(e[n].replace(/"/g,'""'));return t=t.concat('"'),this._doAppend(t)},e.prototype.inputPlaceholder=function(e){return this._doAppend("?"),this._inputData||(this._inputData=[]),this._inputData.push(e),this},e.prototype._doAppend=function(e,t){this._pendingSeparator&&(t||(this._text=this._text.concat(this._pendingSeparator))),this._text=this._text.concat(e),this._pendingSeparator=" "},e.prototype.fragment=function(e){return this.sql(e.sql),this._inputData||(this._inputData=[]),Array.prototype.push.apply(this._inputData,e.inputData),this},e.prototype.createAlias=function(e){var t=this._aliasCounts;t||(this._aliasCounts=t={});var n=t[e]||0;return t[e]=n+1,this._aliasPrefix+e+n},e.prototype.getInputCount=function(){return this._inputData?this._inputData.length:0},e.prototype.build=function(){return new V(this.buildSQL(),this._inputData)},e.prototype.buildSQL=function(){return this._text},e.prototype.toString=function(){return this.buildSQL()},e}(),G={};G[d.SimpleType.ARRAYBUFFER]={sqlType:"BLOB",toSQL:function(e){if(!e)return e;for(var t=new Uint8Array(e),n="",r=0,o=t.length;r<o;r++)n+=String.fromCharCode(t[r]);return btoa(n)},fromSQL:function(e){if(null==e)return e;for(var t=atob(e),n=new Uint8Array(t.length),r=0,o=n.length;r<o;r++)n[r]=t.charCodeAt(r);return n.buffer},appendComparableTermExpansion:function(e,t){t(e)}},G[d.SimpleType.BOOLEAN]={sqlType:"INTEGER",toSQL:function(e){return null==e?e:e?1:0},fromSQL:function(e){return null==e?e:1===e},appendComparableTermExpansion:function(e,t){t(e)}},G[d.SimpleType.DATE]={sqlType:"INTEGER",toSQL:function(e){return e?e.valueOf():e},fromSQL:function(e){return null==e?e:new Date(e)},appendComparableTermExpansion:function(e,t){t(e)}},G[d.SimpleType.DECIMAL]={sqlType:"TEXT",toSQL:function(e){return e},fromSQL:function(e){return e},appendComparableTermExpansion:function(e,t){e.groupStart("CAST("),t(e),e.sql("AS REAL").groupEnd(")")}},G[d.SimpleType.INTEGER]={sqlType:"INTEGER",toSQL:function(e){return e},fromSQL:function(e){return e},appendComparableTermExpansion:function(e,t){t(e)}},G[d.SimpleType.REAL]={sqlType:"REAL",toSQL:function(e){return e},fromSQL:function(e){return e},appendComparableTermExpansion:function(e,t){t(e)}},G[d.SimpleType.STRING]={sqlType:"TEXT",toSQL:function(e){return e},fromSQL:function(e){return e},appendComparableTermExpansion:function(e,t){t(e)}};var M,K,J,Y,H,X,z,$,Z="_rowid_",ee=d.SimpleType.INTEGER,te=(M=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}M(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),ne=function(i){function a(e,t,n,r){var o=i.call(this)||this;return a._validateName(e),o.name=e,o.converter=t,o.type=t.sqlType,o.key=n,o.identities=R(r,e),o}return te(a,i),a._validateName=function(e){if(e.toLowerCase()===Z.toLowerCase())throw new Error("Column name '"+Z+"' is reserved for internal use")},a.prototype.initTable=function(e){if(this.ensureNotSealed(),this.table)throw new Error("Column already assigned to a table");this.table=e},a.prototype.toString=function(){return this.name},a.fromFieldProviderSchema=function(e){return new a(e.properties.columnName||e.name,G[B(d.SimpleType,e.type)],e.key,e.identities)},a.fromColumn=function(e,t,n){return new a(t,e.converter,!1,n)},a}(I),re=function(){function e(e,t){this._oldSchema=e,this._newSchema=t,this._queryBuilders=[],this._cleanupQueryBuilders=[],this._newBridgeTablesTuples={},this._newTablesTupleJoins={},this._tableChangedIndexes={}}return e.prototype.generate=function(){var e=this._computeSchemaDiff();if(!e)return[];try{return this._collectChangedIndexes(e),this._generateRelations(e),this._generateTablesAndIndexes(e),this._queryBuilders.map(function(e){return e.buildSQL()}).concat(this._cleanupQueryBuilders.map(function(e){return e.buildSQL()}))}finally{this._resetGenerationState()}},e.prototype._resetGenerationState=function(){this._queryBuilders=[],this._cleanupQueryBuilders=[],this._newBridgeTablesTuples={},this._newTablesTupleJoins={},this._tableChangedIndexes={}},e.prototype._addQuery=function(){var e=new j;return this._queryBuilders.push(e),e},e.prototype._addCleanupQuery=function(){var e=new j;return this._cleanupQueryBuilders.unshift(e),e},e.prototype._computeSchemaDiff=function(){var n=this,e=this._oldSchema.tables,t=this._oldSchema.relations,r=this._oldSchema.indexes,o=this._newSchema.tables,i=this._newSchema.relations,a=this._newSchema.indexes,u=!1,s=[];F(t,i,this._getRelationIdentityKey.bind(this)).replaced.forEach(function(e){if(1<e.older.length||1<e.newer.length)throw new Error("A new relation can replace exactly one old relation");var t=n._computeRelationDiff(e.older[0],e.newer[0]);t&&(s.push(t),u=!0)});var l=[],p=F(e,o,this._getTableIdentityKey.bind(this));(0<p.added.length||0<p.removed.length)&&(u=!0),p.replaced.forEach(function(e){if(1<e.older.length||1<e.newer.length)throw new Error("A new table can replace exactly one old table");var t=n._computeTableDiff(e.older[0],e.newer[0]);t&&(l.push(t),u=!0)});var c=[],d=F(r,a,this._getIndexIdentityKey.bind(this));return(0<d.added.length||0<d.removed.length)&&(u=!0),d.replaced.forEach(function(e){if(1<e.older.length||1<e.newer.length)throw new Error("A new index can replace exactly one old index");var t=n._computeIndexDiff(e.older[0],e.newer[0]);t&&(c.push(t),u=!0)}),u?{addedTables:p.added.slice(),removedTables:p.removed.slice(),changedTables:l,changedRelations:s,addedIndexes:d.added.slice(),removedIndexes:d.removed.slice(),changedIndexes:c}:null},e.prototype._computeRelationDiff=function(e,t){return t.accessor&&!e.accessor.hasSameStructure(t.accessor)?{oldRelation:e,newRelation:t}:null},e.prototype._computeTableDiff=function(e,t){var n=this,r=e.name!==t.name,o={older:[],newer:[]},i=F(e.columns,t.columns,this._getColumnIdentityKey.bind(this));(0<i.added.length||0<i.removed.length)&&(r=!0),i.replaced.forEach(function(e){if(1<e.older.length)throw new Error("New columns can replace exactly at most one column");var t=e.older[0];r=r||n._computeColumnDiff(t,e.newer),e.newer.forEach(function(e){o.older.push(t),o.newer.push(e)})});var a=F(e.foreignKeys,t.foreignKeys,this._getForeignKeyIdentityKey.bind(this));return(0<a.added.length||0<a.removed.length)&&(r=!0),a.replaced.forEach(function(e){if(1<e.older.length||1<e.newer.length)throw new Error("A new foreign key can replace exactly one old foreign key");r=r||n._computeForeignKeyDiff(e.older[0],e.newer[0])}),r?{oldTable:e,newTable:t,columnIdentity:o}:null},e.prototype._computeColumnDiff=function(e,t){if(1<t.length)return!0;var n=t[0];return n.name!==e.name||n.type!==e.type||n.key!==e.key},e.prototype._computeForeignKeyDiff=function(e,t){var n=this,r=!1,o=F(e.columns,t.columns,this._getColumnIdentityKey.bind(this));return(0<o.added.length||0<o.removed.length)&&(r=!0),o.replaced.forEach(function(e){if(1<e.older.length)throw new Error("New columns can replace exactly at most one column");var t=e.older[0];r=r||n._computeColumnDiff(t,e.newer)}),this._computeTableDiff(e.referencedTable,t.referencedTable)&&(r=!0),r},e.prototype._computeIndexDiff=function(e,t){var n=this,r=e.name!==t.name||e.unique!==t.unique;this._computeTableDiff(e.table,t.table)&&(r=!0);var o=F(e.columns,t.columns,this._getColumnIdentityKey.bind(this));return(0<o.added.length||0<o.removed.length)&&(r=!0),o.replaced.forEach(function(e){if(1<e.older.length)throw new Error("New columns can replace exactly at most one column");var t=e.older[0];r=r||n._computeColumnDiff(t,e.newer)}),r?{oldIndex:e,newIndex:t}:null},e.prototype._generateRelations=function(e){e.changedRelations.forEach(this._generateRelationTuplesTable,this)},e.prototype._generateRelationTuplesTable=function(e){var t=e.oldRelation,n=e.newRelation,r=n.table1,o=n.table2,i=this._newSchema.createBridgeTable("_tuples_"+n.name,"temp",[],r,o,{},{}),a=i.table,u=this._addQuery().sql("CREATE TABLE").quotedName(a.dbName,a.name);this._appendTableDefinition(u,a);var s=this._addQuery().sql("INSERT INTO").quotedName(a.dbName,a.name);if(this._appendTargetColumnsList(s,a.columns),t.accessor.appendTupleSelection(s,n.accessor.getUniqueSide()),this._addCleanupQuery().sql("DROP TABLE").quotedName(a.dbName,a.name),n.accessor instanceof W.Bridged){var l=n.accessor.getBridgeTable();0,this._newBridgeTablesTuples[l.name]=a}else if(n.accessor instanceof W.Collapsed){var p=n.accessor.getCollapsedTable(),c=void 0,d=void 0,f=void 0;if(n.table1===p)c=g.ONE,d=i.fkCols1,f=i.fkCols2;else{if(n.table2!==p)throw new Error("Invalid collapsed table");c=g.TWO,d=i.fkCols2,f=i.fkCols1}var h=this._newTablesTupleJoins[p.name];h||(this._newTablesTupleJoins[p.name]=h=[]),h.push({relationAccessor:n.accessor,side:c,table:a,fkCols:d,otherFkCols:f})}else 0},e.prototype._collectChangedIndexes=function(e){var n=this._tableChangedIndexes;function t(e){var t=n[e.name];return t||(n[e.name]=t={added:[],removed:[]}),t}e.addedIndexes.forEach(function(e){t(e.table).added.push(e)}),e.removedIndexes.forEach(function(e){t(e.table).removed.push(e)}),e.changedIndexes.forEach(function(e){t(e.oldIndex.table).removed.push(e.oldIndex),t(e.newIndex.table).added.push(e.newIndex)})},e.prototype._generateTablesAndIndexes=function(e){var n=this,t=this._tableChangedIndexes||{};function r(e){return t[e]||{added:[],removed:[]}}var o={};e.addedTables.forEach(function(e){n._generateTableAddition(e,r(e.name).added),o[e.name]=!0}),e.changedTables.forEach(function(e){n._generateTableUpdate(e,r(e.oldTable.name).removed,r(e.newTable.name).added),o[e.oldTable.name]=!0,o[e.newTable.name]=!0}),e.removedTables.forEach(function(e){n._generateTableRemoval(e,r(e.name).removed),o[e.name]=!0}),Object.keys(t).forEach(function(e){if(!0!==o[e]){var t=r(e);n._generateTableIndexesOnly(t.removed,t.added)}})},e.prototype._generateTableAddition=function(e,t){var n=this._addQuery().sql("CREATE TABLE").quotedName(e.dbName,e.name);this._appendTableDefinition(n,e),t.forEach(this._generateIndexAddition,this);var r=this._newBridgeTablesTuples[e.name];if(r){var o=this._addQuery().sql("INSERT INTO").quotedName(e.dbName,e.name);this._appendTargetColumnsList(o,e.columns),o.sql("SELECT"),this._appendResultColumnsList(o,r.columns),o.sql("FROM").quotedName(r.dbName,r.name)}},e.prototype._generateTableUpdate=function(e,t,n){var r=e.oldTable,o=e.newTable,i=this._newTablesTupleJoins[o.name]||[],a="_new_"+o.name,u=this._addQuery().sql("CREATE TABLE").quotedName(o.dbName,a);this._appendTableDefinition(u,o);var s=e.columnIdentity.newer.slice();i.forEach(function(e,t){Array.prototype.push.apply(s,e.relationAccessor.getCollapsedColumns())});var l=e.columnIdentity.older.slice();i.forEach(function(e,t){var n="t"+t;e.otherFkCols.forEach(function(e){l.push({tableAlias:n,column:e})})});var p=this._addQuery().sql("INSERT INTO").quotedName(o.dbName,a);this._appendTargetColumnsList(p,s),p.sql("SELECT"),this._appendResultColumnsList(p,l),p.sql("FROM").quotedName(r.dbName,r.name),i.forEach(function(e,t){e.relationAccessor.appendKeyImportJoin(p,e.side,e.table,"t"+t,e.fkCols)}),this._addQuery().sql("DROP TABLE").quotedName(r.dbName,r.name),this._addQuery().sql("ALTER TABLE").quotedName(o.dbName,a).sql("RENAME TO").quotedName(o.name),n.forEach(this._generateIndexAddition,this)},e.prototype._generateTableRemoval=function(e,t){this._addQuery().sql("DROP TABLE").quotedName(e.dbName,e.name)},e.prototype._generateTableIndexesOnly=function(e,t){e.forEach(this._generateIndexRemoval,this),t.forEach(this._generateIndexAddition,this)},e.prototype._generateIndexAddition=function(e){var t=this._addQuery().sql(e.unique?"CREATE UNIQUE INDEX":"CREATE INDEX");t.quotedName(e.table.dbName,e.name),t.sql("ON").quotedName(e.table.name),this._appendTargetColumnsList(t,e.columns)},e.prototype._generateIndexRemoval=function(e){this._addQuery().sql("DROP INDEX").quotedName(e.table.dbName,e.name)},e.prototype._appendTableDefinition=function(t,e){var n=this;t.groupStart("(\n  "),e.columns.forEach(function(e){n._appendColumnDefinition(t,e),t.separator(",\n  ")}),this._appendTableConstraints(t,e),t.groupEnd("\n)")},e.prototype._appendColumnDefinition=function(e,t){e.quotedName(t.name),e.sql(t.type)},e.prototype._appendTableConstraints=function(t,e){var n=e.keyColumns;0<n.length&&(t.sql("PRIMARY KEY").groupStart("("),n.forEach(function(e){t.quotedName(e.name),t.separator(", ")}),t.groupEnd(")")),t.separator(",\n  "),e.foreignKeys.forEach(function(e){t.sql("FOREIGN KEY").groupStart("("),e.columns.forEach(function(e){t.quotedName(e.name),t.separator(", ")}),t.groupEnd(")"),t.sql("REFERENCES").quotedName(e.referencedTable.dbName,e.referencedTable.name),t.groupStart("("),e.referencedColumns.forEach(function(e){t.quotedName(e.name),t.separator(", ")}),t.groupEnd(")"),t.separator(",\n  ")})},e.prototype._appendTargetColumnsList=function(t,e){t.groupStart("("),e.forEach(function(e){e instanceof ne?t.quotedName(e.name):t.quotedName(e.tableAlias,e.column.name),t.separator(", ")}),t.groupEnd(")")},e.prototype._appendResultColumnsList=function(t,e){t.groupStart(),e.forEach(function(e){e instanceof ne?t.quotedName(e.name):t.quotedName(e.tableAlias,e.column.name),t.separator(", ")}),t.groupEnd()},e.prototype._getTableIdentityKey=function(e){return e.identities},e.prototype._getColumnIdentityKey=function(e){return e.identities},e.prototype._getRelationIdentityKey=function(e){return e.identities},e.prototype._getForeignKeyIdentityKey=function(e){return e.identities},e.prototype._getIndexIdentityKey=function(e){return e.identities},e}(),oe=function(){function e(){this._listeners=[]}return e.prototype.add=function(e){this._listeners.push(e)},e.prototype.remove=function(e){for(var t=0;t<this._listeners.length;t++)if(this._listeners[t]===e)return void this._listeners.splice(t,1)},e.prototype.notifyBegunTransaction=function(e){this._notify("begunTransaction",{readOnly:!e})},e.prototype.notifyResolvedTransaction=function(e,t){this._notify("resolvedTransaction",{readOnly:!e,committed:t})},e.prototype.notifyExecutingSql=function(e,t){this._notify("executingCommand",{command:e,commandParameters:t||[]})},e.prototype.notifyExecutedSql=function(e,t,n){this._notify("executedCommand",{command:e,commandParameters:t||[],commandError:n?n.message:null})},e.prototype._notify=function(e,t){for(var n=0;n<this._listeners.length;n++){this._listeners[n][e](t)}},e}(),ie=function(){function e(){}return e.prototype.executeQuery=function(e,n,r,t,o){var i=e.getDatabase(),a=n.inputData.map(function(e){var t=r[e.parameterName];return void 0!==t&&void 0!==e.elementIndex&&(t=t[e.elementIndex]),e.converter.toSQL(t)});e.runInTransaction(function(e){s(i,e,n.sql,a,t,function(e,t){o(e,t,n.sql,a)})})},e}(),ae=(K=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}K(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),ue=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return ae(t,e),t}(ie),se=(J=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}J(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),le=function(n){function e(e){var t=n.call(this)||this;return t._queryTemplate=e,t}return se(e,n),e.prototype.execute=function(e,t,n,r){var o=this._queryTemplate.expand(t);this.executeQuery(e,o,t,function(e,t){n(t.rowsAffected)},c(r))},e.prototype.computeExpectedInputCount=function(e){return this._queryTemplate.expand(e).inputData.length},e}(ue),pe=(Y=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}Y(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),ce=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return pe(t,e),t.prototype.execute=function(e,t,n,r){var o=[];this.executeScan(e,t,o.push.bind(o),function(){return n(o)},r)},t}(ie),de=(H=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}H(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),fe=function(r){function e(e,t){var n=r.call(this)||this;return n._queryTemplate=e,n._assemblerFactory=t,n}return de(e,r),e.prototype.executeScan=function(e,t,n,r,o){var i=this,a=this._queryTemplate.expand(t);this.executeQuery(e,a,t,function(e,t){i._scanObjects(t,i._assemblerFactory.createAssembler(),n),r()},c(o))},e.prototype._scanObjects=function(e,t,n){for(var r=e.rows,o=0;o<r.length;o++){var i=t(r.item(o));i&&n(i)}},e.prototype.computeExpectedInputCount=function(e){return this._queryTemplate.expand(e).inputData.length},e}(ce),he=function(){function e(e){this._purposeLabel=e,this._list=[],this._map={}}return e.prototype.getSize=function(){return this._list.length},e.prototype.getAll=function(){return this._list},e.prototype.get=function(e){return this._doGet(e,void 0)},e.prototype.getSpecific=function(e,t){return this._doGet(e,t)},e.prototype._doGet=function(e,t){var n=this._computeKey(e,t);return this._map[n]||null},e.prototype.has=function(e){return this._doHas(e,void 0)},e.prototype.hasSpecific=function(e,t){return this._doHas(e,t)},e.prototype._doHas=function(e,t){var n=this._computeKey(e,t);return!!this._map[n]},e.prototype.add=function(e,t){this._doAdd(e,void 0,t)},e.prototype.addSpecific=function(e,t,n){this._doAdd(e,t,n),this._doHas(e,void 0)||this._doAdd(e,void 0,n,!0)},e.prototype._doAdd=function(e,t,n,r){var o=this._computeKey(e,t);if(this._map[o])throw new Error(this._computeKeyMessage(e,t)+" already added as "+this._purposeLabel);this._map[o]=n,r||this._list.push(n)},e.prototype._computeKey=function(e,t){var n='"'+e.table.name+'"."'+e.name+'"';return void 0!==t?n+","+String(t):n},e.prototype._computeKeyMessage=function(e,t){var n="Column "+e+" of table "+e.table;return void 0!==t&&(n+=" as '"+t+"'"),n},e}();!function(e){var t=function(){function e(e){this._prefix=e+" ("}return e.prototype.appendExpansion=function(e,t){e.sql(this._prefix).sql(t[0](e)).sql(")")},e}();e.Unary=t;var n=function(){function e(e){this._infix=") "+e+" ("}return e.prototype.appendExpansion=function(e,t){e.groupStart("(");for(var n=0;n<t.length;n++)t[n](e),e.separator(this._infix);e.groupEnd(")")},e}();e.Binary=n}(X||(X={})),function(e){var t=function(){function e(e,t){this._prefixSQL=e,this._suffixSQL=t}return e.prototype.appendExpansion=function(e,t,n,r){this._prefixSQL&&e.sql(this._prefixSQL),n(e),this._suffixSQL&&e.sql(this._suffixSQL)},e}();e.Unary=t;var r=function(){function e(e){this._operatorSQL=e}return e.prototype.appendExpansion=function(e,t,n,i){if(!i)throw new Error("Must supply a right operand");n(e),e.sql(this._operatorSQL),e.expansion(function(e){var t=i.appender,n=e[i.parameterName],r=new j;if(r.groupStart("("),n&&Array.isArray(n)){if(n.length<=0)throw new Error("Empty array parameter '"+i.parameterName+"'");for(var o=0;o<n.length;o++)t(r,o),r.separator(",")}else t(r);return r.groupEnd(")"),r.build()})},e}();e.Collection=r;var o=function(){function r(e,t,n,r){void 0===r&&(r=!1),this._prefixSQL=e,this._operatorSQL=t,this._suffixSQL=n,this._comparison=r}return r.prototype.appendExpansion=function(e,t,o,i){var a=this;if(!i)throw new Error("Must supply a right operand");o=this._prepareLeftOperandAppender(o,t);var u=this._prepareRightOperandAppender(i.appender,t),n=i.internalOperator||d.CollectionOperator.ANY,s=r._INTERNAL_OPERATOR_INFIXES[n];if(!s)throw new Error("Invalid internal operator '"+n+"'");e.expansion(function(e){var t=e[i.parameterName],n=new j;if(t&&Array.isArray(t)){if(n.groupStart("("),t.length<=0)throw new Error("Empty array parameter '"+i.parameterName+"'");for(var r=0;r<t.length;r++)a._prefixSQL&&n.sql(a._prefixSQL),o(n),n.sql(a._operatorSQL),u(n,r),a._suffixSQL&&n.sql(a._suffixSQL),n.separator(s);n.groupEnd(")")}else a._prefixSQL&&n.sql(a._prefixSQL),o(n),n.sql(a._operatorSQL),u(n),a._suffixSQL&&n.sql(a._suffixSQL);return n.build()})},r.prototype._prepareLeftOperandAppender=function(e,t){if(this._comparison){var n=e;e=function(e){t.appendComparableTermExpansion(e,n)}}return e},r.prototype._prepareRightOperandAppender=function(e,n){if(this._comparison){var r=e;e=function(e,t){n.appendComparableTermExpansion(e,function(e){r(e,t)})}}return e},r._INTERNAL_OPERATOR_INFIXES=((n={})[d.CollectionOperator.ALL]=") AND (",n[d.CollectionOperator.ANY]=") OR (",n),r}();e.Binary=o;var n,i=function(){function e(e,t,n){this._collectionHandlers={},this._scalarHandler=new o(null,e,null),t&&(this._collectionHandlers[d.CollectionOperator.ALL]=new r(t)),n&&(this._collectionHandlers[d.CollectionOperator.ANY]=new r(n))}return e.prototype.appendExpansion=function(e,t,n,r){if(!r)throw new Error("Must supply a right operand");var o=r.internalOperator||d.CollectionOperator.ANY,i=this._collectionHandlers[o];return i?i.appendExpansion(e,t,n,r):this._scalarHandler.appendExpansion(e,t,n,r)},e}();e.OptimizedBinary=i}(z||(z={})),function(e){e.LOGIC=((t={})[d.LogicOperator.NOT]=new X.Unary("NOT"),t[d.LogicOperator.AND]=new X.Binary("AND"),t[d.LogicOperator.OR]=new X.Binary("OR"),t);var t,n,r="REPLACE(REPLACE(",o=",'*','[*]'),'?','[?]')";e.VALUE=((n={})[d.ValueOperator.EMPTY]=new z.Unary(null,"= ''"),n[d.ValueOperator.NOT_EMPTY]=new z.Unary(null,"<> ''"),n[d.ValueOperator.NULL]=new z.Unary(null,"IS NULL"),n[d.ValueOperator.NOT_NULL]=new z.Unary(null,"IS NOT NULL"),n[d.ValueOperator.IN]=new z.Collection("IN"),n[d.ValueOperator.NOT_IN]=new z.Collection("NOT IN"),n[d.ValueOperator.EQUAL]=new z.OptimizedBinary("=",null,"IN"),n[d.ValueOperator.EQUAL_IGNORE_CASE]=new z.Binary("LOWER(",") = LOWER(",")"),n[d.ValueOperator.NOT_EQUAL]=new z.OptimizedBinary("<>","NOT IN",null),n[d.ValueOperator.NOT_EQUAL_IGNORE_CASE]=new z.Binary("LOWER(",") <> LOWER(",")"),n[d.ValueOperator.GREATER]=new z.Binary(null,">",null,!0),n[d.ValueOperator.GREATER_OR_EQUAL]=new z.Binary(null,">=",null,!0),n[d.ValueOperator.LESSER]=new z.Binary(null,"<",null,!0),n[d.ValueOperator.LESSER_OR_EQUAL]=new z.Binary(null,"<=",null,!0),n[d.ValueOperator.BEGINNING]=new z.Binary(null,"GLOB "+r,o+" || '*'"),n[d.ValueOperator.BEGINNING_IGNORE_CASE]=new z.Binary("LOWER(",") GLOB "+r+"LOWER(",")"+o+" || '*'"),n[d.ValueOperator.NOT_BEGINNING]=new z.Binary(null,"NOT GLOB "+r,o+" || '*'"),n[d.ValueOperator.NOT_BEGINNING_IGNORE_CASE]=new z.Binary("LOWER(",") NOT GLOB "+r+"LOWER(",")"+o+" || '*'"),n[d.ValueOperator.CONTAINING]=new z.Binary(null,"GLOB '*' || "+r,o+" || '*'"),n[d.ValueOperator.CONTAINING_IGNORE_CASE]=new z.Binary("LOWER(",") GLOB '*' || "+r+"LOWER(",")"+o+" || '*'"),n[d.ValueOperator.NOT_CONTAINING]=new z.Binary(null,"NOT GLOB '*' || "+r,o+" || '*'"),n[d.ValueOperator.NOT_CONTAINING_IGNORE_CASE]=new z.Binary("LOWER(",") NOT GLOB '*' || "+r+"LOWER(",")"+o+" || '*'"),n[d.ValueOperator.ENDING]=new z.Binary(null,"GLOB '*' || "+r,o+""),n[d.ValueOperator.ENDING_IGNORE_CASE]=new z.Binary("LOWER(",") GLOB '*' || "+r+"LOWER(",")"+o),n[d.ValueOperator.NOT_ENDING]=new z.Binary(null,"NOT GLOB '*' || "+r,o+""),n[d.ValueOperator.NOT_ENDING_IGNORE_CASE]=new z.Binary("LOWER(",") NOT GLOB '*' || "+r+"LOWER(",")"+o),n)}($||($={}));var me,_e=function(){function e(e){this._expansions=[],this._queryBuilder=new j(e)}return e.prototype.toString=function(){return this._queryBuilder.toString()},e.prototype.groupStart=function(e){return this._queryBuilder.groupStart(e),this},e.prototype.separator=function(e){return this._queryBuilder.separator(e),this},e.prototype.groupEnd=function(e){return this._queryBuilder.groupEnd(e),this},e.prototype.sql=function(e){return this._queryBuilder.sql(e),this},e.prototype.name=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this._queryBuilder.name.apply(this._queryBuilder,e),this},e.prototype.quotedName=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this._queryBuilder.quotedName.apply(this._queryBuilder,e),this},e.prototype.inputPlaceholder=function(e){return this._queryBuilder.inputPlaceholder(e),this},e.prototype.fragment=function(e){return this._queryBuilder.fragment(e),this},e.prototype.expansion=function(e){var t;if((t="function"==typeof e?new ye(e):e).isConstant()){var n=t.expand(void 0);return this._queryBuilder.fragment(n),this}var r=this._expansions.length;return this._expansions.push({template:t,inputOffset:this._queryBuilder.getInputCount()}),this._queryBuilder.sql("@"+r+"@"),this},e.prototype.createAlias=function(e){return this._queryBuilder.createAlias(e)},e.prototype.build=function(){return 0<this._expansions.length?new Ee(this._queryBuilder,this._expansions):new be(this._queryBuilder)},e}(),ye=function(){function e(e){this.expand=e}return e.prototype.isConstant=function(){return!1},e}(),be=function(){function e(e){this._query=e.build()}return e.prototype.isConstant=function(){return!0},e.prototype.expand=function(e){return this._query},e}(),Ee=function(){function e(e,t){this._query=e.build(),this._expansions=t.slice()}return e.prototype.isConstant=function(){return!1},e.prototype.expand=function(o){var i=this,t=this._query.inputData,n=0;function a(e){n<e&&(Array.prototype.push.apply(u,t.slice(n,e)),n=e)}var u=[],e=this._query.sql.replace(/@(\d+)@/g,function(e,t){var n=i._expansions[Number(t)],r=n.template.expand(o);return a(n.inputOffset),Array.prototype.push.apply(u,r.inputData),r.sql});return a(t.length),new V(e,u)},e}(),ve=(me=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}me(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),ge=function(o){function n(e,t,n){var r=o.call(this)||this;return r.columns=[],r.keyColumns=[],r.columnsByName={},r.columnsByFieldName={},r.rowidAliasColumn=null,r.attachedRelationsByEndName={},r.foreignKeys=[],r.name=e,r.dbName=t,r.identities=R(n,e),r}return ve(n,o),n.prototype._defineSchemaForField=function(e){var t=ne.fromFieldProviderSchema(e);this.addColumn(t,e.name)},n.prototype.addColumn=function(e,t){if(this.ensureNotSealed(),e.initTable(this),this.columns.push(e),e.key&&this.keyColumns.push(e),this.columnsByName[e.name])throw new Error("Column name '"+e.name+"' already in use");if(this.columnsByName[e.name]=e,t){if(this.columnsByFieldName[t])throw new Error("Column already defined for field '"+t+"'");this.columnsByFieldName[t]=e}1===this.keyColumns.length&&"INTEGER"===this.keyColumns[0].type?this.rowidAliasColumn=this.keyColumns[0]:this.rowidAliasColumn=null},n.prototype.addAttachedRelation=function(e,t,n){if(this.ensureNotSealed(),this.attachedRelationsByEndName[n])throw new Error("Relation end name '"+n+"' already attached");this.attachedRelationsByEndName[n]={relation:e,side:t}},n.prototype.addForeignKey=function(e){if(this.ensureNotSealed(),e.columns[0].table!==this)throw new Error("Foreign key is not based on this table");this.foreignKeys.push(e)},n.prototype.seal=function(){this.columns.forEach(function(e){e.seal()}),this.foreignKeys.forEach(function(e){e.seal()}),o.prototype.seal.call(this)},n.prototype.toString=function(){return this.name},n.fromStoreProviderSchema=function(e){var t=new n(e.properties.tableName||e.name,"main",e.identities);return e.fields.forEach(t._defineSchemaForField,t),t},n}(I),Te=function(){function e(e,t,n){this._outputRowidPropertyName=null;var r=(this.db=e).getSchema();this._storeOrRelationName=t,this._worker=new Ue(r,t,!(!n||!n.forbidJoins)),this._flatWorker=n&&n.flatVariants?new Ue(r,t,!0):null}return e.prototype.includeInputField=function(t,n){this._invokeWorkers(function(e){e.includeInputField(t,n)})},e.prototype.includeOutputRowid=function(e){if(this._outputRowidPropertyName)throw new Error("Rowid already included as output");this._outputRowidPropertyName=e},e.prototype.includeOutputField=function(t,n){this._invokeWorkers(function(e){e.includeOutputField(t,n)})},e.prototype.includeFilter=function(t){this._invokeWorkers(function(e){e.includeFilter(t)})},e.prototype.includeFilterOnRowid=function(t){this._invokeWorkers(function(e){e.includeFilterOnRowid(t)})},e.prototype.includeOrderTerm=function(t){this._invokeWorkers(function(e){e.includeOrderTerm(t)})},e.prototype.includeLimit=function(t){this._invokeWorkers(function(e){e.includeLimit(t)})},e.prototype._invokeWorkers=function(e){e.call(this,this._worker),this._flatWorker&&(this._worker._joined?this._flatWorker=null:e.call(this,this._flatWorker))},e.prototype.getInputColumn=function(e){var t=this._getWorker()._inputColumns.get(e);return t?this._createInputColumnInputInfo(t):null},e.prototype._createInputColumnInputInfo=function(e){return{parameterName:e.valueParameter,elementIndex:void 0,converter:e.column.converter}},e.prototype.getResultColumns=function(){var e=this._getWorker()._resultColumns.getAll().map(this._createResultColumnOutputInfo,this);return this._outputRowidPropertyName&&e.unshift({alias:We,converter:G[ee],propertyName:this._outputRowidPropertyName}),e},e.prototype.getResultColumn=function(e){var t=this._getWorker()._resultColumns.get(e);return t?this._createResultColumnOutputInfo(t):null},e.prototype._createResultColumnOutputInfo=function(e){return{alias:e.alias,converter:e.column.converter,propertyName:e.propertyName}},e.prototype.hasOrderColumn=function(e){return this._getWorker()._orderColumns.has(e)},e.prototype.isJoined=function(){return this._getWorker()._joined},e.prototype.isJoinedToMany=function(){return this._getWorker()._joinedToMany},e.prototype.getBaseDataSet=function(){return this._getWorker()._baseDataSet},e.prototype.getDataSets=function(){var e=this._getWorker();return[e._baseDataSet].concat(e._dataSets)},e.prototype.isRowidAliasField=function(e){var t=this._getWorker(),n=t.parseFieldPath(e),r=t._baseDataSet;return t.locateFieldColumn(r.element,n.relationEndNames,n.fieldName)===this.getRowidAliasColumn()},e.prototype.getRowidAliasColumn=function(){var e=this.getBaseDataSet();return e.element instanceof ge?e.element.rowidAliasColumn:e.element.accessor.getBaseTable().rowidAliasColumn},e.prototype.isFlatQueriesOnly=function(){return this._getWorker()===this._flatWorker},e.prototype.buildTableExpression=function(){var e=this._getBaseTable();return(new j).quotedName(e.dbName,e.name).buildSQL()},e.prototype.buildResultList=function(e){var t=this._getWorker(),n=t._resultColumns.getAll();if(e&&0<e.length&&(n=n.concat(e)),!this._outputRowidPropertyName&&n.length<=0)return"NULL";var r=new j;return r.groupStart(),this._outputRowidPropertyName&&(r.quotedName(t._baseDataSet.alias||"",Z),r.sql("AS").name(We),r.separator(", ")),n.forEach(function(e){r.quotedName(e.dataSet.alias||"",e.column.name),r.sql("AS").name(e.alias),r.separator(", ")}),r.groupEnd(),r.buildSQL()},e.prototype.buildFromExpression=function(){return this._getWorker()._fromBuilder.buildSQL()},e.prototype.buildInsertList=function(){var e=this._getWorker()._inputColumns.getAll();if(e.length<=0)throw new Error("No input columns specified");var t=new j;return t.groupStart("("),e.forEach(function(e){t.quotedName(e.column.name),t.separator(",")}),t.groupEnd(")"),t.buildSQL()},e.prototype.buildValuesList=function(){var t=this,e=this._getWorker()._inputColumns.getAll();if(e.length<=0)throw new Error("No input columns specified");var n=new j;return n.groupStart("("),e.forEach(function(e){n.inputPlaceholder(t._createInputColumnInputInfo(e)),n.separator(",")}),n.groupEnd(")"),n.build()},e.prototype.buildSetList=function(){var t=this,e=this._getWorker()._inputColumns.getAll();if(e.length<=0)throw new Error("No input columns specified");var n=new j;return n.groupStart(),e.forEach(function(e){n.quotedName(e.column.name),n.sql("=").inputPlaceholder(t._createInputColumnInputInfo(e)),n.separator(", ")}),n.groupEnd(),n.build()},e.prototype.isWhereExpressionAvailable=function(){return!!this._getWorker()._whereBuilder},e.prototype.buildWhereExpression=function(){var e=this._getWorker();if(!e._whereBuilder)throw new Error("No filters specified");return e._whereBuilder.build()},e.prototype.buildWhereSubQuery=function(){var e=this._getWorker()._baseDataSet.alias,t=new _e;return t.sql("SELECT"),t.quotedName(e||"",Z),t.sql("FROM").sql(this.buildFromExpression()),this.isWhereExpressionAvailable()&&t.sql("WHERE").expansion(this.buildWhereExpression()),t.build()},e.prototype.buildFlatWhereOnRowid=function(n){var e=$.VALUE[d.ValueOperator.IN],r=G[ee],t={appender:function(e,t){e.inputPlaceholder({parameterName:n,elementIndex:t,converter:r})},parameterName:n,internalOperator:d.CollectionOperator.ANY},o=new _e;return e.appendExpansion(o,r,function(e){return e.quotedName("",Z)},t),o.build()},e.prototype.isRelationInsertionByUpdate=function(){return this._getBaseRelation().accessor.insertsByUpdating()},e.prototype.buildRelationTupleInsertionQuery=function(){var r=this,o=this._getWorker(),e=new _e;return this._getBaseRelation().accessor.appendTupleInsertion(e,function(e,t){var n=o._inputColumns.get(t);if(!n)throw new Error("Must provide an input for column '"+t+"'");e.inputPlaceholder(r._createInputColumnInputInfo(n))}),e.build()},e.prototype.buildRelationTupleUpdatingQueryProlog=function(){var r=this,o=this._getWorker(),e=new j;return this._getBaseRelation().accessor.appendTupleUpdating(e,function(e,t){var n=o._inputColumns.get(t);if(!n)throw new Error("Must provide an input for column '"+t+"'");e.inputPlaceholder(r._createInputColumnInputInfo(n))},function(e){return o._inputColumns.has(e)}),e.build()},e.prototype.buildRelationTupleDeletionQueryProlog=function(){var e=new j;return this._getBaseRelation().accessor.appendTupleDeletion(e),e.buildSQL()},e.prototype.isOrderExpressionAvailable=function(){return!!(0<this._getWorker()._orderColumns.getSize())},e.prototype.buildOrderExpression=function(e){var t=this._getWorker()._orderColumns.getAll();if(e&&0<e.length&&(t=t.concat(e)),t.length<=0)throw new Error("No order terms specified");var n=new j;return n.groupStart(),t.forEach(function(t){t.column.converter.appendComparableTermExpansion(n,function(e){e.quotedName(t.dataSet.alias||"",t.column.name)}),t.descending&&n.sql("DESC"),n.separator(", ")}),n.groupEnd(),n.buildSQL()},e.prototype.isLimitExpressionAvailable=function(){return!!this._getWorker()._limit},e.prototype.buildLimitExpression=function(){var e=this._getWorker()._limit;if(!e)throw new Error("No limit specified");var t=new j;return t.sql(String(e.count)),void 0!==e.offset&&t.sql("OFFSET").sql(String(e.offset)),t.buildSQL()},e.prototype._getBaseTable=function(){var e=this._getWorker()._baseDataSet.element;if(!(e instanceof ge))throw new Error("Not based on a table");return e},e.prototype._getBaseRelation=function(){var e=this._getWorker()._baseDataSet.element;if(!(e instanceof L))throw new Error("Not based on a relation");return e},e.prototype._getWorker=function(){return this._flatWorker||this._worker},e.prototype.createRelatedBuilder=function(e){return new e(this.db,this._storeOrRelationName)},e}();function Oe(e,t){var n;if(!(n=e instanceof L?e.accessor.getConnectionRelation(t):e.attachedRelationsByEndName[t]))throw new Error("Unknown relation end '"+t+"' at "+(e instanceof L?"relation ":"table ")+e);return n}var we,Ne,Se,Re,Ae,Ce,xe,Ie,qe,Le,Pe,Fe,ke,Be,De,Qe,We="rowid",Ue=function(){function e(e,t,n){this._fromBuilder=new j,this._whereBuilder=null,this._inputColumns=new he("input"),this._resultColumns=new he("result"),this._orderColumns=new he("order term"),this._limit=null,this._dataSetsMap={},this._dataSets=[],this._joined=!1,this._joinedToMany=!1,this._noJoins=n,this._baseDataSet=this._createBaseDataSet(e,t)}return e.prototype.includeInputField=function(e,t){var n=this._includeField(e);this._inputColumns.add(n.column,{column:n.column,valueParameter:t})},e.prototype.includeOutputField=function(e,t){var n=this._includeField(e),r="o"+this._resultColumns.getSize();this._resultColumns.addSpecific(n.column,r,{dataSet:n.dataSet,column:n.column,alias:r,propertyName:t}),n.dataSet.usedInResults=!0},e.prototype.includeFilterOnRowid=function(e){var t=this._whereBuilder;t?t.sql("AND"):this._whereBuilder=t=new _e,t.groupStart("("),this._appendFilterOnRowidTerm(t,e),t.groupEnd(")")},e.prototype._appendFilterOnRowidTerm=function(e,n){var t=this,r=$.VALUE[d.ValueOperator.IN],o=G[ee],i={appender:function(e,t){e.inputPlaceholder({parameterName:n,elementIndex:t,converter:o})},parameterName:n,internalOperator:d.CollectionOperator.ANY};r.appendExpansion(e,o,function(e){return e.quotedName(t._baseDataSet.alias||"",Z)},i)},e.prototype.includeFilter=function(e){var t=this._whereBuilder;t?t.sql("AND"):this._whereBuilder=t=new _e,t.groupStart("("),this._appendFilter(t,e),t.groupEnd(")")},e.prototype._appendFilter=function(e,t){d.Provider.FilterExpression.isFilterTerm(t)?this._appendFilterTerm(e,t):this._appendFilterLogicExpression(e,t)},e.prototype._appendFilterLogicExpression=function(e,t){var n=this,r=$.LOGIC[t.operator];if(!r)throw new Error("Unknown logic operator '"+t.operator+"'");var o=t.operands.map(function(t){return function(e){return n._appendFilter(e,t)}});r.appendExpansion(e,o)},e.prototype._appendFilterTerm=function(e,t){var n=$.VALUE[t.operator];if(!n)throw new Error("Unknown value operator '"+t.operator+"'");var r=this._includeField(t.fieldPath),o=void 0;if(void 0!==t.valueParameter){var i=t.valueParameter;o={appender:function(e,t){e.inputPlaceholder({parameterName:i,elementIndex:t,converter:r.column.converter})},parameterName:t.valueParameter,internalOperator:t.internalOperator}}n.appendExpansion(e,r.column.converter,function(e){e.quotedName(r.dataSet.alias||"",r.column.name)},o)},e.prototype.includeOrderTerm=function(e){var t=this._includeField(e.fieldPath);this._orderColumns.add(t.column,{dataSet:t.dataSet,column:t.column,descending:e.descending})},e.prototype._includeField=function(e){for(var t=this.parseFieldPath(e),n=t.relationEndNames,r=t.fieldName,o=null,i=-1,a=n.length;0<=a;a--)if(o=this._retrieveDataSet(n.slice(0,a))){i=a;break}var u=this.locateFieldColumn(o.element,n.slice(i),r),s=this._baseDataSet;for(a=0;a<n.length;a++){var l=Oe(s.element,n[a]),p=l.relation.accessor.getEquivalentColumn(l.side,u);if(p){u=p;break}s=this._includeDataSet(n.slice(0,a+1))}return{dataSet:s,column:u}},e.prototype.locateFieldColumn=function(e,t,n){if(t.length<=0)return function(e,t){if(e instanceof L)throw new Error("Fields not supported at relations");var n=e.columnsByFieldName[t];if(!n)throw new Error("Unknown field '"+t+"' at table '"+e+"'");return n}(e,n);var r=Oe(e,t[0]),o=r.side===g.ONE?r.relation.table2:r.relation.table1;return this.locateFieldColumn(o,t.slice(1),n)},e.prototype.parseFieldPath=function(e){var t=e.lastIndexOf(".");return t<0?{relationEndNames:[],fieldName:e}:{relationEndNames:e.substring(0,t).split("."),fieldName:e.substring(t+1)}},e.prototype.includeLimit=function(e){if(this._limit)throw new Error("Limit already added");this._limit={count:e.count,offset:e.begin}},e.prototype._createBaseDataSet=function(e,t){var n=e.tablesByStoreName[t];if(n)return this._createBaseTableDataSet(n,n);var r=e.relationsByName[t];if(r)return this._createBaseTableDataSet(r,r.accessor.getBaseTable());throw new Error("Unknown store/relation '"+t+"'")},e.prototype._createBaseTableDataSet=function(e,t){var n=this._noJoins?null:this._fromBuilder.createAlias("t");return this._fromBuilder.quotedName(t.dbName,t.name),n&&this._fromBuilder.sql("AS").quotedName(n),{element:e,table:t,many:!1,alias:n,usedInResults:!1}},e.prototype._createJoinedDataSet=function(e,t){var n=e.alias;if(this._noJoins||!n)throw new Error("Cannot join more tables");this._joined=!0;var r=Oe(e.element,t),o=r.relation,i=r.side,a=o.accessor.appendTableJoin(this._fromBuilder,i,n),u=e.many||a.many;return u&&(this._joinedToMany=!0),{element:a.table,table:a.table,many:u,alias:a.alias,usedInResults:!1}},e.prototype._retrieveDataSet=function(e){return this._retrieveOrIncludeDataSet(e,!1)},e.prototype._includeDataSet=function(e){return this._retrieveOrIncludeDataSet(e,!0)},e.prototype._retrieveOrIncludeDataSet=function(e,t){if(e.length<=0)return this._baseDataSet;var n=e.join("."),r=this._dataSetsMap[n];if(r)return r;if(!t)return null;var o=this._includeDataSet(e.slice(0,e.length-1));return r=this._createJoinedDataSet(o,e[e.length-1]),this._dataSetsMap[n]=r,this._dataSets.push(r),r},e}(),Ve=(we=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}we(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),je=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Ve(t,e),t}(Te),Ge=function(){function e(e){this._commandBuilder=e,this.refresh()}return e.prototype.refresh=function(){var r=this._commandBuilder;if(!r.isJoined()||!r.isJoinedToMany())return this._extraResultColumns=[],this._extraOrderTerms=[],void(this._distinctAliases=null);var n=!1,o=[];r.getDataSets().forEach(function(t){if(t.element instanceof ge){var e=t.element;t.usedInResults?e.keyColumns.forEach(function(e){o.push({dataSet:t,column:e})}):t.many&&(n=!0)}});var t=[];this._extraOrderTerms=t,o.forEach(function(e){r.hasOrderColumn(e.column)||t.push({dataSet:e.dataSet,column:e.column,descending:!1})});var i=[];if(this._extraResultColumns=i,n){var a=[];this._distinctAliases=a;var u=0;o.forEach(function(e){var t,n=r.getResultColumn(e.column);n?t=n.alias:(t="key"+u++,i.push({dataSet:e.dataSet,column:e.column,alias:t})),a.push(t)})}else this._distinctAliases=null},e.prototype.getExtraResultColumns=function(){return this._extraResultColumns||[]},e.prototype.getExtraOrderTerms=function(){return this._extraOrderTerms||[]},e.prototype.createAssemblerFactory=function(e){return new Me(this._distinctAliases||null,e)},e}(),Me=function(){function e(e,t){this._distinctAliases=e,this._objectPropertyInfos=t}return e.prototype.createAssembler=function(){var n=this,r=null;return function(e){var t=n._computeDistinctKey(e);return null!==t&&t===r?null:(r=t,n._buildObject(e))}},e.prototype._computeDistinctKey=function(e){var t=this._distinctAliases;if(!t)return null;for(var n="",r=0;r<t.length;r++)0<r&&(n=n.concat("_$$_")),n=n.concat(String(e[t[r]]));return n},e.prototype._buildObject=function(e){for(var t=this._objectPropertyInfos,n={},r=0;r<t.length;r++){var o=t[r],i=e[o.alias];n[o.propertyName]=o.converter.fromSQL(i)}return n},e}(),Ke=(Ne=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}Ne(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),Je=function(r){function e(e,t){var n=r.call(this,e,t)||this;return n._distinct=!1,n}return Ke(e,r),e.prototype.useDistinct=function(){if(this._distinct)throw new Error("Distinct already set");this._distinct=!0},e.prototype.addOutputField=function(e,t){this.includeOutputField(e,t)},e.prototype.addFilter=function(e){this.includeFilter(e)},e.prototype.addOrderTerm=function(e){this.includeOrderTerm(e)},e.prototype.addLimit=function(e){this.includeLimit(e)},e.prototype.build=function(){var e=new Ge(this),t=e.getExtraResultColumns(),n=e.getExtraOrderTerms(),r=new _e;r.sql(this._distinct?"SELECT DISTINCT":"SELECT"),r.sql(this.buildResultList(t)),r.sql("FROM").sql(this.buildFromExpression()),this.isWhereExpressionAvailable()&&r.sql("WHERE").expansion(this.buildWhereExpression()),(this.isOrderExpressionAvailable()||0<n.length)&&r.sql("ORDER BY").sql(this.buildOrderExpression(n)),this.isLimitExpressionAvailable()&&r.sql("LIMIT").sql(this.buildLimitExpression());var o=r.build(),i=e.createAssemblerFactory(this.getResultColumns());return new fe(o,i)},e}(je),Ye=(Se=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}Se(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),He=function(u){function d(e,t,n,r,o,i){var a=u.call(this)||this;return a._beforeFiller=null,a._afterFiller=null,a._queryTemplate=t,r&&(a._beforeFiller=d._createTrackedObjectsFillter(n)),a._beforeCommand=r,(i||o&&0<o.length)&&(a._afterFiller=d._createTrackedObjectsFillter(o)),a._afterCommand=i,a._maxStatementInputs=e.getSchema().maxStatementInputs,a}return Ye(d,u),d.prototype.execute=function(n,r,o,i){var a=this,u=[],s={};this._executeTrackingBefore(n,r,u,s,function(){if(a._beforeCommand&&u.length<=0)return o([]);var t=!a._beforeCommand;a._executeMainOperation(n,r,u,t,function(e){if(e.rowsAffected<=0)return o([]);t&&u.push(e.insertId),a._executeTrackingAfter(n,r,u,s,function(){o(u.map(function(e){return s[e]}))},i)},i)},i)},d.prototype._executeTrackingBefore=function(e,n,r,o,t,i){var a=d.ROWID_PROPERTY_NAME,u=this._beforeFiller,s=this._beforeCommand;u&&s?s.executeScan(e,n,function(e){var t=e[a];delete e[a],r.push(t),u(o,t,e,n)},t,i):t()},d.prototype._executeTrackingAfter=function(e,n,t,r,o,i){var a=d.ROWID_PROPERTY_NAME,u=this._afterFiller;u?this._afterCommand?this._scanSelectCommand(this._afterCommand,e,t,function(e){var t=e[a];delete e[a],u(r,t,e,n)},o,i):(t.forEach(function(e){u(r,e,void 0,n)}),o()):o()},d.prototype._scanSelectCommand=function(e,t,n,r,o,i){var a={};a[d.ROWID_VALUE_PARAMETER]=n;var u=e.computeExpectedInputCount(a);if(u<=this._maxStatementInputs)e.executeScan(t,a,r,o,i);else{var s=this._maxStatementInputs-(u-n.length);if(s<1)return void i(new Error("Too many parameters for tracking command execution"));this._scanSelectCommandOnChunks(e,t,n,0,s,r,o,i)}},d.prototype._scanSelectCommandOnChunks=function(e,t,n,r,o,i,a,u){var s=this,l=d.ROWID_VALUE_PARAMETER,p=n.slice(r,r+o),c={};c[l]=p,e.executeScan(t,c,i,function(){r+o<n.length?s._scanSelectCommandOnChunks(e,t,n,r+o,o,i,a,u):a()},u)},d._createTrackedObjectsFillter=function(e){var u=[],s=[];return e&&e.forEach(function(e){e.valueParameter?u.push({valueParameter:e.valueParameter,propertyName:e.propertyName}):s.push(e.propertyName)}),function(e,t,n,r){var o=e[t];o||(e[t]=o={});for(var i=0;i<u.length;i++){var a=u[i];o[a.propertyName]=r[a.valueParameter]}for(i=0;i<s.length;i++)o[s[i]]=t;n&&function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(null==e)throw new TypeError("Cannot convert first argument to object");e=Object(e);for(var r=0;r<t.length;r++){var o=t[r];if(null!=o)for(var i in o=Object(o))o.hasOwnProperty(i)&&(e[i]=o[i])}}(o,n)}},d.prototype._executeMainOperation=function(e,t,n,r,o,i){var a=[],u=Object.create(t);u[d.ROWID_VALUE_PARAMETER]=n;var s=this._queryTemplate.expand(u);if(s.inputData.length<=this._maxStatementInputs)this.executeQuery(e,s,u,function(e,t){a.push(t),p()},c(i));else{var l=this._maxStatementInputs-(s.inputData.length-n.length);if(l<1)return void i(new Error("Too many parameters for tracking command execution"));this._executeMainQueryOnChunks(a,e,t,n,0,l,p,c(i))}function p(){for(var e=r?a[0].insertId:void 0,t=0,n=0;n<a.length;n++)t+=a[n].rowsAffected;o({insertId:e,rowsAffected:t})}},d.prototype._executeMainQueryOnChunks=function(n,r,o,i,a,u,s,l){var p=this,e=i.slice(a,a+u),t=Object.create(o);t[d.ROWID_VALUE_PARAMETER]=e;var c=this._queryTemplate.expand(t);this.executeQuery(r,c,t,function(e,t){n.push(t),a+u<i.length?p._executeMainQueryOnChunks(n,r,o,i,a+u,u,s,l):s()},l)},d.prototype.computeExpectedInputCount=function(e){throw new Error("Unable to compute expect input count")},d.ROWID_PROPERTY_NAME="_rowid",d.ROWID_VALUE_PARAMETER="rowid",d}(ue),Xe=(Re=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}Re(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),ze=function(o){function e(e,t,n){var r=o.call(this,e,t,n)||this;return r._filters=null,r._beforeFields=new $e("before the command"),r._afterFields=new $e("after the command"),r._hiddenSideEffects=e.getSchema().triggersExpected,r}return Xe(e,o),e.prototype.includeBeforeTrackedField=function(e,t){this._beforeFields.add(e,t),this.isRowidAliasField(e)&&this._beforeFields.addExpectedFromRowid(e)},e.prototype.includeAfterTrackedField=function(e,t){this._afterFields.add(e,t),this.isRowidAliasField(e)&&this._afterFields.addExpectedFromRowid(e)},e.prototype.includeAfterExpectedField=function(e,t){this._hiddenSideEffects||this._afterFields.addExpectedFromParameters(e,t)},e.prototype.includeFilter=function(e){o.prototype.includeFilter.call(this,e),this._filters||(this._filters=[]),this._filters.push(e)},e.prototype.hasTrackedFields=function(){return!this._beforeFields.isEmpty()||!this._afterFields.isEmpty()},e.prototype.buildBeforeTrackingPassthroughs=function(){return this._beforeFields.getPassthrough()},e.prototype.buildBeforeTrackingCommand=function(e,t){var n=this._beforeFields.getRequired(),r=this.createRelatedBuilder(e);return r.includeOutputRowid(t),n.forEach(function(e){r.includeOutputField(e.fieldPath,e.propertyName)}),this._filters&&this._filters.forEach(function(e){return r.includeFilter(e)}),r.build()},e.prototype.buildAfterTrackingPassthroughs=function(){return this._afterFields.getPassthrough()},e.prototype.buildAfterTrackingCommand=function(e,t,n){var r=this._afterFields.getRequired();if(r.length<=0)return null;var o=this.createRelatedBuilder(e);return o.includeOutputRowid(t),r.forEach(function(e){o.includeOutputField(e.fieldPath,e.propertyName)}),o.includeFilterOnRowid(n),o.build()},e.prototype.build=function(){return this.hasTrackedFields()?this.buildTracking():this.buildNormal()},e}(Te),$e=function(){function e(e){this._purposeLabel=e,this._propertyNames=null,this._expectedValueParameters=null}return e.prototype.isEmpty=function(){return!this._added},e.prototype.add=function(e,t){if(this._propertyNames&&this._propertyNames[e])throw new Error("Field path '"+e+"' is already added for tracking "+this._purposeLabel);(this._propertyNames||(this._propertyNames={}))[e]=t,this._added=!0},e.prototype.addExpectedFromRowid=function(e){this._expectedValueParameters&&this._expectedValueParameters[e]||((this._expectedValueParameters||(this._expectedValueParameters={}))[e]=null)},e.prototype.addExpectedFromParameters=function(e,t){if(this._expectedValueParameters&&this._expectedValueParameters[e])throw new Error("Field path '"+e+"' has already an expected value for tracking "+this._purposeLabel);(this._expectedValueParameters||(this._expectedValueParameters={}))[e]=t},e.prototype.getRequired=function(){var t=this,n=this._propertyNames;if(!n)return[];var r=[];return Object.keys(n).forEach(function(e){t._expectedValueParameters&&void 0!==t._expectedValueParameters[e]||r.push({fieldPath:e,propertyName:n[e]})}),r},e.prototype.getPassthrough=function(){var n=this._propertyNames,r=this._expectedValueParameters;if(!n||!r)return[];var o=[];return Object.keys(n).forEach(function(e){var t=r[e];void 0!==t&&o.push({valueParameter:t,propertyName:n[e]})}),o},e}(),Ze=(Ae=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}Ae(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),et=function(n){function e(e,t){return n.call(this,e,t,{flatVariants:!0})||this}return Ze(e,n),e.prototype.addFilter=function(e){this.includeFilter(e)},e.prototype.addOutputField=function(e,t){this.includeBeforeTrackedField(e,t)},e.prototype.buildNormal=function(){var e=new _e;e.sql(this.buildRelationTupleDeletionQueryProlog()),this.isWhereExpressionAvailable()&&(e.sql("WHERE"),this.isFlatQueriesOnly()?e.expansion(this.buildWhereExpression()):(e.sql(Z).sql("IN").groupStart("("),e.expansion(this.buildWhereSubQuery()),e.groupEnd(")")));var t=e.build();return new le(t)},e.prototype.buildTracking=function(){var e=this.buildBeforeTrackingPassthroughs(),t=this.buildBeforeTrackingCommand(Je,He.ROWID_PROPERTY_NAME),n=new _e;n.sql(this.buildRelationTupleDeletionQueryProlog()),n.sql("WHERE"),n.expansion(this.buildFlatWhereOnRowid(He.ROWID_VALUE_PARAMETER));var r=n.build();return new He(this.db,r,e,t,null,null)},e}(ze),tt=(Ce=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}Ce(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),nt=function(r){function e(e,t){var n=r.call(this,e,t)||this;return n._distinct=!1,n}return tt(e,r),e.prototype.useDistinct=function(){if(this._distinct)throw new Error("Distinct already set");this._distinct=!0},e.prototype.addOutputField=function(e,t){this.includeOutputField(e,t)},e.prototype.addFilter=function(e){this.includeFilter(e)},e.prototype.addOrderTerm=function(e){this.includeOrderTerm(e)},e.prototype.addLimit=function(e){this.includeLimit(e)},e.prototype.build=function(){var e=new Ge(this),t=e.getExtraResultColumns(),n=e.getExtraOrderTerms(),r=new _e;r.sql(this._distinct?"SELECT DISTINCT":"SELECT"),r.sql(this.buildResultList(t)),r.sql("FROM").sql(this.buildFromExpression()),this.isWhereExpressionAvailable()&&r.sql("WHERE").expansion(this.buildWhereExpression()),(this.isOrderExpressionAvailable()||0<n.length)&&r.sql("ORDER BY").sql(this.buildOrderExpression(n)),this.isLimitExpressionAvailable()&&r.sql("LIMIT").sql(this.buildLimitExpression());var o=r.build(),i=e.createAssemblerFactory(this.getResultColumns());return new fe(o,i)},e}(je),rt=(xe=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}xe(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),ot=function(n){function e(e,t){return n.call(this,e,t,{forbidJoins:!0})||this}return rt(e,n),e.prototype.addInputField=function(e,t){this.includeInputField(e,t),this.includeAfterExpectedField(e,t)},e.prototype.addOutputField=function(e,t){this.includeAfterTrackedField(e,t)},e.prototype.buildNormal=function(){var e=this.buildRelationTupleInsertionQuery();return new le(e)},e.prototype.buildTracking=function(){return this.isRelationInsertionByUpdate()?this._buildTrackingForUpdate():this._buildTrackingForInsert()},e.prototype._buildTrackingForInsert=function(){var e=this.buildAfterTrackingPassthroughs(),t=this.buildAfterTrackingCommand(nt,He.ROWID_PROPERTY_NAME,He.ROWID_VALUE_PARAMETER),n=this.buildRelationTupleInsertionQuery();return new He(this.db,n,null,null,e,t)},e.prototype._buildTrackingForUpdate=function(){var e=this.getRowidAliasColumn();if(!e)throw new Error("No rowid alias on relation base table");var t=this.getInputColumn(e);if(!t)throw new Error("Must provide an input for rowid column");var n=new it(t),r=this.buildAfterTrackingPassthroughs(),o=this.buildAfterTrackingCommand(nt,He.ROWID_PROPERTY_NAME,He.ROWID_VALUE_PARAMETER),i=this.buildRelationTupleInsertionQuery();return new He(this.db,i,null,n,r,o)},e}(ze),it=function(n){function e(e){var t=n.call(this)||this;return t._rowidParameterName=e.parameterName,t}return rt(e,n),e.prototype.executeScan=function(e,t,n,r,o){var i={};i[He.ROWID_PROPERTY_NAME]=t[this._rowidParameterName],n(i),r()},e.prototype.computeExpectedInputCount=function(e){throw new Error("Unable to compute expect input count")},e}(ce),at=(Ie=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}Ie(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),ut=function(n){function e(e,t){return n.call(this,e,t,{flatVariants:!0})||this}return at(e,n),e.prototype.addInputField=function(e,t){this.includeInputField(e,t),this.includeAfterExpectedField(e,t)},e.prototype.addFilter=function(e){this.includeFilter(e)},e.prototype.addOutputField=function(e,t,n){t?this.includeBeforeTrackedField(e,n):this.includeAfterTrackedField(e,n)},e.prototype.buildNormal=function(){var e=new _e;e.fragment(this.buildRelationTupleUpdatingQueryProlog()),this.isWhereExpressionAvailable()&&(e.sql("WHERE"),this.isFlatQueriesOnly()?e.expansion(this.buildWhereExpression()):(e.sql(Z).sql("IN").groupStart("("),e.expansion(this.buildWhereSubQuery()),e.groupEnd(")")));var t=e.build();return new le(t)},e.prototype.buildTracking=function(){var e=this.buildBeforeTrackingPassthroughs(),t=this.buildBeforeTrackingCommand(Je,He.ROWID_PROPERTY_NAME),n=this.buildAfterTrackingPassthroughs(),r=this.buildAfterTrackingCommand(Je,He.ROWID_PROPERTY_NAME,He.ROWID_VALUE_PARAMETER),o=new _e;o.fragment(this.buildRelationTupleUpdatingQueryProlog()),o.sql("WHERE"),o.expansion(this.buildFlatWhereOnRowid(He.ROWID_VALUE_PARAMETER));var i=o.build();return new He(this.db,i,e,t,n,r)},e}(ze),st=(qe=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}qe(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),lt=function(n){function e(e,t){return n.call(this,e,t,{flatVariants:!0})||this}return st(e,n),e.prototype.addFilter=function(e){this.includeFilter(e)},e.prototype.addOutputField=function(e,t){this.includeBeforeTrackedField(e,t)},e.prototype.buildNormal=function(){var e=new _e;e.sql("DELETE FROM").sql(this.buildTableExpression()),this.isWhereExpressionAvailable()&&(e.sql("WHERE"),this.isFlatQueriesOnly()?e.expansion(this.buildWhereExpression()):(e.sql(Z).sql("IN").groupStart("("),e.expansion(this.buildWhereSubQuery()),e.groupEnd(")")));var t=e.build();return new le(t)},e.prototype.buildTracking=function(){var e=this.buildBeforeTrackingPassthroughs(),t=this.buildBeforeTrackingCommand(nt,He.ROWID_PROPERTY_NAME),n=new _e;n.sql("DELETE FROM").sql(this.buildTableExpression()),n.sql("WHERE"),n.expansion(this.buildFlatWhereOnRowid(He.ROWID_VALUE_PARAMETER));var r=n.build();return new He(this.db,r,e,t,null,null)},e}(ze),pt=(Le=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}Le(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),ct=function(n){function e(e,t){return n.call(this,e,t,{forbidJoins:!0})||this}return pt(e,n),e.prototype.addInputField=function(e,t){this.includeInputField(e,t),this.includeAfterExpectedField(e,t)},e.prototype.addOutputField=function(e,t){this.includeAfterTrackedField(e,t)},e.prototype.buildNormal=function(){var e=new _e;e.sql("INSERT INTO").sql(this.buildTableExpression()),e.sql(this.buildInsertList()),e.sql("VALUES").fragment(this.buildValuesList());var t=e.build();return new le(t)},e.prototype.buildTracking=function(){var e=this.buildAfterTrackingPassthroughs(),t=this.buildAfterTrackingCommand(nt,He.ROWID_PROPERTY_NAME,He.ROWID_VALUE_PARAMETER),n=new _e;n.sql("INSERT INTO").sql(this.buildTableExpression()),n.sql(this.buildInsertList()),n.sql("VALUES").fragment(this.buildValuesList());var r=n.build();return new He(this.db,r,null,null,e,t)},e}(ze),dt=(Pe=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}Pe(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),ft=function(n){function e(e,t){return n.call(this,e,t,{flatVariants:!0})||this}return dt(e,n),e.prototype.addInputField=function(e,t){this.includeInputField(e,t),this.includeAfterExpectedField(e,t)},e.prototype.addFilter=function(e){this.includeFilter(e)},e.prototype.addOutputField=function(e,t,n){t?this.includeBeforeTrackedField(e,n):this.includeAfterTrackedField(e,n)},e.prototype.buildNormal=function(){var e=new _e;e.sql("UPDATE").sql(this.buildTableExpression()),e.sql("SET").fragment(this.buildSetList()),this.isWhereExpressionAvailable()&&(e.sql("WHERE"),this.isFlatQueriesOnly()?e.expansion(this.buildWhereExpression()):(e.sql(Z).sql("IN").groupStart("("),e.expansion(this.buildWhereSubQuery()),e.groupEnd(")")));var t=e.build();return new le(t)},e.prototype.buildTracking=function(){var e=this.buildBeforeTrackingPassthroughs(),t=this.buildBeforeTrackingCommand(nt,He.ROWID_PROPERTY_NAME),n=this.buildAfterTrackingPassthroughs(),r=this.buildAfterTrackingCommand(nt,He.ROWID_PROPERTY_NAME,He.ROWID_VALUE_PARAMETER),o=new _e;o.sql("UPDATE").sql(this.buildTableExpression()),o.sql("SET").fragment(this.buildSetList()),o.sql("WHERE"),o.expansion(this.buildFlatWhereOnRowid(He.ROWID_VALUE_PARAMETER));var i=o.build();return new He(this.db,i,e,t,n,r)},e}(ze),ht=(Fe=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}Fe(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),mt=function(o){function i(e,t,n){var r=o.call(this)||this;return i._validate(e,t,n),r.columns=e.slice(),r.referencedTable=t,r.referencedColumns=n.slice(),r.identities=A(":fk:/",C.apply(void 0,e.map(function(e){return e.identities})),t.identities,C.apply(void 0,n.map(function(e){return e.identities}))),r}return ht(i,o),i._validate=function(e,t,n){if(e.length<=0)throw new Error("Foreign keys require at least one column");if(e.length!==n.length)throw new Error("The numbers of columns and referenced columns must match");var r=e[0].table;if(!r)throw new Error("Some columns are not part of any table");e.forEach(function(e){if(e.table!==r)throw new Error("All columns must be part of the same table")}),n.forEach(function(e){if(e.table!==t)throw new Error("All referenced columns must be part of the referenced table")})},i}(I),_t=(ke=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}ke(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),yt=function(o){function i(e,t,n){var r=o.call(this)||this;return i._validate(n),r.name=e,r.unique=t,r.table=n[0].table,r.columns=n.slice(),r.identities=A(":ix:/",C.apply(void 0,n.map(function(e){return e.identities}))),r}return _t(i,o),i._validate=function(e){if(e.length<=0)throw new Error("Indexes require at least one column");var t=e[0].table;if(!t)throw new Error("Some columns are not part of any table");e.forEach(function(e){if(e.table!==t)throw new Error("All columns must be part of the same table")})},i.prototype.toString=function(){return this.name},i}(I),bt=(Be=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}Be(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),Et=function(n){function r(e){var t=n.call(this)||this;return t.tables=[],t.tablesByName={},t.tablesByStoreName={},t.relations=[],t.relationsByName={},t.indexes=[],t.indexesByName={},t._useForeignKeys=!(!e||!e.foreignKeys),t.triggersExpected=!(!e||!e.triggers),t.maxStatementInputs=e&&e.maxStatementInputs||950,t}return bt(r,n),r.prototype._defineSchemaForStore=function(e){var t=this,n=ge.fromStoreProviderSchema(e);this.addTable(n,e.name),e.indexes.forEach(function(e){t._defineSchemaForIndex(n,e)})},r.prototype.addTable=function(e,t){if(this.ensureNotSealed(),this.tables.push(e),this.tablesByName[e.name])throw new Error("Table name '"+e.name+"' already in use");if(this.relationsByName[e.name])throw new Error("Table name '"+e.name+"' conflicts with a relation");if(this.tablesByName[e.name]=e,t){if(this.tablesByStoreName[t])throw new Error("Table already defined for store '"+t+"'");this.tablesByStoreName[t]=e}},r.prototype._defineSchemaForRelation=function(e){var t=e.name,n=e.end1,r=e.end2,o=null;if(n.properties.collapsedSide&&(o=n),r.properties.collapsedSide){if(o)throw new Error("Relation '"+t+"' is collapsed on both sides");o=r}var i=e.properties.bridgeTableName||null;if(o&&i)throw new Error("Relation '"+t+"' is collapsd while declaring a bridge table name");i||n.many===r.many||(o=n.many?n:r),o?this._defineSchemaForCollapsedRelation(e,o):this._defineSchemaForBridgedRelation(e,i||t)},r.prototype._defineSchemaForBridgedRelation=function(e,t){var n=e.end1,r=e.end2,o=this._retrieveRelationEndTable(n),i=this._retrieveRelationEndTable(r),a=L.fromRelationProviderSchema(e),u=this._retrieveRelationEndColumnNames(n,o,"bridgeColumnName"),s=this._retrieveRelationEndColumnNames(r,i,"bridgeColumnName"),l=this.createBridgeTable(t,"main",a.identities,o,i,u,s),p=l.table,c=l.fkCols1,d=l.fkCols2;this.addTable(p),a.initTables(o,i),a.initAccessor(new W.Bridged(p,{table:o,bridgeCols:c,endName:n.innerName},{table:i,bridgeCols:d,endName:r.innerName})),this.addRelation(a),o.addAttachedRelation(a,g.ONE,n.name),i.addAttachedRelation(a,g.TWO,r.name)},r.prototype.createBridgeTable=function(e,t,n,r,o,i,a){var u=A(":relbridge:",n),s=A(n,"/1"),l=A(n,"/2"),p=new ge(e,t,u),c=r===o;function d(e,t){var n=e.charAt(0).toLowerCase()+e.substring(1);return c&&(n+=t),n}return{table:p,fkCols1:this._addForeignKeyColumns(p,r,d(r.name,"_1"),i,s),fkCols2:this._addForeignKeyColumns(p,o,d(o.name,"_2"),a,l)}},r.prototype._defineSchemaForCollapsedRelation=function(e,t){var n=e.end1,r=e.end2,o=t===n?r:n;if(o.many)throw new Error("The other end of a collapsed relation cannot have 'many' cardinality");var i=this._retrieveRelationEndTable(t),a=this._retrieveRelationEndTable(o),u=L.fromRelationProviderSchema(e),s=A(u.identities,o===n?"/1":"/2"),l=this._retrieveRelationEndColumnNames(t,a,"columnName"),p=this._addForeignKeyColumns(i,a,t.name,l,s),c=t==n?g.ONE:g.TWO;c===g.ONE?u.initTables(i,a):u.initTables(a,i),u.initAccessor(new W.Collapsed(c,{table:i,endName:t.innerName,columns:p,many:t.many},{table:a,endName:o.innerName})),this.addRelation(u),i.addAttachedRelation(u,c,t.name),a.addAttachedRelation(u,g.oppositeOf(c),o.name)},r.prototype._addForeignKeyColumns=function(i,a,u,s,l){var e=a.keyColumns.slice(),p=1<e.length?[]:l,t=e.map(function(e){var t=A(l,"/:fkcol:/",a.identities,"/",e.identities),n=p.concat(t),r=s[e.name]||u+"__"+e.name,o=ne.fromColumn(e,r,n);return i.addColumn(o),o});return this._useForeignKeys&&i.addForeignKey(new mt(t,a,e)),t},r.prototype._retrieveRelationEndTable=function(e){var t=this.tablesByStoreName[e.storeName];if(!t)throw new Error("Invalid store '"+e.storeName+"' referenced by relation end '"+e.name);return t},r.prototype._retrieveRelationEndColumnNames=function(r,o,i){var a={};return Object.keys(r.properties).map(function(e){if(0===e.indexOf(i)){var t=e.substring(i.length+".".length),n=o.columnsByFieldName[t];if(!n)throw new Error("Invalid field '"+t+"' referenced by relation end '"+r.name);a[n.name]=r.properties[e]}}),a},r.prototype.addRelation=function(e){if(this.ensureNotSealed(),this.relations.push(e),this.relationsByName[e.name])throw new Error("Relation name '"+e.name+"' already in use");this.relationsByName[e.name]=e},r.prototype._defineSchemaForIndex=function(n,e){var t=e.fieldNames.map(function(e){var t=n.columnsByFieldName[e];if(!t)throw new Error("Invalid field '"+e+"' referenced by index");return t}),r=e.properties.indexName||"idx_"+n.name+"_"+t.map(function(e){return e.name}).join("_"),o=new yt(r,e.unique,t);this.addIndex(o)},r.prototype.addIndex=function(e){if(this.ensureNotSealed(),this.indexes.push(e),this.indexesByName[e.name])throw new Error("Index name '"+e.name+"' already in use");this.indexesByName[e.name]=e},r.prototype.seal=function(){this.tables.forEach(function(e){e.seal()}),this.relations.forEach(function(e){e.seal()}),this.indexes.forEach(function(e){e.seal()}),n.prototype.seal.call(this)},r.fromProviderSchema=function(e){var t=new r({foreignKeys:!0===e.properties.foreignKeys,triggers:!0===e.properties.triggers,maxStatementInputs:e.properties.maxStatementInputs});return e.stores.forEach(t._defineSchemaForStore,t),e.relations.forEach(t._defineSchemaForRelation,t),t},r}(I),vt=function(){function c(e,t,n){this._version=e,this._schema=t,this._asyncOpen=n,this._listeners=new oe}return c.prototype.getSchema=function(){return this._schema},c.prototype.createSession=function(e,t){var n=this;if(!e)throw new Error("No database name specified");return this._openDatabase(e).then(function(e){var t=""===e.version?-1:Number(e.version);if(t!==n._version)throw new d.VersionError(n._version,t);return new N(n,e)})},c.prototype.upgradeVersion=function(e,o){var a=this,u=this;return this._openDatabase(e).then(function(n){var e=""===n.version?-1:Number(n.version);if(e!==a._version){var t=o(e),r=Et.fromProviderSchema(t),i=new re(r,a._schema).generate();return new Promise(function(e,t){var o=null;n.changeVersion(n.version,String(a._version),function(e){!function n(r){r<i.length&&s(u,e,i[r],[],function(e,t){n(r+1)},function(e,t){o=l(t,i[r])})}(0)},function(e){t(o||l(e))},e)})}})},c.prototype._openDatabase=function(e){var o=this._asyncOpen;return new Promise(function(t){var n=i(e,"",e,1048576);if(!o)return t(n);var r={};n.version=r,function e(){if(n.version!==r)return t(n);setTimeout(e,0)}()})},c.prototype.compileSelectCommand=function(e){var t;return t=this._schema.relationsByName[e.storeOrRelationName]?new Je(this,e.storeOrRelationName):new nt(this,e.storeOrRelationName),e.distinct&&t.useDistinct(),e.outputs.forEach(function(e){t.addOutputField(e.fieldPath,e.propertyName)}),e.filter&&t.addFilter(e.filter),e.order.forEach(function(e){t.addOrderTerm(e)}),e.limit&&t.addLimit(e.limit),t.build()},c.prototype.compileInsertCommand=function(e){var t;return t=this._schema.relationsByName[e.storeOrRelationName]?new ot(this,e.storeOrRelationName):new ct(this,e.storeOrRelationName),e.inserts.forEach(function(e){t.addInputField(e.fieldPath,e.valueParameter)}),e.outputs.forEach(function(e){t.addOutputField(e.fieldPath,e.propertyName)}),t.build()},c.prototype.compileInsertCommandOLD=function(e){if(this._schema.relationsByName[e.storeOrRelationName])throw new Error("Relation inserts are not supported");return this._compileInsertCommandOLD(e)},c.prototype.compileUpdateCommand=function(e){var t;return t=this._schema.relationsByName[e.storeOrRelationName]?new ut(this,e.storeOrRelationName):new ft(this,e.storeOrRelationName),e.updates.forEach(function(e){t.addInputField(e.fieldPath,e.valueParameter)}),e.filter&&t.addFilter(e.filter),e.outputs.forEach(function(e){t.addOutputField(e.fieldPath,e.before,e.propertyName)}),t.build()},c.prototype.compileUpdateCommandOLD=function(e){if(this._schema.relationsByName[e.storeOrRelationName])throw new Error("Relation updates are not supported");return this._compileUpdateCommandOLD(e)},c.prototype.compileDeleteCommand=function(e){var t;return t=this._schema.relationsByName[e.storeOrRelationName]?new et(this,e.storeOrRelationName):new lt(this,e.storeOrRelationName),e.filter&&t.addFilter(e.filter),e.outputs.forEach(function(e){t.addOutputField(e.fieldPath,e.propertyName)}),t.build()},c.prototype._compileInsertCommandOLD=function(e){var l=this._schema.tablesByStoreName[e.storeOrRelationName];function p(e){return'"'+e+'"'}var r="",o="",i=[],a=[];e.inserts.forEach(function(e,t){var n=l.columnsByFieldName[e.fieldPath];r+=(0<t?",":"")+p(n.name),o+=0<t?",?":"?",i.push(e.valueParameter),a.push(n.converter.toSQL)});var t,n="INSERT INTO "+p(l.name)+"("+r+") VALUES ("+o+")";return t=1===l.keyColumns.length&&l.keyColumns[0]===l.rowidAliasColumn?function(e,t,n,r,o){var i={};i[l.keyColumns[0].name]=l.keyColumns[0].converter.toSQL(n.insertId),r(i)}:l.keyColumns.length<=0?function(e,t,n,r,o){r({})}:function(e,t,n,i,r){var o="",a=[],u=[];l.keyColumns.forEach(function(e,t){o+=(0<t?",":"")+p(e.name)+" r"+t,a.push(e.name),u.push(e.converter.toSQL)});var s="SELECT "+o+" FROM "+p(l.name)+" WHERE _rowid_ = ?";e.executeSql(s,[n.insertId],function(e,t){for(var n=t.rows.item(0),r={},o=0;o<a.length;o++)r[a[o]]=u[o](n&&n["r"+o]);i(r)},function(e,t){return r(new Error("[SQL"+t.code+"]: "+t.message)),!0})},{sql:n,parameterNames:i,parameterConvs:a,resultConv:t,isUpdate:!1}},c.prototype._compileUpdateCommandOLD=function(e){var a=this._schema.tablesByStoreName[e.storeOrRelationName];function i(e){return'"'+e+'"'}var r="",u=[],s=[];e.updates.forEach(function(e,t){var n=a.columnsByFieldName[e.fieldPath];r+=(0<t?", ":"")+i(n.name)+" = ?",u.push(e.valueParameter),s.push(n.converter.toSQL)});var l=null,p={},t=e.filter?function e(t){if(d.Provider.FilterExpression.isFilterTerm(t)){var n=a.columnsByFieldName[t.fieldPath];n.key?(void 0!==t.valueParameter&&(p[n.name]=t.valueParameter),null===l&&(l=!0)):l=!1,void 0!==t.valueParameter&&(u.push(t.valueParameter),s.push(n.converter.toSQL));var r=c._VALUE_OPERATOR_HANDLERS[t.operator];return r(i(n.name),"?")}var o=c._LOGIC_OPERATOR_HANDLERS[t.operator];return o.apply(void 0,t.operands.map(e))}(e.filter):null;return{sql:"UPDATE "+i(a.name)+" SET "+r+(t?" WHERE "+t:""),parameterNames:u,parameterConvs:s,resultConv:!0===l?function(e,n,t,r,o){var i={};a.keyColumns.forEach(function(e){var t=n[p[e.name]];i[e.name]=e.converter.toSQL(t)}),r([i])}:function(e,t,n,r,o){o(new Error("The result of an update requires filtering and only on the key properties"))},isUpdate:!0}},c.prototype.attachSession=function(e){return new N(this,e)},c.prototype.attachTransaction=function(e){return new w(this,null,!0,e)},c.prototype.addListener=function(e){this._listeners.add(e)},c.prototype.removeListener=function(e){this._listeners.remove(e)},c.prototype.getListeners=function(){return this._listeners},c._LOGIC_OPERATOR_HANDLERS=((De={})[d.LogicOperator.NOT]=function(e){return"NOT ("+e+")"},De[d.LogicOperator.AND]=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return"("+e.join(") AND (")+")"},De[d.LogicOperator.OR]=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return"("+e.join(") OR (")+")"},De),c._VALUE_OPERATOR_HANDLERS=((Qe={})[d.ValueOperator.EMPTY]=function(e){return gt()},Qe[d.ValueOperator.NOT_EMPTY]=function(e){return gt()},Qe[d.ValueOperator.NULL]=function(e){return gt()},Qe[d.ValueOperator.NOT_NULL]=function(e){return gt()},Qe[d.ValueOperator.IN]=function(e,t){return gt()},Qe[d.ValueOperator.NOT_IN]=function(e,t){return gt()},Qe[d.ValueOperator.EQUAL]=function(e,t){return e+" = "+t},Qe[d.ValueOperator.EQUAL_IGNORE_CASE]=function(e,t){return gt()},Qe[d.ValueOperator.NOT_EQUAL]=function(e,t){return e+" <> "+t},Qe[d.ValueOperator.NOT_EQUAL_IGNORE_CASE]=function(e,t){return gt()},Qe[d.ValueOperator.GREATER]=function(e,t){return gt()},Qe[d.ValueOperator.GREATER_OR_EQUAL]=function(e,t){return gt()},Qe[d.ValueOperator.LESSER]=function(e,t){return gt()},Qe[d.ValueOperator.LESSER_OR_EQUAL]=function(e,t){return gt()},Qe[d.ValueOperator.BEGINNING]=function(e,t){return gt()},Qe[d.ValueOperator.BEGINNING_IGNORE_CASE]=function(e,t){return gt()},Qe[d.ValueOperator.NOT_BEGINNING]=function(e,t){return gt()},Qe[d.ValueOperator.NOT_BEGINNING_IGNORE_CASE]=function(e,t){return gt()},Qe[d.ValueOperator.CONTAINING]=function(e,t){return gt()},Qe[d.ValueOperator.CONTAINING_IGNORE_CASE]=function(e,t){return gt()},Qe[d.ValueOperator.NOT_CONTAINING]=function(e,t){return gt()},Qe[d.ValueOperator.NOT_CONTAINING_IGNORE_CASE]=function(e,t){return gt()},Qe[d.ValueOperator.ENDING]=function(e,t){return gt()},Qe[d.ValueOperator.ENDING_IGNORE_CASE]=function(e,t){return gt()},Qe[d.ValueOperator.NOT_ENDING]=function(e,t){return gt()},Qe[d.ValueOperator.NOT_ENDING_IGNORE_CASE]=function(e,t){return gt()},Qe),c}();function gt(){throw new Error("Operator not supported")}var Tt=function(){function e(e){this._asyncOpen=e&&e.asyncOpen||!1}return e.prototype.createDatabase=function(e,t){if("function"!=typeof window.openDatabase)throw new Error("WebSQL is not supported by the current environment");var n=Et.fromProviderSchema(t);return new vt(e,n,this._asyncOpen)},e.prototype.hasFeature=function(e){switch(e){case d.ProviderFeature.ATOMIC_TRANSACTIONS:return!0}return!1},e}();Object(d.registerProvider)("websql",Tt)}])});